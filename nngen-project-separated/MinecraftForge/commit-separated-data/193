BLEU SCORE: 0.021352774592011646

TEST MSG: Remove BlamingTransformer
GENERATED MSG: Remove dynamic lambda methods when inside of SideOnly methods

TEST DIFF (one line): diff - - git a / patches / minecraft / net / minecraft / crash / CrashReport . java . patch b / patches / minecraft / net / minecraft / crash / CrashReport . java . patch <nl> index 03212e9 . . fc71a49 100644 <nl> - - - a / patches / minecraft / net / minecraft / crash / CrashReport . java . patch <nl> + + + b / patches / minecraft / net / minecraft / crash / CrashReport . java . patch <nl> @ @ - 8 , 11 + 8 , 10 @ @ <nl> } <nl> <nl> public String func _ 71501 _ a ( ) <nl> - @ @ - 205 , 6 + 206 , 8 @ @ <nl> + @ @ - 205 , 6 + 206 , 7 @ @ <nl> { <nl> StringBuilder stringbuilder = new StringBuilder ( ) ; <nl> stringbuilder . append ( " - - - - Minecraft Crash Report - - - - \ n " ) ; <nl> - + net . minecraftforge . fml . common . asm . transformers . BlamingTransformer . onCrash ( stringbuilder ) ; <nl> + net . minecraftforge . fml . relauncher . CoreModManager . onCrash ( stringbuilder ) ; <nl> stringbuilder . append ( " / / " ) ; <nl> stringbuilder . append ( func _ 71503 _ h ( ) ) ; <nl> diff - - git a / src / main / java / net / minecraftforge / fml / common / FMLModContainer . java b / src / main / java / net / minecraftforge / fml / common / FMLModContainer . java <nl> index c1c5758 . . 7278ea6 100644 <nl> - - - a / src / main / java / net / minecraftforge / fml / common / FMLModContainer . java <nl> + + + b / src / main / java / net / minecraftforge / fml / common / FMLModContainer . java <nl> @ @ - 37 , 13 + 37 , 11 @ @ import java . util . Map ; <nl> import java . util . Properties ; <nl> import java . util . Set ; <nl> <nl> - import com . google . common . base . Throwables ; <nl> import net . minecraftforge . common . MinecraftForge ; <nl> import net . minecraftforge . common . config . Config ; <nl> import net . minecraftforge . common . config . ConfigManager ; <nl> import net . minecraftforge . fml . common . Mod . Instance ; <nl> import net . minecraftforge . fml . common . Mod . Metadata ; <nl> - import net . minecraftforge . fml . common . asm . transformers . BlamingTransformer ; <nl> import net . minecraftforge . fml . common . discovery . ASMDataTable ; <nl> import net . minecraftforge . fml . common . discovery . ModCandidate ; <nl> import net . minecraftforge . fml . common . discovery . ASMDataTable . ASMData ; <nl> @ @ - 507 , 7 + 505 , 6 @ @ public class FMLModContainer implements ModContainer <nl> @ Subscribe <nl> public void constructMod ( FMLConstructionEvent event ) <nl> { <nl> - BlamingTransformer . addClasses ( getModId ( ) , candidate . getClassList ( ) ) ; <nl> ModClassLoader modClassLoader = event . getModClassLoader ( ) ; <nl> try <nl> { <nl> diff - - git a / src / main / java / net / minecraftforge / fml / common / asm / transformers / BlamingTransformer . java b / src / main / java / net / minecraftforge / fml / common / asm / transformers / BlamingTransformer . java <nl> deleted file mode 100644 <nl> index d76dcfc . . 0000000 <nl> - - - a / src / main / java / net / minecraftforge / fml / common / asm / transformers / BlamingTransformer . java <nl> + + + / dev / null <nl> @ @ - 1 , 133 + 0 , 0 @ @ <nl> - / * <nl> - * Minecraft Forge <nl> - * Copyright ( c ) 2016 - 2018 . <nl> - * <nl> - * This library is free software ; you can redistribute it and / or <nl> - * modify it under the terms of the GNU Lesser General Public <nl> - * License as published by the Free Software Foundation version 2 . 1 <nl> - * of the License . <nl> - * <nl> - * This library is distributed in the hope that it will be useful , <nl> - * but WITHOUT ANY WARRANTY ; without even the implied warranty of <nl> - * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE . See the GNU <nl> - * Lesser General Public License for more details . <nl> - * <nl> - * You should have received a copy of the GNU Lesser General Public <nl> - * License along with this library ; if not , write to the Free Software <nl> - * Foundation , Inc . , 51 Franklin Street , Fifth Floor , Boston , MA 02110 - 1301 USA <nl> - * / <nl> - <nl> - package net . minecraftforge . fml . common . asm . transformers ; <nl> - <nl> - import java . util . HashMap ; <nl> - import java . util . HashSet ; <nl> - import java . util . Map ; <nl> - import java . util . Set ; <nl> - import java . util . TreeSet ; <nl> - <nl> - import net . minecraft . launchwrapper . IClassTransformer ; <nl> - import net . minecraftforge . fml . common . FMLLog ; <nl> - <nl> - import org . apache . commons . lang3 . JavaVersion ; <nl> - import org . apache . commons . lang3 . SystemUtils ; <nl> - import org . objectweb . asm . ClassReader ; <nl> - import org . objectweb . asm . ClassVisitor ; <nl> - import org . objectweb . asm . Opcodes ; <nl> - <nl> - import com . google . common . collect . ImmutableSet ; <nl> - <nl> - public class BlamingTransformer implements IClassTransformer <nl> - { <nl> - private static final Map < String , String > classMap = new HashMap < String , String > ( ) ; <nl> - private static final Set < String > naughtyMods = new HashSet < String > ( ) ; <nl> - private static final Set < String > naughtyClasses = new TreeSet < String > ( ) ; <nl> - private static final Set < String > orphanNaughtyClasses = new HashSet < String > ( ) ; <nl> - <nl> - @ Override <nl> - public byte [ ] transform ( String name , String transformedName , byte [ ] bytes ) <nl> - { <nl> - if ( bytes = = null ) { return null ; } <nl> - <nl> - ClassReader classReader = new ClassReader ( bytes ) ; <nl> - VersionVisitor visitor = new VersionVisitor ( ) ; <nl> - classReader . accept ( visitor , ClassReader . SKIP _ CODE | ClassReader . SKIP _ DEBUG ) ; <nl> - return bytes ; <nl> - } <nl> - <nl> - public static void blame ( String modId , String cls ) <nl> - { <nl> - naughtyClasses . add ( cls ) ; <nl> - naughtyMods . add ( modId ) ; <nl> - FMLLog . log . fatal ( " Unsupported class format in mod { } : class { } " , modId , cls ) ; <nl> - } <nl> - <nl> - public static class VersionVisitor extends ClassVisitor <nl> - { <nl> - public VersionVisitor ( ) <nl> - { <nl> - super ( Opcodes . ASM5 ) ; <nl> - } <nl> - <nl> - @ Override <nl> - public void visit ( int version , int access , String name , String signature , String superName , String [ ] interfaces ) <nl> - { <nl> - if ( ( version = = Opcodes . V1 _ 8 & & ! SystemUtils . isJavaVersionAtLeast ( JavaVersion . JAVA _ 1 _ 8 ) ) | | <nl> - ( version = = Opcodes . V1 _ 7 & & ! SystemUtils . isJavaVersionAtLeast ( JavaVersion . JAVA _ 1 _ 7 ) ) ) <nl> - { <nl> - if ( classMap . containsKey ( name ) ) blame ( classMap . get ( name ) , name ) ; <nl> - else orphanNaughtyClasses . add ( name ) ; <nl> - } <nl> - } <nl> - } <nl> - <nl> - private static void checkPendingNaughty ( ) <nl> - { <nl> - ImmutableSet . Builder < String > toRemove = ImmutableSet . builder ( ) ; <nl> - for ( String cls : orphanNaughtyClasses ) <nl> - { <nl> - if ( classMap . containsKey ( cls ) ) <nl> - { <nl> - String modId = classMap . get ( cls ) ; <nl> - blame ( modId , cls ) ; <nl> - toRemove . add ( cls ) ; <nl> - } <nl> - } <nl> - orphanNaughtyClasses . removeAll ( toRemove . build ( ) ) ; <nl> - } <nl> - <nl> - public static void addClasses ( String modId , Set < String > classList ) <nl> - { <nl> - for ( String cls : classList ) <nl> - { <nl> - classMap . put ( cls , modId ) ; <nl> - } <nl> - checkPendingNaughty ( ) ; <nl> - } <nl> - <nl> - public static void onCrash ( StringBuilder builder ) <nl> - { <nl> - checkPendingNaughty ( ) ; <nl> - if ( ! naughtyClasses . isEmpty ( ) ) <nl> - { <nl> - builder . append ( " \ n * * * ATTENTION : detected classes with unsupported format * * * \ n " ) ; <nl> - builder . append ( " * * * DO NOT SUBMIT THIS CRASH REPORT TO FORGE * * * \ n \ n " ) ; <nl> - if ( ! naughtyMods . isEmpty ( ) ) <nl> - { <nl> - builder . append ( " Contact authors of the following mods : \ n " ) ; <nl> - for ( String modId : naughtyMods ) <nl> - { <nl> - builder . append ( " " ) . append ( modId ) . append ( " \ n " ) ; <nl> - } <nl> - } <nl> - if ( ! orphanNaughtyClasses . isEmpty ( ) ) <nl> - { <nl> - builder . append ( " Unidentified unsupported classes : \ n " ) ; <nl> - for ( String cls : orphanNaughtyClasses ) <nl> - { <nl> - builder . append ( " " ) . append ( cls ) . append ( " \ n " ) ; <nl> - } <nl> - } <nl> - builder . append ( ' \ n ' ) ; <nl> - } <nl> - } <nl> - } <nl> diff - - git a / src / main / java / net / minecraftforge / fml / relauncher / FMLCorePlugin . java b / src / main / java / net / minecraftforge / fml / relauncher / FMLCorePlugin . java <nl> index c8e044d . . aea4b6a 100644 <nl> - - - a / src / main / java / net / minecraftforge / fml / relauncher / FMLCorePlugin . java <nl> + + + b / src / main / java / net / minecraftforge / fml / relauncher / FMLCorePlugin . java <nl> @ @ - 27 , 7 + 27 , 6 @ @ public class FMLCorePlugin implements IFMLLoadingPlugin <nl> public String [ ] getASMTransformerClass ( ) <nl> { <nl> return new String [ ] { <nl> - " net . minecraftforge . fml . common . asm . transformers . BlamingTransformer " , <nl> " net . minecraftforge . fml . common . asm . transformers . SideTransformer " , <nl> " net . minecraftforge . fml . common . asm . transformers . EventSubscriptionTransformer " , <nl> " net . minecraftforge . fml . common . asm . transformers . EventSubscriberTransformer " ,
NEAREST DIFF (one line): diff - - git a / src / main / java / net / minecraftforge / fml / common / asm / transformers / SideTransformer . java b / src / main / java / net / minecraftforge / fml / common / asm / transformers / SideTransformer . java <nl> index 68e6c1f . . 4c1d0b5 100644 <nl> - - - a / src / main / java / net / minecraftforge / fml / common / asm / transformers / SideTransformer . java <nl> + + + b / src / main / java / net / minecraftforge / fml / common / asm / transformers / SideTransformer . java <nl> @ @ - 19 , 8 + 19 , 10 @ @ <nl> <nl> package net . minecraftforge . fml . common . asm . transformers ; <nl> <nl> + import java . util . ArrayList ; <nl> import java . util . Iterator ; <nl> import java . util . List ; <nl> + import java . util . ListIterator ; <nl> <nl> import net . minecraft . launchwrapper . IClassTransformer ; <nl> import net . minecraftforge . fml . relauncher . FMLLaunchHandler ; <nl> @ @ - 28 , 7 + 30 , 11 @ @ import net . minecraftforge . fml . relauncher . SideOnly ; <nl> <nl> import org . objectweb . asm . ClassReader ; <nl> import org . objectweb . asm . ClassWriter ; <nl> + import org . objectweb . asm . Handle ; <nl> + import org . objectweb . asm . MethodVisitor ; <nl> + import org . objectweb . asm . Opcodes ; <nl> import org . objectweb . asm . Type ; <nl> + import org . objectweb . asm . tree . AbstractInsnNode ; <nl> import org . objectweb . asm . tree . AnnotationNode ; <nl> import org . objectweb . asm . tree . ClassNode ; <nl> import org . objectweb . asm . tree . FieldNode ; <nl> @ @ - 69 , 6 + 75 , 8 @ @ public class SideTransformer implements IClassTransformer <nl> fields . remove ( ) ; <nl> } <nl> } <nl> + <nl> + LambdaGatherer lambdaGatherer = new LambdaGatherer ( ) ; <nl> Iterator < MethodNode > methods = classNode . methods . iterator ( ) ; <nl> while ( methods . hasNext ( ) ) <nl> { <nl> @ @ - 80 , 6 + 88 , 29 @ @ public class SideTransformer implements IClassTransformer <nl> System . out . println ( String . format ( " Removing Method : % s . % s % s " , classNode . name , method . name , method . desc ) ) ; <nl> } <nl> methods . remove ( ) ; <nl> + lambdaGatherer . accept ( method ) ; <nl> + } <nl> + } <nl> + <nl> + / / remove dynamic lambda methods that are inside of removed methods <nl> + List < Handle > dynamicLambdaHandles = lambdaGatherer . getDynamicLambdaHandles ( ) ; <nl> + if ( ! dynamicLambdaHandles . isEmpty ( ) ) <nl> + { <nl> + methods = classNode . methods . iterator ( ) ; <nl> + while ( methods . hasNext ( ) ) <nl> + { <nl> + MethodNode method = methods . next ( ) ; <nl> + for ( Handle dynamicLambdaHandle : dynamicLambdaHandles ) <nl> + { <nl> + if ( method . name . equals ( dynamicLambdaHandle . getName ( ) ) & & method . desc . equals ( dynamicLambdaHandle . getDesc ( ) ) ) <nl> + { <nl> + if ( DEBUG ) <nl> + { <nl> + System . out . println ( String . format ( " Removing Method : % s . % s % s " , classNode . name , method . name , method . desc ) ) ; <nl> + } <nl> + methods . remove ( ) ; <nl> + } <nl> + } <nl> } <nl> } <nl> <nl> @ @ - 120 , 4 + 151 , 41 @ @ public class SideTransformer implements IClassTransformer <nl> } <nl> return false ; <nl> } <nl> + <nl> + private static class LambdaGatherer extends MethodVisitor { <nl> + private static final Handle META _ FACTORY = new Handle ( Opcodes . H _ INVOKESTATIC , " java / lang / invoke / LambdaMetafactory " , " metafactory " , <nl> + " ( Ljava / lang / invoke / MethodHandles $ Lookup ; Ljava / lang / String ; Ljava / lang / invoke / MethodType ; Ljava / lang / invoke / MethodType ; Ljava / lang / invoke / MethodHandle ; Ljava / lang / invoke / MethodType ; ) Ljava / lang / invoke / CallSite ; " ) ; <nl> + private final List < Handle > dynamicLambdaHandles = new ArrayList < Handle > ( ) ; <nl> + <nl> + public LambdaGatherer ( ) { <nl> + super ( Opcodes . ASM5 ) ; <nl> + } <nl> + <nl> + public void accept ( MethodNode method ) { <nl> + ListIterator < AbstractInsnNode > insnNodeIterator = method . instructions . iterator ( ) ; <nl> + while ( insnNodeIterator . hasNext ( ) ) <nl> + { <nl> + AbstractInsnNode insnNode = insnNodeIterator . next ( ) ; <nl> + if ( insnNode . getType ( ) = = AbstractInsnNode . INVOKE _ DYNAMIC _ INSN ) <nl> + { <nl> + insnNode . accept ( this ) ; <nl> + } <nl> + } <nl> + } <nl> + <nl> + @ Override <nl> + public void visitInvokeDynamicInsn ( String name , String desc , Handle bsm , Object . . . bsmArgs ) <nl> + { <nl> + if ( META _ FACTORY . equals ( bsm ) ) <nl> + { <nl> + Handle dynamicLambdaHandle = ( Handle ) bsmArgs [ 1 ] ; <nl> + dynamicLambdaHandles . add ( dynamicLambdaHandle ) ; <nl> + } <nl> + } <nl> + <nl> + public List < Handle > getDynamicLambdaHandles ( ) <nl> + { <nl> + return dynamicLambdaHandles ; <nl> + } <nl> + } <nl> } <nl> diff - - git a / src / main / java / net / minecraftforge / fml / common / registry / FMLControlledNamespacedRegistry . java b / src / main / java / net / minecraftforge / fml / common / registry / FMLControlledNamespacedRegistry . java <nl> index 6e8f0cd . . 200c2f6 100644 <nl> - - - a / src / main / java / net / minecraftforge / fml / common / registry / FMLControlledNamespacedRegistry . java <nl> + + + b / src / main / java / net / minecraftforge / fml / common / registry / FMLControlledNamespacedRegistry . java <nl> @ @ - 121 , 7 + 121 , 7 @ @ public class FMLControlledNamespacedRegistry < I extends IForgeRegistryEntry < I > > e <nl> { <nl> try <nl> { <nl> - ReflectionHelper . findMethod ( BitSet . class , this . availabilityMap , new String [ ] { " trimToSize " } ) . invoke ( this . availabilityMap ) ; <nl> + ReflectionHelper . findMethod ( BitSet . class , " trimToSize " , null ) . invoke ( this . availabilityMap ) ; <nl> } <nl> catch ( Exception e ) <nl> { <nl> diff - - git a / src / main / java / net / minecraftforge / fml / relauncher / ReflectionHelper . java b / src / main / java / net / minecraftforge / fml / relauncher / ReflectionHelper . java <nl> index 4017160 . . 0085625 100644 <nl> - - - a / src / main / java / net / minecraftforge / fml / relauncher / ReflectionHelper . java <nl> + + + b / src / main / java / net / minecraftforge / fml / relauncher / ReflectionHelper . java <nl> @ @ - 18 , 6 + 18 , 11 @ @ <nl> * / <nl> package net . minecraftforge . fml . relauncher ; <nl> <nl> + import com . google . common . base . Preconditions ; <nl> + import net . minecraft . launchwrapper . Launch ; <nl> + import org . apache . commons . lang3 . StringUtils ; <nl> + <nl> + import javax . annotation . Nonnull ; <nl> import javax . annotation . Nullable ; <nl> import java . lang . reflect . Field ; <nl> import java . lang . reflect . Method ; <nl> @ @ - 40 , 6 + 45 , 11 @ @ public class ReflectionHelper <nl> / / this . methodNames = methodNames ; <nl> } <nl> <nl> + public UnableToFindMethodException ( Throwable failed ) <nl> + { <nl> + super ( failed ) ; <nl> + } <nl> + <nl> } <nl> <nl> public static class UnableToFindClassException extends RuntimeException <nl> @ @ - 170 , 10 + 180 , 13 @ @ public class ReflectionHelper <nl> throw new UnableToFindClassException ( classNames , err ) ; <nl> } <nl> <nl> - <nl> + / * * <nl> + * @ deprecated use { @ link # findMethod ( Class , String , String , Class [ ] ) } <nl> + * / <nl> + @ Deprecated <nl> public static < E > Method findMethod ( Class < ? super E > clazz , E instance , String [ ] methodNames , Class < ? > . . . methodTypes ) <nl> { <nl> - Exception failed = null ; <nl> + Throwable failed = null ; <nl> for ( String methodName : methodNames ) <nl> { <nl> try <nl> @ @ - 187 , 6 + 200 , 47 @ @ public class ReflectionHelper <nl> failed = e ; <nl> } <nl> } <nl> - throw new UnableToFindMethodException ( methodNames , failed ) ; <nl> + throw new UnableToFindMethodException ( failed ) ; <nl> + } <nl> + <nl> + / * * <nl> + * Finds a method with the specified name and parameters in the given class and makes it accessible . <nl> + * Note : for performance , store the returned value and avoid calling this repeatedly . <nl> + * < p > <nl> + * Throws an exception if the method is not found . <nl> + * <nl> + * @ param clazz The class to find the method on . <nl> + * @ param methodName The name of the method to find ( used in developer environments , i . e . " getWorldTime " ) . <nl> + * @ param methodObfName The obfuscated name of the method to find ( used in obfuscated environments , i . e . " func _ 72820 _ D " ) . <nl> + * If the name you are looking for is on a class that is never obfuscated , this should be null . <nl> + * @ param parameterTypes The parameter types of the method to find . <nl> + * @ return The method with the specified name and parameters in the given class . <nl> + * / <nl> + @ Nonnull <nl> + public static Method findMethod ( @ Nonnull Class < ? > clazz , @ Nonnull String methodName , @ Nullable String methodObfName , Class < ? > . . . parameterTypes ) <nl> + { <nl> + Preconditions . checkNotNull ( clazz ) ; <nl> + Preconditions . checkArgument ( StringUtils . isNotEmpty ( methodName ) , " Method name cannot be empty " ) ; <nl> + <nl> + String nameToFind ; <nl> + if ( methodObfName = = null | | ( Boolean ) Launch . blackboard . get ( " fml . deobfuscatedEnvironment " ) ) <nl> + { <nl> + nameToFind = methodName ; <nl> + } <nl> + else <nl> + { <nl> + nameToFind = methodObfName ; <nl> + } <nl> + <nl> + try <nl> + { <nl> + Method m = clazz . getDeclaredMethod ( nameToFind , parameterTypes ) ; <nl> + m . setAccessible ( true ) ; <nl> + return m ; <nl> + } <nl> + catch ( Exception e ) <nl> + { <nl> + throw new UnableToFindMethodException ( e ) ; <nl> + } <nl> } <nl> }

TEST DIFF:
diff - - git a / patches / minecraft / net / minecraft / crash / CrashReport . java . patch b / patches / minecraft / net / minecraft / crash / CrashReport . java . patch 
 index 03212e9 . . fc71a49 100644 
 - - - a / patches / minecraft / net / minecraft / crash / CrashReport . java . patch 
 + + + b / patches / minecraft / net / minecraft / crash / CrashReport . java . patch 
 @ @ - 8 , 11 + 8 , 10 @ @ 
 } 
 
 public String func _ 71501 _ a ( ) 
 - @ @ - 205 , 6 + 206 , 8 @ @ 
 + @ @ - 205 , 6 + 206 , 7 @ @ 
 { 
 StringBuilder stringbuilder = new StringBuilder ( ) ; 
 stringbuilder . append ( " - - - - Minecraft Crash Report - - - - \ n " ) ; 
 - + net . minecraftforge . fml . common . asm . transformers . BlamingTransformer . onCrash ( stringbuilder ) ; 
 + net . minecraftforge . fml . relauncher . CoreModManager . onCrash ( stringbuilder ) ; 
 stringbuilder . append ( " / / " ) ; 
 stringbuilder . append ( func _ 71503 _ h ( ) ) ; 
 diff - - git a / src / main / java / net / minecraftforge / fml / common / FMLModContainer . java b / src / main / java / net / minecraftforge / fml / common / FMLModContainer . java 
 index c1c5758 . . 7278ea6 100644 
 - - - a / src / main / java / net / minecraftforge / fml / common / FMLModContainer . java 
 + + + b / src / main / java / net / minecraftforge / fml / common / FMLModContainer . java 
 @ @ - 37 , 13 + 37 , 11 @ @ import java . util . Map ; 
 import java . util . Properties ; 
 import java . util . Set ; 
 
 - import com . google . common . base . Throwables ; 
 import net . minecraftforge . common . MinecraftForge ; 
 import net . minecraftforge . common . config . Config ; 
 import net . minecraftforge . common . config . ConfigManager ; 
 import net . minecraftforge . fml . common . Mod . Instance ; 
 import net . minecraftforge . fml . common . Mod . Metadata ; 
 - import net . minecraftforge . fml . common . asm . transformers . BlamingTransformer ; 
 import net . minecraftforge . fml . common . discovery . ASMDataTable ; 
 import net . minecraftforge . fml . common . discovery . ModCandidate ; 
 import net . minecraftforge . fml . common . discovery . ASMDataTable . ASMData ; 
 @ @ - 507 , 7 + 505 , 6 @ @ public class FMLModContainer implements ModContainer 
 @ Subscribe 
 public void constructMod ( FMLConstructionEvent event ) 
 { 
 - BlamingTransformer . addClasses ( getModId ( ) , candidate . getClassList ( ) ) ; 
 ModClassLoader modClassLoader = event . getModClassLoader ( ) ; 
 try 
 { 
 diff - - git a / src / main / java / net / minecraftforge / fml / common / asm / transformers / BlamingTransformer . java b / src / main / java / net / minecraftforge / fml / common / asm / transformers / BlamingTransformer . java 
 deleted file mode 100644 
 index d76dcfc . . 0000000 
 - - - a / src / main / java / net / minecraftforge / fml / common / asm / transformers / BlamingTransformer . java 
 + + + / dev / null 
 @ @ - 1 , 133 + 0 , 0 @ @ 
 - / * 
 - * Minecraft Forge 
 - * Copyright ( c ) 2016 - 2018 . 
 - * 
 - * This library is free software ; you can redistribute it and / or 
 - * modify it under the terms of the GNU Lesser General Public 
 - * License as published by the Free Software Foundation version 2 . 1 
 - * of the License . 
 - * 
 - * This library is distributed in the hope that it will be useful , 
 - * but WITHOUT ANY WARRANTY ; without even the implied warranty of 
 - * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE . See the GNU 
 - * Lesser General Public License for more details . 
 - * 
 - * You should have received a copy of the GNU Lesser General Public 
 - * License along with this library ; if not , write to the Free Software 
 - * Foundation , Inc . , 51 Franklin Street , Fifth Floor , Boston , MA 02110 - 1301 USA 
 - * / 
 - 
 - package net . minecraftforge . fml . common . asm . transformers ; 
 - 
 - import java . util . HashMap ; 
 - import java . util . HashSet ; 
 - import java . util . Map ; 
 - import java . util . Set ; 
 - import java . util . TreeSet ; 
 - 
 - import net . minecraft . launchwrapper . IClassTransformer ; 
 - import net . minecraftforge . fml . common . FMLLog ; 
 - 
 - import org . apache . commons . lang3 . JavaVersion ; 
 - import org . apache . commons . lang3 . SystemUtils ; 
 - import org . objectweb . asm . ClassReader ; 
 - import org . objectweb . asm . ClassVisitor ; 
 - import org . objectweb . asm . Opcodes ; 
 - 
 - import com . google . common . collect . ImmutableSet ; 
 - 
 - public class BlamingTransformer implements IClassTransformer 
 - { 
 - private static final Map < String , String > classMap = new HashMap < String , String > ( ) ; 
 - private static final Set < String > naughtyMods = new HashSet < String > ( ) ; 
 - private static final Set < String > naughtyClasses = new TreeSet < String > ( ) ; 
 - private static final Set < String > orphanNaughtyClasses = new HashSet < String > ( ) ; 
 - 
 - @ Override 
 - public byte [ ] transform ( String name , String transformedName , byte [ ] bytes ) 
 - { 
 - if ( bytes = = null ) { return null ; } 
 - 
 - ClassReader classReader = new ClassReader ( bytes ) ; 
 - VersionVisitor visitor = new VersionVisitor ( ) ; 
 - classReader . accept ( visitor , ClassReader . SKIP _ CODE | ClassReader . SKIP _ DEBUG ) ; 
 - return bytes ; 
 - } 
 - 
 - public static void blame ( String modId , String cls ) 
 - { 
 - naughtyClasses . add ( cls ) ; 
 - naughtyMods . add ( modId ) ; 
 - FMLLog . log . fatal ( " Unsupported class format in mod { } : class { } " , modId , cls ) ; 
 - } 
 - 
 - public static class VersionVisitor extends ClassVisitor 
 - { 
 - public VersionVisitor ( ) 
 - { 
 - super ( Opcodes . ASM5 ) ; 
 - } 
 - 
 - @ Override 
 - public void visit ( int version , int access , String name , String signature , String superName , String [ ] interfaces ) 
 - { 
 - if ( ( version = = Opcodes . V1 _ 8 & & ! SystemUtils . isJavaVersionAtLeast ( JavaVersion . JAVA _ 1 _ 8 ) ) | | 
 - ( version = = Opcodes . V1 _ 7 & & ! SystemUtils . isJavaVersionAtLeast ( JavaVersion . JAVA _ 1 _ 7 ) ) ) 
 - { 
 - if ( classMap . containsKey ( name ) ) blame ( classMap . get ( name ) , name ) ; 
 - else orphanNaughtyClasses . add ( name ) ; 
 - } 
 - } 
 - } 
 - 
 - private static void checkPendingNaughty ( ) 
 - { 
 - ImmutableSet . Builder < String > toRemove = ImmutableSet . builder ( ) ; 
 - for ( String cls : orphanNaughtyClasses ) 
 - { 
 - if ( classMap . containsKey ( cls ) ) 
 - { 
 - String modId = classMap . get ( cls ) ; 
 - blame ( modId , cls ) ; 
 - toRemove . add ( cls ) ; 
 - } 
 - } 
 - orphanNaughtyClasses . removeAll ( toRemove . build ( ) ) ; 
 - } 
 - 
 - public static void addClasses ( String modId , Set < String > classList ) 
 - { 
 - for ( String cls : classList ) 
 - { 
 - classMap . put ( cls , modId ) ; 
 - } 
 - checkPendingNaughty ( ) ; 
 - } 
 - 
 - public static void onCrash ( StringBuilder builder ) 
 - { 
 - checkPendingNaughty ( ) ; 
 - if ( ! naughtyClasses . isEmpty ( ) ) 
 - { 
 - builder . append ( " \ n * * * ATTENTION : detected classes with unsupported format * * * \ n " ) ; 
 - builder . append ( " * * * DO NOT SUBMIT THIS CRASH REPORT TO FORGE * * * \ n \ n " ) ; 
 - if ( ! naughtyMods . isEmpty ( ) ) 
 - { 
 - builder . append ( " Contact authors of the following mods : \ n " ) ; 
 - for ( String modId : naughtyMods ) 
 - { 
 - builder . append ( " " ) . append ( modId ) . append ( " \ n " ) ; 
 - } 
 - } 
 - if ( ! orphanNaughtyClasses . isEmpty ( ) ) 
 - { 
 - builder . append ( " Unidentified unsupported classes : \ n " ) ; 
 - for ( String cls : orphanNaughtyClasses ) 
 - { 
 - builder . append ( " " ) . append ( cls ) . append ( " \ n " ) ; 
 - } 
 - } 
 - builder . append ( ' \ n ' ) ; 
 - } 
 - } 
 - } 
 diff - - git a / src / main / java / net / minecraftforge / fml / relauncher / FMLCorePlugin . java b / src / main / java / net / minecraftforge / fml / relauncher / FMLCorePlugin . java 
 index c8e044d . . aea4b6a 100644 
 - - - a / src / main / java / net / minecraftforge / fml / relauncher / FMLCorePlugin . java 
 + + + b / src / main / java / net / minecraftforge / fml / relauncher / FMLCorePlugin . java 
 @ @ - 27 , 7 + 27 , 6 @ @ public class FMLCorePlugin implements IFMLLoadingPlugin 
 public String [ ] getASMTransformerClass ( ) 
 { 
 return new String [ ] { 
 - " net . minecraftforge . fml . common . asm . transformers . BlamingTransformer " , 
 " net . minecraftforge . fml . common . asm . transformers . SideTransformer " , 
 " net . minecraftforge . fml . common . asm . transformers . EventSubscriptionTransformer " , 
 " net . minecraftforge . fml . common . asm . transformers . EventSubscriberTransformer " ,

NEAREST DIFF:
diff - - git a / src / main / java / net / minecraftforge / fml / common / asm / transformers / SideTransformer . java b / src / main / java / net / minecraftforge / fml / common / asm / transformers / SideTransformer . java 
 index 68e6c1f . . 4c1d0b5 100644 
 - - - a / src / main / java / net / minecraftforge / fml / common / asm / transformers / SideTransformer . java 
 + + + b / src / main / java / net / minecraftforge / fml / common / asm / transformers / SideTransformer . java 
 @ @ - 19 , 8 + 19 , 10 @ @ 
 
 package net . minecraftforge . fml . common . asm . transformers ; 
 
 + import java . util . ArrayList ; 
 import java . util . Iterator ; 
 import java . util . List ; 
 + import java . util . ListIterator ; 
 
 import net . minecraft . launchwrapper . IClassTransformer ; 
 import net . minecraftforge . fml . relauncher . FMLLaunchHandler ; 
 @ @ - 28 , 7 + 30 , 11 @ @ import net . minecraftforge . fml . relauncher . SideOnly ; 
 
 import org . objectweb . asm . ClassReader ; 
 import org . objectweb . asm . ClassWriter ; 
 + import org . objectweb . asm . Handle ; 
 + import org . objectweb . asm . MethodVisitor ; 
 + import org . objectweb . asm . Opcodes ; 
 import org . objectweb . asm . Type ; 
 + import org . objectweb . asm . tree . AbstractInsnNode ; 
 import org . objectweb . asm . tree . AnnotationNode ; 
 import org . objectweb . asm . tree . ClassNode ; 
 import org . objectweb . asm . tree . FieldNode ; 
 @ @ - 69 , 6 + 75 , 8 @ @ public class SideTransformer implements IClassTransformer 
 fields . remove ( ) ; 
 } 
 } 
 + 
 + LambdaGatherer lambdaGatherer = new LambdaGatherer ( ) ; 
 Iterator < MethodNode > methods = classNode . methods . iterator ( ) ; 
 while ( methods . hasNext ( ) ) 
 { 
 @ @ - 80 , 6 + 88 , 29 @ @ public class SideTransformer implements IClassTransformer 
 System . out . println ( String . format ( " Removing Method : % s . % s % s " , classNode . name , method . name , method . desc ) ) ; 
 } 
 methods . remove ( ) ; 
 + lambdaGatherer . accept ( method ) ; 
 + } 
 + } 
 + 
 + / / remove dynamic lambda methods that are inside of removed methods 
 + List < Handle > dynamicLambdaHandles = lambdaGatherer . getDynamicLambdaHandles ( ) ; 
 + if ( ! dynamicLambdaHandles . isEmpty ( ) ) 
 + { 
 + methods = classNode . methods . iterator ( ) ; 
 + while ( methods . hasNext ( ) ) 
 + { 
 + MethodNode method = methods . next ( ) ; 
 + for ( Handle dynamicLambdaHandle : dynamicLambdaHandles ) 
 + { 
 + if ( method . name . equals ( dynamicLambdaHandle . getName ( ) ) & & method . desc . equals ( dynamicLambdaHandle . getDesc ( ) ) ) 
 + { 
 + if ( DEBUG ) 
 + { 
 + System . out . println ( String . format ( " Removing Method : % s . % s % s " , classNode . name , method . name , method . desc ) ) ; 
 + } 
 + methods . remove ( ) ; 
 + } 
 + } 
 } 
 } 
 
 @ @ - 120 , 4 + 151 , 41 @ @ public class SideTransformer implements IClassTransformer 
 } 
 return false ; 
 } 
 + 
 + private static class LambdaGatherer extends MethodVisitor { 
 + private static final Handle META _ FACTORY = new Handle ( Opcodes . H _ INVOKESTATIC , " java / lang / invoke / LambdaMetafactory " , " metafactory " , 
 + " ( Ljava / lang / invoke / MethodHandles $ Lookup ; Ljava / lang / String ; Ljava / lang / invoke / MethodType ; Ljava / lang / invoke / MethodType ; Ljava / lang / invoke / MethodHandle ; Ljava / lang / invoke / MethodType ; ) Ljava / lang / invoke / CallSite ; " ) ; 
 + private final List < Handle > dynamicLambdaHandles = new ArrayList < Handle > ( ) ; 
 + 
 + public LambdaGatherer ( ) { 
 + super ( Opcodes . ASM5 ) ; 
 + } 
 + 
 + public void accept ( MethodNode method ) { 
 + ListIterator < AbstractInsnNode > insnNodeIterator = method . instructions . iterator ( ) ; 
 + while ( insnNodeIterator . hasNext ( ) ) 
 + { 
 + AbstractInsnNode insnNode = insnNodeIterator . next ( ) ; 
 + if ( insnNode . getType ( ) = = AbstractInsnNode . INVOKE _ DYNAMIC _ INSN ) 
 + { 
 + insnNode . accept ( this ) ; 
 + } 
 + } 
 + } 
 + 
 + @ Override 
 + public void visitInvokeDynamicInsn ( String name , String desc , Handle bsm , Object . . . bsmArgs ) 
 + { 
 + if ( META _ FACTORY . equals ( bsm ) ) 
 + { 
 + Handle dynamicLambdaHandle = ( Handle ) bsmArgs [ 1 ] ; 
 + dynamicLambdaHandles . add ( dynamicLambdaHandle ) ; 
 + } 
 + } 
 + 
 + public List < Handle > getDynamicLambdaHandles ( ) 
 + { 
 + return dynamicLambdaHandles ; 
 + } 
 + } 
 } 
 diff - - git a / src / main / java / net / minecraftforge / fml / common / registry / FMLControlledNamespacedRegistry . java b / src / main / java / net / minecraftforge / fml / common / registry / FMLControlledNamespacedRegistry . java 
 index 6e8f0cd . . 200c2f6 100644 
 - - - a / src / main / java / net / minecraftforge / fml / common / registry / FMLControlledNamespacedRegistry . java 
 + + + b / src / main / java / net / minecraftforge / fml / common / registry / FMLControlledNamespacedRegistry . java 
 @ @ - 121 , 7 + 121 , 7 @ @ public class FMLControlledNamespacedRegistry < I extends IForgeRegistryEntry < I > > e 
 { 
 try 
 { 
 - ReflectionHelper . findMethod ( BitSet . class , this . availabilityMap , new String [ ] { " trimToSize " } ) . invoke ( this . availabilityMap ) ; 
 + ReflectionHelper . findMethod ( BitSet . class , " trimToSize " , null ) . invoke ( this . availabilityMap ) ; 
 } 
 catch ( Exception e ) 
 { 
 diff - - git a / src / main / java / net / minecraftforge / fml / relauncher / ReflectionHelper . java b / src / main / java / net / minecraftforge / fml / relauncher / ReflectionHelper . java 
 index 4017160 . . 0085625 100644 
 - - - a / src / main / java / net / minecraftforge / fml / relauncher / ReflectionHelper . java 
 + + + b / src / main / java / net / minecraftforge / fml / relauncher / ReflectionHelper . java 
 @ @ - 18 , 6 + 18 , 11 @ @ 
 * / 
 package net . minecraftforge . fml . relauncher ; 
 
 + import com . google . common . base . Preconditions ; 
 + import net . minecraft . launchwrapper . Launch ; 
 + import org . apache . commons . lang3 . StringUtils ; 
 + 
 + import javax . annotation . Nonnull ; 
 import javax . annotation . Nullable ; 
 import java . lang . reflect . Field ; 
 import java . lang . reflect . Method ; 
 @ @ - 40 , 6 + 45 , 11 @ @ public class ReflectionHelper 
 / / this . methodNames = methodNames ; 
 } 
 
 + public UnableToFindMethodException ( Throwable failed ) 
 + { 
 + super ( failed ) ; 
 + } 
 + 
 } 
 
 public static class UnableToFindClassException extends RuntimeException 
 @ @ - 170 , 10 + 180 , 13 @ @ public class ReflectionHelper 
 throw new UnableToFindClassException ( classNames , err ) ; 
 } 
 
 - 
 + / * * 
 + * @ deprecated use { @ link # findMethod ( Class , String , String , Class [ ] ) } 
 + * / 
 + @ Deprecated 
 public static < E > Method findMethod ( Class < ? super E > clazz , E instance , String [ ] methodNames , Class < ? > . . . methodTypes ) 
 { 
 - Exception failed = null ; 
 + Throwable failed = null ; 
 for ( String methodName : methodNames ) 
 { 
 try 
 @ @ - 187 , 6 + 200 , 47 @ @ public class ReflectionHelper 
 failed = e ; 
 } 
 } 
 - throw new UnableToFindMethodException ( methodNames , failed ) ; 
 + throw new UnableToFindMethodException ( failed ) ; 
 + } 
 + 
 + / * * 
 + * Finds a method with the specified name and parameters in the given class and makes it accessible . 
 + * Note : for performance , store the returned value and avoid calling this repeatedly . 
 + * < p > 
 + * Throws an exception if the method is not found . 
 + * 
 + * @ param clazz The class to find the method on . 
 + * @ param methodName The name of the method to find ( used in developer environments , i . e . " getWorldTime " ) . 
 + * @ param methodObfName The obfuscated name of the method to find ( used in obfuscated environments , i . e . " func _ 72820 _ D " ) . 
 + * If the name you are looking for is on a class that is never obfuscated , this should be null . 
 + * @ param parameterTypes The parameter types of the method to find . 
 + * @ return The method with the specified name and parameters in the given class . 
 + * / 
 + @ Nonnull 
 + public static Method findMethod ( @ Nonnull Class < ? > clazz , @ Nonnull String methodName , @ Nullable String methodObfName , Class < ? > . . . parameterTypes ) 
 + { 
 + Preconditions . checkNotNull ( clazz ) ; 
 + Preconditions . checkArgument ( StringUtils . isNotEmpty ( methodName ) , " Method name cannot be empty " ) ; 
 + 
 + String nameToFind ; 
 + if ( methodObfName = = null | | ( Boolean ) Launch . blackboard . get ( " fml . deobfuscatedEnvironment " ) ) 
 + { 
 + nameToFind = methodName ; 
 + } 
 + else 
 + { 
 + nameToFind = methodObfName ; 
 + } 
 + 
 + try 
 + { 
 + Method m = clazz . getDeclaredMethod ( nameToFind , parameterTypes ) ; 
 + m . setAccessible ( true ) ; 
 + return m ; 
 + } 
 + catch ( Exception e ) 
 + { 
 + throw new UnableToFindMethodException ( e ) ; 
 + } 
 } 
 }
