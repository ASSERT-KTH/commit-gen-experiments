BLEU SCORE: 0.03494888491863064

TEST MSG: Some more substitution tests . It seems like it ' s working as it should .
GENERATED MSG: More tests . Substitutions now work , and a fix is included . * sigh * Closes too many bugs to count .

TEST DIFF (one line): diff - - git a / src / test / java / net / minecraftforge / fml / common / registry / RegistryTestSuite . java b / src / test / java / net / minecraftforge / fml / common / registry / RegistryTestSuite . java <nl> index d3512ae . . efde270 100644 <nl> - - - a / src / test / java / net / minecraftforge / fml / common / registry / RegistryTestSuite . java <nl> + + + b / src / test / java / net / minecraftforge / fml / common / registry / RegistryTestSuite . java <nl> @ @ - 7 , 7 + 7 , 7 @ @ import org . junit . runners . Suite ; <nl> * Run the full suite of tests <nl> * / <nl> @ RunWith ( Suite . class ) <nl> - @ Suite . SuiteClasses ( { VanillaRegistryTests . class , FreezingTests . class , SubstitutionTests . class } ) <nl> + @ Suite . SuiteClasses ( { VanillaRegistryTests . class , FreezingTests . class , SubstitutionRemoveRestoreTest . class , SubstitutionInjectionTest . class } ) <nl> public class RegistryTestSuite <nl> { <nl> } <nl> diff - - git a / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionInjectionTest . java b / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionInjectionTest . java <nl> new file mode 100644 <nl> index 0000000 . . 6e0a3ec <nl> - - - / dev / null <nl> + + + b / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionInjectionTest . java <nl> @ @ - 0 , 0 + 1 , 76 @ @ <nl> + package net . minecraftforge . fml . common . registry ; <nl> + <nl> + import net . minecraft . block . Block ; <nl> + import net . minecraft . block . BlockDirt ; <nl> + import net . minecraft . init . Blocks ; <nl> + import net . minecraft . init . Bootstrap ; <nl> + import net . minecraft . util . ResourceLocation ; <nl> + import net . minecraftforge . fml . common . DummyModContainer ; <nl> + import net . minecraftforge . fml . common . Loader ; <nl> + import net . minecraftforge . fml . common . ModMetadata ; <nl> + import org . junit . BeforeClass ; <nl> + import org . junit . Test ; <nl> + import org . junit . runner . RunWith ; <nl> + <nl> + import static org . junit . Assert . assertEquals ; <nl> + import static org . junit . Assert . assertNotEquals ; <nl> + <nl> + / * * <nl> + * Substitution test harness - tests that substitutions behave correctly <nl> + * / <nl> + @ RunWith ( ForgeTestRunner . class ) <nl> + public class SubstitutionInjectionTest <nl> + { <nl> + private ResourceLocation myDirt = new ResourceLocation ( " minecraft : dirt " ) ; <nl> + private BlockDirt toSub = new BlockDirt ( ) { <nl> + <nl> + } ; <nl> + <nl> + @ BeforeClass <nl> + public static void setup ( ) <nl> + { <nl> + Loader . instance ( ) ; <nl> + Bootstrap . register ( ) ; <nl> + Loader . instance ( ) . setupTestHarness ( new DummyModContainer ( new ModMetadata ( ) { { <nl> + modId = " test " ; <nl> + } } ) ) ; <nl> + } <nl> + <nl> + @ Test <nl> + public void testSubstitutionInjection ( ) throws Exception <nl> + { <nl> + / / Capture snapshot prior to registering the substitution - this is a world state " pre - substitute " <nl> + final PersistentRegistryManager . GameDataSnapshot snapshot = PersistentRegistryManager . takeSnapshot ( ) ; <nl> + <nl> + GameRegistry . addSubstitutionAlias ( " minecraft : dirt " , GameRegistry . Type . BLOCK , toSub ) ; <nl> + PersistentRegistryManager . freezeData ( ) ; <nl> + ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; <nl> + <nl> + final FMLControlledNamespacedRegistry < Block > blockRegistry = ( FMLControlledNamespacedRegistry < Block > ) PersistentRegistryManager . findRegistryByType ( Block . class ) ; <nl> + <nl> + / / TEST 1 : Does my substitute take effect ? The substitute should be found in the registry <nl> + Block fnd = blockRegistry . getValue ( myDirt ) ; <nl> + Block currDirt = Blocks . DIRT ; <nl> + assertEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; <nl> + assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; <nl> + assertEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; <nl> + <nl> + / / TEST 2 : Does the substitute get injected when told by loading operation ? The substitute should be found in the registry <nl> + PersistentRegistryManager . injectSnapshot ( snapshot , true , true ) ; <nl> + ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; <nl> + fnd = blockRegistry . getValue ( myDirt ) ; <nl> + currDirt = Blocks . DIRT ; <nl> + assertEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; <nl> + assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; <nl> + assertEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; <nl> + <nl> + / / TEST 3 : Does the substitute get restored when reverting to frozen state ? The substitute should be found in the registry again <nl> + PersistentRegistryManager . revertToFrozen ( ) ; <nl> + ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; <nl> + fnd = blockRegistry . getValue ( myDirt ) ; <nl> + currDirt = Blocks . DIRT ; <nl> + assertEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; <nl> + assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; <nl> + assertEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; <nl> + } <nl> + } <nl> diff - - git a / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionRemoveRestoreTest . java b / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionRemoveRestoreTest . java <nl> new file mode 100644 <nl> index 0000000 . . 41c9450 <nl> - - - / dev / null <nl> + + + b / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionRemoveRestoreTest . java <nl> @ @ - 0 , 0 + 1 , 75 @ @ <nl> + package net . minecraftforge . fml . common . registry ; <nl> + <nl> + import net . minecraft . block . Block ; <nl> + import net . minecraft . block . BlockDirt ; <nl> + import net . minecraft . init . Blocks ; <nl> + import net . minecraft . init . Bootstrap ; <nl> + import net . minecraft . util . ResourceLocation ; <nl> + import net . minecraftforge . fml . common . DummyModContainer ; <nl> + import net . minecraftforge . fml . common . Loader ; <nl> + import net . minecraftforge . fml . common . ModMetadata ; <nl> + import org . junit . BeforeClass ; <nl> + import org . junit . Test ; <nl> + import org . junit . runner . RunWith ; <nl> + <nl> + import static org . junit . Assert . assertEquals ; <nl> + import static org . junit . Assert . assertNotEquals ; <nl> + <nl> + / * * <nl> + * Substitution test harness - tests that substitutions behave correctly <nl> + * / <nl> + @ RunWith ( ForgeTestRunner . class ) <nl> + public class SubstitutionRemoveRestoreTest <nl> + { <nl> + private ResourceLocation myDirt = new ResourceLocation ( " minecraft : dirt " ) ; <nl> + private BlockDirt toSub = new BlockDirt ( ) { <nl> + <nl> + } ; <nl> + <nl> + @ BeforeClass <nl> + public static void setup ( ) <nl> + { <nl> + Loader . instance ( ) ; <nl> + Bootstrap . register ( ) ; <nl> + Loader . instance ( ) . setupTestHarness ( new DummyModContainer ( new ModMetadata ( ) { { <nl> + modId = " test " ; <nl> + } } ) ) ; <nl> + } <nl> + <nl> + @ Test <nl> + public void testSubstitutionRemovalAndRestore ( ) throws Exception <nl> + { <nl> + GameRegistry . addSubstitutionAlias ( " minecraft : dirt " , GameRegistry . Type . BLOCK , toSub ) ; <nl> + PersistentRegistryManager . freezeData ( ) ; <nl> + ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; <nl> + <nl> + final FMLControlledNamespacedRegistry < Block > blockRegistry = ( FMLControlledNamespacedRegistry < Block > ) PersistentRegistryManager . findRegistryByType ( Block . class ) ; <nl> + <nl> + / / TEST 1 : Does my substitute take effect ? The substitute should be found in the registry <nl> + Block fnd = blockRegistry . getValue ( myDirt ) ; <nl> + Block currDirt = Blocks . DIRT ; <nl> + assertEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; <nl> + assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; <nl> + assertEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; <nl> + <nl> + / / TEST 2 : Does the substitute get removed when told by remote operation ? The substitute should NOT be found in the registry <nl> + final PersistentRegistryManager . GameDataSnapshot snapshot = PersistentRegistryManager . takeSnapshot ( ) ; <nl> + snapshot . entries . get ( PersistentRegistryManager . BLOCKS ) . substitutions . clear ( ) ; <nl> + PersistentRegistryManager . injectSnapshot ( snapshot , false , false ) ; <nl> + ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; <nl> + fnd = blockRegistry . getValue ( myDirt ) ; <nl> + currDirt = Blocks . DIRT ; <nl> + assertNotEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; <nl> + assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; <nl> + assertNotEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; <nl> + <nl> + / / TEST 3 : Does the substitute get restored when reverting to frozen state ? The substitute should be found in the registry again <nl> + PersistentRegistryManager . revertToFrozen ( ) ; <nl> + ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; <nl> + fnd = blockRegistry . getValue ( myDirt ) ; <nl> + currDirt = Blocks . DIRT ; <nl> + assertEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; <nl> + assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; <nl> + assertEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; <nl> + } <nl> + } <nl> diff - - git a / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionTests . java b / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionTests . java <nl> deleted file mode 100644 <nl> index 76c663a . . 0000000 <nl> - - - a / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionTests . java <nl> + + + / dev / null <nl> @ @ - 1 , 75 + 0 , 0 @ @ <nl> - package net . minecraftforge . fml . common . registry ; <nl> - <nl> - import net . minecraft . block . Block ; <nl> - import net . minecraft . block . BlockDirt ; <nl> - import net . minecraft . init . Blocks ; <nl> - import net . minecraft . init . Bootstrap ; <nl> - import net . minecraft . util . ResourceLocation ; <nl> - import net . minecraftforge . fml . common . DummyModContainer ; <nl> - import net . minecraftforge . fml . common . Loader ; <nl> - import net . minecraftforge . fml . common . ModMetadata ; <nl> - import org . junit . BeforeClass ; <nl> - import org . junit . Test ; <nl> - import org . junit . runner . RunWith ; <nl> - <nl> - import static org . junit . Assert . assertEquals ; <nl> - import static org . junit . Assert . assertNotEquals ; <nl> - <nl> - / * * <nl> - * Substitution test harness - tests that substitutions behave correctly <nl> - * / <nl> - @ RunWith ( ForgeTestRunner . class ) <nl> - public class SubstitutionTests <nl> - { <nl> - private ResourceLocation myDirt = new ResourceLocation ( " minecraft : dirt " ) ; <nl> - private BlockDirt toSub = new BlockDirt ( ) { <nl> - <nl> - } ; <nl> - <nl> - @ BeforeClass <nl> - public static void setup ( ) <nl> - { <nl> - Loader . instance ( ) ; <nl> - Bootstrap . register ( ) ; <nl> - Loader . instance ( ) . setupTestHarness ( new DummyModContainer ( new ModMetadata ( ) { { <nl> - modId = " test " ; <nl> - } } ) ) ; <nl> - } <nl> - <nl> - @ Test <nl> - public void testSubstitution ( ) throws Exception <nl> - { <nl> - GameRegistry . addSubstitutionAlias ( " minecraft : dirt " , GameRegistry . Type . BLOCK , toSub ) ; <nl> - PersistentRegistryManager . freezeData ( ) ; <nl> - ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; <nl> - <nl> - final FMLControlledNamespacedRegistry < Block > blockRegistry = ( FMLControlledNamespacedRegistry < Block > ) PersistentRegistryManager . findRegistryByType ( Block . class ) ; <nl> - <nl> - / / TEST 1 : Does my substitute take effect ? The substitute should be found in the registry <nl> - Block fnd = blockRegistry . getValue ( myDirt ) ; <nl> - Block currDirt = Blocks . DIRT ; <nl> - assertEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; <nl> - assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; <nl> - assertEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; <nl> - <nl> - / / TEST 2 : Does the substitute get removed when told by remote operation ? The substitute should NOT be found in the registry <nl> - final PersistentRegistryManager . GameDataSnapshot snapshot = PersistentRegistryManager . takeSnapshot ( ) ; <nl> - snapshot . entries . get ( PersistentRegistryManager . BLOCKS ) . substitutions . clear ( ) ; <nl> - PersistentRegistryManager . injectSnapshot ( snapshot , false , false ) ; <nl> - ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; <nl> - fnd = blockRegistry . getValue ( myDirt ) ; <nl> - currDirt = Blocks . DIRT ; <nl> - assertNotEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; <nl> - assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; <nl> - assertNotEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; <nl> - <nl> - / / TEST 3 : Does the substitute get restored when reverting to frozen state ? The substitute should be found in the registry again <nl> - PersistentRegistryManager . revertToFrozen ( ) ; <nl> - ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; <nl> - fnd = blockRegistry . getValue ( myDirt ) ; <nl> - currDirt = Blocks . DIRT ; <nl> - assertEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; <nl> - assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; <nl> - assertEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; <nl> - } <nl> - }
NEAREST DIFF (one line): diff - - git a / src / main / java / net / minecraftforge / fml / common / LoadController . java b / src / main / java / net / minecraftforge / fml / common / LoadController . java <nl> index 99df669 . . 7422eec 100644 <nl> - - - a / src / main / java / net / minecraftforge / fml / common / LoadController . java <nl> + + + b / src / main / java / net / minecraftforge / fml / common / LoadController . java <nl> @ @ - 199 , 6 + 199 , 10 @ @ public class LoadController <nl> return activeContainer ! = null ? activeContainer : findActiveContainerFromStack ( ) ; <nl> } <nl> <nl> + void forceActiveContainer ( ModContainer container ) <nl> + { <nl> + activeContainer = container ; <nl> + } <nl> @ Subscribe <nl> public void propogateStateMessage ( FMLEvent stateEvent ) <nl> { <nl> diff - - git a / src / main / java / net / minecraftforge / fml / common / Loader . java b / src / main / java / net / minecraftforge / fml / common / Loader . java <nl> index 982c389 . . 82bcd17 100644 <nl> - - - a / src / main / java / net / minecraftforge / fml / common / Loader . java <nl> + + + b / src / main / java / net / minecraftforge / fml / common / Loader . java <nl> @ @ - 38 , 6 + 38 , 7 @ @ import net . minecraftforge . common . capabilities . CapabilityManager ; <nl> import net . minecraftforge . fml . common . LoaderState . ModState ; <nl> import net . minecraftforge . fml . common . ModContainer . Disableable ; <nl> import net . minecraftforge . fml . common . ProgressManager . ProgressBar ; <nl> + import net . minecraftforge . fml . common . discovery . ASMDataTable ; <nl> import net . minecraftforge . fml . common . discovery . ModDiscoverer ; <nl> import net . minecraftforge . fml . common . event . FMLInterModComms ; <nl> import net . minecraftforge . fml . common . event . FMLLoadEvent ; <nl> @ @ - 489 , 10 + 490 , 23 @ @ public class Loader <nl> } <nl> <nl> / * * <nl> + * Used to setup a testharness with a single dummy mod instance for use with various testing hooks <nl> + * @ param dummycontainer A dummy container that will be returned as " active " for all queries <nl> + * / <nl> + public void setupTestHarness ( ModContainer dummycontainer ) <nl> + { <nl> + modController = new LoadController ( this ) ; <nl> + mods = Lists . newArrayList ( dummycontainer ) ; <nl> + modController . transition ( LoaderState . LOADING , false ) ; <nl> + modController . transition ( LoaderState . CONSTRUCTING , false ) ; <nl> + ObjectHolderRegistry . INSTANCE . findObjectHolders ( new ASMDataTable ( ) ) ; <nl> + modController . forceActiveContainer ( dummycontainer ) ; <nl> + } <nl> + / * * <nl> * Called from the hook to start mod loading . We trigger the <nl> * { @ link # identifyMods ( ) } and Constructing , Preinitalization , and Initalization phases here . Finally , <nl> * the mod list is frozen completely and is consider immutable from then on . <nl> - * @ param injectedModContainers <nl> + * @ param injectedModContainers containers to inject <nl> * / <nl> public void loadMods ( List < String > injectedModContainers ) <nl> { <nl> diff - - git a / src / main / java / net / minecraftforge / fml / common / registry / FMLControlledNamespacedRegistry . java b / src / main / java / net / minecraftforge / fml / common / registry / FMLControlledNamespacedRegistry . java <nl> index c6c2d4b . . 5ccad59 100644 <nl> - - - a / src / main / java / net / minecraftforge / fml / common / registry / FMLControlledNamespacedRegistry . java <nl> + + + b / src / main / java / net / minecraftforge / fml / common / registry / FMLControlledNamespacedRegistry . java <nl> @ @ - 66 , 6 + 66 , 10 @ @ public class FMLControlledNamespacedRegistry < I extends IForgeRegistryEntry < I > > e <nl> * / <nl> private final BiMap < ResourceLocation , I > persistentSubstitutions = HashBiMap . create ( ) ; <nl> / * * <nl> + * Substitution originals - these are the originals that are being substituted <nl> + * / <nl> + private final BiMap < ResourceLocation , I > substitutionOriginals = HashBiMap . create ( ) ; <nl> + / * * <nl> * This is the current active substitution set for a particular world . It will change as worlds come and go . <nl> * / <nl> private final BiMap < ResourceLocation , I > activeSubstitutions = HashBiMap . create ( ) ; <nl> @ @ - 602 , 6 + 606 , 11 @ @ public class FMLControlledNamespacedRegistry < I extends IForgeRegistryEntry < I > > e <nl> I sub = getPersistentSubstitutions ( ) . get ( nameToReplace ) ; <nl> getExistingDelegate ( original ) . changeReference ( sub ) ; <nl> activeSubstitutions . put ( nameToReplace , sub ) ; <nl> + int id = getIDForObjectBypass ( original ) ; <nl> + / / force the new object into the existing map <nl> + addObjectRaw ( id , nameToReplace , sub ) ; <nl> + / / Track the original in the substitution originals collection <nl> + substitutionOriginals . put ( nameToReplace , original ) ; <nl> return original ; <nl> } <nl> return null ; <nl> @ @ - 747 , 7 + 756 , 11 @ @ public class FMLControlledNamespacedRegistry < I extends IForgeRegistryEntry < I > > e <nl> remappedIds . put ( itemName , new Integer [ ] { currId , newId } ) ; <nl> } <nl> I obj = currentRegistry . getRaw ( itemName ) ; <nl> - <nl> + / / If we have an object in the originals set , we use that for initial adding - substitute activation will readd the substitute if neceessary later <nl> + if ( currentRegistry . substitutionOriginals . containsKey ( itemName ) ) <nl> + { <nl> + obj = currentRegistry . substitutionOriginals . get ( itemName ) ; <nl> + } <nl> add ( newId , itemName , obj ) ; <nl> } <nl> } <nl> diff - - git a / src / test / java / net / minecraftforge / fml / common / registry / ForgeTestRunner . java b / src / test / java / net / minecraftforge / fml / common / registry / ForgeTestRunner . java <nl> index cc4fbb0 . . 8302867 100644 <nl> - - - a / src / test / java / net / minecraftforge / fml / common / registry / ForgeTestRunner . java <nl> + + + b / src / test / java / net / minecraftforge / fml / common / registry / ForgeTestRunner . java <nl> @ @ - 13 , 9 + 13 , 8 @ @ import org . junit . runners . JUnit4 ; <nl> import org . junit . runners . model . InitializationError ; <nl> <nl> / * * <nl> - * Uses { @ code ResettingClassLoader } to load the test class , meaning the <nl> - * { @ code Quarantine } annotation can be used to ensure certain classes are <nl> - * loaded separately . <nl> + * Uses { @ code ResettingClassLoader } to load the test class . Minecraft and Forge <nl> + * classes are loaded using the separate class loader . <nl> * <nl> * Use of a separate class loader allows classes to be reloaded for each test <nl> * class , which is handy when you ' re testing frameworks that make use of static <nl> diff - - git a / src / test / java / net / minecraftforge / fml / common / registry / RegistryTestSuite . java b / src / test / java / net / minecraftforge / fml / common / registry / RegistryTestSuite . java <nl> new file mode 100644 <nl> index 0000000 . . d3512ae <nl> - - - / dev / null <nl> + + + b / src / test / java / net / minecraftforge / fml / common / registry / RegistryTestSuite . java <nl> @ @ - 0 , 0 + 1 , 13 @ @ <nl> + package net . minecraftforge . fml . common . registry ; <nl> + <nl> + import org . junit . runner . RunWith ; <nl> + import org . junit . runners . Suite ; <nl> + <nl> + / * * <nl> + * Run the full suite of tests <nl> + * / <nl> + @ RunWith ( Suite . class ) <nl> + @ Suite . SuiteClasses ( { VanillaRegistryTests . class , FreezingTests . class , SubstitutionTests . class } ) <nl> + public class RegistryTestSuite <nl> + { <nl> + } <nl> diff - - git a / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionTests . java b / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionTests . java <nl> new file mode 100644 <nl> index 0000000 . . 76c663a <nl> - - - / dev / null <nl> + + + b / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionTests . java <nl> @ @ - 0 , 0 + 1 , 75 @ @ <nl> + package net . minecraftforge . fml . common . registry ; <nl> + <nl> + import net . minecraft . block . Block ; <nl> + import net . minecraft . block . BlockDirt ; <nl> + import net . minecraft . init . Blocks ; <nl> + import net . minecraft . init . Bootstrap ; <nl> + import net . minecraft . util . ResourceLocation ; <nl> + import net . minecraftforge . fml . common . DummyModContainer ; <nl> + import net . minecraftforge . fml . common . Loader ; <nl> + import net . minecraftforge . fml . common . ModMetadata ; <nl> + import org . junit . BeforeClass ; <nl> + import org . junit . Test ; <nl> + import org . junit . runner . RunWith ; <nl> + <nl> + import static org . junit . Assert . assertEquals ; <nl> + import static org . junit . Assert . assertNotEquals ; <nl> + <nl> + / * * <nl> + * Substitution test harness - tests that substitutions behave correctly <nl> + * / <nl> + @ RunWith ( ForgeTestRunner . class ) <nl> + public class SubstitutionTests <nl> + { <nl> + private ResourceLocation myDirt = new ResourceLocation ( " minecraft : dirt " ) ; <nl> + private BlockDirt toSub = new BlockDirt ( ) { <nl> + <nl> + } ; <nl> + <nl> + @ BeforeClass <nl> + public static void setup ( ) <nl> + { <nl> + Loader . instance ( ) ; <nl> + Bootstrap . register ( ) ; <nl> + Loader . instance ( ) . setupTestHarness ( new DummyModContainer ( new ModMetadata ( ) { { <nl> + modId = " test " ; <nl> + } } ) ) ; <nl> + } <nl> + <nl> + @ Test <nl> + public void testSubstitution ( ) throws Exception <nl> + { <nl> + GameRegistry . addSubstitutionAlias ( " minecraft : dirt " , GameRegistry . Type . BLOCK , toSub ) ; <nl> + PersistentRegistryManager . freezeData ( ) ; <nl> + ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; <nl> + <nl> + final FMLControlledNamespacedRegistry < Block > blockRegistry = ( FMLControlledNamespacedRegistry < Block > ) PersistentRegistryManager . findRegistryByType ( Block . class ) ; <nl> + <nl> + / / TEST 1 : Does my substitute take effect ? The substitute should be found in the registry <nl> + Block fnd = blockRegistry . getValue ( myDirt ) ; <nl> + Block currDirt = Blocks . DIRT ; <nl> + assertEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; <nl> + assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; <nl> + assertEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; <nl> + <nl> + / / TEST 2 : Does the substitute get removed when told by remote operation ? The substitute should NOT be found in the registry <nl> + final PersistentRegistryManager . GameDataSnapshot snapshot = PersistentRegistryManager . takeSnapshot ( ) ; <nl> + snapshot . entries . get ( PersistentRegistryManager . BLOCKS ) . substitutions . clear ( ) ; <nl> + PersistentRegistryManager . injectSnapshot ( snapshot , false , false ) ; <nl> + ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; <nl> + fnd = blockRegistry . getValue ( myDirt ) ; <nl> + currDirt = Blocks . DIRT ; <nl> + assertNotEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; <nl> + assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; <nl> + assertNotEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; <nl> + <nl> + / / TEST 3 : Does the substitute get restored when reverting to frozen state ? The substitute should be found in the registry again <nl> + PersistentRegistryManager . revertToFrozen ( ) ; <nl> + ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; <nl> + fnd = blockRegistry . getValue ( myDirt ) ; <nl> + currDirt = Blocks . DIRT ; <nl> + assertEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; <nl> + assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; <nl> + assertEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; <nl> + } <nl> + }

TEST DIFF:
diff - - git a / src / test / java / net / minecraftforge / fml / common / registry / RegistryTestSuite . java b / src / test / java / net / minecraftforge / fml / common / registry / RegistryTestSuite . java 
 index d3512ae . . efde270 100644 
 - - - a / src / test / java / net / minecraftforge / fml / common / registry / RegistryTestSuite . java 
 + + + b / src / test / java / net / minecraftforge / fml / common / registry / RegistryTestSuite . java 
 @ @ - 7 , 7 + 7 , 7 @ @ import org . junit . runners . Suite ; 
 * Run the full suite of tests 
 * / 
 @ RunWith ( Suite . class ) 
 - @ Suite . SuiteClasses ( { VanillaRegistryTests . class , FreezingTests . class , SubstitutionTests . class } ) 
 + @ Suite . SuiteClasses ( { VanillaRegistryTests . class , FreezingTests . class , SubstitutionRemoveRestoreTest . class , SubstitutionInjectionTest . class } ) 
 public class RegistryTestSuite 
 { 
 } 
 diff - - git a / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionInjectionTest . java b / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionInjectionTest . java 
 new file mode 100644 
 index 0000000 . . 6e0a3ec 
 - - - / dev / null 
 + + + b / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionInjectionTest . java 
 @ @ - 0 , 0 + 1 , 76 @ @ 
 + package net . minecraftforge . fml . common . registry ; 
 + 
 + import net . minecraft . block . Block ; 
 + import net . minecraft . block . BlockDirt ; 
 + import net . minecraft . init . Blocks ; 
 + import net . minecraft . init . Bootstrap ; 
 + import net . minecraft . util . ResourceLocation ; 
 + import net . minecraftforge . fml . common . DummyModContainer ; 
 + import net . minecraftforge . fml . common . Loader ; 
 + import net . minecraftforge . fml . common . ModMetadata ; 
 + import org . junit . BeforeClass ; 
 + import org . junit . Test ; 
 + import org . junit . runner . RunWith ; 
 + 
 + import static org . junit . Assert . assertEquals ; 
 + import static org . junit . Assert . assertNotEquals ; 
 + 
 + / * * 
 + * Substitution test harness - tests that substitutions behave correctly 
 + * / 
 + @ RunWith ( ForgeTestRunner . class ) 
 + public class SubstitutionInjectionTest 
 + { 
 + private ResourceLocation myDirt = new ResourceLocation ( " minecraft : dirt " ) ; 
 + private BlockDirt toSub = new BlockDirt ( ) { 
 + 
 + } ; 
 + 
 + @ BeforeClass 
 + public static void setup ( ) 
 + { 
 + Loader . instance ( ) ; 
 + Bootstrap . register ( ) ; 
 + Loader . instance ( ) . setupTestHarness ( new DummyModContainer ( new ModMetadata ( ) { { 
 + modId = " test " ; 
 + } } ) ) ; 
 + } 
 + 
 + @ Test 
 + public void testSubstitutionInjection ( ) throws Exception 
 + { 
 + / / Capture snapshot prior to registering the substitution - this is a world state " pre - substitute " 
 + final PersistentRegistryManager . GameDataSnapshot snapshot = PersistentRegistryManager . takeSnapshot ( ) ; 
 + 
 + GameRegistry . addSubstitutionAlias ( " minecraft : dirt " , GameRegistry . Type . BLOCK , toSub ) ; 
 + PersistentRegistryManager . freezeData ( ) ; 
 + ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; 
 + 
 + final FMLControlledNamespacedRegistry < Block > blockRegistry = ( FMLControlledNamespacedRegistry < Block > ) PersistentRegistryManager . findRegistryByType ( Block . class ) ; 
 + 
 + / / TEST 1 : Does my substitute take effect ? The substitute should be found in the registry 
 + Block fnd = blockRegistry . getValue ( myDirt ) ; 
 + Block currDirt = Blocks . DIRT ; 
 + assertEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; 
 + assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; 
 + assertEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; 
 + 
 + / / TEST 2 : Does the substitute get injected when told by loading operation ? The substitute should be found in the registry 
 + PersistentRegistryManager . injectSnapshot ( snapshot , true , true ) ; 
 + ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; 
 + fnd = blockRegistry . getValue ( myDirt ) ; 
 + currDirt = Blocks . DIRT ; 
 + assertEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; 
 + assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; 
 + assertEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; 
 + 
 + / / TEST 3 : Does the substitute get restored when reverting to frozen state ? The substitute should be found in the registry again 
 + PersistentRegistryManager . revertToFrozen ( ) ; 
 + ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; 
 + fnd = blockRegistry . getValue ( myDirt ) ; 
 + currDirt = Blocks . DIRT ; 
 + assertEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; 
 + assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; 
 + assertEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; 
 + } 
 + } 
 diff - - git a / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionRemoveRestoreTest . java b / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionRemoveRestoreTest . java 
 new file mode 100644 
 index 0000000 . . 41c9450 
 - - - / dev / null 
 + + + b / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionRemoveRestoreTest . java 
 @ @ - 0 , 0 + 1 , 75 @ @ 
 + package net . minecraftforge . fml . common . registry ; 
 + 
 + import net . minecraft . block . Block ; 
 + import net . minecraft . block . BlockDirt ; 
 + import net . minecraft . init . Blocks ; 
 + import net . minecraft . init . Bootstrap ; 
 + import net . minecraft . util . ResourceLocation ; 
 + import net . minecraftforge . fml . common . DummyModContainer ; 
 + import net . minecraftforge . fml . common . Loader ; 
 + import net . minecraftforge . fml . common . ModMetadata ; 
 + import org . junit . BeforeClass ; 
 + import org . junit . Test ; 
 + import org . junit . runner . RunWith ; 
 + 
 + import static org . junit . Assert . assertEquals ; 
 + import static org . junit . Assert . assertNotEquals ; 
 + 
 + / * * 
 + * Substitution test harness - tests that substitutions behave correctly 
 + * / 
 + @ RunWith ( ForgeTestRunner . class ) 
 + public class SubstitutionRemoveRestoreTest 
 + { 
 + private ResourceLocation myDirt = new ResourceLocation ( " minecraft : dirt " ) ; 
 + private BlockDirt toSub = new BlockDirt ( ) { 
 + 
 + } ; 
 + 
 + @ BeforeClass 
 + public static void setup ( ) 
 + { 
 + Loader . instance ( ) ; 
 + Bootstrap . register ( ) ; 
 + Loader . instance ( ) . setupTestHarness ( new DummyModContainer ( new ModMetadata ( ) { { 
 + modId = " test " ; 
 + } } ) ) ; 
 + } 
 + 
 + @ Test 
 + public void testSubstitutionRemovalAndRestore ( ) throws Exception 
 + { 
 + GameRegistry . addSubstitutionAlias ( " minecraft : dirt " , GameRegistry . Type . BLOCK , toSub ) ; 
 + PersistentRegistryManager . freezeData ( ) ; 
 + ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; 
 + 
 + final FMLControlledNamespacedRegistry < Block > blockRegistry = ( FMLControlledNamespacedRegistry < Block > ) PersistentRegistryManager . findRegistryByType ( Block . class ) ; 
 + 
 + / / TEST 1 : Does my substitute take effect ? The substitute should be found in the registry 
 + Block fnd = blockRegistry . getValue ( myDirt ) ; 
 + Block currDirt = Blocks . DIRT ; 
 + assertEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; 
 + assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; 
 + assertEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; 
 + 
 + / / TEST 2 : Does the substitute get removed when told by remote operation ? The substitute should NOT be found in the registry 
 + final PersistentRegistryManager . GameDataSnapshot snapshot = PersistentRegistryManager . takeSnapshot ( ) ; 
 + snapshot . entries . get ( PersistentRegistryManager . BLOCKS ) . substitutions . clear ( ) ; 
 + PersistentRegistryManager . injectSnapshot ( snapshot , false , false ) ; 
 + ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; 
 + fnd = blockRegistry . getValue ( myDirt ) ; 
 + currDirt = Blocks . DIRT ; 
 + assertNotEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; 
 + assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; 
 + assertNotEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; 
 + 
 + / / TEST 3 : Does the substitute get restored when reverting to frozen state ? The substitute should be found in the registry again 
 + PersistentRegistryManager . revertToFrozen ( ) ; 
 + ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; 
 + fnd = blockRegistry . getValue ( myDirt ) ; 
 + currDirt = Blocks . DIRT ; 
 + assertEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; 
 + assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; 
 + assertEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; 
 + } 
 + } 
 diff - - git a / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionTests . java b / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionTests . java 
 deleted file mode 100644 
 index 76c663a . . 0000000 
 - - - a / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionTests . java 
 + + + / dev / null 
 @ @ - 1 , 75 + 0 , 0 @ @ 
 - package net . minecraftforge . fml . common . registry ; 
 - 
 - import net . minecraft . block . Block ; 
 - import net . minecraft . block . BlockDirt ; 
 - import net . minecraft . init . Blocks ; 
 - import net . minecraft . init . Bootstrap ; 
 - import net . minecraft . util . ResourceLocation ; 
 - import net . minecraftforge . fml . common . DummyModContainer ; 
 - import net . minecraftforge . fml . common . Loader ; 
 - import net . minecraftforge . fml . common . ModMetadata ; 
 - import org . junit . BeforeClass ; 
 - import org . junit . Test ; 
 - import org . junit . runner . RunWith ; 
 - 
 - import static org . junit . Assert . assertEquals ; 
 - import static org . junit . Assert . assertNotEquals ; 
 - 
 - / * * 
 - * Substitution test harness - tests that substitutions behave correctly 
 - * / 
 - @ RunWith ( ForgeTestRunner . class ) 
 - public class SubstitutionTests 
 - { 
 - private ResourceLocation myDirt = new ResourceLocation ( " minecraft : dirt " ) ; 
 - private BlockDirt toSub = new BlockDirt ( ) { 
 - 
 - } ; 
 - 
 - @ BeforeClass 
 - public static void setup ( ) 
 - { 
 - Loader . instance ( ) ; 
 - Bootstrap . register ( ) ; 
 - Loader . instance ( ) . setupTestHarness ( new DummyModContainer ( new ModMetadata ( ) { { 
 - modId = " test " ; 
 - } } ) ) ; 
 - } 
 - 
 - @ Test 
 - public void testSubstitution ( ) throws Exception 
 - { 
 - GameRegistry . addSubstitutionAlias ( " minecraft : dirt " , GameRegistry . Type . BLOCK , toSub ) ; 
 - PersistentRegistryManager . freezeData ( ) ; 
 - ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; 
 - 
 - final FMLControlledNamespacedRegistry < Block > blockRegistry = ( FMLControlledNamespacedRegistry < Block > ) PersistentRegistryManager . findRegistryByType ( Block . class ) ; 
 - 
 - / / TEST 1 : Does my substitute take effect ? The substitute should be found in the registry 
 - Block fnd = blockRegistry . getValue ( myDirt ) ; 
 - Block currDirt = Blocks . DIRT ; 
 - assertEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; 
 - assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; 
 - assertEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; 
 - 
 - / / TEST 2 : Does the substitute get removed when told by remote operation ? The substitute should NOT be found in the registry 
 - final PersistentRegistryManager . GameDataSnapshot snapshot = PersistentRegistryManager . takeSnapshot ( ) ; 
 - snapshot . entries . get ( PersistentRegistryManager . BLOCKS ) . substitutions . clear ( ) ; 
 - PersistentRegistryManager . injectSnapshot ( snapshot , false , false ) ; 
 - ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; 
 - fnd = blockRegistry . getValue ( myDirt ) ; 
 - currDirt = Blocks . DIRT ; 
 - assertNotEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; 
 - assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; 
 - assertNotEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; 
 - 
 - / / TEST 3 : Does the substitute get restored when reverting to frozen state ? The substitute should be found in the registry again 
 - PersistentRegistryManager . revertToFrozen ( ) ; 
 - ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; 
 - fnd = blockRegistry . getValue ( myDirt ) ; 
 - currDirt = Blocks . DIRT ; 
 - assertEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; 
 - assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; 
 - assertEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; 
 - } 
 - }

NEAREST DIFF:
diff - - git a / src / main / java / net / minecraftforge / fml / common / LoadController . java b / src / main / java / net / minecraftforge / fml / common / LoadController . java 
 index 99df669 . . 7422eec 100644 
 - - - a / src / main / java / net / minecraftforge / fml / common / LoadController . java 
 + + + b / src / main / java / net / minecraftforge / fml / common / LoadController . java 
 @ @ - 199 , 6 + 199 , 10 @ @ public class LoadController 
 return activeContainer ! = null ? activeContainer : findActiveContainerFromStack ( ) ; 
 } 
 
 + void forceActiveContainer ( ModContainer container ) 
 + { 
 + activeContainer = container ; 
 + } 
 @ Subscribe 
 public void propogateStateMessage ( FMLEvent stateEvent ) 
 { 
 diff - - git a / src / main / java / net / minecraftforge / fml / common / Loader . java b / src / main / java / net / minecraftforge / fml / common / Loader . java 
 index 982c389 . . 82bcd17 100644 
 - - - a / src / main / java / net / minecraftforge / fml / common / Loader . java 
 + + + b / src / main / java / net / minecraftforge / fml / common / Loader . java 
 @ @ - 38 , 6 + 38 , 7 @ @ import net . minecraftforge . common . capabilities . CapabilityManager ; 
 import net . minecraftforge . fml . common . LoaderState . ModState ; 
 import net . minecraftforge . fml . common . ModContainer . Disableable ; 
 import net . minecraftforge . fml . common . ProgressManager . ProgressBar ; 
 + import net . minecraftforge . fml . common . discovery . ASMDataTable ; 
 import net . minecraftforge . fml . common . discovery . ModDiscoverer ; 
 import net . minecraftforge . fml . common . event . FMLInterModComms ; 
 import net . minecraftforge . fml . common . event . FMLLoadEvent ; 
 @ @ - 489 , 10 + 490 , 23 @ @ public class Loader 
 } 
 
 / * * 
 + * Used to setup a testharness with a single dummy mod instance for use with various testing hooks 
 + * @ param dummycontainer A dummy container that will be returned as " active " for all queries 
 + * / 
 + public void setupTestHarness ( ModContainer dummycontainer ) 
 + { 
 + modController = new LoadController ( this ) ; 
 + mods = Lists . newArrayList ( dummycontainer ) ; 
 + modController . transition ( LoaderState . LOADING , false ) ; 
 + modController . transition ( LoaderState . CONSTRUCTING , false ) ; 
 + ObjectHolderRegistry . INSTANCE . findObjectHolders ( new ASMDataTable ( ) ) ; 
 + modController . forceActiveContainer ( dummycontainer ) ; 
 + } 
 + / * * 
 * Called from the hook to start mod loading . We trigger the 
 * { @ link # identifyMods ( ) } and Constructing , Preinitalization , and Initalization phases here . Finally , 
 * the mod list is frozen completely and is consider immutable from then on . 
 - * @ param injectedModContainers 
 + * @ param injectedModContainers containers to inject 
 * / 
 public void loadMods ( List < String > injectedModContainers ) 
 { 
 diff - - git a / src / main / java / net / minecraftforge / fml / common / registry / FMLControlledNamespacedRegistry . java b / src / main / java / net / minecraftforge / fml / common / registry / FMLControlledNamespacedRegistry . java 
 index c6c2d4b . . 5ccad59 100644 
 - - - a / src / main / java / net / minecraftforge / fml / common / registry / FMLControlledNamespacedRegistry . java 
 + + + b / src / main / java / net / minecraftforge / fml / common / registry / FMLControlledNamespacedRegistry . java 
 @ @ - 66 , 6 + 66 , 10 @ @ public class FMLControlledNamespacedRegistry < I extends IForgeRegistryEntry < I > > e 
 * / 
 private final BiMap < ResourceLocation , I > persistentSubstitutions = HashBiMap . create ( ) ; 
 / * * 
 + * Substitution originals - these are the originals that are being substituted 
 + * / 
 + private final BiMap < ResourceLocation , I > substitutionOriginals = HashBiMap . create ( ) ; 
 + / * * 
 * This is the current active substitution set for a particular world . It will change as worlds come and go . 
 * / 
 private final BiMap < ResourceLocation , I > activeSubstitutions = HashBiMap . create ( ) ; 
 @ @ - 602 , 6 + 606 , 11 @ @ public class FMLControlledNamespacedRegistry < I extends IForgeRegistryEntry < I > > e 
 I sub = getPersistentSubstitutions ( ) . get ( nameToReplace ) ; 
 getExistingDelegate ( original ) . changeReference ( sub ) ; 
 activeSubstitutions . put ( nameToReplace , sub ) ; 
 + int id = getIDForObjectBypass ( original ) ; 
 + / / force the new object into the existing map 
 + addObjectRaw ( id , nameToReplace , sub ) ; 
 + / / Track the original in the substitution originals collection 
 + substitutionOriginals . put ( nameToReplace , original ) ; 
 return original ; 
 } 
 return null ; 
 @ @ - 747 , 7 + 756 , 11 @ @ public class FMLControlledNamespacedRegistry < I extends IForgeRegistryEntry < I > > e 
 remappedIds . put ( itemName , new Integer [ ] { currId , newId } ) ; 
 } 
 I obj = currentRegistry . getRaw ( itemName ) ; 
 - 
 + / / If we have an object in the originals set , we use that for initial adding - substitute activation will readd the substitute if neceessary later 
 + if ( currentRegistry . substitutionOriginals . containsKey ( itemName ) ) 
 + { 
 + obj = currentRegistry . substitutionOriginals . get ( itemName ) ; 
 + } 
 add ( newId , itemName , obj ) ; 
 } 
 } 
 diff - - git a / src / test / java / net / minecraftforge / fml / common / registry / ForgeTestRunner . java b / src / test / java / net / minecraftforge / fml / common / registry / ForgeTestRunner . java 
 index cc4fbb0 . . 8302867 100644 
 - - - a / src / test / java / net / minecraftforge / fml / common / registry / ForgeTestRunner . java 
 + + + b / src / test / java / net / minecraftforge / fml / common / registry / ForgeTestRunner . java 
 @ @ - 13 , 9 + 13 , 8 @ @ import org . junit . runners . JUnit4 ; 
 import org . junit . runners . model . InitializationError ; 
 
 / * * 
 - * Uses { @ code ResettingClassLoader } to load the test class , meaning the 
 - * { @ code Quarantine } annotation can be used to ensure certain classes are 
 - * loaded separately . 
 + * Uses { @ code ResettingClassLoader } to load the test class . Minecraft and Forge 
 + * classes are loaded using the separate class loader . 
 * 
 * Use of a separate class loader allows classes to be reloaded for each test 
 * class , which is handy when you ' re testing frameworks that make use of static 
 diff - - git a / src / test / java / net / minecraftforge / fml / common / registry / RegistryTestSuite . java b / src / test / java / net / minecraftforge / fml / common / registry / RegistryTestSuite . java 
 new file mode 100644 
 index 0000000 . . d3512ae 
 - - - / dev / null 
 + + + b / src / test / java / net / minecraftforge / fml / common / registry / RegistryTestSuite . java 
 @ @ - 0 , 0 + 1 , 13 @ @ 
 + package net . minecraftforge . fml . common . registry ; 
 + 
 + import org . junit . runner . RunWith ; 
 + import org . junit . runners . Suite ; 
 + 
 + / * * 
 + * Run the full suite of tests 
 + * / 
 + @ RunWith ( Suite . class ) 
 + @ Suite . SuiteClasses ( { VanillaRegistryTests . class , FreezingTests . class , SubstitutionTests . class } ) 
 + public class RegistryTestSuite 
 + { 
 + } 
 diff - - git a / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionTests . java b / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionTests . java 
 new file mode 100644 
 index 0000000 . . 76c663a 
 - - - / dev / null 
 + + + b / src / test / java / net / minecraftforge / fml / common / registry / SubstitutionTests . java 
 @ @ - 0 , 0 + 1 , 75 @ @ 
 + package net . minecraftforge . fml . common . registry ; 
 + 
 + import net . minecraft . block . Block ; 
 + import net . minecraft . block . BlockDirt ; 
 + import net . minecraft . init . Blocks ; 
 + import net . minecraft . init . Bootstrap ; 
 + import net . minecraft . util . ResourceLocation ; 
 + import net . minecraftforge . fml . common . DummyModContainer ; 
 + import net . minecraftforge . fml . common . Loader ; 
 + import net . minecraftforge . fml . common . ModMetadata ; 
 + import org . junit . BeforeClass ; 
 + import org . junit . Test ; 
 + import org . junit . runner . RunWith ; 
 + 
 + import static org . junit . Assert . assertEquals ; 
 + import static org . junit . Assert . assertNotEquals ; 
 + 
 + / * * 
 + * Substitution test harness - tests that substitutions behave correctly 
 + * / 
 + @ RunWith ( ForgeTestRunner . class ) 
 + public class SubstitutionTests 
 + { 
 + private ResourceLocation myDirt = new ResourceLocation ( " minecraft : dirt " ) ; 
 + private BlockDirt toSub = new BlockDirt ( ) { 
 + 
 + } ; 
 + 
 + @ BeforeClass 
 + public static void setup ( ) 
 + { 
 + Loader . instance ( ) ; 
 + Bootstrap . register ( ) ; 
 + Loader . instance ( ) . setupTestHarness ( new DummyModContainer ( new ModMetadata ( ) { { 
 + modId = " test " ; 
 + } } ) ) ; 
 + } 
 + 
 + @ Test 
 + public void testSubstitution ( ) throws Exception 
 + { 
 + GameRegistry . addSubstitutionAlias ( " minecraft : dirt " , GameRegistry . Type . BLOCK , toSub ) ; 
 + PersistentRegistryManager . freezeData ( ) ; 
 + ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; 
 + 
 + final FMLControlledNamespacedRegistry < Block > blockRegistry = ( FMLControlledNamespacedRegistry < Block > ) PersistentRegistryManager . findRegistryByType ( Block . class ) ; 
 + 
 + / / TEST 1 : Does my substitute take effect ? The substitute should be found in the registry 
 + Block fnd = blockRegistry . getValue ( myDirt ) ; 
 + Block currDirt = Blocks . DIRT ; 
 + assertEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; 
 + assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; 
 + assertEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; 
 + 
 + / / TEST 2 : Does the substitute get removed when told by remote operation ? The substitute should NOT be found in the registry 
 + final PersistentRegistryManager . GameDataSnapshot snapshot = PersistentRegistryManager . takeSnapshot ( ) ; 
 + snapshot . entries . get ( PersistentRegistryManager . BLOCKS ) . substitutions . clear ( ) ; 
 + PersistentRegistryManager . injectSnapshot ( snapshot , false , false ) ; 
 + ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; 
 + fnd = blockRegistry . getValue ( myDirt ) ; 
 + currDirt = Blocks . DIRT ; 
 + assertNotEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; 
 + assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; 
 + assertNotEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; 
 + 
 + / / TEST 3 : Does the substitute get restored when reverting to frozen state ? The substitute should be found in the registry again 
 + PersistentRegistryManager . revertToFrozen ( ) ; 
 + ObjectHolderRegistry . INSTANCE . applyObjectHolders ( ) ; 
 + fnd = blockRegistry . getValue ( myDirt ) ; 
 + currDirt = Blocks . DIRT ; 
 + assertEquals ( " Got my dirt substitute - Blocks " , toSub , currDirt ) ; 
 + assertEquals ( " Got my dirt substitute - Blocks and registry " , currDirt , fnd ) ; 
 + assertEquals ( " Got my dirt substitute - registry " , toSub , fnd ) ; 
 + } 
 + }
