BLEU SCORE: 0.005238546714708299

TEST MSG: OBJ loader : fixed another whitespace - related issue ; removed unused " modifyUVs " property for now ; added the " flip - v " property to switch between OpenGL - style and DirextX - style model UVs ; fixed normals - they are now correct in - world , still a bit strange for the items ; fixed normals a little bit for B3D models too .
GENERATED MSG: Clean up some formatting .

TEST DIFF (one line): diff - - git a / src / main / java / net / minecraftforge / client / model / b3d / B3DLoader . java b / src / main / java / net / minecraftforge / client / model / b3d / B3DLoader . java <nl> index a899847 . . d75ab37 100644 <nl> - - - a / src / main / java / net / minecraftforge / client / model / b3d / B3DLoader . java <nl> + + + b / src / main / java / net / minecraftforge / client / model / b3d / B3DLoader . java <nl> @ @ - 582 , 11 + 582 , 11 @ @ public class B3DLoader implements ICustomModelLoader <nl> case NORMAL : <nl> if ( v . getNormal ( ) ! = null ) <nl> { <nl> - builder . put ( e , v . getNormal ( ) . x , v . getNormal ( ) . y , v . getNormal ( ) . z , 1 ) ; <nl> + builder . put ( e , v . getNormal ( ) . x , v . getNormal ( ) . y , v . getNormal ( ) . z , 0 ) ; <nl> } <nl> else <nl> { <nl> - builder . put ( e , faceNormal . x , faceNormal . y , faceNormal . z , 1 ) ; <nl> + builder . put ( e , faceNormal . x , faceNormal . y , faceNormal . z , 0 ) ; <nl> } <nl> break ; <nl> default : <nl> diff - - git a / src / main / java / net / minecraftforge / client / model / b3d / B3DModel . java b / src / main / java / net / minecraftforge / client / model / b3d / B3DModel . java <nl> index 070e01f . . c9b889a 100644 <nl> - - - a / src / main / java / net / minecraftforge / client / model / b3d / B3DModel . java <nl> + + + b / src / main / java / net / minecraftforge / client / model / b3d / B3DModel . java <nl> @ @ - 17 , 6 + 17 , 7 @ @ import java . util . List ; <nl> import java . util . Map ; <nl> import java . util . Set ; <nl> <nl> + import javax . vecmath . Matrix3f ; <nl> import javax . vecmath . Matrix4f ; <nl> import javax . vecmath . Quat4f ; <nl> import javax . vecmath . Vector2f ; <nl> @ @ - 625 , 7 + 626 , 8 @ @ public class B3DModel <nl> bm . mul ( bone . getLeft ( ) ) ; <nl> t . add ( bm ) ; <nl> } <nl> - if ( totalWeight ! = 0 ) t . mul ( 1f / totalWeight ) ; <nl> + if ( Math . abs ( totalWeight ) > 1e - 4 ) t . mul ( 1f / totalWeight ) ; <nl> + else t . setIdentity ( ) ; <nl> } <nl> <nl> / / pos <nl> @ @ - 635 , 12 + 637 , 12 @ @ public class B3DModel <nl> Vector3f rPos = new Vector3f ( newPos . x / newPos . w , newPos . y / newPos . w , newPos . z / newPos . w ) ; <nl> <nl> / / normal <nl> - t . invert ( ) ; <nl> - t . transpose ( ) ; <nl> - Vector4f normal = new Vector4f ( this . normal ) , newNormal = new Vector4f ( ) ; <nl> - normal . w = 1 ; <nl> - t . transform ( normal , newNormal ) ; <nl> - Vector3f rNormal = new Vector3f ( newNormal . x / newNormal . w , newNormal . y / newNormal . w , newNormal . z / newNormal . w ) ; <nl> + Matrix3f tm = new Matrix3f ( ) ; <nl> + t . getRotationScale ( tm ) ; <nl> + tm . invert ( ) ; <nl> + tm . transpose ( ) ; <nl> + Vector3f normal = new Vector3f ( this . normal ) , rNormal = new Vector3f ( ) ; <nl> + tm . transform ( normal , rNormal ) ; <nl> rNormal . normalize ( ) ; <nl> <nl> / / texCoords TODO <nl> diff - - git a / src / main / java / net / minecraftforge / client / model / obj / OBJModel . java b / src / main / java / net / minecraftforge / client / model / obj / OBJModel . java <nl> index b0e890f . . 492694d 100644 <nl> - - - a / src / main / java / net / minecraftforge / client / model / obj / OBJModel . java <nl> + + + b / src / main / java / net / minecraftforge / client / model / obj / OBJModel . java <nl> @ @ - 14 , 6 + 14 , 7 @ @ import java . util . Map ; <nl> import java . util . Set ; <nl> import java . util . regex . Pattern ; <nl> <nl> + import javax . vecmath . Matrix3f ; <nl> import javax . vecmath . Matrix4f ; <nl> import javax . vecmath . Vector2f ; <nl> import javax . vecmath . Vector3f ; <nl> @ @ - 69 , 7 + 70 , 7 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> <nl> public OBJModel ( MaterialLibrary matLib , ResourceLocation modelLocation ) <nl> { <nl> - 	 this ( matLib , modelLocation , null ) ; <nl> + this ( matLib , modelLocation , new CustomData ( ) ) ; <nl> } <nl> <nl> public OBJModel ( MaterialLibrary matLib , ResourceLocation modelLocation , CustomData customData ) <nl> @ @ - 131 , 16 + 132 , 11 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> { <nl> return this . matLib ; <nl> } <nl> - <nl> - public boolean hasCustomData ( ) <nl> - { <nl> - 	 return this . customData ! = null ; <nl> - } <nl> <nl> @ Override <nl> public IModel process ( ImmutableMap < String , String > customData ) <nl> { <nl> - 	 OBJModel ret = new OBJModel ( this . matLib , this . modelLocation , new CustomData ( customData ) ) ; <nl> + OBJModel ret = new OBJModel ( this . matLib , this . modelLocation , new CustomData ( this . customData , customData ) ) ; <nl> return ret ; <nl> } <nl> <nl> @ @ - 150 , 35 + 146 , 44 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> OBJModel ret = new OBJModel ( this . matLib . makeLibWithReplacements ( textures ) , this . modelLocation , this . customData ) ; <nl> return ret ; <nl> } <nl> - <nl> - public static class CustomData <nl> + <nl> + static class CustomData <nl> { <nl> - 	 public boolean ambientOcclusion = true ; <nl> - 	 public boolean gui3d = true ; <nl> - 	 public boolean modifyUVs = false ; <nl> - 	 <nl> - 	 public CustomData ( ImmutableMap < String , String > customData ) <nl> - 	 { <nl> - 	 	 this . process ( customData ) ; <nl> - 	 } <nl> - 	 <nl> - 	 public void process ( ImmutableMap < String , String > customData ) <nl> - 	 { <nl> - 	 	 for ( Map . Entry < String , String > e : customData . entrySet ( ) ) <nl> - 	 	 { <nl> - 	 	 	 if ( e . getKey ( ) . equals ( " ambient " ) ) <nl> - 	 	 	 	 this . ambientOcclusion = Boolean . valueOf ( e . getValue ( ) ) ; <nl> - 	 	 	 else if ( e . getKey ( ) . equals ( " gui3d " ) ) <nl> - 	 	 	 	 this . gui3d = Boolean . valueOf ( e . getValue ( ) ) ; <nl> - 	 	 	 else if ( e . getKey ( ) . equals ( " modifyUVs " ) ) <nl> - 	 	 	 	 this . modifyUVs = Boolean . valueOf ( e . getValue ( ) ) ; <nl> - 	 	 } <nl> - 	 } <nl> + public boolean ambientOcclusion = true ; <nl> + public boolean gui3d = true ; <nl> + / / should be an enum , TODO <nl> + / / public boolean modifyUVs = false ; <nl> + public boolean flipV = false ; <nl> + <nl> + public CustomData ( CustomData parent , ImmutableMap < String , String > customData ) <nl> + { <nl> + this . ambientOcclusion = parent . ambientOcclusion ; <nl> + this . gui3d = parent . gui3d ; <nl> + this . flipV = parent . flipV ; <nl> + this . process ( customData ) ; <nl> + } <nl> + <nl> + public CustomData ( ) { } <nl> + <nl> + public void process ( ImmutableMap < String , String > customData ) <nl> + { <nl> + for ( Map . Entry < String , String > e : customData . entrySet ( ) ) <nl> + { <nl> + if ( e . getKey ( ) . equals ( " ambient " ) ) <nl> + this . ambientOcclusion = Boolean . valueOf ( e . getValue ( ) ) ; <nl> + else if ( e . getKey ( ) . equals ( " gui3d " ) ) <nl> + this . gui3d = Boolean . valueOf ( e . getValue ( ) ) ; <nl> + / * else if ( e . getKey ( ) . equals ( " modifyUVs " ) ) <nl> + this . modifyUVs = Boolean . valueOf ( e . getValue ( ) ) ; * / <nl> + else if ( e . getKey ( ) . equals ( " flip - v " ) ) <nl> + this . flipV = Boolean . valueOf ( e . getValue ( ) ) ; <nl> + } <nl> + } <nl> } <nl> <nl> public static class Parser <nl> { <nl> - 	 private static final Pattern WHITE _ SPACE = Pattern . compile ( " \ \ s + " ) ; <nl> + private static final Pattern WHITE _ SPACE = Pattern . compile ( " \ \ s + " ) ; <nl> private static Set < String > unknownObjectCommands = new HashSet < String > ( ) ; <nl> public MaterialLibrary materialLibrary = new MaterialLibrary ( ) ; <nl> private IResourceManager manager ; <nl> @ @ - 209 , 7 + 214 , 7 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> String currentLine = " " ; <nl> Material material = new Material ( ) ; <nl> int usemtlCounter = 0 ; <nl> - <nl> + <nl> / / float [ ] minUVBounds = new float [ ] { 0 . 0f , 0 . 0f } ; <nl> / / float [ ] maxUVBounds = new float [ ] { 1 . 0f , 1 . 0f } ; <nl> <nl> @ @ - 217 , 8 + 222 , 9 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> { <nl> currentLine = objReader . readLine ( ) ; <nl> if ( currentLine = = null ) break ; <nl> + currentLine . trim ( ) ; <nl> if ( currentLine . isEmpty ( ) | | currentLine . startsWith ( " # " ) ) continue ; <nl> - <nl> + <nl> String [ ] fields = WHITE _ SPACE . split ( currentLine , 2 ) ; <nl> String key = fields [ 0 ] ; <nl> String data = fields [ 1 ] ; <nl> @ @ - 255 , 14 + 261 , 14 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> floatSplitData [ i ] = Float . parseFloat ( splitData [ i ] ) ; <nl> TextureCoordinate texCoord = new TextureCoordinate ( new Vector3f ( floatSplitData [ 0 ] , floatSplitData [ 1 ] , floatSplitData . length = = 3 ? floatSplitData [ 2 ] : 1 ) ) ; <nl> if ( texCoord . u < 0 . 0f | | texCoord . u > 1 . 0f | | texCoord . v < 0 . 0f | | texCoord . v > 1 . 0f ) <nl> - 	 throw new UVsOutOfBoundsException ( this . objFrom ) ; <nl> + throw new UVsOutOfBoundsException ( this . objFrom ) ; <nl> / / this . UVsOutOfBounds = ( texCoord . u < 0 . 0f | | texCoord . u > 1 . 0f | | texCoord . v < 0 . 0f | | texCoord . v > 1 . 0f ) ; <nl> - <nl> + <nl> / / if ( texCoord . u < 0 . 0f | | texCoord . u > 1 . 0f | | texCoord . v < 0 . 0f | | texCoord . v > 1 . 0f ) <nl> / / { <nl> - / / 	 this . UVsOutOfBounds = true ; <nl> - / / 	 texCoord . u - = Math . floor ( texCoord . u ) ; <nl> - / / 	 texCoord . v - = Math . floor ( texCoord . v ) ; <nl> + / / this . UVsOutOfBounds = true ; <nl> + / / texCoord . u - = Math . floor ( texCoord . u ) ; <nl> + / / texCoord . v - = Math . floor ( texCoord . v ) ; <nl> / / } <nl> <nl> / / minUVBounds [ 0 ] = floatSplitData [ 0 ] < minUVBounds [ 0 ] ? floatSplitData [ 0 ] : minUVBounds [ 0 ] ; <nl> @ @ - 297 , 7 + 303 , 7 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> norm = norm < 0 ? this . normals . size ( ) - 1 : norm - 1 ; <nl> <nl> this . vertices . get ( vert ) . setNormal ( this . normals . get ( norm ) ) ; <nl> - <nl> + <nl> v . add ( this . vertices . get ( vert ) ) ; <nl> / / n . add ( this . normals . get ( norm ) ) ; <nl> } <nl> @ @ - 314 , 7 + 320 , 7 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> norm = Integer . parseInt ( splitSlash [ i ] [ 2 ] ) ; <nl> norm = norm < 0 ? this . normals . size ( ) - 1 : norm - 1 ; <nl> } <nl> - <nl> + <nl> this . vertices . get ( vert ) . setTextureCoordinate ( this . texCoords . get ( texCoord ) ) ; <nl> this . vertices . get ( vert ) . setNormal ( splitSlash [ i ] . length > 2 ? this . normals . get ( norm ) : null ) ; <nl> <nl> @ @ - 401 , 8 + 407 , 8 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> } <nl> } <nl> } <nl> - <nl> - OBJModel model = new OBJModel ( this . materialLibrary , this . objFrom , null ) ; <nl> + <nl> + OBJModel model = new OBJModel ( this . materialLibrary , this . objFrom ) ; <nl> / / model . getMatLib ( ) . setUVBounds ( minUVBounds [ 0 ] , maxUVBounds [ 0 ] , minUVBounds [ 1 ] , maxUVBounds [ 1 ] ) ; <nl> return model ; <nl> } <nl> @ @ - 410 , 7 + 416 , 7 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> <nl> public static class MaterialLibrary <nl> { <nl> - 	 private static final Pattern WHITE _ SPACE = Pattern . compile ( " \ \ s + " ) ; <nl> + private static final Pattern WHITE _ SPACE = Pattern . compile ( " \ \ s + " ) ; <nl> private Set < String > unknownMaterialCommands = new HashSet < String > ( ) ; <nl> private Map < String , Material > materials = new HashMap < String , Material > ( ) ; <nl> private Map < String , Group > groups = new HashMap < String , Group > ( ) ; <nl> @ @ - 424 , 9 + 430 , 9 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> { <nl> this . groups . put ( Group . DEFAULT _ NAME , new Group ( Group . DEFAULT _ NAME , null ) ) ; <nl> } <nl> - <nl> + <nl> public MaterialLibrary makeLibWithReplacements ( ImmutableMap < String , String > replacements ) <nl> - { <nl> + { <nl> Map < String , Material > mats = new HashMap < String , Material > ( ) ; <nl> for ( Map . Entry < String , Material > e : this . materials . entrySet ( ) ) <nl> { <nl> @ @ - 453 , 14 + 459 , 14 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> return ret ; <nl> } <nl> <nl> - / / public float [ ] getMinUVBounds ( ) <nl> + / / public float [ ] getMinUVBounds ( ) <nl> / / { <nl> - / / 	 return this . minUVBounds ; <nl> + / / return this . minUVBounds ; <nl> / / } <nl> - <nl> + <nl> / / public float [ ] getMaxUVBounds ( ) <nl> / / { <nl> - / / 	 return this . maxUVBounds ; <nl> + / / return this . maxUVBounds ; <nl> / / } <nl> <nl> / / public void setUVBounds ( float minU , float maxU , float minV , float maxV ) <nl> @ @ - 512 , 8 + 518 , 8 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> boolean hasSetTexture = false ; <nl> boolean hasSetColor = false ; <nl> String domain = from . getResourceDomain ( ) ; <nl> - if ( ! path . contains ( " / " ) ) <nl> - 	 path = from . getResourcePath ( ) . substring ( 0 , from . getResourcePath ( ) . lastIndexOf ( " / " ) + 1 ) + path ; <nl> + if ( ! path . contains ( " / " ) ) <nl> + path = from . getResourcePath ( ) . substring ( 0 , from . getResourcePath ( ) . lastIndexOf ( " / " ) + 1 ) + path ; <nl> mtlStream = new InputStreamReader ( manager . getResource ( new ResourceLocation ( domain , path ) ) . getInputStream ( ) , Charsets . UTF _ 8 ) ; <nl> mtlReader = new BufferedReader ( mtlStream ) ; <nl> <nl> @ @ - 528 , 6 + 534 , 7 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> { <nl> currentLine = mtlReader . readLine ( ) ; <nl> if ( currentLine = = null ) break ; <nl> + currentLine . trim ( ) ; <nl> if ( currentLine . isEmpty ( ) | | currentLine . startsWith ( " # " ) ) continue ; <nl> <nl> String [ ] fields = WHITE _ SPACE . split ( currentLine , 2 ) ; <nl> @ @ - 582 , 11 + 589 , 11 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> } <nl> else if ( key . equalsIgnoreCase ( " d " ) | | key . equalsIgnoreCase ( " Tr " ) ) <nl> { <nl> - 	 / / d < - optional key here > float [ 0 . 0 : 1 . 0 , 1 . 0 ] <nl> - 	 / / Tr r g b OR Tr spectral map file OR Tr xyz r g b ( CIEXYZ colorspace ) <nl> - 	 String [ ] splitData = WHITE _ SPACE . split ( data ) ; 	 <nl> - 	 float alpha = Float . parseFloat ( splitData [ splitData . length - 1 ] ) ; <nl> - 	 material . getColor ( ) . setW ( alpha ) ; <nl> + / / d < - optional key here > float [ 0 . 0 : 1 . 0 , 1 . 0 ] <nl> + / / Tr r g b OR Tr spectral map file OR Tr xyz r g b ( CIEXYZ colorspace ) <nl> + String [ ] splitData = WHITE _ SPACE . split ( data ) ; <nl> + float alpha = Float . parseFloat ( splitData [ splitData . length - 1 ] ) ; <nl> + material . getColor ( ) . setW ( alpha ) ; <nl> } <nl> else <nl> { <nl> @ @ - 756 , 11 + 763 , 11 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> { <nl> this ( verts , Material . DEFAULT _ NAME ) ; <nl> } <nl> - <nl> + <nl> public Face ( Vertex [ ] verts , String materialName ) { <nl> - 	 this . verts = verts ! = null & & verts . length > 2 ? verts : null ; <nl> - 	 setMaterialName ( materialName ) ; <nl> - 	 checkData ( ) ; <nl> + this . verts = verts ! = null & & verts . length > 2 ? verts : null ; <nl> + setMaterialName ( materialName ) ; <nl> + checkData ( ) ; <nl> } <nl> <nl> / / public Face ( Vertex [ ] verts , Normal [ ] norms ) <nl> @ @ - 780 , 9 + 787 , 9 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> <nl> / / public Face ( Vertex [ ] verts , Normal [ ] norms , TextureCoordinate [ ] texCoords , String materialName ) <nl> / / { <nl> - / / 	 this . verts = verts ! = null & & verts . length > 2 ? verts : null ; <nl> - / / 	 this . norms = norms ! = null & & norms . length > 2 ? norms : null ; <nl> - / / 	 this . texCoords = texCoords ! = null & & texCoords . length > 2 ? texCoords : null ; <nl> + / / this . verts = verts ! = null & & verts . length > 2 ? verts : null ; <nl> + / / this . norms = norms ! = null & & norms . length > 2 ? norms : null ; <nl> + / / this . texCoords = texCoords ! = null & & texCoords . length > 2 ? texCoords : null ; <nl> / / setMaterialName ( materialName ) ; <nl> / / checkData ( ) ; <nl> / / } <nl> @ @ - 791 , 7 + 798 , 7 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> { <nl> if ( this . verts ! = null & & this . verts . length = = 3 ) <nl> { <nl> - 	 this . isTri = true ; <nl> + this . isTri = true ; <nl> this . verts = new Vertex [ ] { this . verts [ 0 ] , this . verts [ 1 ] , this . verts [ 2 ] , this . verts [ 2 ] } ; <nl> } <nl> } <nl> @ @ - 822 , 40 + 829 , 40 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> / / public boolean areUVsNormalized ( ) <nl> / / { <nl> / / for ( Vertex v : this . verts ) <nl> - / / 	 if ( ! v . hasNormalizedUVs ( ) ) <nl> - / / 	 	 return false ; <nl> + / / if ( ! v . hasNormalizedUVs ( ) ) <nl> + / / return false ; <nl> / / return true ; <nl> / / } <nl> - <nl> + <nl> / / public void normalizeUVs ( float [ ] min , float [ ] max ) <nl> / / { <nl> - / / 	 if ( ! this . areUVsNormalized ( ) ) <nl> - / / 	 { <nl> - / / 	 	 for ( int i = 0 ; i < this . verts . length ; i + + ) { <nl> - / / 	 	 	 TextureCoordinate texCoord = this . verts [ i ] . getTextureCoordinate ( ) ; <nl> - / / 	 	 	 min [ 0 ] = texCoord . u < min [ 0 ] ? texCoord . u : min [ 0 ] ; <nl> - / / 	 	 	 max [ 0 ] = texCoord . u > max [ 0 ] ? texCoord . u : max [ 0 ] ; <nl> - / / 	 	 	 min [ 1 ] = texCoord . v < min [ 1 ] ? texCoord . v : min [ 1 ] ; <nl> - / / 	 	 	 max [ 1 ] = texCoord . v > max [ 1 ] ? texCoord . v : max [ 1 ] ; <nl> - / / 	 	 } <nl> - / / 	 	 <nl> - / / 	 	 for ( Vertex v : this . verts ) { <nl> - / / 	 	 	 v . texCoord . u = ( v . texCoord . u - min [ 0 ] ) / ( max [ 0 ] - min [ 0 ] ) ; <nl> - / / 	 	 	 v . texCoord . v = ( v . texCoord . v - min [ 1 ] ) / ( max [ 1 ] - max [ 1 ] ) ; <nl> - / / 	 	 } <nl> - / / 	 } <nl> + / / if ( ! this . areUVsNormalized ( ) ) <nl> + / / { <nl> + / / for ( int i = 0 ; i < this . verts . length ; i + + ) { <nl> + / / TextureCoordinate texCoord = this . verts [ i ] . getTextureCoordinate ( ) ; <nl> + / / min [ 0 ] = texCoord . u < min [ 0 ] ? texCoord . u : min [ 0 ] ; <nl> + / / max [ 0 ] = texCoord . u > max [ 0 ] ? texCoord . u : max [ 0 ] ; <nl> + / / min [ 1 ] = texCoord . v < min [ 1 ] ? texCoord . v : min [ 1 ] ; <nl> + / / max [ 1 ] = texCoord . v > max [ 1 ] ? texCoord . v : max [ 1 ] ; <nl> + / / } <nl> + / / <nl> + / / for ( Vertex v : this . verts ) { <nl> + / / v . texCoord . u = ( v . texCoord . u - min [ 0 ] ) / ( max [ 0 ] - min [ 0 ] ) ; <nl> + / / v . texCoord . v = ( v . texCoord . v - min [ 1 ] ) / ( max [ 1 ] - max [ 1 ] ) ; <nl> + / / } <nl> + / / } <nl> / / } <nl> <nl> public Face bake ( TRSRTransformation transform ) <nl> { <nl> Matrix4f m = transform . getMatrix ( ) ; <nl> + Matrix3f mn = null ; <nl> Vertex [ ] vertices = new Vertex [ verts . length ] ; <nl> / / Normal [ ] normals = norms ! = null ? new Normal [ norms . length ] : null ; <nl> / / TextureCoordinate [ ] textureCoords = texCoords ! = null ? new TextureCoordinate [ texCoords . length ] : null ; <nl> <nl> for ( int i = 0 ; i < verts . length ; i + + ) <nl> { <nl> - m = transform . getMatrix ( ) ; <nl> Vertex v = verts [ i ] ; <nl> / / Normal n = norms ! = null ? norms [ i ] : null ; <nl> / / TextureCoordinate t = texCoords ! = null ? texCoords [ i ] : null ; <nl> @ @ - 864 , 34 + 871 , 25 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> pos . w = 1 ; <nl> m . transform ( pos , newPos ) ; <nl> vertices [ i ] = new Vertex ( newPos , v . getMaterial ( ) ) ; <nl> - <nl> + <nl> if ( v . hasNormal ( ) ) <nl> { <nl> - 	 m . invert ( ) ; <nl> - 	 Vector4f normal = new Vector4f ( v . getNormal ( ) . getData ( ) ) , newNormal = new Vector4f ( ) ; <nl> - 	 normal . w = 1 . 0f ; <nl> - 	 m . transform ( normal , newNormal ) ; <nl> - 	 Vector3f rNormal = new Vector3f ( newNormal . x / newNormal . w , newNormal . y / newNormal . w , newNormal . z / newNormal . w ) ; <nl> - 	 rNormal . normalize ( ) ; <nl> - 	 vertices [ i ] . setNormal ( new Normal ( rNormal ) ) ; <nl> + if ( mn = = null ) <nl> + { <nl> + mn = new Matrix3f ( ) ; <nl> + m . getRotationScale ( mn ) ; <nl> + mn . invert ( ) ; <nl> + mn . transpose ( ) ; <nl> + } <nl> + Vector3f normal = new Vector3f ( v . getNormal ( ) . getData ( ) ) , newNormal = new Vector3f ( ) ; <nl> + mn . transform ( normal , newNormal ) ; <nl> + newNormal . normalize ( ) ; <nl> + vertices [ i ] . setNormal ( new Normal ( newNormal ) ) ; <nl> } <nl> - else v . setNormal ( new Normal ( 0 . 0f , 1 . 0f , 0 . 0f ) ) ; <nl> - <nl> + <nl> if ( v . hasTextureCoordinate ( ) ) vertices [ i ] . setTextureCoordinate ( v . getTextureCoordinate ( ) ) ; <nl> else v . setTextureCoordinate ( TextureCoordinate . getDefaultUVs ( ) [ i ] ) ; <nl> <nl> - / / if ( n ! = null ) <nl> - / / { <nl> - / / m . invert ( ) ; <nl> - / / m . transpose ( ) ; <nl> - / / Vector4f normal = new Vector4f ( n . getData ( ) ) , newNormal = new Vector4f ( ) ; <nl> - / / normal . w = 1 ; <nl> - / / m . transform ( normal , newNormal ) ; <nl> - / / Vector3f rNormal = new Vector3f ( newNormal . x / newNormal . w , newNormal . y / newNormal . w , newNormal . z / newNormal . w ) ; <nl> - / / rNormal . normalize ( ) ; <nl> - / / normals [ i ] = new Normal ( rNormal ) ; <nl> - / / } <nl> - <nl> / / texCoords TODO <nl> / / if ( t ! = null ) textureCoords [ i ] = t ; <nl> } <nl> @ @ - 900 , 40 + 898 , 13 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> <nl> public Normal getNormal ( ) <nl> { <nl> - 	 for ( Vertex v : this . verts ) <nl> - 	 { <nl> - 	 	 if ( ! v . hasNormal ( ) ) <nl> - 	 	 { <nl> - 	 	 	 Vector3f vPos = v . getPos3 ( ) ; <nl> - 	 	 	 vPos . normalize ( ) ; <nl> - 	 	 	 v . setNormal ( new Normal ( vPos ) ) ; <nl> - 	 	 } <nl> - 	 } <nl> - 	 <nl> - 	 Vector3f a = this . verts [ 1 ] . getNormal ( ) . getData ( ) ; <nl> - 	 a . sub ( this . verts [ 0 ] . getNormal ( ) . getData ( ) ) ; <nl> - 	 Vector3f b = this . verts [ 2 ] . getNormal ( ) . getData ( ) ; <nl> - 	 b . sub ( this . verts [ 0 ] . getNormal ( ) . getData ( ) ) ; <nl> - 	 Vector3f c = new Vector3f ( ) ; <nl> - 	 c . cross ( a , b ) ; <nl> - 	 c . normalize ( ) ; <nl> - 	 <nl> - 	 if ( this . isTri ) return new Normal ( c ) ; <nl> - 	 else <nl> - 	 { <nl> - 	 	 a = this . verts [ 1 ] . getNormal ( ) . getData ( ) ; <nl> - 	 	 a . sub ( this . verts [ 3 ] . getNormal ( ) . getData ( ) ) ; <nl> - 	 	 b = this . verts [ 2 ] . getNormal ( ) . getData ( ) ; <nl> - 	 	 b . sub ( this . verts [ 3 ] . getNormal ( ) . getData ( ) ) ; <nl> - 	 	 Vector3f c1 = new Vector3f ( ) ; <nl> - 	 	 c1 . cross ( a , b ) ; <nl> - 	 	 c1 . normalize ( ) ; <nl> - 	 	 Vector3f normal = new Vector3f ( ) ; <nl> - 	 	 normal . add ( c , c1 ) ; <nl> - 	 	 normal . scale ( 0 . 5f ) ; <nl> - 	 	 normal . normalize ( ) ; <nl> - 	 	 return new Normal ( normal ) ; <nl> - 	 } <nl> + Vector3f a = this . verts [ 2 ] . getPos3 ( ) ; <nl> + a . sub ( this . verts [ 0 ] . getPos3 ( ) ) ; <nl> + Vector3f b = this . verts [ 3 ] . getPos3 ( ) ; <nl> + b . sub ( this . verts [ 1 ] . getPos3 ( ) ) ; <nl> + a . cross ( a , b ) ; <nl> + a . normalize ( ) ; <nl> + return new Normal ( a ) ; <nl> } <nl> } <nl> <nl> @ @ - 959 , 45 + 930 , 45 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> { <nl> return this . position ; <nl> } <nl> - <nl> + <nl> public Vector3f getPos3 ( ) <nl> { <nl> - 	 return new Vector3f ( this . position . x , this . position . y , this . position . z ) ; <nl> + return new Vector3f ( this . position . x , this . position . y , this . position . z ) ; <nl> } <nl> - <nl> + <nl> public boolean hasNormal ( ) <nl> { <nl> - 	 return this . normal ! = null ; <nl> + return this . normal ! = null ; <nl> } <nl> - <nl> + <nl> public void setNormal ( Normal normal ) <nl> { <nl> - 	 this . normal = normal ; <nl> + this . normal = normal ; <nl> } <nl> - <nl> + <nl> public Normal getNormal ( ) <nl> { <nl> - 	 return this . normal ; <nl> + return this . normal ; <nl> } <nl> - <nl> + <nl> public boolean hasTextureCoordinate ( ) <nl> { <nl> - 	 return this . texCoord ! = null ; <nl> + return this . texCoord ! = null ; <nl> } <nl> - <nl> + <nl> public void setTextureCoordinate ( TextureCoordinate texCoord ) <nl> { <nl> - 	 this . texCoord = texCoord ; <nl> + this . texCoord = texCoord ; <nl> } <nl> - <nl> + <nl> public TextureCoordinate getTextureCoordinate ( ) <nl> { <nl> - 	 return this . texCoord ; <nl> + return this . texCoord ; <nl> } <nl> <nl> / / public boolean hasNormalizedUVs ( ) <nl> / / { <nl> - / / 	 return this . texCoord . u > = 0 . 0f & & this . texCoord . u < = 1 . 0f & & this . texCoord . v > = 0 . 0f & & this . texCoord . v < = 1 . 0f ; <nl> + / / return this . texCoord . u > = 0 . 0f & & this . texCoord . u < = 1 . 0f & & this . texCoord . v > = 0 . 0f & & this . texCoord . v < = 1 . 0f ; <nl> / / } <nl> <nl> public void setMaterial ( Material material ) <nl> @ @ - 1020 , 78 + 991 , 78 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> return builder . toString ( ) ; <nl> } <nl> } <nl> - <nl> + <nl> public static class Normal <nl> { <nl> - 	 public float x , y , z ; <nl> - 	 <nl> - 	 public Normal ( ) <nl> - 	 { <nl> - 	 	 this ( 0 . 0f , 0 . 0f , 0 . 0f ) ; <nl> - 	 } <nl> - 	 <nl> - 	 public Normal ( float [ ] data ) <nl> - 	 { <nl> - 	 	 this ( data [ 0 ] , data [ 1 ] , data [ 2 ] ) ; <nl> - 	 } <nl> - 	 <nl> - 	 public Normal ( Vector3f vector3f ) <nl> - 	 { <nl> - 	 	 this ( vector3f . x , vector3f . y , vector3f . z ) ; <nl> - 	 } <nl> - 	 <nl> - 	 public Normal ( float x , float y , float z ) { <nl> - 	 	 this . x = x ; <nl> - 	 	 this . y = y ; <nl> - 	 	 this . z = z ; <nl> - 	 } <nl> - 	 <nl> - 	 public Vector3f getData ( ) <nl> - 	 { <nl> - 	 	 return new Vector3f ( this . x , this . y , this . z ) ; <nl> - 	 } <nl> + public float x , y , z ; <nl> + <nl> + public Normal ( ) <nl> + { <nl> + this ( 0 . 0f , 0 . 0f , 0 . 0f ) ; <nl> + } <nl> + <nl> + public Normal ( float [ ] data ) <nl> + { <nl> + this ( data [ 0 ] , data [ 1 ] , data [ 2 ] ) ; <nl> + } <nl> + <nl> + public Normal ( Vector3f vector3f ) <nl> + { <nl> + this ( vector3f . x , vector3f . y , vector3f . z ) ; <nl> + } <nl> + <nl> + public Normal ( float x , float y , float z ) { <nl> + this . x = x ; <nl> + this . y = y ; <nl> + this . z = z ; <nl> + } <nl> + <nl> + public Vector3f getData ( ) <nl> + { <nl> + return new Vector3f ( this . x , this . y , this . z ) ; <nl> + } <nl> } <nl> <nl> public static class TextureCoordinate <nl> { <nl> - 	 public float u , v , w ; <nl> - 	 <nl> - 	 public TextureCoordinate ( ) <nl> - 	 { <nl> - 	 	 this ( 0 . 0f , 0 . 0f , 1 . 0f ) ; <nl> - 	 } <nl> - 	 <nl> - 	 public TextureCoordinate ( float [ ] data ) <nl> - 	 { <nl> - 	 	 this ( data [ 0 ] , data [ 1 ] , data [ 2 ] ) ; <nl> - 	 } <nl> - 	 <nl> - 	 public TextureCoordinate ( Vector3f data ) <nl> - 	 { <nl> - 	 	 this ( data . x , data . y , data . z ) ; <nl> - 	 } <nl> - 	 <nl> - 	 public TextureCoordinate ( float u , float v , float w ) <nl> - 	 { <nl> - 	 	 this . u = u ; <nl> - 	 	 this . v = v ; <nl> - 	 	 this . w = w ; <nl> - 	 } <nl> - 	 <nl> - 	 public Vector3f getData ( ) <nl> - 	 { <nl> - 	 	 return new Vector3f ( this . u , this . v , this . w ) ; <nl> - 	 } <nl> - 	 <nl> - 	 public static TextureCoordinate [ ] getDefaultUVs ( ) <nl> - 	 { <nl> - 	 	 TextureCoordinate [ ] texCoords = new TextureCoordinate [ 4 ] ; <nl> - 	 	 texCoords [ 0 ] = new TextureCoordinate ( 0 . 0f , 0 . 0f , 1 . 0f ) ; <nl> - 	 	 texCoords [ 1 ] = new TextureCoordinate ( 1 . 0f , 0 . 0f , 1 . 0f ) ; <nl> - 	 	 texCoords [ 2 ] = new TextureCoordinate ( 1 . 0f , 1 . 0f , 1 . 0f ) ; <nl> - 	 	 texCoords [ 3 ] = new TextureCoordinate ( 0 . 0f , 1 . 0f , 1 . 0f ) ; <nl> - 	 	 return texCoords ; <nl> - 	 } <nl> + public float u , v , w ; <nl> + <nl> + public TextureCoordinate ( ) <nl> + { <nl> + this ( 0 . 0f , 0 . 0f , 1 . 0f ) ; <nl> + } <nl> + <nl> + public TextureCoordinate ( float [ ] data ) <nl> + { <nl> + this ( data [ 0 ] , data [ 1 ] , data [ 2 ] ) ; <nl> + } <nl> + <nl> + public TextureCoordinate ( Vector3f data ) <nl> + { <nl> + this ( data . x , data . y , data . z ) ; <nl> + } <nl> + <nl> + public TextureCoordinate ( float u , float v , float w ) <nl> + { <nl> + this . u = u ; <nl> + this . v = v ; <nl> + this . w = w ; <nl> + } <nl> + <nl> + public Vector3f getData ( ) <nl> + { <nl> + return new Vector3f ( this . u , this . v , this . w ) ; <nl> + } <nl> + <nl> + public static TextureCoordinate [ ] getDefaultUVs ( ) <nl> + { <nl> + TextureCoordinate [ ] texCoords = new TextureCoordinate [ 4 ] ; <nl> + texCoords [ 0 ] = new TextureCoordinate ( 0 . 0f , 0 . 0f , 1 . 0f ) ; <nl> + texCoords [ 1 ] = new TextureCoordinate ( 1 . 0f , 0 . 0f , 1 . 0f ) ; <nl> + texCoords [ 2 ] = new TextureCoordinate ( 1 . 0f , 1 . 0f , 1 . 0f ) ; <nl> + texCoords [ 3 ] = new TextureCoordinate ( 0 . 0f , 1 . 0f , 1 . 0f ) ; <nl> + return texCoords ; <nl> + } <nl> } <nl> <nl> public static class Group implements IModelPart <nl> @ @ - 1118 , 7 + 1089 , 7 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> LinkedHashSet < Face > faceSet = new LinkedHashSet < Face > ( ) ; <nl> for ( Face f : this . faces ) <nl> { <nl> - / / 	 if ( minUVBounds ! = null & & maxUVBounds ! = null ) f . normalizeUVs ( minUVBounds , maxUVBounds ) ; <nl> + / / if ( minUVBounds ! = null & & maxUVBounds ! = null ) f . normalizeUVs ( minUVBounds , maxUVBounds ) ; <nl> faceSet . add ( f . bake ( transform ) ) ; <nl> } <nl> return faceSet ; <nl> @ @ - 1302 , 10 + 1273 , 10 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> private Set < BakedQuad > quads ; <nl> private ImmutableMap < String , TextureAtlasSprite > textures ; <nl> private TextureAtlasSprite sprite = ModelLoader . White . instance ; <nl> - <nl> + <nl> public OBJBakedModel ( OBJModel model , IModelState state , VertexFormat format , ImmutableMap < String , TextureAtlasSprite > textures ) <nl> { <nl> - 	 this . model = model ; <nl> + this . model = model ; <nl> this . state = state ; <nl> if ( this . state instanceof OBJState ) this . updateStateVisibilityMap ( ( OBJState ) this . state ) ; <nl> this . format = format ; <nl> @ @ - 1333 , 16 + 1304 , 16 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> TRSRTransformation transform = TRSRTransformation . identity ( ) ; <nl> for ( Group g : this . model . getMatLib ( ) . getGroups ( ) . values ( ) ) <nl> { <nl> - / / 	 g . minUVBounds = this . model . getMatLib ( ) . minUVBounds ; <nl> - / / 	 g . maxUVBounds = this . model . getMatLib ( ) . maxUVBounds ; <nl> - / / 	 FMLLog . info ( " Group : % s u : [ % f , % f ] v : [ % f , % f ] " , g . name , g . minUVBounds [ 0 ] , g . maxUVBounds [ 0 ] , g . minUVBounds [ 1 ] , g . maxUVBounds [ 1 ] ) ; <nl> - 	 <nl> + / / g . minUVBounds = this . model . getMatLib ( ) . minUVBounds ; <nl> + / / g . maxUVBounds = this . model . getMatLib ( ) . maxUVBounds ; <nl> + / / FMLLog . info ( " Group : % s u : [ % f , % f ] v : [ % f , % f ] " , g . name , g . minUVBounds [ 0 ] , g . maxUVBounds [ 0 ] , g . minUVBounds [ 1 ] , g . maxUVBounds [ 1 ] ) ; <nl> + <nl> if ( this . state instanceof OBJState ) <nl> { <nl> OBJState state = ( OBJState ) this . state ; <nl> - if ( state . parent ! = null & & state . parent instanceof TRSRTransformation ) <nl> + if ( state . parent ! = null ) <nl> { <nl> - transform = ( TRSRTransformation ) state . parent ; <nl> + transform = state . parent . apply ( model ) ; <nl> } <nl> / / TODO : can this be replaced by updateStateVisibilityMap ( OBJState ) ? <nl> if ( state . getGroupNamesFromMap ( ) . contains ( Group . ALL ) ) <nl> @ @ - 1377 , 14 + 1348 , 9 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> faces . addAll ( g . applyTransform ( transform ) ) ; <nl> } <nl> } <nl> - else if ( this . state instanceof TRSRTransformation ) <nl> - { <nl> - transform = ( TRSRTransformation ) this . state ; <nl> - faces . addAll ( g . applyTransform ( transform ) ) ; <nl> - } <nl> else <nl> { <nl> - transform = TRSRTransformation . identity ( ) ; <nl> + transform = state . apply ( model ) ; <nl> faces . addAll ( g . applyTransform ( transform ) ) ; <nl> } <nl> } <nl> @ @ - 1404 , 10 + 1370 , 11 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> UnpackedBakedQuad . Builder builder = new UnpackedBakedQuad . Builder ( format ) ; <nl> builder . setQuadOrientation ( EnumFacing . getFacingFromVector ( f . getNormal ( ) . x , f . getNormal ( ) . y , f . getNormal ( ) . z ) ) ; <nl> builder . setQuadColored ( ) ; <nl> - putVertexData ( builder , f . verts [ 0 ] , f . getNormal ( ) , TextureCoordinate . getDefaultUVs ( ) [ 0 ] , sprite ) ; <nl> - putVertexData ( builder , f . verts [ 1 ] , f . getNormal ( ) , TextureCoordinate . getDefaultUVs ( ) [ 1 ] , sprite ) ; <nl> - putVertexData ( builder , f . verts [ 2 ] , f . getNormal ( ) , TextureCoordinate . getDefaultUVs ( ) [ 2 ] , sprite ) ; <nl> - putVertexData ( builder , f . verts [ 3 ] , f . getNormal ( ) , TextureCoordinate . getDefaultUVs ( ) [ 3 ] , sprite ) ; <nl> + Normal faceNormal = f . getNormal ( ) ; <nl> + putVertexData ( builder , f . verts [ 0 ] , faceNormal , TextureCoordinate . getDefaultUVs ( ) [ 0 ] , sprite ) ; <nl> + putVertexData ( builder , f . verts [ 1 ] , faceNormal , TextureCoordinate . getDefaultUVs ( ) [ 1 ] , sprite ) ; <nl> + putVertexData ( builder , f . verts [ 2 ] , faceNormal , TextureCoordinate . getDefaultUVs ( ) [ 2 ] , sprite ) ; <nl> + putVertexData ( builder , f . verts [ 3 ] , faceNormal , TextureCoordinate . getDefaultUVs ( ) [ 3 ] , sprite ) ; <nl> quads . add ( builder . build ( ) ) ; <nl> } <nl> } <nl> @ @ - 1426 , 37 + 1393 , 37 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> break ; <nl> case COLOR : <nl> float d ; <nl> - if ( v . hasNormal ( ) ) <nl> - 	 d = LightUtil . diffuseLight ( v . getNormal ( ) . x , v . getNormal ( ) . y , v . getNormal ( ) . z ) ; <nl> - else <nl> - 	 d = LightUtil . diffuseLight ( faceNormal . x , faceNormal . y , faceNormal . z ) ; <nl> - <nl> - if ( v . getMaterial ( ) ! = null ) <nl> - 	 builder . put ( e , <nl> - 	 	 	 d * v . getMaterial ( ) . getColor ( ) . x , <nl> - 	 	 	 d * v . getMaterial ( ) . getColor ( ) . y , <nl> - 	 	 	 d * v . getMaterial ( ) . getColor ( ) . z , <nl> - 	 	 	 v . getMaterial ( ) . getColor ( ) . w ) ; <nl> - else <nl> - 	 builder . put ( e , d , d , d , 1 ) ; <nl> + if ( v . hasNormal ( ) ) <nl> + d = LightUtil . diffuseLight ( v . getNormal ( ) . x , v . getNormal ( ) . y , v . getNormal ( ) . z ) ; <nl> + else <nl> + d = LightUtil . diffuseLight ( faceNormal . x , faceNormal . y , faceNormal . z ) ; <nl> + <nl> + if ( v . getMaterial ( ) ! = null ) <nl> + builder . put ( e , <nl> + d * v . getMaterial ( ) . getColor ( ) . x , <nl> + d * v . getMaterial ( ) . getColor ( ) . y , <nl> + d * v . getMaterial ( ) . getColor ( ) . z , <nl> + v . getMaterial ( ) . getColor ( ) . w ) ; <nl> + else <nl> + builder . put ( e , d , d , d , 1 ) ; <nl> break ; <nl> case UV : <nl> - 	 if ( ! v . hasTextureCoordinate ( ) ) <nl> - 	 	 builder . put ( e , <nl> - 	 	 	 	 sprite . getInterpolatedU ( defUV . u * 16 ) , <nl> - 	 	 	 	 sprite . getInterpolatedV ( defUV . v * 16 ) , <nl> - 	 	 	 	 0 , 1 ) ; <nl> - 	 else <nl> - 	 	 builder . put ( e , <nl> - 	 	 	 	 sprite . getInterpolatedU ( v . getTextureCoordinate ( ) . u * 16 ) , <nl> - 	 	 	 	 sprite . getInterpolatedV ( v . getTextureCoordinate ( ) . v * 16 ) , <nl> - 	 	 	 	 0 , 1 ) ; <nl> + if ( ! v . hasTextureCoordinate ( ) ) <nl> + builder . put ( e , <nl> + sprite . getInterpolatedU ( defUV . u * 16 ) , <nl> + sprite . getInterpolatedV ( ( model . customData . flipV ? 1 - defUV . v : defUV . v ) * 16 ) , <nl> + 0 , 1 ) ; <nl> + else <nl> + builder . put ( e , <nl> + sprite . getInterpolatedU ( v . getTextureCoordinate ( ) . u * 16 ) , <nl> + sprite . getInterpolatedV ( ( model . customData . flipV ? 1 - v . getTextureCoordinate ( ) . v : v . getTextureCoordinate ( ) . v ) * 16 ) , <nl> + 0 , 1 ) ; <nl> break ; <nl> case NORMAL : <nl> - if ( ! v . hasNormal ( ) ) <nl> - 	 builder . put ( e , faceNormal . x , faceNormal . y , faceNormal . z , 1 ) ; <nl> - else <nl> - 	 builder . put ( e , v . getNormal ( ) . x , v . getNormal ( ) . y , v . getNormal ( ) . z , 1 ) ; <nl> + if ( ! v . hasNormal ( ) ) <nl> + builder . put ( e , faceNormal . x , faceNormal . y , faceNormal . z , 0 ) ; <nl> + else <nl> + builder . put ( e , v . getNormal ( ) . x , v . getNormal ( ) . y , v . getNormal ( ) . z , 0 ) ; <nl> break ; <nl> default : <nl> builder . put ( e ) ; <nl> @ @ - 1467 , 13 + 1434 , 13 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> @ Override <nl> public boolean isAmbientOcclusion ( ) <nl> { <nl> - return model ! = null & & model . hasCustomData ( ) ? model . customData . ambientOcclusion : true ; <nl> + return model ! = null ? model . customData . ambientOcclusion : true ; <nl> } <nl> <nl> @ Override <nl> public boolean isGui3d ( ) <nl> { <nl> - return model ! = null & & model . hasCustomData ( ) ? model . customData . gui3d : true ; <nl> + return model ! = null ? model . customData . gui3d : true ; <nl> } <nl> <nl> @ Override <nl> @ @ - 1527 , 7 + 1494 , 7 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> } <nl> return this ; <nl> } <nl> - <nl> + <nl> private void updateStateVisibilityMap ( OBJState state ) <nl> { <nl> if ( state . visibilityMap . containsKey ( Group . ALL ) ) <nl> @ @ - 1602 , 16 + 1569 , 16 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData <nl> return this . model . modelLocation . toString ( ) ; <nl> } <nl> } <nl> - <nl> + <nl> @ SuppressWarnings ( " serial " ) <nl> public static class UVsOutOfBoundsException extends RuntimeException <nl> { <nl> - 	 public ResourceLocation modelLocation ; <nl> - 	 <nl> - 	 public UVsOutOfBoundsException ( ResourceLocation modelLocation ) <nl> - 	 { <nl> - 	 	 super ( String . format ( " Model ' % s ' has UVs ( ' vt ' ) out of bounds 0 - 1 ! The missing model will be used instead . Support for UV processing will be added to the OBJ loader in the future . " , modelLocation ) ) ; <nl> - 	 	 this . modelLocation = modelLocation ; <nl> - 	 } <nl> + public ResourceLocation modelLocation ; <nl> + <nl> + public UVsOutOfBoundsException ( ResourceLocation modelLocation ) <nl> + { <nl> + super ( String . format ( " Model ' % s ' has UVs ( ' vt ' ) out of bounds 0 - 1 ! The missing model will be used instead . Support for UV processing will be added to the OBJ loader in the future . " , modelLocation ) ) ; <nl> + this . modelLocation = modelLocation ; <nl> + } <nl> } <nl> }
NEAREST DIFF (one line): diff - - git a / common / net / minecraftforge / common / DimensionManager . java b / common / net / minecraftforge / common / DimensionManager . java <nl> index 8d39723 . . 8ea6785 100644 <nl> - - - a / common / net / minecraftforge / common / DimensionManager . java <nl> + + + b / common / net / minecraftforge / common / DimensionManager . java <nl> @ @ - 197 , 12 + 197 , 15 @ @ public class DimensionManager <nl> <nl> public static void setWorld ( int id , WorldServer world ) <nl> { <nl> - if ( world ! = null ) { <nl> + if ( world ! = null ) <nl> + { <nl> worlds . put ( id , world ) ; <nl> weakWorldMap . put ( world , world ) ; <nl> MinecraftServer . getServer ( ) . worldTickTimes . put ( id , new long [ 100 ] ) ; <nl> FMLLog . info ( " Loading dimension % d ( % s ) ( % s ) " , id , world . getWorldInfo ( ) . getWorldName ( ) , world . getMinecraftServer ( ) ) ; <nl> - } else { <nl> + } <nl> + else <nl> + { <nl> worlds . remove ( id ) ; <nl> MinecraftServer . getServer ( ) . worldTickTimes . remove ( id ) ; <nl> FMLLog . info ( " Unloading dimension % d " , id ) ; <nl> @ @ - 231 , 14 + 234 , 18 @ @ public class DimensionManager <nl> <nl> public static void initDimension ( int dim ) { <nl> WorldServer overworld = getWorld ( 0 ) ; <nl> - if ( overworld = = null ) { <nl> + if ( overworld = = null ) <nl> + { <nl> throw new RuntimeException ( " Cannot Hotload Dim : Overworld is not Loaded ! " ) ; <nl> } <nl> - try { <nl> + try <nl> + { <nl> DimensionManager . getProviderType ( dim ) ; <nl> - } catch ( Exception e ) { <nl> + } <nl> + catch ( Exception e ) <nl> + { <nl> System . err . println ( " Cannot Hotload Dim : " + e . getMessage ( ) ) ; <nl> - return ; / / If a provider hasn ' t been registered then we can ' t hotload the dim <nl> + return ; / / If a provider hasn ' t been registered then we can ' t hotload the dim <nl> } <nl> MinecraftServer mcServer = overworld . getMinecraftServer ( ) ; <nl> ISaveHandler savehandler = overworld . getSaveHandler ( ) ; <nl> diff - - git a / common / net / minecraftforge / common / ForgeChunkManager . java b / common / net / minecraftforge / common / ForgeChunkManager . java <nl> index ee00212 . . 03d8714 100644 <nl> - - - a / common / net / minecraftforge / common / ForgeChunkManager . java <nl> + + + b / common / net / minecraftforge / common / ForgeChunkManager . java <nl> @ @ - 816 , 7 + 816 , 10 @ @ public class ForgeChunkManager <nl> static void saveWorld ( World world ) <nl> { <nl> / / only persist persistent worlds <nl> - if ( ! ( world instanceof WorldServer ) ) { return ; } <nl> + if ( ! ( world instanceof WorldServer ) ) <nl> + { <nl> + return ; <nl> + } <nl> WorldServer worldServer = ( WorldServer ) world ; <nl> File chunkDir = worldServer . getChunkSaveLocation ( ) ; <nl> File chunkLoaderData = new File ( chunkDir , " forcedchunks . dat " ) ; <nl> diff - - git a / common / net / minecraftforge / fluids / BlockFluidFinite . java b / common / net / minecraftforge / fluids / BlockFluidFinite . java <nl> index 6a6edf7 . . 0dc2d0b 100644 <nl> - - - a / common / net / minecraftforge / fluids / BlockFluidFinite . java <nl> + + + b / common / net / minecraftforge / fluids / BlockFluidFinite . java <nl> @ @ - 31 , 7 + 31 , 8 @ @ public class BlockFluidFinite extends BlockFluidBase <nl> return 0 ; <nl> } <nl> <nl> - if ( world . getBlockId ( x , y , z ) ! = blockID ) { <nl> + if ( world . getBlockId ( x , y , z ) ! = blockID ) <nl> + { <nl> return - 1 ; <nl> } <nl> <nl> @ @ - 110 , 7 + 111 , 8 @ @ public class BlockFluidFinite extends BlockFluidBase <nl> total + = west ; <nl> } <nl> <nl> - if ( east > = 0 ) { <nl> + if ( east > = 0 ) <nl> + { <nl> + + count ; <nl> total + = east ; <nl> } <nl> @ @ - 182 , 10 + 184 , 14 @ @ public class BlockFluidFinite extends BlockFluidBase <nl> + + newwest ; <nl> - - rem ; <nl> } <nl> - if ( newwest ! = west ) { <nl> - if ( newwest = = 0 ) { <nl> + if ( newwest ! = west ) <nl> + { <nl> + if ( newwest = = 0 ) <nl> + { <nl> world . setBlock ( x - 1 , y , z , 0 ) ; <nl> - } else { <nl> + } <nl> + else <nl> + { <nl> world . setBlock ( x - 1 , y , z , blockID , newwest - 1 , 2 ) ; <nl> } <nl> world . scheduleBlockUpdate ( x - 1 , y , z , blockID , tickRate ) ; <nl> diff - - git a / patches / minecraft / net / minecraft / client / entity / EntityPlayerSP . java . patch b / patches / minecraft / net / minecraft / client / entity / EntityPlayerSP . java . patch <nl> index e401b0d . . 810ebea 100644 <nl> - - - a / patches / minecraft / net / minecraft / client / entity / EntityPlayerSP . java . patch <nl> + + + b / patches / minecraft / net / minecraft / client / entity / EntityPlayerSP . java . patch <nl> @ @ - 9 , 11 + 9 , 14 @ @ <nl> <nl> @ SideOnly ( Side . CLIENT ) <nl> public class EntityPlayerSP extends AbstractClientPlayer <nl> - @ @ - 570 , 18 + 572 , 63 @ @ <nl> + @ @ - 570 , 18 + 572 , 66 @ @ <nl> * / <nl> protected boolean pushOutOfBlocks ( double par1 , double par3 , double par5 ) <nl> { <nl> - + if ( this . noClip ) { return false ; } <nl> + + if ( this . noClip ) <nl> + + { <nl> + + return false ; <nl> + + } <nl> int i = MathHelper . floor _ double ( par1 ) ; <nl> int j = MathHelper . floor _ double ( par3 ) ; <nl> int k = MathHelper . floor _ double ( par5 ) ; <nl> @ @ - 79 , 7 + 82 , 7 @ @ <nl> byte b0 = - 1 ; <nl> double d5 = 9999 . 0D ; <nl> <nl> - @ @ - 685 , 6 + 732 , 12 @ @ <nl> + @ @ - 685 , 6 + 735 , 12 @ @ <nl> <nl> public void playSound ( String par1Str , float par2 , float par3 ) <nl> { <nl> diff - - git a / patches / minecraft / net / minecraft / entity / player / EntityPlayer . java . patch b / patches / minecraft / net / minecraft / entity / player / EntityPlayer . java . patch <nl> index 168d019 . . 3ef5937 100644 <nl> - - - a / patches / minecraft / net / minecraft / entity / player / EntityPlayer . java . patch <nl> + + + b / patches / minecraft / net / minecraft / entity / player / EntityPlayer . java . patch <nl> @ @ - 453 , 18 + 453 , 19 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 1650 , 6 + 1803 , 10 @ @ <nl> + @ @ - 1650 , 6 + 1803 , 11 @ @ <nl> * / <nl> public void setSpawnChunk ( ChunkCoordinates par1ChunkCoordinates , boolean par2 ) <nl> { <nl> - + if ( this . dimension ! = 0 ) { <nl> + + if ( this . dimension ! = 0 ) <nl> + + { <nl> + setSpawnChunk ( par1ChunkCoordinates , par2 , this . dimension ) ; <nl> + return ; <nl> + } <nl> if ( par1ChunkCoordinates ! = null ) <nl> { <nl> this . spawnChunk = new ChunkCoordinates ( par1ChunkCoordinates ) ; <nl> - @ @ - 1661 , 7 + 1818 , 32 @ @ <nl> + @ @ - 1661 , 7 + 1819 , 39 @ @ <nl> this . spawnForced = false ; <nl> } <nl> } <nl> @ @ - 477 , 20 + 478 , 27 @ @ <nl> + * @ param dimension Which dimension to apply the player - specific respawn point to <nl> + * / <nl> + public void setSpawnChunk ( ChunkCoordinates chunkCoordinates , boolean forced , int dimension ) { <nl> - + if ( dimension = = 0 ) { <nl> - + if ( chunkCoordinates ! = null ) { <nl> + + if ( dimension = = 0 ) <nl> + + { <nl> + + if ( chunkCoordinates ! = null ) <nl> + + { <nl> + this . spawnChunk = new ChunkCoordinates ( chunkCoordinates ) ; <nl> + this . spawnForced = forced ; <nl> - + } else { <nl> + + } <nl> + + else <nl> + + { <nl> + this . spawnChunk = null ; <nl> + this . spawnForced = false ; <nl> + } <nl> + return ; <nl> + } <nl> - + if ( chunkCoordinates ! = null ) { <nl> + + if ( chunkCoordinates ! = null ) <nl> + + { <nl> + this . spawnChunkMap . put ( dimension , new ChunkCoordinates ( chunkCoordinates ) ) ; <nl> + this . spawnForcedMap . put ( dimension , forced ) ; <nl> - + } else { <nl> + + } <nl> + + else <nl> + + { <nl> + this . spawnChunkMap . remove ( dimension ) ; <nl> + this . spawnForcedMap . remove ( dimension ) ; <nl> + } <nl> @ @ - 498 , 7 + 506 , 7 @ @ <nl> / * * <nl> * Will trigger the specified trigger . <nl> * / <nl> - @ @ - 1843 , 6 + 2025 , 10 @ @ <nl> + @ @ - 1843 , 6 + 2033 , 10 @ @ <nl> <nl> super . fall ( par1 ) ; <nl> } <nl> @ @ - 509 , 7 + 517 , 7 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 1884 , 7 + 2070 , 7 @ @ <nl> + @ @ - 1884 , 7 + 2078 , 7 @ @ <nl> { <nl> if ( par1ItemStack . getItem ( ) . requiresMultipleRenderPasses ( ) ) <nl> { <nl> @ @ - 518 , 7 + 526 , 7 @ @ <nl> } <nl> <nl> if ( this . itemInUse ! = null & & par1ItemStack . itemID = = Item . bow . itemID ) <nl> - @ @ - 1906 , 6 + 2092 , 7 @ @ <nl> + @ @ - 1906 , 6 + 2100 , 7 @ @ <nl> return Item . bow . getItemIconForUseDuration ( 0 ) ; <nl> } <nl> } <nl> @ @ - 526 , 7 + 534 , 7 @ @ <nl> } <nl> <nl> return icon ; <nl> - @ @ - 2127 , 7 + 2314 , 17 @ @ <nl> + @ @ - 2127 , 7 + 2322 , 17 @ @ <nl> this . setScore ( par1EntityPlayer . getScore ( ) ) ; <nl> } <nl> <nl> @ @ - 544 , 7 + 552 , 7 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 2191 , 7 + 2388 , 14 @ @ <nl> + @ @ - 2191 , 7 + 2396 , 14 @ @ <nl> * / <nl> public void setCurrentItemOrArmor ( int par1 , ItemStack par2ItemStack ) <nl> { <nl> @ @ - 560 , 7 + 568 , 7 @ @ <nl> } <nl> <nl> @ SideOnly ( Side . CLIENT ) <nl> - @ @ - 2245 , 7 + 2449 , 7 @ @ <nl> + @ @ - 2245 , 7 + 2457 , 7 @ @ <nl> * / <nl> public String getTranslatedEntityName ( ) <nl> { <nl> @ @ - 569 , 7 + 577 , 7 @ @ <nl> } <nl> <nl> public void setAbsorptionAmount ( float par1 ) <nl> - @ @ - 2267 , 4 + 2471 , 39 @ @ <nl> + @ @ - 2267 , 4 + 2479 , 39 @ @ <nl> { <nl> FMLNetworkHandler . openGui ( this , mod , modGuiId , world , x , y , z ) ; <nl> } <nl> diff - - git a / patches / minecraft / net / minecraft / world / World . java . patch b / patches / minecraft / net / minecraft / world / World . java . patch <nl> index 68e76d6 . . 92fdbc5 100644 <nl> - - - a / patches / minecraft / net / minecraft / world / World . java . patch <nl> + + + b / patches / minecraft / net / minecraft / world / World . java . patch <nl> @ @ - 114 , 7 + 114 , 7 @ @ <nl> } <nl> else <nl> { <nl> - @ @ - 290 , 6 + 337 , 19 @ @ <nl> + @ @ - 290 , 6 + 337 , 20 @ @ <nl> <nl> this . calculateInitialSkylight ( ) ; <nl> this . calculateInitialWeather ( ) ; <nl> @ @ - 126 , 7 + 126 , 8 @ @ <nl> + / / Buildcraft has suffered from the issue this fixes . If you load the same data from two different worlds they can get two different copies of the same object , thus the last saved gets final say . <nl> + private MapStorage getMapStorage ( ISaveHandler savehandler ) <nl> + { <nl> - + if ( s _ savehandler ! = savehandler | | s _ mapStorage = = null ) { <nl> + + if ( s _ savehandler ! = savehandler | | s _ mapStorage = = null ) <nl> + + { <nl> + s _ mapStorage = new MapStorage ( savehandler ) ; <nl> + s _ savehandler = savehandler ; <nl> + } <nl> @ @ - 134 , 7 + 135 , 7 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 373 , 7 + 433 , 8 @ @ <nl> + @ @ - 373 , 7 + 434 , 8 @ @ <nl> * / <nl> public boolean isAirBlock ( int par1 , int par2 , int par3 ) <nl> { <nl> @ @ - 144 , 7 + 145 , 7 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 382 , 7 + 443 , 8 @ @ <nl> + @ @ - 382 , 7 + 444 , 8 @ @ <nl> public boolean blockHasTileEntity ( int par1 , int par2 , int par3 ) <nl> { <nl> int l = this . getBlockId ( par1 , par2 , par3 ) ; <nl> @ @ - 154 , 7 + 155 , 7 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 1157 , 7 + 1219 , 7 @ @ <nl> + @ @ - 1157 , 7 + 1220 , 7 @ @ <nl> * / <nl> public boolean isDaytime ( ) <nl> { <nl> @ @ - 163 , 7 + 164 , 7 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 1192 , 7 + 1254 , 7 @ @ <nl> + @ @ - 1192 , 7 + 1255 , 7 @ @ <nl> int l1 = this . getBlockMetadata ( l , i1 , j1 ) ; <nl> Block block = Block . blocksList [ k1 ] ; <nl> <nl> @ @ - 172 , 7 + 173 , 7 @ @ <nl> { <nl> MovingObjectPosition movingobjectposition = block . collisionRayTrace ( this , l , i1 , j1 , par1Vec3 , par2Vec3 ) ; <nl> <nl> - @ @ - 1392 , 6 + 1454 , 12 @ @ <nl> + @ @ - 1392 , 6 + 1455 , 12 @ @ <nl> * / <nl> public void playSoundAtEntity ( Entity par1Entity , String par2Str , float par3 , float par4 ) <nl> { <nl> @ @ - 185 , 7 + 186 , 7 @ @ <nl> if ( par1Entity ! = null & & par2Str ! = null ) <nl> { <nl> for ( int i = 0 ; i < this . worldAccesses . size ( ) ; + + i ) <nl> - @ @ - 1406 , 6 + 1474 , 12 @ @ <nl> + @ @ - 1406 , 6 + 1475 , 12 @ @ <nl> * / <nl> public void playSoundToNearExcept ( EntityPlayer par1EntityPlayer , String par2Str , float par3 , float par4 ) <nl> { <nl> @ @ - 198 , 7 + 199 , 7 @ @ <nl> if ( par1EntityPlayer ! = null & & par2Str ! = null ) <nl> { <nl> for ( int i = 0 ; i < this . worldAccesses . size ( ) ; + + i ) <nl> - @ @ - 1492 , 6 + 1566 , 11 @ @ <nl> + @ @ - 1492 , 6 + 1567 , 11 @ @ <nl> EntityPlayer entityplayer = ( EntityPlayer ) par1Entity ; <nl> this . playerEntities . add ( entityplayer ) ; <nl> this . updateAllPlayersSleepingFlag ( ) ; <nl> @ @ - 210 , 7 + 211 , 7 @ @ <nl> } <nl> <nl> this . getChunkFromChunkCoords ( i , j ) . addEntity ( par1Entity ) ; <nl> - @ @ - 1732 , 6 + 1811 , 12 @ @ <nl> + @ @ - 1732 , 6 + 1812 , 12 @ @ <nl> * Calculates the color for the skybox <nl> * / <nl> public Vec3 getSkyColor ( Entity par1Entity , float par2 ) <nl> @ @ - 223 , 7 + 224 , 7 @ @ <nl> { <nl> float f1 = this . getCelestialAngle ( par2 ) ; <nl> float f2 = MathHelper . cos ( f1 * ( float ) Math . PI * 2 . 0F ) * 2 . 0F + 0 . 5F ; <nl> - @ @ - 1833 , 6 + 1918 , 12 @ @ <nl> + @ @ - 1833 , 6 + 1919 , 12 @ @ <nl> @ SideOnly ( Side . CLIENT ) <nl> public Vec3 getCloudColour ( float par1 ) <nl> { <nl> @ @ - 236 , 7 + 237 , 7 @ @ <nl> float f1 = this . getCelestialAngle ( par1 ) ; <nl> float f2 = MathHelper . cos ( f1 * ( float ) Math . PI * 2 . 0F ) * 2 . 0F + 0 . 5F ; <nl> <nl> - @ @ - 1904 , 6 + 1995 , 8 @ @ <nl> + @ @ - 1904 , 6 + 1996 , 8 @ @ <nl> public int getTopSolidOrLiquidBlock ( int par1 , int par2 ) <nl> { <nl> Chunk chunk = this . getChunkFromBlockCoords ( par1 , par2 ) ; <nl> @ @ - 245 , 7 + 246 , 7 @ @ <nl> int k = chunk . getTopFilledSegment ( ) + 15 ; <nl> par1 & = 15 ; <nl> <nl> - @ @ - 1911 , 7 + 2004 , 7 @ @ <nl> + @ @ - 1911 , 7 + 2005 , 7 @ @ <nl> { <nl> int l = chunk . getBlockID ( par1 , k , par2 ) ; <nl> <nl> @ @ - 254 , 7 + 255 , 7 @ @ <nl> { <nl> return k + 1 ; <nl> } <nl> - @ @ - 1926 , 6 + 2019 , 12 @ @ <nl> + @ @ - 1926 , 6 + 2020 , 12 @ @ <nl> * How bright are stars in the sky <nl> * / <nl> public float getStarBrightness ( float par1 ) <nl> @ @ - 267 , 7 + 268 , 7 @ @ <nl> { <nl> float f1 = this . getCelestialAngle ( par1 ) ; <nl> float f2 = 1 . 0F - ( MathHelper . cos ( f1 * ( float ) Math . PI * 2 . 0F ) * 2 . 0F + 0 . 25F ) ; <nl> - @ @ - 1990 , 7 + 2089 , 15 @ @ <nl> + @ @ - 1990 , 7 + 2090 , 15 @ @ <nl> entity . addEntityCrashInfo ( crashreportcategory ) ; <nl> } <nl> <nl> @ @ - 284 , 7 + 285 , 7 @ @ <nl> } <nl> <nl> if ( entity . isDead ) <nl> - @ @ - 2052 , 7 + 2159 , 16 @ @ <nl> + @ @ - 2052 , 7 + 2160 , 16 @ @ <nl> crashreport = CrashReport . makeCrashReport ( throwable1 , " Ticking entity " ) ; <nl> crashreportcategory = crashreport . makeCategory ( " Entity being ticked " ) ; <nl> entity . addEntityCrashInfo ( crashreportcategory ) ; <nl> @ @ - 302 , 7 + 303 , 7 @ @ <nl> } <nl> } <nl> <nl> - @ @ - 2095 , 7 + 2211 , 16 @ @ <nl> + @ @ - 2095 , 7 + 2212 , 16 @ @ <nl> crashreport = CrashReport . makeCrashReport ( throwable2 , " Ticking tile entity " ) ; <nl> crashreportcategory = crashreport . makeCategory ( " Tile entity being ticked " ) ; <nl> tileentity . func _ 85027 _ a ( crashreportcategory ) ; <nl> @ @ - 320 , 7 + 321 , 7 @ @ <nl> } <nl> } <nl> <nl> - @ @ - 2109 , 7 + 2234 , 7 @ @ <nl> + @ @ - 2109 , 7 + 2235 , 7 @ @ <nl> <nl> if ( chunk ! = null ) <nl> { <nl> @ @ - 329 , 7 + 330 , 7 @ @ <nl> } <nl> } <nl> } <nl> - @ @ - 2118 , 6 + 2243 , 10 @ @ <nl> + @ @ - 2118 , 6 + 2244 , 10 @ @ <nl> <nl> if ( ! this . entityRemoval . isEmpty ( ) ) <nl> { <nl> @ @ - 340 , 7 + 341 , 7 @ @ <nl> this . loadedTileEntityList . removeAll ( this . entityRemoval ) ; <nl> this . entityRemoval . clear ( ) ; <nl> } <nl> - @ @ - 2138 , 18 + 2267 , 18 @ @ <nl> + @ @ - 2138 , 18 + 2268 , 18 @ @ <nl> { <nl> this . loadedTileEntityList . add ( tileentity1 ) ; <nl> } <nl> @ @ - 363 , 7 + 364 , 7 @ @ <nl> } <nl> } <nl> <nl> - @ @ - 2162 , 13 + 2291 , 13 @ @ <nl> + @ @ - 2162 , 13 + 2292 , 13 @ @ <nl> <nl> public void addTileEntity ( Collection par1Collection ) <nl> { <nl> @ @ - 384 , 7 + 385 , 7 @ @ <nl> } <nl> } <nl> <nl> - @ @ - 2188 , 9 + 2317 , 17 @ @ <nl> + @ @ - 2188 , 9 + 2318 , 17 @ @ <nl> { <nl> int i = MathHelper . floor _ double ( par1Entity . posX ) ; <nl> int j = MathHelper . floor _ double ( par1Entity . posZ ) ; <nl> @ @ - 405 , 7 + 406 , 7 @ @ <nl> { <nl> par1Entity . lastTickPosX = par1Entity . posX ; <nl> par1Entity . lastTickPosY = par1Entity . posY ; <nl> - @ @ - 2424 , 6 + 2561 , 14 @ @ <nl> + @ @ - 2424 , 6 + 2562 , 14 @ @ <nl> { <nl> return true ; <nl> } <nl> @ @ - 420 , 7 + 421 , 7 @ @ <nl> } <nl> } <nl> } <nl> - @ @ - 2746 , 15 + 2891 , 16 @ @ <nl> + @ @ - 2746 , 15 + 2892 , 16 @ @ <nl> * / <nl> public void setBlockTileEntity ( int par1 , int par2 , int par3 , TileEntity par4TileEntity ) <nl> { <nl> @ @ - 446 , 7 + 447 , 7 @ @ <nl> while ( iterator . hasNext ( ) ) <nl> { <nl> TileEntity tileentity1 = ( TileEntity ) iterator . next ( ) ; <nl> - @ @ - 2765 , 20 + 2911 , 21 @ @ <nl> + @ @ - 2765 , 20 + 2912 , 21 @ @ <nl> iterator . remove ( ) ; <nl> } <nl> } <nl> @ @ - 479 , 7 + 480 , 7 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 2786 , 28 + 2933 , 13 @ @ <nl> + @ @ - 2786 , 28 + 2934 , 13 @ @ <nl> * / <nl> public void removeBlockTileEntity ( int par1 , int par2 , int par3 ) <nl> { <nl> @ @ - 515 , 7 + 516 , 7 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 2832 , 7 + 2964 , 8 @ @ <nl> + @ @ - 2832 , 7 + 2965 , 8 @ @ <nl> * / <nl> public boolean isBlockNormalCube ( int par1 , int par2 , int par3 ) <nl> { <nl> @ @ - 525 , 7 + 526 , 7 @ @ <nl> } <nl> <nl> public boolean isBlockFullCube ( int par1 , int par2 , int par3 ) <nl> - @ @ - 2855 , 16 + 2988 , 17 @ @ <nl> + @ @ - 2855 , 16 + 2989 , 17 @ @ <nl> * / <nl> public boolean doesBlockHaveSolidTopSurface ( int par1 , int par2 , int par3 ) <nl> { <nl> @ @ - 545 , 7 + 546 , 7 @ @ <nl> return par1Block = = null ? false : ( par1Block . blockMaterial . isOpaque ( ) & & par1Block . renderAsNormalBlock ( ) ? true : ( par1Block instanceof BlockStairs ? ( par2 & 4 ) = = 4 : ( par1Block instanceof BlockHalfSlab ? ( par2 & 8 ) = = 8 : ( par1Block instanceof BlockHopper ? true : ( par1Block instanceof BlockSnow ? ( par2 & 7 ) = = 7 : false ) ) ) ) ) ; <nl> } <nl> <nl> - @ @ - 2881 , 7 + 3015 , 7 @ @ <nl> + @ @ - 2881 , 7 + 3016 , 7 @ @ <nl> if ( chunk ! = null & & ! chunk . isEmpty ( ) ) <nl> { <nl> Block block = Block . blocksList [ this . getBlockId ( par1 , par2 , par3 ) ] ; <nl> @ @ - 554 , 7 + 555 , 7 @ @ <nl> } <nl> else <nl> { <nl> - @ @ - 2912 , 8 + 3046 , 7 @ @ <nl> + @ @ - 2912 , 8 + 3047 , 7 @ @ <nl> * / <nl> public void setAllowedSpawnTypes ( boolean par1 , boolean par2 ) <nl> { <nl> @ @ - 564 , 7 + 565 , 7 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 2929 , 6 + 3062 , 11 @ @ <nl> + @ @ - 2929 , 6 + 3063 , 11 @ @ <nl> * / <nl> private void calculateInitialWeather ( ) <nl> { <nl> @ @ - 576 , 7 + 577 , 7 @ @ <nl> if ( this . worldInfo . isRaining ( ) ) <nl> { <nl> this . rainingStrength = 1 . 0F ; <nl> - @ @ - 2944 , 6 + 3082 , 11 @ @ <nl> + @ @ - 2944 , 6 + 3083 , 11 @ @ <nl> * Updates all weather states . <nl> * / <nl> protected void updateWeather ( ) <nl> @ @ - 588 , 7 + 589 , 7 @ @ <nl> { <nl> if ( ! this . provider . hasNoSky ) <nl> { <nl> - @ @ - 3041 , 12 + 3184 , 14 @ @ <nl> + @ @ - 3041 , 12 + 3185 , 14 @ @ <nl> <nl> public void toggleRain ( ) <nl> { <nl> @ @ - 604 , 7 + 605 , 7 @ @ <nl> this . theProfiler . startSection ( " buildList " ) ; <nl> int i ; <nl> EntityPlayer entityplayer ; <nl> - @ @ - 3153 , 6 + 3298 , 11 @ @ <nl> + @ @ - 3153 , 6 + 3299 , 11 @ @ <nl> * / <nl> public boolean canBlockFreeze ( int par1 , int par2 , int par3 , boolean par4 ) <nl> { <nl> @ @ - 616 , 7 + 617 , 7 @ @ <nl> BiomeGenBase biomegenbase = this . getBiomeGenForCoords ( par1 , par3 ) ; <nl> float f = biomegenbase . getFloatTemperature ( ) ; <nl> <nl> - @ @ - 3211 , 6 + 3361 , 11 @ @ <nl> + @ @ - 3211 , 6 + 3362 , 11 @ @ <nl> * / <nl> public boolean canSnowAt ( int par1 , int par2 , int par3 ) <nl> { <nl> @ @ - 628 , 7 + 629 , 7 @ @ <nl> BiomeGenBase biomegenbase = this . getBiomeGenForCoords ( par1 , par3 ) ; <nl> float f = biomegenbase . getFloatTemperature ( ) ; <nl> <nl> - @ @ - 3254 , 10 + 3409 , 12 @ @ <nl> + @ @ - 3254 , 10 + 3410 , 12 @ @ <nl> else <nl> { <nl> int l = this . getBlockId ( par1 , par2 , par3 ) ; <nl> @ @ - 645 , 7 + 646 , 7 @ @ <nl> { <nl> j1 = 1 ; <nl> } <nl> - @ @ - 3353 , 7 + 3510 , 9 @ @ <nl> + @ @ - 3353 , 7 + 3511 , 9 @ @ <nl> int j4 = i2 + Facing . offsetsXForSide [ i4 ] ; <nl> int k4 = j2 + Facing . offsetsYForSide [ i4 ] ; <nl> int l4 = k2 + Facing . offsetsZForSide [ i4 ] ; <nl> @ @ - 656 , 7 + 657 , 7 @ @ <nl> i3 = this . getSavedLightValue ( par1EnumSkyBlock , j4 , k4 , l4 ) ; <nl> <nl> if ( i3 = = l2 - i5 & & i1 < this . lightUpdateBlockList . length ) <nl> - @ @ - 3456 , 10 + 3615 , 10 @ @ <nl> + @ @ - 3456 , 10 + 3616 , 10 @ @ <nl> public List getEntitiesWithinAABBExcludingEntity ( Entity par1Entity , AxisAlignedBB par2AxisAlignedBB , IEntitySelector par3IEntitySelector ) <nl> { <nl> ArrayList arraylist = new ArrayList ( ) ; <nl> @ @ - 671 , 7 + 672 , 7 @ @ <nl> <nl> for ( int i1 = i ; i1 < = j ; + + i1 ) <nl> { <nl> - @ @ - 3485 , 10 + 3644 , 10 @ @ <nl> + @ @ - 3485 , 10 + 3645 , 10 @ @ <nl> <nl> public List selectEntitiesWithinAABB ( Class par1Class , AxisAlignedBB par2AxisAlignedBB , IEntitySelector par3IEntitySelector ) <nl> { <nl> @ @ - 686 , 7 + 687 , 7 @ @ <nl> ArrayList arraylist = new ArrayList ( ) ; <nl> <nl> for ( int i1 = i ; i1 < = j ; + + i1 ) <nl> - @ @ - 3582 , 11 + 3741 , 14 @ @ <nl> + @ @ - 3582 , 11 + 3742 , 14 @ @ <nl> * / <nl> public void addLoadedEntities ( List par1List ) <nl> { <nl> @ @ - 704 , 7 + 705 , 7 @ @ <nl> } <nl> } <nl> <nl> - @ @ - 3620 , 6 + 3782 , 11 @ @ <nl> + @ @ - 3620 , 6 + 3783 , 11 @ @ <nl> else <nl> { <nl> if ( block ! = null & & ( block = = Block . waterMoving | | block = = Block . waterStill | | block = = Block . lavaMoving | | block = = Block . lavaStill | | block = = Block . fire | | block . blockMaterial . isReplaceable ( ) ) ) <nl> @ @ - 716 , 7 + 717 , 7 @ @ <nl> { <nl> block = null ; <nl> } <nl> - @ @ - 3914 , 7 + 4081 , 7 @ @ <nl> + @ @ - 3914 , 7 + 4082 , 7 @ @ <nl> * / <nl> public long getSeed ( ) <nl> { <nl> @ @ - 725 , 7 + 726 , 7 @ @ <nl> } <nl> <nl> public long getTotalWorldTime ( ) <nl> - @ @ - 3924 , 7 + 4091 , 7 @ @ <nl> + @ @ - 3924 , 7 + 4092 , 7 @ @ <nl> <nl> public long getWorldTime ( ) <nl> { <nl> @ @ - 734 , 7 + 735 , 7 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 3932 , 7 + 4099 , 7 @ @ <nl> + @ @ - 3932 , 7 + 4100 , 7 @ @ <nl> * / <nl> public void setWorldTime ( long par1 ) <nl> { <nl> @ @ - 743 , 7 + 744 , 7 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 3940 , 13 + 4107 , 13 @ @ <nl> + @ @ - 3940 , 13 + 4108 , 13 @ @ <nl> * / <nl> public ChunkCoordinates getSpawnPoint ( ) <nl> { <nl> @ @ - 759 , 7 + 760 , 7 @ @ <nl> } <nl> <nl> @ SideOnly ( Side . CLIENT ) <nl> - @ @ - 3970 , 7 + 4137 , 10 @ @ <nl> + @ @ - 3970 , 7 + 4138 , 10 @ @ <nl> <nl> if ( ! this . loadedEntityList . contains ( par1Entity ) ) <nl> { <nl> @ @ - 771 , 7 + 772 , 7 @ @ <nl> } <nl> } <nl> <nl> - @ @ - 3978 , 6 + 4148 , 11 @ @ <nl> + @ @ - 3978 , 6 + 4149 , 11 @ @ <nl> * Called when checking if a certain block can be mined or not . The ' spawn safe zone ' check is located here . <nl> * / <nl> public boolean canMineBlock ( EntityPlayer par1EntityPlayer , int par2 , int par3 , int par4 ) <nl> @ @ - 783 , 7 + 784 , 7 @ @ <nl> { <nl> return true ; <nl> } <nl> - @ @ - 4098 , 8 + 4273 , 7 @ @ <nl> + @ @ - 4098 , 8 + 4274 , 7 @ @ <nl> * / <nl> public boolean isBlockHighHumidity ( int par1 , int par2 , int par3 ) <nl> { <nl> @ @ - 793 , 7 + 794 , 7 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 4174 , 7 + 4348 , 7 @ @ <nl> + @ @ - 4174 , 7 + 4349 , 7 @ @ <nl> * / <nl> public int getHeight ( ) <nl> { <nl> @ @ - 802 , 7 + 803 , 7 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 4182 , 7 + 4356 , 7 @ @ <nl> + @ @ - 4182 , 7 + 4357 , 7 @ @ <nl> * / <nl> public int getActualHeight ( ) <nl> { <nl> @ @ - 811 , 7 + 812 , 7 @ @ <nl> } <nl> <nl> public IUpdatePlayerListBox getMinecartSoundUpdater ( EntityMinecart par1EntityMinecart ) <nl> - @ @ - 4225 , 7 + 4399 , 7 @ @ <nl> + @ @ - 4225 , 7 + 4400 , 7 @ @ <nl> * / <nl> public double getHorizon ( ) <nl> { <nl> @ @ - 820 , 7 + 821 , 7 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 4294 , 30 + 4468 , 28 @ @ <nl> + @ @ - 4294 , 30 + 4469 , 28 @ @ <nl> <nl> public void func _ 96440 _ m ( int par1 , int par2 , int par3 , int par4 ) <nl> { <nl> @ @ - 872 , 7 + 873 , 7 @ @ <nl> } <nl> } <nl> } <nl> - @ @ - 4363 , 4 + 4535 , 115 @ @ <nl> + @ @ - 4363 , 4 + 4536 , 115 @ @ <nl> <nl> return MathHelper . clamp _ float ( f , 0 . 0F , flag ? 1 . 5F : 1 . 0F ) ; <nl> } <nl> diff - - git a / patches / minecraft / net / minecraft / world / chunk / Chunk . java . patch b / patches / minecraft / net / minecraft / world / chunk / Chunk . java . patch <nl> index fa2590f . . 89f4e50 100644 <nl> - - - a / patches / minecraft / net / minecraft / world / chunk / Chunk . java . patch <nl> + + + b / patches / minecraft / net / minecraft / world / chunk / Chunk . java . patch <nl> @ @ - 22 , 7 + 22 , 7 @ @ <nl> <nl> if ( b0 ! = 0 ) <nl> { <nl> - @ @ - 159 , 6 + 165 , 90 @ @ <nl> + @ @ - 159 , 6 + 165 , 92 @ @ <nl> } <nl> <nl> / * * <nl> @ @ - 94 , 13 + 94 , 15 @ @ <nl> + int id = ids [ idx ] & 0xFFFFFF ; <nl> + int meta = metadata [ idx ] ; <nl> + <nl> - + if ( id ! = 0 ) { <nl> + + if ( id ! = 0 ) <nl> + + { <nl> + int storageBlock = y > > 4 ; <nl> + <nl> - + if ( this . storageArrays [ storageBlock ] = = null ) { <nl> - + this . storageArrays [ storageBlock ] = new ExtendedBlockStorage ( storageBlock < < 4 , ! world . provider . hasNoSky ) ; <nl> + + if ( this . storageArrays [ storageBlock ] = = null ) <nl> + + { <nl> + + this . storageArrays [ storageBlock ] = new ExtendedBlockStorage ( storageBlock < < 4 , ! world . provider . hasNoSky ) ; <nl> + } <nl> - + <nl> + + <nl> + this . storageArrays [ storageBlock ] . setExtBlockID ( x , y & 15 , z , id ) ; <nl> + this . storageArrays [ storageBlock ] . setExtBlockMetadata ( x , y & 15 , z , meta ) ; <nl> + } <nl> @ @ - 113 , 7 + 115 , 7 @ @ <nl> * Checks whether the chunk is at the X / Z location specified <nl> * / <nl> public boolean isAtLocation ( int par1 , int par2 ) <nl> - @ @ - 222 , 7 + 312 , 7 @ @ <nl> + @ @ - 222 , 7 + 314 , 7 @ @ <nl> { <nl> int i1 = this . getBlockID ( j , l - 1 , k ) ; <nl> <nl> @ @ - 122 , 7 + 124 , 7 @ @ <nl> { <nl> - - l ; <nl> continue ; <nl> - @ @ - 528 , 7 + 618 , 10 @ @ <nl> + @ @ - 528 , 7 + 620 , 10 @ @ <nl> <nl> public int getBlockLightOpacity ( int par1 , int par2 , int par3 ) <nl> { <nl> @ @ - 134 , 7 + 136 , 7 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 615 , 9 + 708 , 13 @ @ <nl> + @ @ - 615 , 9 + 710 , 13 @ @ <nl> { <nl> Block . blocksList [ l1 ] . breakBlock ( this . worldObj , j2 , par2 , k2 , l1 , i2 ) ; <nl> } <nl> @ @ - 151 , 7 + 153 , 7 @ @ <nl> } <nl> } <nl> <nl> - @ @ - 635 , 7 + 732 , 7 @ @ <nl> + @ @ - 635 , 7 + 734 , 7 @ @ <nl> } <nl> else <nl> { <nl> @ @ - 160 , 7 + 162 , 7 @ @ <nl> { <nl> if ( par2 > = k1 ) <nl> { <nl> - @ @ - 659 , 29 + 756 , 21 @ @ <nl> + @ @ - 659 , 29 + 758 , 21 @ @ <nl> Block . blocksList [ par4 ] . onBlockAdded ( this . worldObj , j2 , par2 , k2 ) ; <nl> } <nl> <nl> @ @ - 193 , 7 + 195 , 7 @ @ <nl> } <nl> } <nl> <nl> - @ @ - 716 , 7 + 805 , 7 @ @ <nl> + @ @ - 716 , 7 + 807 , 7 @ @ <nl> extendedblockstorage . setExtBlockMetadata ( par1 , par2 & 15 , par3 , par4 ) ; <nl> int j1 = extendedblockstorage . getExtBlockID ( par1 , par2 & 15 , par3 ) ; <nl> <nl> @ @ - 202 , 7 + 204 , 7 @ @ <nl> { <nl> TileEntity tileentity = this . getChunkBlockTileEntity ( par1 , par2 , par3 ) ; <nl> <nl> - @ @ - 829 , 6 + 918 , 7 @ @ <nl> + @ @ - 829 , 6 + 920 , 7 @ @ <nl> k = this . entityLists . length - 1 ; <nl> } <nl> <nl> @ @ - 210 , 7 + 212 , 7 @ @ <nl> par1Entity . addedToChunk = true ; <nl> par1Entity . chunkCoordX = this . xPosition ; <nl> par1Entity . chunkCoordY = k ; <nl> - @ @ - 878 , 33 + 968 , 32 @ @ <nl> + @ @ - 878 , 33 + 970 , 32 @ @ <nl> ChunkPosition chunkposition = new ChunkPosition ( par1 , par2 , par3 ) ; <nl> TileEntity tileentity = ( TileEntity ) this . chunkTileEntityMap . get ( chunkposition ) ; <nl> <nl> @ @ - 255 , 7 + 257 , 7 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 919 , 7 + 1008 , 7 @ @ <nl> + @ @ - 919 , 7 + 1010 , 7 @ @ <nl> <nl> if ( this . isChunkLoaded ) <nl> { <nl> @ @ - 264 , 7 + 266 , 7 @ @ <nl> } <nl> } <nl> <nl> - @ @ - 934 , 7 + 1023 , 8 @ @ <nl> + @ @ - 934 , 7 + 1025 , 8 @ @ <nl> par4TileEntity . yCoord = par2 ; <nl> par4TileEntity . zCoord = this . zPosition * 16 + par3 ; <nl> <nl> @ @ - 274 , 7 + 276 , 7 @ @ <nl> { <nl> if ( this . chunkTileEntityMap . containsKey ( chunkposition ) ) <nl> { <nl> - @ @ - 984 , 6 + 1074 , 7 @ @ <nl> + @ @ - 984 , 6 + 1076 , 7 @ @ <nl> <nl> this . worldObj . addLoadedEntities ( this . entityLists [ i ] ) ; <nl> } <nl> @ @ - 282 , 7 + 284 , 7 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 1004 , 6 + 1095 , 7 @ @ <nl> + @ @ - 1004 , 6 + 1097 , 7 @ @ <nl> { <nl> this . worldObj . unloadEntities ( this . entityLists [ i ] ) ; <nl> } <nl> @ @ - 290 , 7 + 292 , 7 @ @ <nl> } <nl> <nl> / * * <nl> - @ @ - 1020 , 8 + 1112 , 8 @ @ <nl> + @ @ - 1020 , 8 + 1114 , 8 @ @ <nl> * / <nl> public void getEntitiesWithinAABBForEntity ( Entity par1Entity , AxisAlignedBB par2AxisAlignedBB , List par3List , IEntitySelector par4IEntitySelector ) <nl> { <nl> @ @ - 301 , 7 + 303 , 7 @ @ <nl> <nl> if ( i < 0 ) <nl> { <nl> - @ @ - 1070 , 8 + 1162 , 8 @ @ <nl> + @ @ - 1070 , 8 + 1164 , 8 @ @ <nl> * / <nl> public void getEntitiesOfTypeWithinAAAB ( Class par1Class , AxisAlignedBB par2AxisAlignedBB , List par3List , IEntitySelector par4IEntitySelector ) <nl> { <nl> @ @ - 312 , 7 + 314 , 7 @ @ <nl> <nl> if ( i < 0 ) <nl> { <nl> - @ @ - 1254 , 6 + 1346 , 15 @ @ <nl> + @ @ - 1254 , 6 + 1348 , 15 @ @ <nl> * / <nl> public void fillChunk ( byte [ ] par1ArrayOfByte , int par2 , int par3 , boolean par4 ) <nl> { <nl> @ @ - 328 , 7 + 330 , 7 @ @ <nl> int k = 0 ; <nl> boolean flag1 = ! this . worldObj . provider . hasNoSky ; <nl> int l ; <nl> - @ @ - 1354 , 12 + 1455 , 26 @ @ <nl> + @ @ - 1354 , 12 + 1457 , 26 @ @ <nl> } <nl> <nl> this . generateHeightMap ( ) ; <nl> @ @ - 359 , 7 + 361 , 7 @ @ <nl> } <nl> } <nl> <nl> - @ @ - 1468 , 4 + 1583 , 18 @ @ <nl> + @ @ - 1468 , 4 + 1585 , 18 @ @ <nl> } <nl> } <nl> }

TEST DIFF:
diff - - git a / src / main / java / net / minecraftforge / client / model / b3d / B3DLoader . java b / src / main / java / net / minecraftforge / client / model / b3d / B3DLoader . java 
 index a899847 . . d75ab37 100644 
 - - - a / src / main / java / net / minecraftforge / client / model / b3d / B3DLoader . java 
 + + + b / src / main / java / net / minecraftforge / client / model / b3d / B3DLoader . java 
 @ @ - 582 , 11 + 582 , 11 @ @ public class B3DLoader implements ICustomModelLoader 
 case NORMAL : 
 if ( v . getNormal ( ) ! = null ) 
 { 
 - builder . put ( e , v . getNormal ( ) . x , v . getNormal ( ) . y , v . getNormal ( ) . z , 1 ) ; 
 + builder . put ( e , v . getNormal ( ) . x , v . getNormal ( ) . y , v . getNormal ( ) . z , 0 ) ; 
 } 
 else 
 { 
 - builder . put ( e , faceNormal . x , faceNormal . y , faceNormal . z , 1 ) ; 
 + builder . put ( e , faceNormal . x , faceNormal . y , faceNormal . z , 0 ) ; 
 } 
 break ; 
 default : 
 diff - - git a / src / main / java / net / minecraftforge / client / model / b3d / B3DModel . java b / src / main / java / net / minecraftforge / client / model / b3d / B3DModel . java 
 index 070e01f . . c9b889a 100644 
 - - - a / src / main / java / net / minecraftforge / client / model / b3d / B3DModel . java 
 + + + b / src / main / java / net / minecraftforge / client / model / b3d / B3DModel . java 
 @ @ - 17 , 6 + 17 , 7 @ @ import java . util . List ; 
 import java . util . Map ; 
 import java . util . Set ; 
 
 + import javax . vecmath . Matrix3f ; 
 import javax . vecmath . Matrix4f ; 
 import javax . vecmath . Quat4f ; 
 import javax . vecmath . Vector2f ; 
 @ @ - 625 , 7 + 626 , 8 @ @ public class B3DModel 
 bm . mul ( bone . getLeft ( ) ) ; 
 t . add ( bm ) ; 
 } 
 - if ( totalWeight ! = 0 ) t . mul ( 1f / totalWeight ) ; 
 + if ( Math . abs ( totalWeight ) > 1e - 4 ) t . mul ( 1f / totalWeight ) ; 
 + else t . setIdentity ( ) ; 
 } 
 
 / / pos 
 @ @ - 635 , 12 + 637 , 12 @ @ public class B3DModel 
 Vector3f rPos = new Vector3f ( newPos . x / newPos . w , newPos . y / newPos . w , newPos . z / newPos . w ) ; 
 
 / / normal 
 - t . invert ( ) ; 
 - t . transpose ( ) ; 
 - Vector4f normal = new Vector4f ( this . normal ) , newNormal = new Vector4f ( ) ; 
 - normal . w = 1 ; 
 - t . transform ( normal , newNormal ) ; 
 - Vector3f rNormal = new Vector3f ( newNormal . x / newNormal . w , newNormal . y / newNormal . w , newNormal . z / newNormal . w ) ; 
 + Matrix3f tm = new Matrix3f ( ) ; 
 + t . getRotationScale ( tm ) ; 
 + tm . invert ( ) ; 
 + tm . transpose ( ) ; 
 + Vector3f normal = new Vector3f ( this . normal ) , rNormal = new Vector3f ( ) ; 
 + tm . transform ( normal , rNormal ) ; 
 rNormal . normalize ( ) ; 
 
 / / texCoords TODO 
 diff - - git a / src / main / java / net / minecraftforge / client / model / obj / OBJModel . java b / src / main / java / net / minecraftforge / client / model / obj / OBJModel . java 
 index b0e890f . . 492694d 100644 
 - - - a / src / main / java / net / minecraftforge / client / model / obj / OBJModel . java 
 + + + b / src / main / java / net / minecraftforge / client / model / obj / OBJModel . java 
 @ @ - 14 , 6 + 14 , 7 @ @ import java . util . Map ; 
 import java . util . Set ; 
 import java . util . regex . Pattern ; 
 
 + import javax . vecmath . Matrix3f ; 
 import javax . vecmath . Matrix4f ; 
 import javax . vecmath . Vector2f ; 
 import javax . vecmath . Vector3f ; 
 @ @ - 69 , 7 + 70 , 7 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 
 public OBJModel ( MaterialLibrary matLib , ResourceLocation modelLocation ) 
 { 
 - 	 this ( matLib , modelLocation , null ) ; 
 + this ( matLib , modelLocation , new CustomData ( ) ) ; 
 } 
 
 public OBJModel ( MaterialLibrary matLib , ResourceLocation modelLocation , CustomData customData ) 
 @ @ - 131 , 16 + 132 , 11 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 { 
 return this . matLib ; 
 } 
 - 
 - public boolean hasCustomData ( ) 
 - { 
 - 	 return this . customData ! = null ; 
 - } 
 
 @ Override 
 public IModel process ( ImmutableMap < String , String > customData ) 
 { 
 - 	 OBJModel ret = new OBJModel ( this . matLib , this . modelLocation , new CustomData ( customData ) ) ; 
 + OBJModel ret = new OBJModel ( this . matLib , this . modelLocation , new CustomData ( this . customData , customData ) ) ; 
 return ret ; 
 } 
 
 @ @ - 150 , 35 + 146 , 44 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 OBJModel ret = new OBJModel ( this . matLib . makeLibWithReplacements ( textures ) , this . modelLocation , this . customData ) ; 
 return ret ; 
 } 
 - 
 - public static class CustomData 
 + 
 + static class CustomData 
 { 
 - 	 public boolean ambientOcclusion = true ; 
 - 	 public boolean gui3d = true ; 
 - 	 public boolean modifyUVs = false ; 
 - 	 
 - 	 public CustomData ( ImmutableMap < String , String > customData ) 
 - 	 { 
 - 	 	 this . process ( customData ) ; 
 - 	 } 
 - 	 
 - 	 public void process ( ImmutableMap < String , String > customData ) 
 - 	 { 
 - 	 	 for ( Map . Entry < String , String > e : customData . entrySet ( ) ) 
 - 	 	 { 
 - 	 	 	 if ( e . getKey ( ) . equals ( " ambient " ) ) 
 - 	 	 	 	 this . ambientOcclusion = Boolean . valueOf ( e . getValue ( ) ) ; 
 - 	 	 	 else if ( e . getKey ( ) . equals ( " gui3d " ) ) 
 - 	 	 	 	 this . gui3d = Boolean . valueOf ( e . getValue ( ) ) ; 
 - 	 	 	 else if ( e . getKey ( ) . equals ( " modifyUVs " ) ) 
 - 	 	 	 	 this . modifyUVs = Boolean . valueOf ( e . getValue ( ) ) ; 
 - 	 	 } 
 - 	 } 
 + public boolean ambientOcclusion = true ; 
 + public boolean gui3d = true ; 
 + / / should be an enum , TODO 
 + / / public boolean modifyUVs = false ; 
 + public boolean flipV = false ; 
 + 
 + public CustomData ( CustomData parent , ImmutableMap < String , String > customData ) 
 + { 
 + this . ambientOcclusion = parent . ambientOcclusion ; 
 + this . gui3d = parent . gui3d ; 
 + this . flipV = parent . flipV ; 
 + this . process ( customData ) ; 
 + } 
 + 
 + public CustomData ( ) { } 
 + 
 + public void process ( ImmutableMap < String , String > customData ) 
 + { 
 + for ( Map . Entry < String , String > e : customData . entrySet ( ) ) 
 + { 
 + if ( e . getKey ( ) . equals ( " ambient " ) ) 
 + this . ambientOcclusion = Boolean . valueOf ( e . getValue ( ) ) ; 
 + else if ( e . getKey ( ) . equals ( " gui3d " ) ) 
 + this . gui3d = Boolean . valueOf ( e . getValue ( ) ) ; 
 + / * else if ( e . getKey ( ) . equals ( " modifyUVs " ) ) 
 + this . modifyUVs = Boolean . valueOf ( e . getValue ( ) ) ; * / 
 + else if ( e . getKey ( ) . equals ( " flip - v " ) ) 
 + this . flipV = Boolean . valueOf ( e . getValue ( ) ) ; 
 + } 
 + } 
 } 
 
 public static class Parser 
 { 
 - 	 private static final Pattern WHITE _ SPACE = Pattern . compile ( " \ \ s + " ) ; 
 + private static final Pattern WHITE _ SPACE = Pattern . compile ( " \ \ s + " ) ; 
 private static Set < String > unknownObjectCommands = new HashSet < String > ( ) ; 
 public MaterialLibrary materialLibrary = new MaterialLibrary ( ) ; 
 private IResourceManager manager ; 
 @ @ - 209 , 7 + 214 , 7 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 String currentLine = " " ; 
 Material material = new Material ( ) ; 
 int usemtlCounter = 0 ; 
 - 
 + 
 / / float [ ] minUVBounds = new float [ ] { 0 . 0f , 0 . 0f } ; 
 / / float [ ] maxUVBounds = new float [ ] { 1 . 0f , 1 . 0f } ; 
 
 @ @ - 217 , 8 + 222 , 9 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 { 
 currentLine = objReader . readLine ( ) ; 
 if ( currentLine = = null ) break ; 
 + currentLine . trim ( ) ; 
 if ( currentLine . isEmpty ( ) | | currentLine . startsWith ( " # " ) ) continue ; 
 - 
 + 
 String [ ] fields = WHITE _ SPACE . split ( currentLine , 2 ) ; 
 String key = fields [ 0 ] ; 
 String data = fields [ 1 ] ; 
 @ @ - 255 , 14 + 261 , 14 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 floatSplitData [ i ] = Float . parseFloat ( splitData [ i ] ) ; 
 TextureCoordinate texCoord = new TextureCoordinate ( new Vector3f ( floatSplitData [ 0 ] , floatSplitData [ 1 ] , floatSplitData . length = = 3 ? floatSplitData [ 2 ] : 1 ) ) ; 
 if ( texCoord . u < 0 . 0f | | texCoord . u > 1 . 0f | | texCoord . v < 0 . 0f | | texCoord . v > 1 . 0f ) 
 - 	 throw new UVsOutOfBoundsException ( this . objFrom ) ; 
 + throw new UVsOutOfBoundsException ( this . objFrom ) ; 
 / / this . UVsOutOfBounds = ( texCoord . u < 0 . 0f | | texCoord . u > 1 . 0f | | texCoord . v < 0 . 0f | | texCoord . v > 1 . 0f ) ; 
 - 
 + 
 / / if ( texCoord . u < 0 . 0f | | texCoord . u > 1 . 0f | | texCoord . v < 0 . 0f | | texCoord . v > 1 . 0f ) 
 / / { 
 - / / 	 this . UVsOutOfBounds = true ; 
 - / / 	 texCoord . u - = Math . floor ( texCoord . u ) ; 
 - / / 	 texCoord . v - = Math . floor ( texCoord . v ) ; 
 + / / this . UVsOutOfBounds = true ; 
 + / / texCoord . u - = Math . floor ( texCoord . u ) ; 
 + / / texCoord . v - = Math . floor ( texCoord . v ) ; 
 / / } 
 
 / / minUVBounds [ 0 ] = floatSplitData [ 0 ] < minUVBounds [ 0 ] ? floatSplitData [ 0 ] : minUVBounds [ 0 ] ; 
 @ @ - 297 , 7 + 303 , 7 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 norm = norm < 0 ? this . normals . size ( ) - 1 : norm - 1 ; 
 
 this . vertices . get ( vert ) . setNormal ( this . normals . get ( norm ) ) ; 
 - 
 + 
 v . add ( this . vertices . get ( vert ) ) ; 
 / / n . add ( this . normals . get ( norm ) ) ; 
 } 
 @ @ - 314 , 7 + 320 , 7 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 norm = Integer . parseInt ( splitSlash [ i ] [ 2 ] ) ; 
 norm = norm < 0 ? this . normals . size ( ) - 1 : norm - 1 ; 
 } 
 - 
 + 
 this . vertices . get ( vert ) . setTextureCoordinate ( this . texCoords . get ( texCoord ) ) ; 
 this . vertices . get ( vert ) . setNormal ( splitSlash [ i ] . length > 2 ? this . normals . get ( norm ) : null ) ; 
 
 @ @ - 401 , 8 + 407 , 8 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 } 
 } 
 } 
 - 
 - OBJModel model = new OBJModel ( this . materialLibrary , this . objFrom , null ) ; 
 + 
 + OBJModel model = new OBJModel ( this . materialLibrary , this . objFrom ) ; 
 / / model . getMatLib ( ) . setUVBounds ( minUVBounds [ 0 ] , maxUVBounds [ 0 ] , minUVBounds [ 1 ] , maxUVBounds [ 1 ] ) ; 
 return model ; 
 } 
 @ @ - 410 , 7 + 416 , 7 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 
 public static class MaterialLibrary 
 { 
 - 	 private static final Pattern WHITE _ SPACE = Pattern . compile ( " \ \ s + " ) ; 
 + private static final Pattern WHITE _ SPACE = Pattern . compile ( " \ \ s + " ) ; 
 private Set < String > unknownMaterialCommands = new HashSet < String > ( ) ; 
 private Map < String , Material > materials = new HashMap < String , Material > ( ) ; 
 private Map < String , Group > groups = new HashMap < String , Group > ( ) ; 
 @ @ - 424 , 9 + 430 , 9 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 { 
 this . groups . put ( Group . DEFAULT _ NAME , new Group ( Group . DEFAULT _ NAME , null ) ) ; 
 } 
 - 
 + 
 public MaterialLibrary makeLibWithReplacements ( ImmutableMap < String , String > replacements ) 
 - { 
 + { 
 Map < String , Material > mats = new HashMap < String , Material > ( ) ; 
 for ( Map . Entry < String , Material > e : this . materials . entrySet ( ) ) 
 { 
 @ @ - 453 , 14 + 459 , 14 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 return ret ; 
 } 
 
 - / / public float [ ] getMinUVBounds ( ) 
 + / / public float [ ] getMinUVBounds ( ) 
 / / { 
 - / / 	 return this . minUVBounds ; 
 + / / return this . minUVBounds ; 
 / / } 
 - 
 + 
 / / public float [ ] getMaxUVBounds ( ) 
 / / { 
 - / / 	 return this . maxUVBounds ; 
 + / / return this . maxUVBounds ; 
 / / } 
 
 / / public void setUVBounds ( float minU , float maxU , float minV , float maxV ) 
 @ @ - 512 , 8 + 518 , 8 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 boolean hasSetTexture = false ; 
 boolean hasSetColor = false ; 
 String domain = from . getResourceDomain ( ) ; 
 - if ( ! path . contains ( " / " ) ) 
 - 	 path = from . getResourcePath ( ) . substring ( 0 , from . getResourcePath ( ) . lastIndexOf ( " / " ) + 1 ) + path ; 
 + if ( ! path . contains ( " / " ) ) 
 + path = from . getResourcePath ( ) . substring ( 0 , from . getResourcePath ( ) . lastIndexOf ( " / " ) + 1 ) + path ; 
 mtlStream = new InputStreamReader ( manager . getResource ( new ResourceLocation ( domain , path ) ) . getInputStream ( ) , Charsets . UTF _ 8 ) ; 
 mtlReader = new BufferedReader ( mtlStream ) ; 
 
 @ @ - 528 , 6 + 534 , 7 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 { 
 currentLine = mtlReader . readLine ( ) ; 
 if ( currentLine = = null ) break ; 
 + currentLine . trim ( ) ; 
 if ( currentLine . isEmpty ( ) | | currentLine . startsWith ( " # " ) ) continue ; 
 
 String [ ] fields = WHITE _ SPACE . split ( currentLine , 2 ) ; 
 @ @ - 582 , 11 + 589 , 11 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 } 
 else if ( key . equalsIgnoreCase ( " d " ) | | key . equalsIgnoreCase ( " Tr " ) ) 
 { 
 - 	 / / d < - optional key here > float [ 0 . 0 : 1 . 0 , 1 . 0 ] 
 - 	 / / Tr r g b OR Tr spectral map file OR Tr xyz r g b ( CIEXYZ colorspace ) 
 - 	 String [ ] splitData = WHITE _ SPACE . split ( data ) ; 	 
 - 	 float alpha = Float . parseFloat ( splitData [ splitData . length - 1 ] ) ; 
 - 	 material . getColor ( ) . setW ( alpha ) ; 
 + / / d < - optional key here > float [ 0 . 0 : 1 . 0 , 1 . 0 ] 
 + / / Tr r g b OR Tr spectral map file OR Tr xyz r g b ( CIEXYZ colorspace ) 
 + String [ ] splitData = WHITE _ SPACE . split ( data ) ; 
 + float alpha = Float . parseFloat ( splitData [ splitData . length - 1 ] ) ; 
 + material . getColor ( ) . setW ( alpha ) ; 
 } 
 else 
 { 
 @ @ - 756 , 11 + 763 , 11 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 { 
 this ( verts , Material . DEFAULT _ NAME ) ; 
 } 
 - 
 + 
 public Face ( Vertex [ ] verts , String materialName ) { 
 - 	 this . verts = verts ! = null & & verts . length > 2 ? verts : null ; 
 - 	 setMaterialName ( materialName ) ; 
 - 	 checkData ( ) ; 
 + this . verts = verts ! = null & & verts . length > 2 ? verts : null ; 
 + setMaterialName ( materialName ) ; 
 + checkData ( ) ; 
 } 
 
 / / public Face ( Vertex [ ] verts , Normal [ ] norms ) 
 @ @ - 780 , 9 + 787 , 9 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 
 / / public Face ( Vertex [ ] verts , Normal [ ] norms , TextureCoordinate [ ] texCoords , String materialName ) 
 / / { 
 - / / 	 this . verts = verts ! = null & & verts . length > 2 ? verts : null ; 
 - / / 	 this . norms = norms ! = null & & norms . length > 2 ? norms : null ; 
 - / / 	 this . texCoords = texCoords ! = null & & texCoords . length > 2 ? texCoords : null ; 
 + / / this . verts = verts ! = null & & verts . length > 2 ? verts : null ; 
 + / / this . norms = norms ! = null & & norms . length > 2 ? norms : null ; 
 + / / this . texCoords = texCoords ! = null & & texCoords . length > 2 ? texCoords : null ; 
 / / setMaterialName ( materialName ) ; 
 / / checkData ( ) ; 
 / / } 
 @ @ - 791 , 7 + 798 , 7 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 { 
 if ( this . verts ! = null & & this . verts . length = = 3 ) 
 { 
 - 	 this . isTri = true ; 
 + this . isTri = true ; 
 this . verts = new Vertex [ ] { this . verts [ 0 ] , this . verts [ 1 ] , this . verts [ 2 ] , this . verts [ 2 ] } ; 
 } 
 } 
 @ @ - 822 , 40 + 829 , 40 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 / / public boolean areUVsNormalized ( ) 
 / / { 
 / / for ( Vertex v : this . verts ) 
 - / / 	 if ( ! v . hasNormalizedUVs ( ) ) 
 - / / 	 	 return false ; 
 + / / if ( ! v . hasNormalizedUVs ( ) ) 
 + / / return false ; 
 / / return true ; 
 / / } 
 - 
 + 
 / / public void normalizeUVs ( float [ ] min , float [ ] max ) 
 / / { 
 - / / 	 if ( ! this . areUVsNormalized ( ) ) 
 - / / 	 { 
 - / / 	 	 for ( int i = 0 ; i < this . verts . length ; i + + ) { 
 - / / 	 	 	 TextureCoordinate texCoord = this . verts [ i ] . getTextureCoordinate ( ) ; 
 - / / 	 	 	 min [ 0 ] = texCoord . u < min [ 0 ] ? texCoord . u : min [ 0 ] ; 
 - / / 	 	 	 max [ 0 ] = texCoord . u > max [ 0 ] ? texCoord . u : max [ 0 ] ; 
 - / / 	 	 	 min [ 1 ] = texCoord . v < min [ 1 ] ? texCoord . v : min [ 1 ] ; 
 - / / 	 	 	 max [ 1 ] = texCoord . v > max [ 1 ] ? texCoord . v : max [ 1 ] ; 
 - / / 	 	 } 
 - / / 	 	 
 - / / 	 	 for ( Vertex v : this . verts ) { 
 - / / 	 	 	 v . texCoord . u = ( v . texCoord . u - min [ 0 ] ) / ( max [ 0 ] - min [ 0 ] ) ; 
 - / / 	 	 	 v . texCoord . v = ( v . texCoord . v - min [ 1 ] ) / ( max [ 1 ] - max [ 1 ] ) ; 
 - / / 	 	 } 
 - / / 	 } 
 + / / if ( ! this . areUVsNormalized ( ) ) 
 + / / { 
 + / / for ( int i = 0 ; i < this . verts . length ; i + + ) { 
 + / / TextureCoordinate texCoord = this . verts [ i ] . getTextureCoordinate ( ) ; 
 + / / min [ 0 ] = texCoord . u < min [ 0 ] ? texCoord . u : min [ 0 ] ; 
 + / / max [ 0 ] = texCoord . u > max [ 0 ] ? texCoord . u : max [ 0 ] ; 
 + / / min [ 1 ] = texCoord . v < min [ 1 ] ? texCoord . v : min [ 1 ] ; 
 + / / max [ 1 ] = texCoord . v > max [ 1 ] ? texCoord . v : max [ 1 ] ; 
 + / / } 
 + / / 
 + / / for ( Vertex v : this . verts ) { 
 + / / v . texCoord . u = ( v . texCoord . u - min [ 0 ] ) / ( max [ 0 ] - min [ 0 ] ) ; 
 + / / v . texCoord . v = ( v . texCoord . v - min [ 1 ] ) / ( max [ 1 ] - max [ 1 ] ) ; 
 + / / } 
 + / / } 
 / / } 
 
 public Face bake ( TRSRTransformation transform ) 
 { 
 Matrix4f m = transform . getMatrix ( ) ; 
 + Matrix3f mn = null ; 
 Vertex [ ] vertices = new Vertex [ verts . length ] ; 
 / / Normal [ ] normals = norms ! = null ? new Normal [ norms . length ] : null ; 
 / / TextureCoordinate [ ] textureCoords = texCoords ! = null ? new TextureCoordinate [ texCoords . length ] : null ; 
 
 for ( int i = 0 ; i < verts . length ; i + + ) 
 { 
 - m = transform . getMatrix ( ) ; 
 Vertex v = verts [ i ] ; 
 / / Normal n = norms ! = null ? norms [ i ] : null ; 
 / / TextureCoordinate t = texCoords ! = null ? texCoords [ i ] : null ; 
 @ @ - 864 , 34 + 871 , 25 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 pos . w = 1 ; 
 m . transform ( pos , newPos ) ; 
 vertices [ i ] = new Vertex ( newPos , v . getMaterial ( ) ) ; 
 - 
 + 
 if ( v . hasNormal ( ) ) 
 { 
 - 	 m . invert ( ) ; 
 - 	 Vector4f normal = new Vector4f ( v . getNormal ( ) . getData ( ) ) , newNormal = new Vector4f ( ) ; 
 - 	 normal . w = 1 . 0f ; 
 - 	 m . transform ( normal , newNormal ) ; 
 - 	 Vector3f rNormal = new Vector3f ( newNormal . x / newNormal . w , newNormal . y / newNormal . w , newNormal . z / newNormal . w ) ; 
 - 	 rNormal . normalize ( ) ; 
 - 	 vertices [ i ] . setNormal ( new Normal ( rNormal ) ) ; 
 + if ( mn = = null ) 
 + { 
 + mn = new Matrix3f ( ) ; 
 + m . getRotationScale ( mn ) ; 
 + mn . invert ( ) ; 
 + mn . transpose ( ) ; 
 + } 
 + Vector3f normal = new Vector3f ( v . getNormal ( ) . getData ( ) ) , newNormal = new Vector3f ( ) ; 
 + mn . transform ( normal , newNormal ) ; 
 + newNormal . normalize ( ) ; 
 + vertices [ i ] . setNormal ( new Normal ( newNormal ) ) ; 
 } 
 - else v . setNormal ( new Normal ( 0 . 0f , 1 . 0f , 0 . 0f ) ) ; 
 - 
 + 
 if ( v . hasTextureCoordinate ( ) ) vertices [ i ] . setTextureCoordinate ( v . getTextureCoordinate ( ) ) ; 
 else v . setTextureCoordinate ( TextureCoordinate . getDefaultUVs ( ) [ i ] ) ; 
 
 - / / if ( n ! = null ) 
 - / / { 
 - / / m . invert ( ) ; 
 - / / m . transpose ( ) ; 
 - / / Vector4f normal = new Vector4f ( n . getData ( ) ) , newNormal = new Vector4f ( ) ; 
 - / / normal . w = 1 ; 
 - / / m . transform ( normal , newNormal ) ; 
 - / / Vector3f rNormal = new Vector3f ( newNormal . x / newNormal . w , newNormal . y / newNormal . w , newNormal . z / newNormal . w ) ; 
 - / / rNormal . normalize ( ) ; 
 - / / normals [ i ] = new Normal ( rNormal ) ; 
 - / / } 
 - 
 / / texCoords TODO 
 / / if ( t ! = null ) textureCoords [ i ] = t ; 
 } 
 @ @ - 900 , 40 + 898 , 13 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 
 public Normal getNormal ( ) 
 { 
 - 	 for ( Vertex v : this . verts ) 
 - 	 { 
 - 	 	 if ( ! v . hasNormal ( ) ) 
 - 	 	 { 
 - 	 	 	 Vector3f vPos = v . getPos3 ( ) ; 
 - 	 	 	 vPos . normalize ( ) ; 
 - 	 	 	 v . setNormal ( new Normal ( vPos ) ) ; 
 - 	 	 } 
 - 	 } 
 - 	 
 - 	 Vector3f a = this . verts [ 1 ] . getNormal ( ) . getData ( ) ; 
 - 	 a . sub ( this . verts [ 0 ] . getNormal ( ) . getData ( ) ) ; 
 - 	 Vector3f b = this . verts [ 2 ] . getNormal ( ) . getData ( ) ; 
 - 	 b . sub ( this . verts [ 0 ] . getNormal ( ) . getData ( ) ) ; 
 - 	 Vector3f c = new Vector3f ( ) ; 
 - 	 c . cross ( a , b ) ; 
 - 	 c . normalize ( ) ; 
 - 	 
 - 	 if ( this . isTri ) return new Normal ( c ) ; 
 - 	 else 
 - 	 { 
 - 	 	 a = this . verts [ 1 ] . getNormal ( ) . getData ( ) ; 
 - 	 	 a . sub ( this . verts [ 3 ] . getNormal ( ) . getData ( ) ) ; 
 - 	 	 b = this . verts [ 2 ] . getNormal ( ) . getData ( ) ; 
 - 	 	 b . sub ( this . verts [ 3 ] . getNormal ( ) . getData ( ) ) ; 
 - 	 	 Vector3f c1 = new Vector3f ( ) ; 
 - 	 	 c1 . cross ( a , b ) ; 
 - 	 	 c1 . normalize ( ) ; 
 - 	 	 Vector3f normal = new Vector3f ( ) ; 
 - 	 	 normal . add ( c , c1 ) ; 
 - 	 	 normal . scale ( 0 . 5f ) ; 
 - 	 	 normal . normalize ( ) ; 
 - 	 	 return new Normal ( normal ) ; 
 - 	 } 
 + Vector3f a = this . verts [ 2 ] . getPos3 ( ) ; 
 + a . sub ( this . verts [ 0 ] . getPos3 ( ) ) ; 
 + Vector3f b = this . verts [ 3 ] . getPos3 ( ) ; 
 + b . sub ( this . verts [ 1 ] . getPos3 ( ) ) ; 
 + a . cross ( a , b ) ; 
 + a . normalize ( ) ; 
 + return new Normal ( a ) ; 
 } 
 } 
 
 @ @ - 959 , 45 + 930 , 45 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 { 
 return this . position ; 
 } 
 - 
 + 
 public Vector3f getPos3 ( ) 
 { 
 - 	 return new Vector3f ( this . position . x , this . position . y , this . position . z ) ; 
 + return new Vector3f ( this . position . x , this . position . y , this . position . z ) ; 
 } 
 - 
 + 
 public boolean hasNormal ( ) 
 { 
 - 	 return this . normal ! = null ; 
 + return this . normal ! = null ; 
 } 
 - 
 + 
 public void setNormal ( Normal normal ) 
 { 
 - 	 this . normal = normal ; 
 + this . normal = normal ; 
 } 
 - 
 + 
 public Normal getNormal ( ) 
 { 
 - 	 return this . normal ; 
 + return this . normal ; 
 } 
 - 
 + 
 public boolean hasTextureCoordinate ( ) 
 { 
 - 	 return this . texCoord ! = null ; 
 + return this . texCoord ! = null ; 
 } 
 - 
 + 
 public void setTextureCoordinate ( TextureCoordinate texCoord ) 
 { 
 - 	 this . texCoord = texCoord ; 
 + this . texCoord = texCoord ; 
 } 
 - 
 + 
 public TextureCoordinate getTextureCoordinate ( ) 
 { 
 - 	 return this . texCoord ; 
 + return this . texCoord ; 
 } 
 
 / / public boolean hasNormalizedUVs ( ) 
 / / { 
 - / / 	 return this . texCoord . u > = 0 . 0f & & this . texCoord . u < = 1 . 0f & & this . texCoord . v > = 0 . 0f & & this . texCoord . v < = 1 . 0f ; 
 + / / return this . texCoord . u > = 0 . 0f & & this . texCoord . u < = 1 . 0f & & this . texCoord . v > = 0 . 0f & & this . texCoord . v < = 1 . 0f ; 
 / / } 
 
 public void setMaterial ( Material material ) 
 @ @ - 1020 , 78 + 991 , 78 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 return builder . toString ( ) ; 
 } 
 } 
 - 
 + 
 public static class Normal 
 { 
 - 	 public float x , y , z ; 
 - 	 
 - 	 public Normal ( ) 
 - 	 { 
 - 	 	 this ( 0 . 0f , 0 . 0f , 0 . 0f ) ; 
 - 	 } 
 - 	 
 - 	 public Normal ( float [ ] data ) 
 - 	 { 
 - 	 	 this ( data [ 0 ] , data [ 1 ] , data [ 2 ] ) ; 
 - 	 } 
 - 	 
 - 	 public Normal ( Vector3f vector3f ) 
 - 	 { 
 - 	 	 this ( vector3f . x , vector3f . y , vector3f . z ) ; 
 - 	 } 
 - 	 
 - 	 public Normal ( float x , float y , float z ) { 
 - 	 	 this . x = x ; 
 - 	 	 this . y = y ; 
 - 	 	 this . z = z ; 
 - 	 } 
 - 	 
 - 	 public Vector3f getData ( ) 
 - 	 { 
 - 	 	 return new Vector3f ( this . x , this . y , this . z ) ; 
 - 	 } 
 + public float x , y , z ; 
 + 
 + public Normal ( ) 
 + { 
 + this ( 0 . 0f , 0 . 0f , 0 . 0f ) ; 
 + } 
 + 
 + public Normal ( float [ ] data ) 
 + { 
 + this ( data [ 0 ] , data [ 1 ] , data [ 2 ] ) ; 
 + } 
 + 
 + public Normal ( Vector3f vector3f ) 
 + { 
 + this ( vector3f . x , vector3f . y , vector3f . z ) ; 
 + } 
 + 
 + public Normal ( float x , float y , float z ) { 
 + this . x = x ; 
 + this . y = y ; 
 + this . z = z ; 
 + } 
 + 
 + public Vector3f getData ( ) 
 + { 
 + return new Vector3f ( this . x , this . y , this . z ) ; 
 + } 
 } 
 
 public static class TextureCoordinate 
 { 
 - 	 public float u , v , w ; 
 - 	 
 - 	 public TextureCoordinate ( ) 
 - 	 { 
 - 	 	 this ( 0 . 0f , 0 . 0f , 1 . 0f ) ; 
 - 	 } 
 - 	 
 - 	 public TextureCoordinate ( float [ ] data ) 
 - 	 { 
 - 	 	 this ( data [ 0 ] , data [ 1 ] , data [ 2 ] ) ; 
 - 	 } 
 - 	 
 - 	 public TextureCoordinate ( Vector3f data ) 
 - 	 { 
 - 	 	 this ( data . x , data . y , data . z ) ; 
 - 	 } 
 - 	 
 - 	 public TextureCoordinate ( float u , float v , float w ) 
 - 	 { 
 - 	 	 this . u = u ; 
 - 	 	 this . v = v ; 
 - 	 	 this . w = w ; 
 - 	 } 
 - 	 
 - 	 public Vector3f getData ( ) 
 - 	 { 
 - 	 	 return new Vector3f ( this . u , this . v , this . w ) ; 
 - 	 } 
 - 	 
 - 	 public static TextureCoordinate [ ] getDefaultUVs ( ) 
 - 	 { 
 - 	 	 TextureCoordinate [ ] texCoords = new TextureCoordinate [ 4 ] ; 
 - 	 	 texCoords [ 0 ] = new TextureCoordinate ( 0 . 0f , 0 . 0f , 1 . 0f ) ; 
 - 	 	 texCoords [ 1 ] = new TextureCoordinate ( 1 . 0f , 0 . 0f , 1 . 0f ) ; 
 - 	 	 texCoords [ 2 ] = new TextureCoordinate ( 1 . 0f , 1 . 0f , 1 . 0f ) ; 
 - 	 	 texCoords [ 3 ] = new TextureCoordinate ( 0 . 0f , 1 . 0f , 1 . 0f ) ; 
 - 	 	 return texCoords ; 
 - 	 } 
 + public float u , v , w ; 
 + 
 + public TextureCoordinate ( ) 
 + { 
 + this ( 0 . 0f , 0 . 0f , 1 . 0f ) ; 
 + } 
 + 
 + public TextureCoordinate ( float [ ] data ) 
 + { 
 + this ( data [ 0 ] , data [ 1 ] , data [ 2 ] ) ; 
 + } 
 + 
 + public TextureCoordinate ( Vector3f data ) 
 + { 
 + this ( data . x , data . y , data . z ) ; 
 + } 
 + 
 + public TextureCoordinate ( float u , float v , float w ) 
 + { 
 + this . u = u ; 
 + this . v = v ; 
 + this . w = w ; 
 + } 
 + 
 + public Vector3f getData ( ) 
 + { 
 + return new Vector3f ( this . u , this . v , this . w ) ; 
 + } 
 + 
 + public static TextureCoordinate [ ] getDefaultUVs ( ) 
 + { 
 + TextureCoordinate [ ] texCoords = new TextureCoordinate [ 4 ] ; 
 + texCoords [ 0 ] = new TextureCoordinate ( 0 . 0f , 0 . 0f , 1 . 0f ) ; 
 + texCoords [ 1 ] = new TextureCoordinate ( 1 . 0f , 0 . 0f , 1 . 0f ) ; 
 + texCoords [ 2 ] = new TextureCoordinate ( 1 . 0f , 1 . 0f , 1 . 0f ) ; 
 + texCoords [ 3 ] = new TextureCoordinate ( 0 . 0f , 1 . 0f , 1 . 0f ) ; 
 + return texCoords ; 
 + } 
 } 
 
 public static class Group implements IModelPart 
 @ @ - 1118 , 7 + 1089 , 7 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 LinkedHashSet < Face > faceSet = new LinkedHashSet < Face > ( ) ; 
 for ( Face f : this . faces ) 
 { 
 - / / 	 if ( minUVBounds ! = null & & maxUVBounds ! = null ) f . normalizeUVs ( minUVBounds , maxUVBounds ) ; 
 + / / if ( minUVBounds ! = null & & maxUVBounds ! = null ) f . normalizeUVs ( minUVBounds , maxUVBounds ) ; 
 faceSet . add ( f . bake ( transform ) ) ; 
 } 
 return faceSet ; 
 @ @ - 1302 , 10 + 1273 , 10 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 private Set < BakedQuad > quads ; 
 private ImmutableMap < String , TextureAtlasSprite > textures ; 
 private TextureAtlasSprite sprite = ModelLoader . White . instance ; 
 - 
 + 
 public OBJBakedModel ( OBJModel model , IModelState state , VertexFormat format , ImmutableMap < String , TextureAtlasSprite > textures ) 
 { 
 - 	 this . model = model ; 
 + this . model = model ; 
 this . state = state ; 
 if ( this . state instanceof OBJState ) this . updateStateVisibilityMap ( ( OBJState ) this . state ) ; 
 this . format = format ; 
 @ @ - 1333 , 16 + 1304 , 16 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 TRSRTransformation transform = TRSRTransformation . identity ( ) ; 
 for ( Group g : this . model . getMatLib ( ) . getGroups ( ) . values ( ) ) 
 { 
 - / / 	 g . minUVBounds = this . model . getMatLib ( ) . minUVBounds ; 
 - / / 	 g . maxUVBounds = this . model . getMatLib ( ) . maxUVBounds ; 
 - / / 	 FMLLog . info ( " Group : % s u : [ % f , % f ] v : [ % f , % f ] " , g . name , g . minUVBounds [ 0 ] , g . maxUVBounds [ 0 ] , g . minUVBounds [ 1 ] , g . maxUVBounds [ 1 ] ) ; 
 - 	 
 + / / g . minUVBounds = this . model . getMatLib ( ) . minUVBounds ; 
 + / / g . maxUVBounds = this . model . getMatLib ( ) . maxUVBounds ; 
 + / / FMLLog . info ( " Group : % s u : [ % f , % f ] v : [ % f , % f ] " , g . name , g . minUVBounds [ 0 ] , g . maxUVBounds [ 0 ] , g . minUVBounds [ 1 ] , g . maxUVBounds [ 1 ] ) ; 
 + 
 if ( this . state instanceof OBJState ) 
 { 
 OBJState state = ( OBJState ) this . state ; 
 - if ( state . parent ! = null & & state . parent instanceof TRSRTransformation ) 
 + if ( state . parent ! = null ) 
 { 
 - transform = ( TRSRTransformation ) state . parent ; 
 + transform = state . parent . apply ( model ) ; 
 } 
 / / TODO : can this be replaced by updateStateVisibilityMap ( OBJState ) ? 
 if ( state . getGroupNamesFromMap ( ) . contains ( Group . ALL ) ) 
 @ @ - 1377 , 14 + 1348 , 9 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 faces . addAll ( g . applyTransform ( transform ) ) ; 
 } 
 } 
 - else if ( this . state instanceof TRSRTransformation ) 
 - { 
 - transform = ( TRSRTransformation ) this . state ; 
 - faces . addAll ( g . applyTransform ( transform ) ) ; 
 - } 
 else 
 { 
 - transform = TRSRTransformation . identity ( ) ; 
 + transform = state . apply ( model ) ; 
 faces . addAll ( g . applyTransform ( transform ) ) ; 
 } 
 } 
 @ @ - 1404 , 10 + 1370 , 11 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 UnpackedBakedQuad . Builder builder = new UnpackedBakedQuad . Builder ( format ) ; 
 builder . setQuadOrientation ( EnumFacing . getFacingFromVector ( f . getNormal ( ) . x , f . getNormal ( ) . y , f . getNormal ( ) . z ) ) ; 
 builder . setQuadColored ( ) ; 
 - putVertexData ( builder , f . verts [ 0 ] , f . getNormal ( ) , TextureCoordinate . getDefaultUVs ( ) [ 0 ] , sprite ) ; 
 - putVertexData ( builder , f . verts [ 1 ] , f . getNormal ( ) , TextureCoordinate . getDefaultUVs ( ) [ 1 ] , sprite ) ; 
 - putVertexData ( builder , f . verts [ 2 ] , f . getNormal ( ) , TextureCoordinate . getDefaultUVs ( ) [ 2 ] , sprite ) ; 
 - putVertexData ( builder , f . verts [ 3 ] , f . getNormal ( ) , TextureCoordinate . getDefaultUVs ( ) [ 3 ] , sprite ) ; 
 + Normal faceNormal = f . getNormal ( ) ; 
 + putVertexData ( builder , f . verts [ 0 ] , faceNormal , TextureCoordinate . getDefaultUVs ( ) [ 0 ] , sprite ) ; 
 + putVertexData ( builder , f . verts [ 1 ] , faceNormal , TextureCoordinate . getDefaultUVs ( ) [ 1 ] , sprite ) ; 
 + putVertexData ( builder , f . verts [ 2 ] , faceNormal , TextureCoordinate . getDefaultUVs ( ) [ 2 ] , sprite ) ; 
 + putVertexData ( builder , f . verts [ 3 ] , faceNormal , TextureCoordinate . getDefaultUVs ( ) [ 3 ] , sprite ) ; 
 quads . add ( builder . build ( ) ) ; 
 } 
 } 
 @ @ - 1426 , 37 + 1393 , 37 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 break ; 
 case COLOR : 
 float d ; 
 - if ( v . hasNormal ( ) ) 
 - 	 d = LightUtil . diffuseLight ( v . getNormal ( ) . x , v . getNormal ( ) . y , v . getNormal ( ) . z ) ; 
 - else 
 - 	 d = LightUtil . diffuseLight ( faceNormal . x , faceNormal . y , faceNormal . z ) ; 
 - 
 - if ( v . getMaterial ( ) ! = null ) 
 - 	 builder . put ( e , 
 - 	 	 	 d * v . getMaterial ( ) . getColor ( ) . x , 
 - 	 	 	 d * v . getMaterial ( ) . getColor ( ) . y , 
 - 	 	 	 d * v . getMaterial ( ) . getColor ( ) . z , 
 - 	 	 	 v . getMaterial ( ) . getColor ( ) . w ) ; 
 - else 
 - 	 builder . put ( e , d , d , d , 1 ) ; 
 + if ( v . hasNormal ( ) ) 
 + d = LightUtil . diffuseLight ( v . getNormal ( ) . x , v . getNormal ( ) . y , v . getNormal ( ) . z ) ; 
 + else 
 + d = LightUtil . diffuseLight ( faceNormal . x , faceNormal . y , faceNormal . z ) ; 
 + 
 + if ( v . getMaterial ( ) ! = null ) 
 + builder . put ( e , 
 + d * v . getMaterial ( ) . getColor ( ) . x , 
 + d * v . getMaterial ( ) . getColor ( ) . y , 
 + d * v . getMaterial ( ) . getColor ( ) . z , 
 + v . getMaterial ( ) . getColor ( ) . w ) ; 
 + else 
 + builder . put ( e , d , d , d , 1 ) ; 
 break ; 
 case UV : 
 - 	 if ( ! v . hasTextureCoordinate ( ) ) 
 - 	 	 builder . put ( e , 
 - 	 	 	 	 sprite . getInterpolatedU ( defUV . u * 16 ) , 
 - 	 	 	 	 sprite . getInterpolatedV ( defUV . v * 16 ) , 
 - 	 	 	 	 0 , 1 ) ; 
 - 	 else 
 - 	 	 builder . put ( e , 
 - 	 	 	 	 sprite . getInterpolatedU ( v . getTextureCoordinate ( ) . u * 16 ) , 
 - 	 	 	 	 sprite . getInterpolatedV ( v . getTextureCoordinate ( ) . v * 16 ) , 
 - 	 	 	 	 0 , 1 ) ; 
 + if ( ! v . hasTextureCoordinate ( ) ) 
 + builder . put ( e , 
 + sprite . getInterpolatedU ( defUV . u * 16 ) , 
 + sprite . getInterpolatedV ( ( model . customData . flipV ? 1 - defUV . v : defUV . v ) * 16 ) , 
 + 0 , 1 ) ; 
 + else 
 + builder . put ( e , 
 + sprite . getInterpolatedU ( v . getTextureCoordinate ( ) . u * 16 ) , 
 + sprite . getInterpolatedV ( ( model . customData . flipV ? 1 - v . getTextureCoordinate ( ) . v : v . getTextureCoordinate ( ) . v ) * 16 ) , 
 + 0 , 1 ) ; 
 break ; 
 case NORMAL : 
 - if ( ! v . hasNormal ( ) ) 
 - 	 builder . put ( e , faceNormal . x , faceNormal . y , faceNormal . z , 1 ) ; 
 - else 
 - 	 builder . put ( e , v . getNormal ( ) . x , v . getNormal ( ) . y , v . getNormal ( ) . z , 1 ) ; 
 + if ( ! v . hasNormal ( ) ) 
 + builder . put ( e , faceNormal . x , faceNormal . y , faceNormal . z , 0 ) ; 
 + else 
 + builder . put ( e , v . getNormal ( ) . x , v . getNormal ( ) . y , v . getNormal ( ) . z , 0 ) ; 
 break ; 
 default : 
 builder . put ( e ) ; 
 @ @ - 1467 , 13 + 1434 , 13 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 @ Override 
 public boolean isAmbientOcclusion ( ) 
 { 
 - return model ! = null & & model . hasCustomData ( ) ? model . customData . ambientOcclusion : true ; 
 + return model ! = null ? model . customData . ambientOcclusion : true ; 
 } 
 
 @ Override 
 public boolean isGui3d ( ) 
 { 
 - return model ! = null & & model . hasCustomData ( ) ? model . customData . gui3d : true ; 
 + return model ! = null ? model . customData . gui3d : true ; 
 } 
 
 @ Override 
 @ @ - 1527 , 7 + 1494 , 7 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 } 
 return this ; 
 } 
 - 
 + 
 private void updateStateVisibilityMap ( OBJState state ) 
 { 
 if ( state . visibilityMap . containsKey ( Group . ALL ) ) 
 @ @ - 1602 , 16 + 1569 , 16 @ @ public class OBJModel implements IRetexturableModel , IModelCustomData 
 return this . model . modelLocation . toString ( ) ; 
 } 
 } 
 - 
 + 
 @ SuppressWarnings ( " serial " ) 
 public static class UVsOutOfBoundsException extends RuntimeException 
 { 
 - 	 public ResourceLocation modelLocation ; 
 - 	 
 - 	 public UVsOutOfBoundsException ( ResourceLocation modelLocation ) 
 - 	 { 
 - 	 	 super ( String . format ( " Model ' % s ' has UVs ( ' vt ' ) out of bounds 0 - 1 ! The missing model will be used instead . Support for UV processing will be added to the OBJ loader in the future . " , modelLocation ) ) ; 
 - 	 	 this . modelLocation = modelLocation ; 
 - 	 } 
 + public ResourceLocation modelLocation ; 
 + 
 + public UVsOutOfBoundsException ( ResourceLocation modelLocation ) 
 + { 
 + super ( String . format ( " Model ' % s ' has UVs ( ' vt ' ) out of bounds 0 - 1 ! The missing model will be used instead . Support for UV processing will be added to the OBJ loader in the future . " , modelLocation ) ) ; 
 + this . modelLocation = modelLocation ; 
 + } 
 } 
 }

NEAREST DIFF:
diff - - git a / common / net / minecraftforge / common / DimensionManager . java b / common / net / minecraftforge / common / DimensionManager . java 
 index 8d39723 . . 8ea6785 100644 
 - - - a / common / net / minecraftforge / common / DimensionManager . java 
 + + + b / common / net / minecraftforge / common / DimensionManager . java 
 @ @ - 197 , 12 + 197 , 15 @ @ public class DimensionManager 
 
 public static void setWorld ( int id , WorldServer world ) 
 { 
 - if ( world ! = null ) { 
 + if ( world ! = null ) 
 + { 
 worlds . put ( id , world ) ; 
 weakWorldMap . put ( world , world ) ; 
 MinecraftServer . getServer ( ) . worldTickTimes . put ( id , new long [ 100 ] ) ; 
 FMLLog . info ( " Loading dimension % d ( % s ) ( % s ) " , id , world . getWorldInfo ( ) . getWorldName ( ) , world . getMinecraftServer ( ) ) ; 
 - } else { 
 + } 
 + else 
 + { 
 worlds . remove ( id ) ; 
 MinecraftServer . getServer ( ) . worldTickTimes . remove ( id ) ; 
 FMLLog . info ( " Unloading dimension % d " , id ) ; 
 @ @ - 231 , 14 + 234 , 18 @ @ public class DimensionManager 
 
 public static void initDimension ( int dim ) { 
 WorldServer overworld = getWorld ( 0 ) ; 
 - if ( overworld = = null ) { 
 + if ( overworld = = null ) 
 + { 
 throw new RuntimeException ( " Cannot Hotload Dim : Overworld is not Loaded ! " ) ; 
 } 
 - try { 
 + try 
 + { 
 DimensionManager . getProviderType ( dim ) ; 
 - } catch ( Exception e ) { 
 + } 
 + catch ( Exception e ) 
 + { 
 System . err . println ( " Cannot Hotload Dim : " + e . getMessage ( ) ) ; 
 - return ; / / If a provider hasn ' t been registered then we can ' t hotload the dim 
 + return ; / / If a provider hasn ' t been registered then we can ' t hotload the dim 
 } 
 MinecraftServer mcServer = overworld . getMinecraftServer ( ) ; 
 ISaveHandler savehandler = overworld . getSaveHandler ( ) ; 
 diff - - git a / common / net / minecraftforge / common / ForgeChunkManager . java b / common / net / minecraftforge / common / ForgeChunkManager . java 
 index ee00212 . . 03d8714 100644 
 - - - a / common / net / minecraftforge / common / ForgeChunkManager . java 
 + + + b / common / net / minecraftforge / common / ForgeChunkManager . java 
 @ @ - 816 , 7 + 816 , 10 @ @ public class ForgeChunkManager 
 static void saveWorld ( World world ) 
 { 
 / / only persist persistent worlds 
 - if ( ! ( world instanceof WorldServer ) ) { return ; } 
 + if ( ! ( world instanceof WorldServer ) ) 
 + { 
 + return ; 
 + } 
 WorldServer worldServer = ( WorldServer ) world ; 
 File chunkDir = worldServer . getChunkSaveLocation ( ) ; 
 File chunkLoaderData = new File ( chunkDir , " forcedchunks . dat " ) ; 
 diff - - git a / common / net / minecraftforge / fluids / BlockFluidFinite . java b / common / net / minecraftforge / fluids / BlockFluidFinite . java 
 index 6a6edf7 . . 0dc2d0b 100644 
 - - - a / common / net / minecraftforge / fluids / BlockFluidFinite . java 
 + + + b / common / net / minecraftforge / fluids / BlockFluidFinite . java 
 @ @ - 31 , 7 + 31 , 8 @ @ public class BlockFluidFinite extends BlockFluidBase 
 return 0 ; 
 } 
 
 - if ( world . getBlockId ( x , y , z ) ! = blockID ) { 
 + if ( world . getBlockId ( x , y , z ) ! = blockID ) 
 + { 
 return - 1 ; 
 } 
 
 @ @ - 110 , 7 + 111 , 8 @ @ public class BlockFluidFinite extends BlockFluidBase 
 total + = west ; 
 } 
 
 - if ( east > = 0 ) { 
 + if ( east > = 0 ) 
 + { 
 + + count ; 
 total + = east ; 
 } 
 @ @ - 182 , 10 + 184 , 14 @ @ public class BlockFluidFinite extends BlockFluidBase 
 + + newwest ; 
 - - rem ; 
 } 
 - if ( newwest ! = west ) { 
 - if ( newwest = = 0 ) { 
 + if ( newwest ! = west ) 
 + { 
 + if ( newwest = = 0 ) 
 + { 
 world . setBlock ( x - 1 , y , z , 0 ) ; 
 - } else { 
 + } 
 + else 
 + { 
 world . setBlock ( x - 1 , y , z , blockID , newwest - 1 , 2 ) ; 
 } 
 world . scheduleBlockUpdate ( x - 1 , y , z , blockID , tickRate ) ; 
 diff - - git a / patches / minecraft / net / minecraft / client / entity / EntityPlayerSP . java . patch b / patches / minecraft / net / minecraft / client / entity / EntityPlayerSP . java . patch 
 index e401b0d . . 810ebea 100644 
 - - - a / patches / minecraft / net / minecraft / client / entity / EntityPlayerSP . java . patch 
 + + + b / patches / minecraft / net / minecraft / client / entity / EntityPlayerSP . java . patch 
 @ @ - 9 , 11 + 9 , 14 @ @ 
 
 @ SideOnly ( Side . CLIENT ) 
 public class EntityPlayerSP extends AbstractClientPlayer 
 - @ @ - 570 , 18 + 572 , 63 @ @ 
 + @ @ - 570 , 18 + 572 , 66 @ @ 
 * / 
 protected boolean pushOutOfBlocks ( double par1 , double par3 , double par5 ) 
 { 
 - + if ( this . noClip ) { return false ; } 
 + + if ( this . noClip ) 
 + + { 
 + + return false ; 
 + + } 
 int i = MathHelper . floor _ double ( par1 ) ; 
 int j = MathHelper . floor _ double ( par3 ) ; 
 int k = MathHelper . floor _ double ( par5 ) ; 
 @ @ - 79 , 7 + 82 , 7 @ @ 
 byte b0 = - 1 ; 
 double d5 = 9999 . 0D ; 
 
 - @ @ - 685 , 6 + 732 , 12 @ @ 
 + @ @ - 685 , 6 + 735 , 12 @ @ 
 
 public void playSound ( String par1Str , float par2 , float par3 ) 
 { 
 diff - - git a / patches / minecraft / net / minecraft / entity / player / EntityPlayer . java . patch b / patches / minecraft / net / minecraft / entity / player / EntityPlayer . java . patch 
 index 168d019 . . 3ef5937 100644 
 - - - a / patches / minecraft / net / minecraft / entity / player / EntityPlayer . java . patch 
 + + + b / patches / minecraft / net / minecraft / entity / player / EntityPlayer . java . patch 
 @ @ - 453 , 18 + 453 , 19 @ @ 
 } 
 
 / * * 
 - @ @ - 1650 , 6 + 1803 , 10 @ @ 
 + @ @ - 1650 , 6 + 1803 , 11 @ @ 
 * / 
 public void setSpawnChunk ( ChunkCoordinates par1ChunkCoordinates , boolean par2 ) 
 { 
 - + if ( this . dimension ! = 0 ) { 
 + + if ( this . dimension ! = 0 ) 
 + + { 
 + setSpawnChunk ( par1ChunkCoordinates , par2 , this . dimension ) ; 
 + return ; 
 + } 
 if ( par1ChunkCoordinates ! = null ) 
 { 
 this . spawnChunk = new ChunkCoordinates ( par1ChunkCoordinates ) ; 
 - @ @ - 1661 , 7 + 1818 , 32 @ @ 
 + @ @ - 1661 , 7 + 1819 , 39 @ @ 
 this . spawnForced = false ; 
 } 
 } 
 @ @ - 477 , 20 + 478 , 27 @ @ 
 + * @ param dimension Which dimension to apply the player - specific respawn point to 
 + * / 
 + public void setSpawnChunk ( ChunkCoordinates chunkCoordinates , boolean forced , int dimension ) { 
 - + if ( dimension = = 0 ) { 
 - + if ( chunkCoordinates ! = null ) { 
 + + if ( dimension = = 0 ) 
 + + { 
 + + if ( chunkCoordinates ! = null ) 
 + + { 
 + this . spawnChunk = new ChunkCoordinates ( chunkCoordinates ) ; 
 + this . spawnForced = forced ; 
 - + } else { 
 + + } 
 + + else 
 + + { 
 + this . spawnChunk = null ; 
 + this . spawnForced = false ; 
 + } 
 + return ; 
 + } 
 - + if ( chunkCoordinates ! = null ) { 
 + + if ( chunkCoordinates ! = null ) 
 + + { 
 + this . spawnChunkMap . put ( dimension , new ChunkCoordinates ( chunkCoordinates ) ) ; 
 + this . spawnForcedMap . put ( dimension , forced ) ; 
 - + } else { 
 + + } 
 + + else 
 + + { 
 + this . spawnChunkMap . remove ( dimension ) ; 
 + this . spawnForcedMap . remove ( dimension ) ; 
 + } 
 @ @ - 498 , 7 + 506 , 7 @ @ 
 / * * 
 * Will trigger the specified trigger . 
 * / 
 - @ @ - 1843 , 6 + 2025 , 10 @ @ 
 + @ @ - 1843 , 6 + 2033 , 10 @ @ 
 
 super . fall ( par1 ) ; 
 } 
 @ @ - 509 , 7 + 517 , 7 @ @ 
 } 
 
 / * * 
 - @ @ - 1884 , 7 + 2070 , 7 @ @ 
 + @ @ - 1884 , 7 + 2078 , 7 @ @ 
 { 
 if ( par1ItemStack . getItem ( ) . requiresMultipleRenderPasses ( ) ) 
 { 
 @ @ - 518 , 7 + 526 , 7 @ @ 
 } 
 
 if ( this . itemInUse ! = null & & par1ItemStack . itemID = = Item . bow . itemID ) 
 - @ @ - 1906 , 6 + 2092 , 7 @ @ 
 + @ @ - 1906 , 6 + 2100 , 7 @ @ 
 return Item . bow . getItemIconForUseDuration ( 0 ) ; 
 } 
 } 
 @ @ - 526 , 7 + 534 , 7 @ @ 
 } 
 
 return icon ; 
 - @ @ - 2127 , 7 + 2314 , 17 @ @ 
 + @ @ - 2127 , 7 + 2322 , 17 @ @ 
 this . setScore ( par1EntityPlayer . getScore ( ) ) ; 
 } 
 
 @ @ - 544 , 7 + 552 , 7 @ @ 
 } 
 
 / * * 
 - @ @ - 2191 , 7 + 2388 , 14 @ @ 
 + @ @ - 2191 , 7 + 2396 , 14 @ @ 
 * / 
 public void setCurrentItemOrArmor ( int par1 , ItemStack par2ItemStack ) 
 { 
 @ @ - 560 , 7 + 568 , 7 @ @ 
 } 
 
 @ SideOnly ( Side . CLIENT ) 
 - @ @ - 2245 , 7 + 2449 , 7 @ @ 
 + @ @ - 2245 , 7 + 2457 , 7 @ @ 
 * / 
 public String getTranslatedEntityName ( ) 
 { 
 @ @ - 569 , 7 + 577 , 7 @ @ 
 } 
 
 public void setAbsorptionAmount ( float par1 ) 
 - @ @ - 2267 , 4 + 2471 , 39 @ @ 
 + @ @ - 2267 , 4 + 2479 , 39 @ @ 
 { 
 FMLNetworkHandler . openGui ( this , mod , modGuiId , world , x , y , z ) ; 
 } 
 diff - - git a / patches / minecraft / net / minecraft / world / World . java . patch b / patches / minecraft / net / minecraft / world / World . java . patch 
 index 68e76d6 . . 92fdbc5 100644 
 - - - a / patches / minecraft / net / minecraft / world / World . java . patch 
 + + + b / patches / minecraft / net / minecraft / world / World . java . patch 
 @ @ - 114 , 7 + 114 , 7 @ @ 
 } 
 else 
 { 
 - @ @ - 290 , 6 + 337 , 19 @ @ 
 + @ @ - 290 , 6 + 337 , 20 @ @ 
 
 this . calculateInitialSkylight ( ) ; 
 this . calculateInitialWeather ( ) ; 
 @ @ - 126 , 7 + 126 , 8 @ @ 
 + / / Buildcraft has suffered from the issue this fixes . If you load the same data from two different worlds they can get two different copies of the same object , thus the last saved gets final say . 
 + private MapStorage getMapStorage ( ISaveHandler savehandler ) 
 + { 
 - + if ( s _ savehandler ! = savehandler | | s _ mapStorage = = null ) { 
 + + if ( s _ savehandler ! = savehandler | | s _ mapStorage = = null ) 
 + + { 
 + s _ mapStorage = new MapStorage ( savehandler ) ; 
 + s _ savehandler = savehandler ; 
 + } 
 @ @ - 134 , 7 + 135 , 7 @ @ 
 } 
 
 / * * 
 - @ @ - 373 , 7 + 433 , 8 @ @ 
 + @ @ - 373 , 7 + 434 , 8 @ @ 
 * / 
 public boolean isAirBlock ( int par1 , int par2 , int par3 ) 
 { 
 @ @ - 144 , 7 + 145 , 7 @ @ 
 } 
 
 / * * 
 - @ @ - 382 , 7 + 443 , 8 @ @ 
 + @ @ - 382 , 7 + 444 , 8 @ @ 
 public boolean blockHasTileEntity ( int par1 , int par2 , int par3 ) 
 { 
 int l = this . getBlockId ( par1 , par2 , par3 ) ; 
 @ @ - 154 , 7 + 155 , 7 @ @ 
 } 
 
 / * * 
 - @ @ - 1157 , 7 + 1219 , 7 @ @ 
 + @ @ - 1157 , 7 + 1220 , 7 @ @ 
 * / 
 public boolean isDaytime ( ) 
 { 
 @ @ - 163 , 7 + 164 , 7 @ @ 
 } 
 
 / * * 
 - @ @ - 1192 , 7 + 1254 , 7 @ @ 
 + @ @ - 1192 , 7 + 1255 , 7 @ @ 
 int l1 = this . getBlockMetadata ( l , i1 , j1 ) ; 
 Block block = Block . blocksList [ k1 ] ; 
 
 @ @ - 172 , 7 + 173 , 7 @ @ 
 { 
 MovingObjectPosition movingobjectposition = block . collisionRayTrace ( this , l , i1 , j1 , par1Vec3 , par2Vec3 ) ; 
 
 - @ @ - 1392 , 6 + 1454 , 12 @ @ 
 + @ @ - 1392 , 6 + 1455 , 12 @ @ 
 * / 
 public void playSoundAtEntity ( Entity par1Entity , String par2Str , float par3 , float par4 ) 
 { 
 @ @ - 185 , 7 + 186 , 7 @ @ 
 if ( par1Entity ! = null & & par2Str ! = null ) 
 { 
 for ( int i = 0 ; i < this . worldAccesses . size ( ) ; + + i ) 
 - @ @ - 1406 , 6 + 1474 , 12 @ @ 
 + @ @ - 1406 , 6 + 1475 , 12 @ @ 
 * / 
 public void playSoundToNearExcept ( EntityPlayer par1EntityPlayer , String par2Str , float par3 , float par4 ) 
 { 
 @ @ - 198 , 7 + 199 , 7 @ @ 
 if ( par1EntityPlayer ! = null & & par2Str ! = null ) 
 { 
 for ( int i = 0 ; i < this . worldAccesses . size ( ) ; + + i ) 
 - @ @ - 1492 , 6 + 1566 , 11 @ @ 
 + @ @ - 1492 , 6 + 1567 , 11 @ @ 
 EntityPlayer entityplayer = ( EntityPlayer ) par1Entity ; 
 this . playerEntities . add ( entityplayer ) ; 
 this . updateAllPlayersSleepingFlag ( ) ; 
 @ @ - 210 , 7 + 211 , 7 @ @ 
 } 
 
 this . getChunkFromChunkCoords ( i , j ) . addEntity ( par1Entity ) ; 
 - @ @ - 1732 , 6 + 1811 , 12 @ @ 
 + @ @ - 1732 , 6 + 1812 , 12 @ @ 
 * Calculates the color for the skybox 
 * / 
 public Vec3 getSkyColor ( Entity par1Entity , float par2 ) 
 @ @ - 223 , 7 + 224 , 7 @ @ 
 { 
 float f1 = this . getCelestialAngle ( par2 ) ; 
 float f2 = MathHelper . cos ( f1 * ( float ) Math . PI * 2 . 0F ) * 2 . 0F + 0 . 5F ; 
 - @ @ - 1833 , 6 + 1918 , 12 @ @ 
 + @ @ - 1833 , 6 + 1919 , 12 @ @ 
 @ SideOnly ( Side . CLIENT ) 
 public Vec3 getCloudColour ( float par1 ) 
 { 
 @ @ - 236 , 7 + 237 , 7 @ @ 
 float f1 = this . getCelestialAngle ( par1 ) ; 
 float f2 = MathHelper . cos ( f1 * ( float ) Math . PI * 2 . 0F ) * 2 . 0F + 0 . 5F ; 
 
 - @ @ - 1904 , 6 + 1995 , 8 @ @ 
 + @ @ - 1904 , 6 + 1996 , 8 @ @ 
 public int getTopSolidOrLiquidBlock ( int par1 , int par2 ) 
 { 
 Chunk chunk = this . getChunkFromBlockCoords ( par1 , par2 ) ; 
 @ @ - 245 , 7 + 246 , 7 @ @ 
 int k = chunk . getTopFilledSegment ( ) + 15 ; 
 par1 & = 15 ; 
 
 - @ @ - 1911 , 7 + 2004 , 7 @ @ 
 + @ @ - 1911 , 7 + 2005 , 7 @ @ 
 { 
 int l = chunk . getBlockID ( par1 , k , par2 ) ; 
 
 @ @ - 254 , 7 + 255 , 7 @ @ 
 { 
 return k + 1 ; 
 } 
 - @ @ - 1926 , 6 + 2019 , 12 @ @ 
 + @ @ - 1926 , 6 + 2020 , 12 @ @ 
 * How bright are stars in the sky 
 * / 
 public float getStarBrightness ( float par1 ) 
 @ @ - 267 , 7 + 268 , 7 @ @ 
 { 
 float f1 = this . getCelestialAngle ( par1 ) ; 
 float f2 = 1 . 0F - ( MathHelper . cos ( f1 * ( float ) Math . PI * 2 . 0F ) * 2 . 0F + 0 . 25F ) ; 
 - @ @ - 1990 , 7 + 2089 , 15 @ @ 
 + @ @ - 1990 , 7 + 2090 , 15 @ @ 
 entity . addEntityCrashInfo ( crashreportcategory ) ; 
 } 
 
 @ @ - 284 , 7 + 285 , 7 @ @ 
 } 
 
 if ( entity . isDead ) 
 - @ @ - 2052 , 7 + 2159 , 16 @ @ 
 + @ @ - 2052 , 7 + 2160 , 16 @ @ 
 crashreport = CrashReport . makeCrashReport ( throwable1 , " Ticking entity " ) ; 
 crashreportcategory = crashreport . makeCategory ( " Entity being ticked " ) ; 
 entity . addEntityCrashInfo ( crashreportcategory ) ; 
 @ @ - 302 , 7 + 303 , 7 @ @ 
 } 
 } 
 
 - @ @ - 2095 , 7 + 2211 , 16 @ @ 
 + @ @ - 2095 , 7 + 2212 , 16 @ @ 
 crashreport = CrashReport . makeCrashReport ( throwable2 , " Ticking tile entity " ) ; 
 crashreportcategory = crashreport . makeCategory ( " Tile entity being ticked " ) ; 
 tileentity . func _ 85027 _ a ( crashreportcategory ) ; 
 @ @ - 320 , 7 + 321 , 7 @ @ 
 } 
 } 
 
 - @ @ - 2109 , 7 + 2234 , 7 @ @ 
 + @ @ - 2109 , 7 + 2235 , 7 @ @ 
 
 if ( chunk ! = null ) 
 { 
 @ @ - 329 , 7 + 330 , 7 @ @ 
 } 
 } 
 } 
 - @ @ - 2118 , 6 + 2243 , 10 @ @ 
 + @ @ - 2118 , 6 + 2244 , 10 @ @ 
 
 if ( ! this . entityRemoval . isEmpty ( ) ) 
 { 
 @ @ - 340 , 7 + 341 , 7 @ @ 
 this . loadedTileEntityList . removeAll ( this . entityRemoval ) ; 
 this . entityRemoval . clear ( ) ; 
 } 
 - @ @ - 2138 , 18 + 2267 , 18 @ @ 
 + @ @ - 2138 , 18 + 2268 , 18 @ @ 
 { 
 this . loadedTileEntityList . add ( tileentity1 ) ; 
 } 
 @ @ - 363 , 7 + 364 , 7 @ @ 
 } 
 } 
 
 - @ @ - 2162 , 13 + 2291 , 13 @ @ 
 + @ @ - 2162 , 13 + 2292 , 13 @ @ 
 
 public void addTileEntity ( Collection par1Collection ) 
 { 
 @ @ - 384 , 7 + 385 , 7 @ @ 
 } 
 } 
 
 - @ @ - 2188 , 9 + 2317 , 17 @ @ 
 + @ @ - 2188 , 9 + 2318 , 17 @ @ 
 { 
 int i = MathHelper . floor _ double ( par1Entity . posX ) ; 
 int j = MathHelper . floor _ double ( par1Entity . posZ ) ; 
 @ @ - 405 , 7 + 406 , 7 @ @ 
 { 
 par1Entity . lastTickPosX = par1Entity . posX ; 
 par1Entity . lastTickPosY = par1Entity . posY ; 
 - @ @ - 2424 , 6 + 2561 , 14 @ @ 
 + @ @ - 2424 , 6 + 2562 , 14 @ @ 
 { 
 return true ; 
 } 
 @ @ - 420 , 7 + 421 , 7 @ @ 
 } 
 } 
 } 
 - @ @ - 2746 , 15 + 2891 , 16 @ @ 
 + @ @ - 2746 , 15 + 2892 , 16 @ @ 
 * / 
 public void setBlockTileEntity ( int par1 , int par2 , int par3 , TileEntity par4TileEntity ) 
 { 
 @ @ - 446 , 7 + 447 , 7 @ @ 
 while ( iterator . hasNext ( ) ) 
 { 
 TileEntity tileentity1 = ( TileEntity ) iterator . next ( ) ; 
 - @ @ - 2765 , 20 + 2911 , 21 @ @ 
 + @ @ - 2765 , 20 + 2912 , 21 @ @ 
 iterator . remove ( ) ; 
 } 
 } 
 @ @ - 479 , 7 + 480 , 7 @ @ 
 } 
 
 / * * 
 - @ @ - 2786 , 28 + 2933 , 13 @ @ 
 + @ @ - 2786 , 28 + 2934 , 13 @ @ 
 * / 
 public void removeBlockTileEntity ( int par1 , int par2 , int par3 ) 
 { 
 @ @ - 515 , 7 + 516 , 7 @ @ 
 } 
 
 / * * 
 - @ @ - 2832 , 7 + 2964 , 8 @ @ 
 + @ @ - 2832 , 7 + 2965 , 8 @ @ 
 * / 
 public boolean isBlockNormalCube ( int par1 , int par2 , int par3 ) 
 { 
 @ @ - 525 , 7 + 526 , 7 @ @ 
 } 
 
 public boolean isBlockFullCube ( int par1 , int par2 , int par3 ) 
 - @ @ - 2855 , 16 + 2988 , 17 @ @ 
 + @ @ - 2855 , 16 + 2989 , 17 @ @ 
 * / 
 public boolean doesBlockHaveSolidTopSurface ( int par1 , int par2 , int par3 ) 
 { 
 @ @ - 545 , 7 + 546 , 7 @ @ 
 return par1Block = = null ? false : ( par1Block . blockMaterial . isOpaque ( ) & & par1Block . renderAsNormalBlock ( ) ? true : ( par1Block instanceof BlockStairs ? ( par2 & 4 ) = = 4 : ( par1Block instanceof BlockHalfSlab ? ( par2 & 8 ) = = 8 : ( par1Block instanceof BlockHopper ? true : ( par1Block instanceof BlockSnow ? ( par2 & 7 ) = = 7 : false ) ) ) ) ) ; 
 } 
 
 - @ @ - 2881 , 7 + 3015 , 7 @ @ 
 + @ @ - 2881 , 7 + 3016 , 7 @ @ 
 if ( chunk ! = null & & ! chunk . isEmpty ( ) ) 
 { 
 Block block = Block . blocksList [ this . getBlockId ( par1 , par2 , par3 ) ] ; 
 @ @ - 554 , 7 + 555 , 7 @ @ 
 } 
 else 
 { 
 - @ @ - 2912 , 8 + 3046 , 7 @ @ 
 + @ @ - 2912 , 8 + 3047 , 7 @ @ 
 * / 
 public void setAllowedSpawnTypes ( boolean par1 , boolean par2 ) 
 { 
 @ @ - 564 , 7 + 565 , 7 @ @ 
 } 
 
 / * * 
 - @ @ - 2929 , 6 + 3062 , 11 @ @ 
 + @ @ - 2929 , 6 + 3063 , 11 @ @ 
 * / 
 private void calculateInitialWeather ( ) 
 { 
 @ @ - 576 , 7 + 577 , 7 @ @ 
 if ( this . worldInfo . isRaining ( ) ) 
 { 
 this . rainingStrength = 1 . 0F ; 
 - @ @ - 2944 , 6 + 3082 , 11 @ @ 
 + @ @ - 2944 , 6 + 3083 , 11 @ @ 
 * Updates all weather states . 
 * / 
 protected void updateWeather ( ) 
 @ @ - 588 , 7 + 589 , 7 @ @ 
 { 
 if ( ! this . provider . hasNoSky ) 
 { 
 - @ @ - 3041 , 12 + 3184 , 14 @ @ 
 + @ @ - 3041 , 12 + 3185 , 14 @ @ 
 
 public void toggleRain ( ) 
 { 
 @ @ - 604 , 7 + 605 , 7 @ @ 
 this . theProfiler . startSection ( " buildList " ) ; 
 int i ; 
 EntityPlayer entityplayer ; 
 - @ @ - 3153 , 6 + 3298 , 11 @ @ 
 + @ @ - 3153 , 6 + 3299 , 11 @ @ 
 * / 
 public boolean canBlockFreeze ( int par1 , int par2 , int par3 , boolean par4 ) 
 { 
 @ @ - 616 , 7 + 617 , 7 @ @ 
 BiomeGenBase biomegenbase = this . getBiomeGenForCoords ( par1 , par3 ) ; 
 float f = biomegenbase . getFloatTemperature ( ) ; 
 
 - @ @ - 3211 , 6 + 3361 , 11 @ @ 
 + @ @ - 3211 , 6 + 3362 , 11 @ @ 
 * / 
 public boolean canSnowAt ( int par1 , int par2 , int par3 ) 
 { 
 @ @ - 628 , 7 + 629 , 7 @ @ 
 BiomeGenBase biomegenbase = this . getBiomeGenForCoords ( par1 , par3 ) ; 
 float f = biomegenbase . getFloatTemperature ( ) ; 
 
 - @ @ - 3254 , 10 + 3409 , 12 @ @ 
 + @ @ - 3254 , 10 + 3410 , 12 @ @ 
 else 
 { 
 int l = this . getBlockId ( par1 , par2 , par3 ) ; 
 @ @ - 645 , 7 + 646 , 7 @ @ 
 { 
 j1 = 1 ; 
 } 
 - @ @ - 3353 , 7 + 3510 , 9 @ @ 
 + @ @ - 3353 , 7 + 3511 , 9 @ @ 
 int j4 = i2 + Facing . offsetsXForSide [ i4 ] ; 
 int k4 = j2 + Facing . offsetsYForSide [ i4 ] ; 
 int l4 = k2 + Facing . offsetsZForSide [ i4 ] ; 
 @ @ - 656 , 7 + 657 , 7 @ @ 
 i3 = this . getSavedLightValue ( par1EnumSkyBlock , j4 , k4 , l4 ) ; 
 
 if ( i3 = = l2 - i5 & & i1 < this . lightUpdateBlockList . length ) 
 - @ @ - 3456 , 10 + 3615 , 10 @ @ 
 + @ @ - 3456 , 10 + 3616 , 10 @ @ 
 public List getEntitiesWithinAABBExcludingEntity ( Entity par1Entity , AxisAlignedBB par2AxisAlignedBB , IEntitySelector par3IEntitySelector ) 
 { 
 ArrayList arraylist = new ArrayList ( ) ; 
 @ @ - 671 , 7 + 672 , 7 @ @ 
 
 for ( int i1 = i ; i1 < = j ; + + i1 ) 
 { 
 - @ @ - 3485 , 10 + 3644 , 10 @ @ 
 + @ @ - 3485 , 10 + 3645 , 10 @ @ 
 
 public List selectEntitiesWithinAABB ( Class par1Class , AxisAlignedBB par2AxisAlignedBB , IEntitySelector par3IEntitySelector ) 
 { 
 @ @ - 686 , 7 + 687 , 7 @ @ 
 ArrayList arraylist = new ArrayList ( ) ; 
 
 for ( int i1 = i ; i1 < = j ; + + i1 ) 
 - @ @ - 3582 , 11 + 3741 , 14 @ @ 
 + @ @ - 3582 , 11 + 3742 , 14 @ @ 
 * / 
 public void addLoadedEntities ( List par1List ) 
 { 
 @ @ - 704 , 7 + 705 , 7 @ @ 
 } 
 } 
 
 - @ @ - 3620 , 6 + 3782 , 11 @ @ 
 + @ @ - 3620 , 6 + 3783 , 11 @ @ 
 else 
 { 
 if ( block ! = null & & ( block = = Block . waterMoving | | block = = Block . waterStill | | block = = Block . lavaMoving | | block = = Block . lavaStill | | block = = Block . fire | | block . blockMaterial . isReplaceable ( ) ) ) 
 @ @ - 716 , 7 + 717 , 7 @ @ 
 { 
 block = null ; 
 } 
 - @ @ - 3914 , 7 + 4081 , 7 @ @ 
 + @ @ - 3914 , 7 + 4082 , 7 @ @ 
 * / 
 public long getSeed ( ) 
 { 
 @ @ - 725 , 7 + 726 , 7 @ @ 
 } 
 
 public long getTotalWorldTime ( ) 
 - @ @ - 3924 , 7 + 4091 , 7 @ @ 
 + @ @ - 3924 , 7 + 4092 , 7 @ @ 
 
 public long getWorldTime ( ) 
 { 
 @ @ - 734 , 7 + 735 , 7 @ @ 
 } 
 
 / * * 
 - @ @ - 3932 , 7 + 4099 , 7 @ @ 
 + @ @ - 3932 , 7 + 4100 , 7 @ @ 
 * / 
 public void setWorldTime ( long par1 ) 
 { 
 @ @ - 743 , 7 + 744 , 7 @ @ 
 } 
 
 / * * 
 - @ @ - 3940 , 13 + 4107 , 13 @ @ 
 + @ @ - 3940 , 13 + 4108 , 13 @ @ 
 * / 
 public ChunkCoordinates getSpawnPoint ( ) 
 { 
 @ @ - 759 , 7 + 760 , 7 @ @ 
 } 
 
 @ SideOnly ( Side . CLIENT ) 
 - @ @ - 3970 , 7 + 4137 , 10 @ @ 
 + @ @ - 3970 , 7 + 4138 , 10 @ @ 
 
 if ( ! this . loadedEntityList . contains ( par1Entity ) ) 
 { 
 @ @ - 771 , 7 + 772 , 7 @ @ 
 } 
 } 
 
 - @ @ - 3978 , 6 + 4148 , 11 @ @ 
 + @ @ - 3978 , 6 + 4149 , 11 @ @ 
 * Called when checking if a certain block can be mined or not . The ' spawn safe zone ' check is located here . 
 * / 
 public boolean canMineBlock ( EntityPlayer par1EntityPlayer , int par2 , int par3 , int par4 ) 
 @ @ - 783 , 7 + 784 , 7 @ @ 
 { 
 return true ; 
 } 
 - @ @ - 4098 , 8 + 4273 , 7 @ @ 
 + @ @ - 4098 , 8 + 4274 , 7 @ @ 
 * / 
 public boolean isBlockHighHumidity ( int par1 , int par2 , int par3 ) 
 { 
 @ @ - 793 , 7 + 794 , 7 @ @ 
 } 
 
 / * * 
 - @ @ - 4174 , 7 + 4348 , 7 @ @ 
 + @ @ - 4174 , 7 + 4349 , 7 @ @ 
 * / 
 public int getHeight ( ) 
 { 
 @ @ - 802 , 7 + 803 , 7 @ @ 
 } 
 
 / * * 
 - @ @ - 4182 , 7 + 4356 , 7 @ @ 
 + @ @ - 4182 , 7 + 4357 , 7 @ @ 
 * / 
 public int getActualHeight ( ) 
 { 
 @ @ - 811 , 7 + 812 , 7 @ @ 
 } 
 
 public IUpdatePlayerListBox getMinecartSoundUpdater ( EntityMinecart par1EntityMinecart ) 
 - @ @ - 4225 , 7 + 4399 , 7 @ @ 
 + @ @ - 4225 , 7 + 4400 , 7 @ @ 
 * / 
 public double getHorizon ( ) 
 { 
 @ @ - 820 , 7 + 821 , 7 @ @ 
 } 
 
 / * * 
 - @ @ - 4294 , 30 + 4468 , 28 @ @ 
 + @ @ - 4294 , 30 + 4469 , 28 @ @ 
 
 public void func _ 96440 _ m ( int par1 , int par2 , int par3 , int par4 ) 
 { 
 @ @ - 872 , 7 + 873 , 7 @ @ 
 } 
 } 
 } 
 - @ @ - 4363 , 4 + 4535 , 115 @ @ 
 + @ @ - 4363 , 4 + 4536 , 115 @ @ 
 
 return MathHelper . clamp _ float ( f , 0 . 0F , flag ? 1 . 5F : 1 . 0F ) ; 
 } 
 diff - - git a / patches / minecraft / net / minecraft / world / chunk / Chunk . java . patch b / patches / minecraft / net / minecraft / world / chunk / Chunk . java . patch 
 index fa2590f . . 89f4e50 100644 
 - - - a / patches / minecraft / net / minecraft / world / chunk / Chunk . java . patch 
 + + + b / patches / minecraft / net / minecraft / world / chunk / Chunk . java . patch 
 @ @ - 22 , 7 + 22 , 7 @ @ 
 
 if ( b0 ! = 0 ) 
 { 
 - @ @ - 159 , 6 + 165 , 90 @ @ 
 + @ @ - 159 , 6 + 165 , 92 @ @ 
 } 
 
 / * * 
 @ @ - 94 , 13 + 94 , 15 @ @ 
 + int id = ids [ idx ] & 0xFFFFFF ; 
 + int meta = metadata [ idx ] ; 
 + 
 - + if ( id ! = 0 ) { 
 + + if ( id ! = 0 ) 
 + + { 
 + int storageBlock = y > > 4 ; 
 + 
 - + if ( this . storageArrays [ storageBlock ] = = null ) { 
 - + this . storageArrays [ storageBlock ] = new ExtendedBlockStorage ( storageBlock < < 4 , ! world . provider . hasNoSky ) ; 
 + + if ( this . storageArrays [ storageBlock ] = = null ) 
 + + { 
 + + this . storageArrays [ storageBlock ] = new ExtendedBlockStorage ( storageBlock < < 4 , ! world . provider . hasNoSky ) ; 
 + } 
 - + 
 + + 
 + this . storageArrays [ storageBlock ] . setExtBlockID ( x , y & 15 , z , id ) ; 
 + this . storageArrays [ storageBlock ] . setExtBlockMetadata ( x , y & 15 , z , meta ) ; 
 + } 
 @ @ - 113 , 7 + 115 , 7 @ @ 
 * Checks whether the chunk is at the X / Z location specified 
 * / 
 public boolean isAtLocation ( int par1 , int par2 ) 
 - @ @ - 222 , 7 + 312 , 7 @ @ 
 + @ @ - 222 , 7 + 314 , 7 @ @ 
 { 
 int i1 = this . getBlockID ( j , l - 1 , k ) ; 
 
 @ @ - 122 , 7 + 124 , 7 @ @ 
 { 
 - - l ; 
 continue ; 
 - @ @ - 528 , 7 + 618 , 10 @ @ 
 + @ @ - 528 , 7 + 620 , 10 @ @ 
 
 public int getBlockLightOpacity ( int par1 , int par2 , int par3 ) 
 { 
 @ @ - 134 , 7 + 136 , 7 @ @ 
 } 
 
 / * * 
 - @ @ - 615 , 9 + 708 , 13 @ @ 
 + @ @ - 615 , 9 + 710 , 13 @ @ 
 { 
 Block . blocksList [ l1 ] . breakBlock ( this . worldObj , j2 , par2 , k2 , l1 , i2 ) ; 
 } 
 @ @ - 151 , 7 + 153 , 7 @ @ 
 } 
 } 
 
 - @ @ - 635 , 7 + 732 , 7 @ @ 
 + @ @ - 635 , 7 + 734 , 7 @ @ 
 } 
 else 
 { 
 @ @ - 160 , 7 + 162 , 7 @ @ 
 { 
 if ( par2 > = k1 ) 
 { 
 - @ @ - 659 , 29 + 756 , 21 @ @ 
 + @ @ - 659 , 29 + 758 , 21 @ @ 
 Block . blocksList [ par4 ] . onBlockAdded ( this . worldObj , j2 , par2 , k2 ) ; 
 } 
 
 @ @ - 193 , 7 + 195 , 7 @ @ 
 } 
 } 
 
 - @ @ - 716 , 7 + 805 , 7 @ @ 
 + @ @ - 716 , 7 + 807 , 7 @ @ 
 extendedblockstorage . setExtBlockMetadata ( par1 , par2 & 15 , par3 , par4 ) ; 
 int j1 = extendedblockstorage . getExtBlockID ( par1 , par2 & 15 , par3 ) ; 
 
 @ @ - 202 , 7 + 204 , 7 @ @ 
 { 
 TileEntity tileentity = this . getChunkBlockTileEntity ( par1 , par2 , par3 ) ; 
 
 - @ @ - 829 , 6 + 918 , 7 @ @ 
 + @ @ - 829 , 6 + 920 , 7 @ @ 
 k = this . entityLists . length - 1 ; 
 } 
 
 @ @ - 210 , 7 + 212 , 7 @ @ 
 par1Entity . addedToChunk = true ; 
 par1Entity . chunkCoordX = this . xPosition ; 
 par1Entity . chunkCoordY = k ; 
 - @ @ - 878 , 33 + 968 , 32 @ @ 
 + @ @ - 878 , 33 + 970 , 32 @ @ 
 ChunkPosition chunkposition = new ChunkPosition ( par1 , par2 , par3 ) ; 
 TileEntity tileentity = ( TileEntity ) this . chunkTileEntityMap . get ( chunkposition ) ; 
 
 @ @ - 255 , 7 + 257 , 7 @ @ 
 } 
 
 / * * 
 - @ @ - 919 , 7 + 1008 , 7 @ @ 
 + @ @ - 919 , 7 + 1010 , 7 @ @ 
 
 if ( this . isChunkLoaded ) 
 { 
 @ @ - 264 , 7 + 266 , 7 @ @ 
 } 
 } 
 
 - @ @ - 934 , 7 + 1023 , 8 @ @ 
 + @ @ - 934 , 7 + 1025 , 8 @ @ 
 par4TileEntity . yCoord = par2 ; 
 par4TileEntity . zCoord = this . zPosition * 16 + par3 ; 
 
 @ @ - 274 , 7 + 276 , 7 @ @ 
 { 
 if ( this . chunkTileEntityMap . containsKey ( chunkposition ) ) 
 { 
 - @ @ - 984 , 6 + 1074 , 7 @ @ 
 + @ @ - 984 , 6 + 1076 , 7 @ @ 
 
 this . worldObj . addLoadedEntities ( this . entityLists [ i ] ) ; 
 } 
 @ @ - 282 , 7 + 284 , 7 @ @ 
 } 
 
 / * * 
 - @ @ - 1004 , 6 + 1095 , 7 @ @ 
 + @ @ - 1004 , 6 + 1097 , 7 @ @ 
 { 
 this . worldObj . unloadEntities ( this . entityLists [ i ] ) ; 
 } 
 @ @ - 290 , 7 + 292 , 7 @ @ 
 } 
 
 / * * 
 - @ @ - 1020 , 8 + 1112 , 8 @ @ 
 + @ @ - 1020 , 8 + 1114 , 8 @ @ 
 * / 
 public void getEntitiesWithinAABBForEntity ( Entity par1Entity , AxisAlignedBB par2AxisAlignedBB , List par3List , IEntitySelector par4IEntitySelector ) 
 { 
 @ @ - 301 , 7 + 303 , 7 @ @ 
 
 if ( i < 0 ) 
 { 
 - @ @ - 1070 , 8 + 1162 , 8 @ @ 
 + @ @ - 1070 , 8 + 1164 , 8 @ @ 
 * / 
 public void getEntitiesOfTypeWithinAAAB ( Class par1Class , AxisAlignedBB par2AxisAlignedBB , List par3List , IEntitySelector par4IEntitySelector ) 
 { 
 @ @ - 312 , 7 + 314 , 7 @ @ 
 
 if ( i < 0 ) 
 { 
 - @ @ - 1254 , 6 + 1346 , 15 @ @ 
 + @ @ - 1254 , 6 + 1348 , 15 @ @ 
 * / 
 public void fillChunk ( byte [ ] par1ArrayOfByte , int par2 , int par3 , boolean par4 ) 
 { 
 @ @ - 328 , 7 + 330 , 7 @ @ 
 int k = 0 ; 
 boolean flag1 = ! this . worldObj . provider . hasNoSky ; 
 int l ; 
 - @ @ - 1354 , 12 + 1455 , 26 @ @ 
 + @ @ - 1354 , 12 + 1457 , 26 @ @ 
 } 
 
 this . generateHeightMap ( ) ; 
 @ @ - 359 , 7 + 361 , 7 @ @ 
 } 
 } 
 
 - @ @ - 1468 , 4 + 1583 , 18 @ @ 
 + @ @ - 1468 , 4 + 1585 , 18 @ @ 
 } 
 } 
 }
