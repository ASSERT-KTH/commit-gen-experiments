BLEU SCORE: 0.015445276590783498

TEST MSG: Refactor to use naming service , and provide an MCP naming service when
GENERATED MSG: Early signs of modloading

TEST DIFF (one line): diff - - git a / build . gradle b / build . gradle <nl> index 67827c0 . . 6a2c5cb 100644 <nl> - - - a / build . gradle <nl> + + + b / build . gradle <nl> @ @ - 288 , 8 + 288 , 8 @ @ project ( ' : forge ' ) { <nl> installer ' org . ow2 . asm : asm : 6 . 2 ' <nl> installer ' org . ow2 . asm : asm - commons : 6 . 2 ' <nl> installer ' org . ow2 . asm : asm - tree : 6 . 2 ' <nl> - installer ' cpw . mods : modlauncher : 0 . 12 . + ' <nl> - installer ' net . minecraftforge : accesstransformers : 0 . 15 . + : shadowed ' <nl> + installer ' cpw . mods : modlauncher : 1 . 0 . + ' <nl> + installer ' net . minecraftforge : accesstransformers : 0 . 16 . + : shadowed ' <nl> installer ' net . minecraftforge : eventbus : 0 . 8 . + : service ' <nl> installer ' net . minecraftforge : forgespi : 0 . 11 . + ' <nl> installer ' net . minecraftforge : coremods : 0 . 4 . + ' <nl> diff - - git a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLClientLaunchProvider . java b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLClientLaunchProvider . java <nl> index f5af1b0 . . 4eead08 100644 <nl> - - - a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLClientLaunchProvider . java <nl> + + + b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLClientLaunchProvider . java <nl> @ @ - 80 , 4 + 80 , 9 @ @ public class FMLClientLaunchProvider extends FMLCommonLaunchHandler implements I <nl> { <nl> return Dist . CLIENT ; <nl> } <nl> + <nl> + @ Override <nl> + protected String getNaming ( ) { <nl> + return " srg " ; <nl> + } <nl> } <nl> diff - - git a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLCommonLaunchHandler . java b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLCommonLaunchHandler . java <nl> index 0fb188a . . 86371ee 100644 <nl> - - - a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLCommonLaunchHandler . java <nl> + + + b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLCommonLaunchHandler . java <nl> @ @ - 135 , 4 + 135 , 6 @ @ public abstract class FMLCommonLaunchHandler <nl> return Optional . empty ( ) ; <nl> } ; <nl> } <nl> + <nl> + protected abstract String getNaming ( ) ; <nl> } <nl> diff - - git a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLEnvironment . java b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLEnvironment . java <nl> index 8df96ef . . f1471b3 100644 <nl> - - - a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLEnvironment . java <nl> + + + b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLEnvironment . java <nl> @ @ - 26 , 8 + 26 , 10 @ @ import net . minecraftforge . forgespi . Environment ; <nl> public class FMLEnvironment <nl> { <nl> public static final Dist dist = FMLLoader . getDist ( ) ; <nl> + public static final String naming = FMLLoader . getNaming ( ) ; <nl> <nl> static void setupInteropEnvironment ( IEnvironment environment ) { <nl> + environment . computePropertyIfAbsent ( IEnvironment . Keys . NAMING . get ( ) , v - > naming ) ; <nl> environment . computePropertyIfAbsent ( Environment . Keys . DIST . get ( ) , v - > dist ) ; <nl> } <nl> } <nl> diff - - git a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLLoader . java b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLLoader . java <nl> index c32e91c . . ff39c52 100644 <nl> - - - a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLLoader . java <nl> + + + b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLLoader . java <nl> @ @ - 19 , 27 + 19 , 35 @ @ <nl> <nl> package net . minecraftforge . fml . loading ; <nl> <nl> + import cpw . mods . modlauncher . Launcher ; <nl> import cpw . mods . modlauncher . ServiceLoaderStreamUtils ; <nl> import cpw . mods . modlauncher . TransformingClassLoader ; <nl> import cpw . mods . modlauncher . api . IEnvironment ; <nl> import cpw . mods . modlauncher . api . ILaunchHandlerService ; <nl> + import cpw . mods . modlauncher . api . INameMappingService ; <nl> import cpw . mods . modlauncher . api . ITransformationService ; <nl> import cpw . mods . modlauncher . api . ITransformingClassLoader ; <nl> import cpw . mods . modlauncher . api . IncompatibleEnvironmentException ; <nl> import cpw . mods . modlauncher . serviceapi . ILaunchPluginService ; <nl> + import net . minecraftforge . accesstransformer . service . AccessTransformerService ; <nl> import net . minecraftforge . api . distmarker . Dist ; <nl> import net . minecraftforge . fml . loading . moddiscovery . BackgroundScanHandler ; <nl> import net . minecraftforge . fml . loading . moddiscovery . ModDiscoverer ; <nl> import net . minecraftforge . fml . loading . moddiscovery . ModFile ; <nl> import net . minecraftforge . forgespi . Environment ; <nl> import net . minecraftforge . forgespi . coremod . ICoreModProvider ; <nl> + import org . apache . commons . lang3 . tuple . Pair ; <nl> import org . apache . logging . log4j . LogManager ; <nl> import org . apache . logging . log4j . Logger ; <nl> <nl> import java . net . URL ; <nl> import java . nio . file . Path ; <nl> import java . nio . file . Paths ; <nl> - import java . util . * ; <nl> + import java . util . ArrayList ; <nl> + import java . util . Map ; <nl> + import java . util . Optional ; <nl> + import java . util . Set ; <nl> + import java . util . function . BiFunction ; <nl> import java . util . function . Predicate ; <nl> import java . util . stream . Collectors ; <nl> <nl> @ @ - 49 , 12 + 57 , 13 @ @ import static net . minecraftforge . fml . loading . LogMarkers . SCAN ; <nl> public class FMLLoader <nl> { <nl> private static final Logger LOGGER = LogManager . getLogger ( ) ; <nl> - private static ILaunchPluginService accessTransformer ; <nl> + private static AccessTransformerService accessTransformer ; <nl> private static ModDiscoverer modDiscoverer ; <nl> private static ICoreModProvider coreModProvider ; <nl> private static ILaunchPluginService eventBus ; <nl> private static LanguageLoadingProvider languageLoadingProvider ; <nl> private static Dist dist ; <nl> + private static String naming ; <nl> private static LoadingModList loadingModList ; <nl> private static TransformingClassLoader launchClassLoader ; <nl> private static RuntimeDistCleaner runtimeDistCleaner ; <nl> @ @ - 73 , 14 + 82 , 14 @ @ public class FMLLoader <nl> LOGGER . debug ( CORE , " FML { } loading " , version ) ; <nl> final Package modLauncherPackage = ITransformationService . class . getPackage ( ) ; <nl> LOGGER . debug ( CORE , " FML found ModLauncher version : { } " , modLauncherPackage . getImplementationVersion ( ) ) ; <nl> - if ( ! modLauncherPackage . isCompatibleWith ( " 1 . 0 " ) ) { <nl> + if ( ! modLauncherPackage . isCompatibleWith ( " 2 . 0 " ) ) { <nl> LOGGER . fatal ( CORE , " Found incompatible ModLauncher specification : { } , version { } from { } " , modLauncherPackage . getSpecificationVersion ( ) , modLauncherPackage . getImplementationVersion ( ) , modLauncherPackage . getImplementationVendor ( ) ) ; <nl> throw new IncompatibleEnvironmentException ( " Incompatible modlauncher found " + modLauncherPackage . getSpecificationVersion ( ) ) ; <nl> } <nl> LOGGER . debug ( CORE , " Initializing modjar URL handler " ) ; <nl> URL . setURLStreamHandlerFactory ( p - > p . equals ( " modjar " ) ? new ModJarURLHandler ( ) : null ) ; <nl> <nl> - accessTransformer = environment . findLaunchPlugin ( " accesstransformer " ) . orElseThrow ( ( ) - > { <nl> + accessTransformer = ( AccessTransformerService ) environment . findLaunchPlugin ( " accesstransformer " ) . orElseThrow ( ( ) - > { <nl> LOGGER . fatal ( CORE , " Access Transformer library is missing , we need this to run " ) ; <nl> return new IncompatibleEnvironmentException ( " Missing AccessTransformer , cannot run " ) ; <nl> } ) ; <nl> @ @ - 160 , 7 + 169 , 9 @ @ public class FMLLoader <nl> gamePath = environment . getProperty ( IEnvironment . Keys . GAMEDIR . get ( ) ) . orElse ( Paths . get ( " . " ) . toAbsolutePath ( ) ) ; <nl> <nl> FMLCommonLaunchHandler commonLaunchHandler = ( FMLCommonLaunchHandler ) launchHandler . get ( ) ; <nl> + naming = commonLaunchHandler . getNaming ( ) ; <nl> dist = commonLaunchHandler . getDist ( ) ; <nl> + accessTransformer . getExtension ( ) . accept ( Pair . of ( naming , " srg " ) ) ; <nl> <nl> mcVersion = ( String ) arguments . get ( " mcVersion " ) ; <nl> mcpVersion = ( String ) arguments . get ( " mcpVersion " ) ; <nl> @ @ - 245 , 4 + 256 , 12 @ @ public class FMLLoader <nl> public static Predicate < String > getClassLoaderExclusions ( ) { <nl> return classLoaderExclusions ; <nl> } <nl> + <nl> + public static String getNaming ( ) { <nl> + return naming ; <nl> + } <nl> + <nl> + public static Optional < BiFunction < INameMappingService . Domain , String , String > > getNameFunction ( final String naming ) { <nl> + return Launcher . INSTANCE . environment ( ) . findNameMapping ( naming ) ; <nl> + } <nl> } <nl> diff - - git a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLServerLaunchProvider . java b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLServerLaunchProvider . java <nl> index d0fde9d . . 608dfc4 100644 <nl> - - - a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLServerLaunchProvider . java <nl> + + + b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLServerLaunchProvider . java <nl> @ @ - 19 , 7 + 19 , 6 @ @ <nl> <nl> package net . minecraftforge . fml . loading ; <nl> <nl> - import com . google . common . collect . ObjectArrays ; <nl> import cpw . mods . modlauncher . api . IEnvironment ; <nl> import cpw . mods . modlauncher . api . ILaunchHandlerService ; <nl> import cpw . mods . modlauncher . api . ITransformingClassLoader ; <nl> @ @ - 27 , 7 + 26 , 6 @ @ import net . minecraftforge . api . distmarker . Dist ; <nl> import org . apache . logging . log4j . LogManager ; <nl> import org . apache . logging . log4j . Logger ; <nl> <nl> - import java . nio . file . Path ; <nl> import java . util . ArrayList ; <nl> import java . util . List ; <nl> import java . util . Map ; <nl> @ @ - 74 , 4 + 72 , 10 @ @ public class FMLServerLaunchProvider extends FMLCommonLaunchHandler implements I <nl> { <nl> return Dist . DEDICATED _ SERVER ; <nl> } <nl> + <nl> + @ Override <nl> + protected String getNaming ( ) { <nl> + return " srg " ; <nl> + } <nl> + <nl> } <nl> diff - - git a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLServiceProvider . java b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLServiceProvider . java <nl> index f014265 . . 176d377 100644 <nl> - - - a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLServiceProvider . java <nl> + + + b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLServiceProvider . java <nl> @ @ - 55 , 6 + 55 , 7 @ @ public class FMLServiceProvider implements ITransformationService <nl> private String targetMcpVersion ; <nl> private String targetMcpMappings ; <nl> private String targetForgeGroup ; <nl> + private Map < String , Object > arguments ; <nl> <nl> @ Override <nl> public String name ( ) <nl> @ @ - 63 , 13 + 64 , 12 @ @ public class FMLServiceProvider implements ITransformationService <nl> } <nl> <nl> @ Override <nl> - public void initialize ( IEnvironment environment ) <nl> - { <nl> - LOGGER . debug ( CORE , " Setting up basic FML game directories " ) ; <nl> + public void initialize ( IEnvironment environment ) { <nl> + LOGGER . debug ( CORE , " Setting up basic FML game directories " ) ; <nl> FMLPaths . setup ( environment ) ; <nl> - LOGGER . debug ( CORE , " Loading configuration " ) ; <nl> + LOGGER . debug ( CORE , " Loading configuration " ) ; <nl> FMLConfig . load ( ) ; <nl> - final Map < String , Object > arguments = new HashMap < > ( ) ; <nl> + arguments = new HashMap < > ( ) ; <nl> arguments . put ( " modLists " , modListsArgumentList ) ; <nl> arguments . put ( " mods " , modsArgumentList ) ; <nl> arguments . put ( " mavenRoots " , mavenRootsArgumentList ) ; <nl> @ @ - 82 , 6 + 82 , 10 @ @ public class FMLServiceProvider implements ITransformationService <nl> FMLLoader . setupLaunchHandler ( environment , arguments ) ; <nl> FMLEnvironment . setupInteropEnvironment ( environment ) ; <nl> Environment . build ( environment ) ; <nl> + } <nl> + <nl> + @ Override <nl> + public void beginScanning ( final IEnvironment environment ) { <nl> LOGGER . debug ( CORE , " Initiating mod scan " ) ; <nl> FMLLoader . beginModScan ( arguments ) ; <nl> } <nl> diff - - git a / src / main / java / net / minecraftforge / fml / common / ObfuscationReflectionHelper . java b / src / main / java / net / minecraftforge / fml / common / ObfuscationReflectionHelper . java <nl> index cdc58cc . . d25e74e 100644 <nl> - - - a / src / main / java / net / minecraftforge / fml / common / ObfuscationReflectionHelper . java <nl> + + + b / src / main / java / net / minecraftforge / fml / common / ObfuscationReflectionHelper . java <nl> @ @ - 18 , 19 + 18 , 17 @ @ <nl> * / <nl> <nl> package net . minecraftforge . fml . common ; <nl> - import java . io . BufferedReader ; <nl> - import java . io . IOException ; <nl> - import java . io . InputStreamReader ; <nl> import java . lang . reflect . Constructor ; <nl> import java . lang . reflect . Field ; <nl> import java . lang . reflect . Method ; <nl> - import java . net . URL ; <nl> import java . util . HashMap ; <nl> import java . util . Map ; <nl> import java . util . StringJoiner ; <nl> <nl> import javax . annotation . Nonnull ; <nl> <nl> + import cpw . mods . modlauncher . api . INameMappingService ; <nl> + import net . minecraftforge . fml . loading . FMLLoader ; <nl> import org . apache . logging . log4j . LogManager ; <nl> import org . apache . logging . log4j . Logger ; <nl> import org . apache . logging . log4j . Marker ; <nl> @ @ - 59 , 25 + 57 , 9 @ @ public class ObfuscationReflectionHelper <nl> <nl> <nl> <nl> - public static String [ ] remapNames ( String . . . names ) <nl> + public static String remapName ( INameMappingService . Domain domain , String name ) <nl> { <nl> - loadMappings ( ) ; <nl> - if ( map . isEmpty ( ) ) <nl> - return names ; <nl> - <nl> - String [ ] mappedNames = new String [ names . length ] ; <nl> - int i = 0 ; <nl> - for ( String name : names ) <nl> - mappedNames [ i + + ] = map . getOrDefault ( name , name ) ; <nl> - return mappedNames ; <nl> - } <nl> - <nl> - public static String remapName ( String name ) <nl> - { <nl> - loadMappings ( ) ; <nl> - if ( map . isEmpty ( ) ) <nl> - return name ; <nl> - return map . getOrDefault ( name , name ) ; <nl> + return FMLLoader . getNameFunction ( " srg " ) . map ( f - > f . apply ( domain , name ) ) . orElse ( name ) ; <nl> } <nl> <nl> public static < T , E > T getPrivateValue ( Class < ? super E > classToAccess , E instance , int fieldIndex ) <nl> @ @ - 99 , 16 + 81 , 16 @ @ public class ObfuscationReflectionHelper <nl> { <nl> try <nl> { <nl> - return ( T ) findField ( classToAccess , remapName ( fieldName ) ) . get ( instance ) ; <nl> + return ( T ) findField ( classToAccess , remapName ( INameMappingService . Domain . FIELD , fieldName ) ) . get ( instance ) ; <nl> } <nl> catch ( UnableToFindFieldException e ) <nl> { <nl> - LOGGER . error ( " Unable to locate field { } ( { } ) on type { } " , fieldName , remapName ( fieldName ) , classToAccess . getName ( ) , e ) ; <nl> + LOGGER . error ( REFLECTION , " Unable to locate field { } ( { } ) on type { } " , fieldName , remapName ( INameMappingService . Domain . FIELD , fieldName ) , classToAccess . getName ( ) , e ) ; <nl> throw e ; <nl> } <nl> catch ( IllegalAccessException e ) <nl> { <nl> - LOGGER . error ( " Unable to access field { } ( { } ) on type { } " , fieldName , remapName ( fieldName ) , classToAccess . getName ( ) , e ) ; <nl> + LOGGER . error ( REFLECTION , " Unable to access field { } ( { } ) on type { } " , fieldName , remapName ( INameMappingService . Domain . FIELD , fieldName ) , classToAccess . getName ( ) , e ) ; <nl> throw new UnableToAccessFieldException ( e ) ; <nl> } <nl> } <nl> @ @ - 132 , 7 + 114 , 7 @ @ public class ObfuscationReflectionHelper <nl> { <nl> try <nl> { <nl> - findField ( classToAccess , remapName ( fieldName ) ) . set ( instance , value ) ; <nl> + findField ( classToAccess , remapName ( INameMappingService . Domain . FIELD , fieldName ) ) . set ( instance , value ) ; <nl> } <nl> catch ( UnableToFindFieldException e ) <nl> { <nl> @ @ - 166 , 7 + 148 , 7 @ @ public class ObfuscationReflectionHelper <nl> <nl> try <nl> { <nl> - Method m = clazz . getDeclaredMethod ( remapName ( methodName ) , parameterTypes ) ; <nl> + Method m = clazz . getDeclaredMethod ( remapName ( INameMappingService . Domain . METHOD , methodName ) , parameterTypes ) ; <nl> m . setAccessible ( true ) ; <nl> return m ; <nl> } <nl> @ @ - 229 , 38 + 211 , 6 @ @ public class ObfuscationReflectionHelper <nl> } <nl> } <nl> <nl> - private static void loadMappings ( ) <nl> - { <nl> - if ( loaded ) <nl> - return ; <nl> - <nl> - synchronized ( map ) / / Just in case ? <nl> - { <nl> - if ( loaded ) / / Incase something else loaded while we were here , jump out <nl> - return ; <nl> - for ( String file : new String [ ] { " fields . csv " , " methods . csv " } ) <nl> - { <nl> - URL path = ClassLoader . getSystemResource ( file ) ; / / We EXPLICITLY go throught the SystemClassLoader here because this is dev - time only . And will be on the root classpath . <nl> - if ( path = = null ) <nl> - continue ; <nl> - <nl> - int count = map . size ( ) ; <nl> - LOGGER . info ( REFLECTION , " Loading Mappings : { } " , path ) ; <nl> - try ( BufferedReader reader = new BufferedReader ( new InputStreamReader ( path . openStream ( ) ) ) ) <nl> - { <nl> - reader . lines ( ) . skip ( 1 ) . map ( e - > e . split ( " , " ) ) . forEach ( e - > map . put ( e [ 0 ] , e [ 1 ] ) ) ; <nl> - } <nl> - catch ( IOException e1 ) <nl> - { <nl> - LOGGER . error ( REFLECTION , " Error reading mappings " , e1 ) ; <nl> - } <nl> - LOGGER . info ( REFLECTION , " Loaded { } entries " , map . size ( ) - count ) ; <nl> - } <nl> - loaded = true ; <nl> - } <nl> - } <nl> - <nl> - / / Add SRG names to these exception ? <nl> public static class UnableToAccessFieldException extends RuntimeException <nl> { <nl> private UnableToAccessFieldException ( Exception e ) <nl> diff - - git a / src / userdev / java / net / minecraftforge / userdev / FMLDevClientLaunchProvider . java b / src / userdev / java / net / minecraftforge / userdev / FMLDevClientLaunchProvider . java <nl> index a464970 . . a2770d5 100644 <nl> - - - a / src / userdev / java / net / minecraftforge / userdev / FMLDevClientLaunchProvider . java <nl> + + + b / src / userdev / java / net / minecraftforge / userdev / FMLDevClientLaunchProvider . java <nl> @ @ - 107 , 4 + 107 , 10 @ @ public class FMLDevClientLaunchProvider extends FMLCommonLaunchHandler implement <nl> @ Override <nl> protected void validatePaths ( final Path forgePath , final Path [ ] mcPaths , final String forgeVersion , final String mcVersion , final String mcpVersion ) { <nl> } <nl> + <nl> + @ Override <nl> + protected String getNaming ( ) { <nl> + return " mcp " ; <nl> + } <nl> + <nl> } <nl> diff - - git a / src / userdev / java / net / minecraftforge / userdev / FMLDevServerLaunchProvider . java b / src / userdev / java / net / minecraftforge / userdev / FMLDevServerLaunchProvider . java <nl> index 73b082c . . 917d379 100644 <nl> - - - a / src / userdev / java / net / minecraftforge / userdev / FMLDevServerLaunchProvider . java <nl> + + + b / src / userdev / java / net / minecraftforge / userdev / FMLDevServerLaunchProvider . java <nl> @ @ - 92 , 4 + 92 , 10 @ @ public class FMLDevServerLaunchProvider extends FMLCommonLaunchHandler implement <nl> { <nl> return Dist . DEDICATED _ SERVER ; <nl> } <nl> + <nl> + @ Override <nl> + protected String getNaming ( ) { <nl> + return " srg " ; <nl> + } <nl> + <nl> } <nl> diff - - git a / src / userdev / java / net / minecraftforge / userdev / FMLUserdevLaunchProvider . java b / src / userdev / java / net / minecraftforge / userdev / FMLUserdevLaunchProvider . java <nl> index 37b3f21 . . 093f45b 100644 <nl> - - - a / src / userdev / java / net / minecraftforge / userdev / FMLUserdevLaunchProvider . java <nl> + + + b / src / userdev / java / net / minecraftforge / userdev / FMLUserdevLaunchProvider . java <nl> @ @ - 89 , 4 + 89 , 10 @ @ public abstract class FMLUserdevLaunchProvider extends FMLCommonLaunchHandler { <nl> mcJars = LibraryFinder . findJarPathFor ( " en _ us . json " , " mcdata " , mcDataPath ) ; <nl> return new Path [ ] { mcJars } ; <nl> } <nl> + <nl> + @ Override <nl> + protected String getNaming ( ) { <nl> + return " mcp " ; <nl> + } <nl> + <nl> } <nl> diff - - git a / src / userdev / java / net / minecraftforge / userdev / MCPNamingService . java b / src / userdev / java / net / minecraftforge / userdev / MCPNamingService . java <nl> new file mode 100644 <nl> index 0000000 . . 562ff58 <nl> - - - / dev / null <nl> + + + b / src / userdev / java / net / minecraftforge / userdev / MCPNamingService . java <nl> @ @ - 0 , 0 + 1 , 111 @ @ <nl> + / * <nl> + * Minecraft Forge <nl> + * Copyright ( c ) 2016 - 2019 . <nl> + * <nl> + * This library is free software ; you can redistribute it and / or <nl> + * modify it under the terms of the GNU Lesser General Public <nl> + * License as published by the Free Software Foundation version 2 . 1 <nl> + * of the License . <nl> + * <nl> + * This library is distributed in the hope that it will be useful , <nl> + * but WITHOUT ANY WARRANTY ; without even the implied warranty of <nl> + * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE . See the GNU <nl> + * Lesser General Public License for more details . <nl> + * <nl> + * You should have received a copy of the GNU Lesser General Public <nl> + * License along with this library ; if not , write to the Free Software <nl> + * Foundation , Inc . , 51 Franklin Street , Fifth Floor , Boston , MA 02110 - 1301 USA <nl> + * / <nl> + <nl> + package net . minecraftforge . userdev ; <nl> + <nl> + import cpw . mods . modlauncher . api . INameMappingService ; <nl> + import org . apache . commons . lang3 . tuple . Pair ; <nl> + import org . apache . logging . log4j . LogManager ; <nl> + import org . apache . logging . log4j . Logger ; <nl> + <nl> + import java . io . BufferedReader ; <nl> + import java . io . IOException ; <nl> + import java . io . InputStreamReader ; <nl> + import java . net . URL ; <nl> + import java . util . HashMap ; <nl> + import java . util . Map ; <nl> + import java . util . function . BiConsumer ; <nl> + import java . util . function . BiFunction ; <nl> + <nl> + import static net . minecraftforge . fml . loading . LogMarkers . CORE ; <nl> + <nl> + public class MCPNamingService implements INameMappingService { <nl> + private static final Logger LOGGER = LogManager . getLogger ( ) ; <nl> + private HashMap < String , String > methods ; <nl> + private HashMap < String , String > fields ; <nl> + <nl> + @ Override <nl> + public String mappingName ( ) { <nl> + return " srgtomcp " ; <nl> + } <nl> + <nl> + @ Override <nl> + public String mappingVersion ( ) { <nl> + return " 1234 " ; <nl> + } <nl> + <nl> + @ Override <nl> + public Map . Entry < String , String > understanding ( ) { <nl> + return Pair . of ( " srg " , " mcp " ) ; <nl> + } <nl> + <nl> + @ Override <nl> + public BiFunction < Domain , String , String > namingFunction ( ) { <nl> + return this : : findMapping ; <nl> + } <nl> + <nl> + private String findMapping ( final Domain domain , final String srgName ) { <nl> + switch ( domain ) { <nl> + case CLASS : <nl> + return srgName ; <nl> + case FIELD : <nl> + return findFieldMapping ( srgName ) ; <nl> + case METHOD : <nl> + return findMethodMapping ( srgName ) ; <nl> + } <nl> + return srgName ; <nl> + } <nl> + <nl> + private String findMethodMapping ( final String origin ) { <nl> + if ( methods = = null ) { <nl> + HashMap < String , String > tmpmethods = new HashMap < > ( 1000 ) ; <nl> + loadMappings ( " methods . csv " , tmpmethods : : put ) ; <nl> + methods = tmpmethods ; <nl> + LOGGER . debug ( CORE , " Loaded { } method mappings from methods . csv " , methods . size ( ) ) ; <nl> + } <nl> + return methods . getOrDefault ( origin , origin ) ; <nl> + } <nl> + <nl> + private String findFieldMapping ( final String origin ) { <nl> + if ( fields = = null ) { <nl> + HashMap < String , String > tmpfields = new HashMap < > ( 1000 ) ; <nl> + loadMappings ( " fields . csv " , tmpfields : : put ) ; <nl> + fields = tmpfields ; <nl> + LOGGER . debug ( CORE , " Loaded { } field mappings from fields . csv " , fields . size ( ) ) ; <nl> + } <nl> + return fields . getOrDefault ( origin , origin ) ; <nl> + } <nl> + <nl> + <nl> + private static void loadMappings ( final String mappingFileName , BiConsumer < String , String > mapStore ) <nl> + { <nl> + URL path = ClassLoader . getSystemResource ( mappingFileName ) ; / / We EXPLICITLY go throught the SystemClassLoader here because this is dev - time only . And will be on the root classpath . <nl> + if ( path = = null ) <nl> + return ; <nl> + <nl> + try ( BufferedReader reader = new BufferedReader ( new InputStreamReader ( path . openStream ( ) ) ) ) <nl> + { <nl> + reader . lines ( ) . skip ( 1 ) . map ( e - > e . split ( " , " ) ) . forEach ( e - > mapStore . accept ( e [ 0 ] , e [ 1 ] ) ) ; <nl> + } <nl> + catch ( IOException e1 ) <nl> + { <nl> + LOGGER . error ( CORE , " Error reading mappings " , e1 ) ; <nl> + } <nl> + } <nl> + } <nl> diff - - git a / src / userdev / resources / META - INF / services / cpw . mods . modlauncher . api . INameMappingService b / src / userdev / resources / META - INF / services / cpw . mods . modlauncher . api . INameMappingService <nl> new file mode 100644 <nl> index 0000000 . . 2c3e934 <nl> - - - / dev / null <nl> + + + b / src / userdev / resources / META - INF / services / cpw . mods . modlauncher . api . INameMappingService <nl> @ @ - 0 , 0 + 1 @ @ <nl> + net . minecraftforge . userdev . MCPNamingService <nl> \ No newline at end of file
NEAREST DIFF (one line): diff - - git a / src / main / java / net / minecraftforge / fml / LaunchTesting . java b / src / main / java / net / minecraftforge / fml / LaunchTesting . java <nl> index c34b865 . . 020c5e7 100644 <nl> - - - a / src / main / java / net / minecraftforge / fml / LaunchTesting . java <nl> + + + b / src / main / java / net / minecraftforge / fml / LaunchTesting . java <nl> @ @ - 25 , 9 + 25 , 10 @ @ import org . apache . logging . log4j . core . config . Configurator ; <nl> <nl> public class LaunchTesting <nl> { <nl> - public static void main ( String . . . args ) <nl> + public static void main ( String . . . args ) throws InterruptedException <nl> { <nl> Configurator . setRootLevel ( Level . DEBUG ) ; <nl> Launcher . main ( " - - launchTarget " , " fml " , " - - gameDir " , " projects / run " ) ; <nl> + Thread . sleep ( 10000 ) ; <nl> } <nl> } <nl> diff - - git a / src / main / java / net / minecraftforge / fml / loading / FMLJavaModLanguageProvider . java b / src / main / java / net / minecraftforge / fml / loading / FMLJavaModLanguageProvider . java <nl> new file mode 100644 <nl> index 0000000 . . fe23461 <nl> - - - / dev / null <nl> + + + b / src / main / java / net / minecraftforge / fml / loading / FMLJavaModLanguageProvider . java <nl> @ @ - 0 , 0 + 1 , 86 @ @ <nl> + / * <nl> + * Minecraft Forge <nl> + * Copyright ( c ) 2018 . <nl> + * <nl> + * This library is free software ; you can redistribute it and / or <nl> + * modify it under the terms of the GNU Lesser General Public <nl> + * License as published by the Free Software Foundation version 2 . 1 <nl> + * of the License . <nl> + * <nl> + * This library is distributed in the hope that it will be useful , <nl> + * but WITHOUT ANY WARRANTY ; without even the implied warranty of <nl> + * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE . See the GNU <nl> + * Lesser General Public License for more details . <nl> + * <nl> + * You should have received a copy of the GNU Lesser General Public <nl> + * License along with this library ; if not , write to the Free Software <nl> + * Foundation , Inc . , 51 Franklin Street , Fifth Floor , Boston , MA 02110 - 1301 USA <nl> + * / <nl> + <nl> + package net . minecraftforge . fml . loading ; <nl> + <nl> + import net . minecraftforge . fml . common . ModContainer ; <nl> + import net . minecraftforge . fml . loading . moddiscovery . ModFile ; <nl> + import net . minecraftforge . fml . loading . moddiscovery . ModInfo ; <nl> + import net . minecraftforge . fml . loading . moddiscovery . ScanResult ; <nl> + import org . objectweb . asm . Type ; <nl> + <nl> + import java . util . List ; <nl> + import java . util . Map ; <nl> + import java . util . function . Consumer ; <nl> + import java . util . function . Function ; <nl> + import java . util . stream . Collectors ; <nl> + <nl> + import static net . minecraftforge . fml . Logging . SCAN ; <nl> + import static net . minecraftforge . fml . Logging . fmlLog ; <nl> + <nl> + public class FMLJavaModLanguageProvider implements IModLanguageProvider <nl> + { <nl> + private static class FMLModTarget implements IModLanguageProvider . IModLanguageLoader { <nl> + private final String className ; <nl> + private final String modId ; <nl> + <nl> + private FMLModTarget ( String className , String modId ) <nl> + { <nl> + this . className = className ; <nl> + this . modId = modId ; <nl> + } <nl> + <nl> + public String getModId ( ) <nl> + { <nl> + return modId ; <nl> + } <nl> + <nl> + @ Override <nl> + public ModContainer loadMod ( ModFile file , ClassLoader modClassLoader ) <nl> + { <nl> + return null ; <nl> + } <nl> + } <nl> + <nl> + public static final Type MODANNOTATION = Type . getType ( " Lnet / minecraftforge / fml / common / Mod ; " ) ; <nl> + <nl> + @ Override <nl> + public String name ( ) <nl> + { <nl> + return " javafml " ; <nl> + } <nl> + <nl> + @ Override <nl> + public Consumer < ScanResult > getFileVisitor ( ) { <nl> + return scanResult - > { <nl> + final Map < String , FMLModTarget > modTargetMap = scanResult . getAnnotations ( ) . stream ( ) <nl> + . filter ( ad - > ad . getAnnotationType ( ) . equals ( MODANNOTATION ) ) <nl> + . peek ( ad - > fmlLog . debug ( SCAN , " Found @ Mod class { } with id { } " , ad . getClassType ( ) . getClassName ( ) , ad . getAnnotationData ( ) . get ( " modid " ) ) ) <nl> + . map ( ad - > new FMLModTarget ( ad . getClassType ( ) . getClassName ( ) , ( String ) ad . getAnnotationData ( ) . get ( " modid " ) ) ) <nl> + . collect ( Collectors . toMap ( FMLModTarget : : getModId , Function . identity ( ) ) ) ; <nl> + modTargetMap . forEach ( ( key , value ) - > scanResult . getFile ( ) . claimLanguage ( key , value ) ) ; <nl> + } ; <nl> + } <nl> + <nl> + @ Override <nl> + public List < ModContainer > buildModContainers ( List < ModInfo > modFiles , ClassLoader modClassLoader ) <nl> + { <nl> + return null ; <nl> + } <nl> + } <nl> diff - - git a / src / main / java / net / minecraftforge / fml / loading / FMLLoader . java b / src / main / java / net / minecraftforge / fml / loading / FMLLoader . java <nl> index 5aecb99 . . 0255021 100644 <nl> - - - a / src / main / java / net / minecraftforge / fml / loading / FMLLoader . java <nl> + + + b / src / main / java / net / minecraftforge / fml / loading / FMLLoader . java <nl> @ @ - 28 , 25 + 28 , 20 @ @ import net . minecraftforge . fml . loading . moddiscovery . ModDiscoverer ; <nl> import net . minecraftforge . forgespi . ICoreModProvider ; <nl> <nl> import java . util . ArrayList ; <nl> - import java . util . Arrays ; <nl> - import java . util . HashSet ; <nl> - import java . util . Iterator ; <nl> - import java . util . List ; <nl> import java . util . ServiceLoader ; <nl> import java . util . Set ; <nl> import java . util . stream . Collectors ; <nl> <nl> import static net . minecraftforge . fml . Logging . CORE ; <nl> - import static net . minecraftforge . fml . Logging . LOADING ; <nl> import static net . minecraftforge . fml . Logging . SCAN ; <nl> import static net . minecraftforge . fml . Logging . fmlLog ; <nl> <nl> public class FMLLoader <nl> { <nl> - <nl> private static ILaunchPluginService accessTransformer ; <nl> private static ModDiscoverer modDiscoverer ; <nl> - private static ICoreModProvider coreMod ; <nl> + private static ICoreModProvider coreModProvider ; <nl> + private static LanguageLoadingProvider languageLoadingProvider ; <nl> <nl> static void onInitialLoad ( IEnvironment environment , Set < String > otherServices ) throws IncompatibleEnvironmentException <nl> { <nl> @ @ - 79 , 9 + 74 , 11 @ @ public class FMLLoader <nl> throw new IncompatibleEnvironmentException ( " Multiple coremod libraries found " ) ; <nl> } <nl> <nl> - coreMod = coreModProviders . get ( 0 ) ; <nl> - final Package coremodPackage = coreMod . getClass ( ) . getPackage ( ) ; <nl> + coreModProvider = coreModProviders . get ( 0 ) ; <nl> + final Package coremodPackage = coreModProvider . getClass ( ) . getPackage ( ) ; <nl> fmlLog . debug ( CORE , " FML found CoreMod version : { } " , coremodPackage . getImplementationVersion ( ) ) ; <nl> + <nl> + languageLoadingProvider = new LanguageLoadingProvider ( ) ; <nl> } <nl> <nl> public static void load ( ) <nl> @ @ - 90 , 4 + 87 , 13 @ @ public class FMLLoader <nl> modDiscoverer = new ModDiscoverer ( ) ; <nl> modDiscoverer . discoverMods ( ) ; <nl> } <nl> + <nl> + public static ICoreModProvider getCoreModProvider ( ) { <nl> + return coreModProvider ; <nl> + } <nl> + <nl> + public static LanguageLoadingProvider getLanguageLoadingProvider ( ) <nl> + { <nl> + return languageLoadingProvider ; <nl> + } <nl> } <nl> diff - - git a / src / main / java / net / minecraftforge / fml / loading / FMLServiceProvider . java b / src / main / java / net / minecraftforge / fml / loading / FMLServiceProvider . java <nl> index 3ceec55 . . 0d1c070 100644 <nl> - - - a / src / main / java / net / minecraftforge / fml / loading / FMLServiceProvider . java <nl> + + + b / src / main / java / net / minecraftforge / fml / loading / FMLServiceProvider . java <nl> @ @ - 25 , 14 + 25 , 17 @ @ import cpw . mods . modlauncher . api . ITransformer ; <nl> import cpw . mods . modlauncher . api . IncompatibleEnvironmentException ; <nl> import joptsimple . ArgumentAcceptingOptionSpec ; <nl> import joptsimple . OptionSpecBuilder ; <nl> + import net . minecraftforge . coremod . CoreModEngine ; <nl> import net . minecraftforge . fml . FMLConfig ; <nl> import net . minecraftforge . fml . common . FMLPaths ; <nl> <nl> import javax . annotation . Nonnull ; <nl> + import java . util . ArrayList ; <nl> import java . util . Collections ; <nl> import java . util . List ; <nl> import java . util . Set ; <nl> import java . util . function . BiFunction ; <nl> + import java . util . stream . Collectors ; <nl> <nl> import static net . minecraftforge . fml . Logging . CORE ; <nl> import static net . minecraftforge . fml . Logging . fmlLog ; <nl> @ @ - 86 , 7 + 89 , 8 @ @ public class FMLServiceProvider implements ITransformationService <nl> @ Override <nl> public List < ITransformer > transformers ( ) <nl> { <nl> - return Collections . emptyList ( ) ; <nl> + fmlLog . debug ( CORE , " Loading coremod transformers " ) ; <nl> + return new ArrayList < > ( FMLLoader . getCoreModProvider ( ) . getCoreModTransformers ( ) ) ; <nl> } <nl> <nl> } <nl> diff - - git a / src / main / java / net / minecraftforge / fml / loading / IModLanguageProvider . java b / src / main / java / net / minecraftforge / fml / loading / IModLanguageProvider . java <nl> new file mode 100644 <nl> index 0000000 . . cceb903 <nl> - - - / dev / null <nl> + + + b / src / main / java / net / minecraftforge / fml / loading / IModLanguageProvider . java <nl> @ @ - 0 , 0 + 1 , 47 @ @ <nl> + / * <nl> + * Minecraft Forge <nl> + * Copyright ( c ) 2018 . <nl> + * <nl> + * This library is free software ; you can redistribute it and / or <nl> + * modify it under the terms of the GNU Lesser General Public <nl> + * License as published by the Free Software Foundation version 2 . 1 <nl> + * of the License . <nl> + * <nl> + * This library is distributed in the hope that it will be useful , <nl> + * but WITHOUT ANY WARRANTY ; without even the implied warranty of <nl> + * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE . See the GNU <nl> + * Lesser General Public License for more details . <nl> + * <nl> + * You should have received a copy of the GNU Lesser General Public <nl> + * License along with this library ; if not , write to the Free Software <nl> + * Foundation , Inc . , 51 Franklin Street , Fifth Floor , Boston , MA 02110 - 1301 USA <nl> + * / <nl> + <nl> + package net . minecraftforge . fml . loading ; <nl> + <nl> + import net . minecraftforge . fml . common . ModContainer ; <nl> + import net . minecraftforge . fml . loading . moddiscovery . ModFile ; <nl> + import net . minecraftforge . fml . loading . moddiscovery . ModInfo ; <nl> + import net . minecraftforge . fml . loading . moddiscovery . ScanResult ; <nl> + <nl> + import java . util . List ; <nl> + import java . util . function . Consumer ; <nl> + <nl> + / * * <nl> + * Loaded as a ServiceLoader , from the classpath . Extensions are loaded from <nl> + * the mods directory , with the FMLType META - INF of LANGPROVIDER . <nl> + * <nl> + * Version data is read from the manifest ' s implementation version . <nl> + * / <nl> + public interface IModLanguageProvider <nl> + { <nl> + String name ( ) ; <nl> + <nl> + Consumer < ScanResult > getFileVisitor ( ) ; <nl> + <nl> + interface IModLanguageLoader { <nl> + ModContainer loadMod ( ModFile file , ClassLoader modClassLoader ) ; <nl> + } <nl> + <nl> + List < ModContainer > buildModContainers ( List < ModInfo > modFiles , ClassLoader modClassLoader ) ; <nl> + } <nl> diff - - git a / src / main / java / net / minecraftforge / fml / loading / LanguageLoadingProvider . java b / src / main / java / net / minecraftforge / fml / loading / LanguageLoadingProvider . java <nl> new file mode 100644 <nl> index 0000000 . . 5b7c7f9 <nl> - - - / dev / null <nl> + + + b / src / main / java / net / minecraftforge / fml / loading / LanguageLoadingProvider . java <nl> @ @ - 0 , 0 + 1 , 64 @ @ <nl> + / * <nl> + * Minecraft Forge <nl> + * Copyright ( c ) 2018 . <nl> + * <nl> + * This library is free software ; you can redistribute it and / or <nl> + * modify it under the terms of the GNU Lesser General Public <nl> + * License as published by the Free Software Foundation version 2 . 1 <nl> + * of the License . <nl> + * <nl> + * This library is distributed in the hope that it will be useful , <nl> + * but WITHOUT ANY WARRANTY ; without even the implied warranty of <nl> + * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE . See the GNU <nl> + * Lesser General Public License for more details . <nl> + * <nl> + * You should have received a copy of the GNU Lesser General Public <nl> + * License along with this library ; if not , write to the Free Software <nl> + * Foundation , Inc . , 51 Franklin Street , Fifth Floor , Boston , MA 02110 - 1301 USA <nl> + * / <nl> + <nl> + package net . minecraftforge . fml . loading ; <nl> + <nl> + import net . minecraftforge . fml . loading . moddiscovery . ModFile ; <nl> + <nl> + import java . nio . file . Path ; <nl> + import java . util . ArrayList ; <nl> + import java . util . HashMap ; <nl> + import java . util . List ; <nl> + import java . util . Map ; <nl> + import java . util . ServiceLoader ; <nl> + import java . util . stream . Stream ; <nl> + <nl> + import static net . minecraftforge . fml . Logging . CORE ; <nl> + import static net . minecraftforge . fml . Logging . fmlLog ; <nl> + <nl> + public class LanguageLoadingProvider <nl> + { <nl> + private final List < IModLanguageProvider > languageProviders = new ArrayList < > ( ) ; <nl> + private final ServiceLoader < IModLanguageProvider > serviceLoader ; <nl> + private final Map < String , IModLanguageProvider > languageProviderMap = new HashMap < > ( ) ; <nl> + <nl> + LanguageLoadingProvider ( ) { <nl> + serviceLoader = ServiceLoader . load ( IModLanguageProvider . class ) ; <nl> + serviceLoader . forEach ( languageProviders : : add ) ; <nl> + <nl> + languageProviders . forEach ( lp - > { <nl> + final Package pkg = lp . getClass ( ) . getPackage ( ) ; <nl> + fmlLog . debug ( CORE , " Found system classpath language provider { } , version { } " , lp . name ( ) , pkg . getImplementationVersion ( ) ) ; <nl> + } ) ; <nl> + <nl> + languageProviders . forEach ( lp - > languageProviderMap . put ( lp . name ( ) , lp ) ) ; <nl> + } <nl> + <nl> + public void addAdditionalLanguages ( List < ModFile > modFiles ) <nl> + { <nl> + if ( modFiles = = null ) return ; <nl> + Stream < Path > langPaths = modFiles . stream ( ) . map ( ModFile : : getFilePath ) ; <nl> + serviceLoader . reload ( ) ; <nl> + } <nl> + <nl> + public IModLanguageProvider getLanguage ( String name ) <nl> + { <nl> + return languageProviderMap . get ( name ) ; <nl> + } <nl> + } <nl> diff - - git a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / BackgroundScanHandler . java b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / BackgroundScanHandler . java <nl> index 93694a4 . . 42a754f 100644 <nl> - - - a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / BackgroundScanHandler . java <nl> + + + b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / BackgroundScanHandler . java <nl> @ @ - 19 , 11 + 19 , 14 @ @ <nl> <nl> package net . minecraftforge . fml . loading . moddiscovery ; <nl> <nl> + import com . google . common . util . concurrent . MoreExecutors ; <nl> + <nl> import java . util . ArrayList ; <nl> import java . util . List ; <nl> import java . util . concurrent . CompletableFuture ; <nl> import java . util . concurrent . ExecutorService ; <nl> import java . util . concurrent . Executors ; <nl> + import java . util . concurrent . ThreadFactory ; <nl> import java . util . concurrent . TimeUnit ; <nl> <nl> import static net . minecraftforge . fml . Logging . SCAN ; <nl> @ @ - 37 , 7 + 40 , 11 @ @ public class BackgroundScanHandler <nl> private final List < ModFile > allFiles ; <nl> <nl> public BackgroundScanHandler ( ) { <nl> - modContentScanner = Executors . newCachedThreadPool ( ) ; <nl> + modContentScanner = Executors . newSingleThreadExecutor ( r - > { <nl> + final Thread thread = Executors . defaultThreadFactory ( ) . newThread ( r ) ; <nl> + thread . setDaemon ( true ) ; <nl> + return thread ; <nl> + } ) ; <nl> scannedFiles = new ArrayList < > ( ) ; <nl> pendingFiles = new ArrayList < > ( ) ; <nl> allFiles = new ArrayList < > ( ) ; <nl> diff - - git a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModDiscoverer . java b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModDiscoverer . java <nl> index 27dc4f0 . . de71a15 100644 <nl> - - - a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModDiscoverer . java <nl> + + + b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModDiscoverer . java <nl> @ @ - 20 , 6 + 20 , 8 @ @ <nl> package net . minecraftforge . fml . loading . moddiscovery ; <nl> <nl> import cpw . mods . modlauncher . ServiceLoaderStreamUtils ; <nl> + import net . minecraftforge . fml . loading . FMLLoader ; <nl> + import net . minecraftforge . fml . loading . LanguageLoadingProvider ; <nl> <nl> import java . util . Collection ; <nl> import java . util . List ; <nl> @ @ - 54 , 12 + 56 , 12 @ @ public class ModDiscoverer { <nl> . peek ( mf - > fmlLog . debug ( SCAN , " Found mod file { } of type { } with locator { } " , mf . getFileName ( ) , mf . getType ( ) , mf . getLocator ( ) ) ) <nl> . collect ( Collectors . groupingBy ( ModFile : : getType ) ) ; <nl> <nl> - / / ModLanguageProvider . loadAdditionalLanguages ( modFiles . get ( ModFile . Type . LANGPROVIDER ) ) ; <nl> + FMLLoader . getLanguageLoadingProvider ( ) . addAdditionalLanguages ( modFiles . get ( ModFile . Type . LANGPROVIDER ) ) ; <nl> BackgroundScanHandler backgroundScanHandler = new BackgroundScanHandler ( ) ; <nl> final List < ModFile > mods = modFiles . get ( ModFile . Type . MOD ) ; <nl> mods . forEach ( ModFile : : identifyMods ) ; <nl> fmlLog . debug ( SCAN , " Found { } mod files with { } mods " , mods : : size , ( ) - > mods . stream ( ) . mapToInt ( mf - > mf . getModInfos ( ) . size ( ) ) . sum ( ) ) ; <nl> - / / mods . stream ( ) . map ( ModFile : : getCoreMods ) . flatMap ( List : : stream ) . forEach ( ServiceProviders . getCoreModProvider ( ) : : addCoreMod ) ; <nl> + mods . stream ( ) . map ( ModFile : : getCoreMods ) . flatMap ( List : : stream ) . forEach ( FMLLoader . getCoreModProvider ( ) : : addCoreMod ) ; <nl> mods . forEach ( backgroundScanHandler : : submitForScanning ) ; <nl> return backgroundScanHandler ; <nl> } <nl> diff - - git a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModFile . java b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModFile . java <nl> index 8733035 . . 8f57bae 100644 <nl> - - - a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModFile . java <nl> + + + b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModFile . java <nl> @ @ - 19 , 14 + 19 , 21 @ @ <nl> <nl> package net . minecraftforge . fml . loading . moddiscovery ; <nl> <nl> + import net . minecraftforge . fml . loading . IModLanguageProvider ; <nl> + <nl> + import javax . swing . text . html . Option ; <nl> import java . nio . file . Path ; <nl> import java . util . List ; <nl> + import java . util . Map ; <nl> import java . util . Objects ; <nl> + import java . util . Optional ; <nl> import java . util . concurrent . CompletableFuture ; <nl> import java . util . concurrent . ExecutionException ; <nl> import java . util . function . Consumer ; <nl> + import java . util . function . Function ; <nl> import java . util . jar . Attributes ; <nl> import java . util . jar . Manifest ; <nl> + import java . util . stream . Collectors ; <nl> <nl> import static net . minecraftforge . fml . Logging . LOADING ; <nl> import static net . minecraftforge . fml . Logging . SCAN ; <nl> @ @ - 40 , 6 + 47 , 11 @ @ public class ModFile <nl> DEFAULTMANIFEST . getMainAttributes ( ) . putValue ( " FMLModType " , " MOD " ) ; <nl> } <nl> <nl> + public void claimLanguage ( String modId , IModLanguageProvider . IModLanguageLoader loader ) <nl> + { <nl> + this . modInfoMap . get ( modId ) . setLoader ( loader ) ; <nl> + } <nl> + <nl> public enum Type { <nl> MOD , LIBRARY , LANGPROVIDER <nl> } <nl> @ @ - 47 , 6 + 59 , 7 @ @ public class ModFile <nl> private final Type modFileType ; <nl> private final Manifest manifest ; <nl> private List < ModInfo > modInfos ; <nl> + private Map < String , ModInfo > modInfoMap ; <nl> private final IModLocator locator ; <nl> private ScanResult fileScanResult ; <nl> private CompletableFuture < ScanResult > futureScanResult ; <nl> @ @ - 60 , 7 + 73 , 8 @ @ public class ModFile <nl> manifest = locator . findManifest ( file ) . orElse ( DEFAULTMANIFEST ) ; <nl> if ( manifest ! = DEFAULTMANIFEST ) fmlLog . debug ( SCAN , " Mod file { } has a manifest " , file ) ; <nl> else fmlLog . debug ( SCAN , " Mod file { } is missing a manifest " , file ) ; <nl> - modFileType = Type . valueOf ( manifest . getMainAttributes ( ) . getValue ( TYPE ) ) ; <nl> + final Optional < String > value = Optional . ofNullable ( manifest . getMainAttributes ( ) . getValue ( TYPE ) ) ; <nl> + modFileType = Type . valueOf ( value . orElse ( " MOD " ) ) ; <nl> } <nl> <nl> public Type getType ( ) { <nl> @ @ - 78 , 6 + 92 , 7 @ @ public class ModFile <nl> public void identifyMods ( ) { <nl> this . modInfos = ModFileParser . readModList ( this ) ; <nl> this . modInfos . forEach ( mi - > fmlLog . debug ( LOADING , " Found mod { } for language { } " , mi . getModId ( ) , mi . getModLoader ( ) ) ) ; <nl> + this . modInfoMap = this . modInfos . stream ( ) . collect ( Collectors . toMap ( ModInfo : : getModId , Function . identity ( ) ) ) ; <nl> this . coreMods = ModFileParser . getCoreMods ( this ) ; <nl> this . coreMods . forEach ( mi - > fmlLog . debug ( LOADING , " Found coremod { } " , mi . getPath ( ) ) ) ; <nl> } <nl> diff - - git a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModInfo . java b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModInfo . java <nl> index 2a3c1de . . 7910600 100644 <nl> - - - a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModInfo . java <nl> + + + b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModInfo . java <nl> @ @ - 20 , 6 + 20 , 10 @ @ <nl> package net . minecraftforge . fml . loading . moddiscovery ; <nl> <nl> import net . minecraftforge . fml . common . versioning . ArtifactVersion ; <nl> + import net . minecraftforge . fml . loading . IModLanguageProvider ; <nl> + <nl> + import java . net . URL ; <nl> + import java . util . List ; <nl> <nl> public class ModInfo { <nl> private final ModFile owningFile ; <nl> @ @ - 27 , 11 + 31 , 12 @ @ public class ModInfo { <nl> private final ArtifactVersion version ; <nl> private final String displayName ; <nl> private final String description ; <nl> - private final java . net . URL updateJSONURL ; <nl> + private final URL updateJSONURL ; <nl> private final String modLoader ; <nl> - private final java . util . List < net . minecraftforge . fml . loading . moddiscovery . ModInfo . ModVersion > dependencies ; <nl> + private final List < ModInfo . ModVersion > dependencies ; <nl> + private IModLanguageProvider . IModLanguageLoader loader ; <nl> <nl> - public ModInfo ( final ModFile owningFile , final String modLoader , final String modId , final String displayName , final ArtifactVersion version , final String description , final java . net . URL updateJSONURL , final java . util . List < net . minecraftforge . fml . loading . moddiscovery . ModInfo . ModVersion > dependencies ) { <nl> + public ModInfo ( final ModFile owningFile , final String modLoader , final String modId , final String displayName , final ArtifactVersion version , final String description , final URL updateJSONURL , final List < ModInfo . ModVersion > dependencies ) { <nl> this . owningFile = owningFile ; <nl> this . modLoader = modLoader ; <nl> this . modId = modId ; <nl> @ @ - 58 , 6 + 63 , 11 @ @ public class ModInfo { <nl> return version ; <nl> } <nl> <nl> + public void setLoader ( IModLanguageProvider . IModLanguageLoader loader ) <nl> + { <nl> + this . loader = loader ; <nl> + } <nl> + <nl> public enum Ordering { <nl> BEFORE , AFTER , NONE ; <nl> } <nl> diff - - git a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ScanResult . java b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ScanResult . java <nl> index f35f626 . . cd75eaa 100644 <nl> - - - a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ScanResult . java <nl> + + + b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ScanResult . java <nl> @ @ - 22 , 27 + 22 , 33 @ @ package net . minecraftforge . fml . loading . moddiscovery ; <nl> <nl> import org . objectweb . asm . Type ; <nl> <nl> + import java . util . ArrayList ; <nl> + import java . util . List ; <nl> import java . util . Map ; <nl> import java . util . Set ; <nl> <nl> public class ScanResult { <nl> private final ModFile file ; <nl> - private final java . util . List < net . minecraftforge . fml . loading . moddiscovery . ScanResult . AnnotationData > annotations = new java . util . ArrayList < > ( ) ; <nl> - private final java . util . List < net . minecraftforge . fml . loading . moddiscovery . ScanResult . ClassData > classes = new java . util . ArrayList < > ( ) ; <nl> + private final List < ScanResult . AnnotationData > annotations = new ArrayList < > ( ) ; <nl> + private final List < ScanResult . ClassData > classes = new ArrayList < > ( ) ; <nl> <nl> public ScanResult ( final ModFile file ) { <nl> this . file = file ; <nl> } <nl> <nl> + public ModFile getFile ( ) { <nl> + return file ; <nl> + } <nl> + <nl> public static boolean interestingAnnotations ( final ModAnnotation annotation ) { <nl> return true ; <nl> } <nl> <nl> - public java . util . List < net . minecraftforge . fml . loading . moddiscovery . ScanResult . ClassData > getClasses ( ) { <nl> + public List < ScanResult . ClassData > getClasses ( ) { <nl> return classes ; <nl> } <nl> <nl> - public java . util . List < net . minecraftforge . fml . loading . moddiscovery . ScanResult . AnnotationData > getAnnotations ( ) { <nl> + public List < ScanResult . AnnotationData > getAnnotations ( ) { <nl> return annotations ; <nl> } <nl> <nl> diff - - git a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / Scanner . java b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / Scanner . java <nl> index 0770426 . . 92fdab3 100644 <nl> - - - a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / Scanner . java <nl> + + + b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / Scanner . java <nl> @ @ - 19 , 8 + 19 , 19 @ @ <nl> <nl> package net . minecraftforge . fml . loading . moddiscovery ; <nl> <nl> + import net . minecraftforge . fml . loading . FMLLoader ; <nl> + import net . minecraftforge . fml . loading . IModLanguageProvider ; <nl> + import net . minecraftforge . fml . loading . LanguageLoadingProvider ; <nl> import org . objectweb . asm . ClassReader ; <nl> <nl> + import java . io . IOException ; <nl> + import java . nio . file . Files ; <nl> + import java . nio . file . Path ; <nl> + import java . util . Set ; <nl> + import java . util . function . Consumer ; <nl> + import java . util . stream . Collectors ; <nl> + <nl> + import static net . minecraftforge . fml . Logging . LOADING ; <nl> import static net . minecraftforge . fml . Logging . SCAN ; <nl> import static net . minecraftforge . fml . Logging . fmlLog ; <nl> <nl> @ @ - 34 , 17 + 45 , 20 @ @ public class Scanner { <nl> public ScanResult scan ( ) { <nl> ScanResult result = new ScanResult ( fileToScan ) ; <nl> fileToScan . scanFile ( p - > fileVisitor ( p , result ) ) ; <nl> + final Set < IModLanguageProvider > modLoaders = fileToScan . getModInfos ( ) . stream ( ) . map ( ModInfo : : getModLoader ) . map ( FMLLoader . getLanguageLoadingProvider ( ) : : getLanguage ) . collect ( Collectors . toSet ( ) ) ; <nl> + modLoaders . stream ( ) . peek ( ml - > fmlLog . debug ( SCAN , " Scanning { } with language loader { } " , fileToScan . getFilePath ( ) , ml . name ( ) ) ) <nl> + . map ( IModLanguageProvider : : getFileVisitor ) . forEach ( c - > c . accept ( result ) ) ; <nl> return result ; <nl> } <nl> <nl> - private void fileVisitor ( final java . nio . file . Path path , final ScanResult result ) { <nl> + private void fileVisitor ( final Path path , final ScanResult result ) { <nl> try { <nl> fmlLog . debug ( SCAN , " Scanning { } path { } " , fileToScan , path ) ; <nl> ModClassVisitor mcv = new ModClassVisitor ( ) ; <nl> - org . objectweb . asm . ClassReader cr = new ClassReader ( java . nio . file . Files . newInputStream ( path ) ) ; <nl> + ClassReader cr = new ClassReader ( Files . newInputStream ( path ) ) ; <nl> cr . accept ( mcv , 0 ) ; <nl> mcv . buildData ( result . getClasses ( ) , result . getAnnotations ( ) ) ; <nl> - } catch ( java . io . IOException e ) { <nl> + } catch ( IOException e ) { <nl> / / mark path bad <nl> } <nl> } <nl> diff - - git a / src / main / resources / META - INF / services / net . minecraftforge . fml . loading . IModLanguageProvider b / src / main / resources / META - INF / services / net . minecraftforge . fml . loading . IModLanguageProvider <nl> new file mode 100644 <nl> index 0000000 . . dc3f902 <nl> - - - / dev / null <nl> + + + b / src / main / resources / META - INF / services / net . minecraftforge . fml . loading . IModLanguageProvider <nl> @ @ - 0 , 0 + 1 @ @ <nl> + net . minecraftforge . fml . loading . FMLJavaModLanguageProvider <nl> \ No newline at end of file

TEST DIFF:
diff - - git a / build . gradle b / build . gradle 
 index 67827c0 . . 6a2c5cb 100644 
 - - - a / build . gradle 
 + + + b / build . gradle 
 @ @ - 288 , 8 + 288 , 8 @ @ project ( ' : forge ' ) { 
 installer ' org . ow2 . asm : asm : 6 . 2 ' 
 installer ' org . ow2 . asm : asm - commons : 6 . 2 ' 
 installer ' org . ow2 . asm : asm - tree : 6 . 2 ' 
 - installer ' cpw . mods : modlauncher : 0 . 12 . + ' 
 - installer ' net . minecraftforge : accesstransformers : 0 . 15 . + : shadowed ' 
 + installer ' cpw . mods : modlauncher : 1 . 0 . + ' 
 + installer ' net . minecraftforge : accesstransformers : 0 . 16 . + : shadowed ' 
 installer ' net . minecraftforge : eventbus : 0 . 8 . + : service ' 
 installer ' net . minecraftforge : forgespi : 0 . 11 . + ' 
 installer ' net . minecraftforge : coremods : 0 . 4 . + ' 
 diff - - git a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLClientLaunchProvider . java b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLClientLaunchProvider . java 
 index f5af1b0 . . 4eead08 100644 
 - - - a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLClientLaunchProvider . java 
 + + + b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLClientLaunchProvider . java 
 @ @ - 80 , 4 + 80 , 9 @ @ public class FMLClientLaunchProvider extends FMLCommonLaunchHandler implements I 
 { 
 return Dist . CLIENT ; 
 } 
 + 
 + @ Override 
 + protected String getNaming ( ) { 
 + return " srg " ; 
 + } 
 } 
 diff - - git a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLCommonLaunchHandler . java b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLCommonLaunchHandler . java 
 index 0fb188a . . 86371ee 100644 
 - - - a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLCommonLaunchHandler . java 
 + + + b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLCommonLaunchHandler . java 
 @ @ - 135 , 4 + 135 , 6 @ @ public abstract class FMLCommonLaunchHandler 
 return Optional . empty ( ) ; 
 } ; 
 } 
 + 
 + protected abstract String getNaming ( ) ; 
 } 
 diff - - git a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLEnvironment . java b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLEnvironment . java 
 index 8df96ef . . f1471b3 100644 
 - - - a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLEnvironment . java 
 + + + b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLEnvironment . java 
 @ @ - 26 , 8 + 26 , 10 @ @ import net . minecraftforge . forgespi . Environment ; 
 public class FMLEnvironment 
 { 
 public static final Dist dist = FMLLoader . getDist ( ) ; 
 + public static final String naming = FMLLoader . getNaming ( ) ; 
 
 static void setupInteropEnvironment ( IEnvironment environment ) { 
 + environment . computePropertyIfAbsent ( IEnvironment . Keys . NAMING . get ( ) , v - > naming ) ; 
 environment . computePropertyIfAbsent ( Environment . Keys . DIST . get ( ) , v - > dist ) ; 
 } 
 } 
 diff - - git a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLLoader . java b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLLoader . java 
 index c32e91c . . ff39c52 100644 
 - - - a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLLoader . java 
 + + + b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLLoader . java 
 @ @ - 19 , 27 + 19 , 35 @ @ 
 
 package net . minecraftforge . fml . loading ; 
 
 + import cpw . mods . modlauncher . Launcher ; 
 import cpw . mods . modlauncher . ServiceLoaderStreamUtils ; 
 import cpw . mods . modlauncher . TransformingClassLoader ; 
 import cpw . mods . modlauncher . api . IEnvironment ; 
 import cpw . mods . modlauncher . api . ILaunchHandlerService ; 
 + import cpw . mods . modlauncher . api . INameMappingService ; 
 import cpw . mods . modlauncher . api . ITransformationService ; 
 import cpw . mods . modlauncher . api . ITransformingClassLoader ; 
 import cpw . mods . modlauncher . api . IncompatibleEnvironmentException ; 
 import cpw . mods . modlauncher . serviceapi . ILaunchPluginService ; 
 + import net . minecraftforge . accesstransformer . service . AccessTransformerService ; 
 import net . minecraftforge . api . distmarker . Dist ; 
 import net . minecraftforge . fml . loading . moddiscovery . BackgroundScanHandler ; 
 import net . minecraftforge . fml . loading . moddiscovery . ModDiscoverer ; 
 import net . minecraftforge . fml . loading . moddiscovery . ModFile ; 
 import net . minecraftforge . forgespi . Environment ; 
 import net . minecraftforge . forgespi . coremod . ICoreModProvider ; 
 + import org . apache . commons . lang3 . tuple . Pair ; 
 import org . apache . logging . log4j . LogManager ; 
 import org . apache . logging . log4j . Logger ; 
 
 import java . net . URL ; 
 import java . nio . file . Path ; 
 import java . nio . file . Paths ; 
 - import java . util . * ; 
 + import java . util . ArrayList ; 
 + import java . util . Map ; 
 + import java . util . Optional ; 
 + import java . util . Set ; 
 + import java . util . function . BiFunction ; 
 import java . util . function . Predicate ; 
 import java . util . stream . Collectors ; 
 
 @ @ - 49 , 12 + 57 , 13 @ @ import static net . minecraftforge . fml . loading . LogMarkers . SCAN ; 
 public class FMLLoader 
 { 
 private static final Logger LOGGER = LogManager . getLogger ( ) ; 
 - private static ILaunchPluginService accessTransformer ; 
 + private static AccessTransformerService accessTransformer ; 
 private static ModDiscoverer modDiscoverer ; 
 private static ICoreModProvider coreModProvider ; 
 private static ILaunchPluginService eventBus ; 
 private static LanguageLoadingProvider languageLoadingProvider ; 
 private static Dist dist ; 
 + private static String naming ; 
 private static LoadingModList loadingModList ; 
 private static TransformingClassLoader launchClassLoader ; 
 private static RuntimeDistCleaner runtimeDistCleaner ; 
 @ @ - 73 , 14 + 82 , 14 @ @ public class FMLLoader 
 LOGGER . debug ( CORE , " FML { } loading " , version ) ; 
 final Package modLauncherPackage = ITransformationService . class . getPackage ( ) ; 
 LOGGER . debug ( CORE , " FML found ModLauncher version : { } " , modLauncherPackage . getImplementationVersion ( ) ) ; 
 - if ( ! modLauncherPackage . isCompatibleWith ( " 1 . 0 " ) ) { 
 + if ( ! modLauncherPackage . isCompatibleWith ( " 2 . 0 " ) ) { 
 LOGGER . fatal ( CORE , " Found incompatible ModLauncher specification : { } , version { } from { } " , modLauncherPackage . getSpecificationVersion ( ) , modLauncherPackage . getImplementationVersion ( ) , modLauncherPackage . getImplementationVendor ( ) ) ; 
 throw new IncompatibleEnvironmentException ( " Incompatible modlauncher found " + modLauncherPackage . getSpecificationVersion ( ) ) ; 
 } 
 LOGGER . debug ( CORE , " Initializing modjar URL handler " ) ; 
 URL . setURLStreamHandlerFactory ( p - > p . equals ( " modjar " ) ? new ModJarURLHandler ( ) : null ) ; 
 
 - accessTransformer = environment . findLaunchPlugin ( " accesstransformer " ) . orElseThrow ( ( ) - > { 
 + accessTransformer = ( AccessTransformerService ) environment . findLaunchPlugin ( " accesstransformer " ) . orElseThrow ( ( ) - > { 
 LOGGER . fatal ( CORE , " Access Transformer library is missing , we need this to run " ) ; 
 return new IncompatibleEnvironmentException ( " Missing AccessTransformer , cannot run " ) ; 
 } ) ; 
 @ @ - 160 , 7 + 169 , 9 @ @ public class FMLLoader 
 gamePath = environment . getProperty ( IEnvironment . Keys . GAMEDIR . get ( ) ) . orElse ( Paths . get ( " . " ) . toAbsolutePath ( ) ) ; 
 
 FMLCommonLaunchHandler commonLaunchHandler = ( FMLCommonLaunchHandler ) launchHandler . get ( ) ; 
 + naming = commonLaunchHandler . getNaming ( ) ; 
 dist = commonLaunchHandler . getDist ( ) ; 
 + accessTransformer . getExtension ( ) . accept ( Pair . of ( naming , " srg " ) ) ; 
 
 mcVersion = ( String ) arguments . get ( " mcVersion " ) ; 
 mcpVersion = ( String ) arguments . get ( " mcpVersion " ) ; 
 @ @ - 245 , 4 + 256 , 12 @ @ public class FMLLoader 
 public static Predicate < String > getClassLoaderExclusions ( ) { 
 return classLoaderExclusions ; 
 } 
 + 
 + public static String getNaming ( ) { 
 + return naming ; 
 + } 
 + 
 + public static Optional < BiFunction < INameMappingService . Domain , String , String > > getNameFunction ( final String naming ) { 
 + return Launcher . INSTANCE . environment ( ) . findNameMapping ( naming ) ; 
 + } 
 } 
 diff - - git a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLServerLaunchProvider . java b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLServerLaunchProvider . java 
 index d0fde9d . . 608dfc4 100644 
 - - - a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLServerLaunchProvider . java 
 + + + b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLServerLaunchProvider . java 
 @ @ - 19 , 7 + 19 , 6 @ @ 
 
 package net . minecraftforge . fml . loading ; 
 
 - import com . google . common . collect . ObjectArrays ; 
 import cpw . mods . modlauncher . api . IEnvironment ; 
 import cpw . mods . modlauncher . api . ILaunchHandlerService ; 
 import cpw . mods . modlauncher . api . ITransformingClassLoader ; 
 @ @ - 27 , 7 + 26 , 6 @ @ import net . minecraftforge . api . distmarker . Dist ; 
 import org . apache . logging . log4j . LogManager ; 
 import org . apache . logging . log4j . Logger ; 
 
 - import java . nio . file . Path ; 
 import java . util . ArrayList ; 
 import java . util . List ; 
 import java . util . Map ; 
 @ @ - 74 , 4 + 72 , 10 @ @ public class FMLServerLaunchProvider extends FMLCommonLaunchHandler implements I 
 { 
 return Dist . DEDICATED _ SERVER ; 
 } 
 + 
 + @ Override 
 + protected String getNaming ( ) { 
 + return " srg " ; 
 + } 
 + 
 } 
 diff - - git a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLServiceProvider . java b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLServiceProvider . java 
 index f014265 . . 176d377 100644 
 - - - a / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLServiceProvider . java 
 + + + b / src / fmllauncher / java / net / minecraftforge / fml / loading / FMLServiceProvider . java 
 @ @ - 55 , 6 + 55 , 7 @ @ public class FMLServiceProvider implements ITransformationService 
 private String targetMcpVersion ; 
 private String targetMcpMappings ; 
 private String targetForgeGroup ; 
 + private Map < String , Object > arguments ; 
 
 @ Override 
 public String name ( ) 
 @ @ - 63 , 13 + 64 , 12 @ @ public class FMLServiceProvider implements ITransformationService 
 } 
 
 @ Override 
 - public void initialize ( IEnvironment environment ) 
 - { 
 - LOGGER . debug ( CORE , " Setting up basic FML game directories " ) ; 
 + public void initialize ( IEnvironment environment ) { 
 + LOGGER . debug ( CORE , " Setting up basic FML game directories " ) ; 
 FMLPaths . setup ( environment ) ; 
 - LOGGER . debug ( CORE , " Loading configuration " ) ; 
 + LOGGER . debug ( CORE , " Loading configuration " ) ; 
 FMLConfig . load ( ) ; 
 - final Map < String , Object > arguments = new HashMap < > ( ) ; 
 + arguments = new HashMap < > ( ) ; 
 arguments . put ( " modLists " , modListsArgumentList ) ; 
 arguments . put ( " mods " , modsArgumentList ) ; 
 arguments . put ( " mavenRoots " , mavenRootsArgumentList ) ; 
 @ @ - 82 , 6 + 82 , 10 @ @ public class FMLServiceProvider implements ITransformationService 
 FMLLoader . setupLaunchHandler ( environment , arguments ) ; 
 FMLEnvironment . setupInteropEnvironment ( environment ) ; 
 Environment . build ( environment ) ; 
 + } 
 + 
 + @ Override 
 + public void beginScanning ( final IEnvironment environment ) { 
 LOGGER . debug ( CORE , " Initiating mod scan " ) ; 
 FMLLoader . beginModScan ( arguments ) ; 
 } 
 diff - - git a / src / main / java / net / minecraftforge / fml / common / ObfuscationReflectionHelper . java b / src / main / java / net / minecraftforge / fml / common / ObfuscationReflectionHelper . java 
 index cdc58cc . . d25e74e 100644 
 - - - a / src / main / java / net / minecraftforge / fml / common / ObfuscationReflectionHelper . java 
 + + + b / src / main / java / net / minecraftforge / fml / common / ObfuscationReflectionHelper . java 
 @ @ - 18 , 19 + 18 , 17 @ @ 
 * / 
 
 package net . minecraftforge . fml . common ; 
 - import java . io . BufferedReader ; 
 - import java . io . IOException ; 
 - import java . io . InputStreamReader ; 
 import java . lang . reflect . Constructor ; 
 import java . lang . reflect . Field ; 
 import java . lang . reflect . Method ; 
 - import java . net . URL ; 
 import java . util . HashMap ; 
 import java . util . Map ; 
 import java . util . StringJoiner ; 
 
 import javax . annotation . Nonnull ; 
 
 + import cpw . mods . modlauncher . api . INameMappingService ; 
 + import net . minecraftforge . fml . loading . FMLLoader ; 
 import org . apache . logging . log4j . LogManager ; 
 import org . apache . logging . log4j . Logger ; 
 import org . apache . logging . log4j . Marker ; 
 @ @ - 59 , 25 + 57 , 9 @ @ public class ObfuscationReflectionHelper 
 
 
 
 - public static String [ ] remapNames ( String . . . names ) 
 + public static String remapName ( INameMappingService . Domain domain , String name ) 
 { 
 - loadMappings ( ) ; 
 - if ( map . isEmpty ( ) ) 
 - return names ; 
 - 
 - String [ ] mappedNames = new String [ names . length ] ; 
 - int i = 0 ; 
 - for ( String name : names ) 
 - mappedNames [ i + + ] = map . getOrDefault ( name , name ) ; 
 - return mappedNames ; 
 - } 
 - 
 - public static String remapName ( String name ) 
 - { 
 - loadMappings ( ) ; 
 - if ( map . isEmpty ( ) ) 
 - return name ; 
 - return map . getOrDefault ( name , name ) ; 
 + return FMLLoader . getNameFunction ( " srg " ) . map ( f - > f . apply ( domain , name ) ) . orElse ( name ) ; 
 } 
 
 public static < T , E > T getPrivateValue ( Class < ? super E > classToAccess , E instance , int fieldIndex ) 
 @ @ - 99 , 16 + 81 , 16 @ @ public class ObfuscationReflectionHelper 
 { 
 try 
 { 
 - return ( T ) findField ( classToAccess , remapName ( fieldName ) ) . get ( instance ) ; 
 + return ( T ) findField ( classToAccess , remapName ( INameMappingService . Domain . FIELD , fieldName ) ) . get ( instance ) ; 
 } 
 catch ( UnableToFindFieldException e ) 
 { 
 - LOGGER . error ( " Unable to locate field { } ( { } ) on type { } " , fieldName , remapName ( fieldName ) , classToAccess . getName ( ) , e ) ; 
 + LOGGER . error ( REFLECTION , " Unable to locate field { } ( { } ) on type { } " , fieldName , remapName ( INameMappingService . Domain . FIELD , fieldName ) , classToAccess . getName ( ) , e ) ; 
 throw e ; 
 } 
 catch ( IllegalAccessException e ) 
 { 
 - LOGGER . error ( " Unable to access field { } ( { } ) on type { } " , fieldName , remapName ( fieldName ) , classToAccess . getName ( ) , e ) ; 
 + LOGGER . error ( REFLECTION , " Unable to access field { } ( { } ) on type { } " , fieldName , remapName ( INameMappingService . Domain . FIELD , fieldName ) , classToAccess . getName ( ) , e ) ; 
 throw new UnableToAccessFieldException ( e ) ; 
 } 
 } 
 @ @ - 132 , 7 + 114 , 7 @ @ public class ObfuscationReflectionHelper 
 { 
 try 
 { 
 - findField ( classToAccess , remapName ( fieldName ) ) . set ( instance , value ) ; 
 + findField ( classToAccess , remapName ( INameMappingService . Domain . FIELD , fieldName ) ) . set ( instance , value ) ; 
 } 
 catch ( UnableToFindFieldException e ) 
 { 
 @ @ - 166 , 7 + 148 , 7 @ @ public class ObfuscationReflectionHelper 
 
 try 
 { 
 - Method m = clazz . getDeclaredMethod ( remapName ( methodName ) , parameterTypes ) ; 
 + Method m = clazz . getDeclaredMethod ( remapName ( INameMappingService . Domain . METHOD , methodName ) , parameterTypes ) ; 
 m . setAccessible ( true ) ; 
 return m ; 
 } 
 @ @ - 229 , 38 + 211 , 6 @ @ public class ObfuscationReflectionHelper 
 } 
 } 
 
 - private static void loadMappings ( ) 
 - { 
 - if ( loaded ) 
 - return ; 
 - 
 - synchronized ( map ) / / Just in case ? 
 - { 
 - if ( loaded ) / / Incase something else loaded while we were here , jump out 
 - return ; 
 - for ( String file : new String [ ] { " fields . csv " , " methods . csv " } ) 
 - { 
 - URL path = ClassLoader . getSystemResource ( file ) ; / / We EXPLICITLY go throught the SystemClassLoader here because this is dev - time only . And will be on the root classpath . 
 - if ( path = = null ) 
 - continue ; 
 - 
 - int count = map . size ( ) ; 
 - LOGGER . info ( REFLECTION , " Loading Mappings : { } " , path ) ; 
 - try ( BufferedReader reader = new BufferedReader ( new InputStreamReader ( path . openStream ( ) ) ) ) 
 - { 
 - reader . lines ( ) . skip ( 1 ) . map ( e - > e . split ( " , " ) ) . forEach ( e - > map . put ( e [ 0 ] , e [ 1 ] ) ) ; 
 - } 
 - catch ( IOException e1 ) 
 - { 
 - LOGGER . error ( REFLECTION , " Error reading mappings " , e1 ) ; 
 - } 
 - LOGGER . info ( REFLECTION , " Loaded { } entries " , map . size ( ) - count ) ; 
 - } 
 - loaded = true ; 
 - } 
 - } 
 - 
 - / / Add SRG names to these exception ? 
 public static class UnableToAccessFieldException extends RuntimeException 
 { 
 private UnableToAccessFieldException ( Exception e ) 
 diff - - git a / src / userdev / java / net / minecraftforge / userdev / FMLDevClientLaunchProvider . java b / src / userdev / java / net / minecraftforge / userdev / FMLDevClientLaunchProvider . java 
 index a464970 . . a2770d5 100644 
 - - - a / src / userdev / java / net / minecraftforge / userdev / FMLDevClientLaunchProvider . java 
 + + + b / src / userdev / java / net / minecraftforge / userdev / FMLDevClientLaunchProvider . java 
 @ @ - 107 , 4 + 107 , 10 @ @ public class FMLDevClientLaunchProvider extends FMLCommonLaunchHandler implement 
 @ Override 
 protected void validatePaths ( final Path forgePath , final Path [ ] mcPaths , final String forgeVersion , final String mcVersion , final String mcpVersion ) { 
 } 
 + 
 + @ Override 
 + protected String getNaming ( ) { 
 + return " mcp " ; 
 + } 
 + 
 } 
 diff - - git a / src / userdev / java / net / minecraftforge / userdev / FMLDevServerLaunchProvider . java b / src / userdev / java / net / minecraftforge / userdev / FMLDevServerLaunchProvider . java 
 index 73b082c . . 917d379 100644 
 - - - a / src / userdev / java / net / minecraftforge / userdev / FMLDevServerLaunchProvider . java 
 + + + b / src / userdev / java / net / minecraftforge / userdev / FMLDevServerLaunchProvider . java 
 @ @ - 92 , 4 + 92 , 10 @ @ public class FMLDevServerLaunchProvider extends FMLCommonLaunchHandler implement 
 { 
 return Dist . DEDICATED _ SERVER ; 
 } 
 + 
 + @ Override 
 + protected String getNaming ( ) { 
 + return " srg " ; 
 + } 
 + 
 } 
 diff - - git a / src / userdev / java / net / minecraftforge / userdev / FMLUserdevLaunchProvider . java b / src / userdev / java / net / minecraftforge / userdev / FMLUserdevLaunchProvider . java 
 index 37b3f21 . . 093f45b 100644 
 - - - a / src / userdev / java / net / minecraftforge / userdev / FMLUserdevLaunchProvider . java 
 + + + b / src / userdev / java / net / minecraftforge / userdev / FMLUserdevLaunchProvider . java 
 @ @ - 89 , 4 + 89 , 10 @ @ public abstract class FMLUserdevLaunchProvider extends FMLCommonLaunchHandler { 
 mcJars = LibraryFinder . findJarPathFor ( " en _ us . json " , " mcdata " , mcDataPath ) ; 
 return new Path [ ] { mcJars } ; 
 } 
 + 
 + @ Override 
 + protected String getNaming ( ) { 
 + return " mcp " ; 
 + } 
 + 
 } 
 diff - - git a / src / userdev / java / net / minecraftforge / userdev / MCPNamingService . java b / src / userdev / java / net / minecraftforge / userdev / MCPNamingService . java 
 new file mode 100644 
 index 0000000 . . 562ff58 
 - - - / dev / null 
 + + + b / src / userdev / java / net / minecraftforge / userdev / MCPNamingService . java 
 @ @ - 0 , 0 + 1 , 111 @ @ 
 + / * 
 + * Minecraft Forge 
 + * Copyright ( c ) 2016 - 2019 . 
 + * 
 + * This library is free software ; you can redistribute it and / or 
 + * modify it under the terms of the GNU Lesser General Public 
 + * License as published by the Free Software Foundation version 2 . 1 
 + * of the License . 
 + * 
 + * This library is distributed in the hope that it will be useful , 
 + * but WITHOUT ANY WARRANTY ; without even the implied warranty of 
 + * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE . See the GNU 
 + * Lesser General Public License for more details . 
 + * 
 + * You should have received a copy of the GNU Lesser General Public 
 + * License along with this library ; if not , write to the Free Software 
 + * Foundation , Inc . , 51 Franklin Street , Fifth Floor , Boston , MA 02110 - 1301 USA 
 + * / 
 + 
 + package net . minecraftforge . userdev ; 
 + 
 + import cpw . mods . modlauncher . api . INameMappingService ; 
 + import org . apache . commons . lang3 . tuple . Pair ; 
 + import org . apache . logging . log4j . LogManager ; 
 + import org . apache . logging . log4j . Logger ; 
 + 
 + import java . io . BufferedReader ; 
 + import java . io . IOException ; 
 + import java . io . InputStreamReader ; 
 + import java . net . URL ; 
 + import java . util . HashMap ; 
 + import java . util . Map ; 
 + import java . util . function . BiConsumer ; 
 + import java . util . function . BiFunction ; 
 + 
 + import static net . minecraftforge . fml . loading . LogMarkers . CORE ; 
 + 
 + public class MCPNamingService implements INameMappingService { 
 + private static final Logger LOGGER = LogManager . getLogger ( ) ; 
 + private HashMap < String , String > methods ; 
 + private HashMap < String , String > fields ; 
 + 
 + @ Override 
 + public String mappingName ( ) { 
 + return " srgtomcp " ; 
 + } 
 + 
 + @ Override 
 + public String mappingVersion ( ) { 
 + return " 1234 " ; 
 + } 
 + 
 + @ Override 
 + public Map . Entry < String , String > understanding ( ) { 
 + return Pair . of ( " srg " , " mcp " ) ; 
 + } 
 + 
 + @ Override 
 + public BiFunction < Domain , String , String > namingFunction ( ) { 
 + return this : : findMapping ; 
 + } 
 + 
 + private String findMapping ( final Domain domain , final String srgName ) { 
 + switch ( domain ) { 
 + case CLASS : 
 + return srgName ; 
 + case FIELD : 
 + return findFieldMapping ( srgName ) ; 
 + case METHOD : 
 + return findMethodMapping ( srgName ) ; 
 + } 
 + return srgName ; 
 + } 
 + 
 + private String findMethodMapping ( final String origin ) { 
 + if ( methods = = null ) { 
 + HashMap < String , String > tmpmethods = new HashMap < > ( 1000 ) ; 
 + loadMappings ( " methods . csv " , tmpmethods : : put ) ; 
 + methods = tmpmethods ; 
 + LOGGER . debug ( CORE , " Loaded { } method mappings from methods . csv " , methods . size ( ) ) ; 
 + } 
 + return methods . getOrDefault ( origin , origin ) ; 
 + } 
 + 
 + private String findFieldMapping ( final String origin ) { 
 + if ( fields = = null ) { 
 + HashMap < String , String > tmpfields = new HashMap < > ( 1000 ) ; 
 + loadMappings ( " fields . csv " , tmpfields : : put ) ; 
 + fields = tmpfields ; 
 + LOGGER . debug ( CORE , " Loaded { } field mappings from fields . csv " , fields . size ( ) ) ; 
 + } 
 + return fields . getOrDefault ( origin , origin ) ; 
 + } 
 + 
 + 
 + private static void loadMappings ( final String mappingFileName , BiConsumer < String , String > mapStore ) 
 + { 
 + URL path = ClassLoader . getSystemResource ( mappingFileName ) ; / / We EXPLICITLY go throught the SystemClassLoader here because this is dev - time only . And will be on the root classpath . 
 + if ( path = = null ) 
 + return ; 
 + 
 + try ( BufferedReader reader = new BufferedReader ( new InputStreamReader ( path . openStream ( ) ) ) ) 
 + { 
 + reader . lines ( ) . skip ( 1 ) . map ( e - > e . split ( " , " ) ) . forEach ( e - > mapStore . accept ( e [ 0 ] , e [ 1 ] ) ) ; 
 + } 
 + catch ( IOException e1 ) 
 + { 
 + LOGGER . error ( CORE , " Error reading mappings " , e1 ) ; 
 + } 
 + } 
 + } 
 diff - - git a / src / userdev / resources / META - INF / services / cpw . mods . modlauncher . api . INameMappingService b / src / userdev / resources / META - INF / services / cpw . mods . modlauncher . api . INameMappingService 
 new file mode 100644 
 index 0000000 . . 2c3e934 
 - - - / dev / null 
 + + + b / src / userdev / resources / META - INF / services / cpw . mods . modlauncher . api . INameMappingService 
 @ @ - 0 , 0 + 1 @ @ 
 + net . minecraftforge . userdev . MCPNamingService 
 \ No newline at end of file

NEAREST DIFF:
diff - - git a / src / main / java / net / minecraftforge / fml / LaunchTesting . java b / src / main / java / net / minecraftforge / fml / LaunchTesting . java 
 index c34b865 . . 020c5e7 100644 
 - - - a / src / main / java / net / minecraftforge / fml / LaunchTesting . java 
 + + + b / src / main / java / net / minecraftforge / fml / LaunchTesting . java 
 @ @ - 25 , 9 + 25 , 10 @ @ import org . apache . logging . log4j . core . config . Configurator ; 
 
 public class LaunchTesting 
 { 
 - public static void main ( String . . . args ) 
 + public static void main ( String . . . args ) throws InterruptedException 
 { 
 Configurator . setRootLevel ( Level . DEBUG ) ; 
 Launcher . main ( " - - launchTarget " , " fml " , " - - gameDir " , " projects / run " ) ; 
 + Thread . sleep ( 10000 ) ; 
 } 
 } 
 diff - - git a / src / main / java / net / minecraftforge / fml / loading / FMLJavaModLanguageProvider . java b / src / main / java / net / minecraftforge / fml / loading / FMLJavaModLanguageProvider . java 
 new file mode 100644 
 index 0000000 . . fe23461 
 - - - / dev / null 
 + + + b / src / main / java / net / minecraftforge / fml / loading / FMLJavaModLanguageProvider . java 
 @ @ - 0 , 0 + 1 , 86 @ @ 
 + / * 
 + * Minecraft Forge 
 + * Copyright ( c ) 2018 . 
 + * 
 + * This library is free software ; you can redistribute it and / or 
 + * modify it under the terms of the GNU Lesser General Public 
 + * License as published by the Free Software Foundation version 2 . 1 
 + * of the License . 
 + * 
 + * This library is distributed in the hope that it will be useful , 
 + * but WITHOUT ANY WARRANTY ; without even the implied warranty of 
 + * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE . See the GNU 
 + * Lesser General Public License for more details . 
 + * 
 + * You should have received a copy of the GNU Lesser General Public 
 + * License along with this library ; if not , write to the Free Software 
 + * Foundation , Inc . , 51 Franklin Street , Fifth Floor , Boston , MA 02110 - 1301 USA 
 + * / 
 + 
 + package net . minecraftforge . fml . loading ; 
 + 
 + import net . minecraftforge . fml . common . ModContainer ; 
 + import net . minecraftforge . fml . loading . moddiscovery . ModFile ; 
 + import net . minecraftforge . fml . loading . moddiscovery . ModInfo ; 
 + import net . minecraftforge . fml . loading . moddiscovery . ScanResult ; 
 + import org . objectweb . asm . Type ; 
 + 
 + import java . util . List ; 
 + import java . util . Map ; 
 + import java . util . function . Consumer ; 
 + import java . util . function . Function ; 
 + import java . util . stream . Collectors ; 
 + 
 + import static net . minecraftforge . fml . Logging . SCAN ; 
 + import static net . minecraftforge . fml . Logging . fmlLog ; 
 + 
 + public class FMLJavaModLanguageProvider implements IModLanguageProvider 
 + { 
 + private static class FMLModTarget implements IModLanguageProvider . IModLanguageLoader { 
 + private final String className ; 
 + private final String modId ; 
 + 
 + private FMLModTarget ( String className , String modId ) 
 + { 
 + this . className = className ; 
 + this . modId = modId ; 
 + } 
 + 
 + public String getModId ( ) 
 + { 
 + return modId ; 
 + } 
 + 
 + @ Override 
 + public ModContainer loadMod ( ModFile file , ClassLoader modClassLoader ) 
 + { 
 + return null ; 
 + } 
 + } 
 + 
 + public static final Type MODANNOTATION = Type . getType ( " Lnet / minecraftforge / fml / common / Mod ; " ) ; 
 + 
 + @ Override 
 + public String name ( ) 
 + { 
 + return " javafml " ; 
 + } 
 + 
 + @ Override 
 + public Consumer < ScanResult > getFileVisitor ( ) { 
 + return scanResult - > { 
 + final Map < String , FMLModTarget > modTargetMap = scanResult . getAnnotations ( ) . stream ( ) 
 + . filter ( ad - > ad . getAnnotationType ( ) . equals ( MODANNOTATION ) ) 
 + . peek ( ad - > fmlLog . debug ( SCAN , " Found @ Mod class { } with id { } " , ad . getClassType ( ) . getClassName ( ) , ad . getAnnotationData ( ) . get ( " modid " ) ) ) 
 + . map ( ad - > new FMLModTarget ( ad . getClassType ( ) . getClassName ( ) , ( String ) ad . getAnnotationData ( ) . get ( " modid " ) ) ) 
 + . collect ( Collectors . toMap ( FMLModTarget : : getModId , Function . identity ( ) ) ) ; 
 + modTargetMap . forEach ( ( key , value ) - > scanResult . getFile ( ) . claimLanguage ( key , value ) ) ; 
 + } ; 
 + } 
 + 
 + @ Override 
 + public List < ModContainer > buildModContainers ( List < ModInfo > modFiles , ClassLoader modClassLoader ) 
 + { 
 + return null ; 
 + } 
 + } 
 diff - - git a / src / main / java / net / minecraftforge / fml / loading / FMLLoader . java b / src / main / java / net / minecraftforge / fml / loading / FMLLoader . java 
 index 5aecb99 . . 0255021 100644 
 - - - a / src / main / java / net / minecraftforge / fml / loading / FMLLoader . java 
 + + + b / src / main / java / net / minecraftforge / fml / loading / FMLLoader . java 
 @ @ - 28 , 25 + 28 , 20 @ @ import net . minecraftforge . fml . loading . moddiscovery . ModDiscoverer ; 
 import net . minecraftforge . forgespi . ICoreModProvider ; 
 
 import java . util . ArrayList ; 
 - import java . util . Arrays ; 
 - import java . util . HashSet ; 
 - import java . util . Iterator ; 
 - import java . util . List ; 
 import java . util . ServiceLoader ; 
 import java . util . Set ; 
 import java . util . stream . Collectors ; 
 
 import static net . minecraftforge . fml . Logging . CORE ; 
 - import static net . minecraftforge . fml . Logging . LOADING ; 
 import static net . minecraftforge . fml . Logging . SCAN ; 
 import static net . minecraftforge . fml . Logging . fmlLog ; 
 
 public class FMLLoader 
 { 
 - 
 private static ILaunchPluginService accessTransformer ; 
 private static ModDiscoverer modDiscoverer ; 
 - private static ICoreModProvider coreMod ; 
 + private static ICoreModProvider coreModProvider ; 
 + private static LanguageLoadingProvider languageLoadingProvider ; 
 
 static void onInitialLoad ( IEnvironment environment , Set < String > otherServices ) throws IncompatibleEnvironmentException 
 { 
 @ @ - 79 , 9 + 74 , 11 @ @ public class FMLLoader 
 throw new IncompatibleEnvironmentException ( " Multiple coremod libraries found " ) ; 
 } 
 
 - coreMod = coreModProviders . get ( 0 ) ; 
 - final Package coremodPackage = coreMod . getClass ( ) . getPackage ( ) ; 
 + coreModProvider = coreModProviders . get ( 0 ) ; 
 + final Package coremodPackage = coreModProvider . getClass ( ) . getPackage ( ) ; 
 fmlLog . debug ( CORE , " FML found CoreMod version : { } " , coremodPackage . getImplementationVersion ( ) ) ; 
 + 
 + languageLoadingProvider = new LanguageLoadingProvider ( ) ; 
 } 
 
 public static void load ( ) 
 @ @ - 90 , 4 + 87 , 13 @ @ public class FMLLoader 
 modDiscoverer = new ModDiscoverer ( ) ; 
 modDiscoverer . discoverMods ( ) ; 
 } 
 + 
 + public static ICoreModProvider getCoreModProvider ( ) { 
 + return coreModProvider ; 
 + } 
 + 
 + public static LanguageLoadingProvider getLanguageLoadingProvider ( ) 
 + { 
 + return languageLoadingProvider ; 
 + } 
 } 
 diff - - git a / src / main / java / net / minecraftforge / fml / loading / FMLServiceProvider . java b / src / main / java / net / minecraftforge / fml / loading / FMLServiceProvider . java 
 index 3ceec55 . . 0d1c070 100644 
 - - - a / src / main / java / net / minecraftforge / fml / loading / FMLServiceProvider . java 
 + + + b / src / main / java / net / minecraftforge / fml / loading / FMLServiceProvider . java 
 @ @ - 25 , 14 + 25 , 17 @ @ import cpw . mods . modlauncher . api . ITransformer ; 
 import cpw . mods . modlauncher . api . IncompatibleEnvironmentException ; 
 import joptsimple . ArgumentAcceptingOptionSpec ; 
 import joptsimple . OptionSpecBuilder ; 
 + import net . minecraftforge . coremod . CoreModEngine ; 
 import net . minecraftforge . fml . FMLConfig ; 
 import net . minecraftforge . fml . common . FMLPaths ; 
 
 import javax . annotation . Nonnull ; 
 + import java . util . ArrayList ; 
 import java . util . Collections ; 
 import java . util . List ; 
 import java . util . Set ; 
 import java . util . function . BiFunction ; 
 + import java . util . stream . Collectors ; 
 
 import static net . minecraftforge . fml . Logging . CORE ; 
 import static net . minecraftforge . fml . Logging . fmlLog ; 
 @ @ - 86 , 7 + 89 , 8 @ @ public class FMLServiceProvider implements ITransformationService 
 @ Override 
 public List < ITransformer > transformers ( ) 
 { 
 - return Collections . emptyList ( ) ; 
 + fmlLog . debug ( CORE , " Loading coremod transformers " ) ; 
 + return new ArrayList < > ( FMLLoader . getCoreModProvider ( ) . getCoreModTransformers ( ) ) ; 
 } 
 
 } 
 diff - - git a / src / main / java / net / minecraftforge / fml / loading / IModLanguageProvider . java b / src / main / java / net / minecraftforge / fml / loading / IModLanguageProvider . java 
 new file mode 100644 
 index 0000000 . . cceb903 
 - - - / dev / null 
 + + + b / src / main / java / net / minecraftforge / fml / loading / IModLanguageProvider . java 
 @ @ - 0 , 0 + 1 , 47 @ @ 
 + / * 
 + * Minecraft Forge 
 + * Copyright ( c ) 2018 . 
 + * 
 + * This library is free software ; you can redistribute it and / or 
 + * modify it under the terms of the GNU Lesser General Public 
 + * License as published by the Free Software Foundation version 2 . 1 
 + * of the License . 
 + * 
 + * This library is distributed in the hope that it will be useful , 
 + * but WITHOUT ANY WARRANTY ; without even the implied warranty of 
 + * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE . See the GNU 
 + * Lesser General Public License for more details . 
 + * 
 + * You should have received a copy of the GNU Lesser General Public 
 + * License along with this library ; if not , write to the Free Software 
 + * Foundation , Inc . , 51 Franklin Street , Fifth Floor , Boston , MA 02110 - 1301 USA 
 + * / 
 + 
 + package net . minecraftforge . fml . loading ; 
 + 
 + import net . minecraftforge . fml . common . ModContainer ; 
 + import net . minecraftforge . fml . loading . moddiscovery . ModFile ; 
 + import net . minecraftforge . fml . loading . moddiscovery . ModInfo ; 
 + import net . minecraftforge . fml . loading . moddiscovery . ScanResult ; 
 + 
 + import java . util . List ; 
 + import java . util . function . Consumer ; 
 + 
 + / * * 
 + * Loaded as a ServiceLoader , from the classpath . Extensions are loaded from 
 + * the mods directory , with the FMLType META - INF of LANGPROVIDER . 
 + * 
 + * Version data is read from the manifest ' s implementation version . 
 + * / 
 + public interface IModLanguageProvider 
 + { 
 + String name ( ) ; 
 + 
 + Consumer < ScanResult > getFileVisitor ( ) ; 
 + 
 + interface IModLanguageLoader { 
 + ModContainer loadMod ( ModFile file , ClassLoader modClassLoader ) ; 
 + } 
 + 
 + List < ModContainer > buildModContainers ( List < ModInfo > modFiles , ClassLoader modClassLoader ) ; 
 + } 
 diff - - git a / src / main / java / net / minecraftforge / fml / loading / LanguageLoadingProvider . java b / src / main / java / net / minecraftforge / fml / loading / LanguageLoadingProvider . java 
 new file mode 100644 
 index 0000000 . . 5b7c7f9 
 - - - / dev / null 
 + + + b / src / main / java / net / minecraftforge / fml / loading / LanguageLoadingProvider . java 
 @ @ - 0 , 0 + 1 , 64 @ @ 
 + / * 
 + * Minecraft Forge 
 + * Copyright ( c ) 2018 . 
 + * 
 + * This library is free software ; you can redistribute it and / or 
 + * modify it under the terms of the GNU Lesser General Public 
 + * License as published by the Free Software Foundation version 2 . 1 
 + * of the License . 
 + * 
 + * This library is distributed in the hope that it will be useful , 
 + * but WITHOUT ANY WARRANTY ; without even the implied warranty of 
 + * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE . See the GNU 
 + * Lesser General Public License for more details . 
 + * 
 + * You should have received a copy of the GNU Lesser General Public 
 + * License along with this library ; if not , write to the Free Software 
 + * Foundation , Inc . , 51 Franklin Street , Fifth Floor , Boston , MA 02110 - 1301 USA 
 + * / 
 + 
 + package net . minecraftforge . fml . loading ; 
 + 
 + import net . minecraftforge . fml . loading . moddiscovery . ModFile ; 
 + 
 + import java . nio . file . Path ; 
 + import java . util . ArrayList ; 
 + import java . util . HashMap ; 
 + import java . util . List ; 
 + import java . util . Map ; 
 + import java . util . ServiceLoader ; 
 + import java . util . stream . Stream ; 
 + 
 + import static net . minecraftforge . fml . Logging . CORE ; 
 + import static net . minecraftforge . fml . Logging . fmlLog ; 
 + 
 + public class LanguageLoadingProvider 
 + { 
 + private final List < IModLanguageProvider > languageProviders = new ArrayList < > ( ) ; 
 + private final ServiceLoader < IModLanguageProvider > serviceLoader ; 
 + private final Map < String , IModLanguageProvider > languageProviderMap = new HashMap < > ( ) ; 
 + 
 + LanguageLoadingProvider ( ) { 
 + serviceLoader = ServiceLoader . load ( IModLanguageProvider . class ) ; 
 + serviceLoader . forEach ( languageProviders : : add ) ; 
 + 
 + languageProviders . forEach ( lp - > { 
 + final Package pkg = lp . getClass ( ) . getPackage ( ) ; 
 + fmlLog . debug ( CORE , " Found system classpath language provider { } , version { } " , lp . name ( ) , pkg . getImplementationVersion ( ) ) ; 
 + } ) ; 
 + 
 + languageProviders . forEach ( lp - > languageProviderMap . put ( lp . name ( ) , lp ) ) ; 
 + } 
 + 
 + public void addAdditionalLanguages ( List < ModFile > modFiles ) 
 + { 
 + if ( modFiles = = null ) return ; 
 + Stream < Path > langPaths = modFiles . stream ( ) . map ( ModFile : : getFilePath ) ; 
 + serviceLoader . reload ( ) ; 
 + } 
 + 
 + public IModLanguageProvider getLanguage ( String name ) 
 + { 
 + return languageProviderMap . get ( name ) ; 
 + } 
 + } 
 diff - - git a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / BackgroundScanHandler . java b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / BackgroundScanHandler . java 
 index 93694a4 . . 42a754f 100644 
 - - - a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / BackgroundScanHandler . java 
 + + + b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / BackgroundScanHandler . java 
 @ @ - 19 , 11 + 19 , 14 @ @ 
 
 package net . minecraftforge . fml . loading . moddiscovery ; 
 
 + import com . google . common . util . concurrent . MoreExecutors ; 
 + 
 import java . util . ArrayList ; 
 import java . util . List ; 
 import java . util . concurrent . CompletableFuture ; 
 import java . util . concurrent . ExecutorService ; 
 import java . util . concurrent . Executors ; 
 + import java . util . concurrent . ThreadFactory ; 
 import java . util . concurrent . TimeUnit ; 
 
 import static net . minecraftforge . fml . Logging . SCAN ; 
 @ @ - 37 , 7 + 40 , 11 @ @ public class BackgroundScanHandler 
 private final List < ModFile > allFiles ; 
 
 public BackgroundScanHandler ( ) { 
 - modContentScanner = Executors . newCachedThreadPool ( ) ; 
 + modContentScanner = Executors . newSingleThreadExecutor ( r - > { 
 + final Thread thread = Executors . defaultThreadFactory ( ) . newThread ( r ) ; 
 + thread . setDaemon ( true ) ; 
 + return thread ; 
 + } ) ; 
 scannedFiles = new ArrayList < > ( ) ; 
 pendingFiles = new ArrayList < > ( ) ; 
 allFiles = new ArrayList < > ( ) ; 
 diff - - git a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModDiscoverer . java b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModDiscoverer . java 
 index 27dc4f0 . . de71a15 100644 
 - - - a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModDiscoverer . java 
 + + + b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModDiscoverer . java 
 @ @ - 20 , 6 + 20 , 8 @ @ 
 package net . minecraftforge . fml . loading . moddiscovery ; 
 
 import cpw . mods . modlauncher . ServiceLoaderStreamUtils ; 
 + import net . minecraftforge . fml . loading . FMLLoader ; 
 + import net . minecraftforge . fml . loading . LanguageLoadingProvider ; 
 
 import java . util . Collection ; 
 import java . util . List ; 
 @ @ - 54 , 12 + 56 , 12 @ @ public class ModDiscoverer { 
 . peek ( mf - > fmlLog . debug ( SCAN , " Found mod file { } of type { } with locator { } " , mf . getFileName ( ) , mf . getType ( ) , mf . getLocator ( ) ) ) 
 . collect ( Collectors . groupingBy ( ModFile : : getType ) ) ; 
 
 - / / ModLanguageProvider . loadAdditionalLanguages ( modFiles . get ( ModFile . Type . LANGPROVIDER ) ) ; 
 + FMLLoader . getLanguageLoadingProvider ( ) . addAdditionalLanguages ( modFiles . get ( ModFile . Type . LANGPROVIDER ) ) ; 
 BackgroundScanHandler backgroundScanHandler = new BackgroundScanHandler ( ) ; 
 final List < ModFile > mods = modFiles . get ( ModFile . Type . MOD ) ; 
 mods . forEach ( ModFile : : identifyMods ) ; 
 fmlLog . debug ( SCAN , " Found { } mod files with { } mods " , mods : : size , ( ) - > mods . stream ( ) . mapToInt ( mf - > mf . getModInfos ( ) . size ( ) ) . sum ( ) ) ; 
 - / / mods . stream ( ) . map ( ModFile : : getCoreMods ) . flatMap ( List : : stream ) . forEach ( ServiceProviders . getCoreModProvider ( ) : : addCoreMod ) ; 
 + mods . stream ( ) . map ( ModFile : : getCoreMods ) . flatMap ( List : : stream ) . forEach ( FMLLoader . getCoreModProvider ( ) : : addCoreMod ) ; 
 mods . forEach ( backgroundScanHandler : : submitForScanning ) ; 
 return backgroundScanHandler ; 
 } 
 diff - - git a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModFile . java b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModFile . java 
 index 8733035 . . 8f57bae 100644 
 - - - a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModFile . java 
 + + + b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModFile . java 
 @ @ - 19 , 14 + 19 , 21 @ @ 
 
 package net . minecraftforge . fml . loading . moddiscovery ; 
 
 + import net . minecraftforge . fml . loading . IModLanguageProvider ; 
 + 
 + import javax . swing . text . html . Option ; 
 import java . nio . file . Path ; 
 import java . util . List ; 
 + import java . util . Map ; 
 import java . util . Objects ; 
 + import java . util . Optional ; 
 import java . util . concurrent . CompletableFuture ; 
 import java . util . concurrent . ExecutionException ; 
 import java . util . function . Consumer ; 
 + import java . util . function . Function ; 
 import java . util . jar . Attributes ; 
 import java . util . jar . Manifest ; 
 + import java . util . stream . Collectors ; 
 
 import static net . minecraftforge . fml . Logging . LOADING ; 
 import static net . minecraftforge . fml . Logging . SCAN ; 
 @ @ - 40 , 6 + 47 , 11 @ @ public class ModFile 
 DEFAULTMANIFEST . getMainAttributes ( ) . putValue ( " FMLModType " , " MOD " ) ; 
 } 
 
 + public void claimLanguage ( String modId , IModLanguageProvider . IModLanguageLoader loader ) 
 + { 
 + this . modInfoMap . get ( modId ) . setLoader ( loader ) ; 
 + } 
 + 
 public enum Type { 
 MOD , LIBRARY , LANGPROVIDER 
 } 
 @ @ - 47 , 6 + 59 , 7 @ @ public class ModFile 
 private final Type modFileType ; 
 private final Manifest manifest ; 
 private List < ModInfo > modInfos ; 
 + private Map < String , ModInfo > modInfoMap ; 
 private final IModLocator locator ; 
 private ScanResult fileScanResult ; 
 private CompletableFuture < ScanResult > futureScanResult ; 
 @ @ - 60 , 7 + 73 , 8 @ @ public class ModFile 
 manifest = locator . findManifest ( file ) . orElse ( DEFAULTMANIFEST ) ; 
 if ( manifest ! = DEFAULTMANIFEST ) fmlLog . debug ( SCAN , " Mod file { } has a manifest " , file ) ; 
 else fmlLog . debug ( SCAN , " Mod file { } is missing a manifest " , file ) ; 
 - modFileType = Type . valueOf ( manifest . getMainAttributes ( ) . getValue ( TYPE ) ) ; 
 + final Optional < String > value = Optional . ofNullable ( manifest . getMainAttributes ( ) . getValue ( TYPE ) ) ; 
 + modFileType = Type . valueOf ( value . orElse ( " MOD " ) ) ; 
 } 
 
 public Type getType ( ) { 
 @ @ - 78 , 6 + 92 , 7 @ @ public class ModFile 
 public void identifyMods ( ) { 
 this . modInfos = ModFileParser . readModList ( this ) ; 
 this . modInfos . forEach ( mi - > fmlLog . debug ( LOADING , " Found mod { } for language { } " , mi . getModId ( ) , mi . getModLoader ( ) ) ) ; 
 + this . modInfoMap = this . modInfos . stream ( ) . collect ( Collectors . toMap ( ModInfo : : getModId , Function . identity ( ) ) ) ; 
 this . coreMods = ModFileParser . getCoreMods ( this ) ; 
 this . coreMods . forEach ( mi - > fmlLog . debug ( LOADING , " Found coremod { } " , mi . getPath ( ) ) ) ; 
 } 
 diff - - git a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModInfo . java b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModInfo . java 
 index 2a3c1de . . 7910600 100644 
 - - - a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModInfo . java 
 + + + b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ModInfo . java 
 @ @ - 20 , 6 + 20 , 10 @ @ 
 package net . minecraftforge . fml . loading . moddiscovery ; 
 
 import net . minecraftforge . fml . common . versioning . ArtifactVersion ; 
 + import net . minecraftforge . fml . loading . IModLanguageProvider ; 
 + 
 + import java . net . URL ; 
 + import java . util . List ; 
 
 public class ModInfo { 
 private final ModFile owningFile ; 
 @ @ - 27 , 11 + 31 , 12 @ @ public class ModInfo { 
 private final ArtifactVersion version ; 
 private final String displayName ; 
 private final String description ; 
 - private final java . net . URL updateJSONURL ; 
 + private final URL updateJSONURL ; 
 private final String modLoader ; 
 - private final java . util . List < net . minecraftforge . fml . loading . moddiscovery . ModInfo . ModVersion > dependencies ; 
 + private final List < ModInfo . ModVersion > dependencies ; 
 + private IModLanguageProvider . IModLanguageLoader loader ; 
 
 - public ModInfo ( final ModFile owningFile , final String modLoader , final String modId , final String displayName , final ArtifactVersion version , final String description , final java . net . URL updateJSONURL , final java . util . List < net . minecraftforge . fml . loading . moddiscovery . ModInfo . ModVersion > dependencies ) { 
 + public ModInfo ( final ModFile owningFile , final String modLoader , final String modId , final String displayName , final ArtifactVersion version , final String description , final URL updateJSONURL , final List < ModInfo . ModVersion > dependencies ) { 
 this . owningFile = owningFile ; 
 this . modLoader = modLoader ; 
 this . modId = modId ; 
 @ @ - 58 , 6 + 63 , 11 @ @ public class ModInfo { 
 return version ; 
 } 
 
 + public void setLoader ( IModLanguageProvider . IModLanguageLoader loader ) 
 + { 
 + this . loader = loader ; 
 + } 
 + 
 public enum Ordering { 
 BEFORE , AFTER , NONE ; 
 } 
 diff - - git a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ScanResult . java b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ScanResult . java 
 index f35f626 . . cd75eaa 100644 
 - - - a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ScanResult . java 
 + + + b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / ScanResult . java 
 @ @ - 22 , 27 + 22 , 33 @ @ package net . minecraftforge . fml . loading . moddiscovery ; 
 
 import org . objectweb . asm . Type ; 
 
 + import java . util . ArrayList ; 
 + import java . util . List ; 
 import java . util . Map ; 
 import java . util . Set ; 
 
 public class ScanResult { 
 private final ModFile file ; 
 - private final java . util . List < net . minecraftforge . fml . loading . moddiscovery . ScanResult . AnnotationData > annotations = new java . util . ArrayList < > ( ) ; 
 - private final java . util . List < net . minecraftforge . fml . loading . moddiscovery . ScanResult . ClassData > classes = new java . util . ArrayList < > ( ) ; 
 + private final List < ScanResult . AnnotationData > annotations = new ArrayList < > ( ) ; 
 + private final List < ScanResult . ClassData > classes = new ArrayList < > ( ) ; 
 
 public ScanResult ( final ModFile file ) { 
 this . file = file ; 
 } 
 
 + public ModFile getFile ( ) { 
 + return file ; 
 + } 
 + 
 public static boolean interestingAnnotations ( final ModAnnotation annotation ) { 
 return true ; 
 } 
 
 - public java . util . List < net . minecraftforge . fml . loading . moddiscovery . ScanResult . ClassData > getClasses ( ) { 
 + public List < ScanResult . ClassData > getClasses ( ) { 
 return classes ; 
 } 
 
 - public java . util . List < net . minecraftforge . fml . loading . moddiscovery . ScanResult . AnnotationData > getAnnotations ( ) { 
 + public List < ScanResult . AnnotationData > getAnnotations ( ) { 
 return annotations ; 
 } 
 
 diff - - git a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / Scanner . java b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / Scanner . java 
 index 0770426 . . 92fdab3 100644 
 - - - a / src / main / java / net / minecraftforge / fml / loading / moddiscovery / Scanner . java 
 + + + b / src / main / java / net / minecraftforge / fml / loading / moddiscovery / Scanner . java 
 @ @ - 19 , 8 + 19 , 19 @ @ 
 
 package net . minecraftforge . fml . loading . moddiscovery ; 
 
 + import net . minecraftforge . fml . loading . FMLLoader ; 
 + import net . minecraftforge . fml . loading . IModLanguageProvider ; 
 + import net . minecraftforge . fml . loading . LanguageLoadingProvider ; 
 import org . objectweb . asm . ClassReader ; 
 
 + import java . io . IOException ; 
 + import java . nio . file . Files ; 
 + import java . nio . file . Path ; 
 + import java . util . Set ; 
 + import java . util . function . Consumer ; 
 + import java . util . stream . Collectors ; 
 + 
 + import static net . minecraftforge . fml . Logging . LOADING ; 
 import static net . minecraftforge . fml . Logging . SCAN ; 
 import static net . minecraftforge . fml . Logging . fmlLog ; 
 
 @ @ - 34 , 17 + 45 , 20 @ @ public class Scanner { 
 public ScanResult scan ( ) { 
 ScanResult result = new ScanResult ( fileToScan ) ; 
 fileToScan . scanFile ( p - > fileVisitor ( p , result ) ) ; 
 + final Set < IModLanguageProvider > modLoaders = fileToScan . getModInfos ( ) . stream ( ) . map ( ModInfo : : getModLoader ) . map ( FMLLoader . getLanguageLoadingProvider ( ) : : getLanguage ) . collect ( Collectors . toSet ( ) ) ; 
 + modLoaders . stream ( ) . peek ( ml - > fmlLog . debug ( SCAN , " Scanning { } with language loader { } " , fileToScan . getFilePath ( ) , ml . name ( ) ) ) 
 + . map ( IModLanguageProvider : : getFileVisitor ) . forEach ( c - > c . accept ( result ) ) ; 
 return result ; 
 } 
 
 - private void fileVisitor ( final java . nio . file . Path path , final ScanResult result ) { 
 + private void fileVisitor ( final Path path , final ScanResult result ) { 
 try { 
 fmlLog . debug ( SCAN , " Scanning { } path { } " , fileToScan , path ) ; 
 ModClassVisitor mcv = new ModClassVisitor ( ) ; 
 - org . objectweb . asm . ClassReader cr = new ClassReader ( java . nio . file . Files . newInputStream ( path ) ) ; 
 + ClassReader cr = new ClassReader ( Files . newInputStream ( path ) ) ; 
 cr . accept ( mcv , 0 ) ; 
 mcv . buildData ( result . getClasses ( ) , result . getAnnotations ( ) ) ; 
 - } catch ( java . io . IOException e ) { 
 + } catch ( IOException e ) { 
 / / mark path bad 
 } 
 } 
 diff - - git a / src / main / resources / META - INF / services / net . minecraftforge . fml . loading . IModLanguageProvider b / src / main / resources / META - INF / services / net . minecraftforge . fml . loading . IModLanguageProvider 
 new file mode 100644 
 index 0000000 . . dc3f902 
 - - - / dev / null 
 + + + b / src / main / resources / META - INF / services / net . minecraftforge . fml . loading . IModLanguageProvider 
 @ @ - 0 , 0 + 1 @ @ 
 + net . minecraftforge . fml . loading . FMLJavaModLanguageProvider 
 \ No newline at end of file
