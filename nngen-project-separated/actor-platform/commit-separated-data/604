BLEU SCORE: 0.018738883683389617

TEST MSG: fix ( android ) : fast share media permission on M
GENERATED MSG: Merge commit ' 38f34b306a02a3f49f7f937eb5d33aacab3a4e26 ' into calls / v2

TEST DIFF (one line): diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java < nl > index 320137d . . fde98dc 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java < nl > @ @ - 13 , 6 + 13 , 7 @ @ import android . graphics . Color ; < nl > import android . graphics . PorterDuff ; < nl > import android . media . MediaScannerConnection ; < nl > import android . net . Uri ; < nl > + import android . os . Build ; < nl > import android . os . Bundle ; < nl > import android . os . Environment ; < nl > import android . provider . ContactsContract ; < nl > @ @ - 113 , 6 + 114 , 7 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > private static final int PERMISSIONS _ REQUEST _ CAMERA = 6 ; < nl > private static final int PERMISSION _ REQUEST _ RECORD _ AUDIO = 7 ; < nl > private static final int PERMISSIONS _ REQUEST _ FOR _ CALL = 8 ; < nl > + private static final int PERMISSION _ REQ _ MEDIA = 11 ; < nl > / / Peer of current chat < nl > private Peer peer ; < nl > < nl > @ @ - 294 , 6 + 296 , 7 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > messageEditText . setText ( " " ) ; < nl > } < nl > textEditing = false ; < nl > + checkSendButton ( ) ; < nl > < nl > } < nl > } ) ; < nl > @ @ - 797 , 6 + 800 , 7 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > } < nl > } ) ; < nl > goneView ( quoteContainer ) ; < nl > + checkSendButton ( ) ; < nl > textEditing = false ; < nl > } else { < nl > messenger ( ) . sendMessage ( peer , rawText ) ; < nl > @ @ - 1077 , 6 + 1081 , 8 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > hideShare ( ) ; < nl > quoteText . setCompoundDrawablesWithIntrinsicBounds ( getResources ( ) . getDrawable ( R . drawable . ic _ editor _ format _ quote _ gray ) , null , null , null ) ; < nl > showView ( quoteContainer ) ; < nl > + checkSendButton ( ) ; < nl > + < nl > } < nl > < nl > / / Back button handling < nl > @ @ - 1085 , 6 + 1091 , 8 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > public void onBackPressed ( ) { < nl > if ( isMentionsVisible ) { < nl > hideMentions ( ) ; < nl > + } else if ( isShareVisible ) { < nl > + hideShare ( ) ; < nl > } else if ( emojiKeyboard . isShowing ( ) ) { < nl > emojiKeyboard . dismiss ( ) ; < nl > } else { < nl > @ @ - 1243 , 7 + 1251 , 7 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > messageEditText . setText ( text ) ; < nl > hideShare ( ) ; < nl > showView ( quoteContainer ) ; < nl > - < nl > + / / we don ' t force check send button here , because it forces from text watcher < nl > } < nl > < nl > private class TextWatcherImp implements TextWatcher { < nl > @ @ - 1308 , 19 + 1316 , 25 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > < nl > @ Override < nl > public void afterTextChanged ( Editable s ) { < nl > - if ( s . length ( ) > 0 ) { < nl > - sendButton . setTint ( ActorSDK . sharedActor ( ) . style . getConvSendEnabledColor ( ) ) ; < nl > - sendButton . setEnabled ( true ) ; < nl > - zoomInView ( sendButton ) ; < nl > - zoomOutView ( audioButton ) ; < nl > - } else { < nl > - sendButton . setTint ( ActorSDK . sharedActor ( ) . style . getConvSendDisabledColor ( ) ) ; < nl > - sendButton . setEnabled ( false ) ; < nl > - zoomInView ( audioButton ) ; < nl > - zoomOutView ( sendButton ) ; < nl > - } < nl > + checkSendButton ( s . length ( ) > 0 ) ; < nl > + } < nl > + } < nl > < nl > + public void checkSendButton ( ) { < nl > + checkSendButton ( messageEditText . getText ( ) . length ( ) > 0 ) ; < nl > + } < nl > < nl > + public void checkSendButton ( boolean hasText ) { < nl > + if ( hasText | | ( currentQuote ! = null & & ! currentQuote . isEmpty ( ) ) ) { < nl > + sendButton . setTint ( ActorSDK . sharedActor ( ) . style . getConvSendEnabledColor ( ) ) ; < nl > + sendButton . setEnabled ( true ) ; < nl > + zoomInView ( sendButton ) ; < nl > + zoomOutView ( audioButton ) ; < nl > + } else { < nl > + sendButton . setTint ( ActorSDK . sharedActor ( ) . style . getConvSendDisabledColor ( ) ) ; < nl > + sendButton . setEnabled ( false ) ; < nl > + zoomInView ( audioButton ) ; < nl > + zoomOutView ( sendButton ) ; < nl > } < nl > } < nl > < nl > @ @ - 1401 , 6 + 1415 , 20 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > private boolean animationInProgress = false ; < nl > < nl > private void showShare ( ) { < nl > + if ( Build . VERSION . SDK _ INT > = Build . VERSION _ CODES . M ) { < nl > + if ( ContextCompat . checkSelfPermission ( ChatActivity . this , Manifest . permission . READ _ EXTERNAL _ STORAGE ) ! = PackageManager . PERMISSION _ GRANTED ) { < nl > + < nl > + ActivityCompat . requestPermissions ( ChatActivity . this , new String [ ] { Manifest . permission . READ _ EXTERNAL _ STORAGE } , PERMISSION _ REQ _ MEDIA ) ; < nl > + < nl > + } else { < nl > + showShareChecked ( ) ; < nl > + } < nl > + } else { < nl > + showShareChecked ( ) ; < nl > + } < nl > + } < nl > + < nl > + private void showShareChecked ( ) { < nl > if ( animationInProgress ) { < nl > return ; < nl > } < nl > @ @ - 1473 , 6 + 1501 , 11 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > & & grantResults [ 0 ] = = PackageManager . PERMISSION _ GRANTED ) { < nl > startCamera ( ) ; < nl > } < nl > + } else if ( requestCode = = PERMISSION _ REQ _ MEDIA ) { < nl > + if ( grantResults . length > 0 < nl > + & & grantResults [ 0 ] = = PackageManager . PERMISSION _ GRANTED ) { < nl > + showShareChecked ( ) ; < nl > + } < nl > } < nl > } < nl > } < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / auth / SignInFragment . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / auth / SignInFragment . java < nl > index bb9f5a3 . . e8104a8 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / auth / SignInFragment . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / auth / SignInFragment . java < nl > @ @ - 79 , 6 + 79 , 7 @ @ public class SignInFragment extends BaseAuthFragment { < nl > } < nl > < nl > codeEnterEditText = ( EditText ) v . findViewById ( R . id . et _ sms _ code _ enter ) ; < nl > + codeEnterEditText . setTextColor ( ActorSDK . sharedActor ( ) . style . getTextPrimaryColor ( ) ) ; < nl > codeEnterEditText . addTextChangedListener ( new TextWatcher ( ) { < nl > @ Override < nl > public void beforeTextChanged ( CharSequence s , int start , int count , int after ) { < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / values / styles . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / values / styles . xml < nl > index 4624f49 . . 946d8b8 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / res / values / styles . xml < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / values / styles . xml < nl > @ @ - 8 , 10 + 8 , 6 @ @ < nl > < style name = " AppToolbarTheme " parent = " Theme . AppCompat . Light . DarkActionBar " > < nl > < item name = " android : windowContentOverlay " > @ null < / item > < nl > < nl > - < item name = " colorControlNormal " > # ffffffff < / item > < nl > - < item name = " android : textColorPrimary " > # ffffffff < / item > < nl > - < item name = " android : colorControlNormal " > # ffffffff < / item > < nl > - < nl > < item name = " colorPrimary " > @ color / primary < / item > < nl > < item name = " colorPrimaryDark " > @ color / primary _ hovered < / item > < nl > < item name = " colorAccent " > @ color / accent < / item > < nl > diff - - git a / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java b / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java < nl > index 6d0acc9 . . ae014c0 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java < nl > @ @ - 74 , 8 + 74 , 12 @ @ public class GalleryScannerActor extends Actor { < nl > } < nl > < nl > private Cursor getQuery ( ) { < nl > - return context . getContentResolver ( ) . query ( uri , projection , null , < nl > - null , MediaStore . MediaColumns . DATE _ MODIFIED + " DESC " ) ; < nl > + try { < nl > + return context . getContentResolver ( ) . query ( uri , projection , null , < nl > + null , MediaStore . MediaColumns . DATE _ MODIFIED + " DESC " ) ; < nl > + } catch ( Exception e ) { < nl > + return null ; < nl > + } < nl > } < nl > < nl > private void scan ( ) {
NEAREST DIFF (one line): diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / AudioActorEx . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / AudioActorEx . java < nl > index 1a5bdbd . . ab63452 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / AudioActorEx . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / AudioActorEx . java < nl > @ @ - 33 , 7 + 33 , 7 @ @ public class AudioActorEx extends AndroidPlayerActor { < nl > < nl > mplayer = new MediaPlayer ( ) ; < nl > mplayer . setAudioStreamType ( AudioManager . STREAM _ VOICE _ CALL ) ; < nl > - / / mplayer . setDataSource ( context , Uri . parse ( " android . resource : / / " + context . getPackageName ( ) + " / " + R . raw . tone ) ) ; < nl > + mplayer . setDataSource ( context , Uri . parse ( " android . resource : / / " + context . getPackageName ( ) + " / " + R . raw . tone ) ) ; < nl > mplayer . prepare ( ) ; < nl > mplayer . setLooping ( true ) ; < nl > mplayer . start ( ) ; < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java < nl > index dc07f04 . . fa9298f 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java < nl > @ @ - 64 , 7 + 64 , 6 @ @ public class CallFragment extends BaseFragment { < nl > private Vibrator v ; < nl > private View answerContainer ; < nl > private Ringtone ringtone ; < nl > - private ActorRef toneActor ; < nl > private CallVM call ; < nl > private ActorRef timer ; < nl > private TextView timerTV ; < nl > @ @ - 160 , 7 + 159 , 7 @ @ public class CallFragment extends BaseFragment { < nl > initIncoming ( ) ; < nl > break ; < nl > case CALLING _ OUTGOING : < nl > - / / onConnecting ( ) ; < nl > + onConnecting ( ) ; < nl > break ; < nl > } < nl > } < nl > @ @ - 237 , 7 + 236 , 7 @ @ public class CallFragment extends BaseFragment { < nl > < nl > private void onAnswer ( ) { < nl > < nl > - / / onConnecting ( ) ; < nl > + onConnecting ( ) ; < nl > answerContainer . setVisibility ( View . INVISIBLE ) ; < nl > if ( ringtone ! = null ) { < nl > ringtone . stop ( ) ; < nl > @ @ - 261 , 64 + 260 , 6 @ @ public class CallFragment extends BaseFragment { < nl > < nl > < nl > public void onConnecting ( ) { < nl > - if ( toneActor = = null ) { < nl > - toneActor = ActorSystem . system ( ) . actorOf ( Props . create ( new ActorCreator ( ) { < nl > - @ Override < nl > - public AudioActorEx create ( ) { < nl > - return new AudioActorEx ( getActivity ( ) , new AudioPlayerActor . AudioPlayerCallback ( ) { < nl > - @ Override < nl > - public void onStart ( String fileName ) { < nl > - < nl > - } < nl > - < nl > - @ Override < nl > - public void onStop ( String fileName ) { < nl > - < nl > - } < nl > - < nl > - @ Override < nl > - public void onPause ( String fileName , float progress ) { < nl > - < nl > - } < nl > - < nl > - @ Override < nl > - public void onProgress ( String fileName , float progress ) { < nl > - < nl > - } < nl > - < nl > - @ Override < nl > - public void onError ( String fileName ) { < nl > - < nl > - } < nl > - } ) ; < nl > - } < nl > - } ) , " actor / android _ tone " ) ; < nl > - } < nl > - < nl > - toneActor . send ( new AndroidPlayerActor . Play ( " " ) ) ; < nl > - < nl > - < nl > - vibrate = true ; < nl > - new Thread ( new Runnable ( ) { < nl > - @ Override < nl > - public void run ( ) { < nl > - while ( vibrate ) { < nl > - try { < nl > - v . vibrate ( 10 ) ; < nl > - Thread . sleep ( 5 ) ; < nl > - v . vibrate ( 10 ) ; < nl > - Thread . sleep ( 200 ) ; < nl > - v . vibrate ( 10 ) ; < nl > - Thread . sleep ( 5 ) ; < nl > - v . vibrate ( 10 ) ; < nl > - Thread . sleep ( 600 ) ; < nl > - } catch ( InterruptedException e ) { < nl > - e . printStackTrace ( ) ; < nl > - } < nl > - } < nl > - } < nl > - } ) . start ( ) ; < nl > - < nl > powerManager = ( PowerManager ) getActivity ( ) . getSystemService ( Context . POWER _ SERVICE ) ; < nl > wakeLock = powerManager . newWakeLock ( field , getActivity ( ) . getLocalClassName ( ) ) ; < nl > < nl > @ @ - 329 , 9 + 270 , 6 @ @ public class CallFragment extends BaseFragment { < nl > < nl > < nl > public void onConnected ( ) { < nl > - if ( toneActor ! = null ) { < nl > - toneActor . send ( new AndroidPlayerActor . Stop ( ) ) ; < nl > - } < nl > vibrate = false ; < nl > v . cancel ( ) ; < nl > v . vibrate ( 200 ) ; < nl > @ @ - 339 , 9 + 277 , 6 @ @ public class CallFragment extends BaseFragment { < nl > } < nl > < nl > public void onCallEnd ( ) { < nl > - if ( toneActor ! = null ) { < nl > - toneActor . send ( new AndroidPlayerActor . Stop ( ) ) ; < nl > - } < nl > vibrate = false ; < nl > if ( ringtone ! = null ) { < nl > ringtone . stop ( ) ; < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / core / AndroidCallProvider . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / core / AndroidCallProvider . java < nl > index 09a946c . . 661e59e 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / core / AndroidCallProvider . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / core / AndroidCallProvider . java < nl > @ @ - 5 , 12 + 5 , 21 @ @ import android . content . Intent ; < nl > < nl > import im . actor . core . providers . CallsProvider ; < nl > import im . actor . core . viewmodel . CallState ; < nl > + import im . actor . runtime . actors . ActorCreator ; < nl > + import im . actor . runtime . actors . ActorRef ; < nl > + import im . actor . runtime . actors . ActorSystem ; < nl > + import im . actor . runtime . actors . Props ; < nl > import im . actor . sdk . ActorSDK ; < nl > + import im . actor . sdk . controllers . calls . AudioActorEx ; < nl > import im . actor . sdk . controllers . calls . CallActivity ; < nl > + import im . actor . sdk . core . audio . AndroidPlayerActor ; < nl > + import im . actor . sdk . core . audio . AudioPlayerActor ; < nl > < nl > import static im . actor . sdk . util . ActorSDKMessenger . messenger ; < nl > < nl > public class AndroidCallProvider implements CallsProvider { < nl > + private ActorRef toneActor ; < nl > + < nl > < nl > @ Override < nl > public void onCallStart ( long callId ) { < nl > @ @ - 29 , 16 + 38 , 52 @ @ public class AndroidCallProvider implements CallsProvider { < nl > < nl > @ Override < nl > public void onCallEnd ( long callId ) { < nl > - messenger ( ) . getCall ( callId ) . getState ( ) . change ( CallState . ENDED ) ; < nl > + < nl > } < nl > < nl > @ Override < nl > public void startOutgoingBeep ( ) { < nl > - / / TODO : Implement < nl > + if ( toneActor = = null ) { < nl > + toneActor = ActorSystem . system ( ) . actorOf ( Props . create ( new ActorCreator ( ) { < nl > + @ Override < nl > + public AudioActorEx create ( ) { < nl > + return new AudioActorEx ( messenger ( ) . getContext ( ) , new AudioPlayerActor . AudioPlayerCallback ( ) { < nl > + @ Override < nl > + public void onStart ( String fileName ) { < nl > + < nl > + } < nl > + < nl > + @ Override < nl > + public void onStop ( String fileName ) { < nl > + < nl > + } < nl > + < nl > + @ Override < nl > + public void onPause ( String fileName , float progress ) { < nl > + < nl > + } < nl > + < nl > + @ Override < nl > + public void onProgress ( String fileName , float progress ) { < nl > + < nl > + } < nl > + < nl > + @ Override < nl > + public void onError ( String fileName ) { < nl > + < nl > + } < nl > + } ) ; < nl > + } < nl > + } ) , " actor / android _ tone " ) ; < nl > + } < nl > + < nl > + toneActor . send ( new AndroidPlayerActor . Play ( " " ) ) ; < nl > } < nl > < nl > @ Override < nl > public void stopOutgoingBeep ( ) { < nl > - / / TODO : Implement < nl > + if ( toneActor ! = null ) { < nl > + toneActor . send ( new AudioActorEx . Stop ( ) ) ; < nl > + } < nl > } < nl > } < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / raw / tone . wav b / actor - sdk / sdk - core - android / android - sdk / src / main / res / raw / tone . wav < nl > new file mode 100644 < nl > index 0000000 . . 65f98cb < nl > Binary files / dev / null and b / actor - sdk / sdk - core - android / android - sdk / src / main / res / raw / tone . wav differ

TEST DIFF:
diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java 
 index 320137d . . fde98dc 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java 
 @ @ - 13 , 6 + 13 , 7 @ @ import android . graphics . Color ; 
 import android . graphics . PorterDuff ; 
 import android . media . MediaScannerConnection ; 
 import android . net . Uri ; 
 + import android . os . Build ; 
 import android . os . Bundle ; 
 import android . os . Environment ; 
 import android . provider . ContactsContract ; 
 @ @ - 113 , 6 + 114 , 7 @ @ public class ChatActivity extends ActorEditTextActivity { 
 private static final int PERMISSIONS _ REQUEST _ CAMERA = 6 ; 
 private static final int PERMISSION _ REQUEST _ RECORD _ AUDIO = 7 ; 
 private static final int PERMISSIONS _ REQUEST _ FOR _ CALL = 8 ; 
 + private static final int PERMISSION _ REQ _ MEDIA = 11 ; 
 / / Peer of current chat 
 private Peer peer ; 
 
 @ @ - 294 , 6 + 296 , 7 @ @ public class ChatActivity extends ActorEditTextActivity { 
 messageEditText . setText ( " " ) ; 
 } 
 textEditing = false ; 
 + checkSendButton ( ) ; 
 
 } 
 } ) ; 
 @ @ - 797 , 6 + 800 , 7 @ @ public class ChatActivity extends ActorEditTextActivity { 
 } 
 } ) ; 
 goneView ( quoteContainer ) ; 
 + checkSendButton ( ) ; 
 textEditing = false ; 
 } else { 
 messenger ( ) . sendMessage ( peer , rawText ) ; 
 @ @ - 1077 , 6 + 1081 , 8 @ @ public class ChatActivity extends ActorEditTextActivity { 
 hideShare ( ) ; 
 quoteText . setCompoundDrawablesWithIntrinsicBounds ( getResources ( ) . getDrawable ( R . drawable . ic _ editor _ format _ quote _ gray ) , null , null , null ) ; 
 showView ( quoteContainer ) ; 
 + checkSendButton ( ) ; 
 + 
 } 
 
 / / Back button handling 
 @ @ - 1085 , 6 + 1091 , 8 @ @ public class ChatActivity extends ActorEditTextActivity { 
 public void onBackPressed ( ) { 
 if ( isMentionsVisible ) { 
 hideMentions ( ) ; 
 + } else if ( isShareVisible ) { 
 + hideShare ( ) ; 
 } else if ( emojiKeyboard . isShowing ( ) ) { 
 emojiKeyboard . dismiss ( ) ; 
 } else { 
 @ @ - 1243 , 7 + 1251 , 7 @ @ public class ChatActivity extends ActorEditTextActivity { 
 messageEditText . setText ( text ) ; 
 hideShare ( ) ; 
 showView ( quoteContainer ) ; 
 - 
 + / / we don ' t force check send button here , because it forces from text watcher 
 } 
 
 private class TextWatcherImp implements TextWatcher { 
 @ @ - 1308 , 19 + 1316 , 25 @ @ public class ChatActivity extends ActorEditTextActivity { 
 
 @ Override 
 public void afterTextChanged ( Editable s ) { 
 - if ( s . length ( ) > 0 ) { 
 - sendButton . setTint ( ActorSDK . sharedActor ( ) . style . getConvSendEnabledColor ( ) ) ; 
 - sendButton . setEnabled ( true ) ; 
 - zoomInView ( sendButton ) ; 
 - zoomOutView ( audioButton ) ; 
 - } else { 
 - sendButton . setTint ( ActorSDK . sharedActor ( ) . style . getConvSendDisabledColor ( ) ) ; 
 - sendButton . setEnabled ( false ) ; 
 - zoomInView ( audioButton ) ; 
 - zoomOutView ( sendButton ) ; 
 - } 
 + checkSendButton ( s . length ( ) > 0 ) ; 
 + } 
 + } 
 
 + public void checkSendButton ( ) { 
 + checkSendButton ( messageEditText . getText ( ) . length ( ) > 0 ) ; 
 + } 
 
 + public void checkSendButton ( boolean hasText ) { 
 + if ( hasText | | ( currentQuote ! = null & & ! currentQuote . isEmpty ( ) ) ) { 
 + sendButton . setTint ( ActorSDK . sharedActor ( ) . style . getConvSendEnabledColor ( ) ) ; 
 + sendButton . setEnabled ( true ) ; 
 + zoomInView ( sendButton ) ; 
 + zoomOutView ( audioButton ) ; 
 + } else { 
 + sendButton . setTint ( ActorSDK . sharedActor ( ) . style . getConvSendDisabledColor ( ) ) ; 
 + sendButton . setEnabled ( false ) ; 
 + zoomInView ( audioButton ) ; 
 + zoomOutView ( sendButton ) ; 
 } 
 } 
 
 @ @ - 1401 , 6 + 1415 , 20 @ @ public class ChatActivity extends ActorEditTextActivity { 
 private boolean animationInProgress = false ; 
 
 private void showShare ( ) { 
 + if ( Build . VERSION . SDK _ INT > = Build . VERSION _ CODES . M ) { 
 + if ( ContextCompat . checkSelfPermission ( ChatActivity . this , Manifest . permission . READ _ EXTERNAL _ STORAGE ) ! = PackageManager . PERMISSION _ GRANTED ) { 
 + 
 + ActivityCompat . requestPermissions ( ChatActivity . this , new String [ ] { Manifest . permission . READ _ EXTERNAL _ STORAGE } , PERMISSION _ REQ _ MEDIA ) ; 
 + 
 + } else { 
 + showShareChecked ( ) ; 
 + } 
 + } else { 
 + showShareChecked ( ) ; 
 + } 
 + } 
 + 
 + private void showShareChecked ( ) { 
 if ( animationInProgress ) { 
 return ; 
 } 
 @ @ - 1473 , 6 + 1501 , 11 @ @ public class ChatActivity extends ActorEditTextActivity { 
 & & grantResults [ 0 ] = = PackageManager . PERMISSION _ GRANTED ) { 
 startCamera ( ) ; 
 } 
 + } else if ( requestCode = = PERMISSION _ REQ _ MEDIA ) { 
 + if ( grantResults . length > 0 
 + & & grantResults [ 0 ] = = PackageManager . PERMISSION _ GRANTED ) { 
 + showShareChecked ( ) ; 
 + } 
 } 
 } 
 } 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / auth / SignInFragment . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / auth / SignInFragment . java 
 index bb9f5a3 . . e8104a8 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / auth / SignInFragment . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / auth / SignInFragment . java 
 @ @ - 79 , 6 + 79 , 7 @ @ public class SignInFragment extends BaseAuthFragment { 
 } 
 
 codeEnterEditText = ( EditText ) v . findViewById ( R . id . et _ sms _ code _ enter ) ; 
 + codeEnterEditText . setTextColor ( ActorSDK . sharedActor ( ) . style . getTextPrimaryColor ( ) ) ; 
 codeEnterEditText . addTextChangedListener ( new TextWatcher ( ) { 
 @ Override 
 public void beforeTextChanged ( CharSequence s , int start , int count , int after ) { 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / values / styles . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / values / styles . xml 
 index 4624f49 . . 946d8b8 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / res / values / styles . xml 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / values / styles . xml 
 @ @ - 8 , 10 + 8 , 6 @ @ 
 < style name = " AppToolbarTheme " parent = " Theme . AppCompat . Light . DarkActionBar " > 
 < item name = " android : windowContentOverlay " > @ null < / item > 
 
 - < item name = " colorControlNormal " > # ffffffff < / item > 
 - < item name = " android : textColorPrimary " > # ffffffff < / item > 
 - < item name = " android : colorControlNormal " > # ffffffff < / item > 
 - 
 < item name = " colorPrimary " > @ color / primary < / item > 
 < item name = " colorPrimaryDark " > @ color / primary _ hovered < / item > 
 < item name = " colorAccent " > @ color / accent < / item > 
 diff - - git a / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java b / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java 
 index 6d0acc9 . . ae014c0 100644 
 - - - a / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java 
 + + + b / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java 
 @ @ - 74 , 8 + 74 , 12 @ @ public class GalleryScannerActor extends Actor { 
 } 
 
 private Cursor getQuery ( ) { 
 - return context . getContentResolver ( ) . query ( uri , projection , null , 
 - null , MediaStore . MediaColumns . DATE _ MODIFIED + " DESC " ) ; 
 + try { 
 + return context . getContentResolver ( ) . query ( uri , projection , null , 
 + null , MediaStore . MediaColumns . DATE _ MODIFIED + " DESC " ) ; 
 + } catch ( Exception e ) { 
 + return null ; 
 + } 
 } 
 
 private void scan ( ) {

NEAREST DIFF:
diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / AudioActorEx . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / AudioActorEx . java 
 index 1a5bdbd . . ab63452 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / AudioActorEx . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / AudioActorEx . java 
 @ @ - 33 , 7 + 33 , 7 @ @ public class AudioActorEx extends AndroidPlayerActor { 
 
 mplayer = new MediaPlayer ( ) ; 
 mplayer . setAudioStreamType ( AudioManager . STREAM _ VOICE _ CALL ) ; 
 - / / mplayer . setDataSource ( context , Uri . parse ( " android . resource : / / " + context . getPackageName ( ) + " / " + R . raw . tone ) ) ; 
 + mplayer . setDataSource ( context , Uri . parse ( " android . resource : / / " + context . getPackageName ( ) + " / " + R . raw . tone ) ) ; 
 mplayer . prepare ( ) ; 
 mplayer . setLooping ( true ) ; 
 mplayer . start ( ) ; 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java 
 index dc07f04 . . fa9298f 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java 
 @ @ - 64 , 7 + 64 , 6 @ @ public class CallFragment extends BaseFragment { 
 private Vibrator v ; 
 private View answerContainer ; 
 private Ringtone ringtone ; 
 - private ActorRef toneActor ; 
 private CallVM call ; 
 private ActorRef timer ; 
 private TextView timerTV ; 
 @ @ - 160 , 7 + 159 , 7 @ @ public class CallFragment extends BaseFragment { 
 initIncoming ( ) ; 
 break ; 
 case CALLING _ OUTGOING : 
 - / / onConnecting ( ) ; 
 + onConnecting ( ) ; 
 break ; 
 } 
 } 
 @ @ - 237 , 7 + 236 , 7 @ @ public class CallFragment extends BaseFragment { 
 
 private void onAnswer ( ) { 
 
 - / / onConnecting ( ) ; 
 + onConnecting ( ) ; 
 answerContainer . setVisibility ( View . INVISIBLE ) ; 
 if ( ringtone ! = null ) { 
 ringtone . stop ( ) ; 
 @ @ - 261 , 64 + 260 , 6 @ @ public class CallFragment extends BaseFragment { 
 
 
 public void onConnecting ( ) { 
 - if ( toneActor = = null ) { 
 - toneActor = ActorSystem . system ( ) . actorOf ( Props . create ( new ActorCreator ( ) { 
 - @ Override 
 - public AudioActorEx create ( ) { 
 - return new AudioActorEx ( getActivity ( ) , new AudioPlayerActor . AudioPlayerCallback ( ) { 
 - @ Override 
 - public void onStart ( String fileName ) { 
 - 
 - } 
 - 
 - @ Override 
 - public void onStop ( String fileName ) { 
 - 
 - } 
 - 
 - @ Override 
 - public void onPause ( String fileName , float progress ) { 
 - 
 - } 
 - 
 - @ Override 
 - public void onProgress ( String fileName , float progress ) { 
 - 
 - } 
 - 
 - @ Override 
 - public void onError ( String fileName ) { 
 - 
 - } 
 - } ) ; 
 - } 
 - } ) , " actor / android _ tone " ) ; 
 - } 
 - 
 - toneActor . send ( new AndroidPlayerActor . Play ( " " ) ) ; 
 - 
 - 
 - vibrate = true ; 
 - new Thread ( new Runnable ( ) { 
 - @ Override 
 - public void run ( ) { 
 - while ( vibrate ) { 
 - try { 
 - v . vibrate ( 10 ) ; 
 - Thread . sleep ( 5 ) ; 
 - v . vibrate ( 10 ) ; 
 - Thread . sleep ( 200 ) ; 
 - v . vibrate ( 10 ) ; 
 - Thread . sleep ( 5 ) ; 
 - v . vibrate ( 10 ) ; 
 - Thread . sleep ( 600 ) ; 
 - } catch ( InterruptedException e ) { 
 - e . printStackTrace ( ) ; 
 - } 
 - } 
 - } 
 - } ) . start ( ) ; 
 - 
 powerManager = ( PowerManager ) getActivity ( ) . getSystemService ( Context . POWER _ SERVICE ) ; 
 wakeLock = powerManager . newWakeLock ( field , getActivity ( ) . getLocalClassName ( ) ) ; 
 
 @ @ - 329 , 9 + 270 , 6 @ @ public class CallFragment extends BaseFragment { 
 
 
 public void onConnected ( ) { 
 - if ( toneActor ! = null ) { 
 - toneActor . send ( new AndroidPlayerActor . Stop ( ) ) ; 
 - } 
 vibrate = false ; 
 v . cancel ( ) ; 
 v . vibrate ( 200 ) ; 
 @ @ - 339 , 9 + 277 , 6 @ @ public class CallFragment extends BaseFragment { 
 } 
 
 public void onCallEnd ( ) { 
 - if ( toneActor ! = null ) { 
 - toneActor . send ( new AndroidPlayerActor . Stop ( ) ) ; 
 - } 
 vibrate = false ; 
 if ( ringtone ! = null ) { 
 ringtone . stop ( ) ; 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / core / AndroidCallProvider . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / core / AndroidCallProvider . java 
 index 09a946c . . 661e59e 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / core / AndroidCallProvider . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / core / AndroidCallProvider . java 
 @ @ - 5 , 12 + 5 , 21 @ @ import android . content . Intent ; 
 
 import im . actor . core . providers . CallsProvider ; 
 import im . actor . core . viewmodel . CallState ; 
 + import im . actor . runtime . actors . ActorCreator ; 
 + import im . actor . runtime . actors . ActorRef ; 
 + import im . actor . runtime . actors . ActorSystem ; 
 + import im . actor . runtime . actors . Props ; 
 import im . actor . sdk . ActorSDK ; 
 + import im . actor . sdk . controllers . calls . AudioActorEx ; 
 import im . actor . sdk . controllers . calls . CallActivity ; 
 + import im . actor . sdk . core . audio . AndroidPlayerActor ; 
 + import im . actor . sdk . core . audio . AudioPlayerActor ; 
 
 import static im . actor . sdk . util . ActorSDKMessenger . messenger ; 
 
 public class AndroidCallProvider implements CallsProvider { 
 + private ActorRef toneActor ; 
 + 
 
 @ Override 
 public void onCallStart ( long callId ) { 
 @ @ - 29 , 16 + 38 , 52 @ @ public class AndroidCallProvider implements CallsProvider { 
 
 @ Override 
 public void onCallEnd ( long callId ) { 
 - messenger ( ) . getCall ( callId ) . getState ( ) . change ( CallState . ENDED ) ; 
 + 
 } 
 
 @ Override 
 public void startOutgoingBeep ( ) { 
 - / / TODO : Implement 
 + if ( toneActor = = null ) { 
 + toneActor = ActorSystem . system ( ) . actorOf ( Props . create ( new ActorCreator ( ) { 
 + @ Override 
 + public AudioActorEx create ( ) { 
 + return new AudioActorEx ( messenger ( ) . getContext ( ) , new AudioPlayerActor . AudioPlayerCallback ( ) { 
 + @ Override 
 + public void onStart ( String fileName ) { 
 + 
 + } 
 + 
 + @ Override 
 + public void onStop ( String fileName ) { 
 + 
 + } 
 + 
 + @ Override 
 + public void onPause ( String fileName , float progress ) { 
 + 
 + } 
 + 
 + @ Override 
 + public void onProgress ( String fileName , float progress ) { 
 + 
 + } 
 + 
 + @ Override 
 + public void onError ( String fileName ) { 
 + 
 + } 
 + } ) ; 
 + } 
 + } ) , " actor / android _ tone " ) ; 
 + } 
 + 
 + toneActor . send ( new AndroidPlayerActor . Play ( " " ) ) ; 
 } 
 
 @ Override 
 public void stopOutgoingBeep ( ) { 
 - / / TODO : Implement 
 + if ( toneActor ! = null ) { 
 + toneActor . send ( new AudioActorEx . Stop ( ) ) ; 
 + } 
 } 
 } 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / raw / tone . wav b / actor - sdk / sdk - core - android / android - sdk / src / main / res / raw / tone . wav 
 new file mode 100644 
 index 0000000 . . 65f98cb 
 Binary files / dev / null and b / actor - sdk / sdk - core - android / android - sdk / src / main / res / raw / tone . wav differ
