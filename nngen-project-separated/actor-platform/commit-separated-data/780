BLEU SCORE: 0.2626909894424158

TEST MSG: fix ( android ) : fix wakelock creation / release
GENERATED MSG: feat ( android ) : chat unread counter

TEST DIFF (one line): diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java < nl > index 35e1965 . . f391539 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java < nl > @ @ - 83 , 6 + 83 , 7 @ @ public class CallFragment extends BaseFragment { < nl > private NotificationManager manager ; < nl > private CallState currentState ; < nl > private ImageButton endCall ; < nl > + private View endCallContainer ; < nl > private boolean speakerOn = false ; < nl > private AudioManager audioManager ; < nl > private AvatarView avatarView ; < nl > @ @ - 125 , 14 + 126 , 14 @ @ public class CallFragment extends BaseFragment { < nl > / / ) ; < nl > < nl > avatarLayers = new View [ ] { < nl > - cont . findViewById ( R . id . layer ) , < nl > + / / cont . findViewById ( R . id . layer ) , < nl > cont . findViewById ( R . id . layer1 ) , < nl > cont . findViewById ( R . id . layer2 ) , < nl > cont . findViewById ( R . id . layer3 ) , < nl > - cont . findViewById ( R . id . layer4 ) < nl > + / / cont . findViewById ( R . id . layer4 ) < nl > } ; < nl > < nl > - wave ( avatarLayers , 1 . 1f , 1200 , 200 ) ; < nl > + wave ( avatarLayers , 1 . 5f , 1900 , - 2f ) ; < nl > < nl > for ( int i = 0 ; i < avatarLayers . length ; i + + ) { < nl > View layer = avatarLayers [ i ] ; < nl > @ @ - 140 , 6 + 141 , 7 @ @ public class CallFragment extends BaseFragment { < nl > ( ( GradientDrawable ) layer . getBackground ( ) ) . setAlpha ( 50 ) ; < nl > } < nl > < nl > + endCallContainer = cont . findViewById ( R . id . end _ call _ container ) ; < nl > answerContainer = cont . findViewById ( R . id . answer _ container ) ; < nl > ImageButton answer = ( ImageButton ) cont . findViewById ( R . id . answer ) ; < nl > answer . setOnClickListener ( new View . OnClickListener ( ) { < nl > @ @ - 404 , 7 + 406 , 7 @ @ public class CallFragment extends BaseFragment { < nl > < nl > private void initIncoming ( ) { < nl > answerContainer . setVisibility ( View . VISIBLE ) ; < nl > - endCall . setVisibility ( View . INVISIBLE ) ; < nl > + endCallContainer . setVisibility ( View . GONE ) ; < nl > < nl > new Thread ( new Runnable ( ) { < nl > @ Override < nl > @ @ - 429 , 8 + 431 , 8 @ @ public class CallFragment extends BaseFragment { < nl > < nl > private void onAnswer ( ) { < nl > < nl > - endCall . setVisibility ( View . VISIBLE ) ; < nl > - answerContainer . setVisibility ( View . INVISIBLE ) ; < nl > + endCallContainer . setVisibility ( View . VISIBLE ) ; < nl > + answerContainer . setVisibility ( View . GONE ) ; < nl > if ( ringtone ! = null ) { < nl > ringtone . stop ( ) ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / BaseFragment . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / BaseFragment . java < nl > index ed702ab . . 6f90f77 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / BaseFragment . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / BaseFragment . java < nl > @ @ - 54 , 8 + 54 , 8 @ @ public class BaseFragment extends BinderCompatFragment { < nl > ViewUtils . showView ( view , isAnimated , isSlow ) ; < nl > } < nl > < nl > - public void wave ( View [ ] layers , float scale , int duration , int stepOffset ) { < nl > - ViewUtils . wave ( layers , scale , duration , stepOffset ) ; < nl > + public void wave ( View [ ] layers , float scale , int duration , float offset ) { < nl > + ViewUtils . wave ( layers , scale , duration , offset ) ; < nl > } < nl > < nl > public void elevateView ( View view ) { < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / util / OffsetCycleInterpolator . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / util / OffsetCycleInterpolator . java < nl > index e8b60fb . . 491ccfb 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / util / OffsetCycleInterpolator . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / util / OffsetCycleInterpolator . java < nl > @ @ - 20 , 6 + 20 , 6 @ @ public class OffsetCycleInterpolator extends CycleInterpolator { < nl > < nl > @ Override < nl > public float getInterpolation ( float input ) { < nl > - return ( float ) ( Math . sin ( 2 * Math . PI * input + offset ) ) ; < nl > + return ( float ) ( Math . sin ( 2 * Math . PI * input + offset ) ) + 1f ; < nl > } < nl > } < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / util / ViewUtils . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / util / ViewUtils . java < nl > index 4cfab50 . . 6ca4c40 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / util / ViewUtils . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / util / ViewUtils . java < nl > @ @ - 248 , 11 + 248 , 11 @ @ public class ViewUtils { < nl > } < nl > } < nl > < nl > - public static void wave ( View [ ] layers , float scale , int duration , int stepOffset ) { < nl > + public static void wave ( View [ ] layers , float scale , int duration , float offset ) { < nl > int step = 0 ; < nl > < nl > for ( View l : layers ) { < nl > - wave ( l , scale , duration , ( ( float ) 1 / layers . length ) * step ) ; < nl > + wave ( l , scale , duration , ( ( float ) 1 / layers . length ) * step * offset ) ; < nl > step + + ; < nl > } < nl > } < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml < nl > index 7cd8351 . . db88b95 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml < nl > @ @ - 32 , 8 + 32 , 8 @ @ < nl > < nl > < View < nl > android : id = " @ + id / layer " < nl > - android : layout _ width = " 100dp " < nl > - android : layout _ height = " 100dp " < nl > + android : layout _ width = " 82dp " < nl > + android : layout _ height = " 82dp " < nl > android : layout _ centerVertical = " true " < nl > android : layout _ centerHorizontal = " true " < nl > android : background = " @ drawable / call _ avatar _ background " / > < nl > @ @ - 63 , 6 + 63 , 7 @ @ < nl > android : background = " @ drawable / call _ avatar _ background " / > < nl > < nl > < View < nl > + android : visibility = " invisible " < nl > android : id = " @ + id / layer4 " < nl > android : layout _ width = " 162dp " < nl > android : layout _ height = " 162dp " < nl > @ @ - 115 , 47 + 116 , 6 @ @ < nl > android : orientation = " vertical " < nl > android : layout _ weight = " 1 " > < nl > < nl > - < LinearLayout < nl > - android : id = " @ + id / answer _ container " < nl > - android : visibility = " invisible " < nl > - android : layout _ width = " match _ parent " < nl > - android : layout _ height = " 60dp " < nl > - android : orientation = " horizontal " < nl > - android : layout _ gravity = " bottom " < nl > - android : layout _ marginBottom = " 20dp " > < nl > - < nl > - < FrameLayout < nl > - android : layout _ width = " 0dp " < nl > - android : layout _ weight = " 1 " < nl > - android : layout _ height = " 60dp " > < nl > - < nl > - < ImageButton < nl > - android : layout _ gravity = " center " < nl > - android : id = " @ + id / notAnswer " < nl > - android : layout _ width = " 60dp " < nl > - android : layout _ height = " 60dp " < nl > - android : src = " @ drawable / ic _ call _ end _ white _ 36dp " < nl > - android : background = " @ drawable / end _ call _ background " / > < nl > - < nl > - < / FrameLayout > < nl > - < nl > - < FrameLayout < nl > - android : layout _ width = " 0dp " < nl > - android : layout _ weight = " 1 " < nl > - android : layout _ height = " 60dp " > < nl > - < nl > - < ImageButton < nl > - android : layout _ gravity = " center " < nl > - android : id = " @ + id / answer " < nl > - android : layout _ width = " 60dp " < nl > - android : layout _ height = " 60dp " < nl > - android : background = " @ drawable / answer _ background " < nl > - android : src = " @ drawable / ic _ call _ white _ 36dp " / > < nl > - < nl > - < / FrameLayout > < nl > - < nl > - < / LinearLayout > < nl > - < nl > < TableLayout < nl > android : paddingBottom = " 15dp " < nl > android : paddingLeft = " 10dp " < nl > @ @ - 246 , 6 + 206 , 7 @ @ < nl > < / TableRow > < nl > < nl > < TableRow < nl > + android : id = " @ + id / end _ call _ container " < nl > android : minHeight = " 110dp " < nl > android : layout _ weight = " 1 " < nl > android : gravity = " center " > < nl > @ @ - 316 , 6 + 277 , 54 @ @ < nl > < nl > < / TableRow > < nl > < nl > + < TableRow < nl > + android : minHeight = " 110dp " < nl > + android : layout _ weight = " 1 " < nl > + android : id = " @ + id / answer _ container " < nl > + android : visibility = " gone " < nl > + android : gravity = " center " > < nl > + < nl > + < LinearLayout < nl > + < nl > + android : layout _ width = " match _ parent " < nl > + android : layout _ height = " wrap _ content " < nl > + android : orientation = " horizontal " < nl > + android : layout _ column = " 0 " < nl > + android : layout _ span = " 3 " > < nl > + < nl > + < FrameLayout < nl > + android : layout _ width = " 0dp " < nl > + android : layout _ weight = " 1 " < nl > + android : layout _ height = " @ dimen / end _ call _ btn _ size " > < nl > + < nl > + < ImageButton < nl > + android : layout _ gravity = " center " < nl > + android : id = " @ + id / notAnswer " < nl > + android : layout _ width = " @ dimen / end _ call _ btn _ size " < nl > + android : layout _ height = " @ dimen / end _ call _ btn _ size " < nl > + android : src = " @ drawable / ic _ call _ end _ white _ 36dp " < nl > + android : background = " @ drawable / end _ call _ background " / > < nl > + < nl > + < / FrameLayout > < nl > + < nl > + < FrameLayout < nl > + android : layout _ width = " 0dp " < nl > + android : layout _ weight = " 1 " < nl > + android : layout _ height = " @ dimen / end _ call _ btn _ size " > < nl > + < nl > + < ImageButton < nl > + android : layout _ gravity = " center " < nl > + android : id = " @ + id / answer " < nl > + android : layout _ width = " @ dimen / end _ call _ btn _ size " < nl > + android : layout _ height = " @ dimen / end _ call _ btn _ size " < nl > + android : background = " @ drawable / answer _ background " < nl > + android : src = " @ drawable / ic _ call _ white _ 36dp " / > < nl > + < nl > + < / FrameLayout > < nl > + < nl > + < / LinearLayout > < nl > + < / TableRow > < nl > + < nl > < / TableLayout > < nl > < nl > < / FrameLayout > < nl > diff - - git a / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / power / AndroidWakeLock . java b / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / power / AndroidWakeLock . java < nl > index daca39f . . 5b43002 100644 < nl > - - - a / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / power / AndroidWakeLock . java < nl > + + + b / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / power / AndroidWakeLock . java < nl > @ @ - 8 , 26 + 8 , 20 @ @ import im . actor . runtime . power . WakeLock ; < nl > < nl > public class AndroidWakeLock implements WakeLock { < nl > < nl > - private static PowerManager . WakeLock wakeLock ; < nl > < nl > - static { < nl > + private final PowerManager . WakeLock wakeLock ; < nl > + < nl > + public AndroidWakeLock ( ) { < nl > PowerManager powerManager = ( PowerManager ) AndroidContext . getContext ( ) . getSystemService ( Context . POWER _ SERVICE ) ; < nl > wakeLock = powerManager . newWakeLock ( PowerManager . PARTIAL _ WAKE _ LOCK , < nl > " ActorWakelock " ) ; < nl > - } < nl > - < nl > - public AndroidWakeLock ( ) { < nl > - acquire ( ) ; < nl > + wakeLock . acquire ( ) ; < nl > } < nl > < nl > @ Override < nl > public void releaseLock ( ) { < nl > - wakeLock . release ( ) ; < nl > - } < nl > - < nl > - private static void acquire ( ) { < nl > - if ( ! wakeLock . isHeld ( ) ) { < nl > - wakeLock . acquire ( ) ; < nl > + if ( wakeLock ! = null & & wakeLock . isHeld ( ) ) { < nl > + wakeLock . release ( ) ; < nl > } < nl > } < nl > }
NEAREST DIFF (one line): diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / activity / BaseActivity . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / activity / BaseActivity . java < nl > index 0379117 . . e40b240 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / activity / BaseActivity . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / activity / BaseActivity . java < nl > @ @ - 5 , 6 + 5 , 7 @ @ import android . graphics . drawable . ColorDrawable ; < nl > import android . os . Bundle ; < nl > import android . support . v7 . app . ActionBar ; < nl > import android . support . v7 . app . AppCompatActivity ; < nl > + import android . support . v7 . widget . Toolbar ; < nl > import android . view . View ; < nl > import android . widget . TextView ; < nl > < nl > @ @ - 71 , 6 + 72 , 10 @ @ public class BaseActivity extends AppCompatActivity { < nl > BINDER . bind ( textView , titleContainer , value ) ; < nl > } < nl > < nl > + public void bindGlobalCounter ( ValueChangedListener < Integer > callback ) { < nl > + BINDER . bindGlobalCounter ( callback ) ; < nl > + } < nl > + < nl > public void bindGroupTyping ( final TextView textView , final View container , final View titleContainer , final Value < int [ ] > typing ) { < nl > BINDER . bindGroupTyping ( textView , container , titleContainer , typing ) ; < nl > } < nl > @ @ - 131 , 12 + 136 , 17 @ @ public class BaseActivity extends AppCompatActivity { < nl > protected void setToolbar ( View view , ActionBar . LayoutParams params , boolean enableBack ) { < nl > getSupportActionBar ( ) . setDisplayShowCustomEnabled ( true ) ; < nl > getSupportActionBar ( ) . setDisplayHomeAsUpEnabled ( true ) ; < nl > - if ( enableBack ) { < nl > - getSupportActionBar ( ) . setDisplayShowHomeEnabled ( true ) ; < nl > - } < nl > getSupportActionBar ( ) . setDisplayShowTitleEnabled ( false ) ; < nl > getSupportActionBar ( ) . setDisplayUseLogoEnabled ( false ) ; < nl > getSupportActionBar ( ) . setCustomView ( view , params ) ; < nl > + if ( enableBack ) { < nl > + getSupportActionBar ( ) . setDisplayShowHomeEnabled ( true ) ; < nl > + } else { < nl > + getSupportActionBar ( ) . setDisplayShowHomeEnabled ( false ) ; < nl > + getSupportActionBar ( ) . setDisplayHomeAsUpEnabled ( false ) ; < nl > + Toolbar parent = ( Toolbar ) view . getParent ( ) ; < nl > + parent . setContentInsetsAbsolute ( 0 , 0 ) ; < nl > + } < nl > } < nl > < nl > protected void setToolbar ( View view , ActionBar . LayoutParams params ) { < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java < nl > index f4bb580 . . df168be 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java < nl > @ @ - 10 , 6 + 10 , 7 @ @ import android . content . pm . ApplicationInfo ; < nl > import android . content . pm . PackageManager ; < nl > import android . content . res . Configuration ; < nl > import android . database . Cursor ; < nl > + import android . graphics . PorterDuff ; < nl > import android . net . Uri ; < nl > import android . os . Bundle ; < nl > import android . provider . ContactsContract ; < nl > @ @ - 27 , 6 + 28 , 8 @ @ import android . view . Menu ; < nl > import android . view . MenuItem ; < nl > import android . view . MotionEvent ; < nl > import android . view . View ; < nl > + import android . view . ViewGroup ; < nl > + import android . view . ViewParent ; < nl > import android . view . animation . AlphaAnimation ; < nl > import android . view . animation . TranslateAnimation ; < nl > import android . widget . AdapterView ; < nl > @ @ - 55 , 6 + 58 , 7 @ @ import im . actor . runtime . actors . ActorSystem ; < nl > import im . actor . runtime . actors . Props ; < nl > import im . actor . runtime . actors . messages . PoisonPill ; < nl > import im . actor . sdk . ActorSDK ; < nl > + import im . actor . sdk . ActorStyle ; < nl > import im . actor . sdk . R ; < nl > import im . actor . sdk . controllers . Intents ; < nl > import im . actor . sdk . controllers . conversation . mentions . MentionsAdapter ; < nl > @ @ - 74 , 6 + 78 , 7 @ @ import im . actor . runtime . mvvm . ValueChangedListener ; < nl > import static im . actor . sdk . util . ViewUtils . expand ; < nl > import static im . actor . sdk . util . ViewUtils . expandMentions ; < nl > import static im . actor . sdk . util . ViewUtils . goneView ; < nl > + import static im . actor . sdk . util . ViewUtils . hideView ; < nl > import static im . actor . sdk . util . ViewUtils . showView ; < nl > import static im . actor . sdk . util . ViewUtils . zoomInView ; < nl > import static im . actor . sdk . util . ViewUtils . zoomOutView ; < nl > @ @ - 113 , 6 + 118 , 8 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / < nl > / / Toolbar views < nl > / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / < nl > + / / Toolbar unread counter < nl > + private TextView counter ; < nl > / / Toolbar Avatar view < nl > private AvatarView barAvatar ; < nl > / / Toolbar title view < nl > @ @ - 414 , 10 + 421 , 22 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > protected void onCreateToolbar ( ) { < nl > / / Loading Toolbar header views < nl > / / Binding to real data is performed in onResume method < nl > + ActorStyle style = ActorSDK . sharedActor ( ) . style ; < nl > barView = LayoutInflater . from ( this ) . inflate ( R . layout . bar _ conversation , null ) ; < nl > ActionBar . LayoutParams layout = new ActionBar . LayoutParams ( ActionBar . LayoutParams . MATCH _ PARENT , ActionBar . LayoutParams . MATCH _ PARENT ) ; < nl > - setToolbar ( barView , layout ) ; < nl > + setToolbar ( barView , layout , false ) ; < nl > + findViewById ( R . id . home ) . setOnClickListener ( new View . OnClickListener ( ) { < nl > + @ Override < nl > + public void onClick ( View v ) { < nl > + onBackPressed ( ) ; < nl > + } < nl > + } ) ; < nl > + < nl > + counter = ( TextView ) barView . findViewById ( R . id . counter ) ; < nl > < nl > + counter . setTextColor ( style . getDialogsCounterTextColor ( ) ) ; < nl > + counter . setBackgroundResource ( R . drawable . ic _ counter _ circle ) ; < nl > + counter . getBackground ( ) . setColorFilter ( style . getDialogsCounterBackgroundColor ( ) , PorterDuff . Mode . MULTIPLY ) ; < nl > barTitle = ( TextView ) barView . findViewById ( R . id . title ) ; < nl > barSubtitleContainer = barView . findViewById ( R . id . subtitleContainer ) ; < nl > barTypingIcon = ( ImageView ) barView . findViewById ( R . id . typingImage ) ; < nl > @ @ - 615 , 6 + 634 , 18 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > } < nl > } ) ; < nl > } < nl > + < nl > + bindGlobalCounter ( new ValueChangedListener < Integer > ( ) { < nl > + @ Override < nl > + public void onChanged ( Integer val , Value < Integer > valueModel ) { < nl > + if ( val > 0 ) { < nl > + counter . setText ( Integer . toString ( val ) ) ; < nl > + showView ( counter ) ; < nl > + } else { < nl > + hideView ( counter ) ; < nl > + } < nl > + } < nl > + } ) ; < nl > } < nl > < nl > @ Override < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / ActorBinder . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / ActorBinder . java < nl > index de76ed5 . . ba8f1cb 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / ActorBinder . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / ActorBinder . java < nl > @ @ - 41 , 6 + 41 , 10 @ @ public class ActorBinder { < nl > < nl > } < nl > < nl > + public void bindGlobalCounter ( ValueChangedListener < Integer > callback ) { < nl > + callback . onChanged ( messenger ( ) . getAppState ( ) . getGlobalCounter ( ) . get ( ) , messenger ( ) . getAppState ( ) . getGlobalCounter ( ) ) ; < nl > + bind ( messenger ( ) . getAppState ( ) . getGlobalCounter ( ) , callback ) ; < nl > + } < nl > < nl > public void bindGroupTyping ( final TextView textView , final View container , final View titleContainer , final Value < int [ ] > typing ) { < nl > bind ( typing , new ValueChangedListener < int [ ] > ( ) { < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / bar _ conversation . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / bar _ conversation . xml < nl > index c284f10 . . 1e5fe62 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / bar _ conversation . xml < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / bar _ conversation . xml < nl > @ @ - 5 , 71 + 5 , 105 @ @ < nl > - - > < nl > < nl > < LinearLayout xmlns : android = " http : / / schemas . android . com / apk / res / android " < nl > - android : id = " @ + id / titleContainer " < nl > android : layout _ width = " match _ parent " < nl > - android : layout _ height = " match _ parent " < nl > - android : background = " @ drawable / selector _ light " > < nl > + android : layout _ height = " match _ parent " > < nl > < nl > - < im . actor . sdk . view . avatar . AvatarView < nl > - android : id = " @ + id / avatarPreview " < nl > - android : layout _ width = " 32dp " < nl > - android : layout _ height = " 32dp " < nl > - android : layout _ gravity = " center _ vertical " < nl > - android : layout _ marginLeft = " 8dp " / > < nl > + < FrameLayout < nl > + android : id = " @ + id / home " < nl > + android : background = " @ drawable / selector _ light " < nl > + android : layout _ width = " ? attr / actionBarSize " < nl > + android : layout _ height = " match _ parent " > < nl > < nl > - < LinearLayout < nl > - android : layout _ width = " 0dp " < nl > - android : layout _ height = " match _ parent " < nl > - android : layout _ weight = " 1 " < nl > - android : gravity = " center _ vertical " < nl > - android : orientation = " vertical " < nl > - android : paddingLeft = " 8dp " > < nl > + < ImageView < nl > + < nl > + android : layout _ width = " wrap _ content " < nl > + android : layout _ height = " match _ parent " < nl > + android : src = " @ drawable / ic _ action _ navigation _ arrow _ back " < nl > + android : scaleType = " center " < nl > + android : layout _ gravity = " center _ vertical | center _ horizontal " / > < nl > < nl > < TextView < nl > - android : id = " @ + id / title " < nl > - android : layout _ width = " match _ parent " < nl > + android : layout _ marginTop = " 10dp " < nl > + android : layout _ marginRight = " 10dp " < nl > + android : layout _ gravity = " top | right " < nl > + android : id = " @ + id / counter " < nl > + android : layout _ width = " wrap _ content " < nl > android : layout _ height = " wrap _ content " < nl > - android : layout _ marginTop = " - 2dp " < nl > - android : ellipsize = " end " < nl > - android : lines = " 1 " < nl > - android : singleLine = " true " < nl > - android : textColor = " # ffffff " < nl > - android : textSize = " 18sp " / > < nl > - < nl > - < FrameLayout < nl > - android : id = " @ + id / subtitleContainer " < nl > - android : layout _ width = " match _ parent " < nl > - android : layout _ height = " wrap _ content " < nl > - android : layout _ marginTop = " - 4dp " < nl > - android : orientation = " horizontal " > < nl > + android : paddingLeft = " 4dp " < nl > + android : paddingRight = " 4dp " < nl > + android : gravity = " center " < nl > + android : textSize = " 12sp " < nl > + android : visibility = " invisible " / > < nl > + < nl > + < / FrameLayout > < nl > + < nl > + < LinearLayout < nl > + android : id = " @ + id / titleContainer " < nl > + android : layout _ width = " match _ parent " < nl > + android : layout _ height = " match _ parent " < nl > + android : background = " @ drawable / selector _ light " > < nl > + < nl > + < im . actor . sdk . view . avatar . AvatarView < nl > + android : id = " @ + id / avatarPreview " < nl > + android : layout _ width = " 32dp " < nl > + android : layout _ height = " 32dp " < nl > + android : layout _ gravity = " center _ vertical " < nl > + android : layout _ marginLeft = " 8dp " / > < nl > < nl > - < LinearLayout < nl > - android : id = " @ + id / typingContainer " < nl > + < LinearLayout < nl > + android : layout _ width = " 0dp " < nl > + android : layout _ height = " match _ parent " < nl > + android : layout _ weight = " 1 " < nl > + android : gravity = " center _ vertical " < nl > + android : orientation = " vertical " < nl > + android : paddingLeft = " 8dp " > < nl > + < nl > + < TextView < nl > + android : id = " @ + id / title " < nl > android : layout _ width = " match _ parent " < nl > android : layout _ height = " wrap _ content " < nl > + android : layout _ marginTop = " - 2dp " < nl > + android : ellipsize = " end " < nl > + android : lines = " 1 " < nl > + android : singleLine = " true " < nl > + android : textColor = " # ffffff " < nl > + android : textSize = " 18sp " / > < nl > + < nl > + < FrameLayout < nl > + android : id = " @ + id / subtitleContainer " < nl > + android : layout _ width = " match _ parent " < nl > + android : layout _ height = " wrap _ content " < nl > + android : layout _ marginTop = " - 4dp " < nl > android : orientation = " horizontal " > < nl > < nl > - < ImageView < nl > - android : id = " @ + id / typingImage " < nl > - android : layout _ width = " wrap _ content " < nl > + < LinearLayout < nl > + android : id = " @ + id / typingContainer " < nl > + android : layout _ width = " match _ parent " < nl > android : layout _ height = " wrap _ content " < nl > - android : layout _ gravity = " center _ vertical " < nl > - android : layout _ marginTop = " 2dp " / > < nl > + android : orientation = " horizontal " > < nl > + < nl > + < ImageView < nl > + android : id = " @ + id / typingImage " < nl > + android : layout _ width = " wrap _ content " < nl > + android : layout _ height = " wrap _ content " < nl > + android : layout _ gravity = " center _ vertical " < nl > + android : layout _ marginTop = " 2dp " / > < nl > + < nl > + < TextView < nl > + android : id = " @ + id / typing " < nl > + android : layout _ width = " match _ parent " < nl > + android : layout _ height = " wrap _ content " < nl > + android : textColor = " # ffffff " < nl > + android : textSize = " 13sp " / > < nl > + < / LinearLayout > < nl > < nl > < TextView < nl > - android : id = " @ + id / typing " < nl > + android : id = " @ + id / subtitle " < nl > android : layout _ width = " match _ parent " < nl > android : layout _ height = " wrap _ content " < nl > android : textColor = " # ffffff " < nl > android : textSize = " 13sp " / > < nl > - < / LinearLayout > < nl > - < nl > - < TextView < nl > - android : id = " @ + id / subtitle " < nl > - android : layout _ width = " match _ parent " < nl > - android : layout _ height = " wrap _ content " < nl > - android : textColor = " # ffffff " < nl > - android : textSize = " 13sp " / > < nl > - < / FrameLayout > < nl > + < / FrameLayout > < nl > + < / LinearLayout > < nl > < / LinearLayout > < nl > < / LinearLayout > < nl > \ No newline at end of file

TEST DIFF:
diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java 
 index 35e1965 . . f391539 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java 
 @ @ - 83 , 6 + 83 , 7 @ @ public class CallFragment extends BaseFragment { 
 private NotificationManager manager ; 
 private CallState currentState ; 
 private ImageButton endCall ; 
 + private View endCallContainer ; 
 private boolean speakerOn = false ; 
 private AudioManager audioManager ; 
 private AvatarView avatarView ; 
 @ @ - 125 , 14 + 126 , 14 @ @ public class CallFragment extends BaseFragment { 
 / / ) ; 
 
 avatarLayers = new View [ ] { 
 - cont . findViewById ( R . id . layer ) , 
 + / / cont . findViewById ( R . id . layer ) , 
 cont . findViewById ( R . id . layer1 ) , 
 cont . findViewById ( R . id . layer2 ) , 
 cont . findViewById ( R . id . layer3 ) , 
 - cont . findViewById ( R . id . layer4 ) 
 + / / cont . findViewById ( R . id . layer4 ) 
 } ; 
 
 - wave ( avatarLayers , 1 . 1f , 1200 , 200 ) ; 
 + wave ( avatarLayers , 1 . 5f , 1900 , - 2f ) ; 
 
 for ( int i = 0 ; i < avatarLayers . length ; i + + ) { 
 View layer = avatarLayers [ i ] ; 
 @ @ - 140 , 6 + 141 , 7 @ @ public class CallFragment extends BaseFragment { 
 ( ( GradientDrawable ) layer . getBackground ( ) ) . setAlpha ( 50 ) ; 
 } 
 
 + endCallContainer = cont . findViewById ( R . id . end _ call _ container ) ; 
 answerContainer = cont . findViewById ( R . id . answer _ container ) ; 
 ImageButton answer = ( ImageButton ) cont . findViewById ( R . id . answer ) ; 
 answer . setOnClickListener ( new View . OnClickListener ( ) { 
 @ @ - 404 , 7 + 406 , 7 @ @ public class CallFragment extends BaseFragment { 
 
 private void initIncoming ( ) { 
 answerContainer . setVisibility ( View . VISIBLE ) ; 
 - endCall . setVisibility ( View . INVISIBLE ) ; 
 + endCallContainer . setVisibility ( View . GONE ) ; 
 
 new Thread ( new Runnable ( ) { 
 @ Override 
 @ @ - 429 , 8 + 431 , 8 @ @ public class CallFragment extends BaseFragment { 
 
 private void onAnswer ( ) { 
 
 - endCall . setVisibility ( View . VISIBLE ) ; 
 - answerContainer . setVisibility ( View . INVISIBLE ) ; 
 + endCallContainer . setVisibility ( View . VISIBLE ) ; 
 + answerContainer . setVisibility ( View . GONE ) ; 
 if ( ringtone ! = null ) { 
 ringtone . stop ( ) ; 
 } 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / BaseFragment . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / BaseFragment . java 
 index ed702ab . . 6f90f77 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / BaseFragment . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / BaseFragment . java 
 @ @ - 54 , 8 + 54 , 8 @ @ public class BaseFragment extends BinderCompatFragment { 
 ViewUtils . showView ( view , isAnimated , isSlow ) ; 
 } 
 
 - public void wave ( View [ ] layers , float scale , int duration , int stepOffset ) { 
 - ViewUtils . wave ( layers , scale , duration , stepOffset ) ; 
 + public void wave ( View [ ] layers , float scale , int duration , float offset ) { 
 + ViewUtils . wave ( layers , scale , duration , offset ) ; 
 } 
 
 public void elevateView ( View view ) { 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / util / OffsetCycleInterpolator . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / util / OffsetCycleInterpolator . java 
 index e8b60fb . . 491ccfb 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / util / OffsetCycleInterpolator . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / util / OffsetCycleInterpolator . java 
 @ @ - 20 , 6 + 20 , 6 @ @ public class OffsetCycleInterpolator extends CycleInterpolator { 
 
 @ Override 
 public float getInterpolation ( float input ) { 
 - return ( float ) ( Math . sin ( 2 * Math . PI * input + offset ) ) ; 
 + return ( float ) ( Math . sin ( 2 * Math . PI * input + offset ) ) + 1f ; 
 } 
 } 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / util / ViewUtils . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / util / ViewUtils . java 
 index 4cfab50 . . 6ca4c40 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / util / ViewUtils . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / util / ViewUtils . java 
 @ @ - 248 , 11 + 248 , 11 @ @ public class ViewUtils { 
 } 
 } 
 
 - public static void wave ( View [ ] layers , float scale , int duration , int stepOffset ) { 
 + public static void wave ( View [ ] layers , float scale , int duration , float offset ) { 
 int step = 0 ; 
 
 for ( View l : layers ) { 
 - wave ( l , scale , duration , ( ( float ) 1 / layers . length ) * step ) ; 
 + wave ( l , scale , duration , ( ( float ) 1 / layers . length ) * step * offset ) ; 
 step + + ; 
 } 
 } 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml 
 index 7cd8351 . . db88b95 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml 
 @ @ - 32 , 8 + 32 , 8 @ @ 
 
 < View 
 android : id = " @ + id / layer " 
 - android : layout _ width = " 100dp " 
 - android : layout _ height = " 100dp " 
 + android : layout _ width = " 82dp " 
 + android : layout _ height = " 82dp " 
 android : layout _ centerVertical = " true " 
 android : layout _ centerHorizontal = " true " 
 android : background = " @ drawable / call _ avatar _ background " / > 
 @ @ - 63 , 6 + 63 , 7 @ @ 
 android : background = " @ drawable / call _ avatar _ background " / > 
 
 < View 
 + android : visibility = " invisible " 
 android : id = " @ + id / layer4 " 
 android : layout _ width = " 162dp " 
 android : layout _ height = " 162dp " 
 @ @ - 115 , 47 + 116 , 6 @ @ 
 android : orientation = " vertical " 
 android : layout _ weight = " 1 " > 
 
 - < LinearLayout 
 - android : id = " @ + id / answer _ container " 
 - android : visibility = " invisible " 
 - android : layout _ width = " match _ parent " 
 - android : layout _ height = " 60dp " 
 - android : orientation = " horizontal " 
 - android : layout _ gravity = " bottom " 
 - android : layout _ marginBottom = " 20dp " > 
 - 
 - < FrameLayout 
 - android : layout _ width = " 0dp " 
 - android : layout _ weight = " 1 " 
 - android : layout _ height = " 60dp " > 
 - 
 - < ImageButton 
 - android : layout _ gravity = " center " 
 - android : id = " @ + id / notAnswer " 
 - android : layout _ width = " 60dp " 
 - android : layout _ height = " 60dp " 
 - android : src = " @ drawable / ic _ call _ end _ white _ 36dp " 
 - android : background = " @ drawable / end _ call _ background " / > 
 - 
 - < / FrameLayout > 
 - 
 - < FrameLayout 
 - android : layout _ width = " 0dp " 
 - android : layout _ weight = " 1 " 
 - android : layout _ height = " 60dp " > 
 - 
 - < ImageButton 
 - android : layout _ gravity = " center " 
 - android : id = " @ + id / answer " 
 - android : layout _ width = " 60dp " 
 - android : layout _ height = " 60dp " 
 - android : background = " @ drawable / answer _ background " 
 - android : src = " @ drawable / ic _ call _ white _ 36dp " / > 
 - 
 - < / FrameLayout > 
 - 
 - < / LinearLayout > 
 - 
 < TableLayout 
 android : paddingBottom = " 15dp " 
 android : paddingLeft = " 10dp " 
 @ @ - 246 , 6 + 206 , 7 @ @ 
 < / TableRow > 
 
 < TableRow 
 + android : id = " @ + id / end _ call _ container " 
 android : minHeight = " 110dp " 
 android : layout _ weight = " 1 " 
 android : gravity = " center " > 
 @ @ - 316 , 6 + 277 , 54 @ @ 
 
 < / TableRow > 
 
 + < TableRow 
 + android : minHeight = " 110dp " 
 + android : layout _ weight = " 1 " 
 + android : id = " @ + id / answer _ container " 
 + android : visibility = " gone " 
 + android : gravity = " center " > 
 + 
 + < LinearLayout 
 + 
 + android : layout _ width = " match _ parent " 
 + android : layout _ height = " wrap _ content " 
 + android : orientation = " horizontal " 
 + android : layout _ column = " 0 " 
 + android : layout _ span = " 3 " > 
 + 
 + < FrameLayout 
 + android : layout _ width = " 0dp " 
 + android : layout _ weight = " 1 " 
 + android : layout _ height = " @ dimen / end _ call _ btn _ size " > 
 + 
 + < ImageButton 
 + android : layout _ gravity = " center " 
 + android : id = " @ + id / notAnswer " 
 + android : layout _ width = " @ dimen / end _ call _ btn _ size " 
 + android : layout _ height = " @ dimen / end _ call _ btn _ size " 
 + android : src = " @ drawable / ic _ call _ end _ white _ 36dp " 
 + android : background = " @ drawable / end _ call _ background " / > 
 + 
 + < / FrameLayout > 
 + 
 + < FrameLayout 
 + android : layout _ width = " 0dp " 
 + android : layout _ weight = " 1 " 
 + android : layout _ height = " @ dimen / end _ call _ btn _ size " > 
 + 
 + < ImageButton 
 + android : layout _ gravity = " center " 
 + android : id = " @ + id / answer " 
 + android : layout _ width = " @ dimen / end _ call _ btn _ size " 
 + android : layout _ height = " @ dimen / end _ call _ btn _ size " 
 + android : background = " @ drawable / answer _ background " 
 + android : src = " @ drawable / ic _ call _ white _ 36dp " / > 
 + 
 + < / FrameLayout > 
 + 
 + < / LinearLayout > 
 + < / TableRow > 
 + 
 < / TableLayout > 
 
 < / FrameLayout > 
 diff - - git a / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / power / AndroidWakeLock . java b / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / power / AndroidWakeLock . java 
 index daca39f . . 5b43002 100644 
 - - - a / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / power / AndroidWakeLock . java 
 + + + b / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / power / AndroidWakeLock . java 
 @ @ - 8 , 26 + 8 , 20 @ @ import im . actor . runtime . power . WakeLock ; 
 
 public class AndroidWakeLock implements WakeLock { 
 
 - private static PowerManager . WakeLock wakeLock ; 
 
 - static { 
 + private final PowerManager . WakeLock wakeLock ; 
 + 
 + public AndroidWakeLock ( ) { 
 PowerManager powerManager = ( PowerManager ) AndroidContext . getContext ( ) . getSystemService ( Context . POWER _ SERVICE ) ; 
 wakeLock = powerManager . newWakeLock ( PowerManager . PARTIAL _ WAKE _ LOCK , 
 " ActorWakelock " ) ; 
 - } 
 - 
 - public AndroidWakeLock ( ) { 
 - acquire ( ) ; 
 + wakeLock . acquire ( ) ; 
 } 
 
 @ Override 
 public void releaseLock ( ) { 
 - wakeLock . release ( ) ; 
 - } 
 - 
 - private static void acquire ( ) { 
 - if ( ! wakeLock . isHeld ( ) ) { 
 - wakeLock . acquire ( ) ; 
 + if ( wakeLock ! = null & & wakeLock . isHeld ( ) ) { 
 + wakeLock . release ( ) ; 
 } 
 } 
 }

NEAREST DIFF:
diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / activity / BaseActivity . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / activity / BaseActivity . java 
 index 0379117 . . e40b240 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / activity / BaseActivity . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / activity / BaseActivity . java 
 @ @ - 5 , 6 + 5 , 7 @ @ import android . graphics . drawable . ColorDrawable ; 
 import android . os . Bundle ; 
 import android . support . v7 . app . ActionBar ; 
 import android . support . v7 . app . AppCompatActivity ; 
 + import android . support . v7 . widget . Toolbar ; 
 import android . view . View ; 
 import android . widget . TextView ; 
 
 @ @ - 71 , 6 + 72 , 10 @ @ public class BaseActivity extends AppCompatActivity { 
 BINDER . bind ( textView , titleContainer , value ) ; 
 } 
 
 + public void bindGlobalCounter ( ValueChangedListener < Integer > callback ) { 
 + BINDER . bindGlobalCounter ( callback ) ; 
 + } 
 + 
 public void bindGroupTyping ( final TextView textView , final View container , final View titleContainer , final Value < int [ ] > typing ) { 
 BINDER . bindGroupTyping ( textView , container , titleContainer , typing ) ; 
 } 
 @ @ - 131 , 12 + 136 , 17 @ @ public class BaseActivity extends AppCompatActivity { 
 protected void setToolbar ( View view , ActionBar . LayoutParams params , boolean enableBack ) { 
 getSupportActionBar ( ) . setDisplayShowCustomEnabled ( true ) ; 
 getSupportActionBar ( ) . setDisplayHomeAsUpEnabled ( true ) ; 
 - if ( enableBack ) { 
 - getSupportActionBar ( ) . setDisplayShowHomeEnabled ( true ) ; 
 - } 
 getSupportActionBar ( ) . setDisplayShowTitleEnabled ( false ) ; 
 getSupportActionBar ( ) . setDisplayUseLogoEnabled ( false ) ; 
 getSupportActionBar ( ) . setCustomView ( view , params ) ; 
 + if ( enableBack ) { 
 + getSupportActionBar ( ) . setDisplayShowHomeEnabled ( true ) ; 
 + } else { 
 + getSupportActionBar ( ) . setDisplayShowHomeEnabled ( false ) ; 
 + getSupportActionBar ( ) . setDisplayHomeAsUpEnabled ( false ) ; 
 + Toolbar parent = ( Toolbar ) view . getParent ( ) ; 
 + parent . setContentInsetsAbsolute ( 0 , 0 ) ; 
 + } 
 } 
 
 protected void setToolbar ( View view , ActionBar . LayoutParams params ) { 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java 
 index f4bb580 . . df168be 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java 
 @ @ - 10 , 6 + 10 , 7 @ @ import android . content . pm . ApplicationInfo ; 
 import android . content . pm . PackageManager ; 
 import android . content . res . Configuration ; 
 import android . database . Cursor ; 
 + import android . graphics . PorterDuff ; 
 import android . net . Uri ; 
 import android . os . Bundle ; 
 import android . provider . ContactsContract ; 
 @ @ - 27 , 6 + 28 , 8 @ @ import android . view . Menu ; 
 import android . view . MenuItem ; 
 import android . view . MotionEvent ; 
 import android . view . View ; 
 + import android . view . ViewGroup ; 
 + import android . view . ViewParent ; 
 import android . view . animation . AlphaAnimation ; 
 import android . view . animation . TranslateAnimation ; 
 import android . widget . AdapterView ; 
 @ @ - 55 , 6 + 58 , 7 @ @ import im . actor . runtime . actors . ActorSystem ; 
 import im . actor . runtime . actors . Props ; 
 import im . actor . runtime . actors . messages . PoisonPill ; 
 import im . actor . sdk . ActorSDK ; 
 + import im . actor . sdk . ActorStyle ; 
 import im . actor . sdk . R ; 
 import im . actor . sdk . controllers . Intents ; 
 import im . actor . sdk . controllers . conversation . mentions . MentionsAdapter ; 
 @ @ - 74 , 6 + 78 , 7 @ @ import im . actor . runtime . mvvm . ValueChangedListener ; 
 import static im . actor . sdk . util . ViewUtils . expand ; 
 import static im . actor . sdk . util . ViewUtils . expandMentions ; 
 import static im . actor . sdk . util . ViewUtils . goneView ; 
 + import static im . actor . sdk . util . ViewUtils . hideView ; 
 import static im . actor . sdk . util . ViewUtils . showView ; 
 import static im . actor . sdk . util . ViewUtils . zoomInView ; 
 import static im . actor . sdk . util . ViewUtils . zoomOutView ; 
 @ @ - 113 , 6 + 118 , 8 @ @ public class ChatActivity extends ActorEditTextActivity { 
 / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / 
 / / Toolbar views 
 / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / 
 + / / Toolbar unread counter 
 + private TextView counter ; 
 / / Toolbar Avatar view 
 private AvatarView barAvatar ; 
 / / Toolbar title view 
 @ @ - 414 , 10 + 421 , 22 @ @ public class ChatActivity extends ActorEditTextActivity { 
 protected void onCreateToolbar ( ) { 
 / / Loading Toolbar header views 
 / / Binding to real data is performed in onResume method 
 + ActorStyle style = ActorSDK . sharedActor ( ) . style ; 
 barView = LayoutInflater . from ( this ) . inflate ( R . layout . bar _ conversation , null ) ; 
 ActionBar . LayoutParams layout = new ActionBar . LayoutParams ( ActionBar . LayoutParams . MATCH _ PARENT , ActionBar . LayoutParams . MATCH _ PARENT ) ; 
 - setToolbar ( barView , layout ) ; 
 + setToolbar ( barView , layout , false ) ; 
 + findViewById ( R . id . home ) . setOnClickListener ( new View . OnClickListener ( ) { 
 + @ Override 
 + public void onClick ( View v ) { 
 + onBackPressed ( ) ; 
 + } 
 + } ) ; 
 + 
 + counter = ( TextView ) barView . findViewById ( R . id . counter ) ; 
 
 + counter . setTextColor ( style . getDialogsCounterTextColor ( ) ) ; 
 + counter . setBackgroundResource ( R . drawable . ic _ counter _ circle ) ; 
 + counter . getBackground ( ) . setColorFilter ( style . getDialogsCounterBackgroundColor ( ) , PorterDuff . Mode . MULTIPLY ) ; 
 barTitle = ( TextView ) barView . findViewById ( R . id . title ) ; 
 barSubtitleContainer = barView . findViewById ( R . id . subtitleContainer ) ; 
 barTypingIcon = ( ImageView ) barView . findViewById ( R . id . typingImage ) ; 
 @ @ - 615 , 6 + 634 , 18 @ @ public class ChatActivity extends ActorEditTextActivity { 
 } 
 } ) ; 
 } 
 + 
 + bindGlobalCounter ( new ValueChangedListener < Integer > ( ) { 
 + @ Override 
 + public void onChanged ( Integer val , Value < Integer > valueModel ) { 
 + if ( val > 0 ) { 
 + counter . setText ( Integer . toString ( val ) ) ; 
 + showView ( counter ) ; 
 + } else { 
 + hideView ( counter ) ; 
 + } 
 + } 
 + } ) ; 
 } 
 
 @ Override 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / ActorBinder . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / ActorBinder . java 
 index de76ed5 . . ba8f1cb 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / ActorBinder . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / ActorBinder . java 
 @ @ - 41 , 6 + 41 , 10 @ @ public class ActorBinder { 
 
 } 
 
 + public void bindGlobalCounter ( ValueChangedListener < Integer > callback ) { 
 + callback . onChanged ( messenger ( ) . getAppState ( ) . getGlobalCounter ( ) . get ( ) , messenger ( ) . getAppState ( ) . getGlobalCounter ( ) ) ; 
 + bind ( messenger ( ) . getAppState ( ) . getGlobalCounter ( ) , callback ) ; 
 + } 
 
 public void bindGroupTyping ( final TextView textView , final View container , final View titleContainer , final Value < int [ ] > typing ) { 
 bind ( typing , new ValueChangedListener < int [ ] > ( ) { 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / bar _ conversation . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / bar _ conversation . xml 
 index c284f10 . . 1e5fe62 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / bar _ conversation . xml 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / bar _ conversation . xml 
 @ @ - 5 , 71 + 5 , 105 @ @ 
 - - > 
 
 < LinearLayout xmlns : android = " http : / / schemas . android . com / apk / res / android " 
 - android : id = " @ + id / titleContainer " 
 android : layout _ width = " match _ parent " 
 - android : layout _ height = " match _ parent " 
 - android : background = " @ drawable / selector _ light " > 
 + android : layout _ height = " match _ parent " > 
 
 - < im . actor . sdk . view . avatar . AvatarView 
 - android : id = " @ + id / avatarPreview " 
 - android : layout _ width = " 32dp " 
 - android : layout _ height = " 32dp " 
 - android : layout _ gravity = " center _ vertical " 
 - android : layout _ marginLeft = " 8dp " / > 
 + < FrameLayout 
 + android : id = " @ + id / home " 
 + android : background = " @ drawable / selector _ light " 
 + android : layout _ width = " ? attr / actionBarSize " 
 + android : layout _ height = " match _ parent " > 
 
 - < LinearLayout 
 - android : layout _ width = " 0dp " 
 - android : layout _ height = " match _ parent " 
 - android : layout _ weight = " 1 " 
 - android : gravity = " center _ vertical " 
 - android : orientation = " vertical " 
 - android : paddingLeft = " 8dp " > 
 + < ImageView 
 + 
 + android : layout _ width = " wrap _ content " 
 + android : layout _ height = " match _ parent " 
 + android : src = " @ drawable / ic _ action _ navigation _ arrow _ back " 
 + android : scaleType = " center " 
 + android : layout _ gravity = " center _ vertical | center _ horizontal " / > 
 
 < TextView 
 - android : id = " @ + id / title " 
 - android : layout _ width = " match _ parent " 
 + android : layout _ marginTop = " 10dp " 
 + android : layout _ marginRight = " 10dp " 
 + android : layout _ gravity = " top | right " 
 + android : id = " @ + id / counter " 
 + android : layout _ width = " wrap _ content " 
 android : layout _ height = " wrap _ content " 
 - android : layout _ marginTop = " - 2dp " 
 - android : ellipsize = " end " 
 - android : lines = " 1 " 
 - android : singleLine = " true " 
 - android : textColor = " # ffffff " 
 - android : textSize = " 18sp " / > 
 - 
 - < FrameLayout 
 - android : id = " @ + id / subtitleContainer " 
 - android : layout _ width = " match _ parent " 
 - android : layout _ height = " wrap _ content " 
 - android : layout _ marginTop = " - 4dp " 
 - android : orientation = " horizontal " > 
 + android : paddingLeft = " 4dp " 
 + android : paddingRight = " 4dp " 
 + android : gravity = " center " 
 + android : textSize = " 12sp " 
 + android : visibility = " invisible " / > 
 + 
 + < / FrameLayout > 
 + 
 + < LinearLayout 
 + android : id = " @ + id / titleContainer " 
 + android : layout _ width = " match _ parent " 
 + android : layout _ height = " match _ parent " 
 + android : background = " @ drawable / selector _ light " > 
 + 
 + < im . actor . sdk . view . avatar . AvatarView 
 + android : id = " @ + id / avatarPreview " 
 + android : layout _ width = " 32dp " 
 + android : layout _ height = " 32dp " 
 + android : layout _ gravity = " center _ vertical " 
 + android : layout _ marginLeft = " 8dp " / > 
 
 - < LinearLayout 
 - android : id = " @ + id / typingContainer " 
 + < LinearLayout 
 + android : layout _ width = " 0dp " 
 + android : layout _ height = " match _ parent " 
 + android : layout _ weight = " 1 " 
 + android : gravity = " center _ vertical " 
 + android : orientation = " vertical " 
 + android : paddingLeft = " 8dp " > 
 + 
 + < TextView 
 + android : id = " @ + id / title " 
 android : layout _ width = " match _ parent " 
 android : layout _ height = " wrap _ content " 
 + android : layout _ marginTop = " - 2dp " 
 + android : ellipsize = " end " 
 + android : lines = " 1 " 
 + android : singleLine = " true " 
 + android : textColor = " # ffffff " 
 + android : textSize = " 18sp " / > 
 + 
 + < FrameLayout 
 + android : id = " @ + id / subtitleContainer " 
 + android : layout _ width = " match _ parent " 
 + android : layout _ height = " wrap _ content " 
 + android : layout _ marginTop = " - 4dp " 
 android : orientation = " horizontal " > 
 
 - < ImageView 
 - android : id = " @ + id / typingImage " 
 - android : layout _ width = " wrap _ content " 
 + < LinearLayout 
 + android : id = " @ + id / typingContainer " 
 + android : layout _ width = " match _ parent " 
 android : layout _ height = " wrap _ content " 
 - android : layout _ gravity = " center _ vertical " 
 - android : layout _ marginTop = " 2dp " / > 
 + android : orientation = " horizontal " > 
 + 
 + < ImageView 
 + android : id = " @ + id / typingImage " 
 + android : layout _ width = " wrap _ content " 
 + android : layout _ height = " wrap _ content " 
 + android : layout _ gravity = " center _ vertical " 
 + android : layout _ marginTop = " 2dp " / > 
 + 
 + < TextView 
 + android : id = " @ + id / typing " 
 + android : layout _ width = " match _ parent " 
 + android : layout _ height = " wrap _ content " 
 + android : textColor = " # ffffff " 
 + android : textSize = " 13sp " / > 
 + < / LinearLayout > 
 
 < TextView 
 - android : id = " @ + id / typing " 
 + android : id = " @ + id / subtitle " 
 android : layout _ width = " match _ parent " 
 android : layout _ height = " wrap _ content " 
 android : textColor = " # ffffff " 
 android : textSize = " 13sp " / > 
 - < / LinearLayout > 
 - 
 - < TextView 
 - android : id = " @ + id / subtitle " 
 - android : layout _ width = " match _ parent " 
 - android : layout _ height = " wrap _ content " 
 - android : textColor = " # ffffff " 
 - android : textSize = " 13sp " / > 
 - < / FrameLayout > 
 + < / FrameLayout > 
 + < / LinearLayout > 
 < / LinearLayout > 
 < / LinearLayout > 
 \ No newline at end of file
