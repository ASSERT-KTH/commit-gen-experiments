BLEU SCORE: 0.03574694956748285

TEST MSG: fix ( server : eventbus ) : fixed internal subscribe
GENERATED MSG: perf ( server ) : don ' t use im . actor . server . persist for loading users in LoadDialogs handler

TEST DIFF (one line): diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / eventbus / EventBusMediator . scala b / actor - server / actor - core / src / main / scala / im / actor / server / eventbus / EventBusMediator . scala < nl > index 88f1938 . . 54f57eb 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / eventbus / EventBusMediator . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / eventbus / EventBusMediator . scala < nl > @ @ - 168 , 9 + 168 , 10 @ @ final class EventBusMediator extends Actor with ActorLogging { < nl > if ( owner . contains ( clientUserId ) ) { < nl > context stop self < nl > } else sender ( ) ! Status . Failure ( new RuntimeException ( " Attempt to dispose by not an owner " ) ) < nl > - case Subscribe ( ref ) ⇒ < nl > + case subscribe @ Subscribe ( ref ) ⇒ < nl > this . internalConsumers . add ( ref ) < nl > context watch ref < nl > + sender ( ) ! SubscribeAck ( subscribe ) < nl > case Terminated ( ref ) ⇒ < nl > this . internalConsumers . remove ( ref ) < nl > }
NEAREST DIFF (one line): diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / dialog / group / GroupDialogHandlers . scala b / actor - server / actor - core / src / main / scala / im / actor / server / dialog / group / GroupDialogHandlers . scala < nl > index 345f913 . . 1d44771 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / dialog / group / GroupDialogHandlers . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / dialog / group / GroupDialogHandlers . scala < nl > @ @ - 82 , 7 + 82 , 6 @ @ trait GroupDialogHandlers extends UpdateCounters { < nl > } < nl > < nl > protected def messageRead ( state : GroupDialogState , readerUserId : Int , readerAuthId : Long , date : Long ) : Unit = { < nl > - log . warning ( s " got message read , with state : $ state , readerUserId : $ readerUserId , date : $ date , authId : $ readerAuthId " ) < nl > val replyTo = sender ( ) < nl > withMemberIds ( groupId ) { ( memberIds , invitedUserIds , _ ) ⇒ < nl > if ( ! state . lastSenderId . contains ( readerUserId ) ) { < nl > @ @ - 105 , 13 + 104 , 11 @ @ trait GroupDialogHandlers extends UpdateCounters { < nl > < nl > val now = new DateTime ( ) . getMillis < nl > val restMembers = memberIds . filterNot ( _ = = readerUserId ) < nl > - log . warning ( s " restMembers are $ restMembers " ) < nl > val authIdsF = Future . sequence ( restMembers map UserOffice . getAuthIds ) map ( _ . flatten . toSet ) < nl > < nl > for { < nl > authIds ← authIdsF < nl > _ ← db . run ( markMessagesRead ( models . Peer . privat ( readerUserId ) , models . Peer . group ( groupId ) , new DateTime ( date ) ) ) < nl > - _ = log . warning ( s " now is : $ now actually reading by user : $ readerUserId " ) < nl > _ ← persistAndPushUpdatesF ( authIds , UpdateMessageRead ( groupPeer , date , now ) , None , isFat = false ) < nl > } yield MessageReadAck ( ) < nl > < nl > diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / office / Processor . scala b / actor - server / actor - core / src / main / scala / im / actor / server / office / Processor . scala < nl > index c91ce8a . . de67bd2 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / office / Processor . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / office / Processor . scala < nl > @ @ - 71 , 7 + 71 , 7 @ @ trait Processor [ State < : ProcessorState , Event < : AnyRef ] extends PersistentActo < nl > context become working ( newState ) < nl > unstashAll ( ) < nl > case msg ⇒ < nl > - log . debug ( " Stashing while initializing . Message : { } " , msg ) < nl > + log . warning ( " Stashing while initializing . Message : { } " , msg ) < nl > stash ( ) < nl > } < nl > < nl > diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesManager . scala b / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesManager . scala < nl > index 07c8777 . . 4541e2c 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesManager . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesManager . scala < nl > @ @ - 135 , 7 + 135 , 6 @ @ object SeqUpdatesManager { < nl > < nl > val fatMetaData = if ( isFat ) Some ( getFatMetaData ( update ) ) else None < nl > < nl > - log . debug ( s " pushing update $ update to authIds : $ authIds " ) < nl > persistAndPushUpdatesF ( authIds , header , serializedData , updateRefs ( update ) , pushText , getOriginPeer ( update ) , fatMetaData ) < nl > } < nl > < nl > diff - - git a / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / messaging / HistoryHandlers . scala b / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / messaging / HistoryHandlers . scala < nl > index ac20104 . . 7884fb0 100644 < nl > - - - a / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / messaging / HistoryHandlers . scala < nl > + + + b / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / messaging / HistoryHandlers . scala < nl > @ @ - 253 , 7 + 253 , 7 @ @ trait HistoryHandlers { < nl > for { < nl > groups ← DBIO . from ( Future . sequence ( groupIds map ( GroupOffice . getApiStruct ( _ , client . userId ) ) ) ) < nl > groupUserIds = groups . map ( g ⇒ g . members . map ( m ⇒ Seq ( m . userId , m . inviterUserId ) ) . flatten : + g . creatorUserId ) . flatten < nl > - users ← getUserStructs ( userIds + + groupUserIds , client . userId , client . authId ) < nl > + users ← DBIO . from ( Future . sequence ( ( userIds + + groupUserIds ) . filterNot ( _ = = 0 ) map ( UserOffice . getApiStruct ( _ , client . userId , client . authId ) ) ) ) < nl > } yield ( users , groups ) < nl > }

TEST DIFF:
diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / eventbus / EventBusMediator . scala b / actor - server / actor - core / src / main / scala / im / actor / server / eventbus / EventBusMediator . scala 
 index 88f1938 . . 54f57eb 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / eventbus / EventBusMediator . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / eventbus / EventBusMediator . scala 
 @ @ - 168 , 9 + 168 , 10 @ @ final class EventBusMediator extends Actor with ActorLogging { 
 if ( owner . contains ( clientUserId ) ) { 
 context stop self 
 } else sender ( ) ! Status . Failure ( new RuntimeException ( " Attempt to dispose by not an owner " ) ) 
 - case Subscribe ( ref ) ⇒ 
 + case subscribe @ Subscribe ( ref ) ⇒ 
 this . internalConsumers . add ( ref ) 
 context watch ref 
 + sender ( ) ! SubscribeAck ( subscribe ) 
 case Terminated ( ref ) ⇒ 
 this . internalConsumers . remove ( ref ) 
 }

NEAREST DIFF:
diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / dialog / group / GroupDialogHandlers . scala b / actor - server / actor - core / src / main / scala / im / actor / server / dialog / group / GroupDialogHandlers . scala 
 index 345f913 . . 1d44771 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / dialog / group / GroupDialogHandlers . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / dialog / group / GroupDialogHandlers . scala 
 @ @ - 82 , 7 + 82 , 6 @ @ trait GroupDialogHandlers extends UpdateCounters { 
 } 
 
 protected def messageRead ( state : GroupDialogState , readerUserId : Int , readerAuthId : Long , date : Long ) : Unit = { 
 - log . warning ( s " got message read , with state : $ state , readerUserId : $ readerUserId , date : $ date , authId : $ readerAuthId " ) 
 val replyTo = sender ( ) 
 withMemberIds ( groupId ) { ( memberIds , invitedUserIds , _ ) ⇒ 
 if ( ! state . lastSenderId . contains ( readerUserId ) ) { 
 @ @ - 105 , 13 + 104 , 11 @ @ trait GroupDialogHandlers extends UpdateCounters { 
 
 val now = new DateTime ( ) . getMillis 
 val restMembers = memberIds . filterNot ( _ = = readerUserId ) 
 - log . warning ( s " restMembers are $ restMembers " ) 
 val authIdsF = Future . sequence ( restMembers map UserOffice . getAuthIds ) map ( _ . flatten . toSet ) 
 
 for { 
 authIds ← authIdsF 
 _ ← db . run ( markMessagesRead ( models . Peer . privat ( readerUserId ) , models . Peer . group ( groupId ) , new DateTime ( date ) ) ) 
 - _ = log . warning ( s " now is : $ now actually reading by user : $ readerUserId " ) 
 _ ← persistAndPushUpdatesF ( authIds , UpdateMessageRead ( groupPeer , date , now ) , None , isFat = false ) 
 } yield MessageReadAck ( ) 
 
 diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / office / Processor . scala b / actor - server / actor - core / src / main / scala / im / actor / server / office / Processor . scala 
 index c91ce8a . . de67bd2 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / office / Processor . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / office / Processor . scala 
 @ @ - 71 , 7 + 71 , 7 @ @ trait Processor [ State < : ProcessorState , Event < : AnyRef ] extends PersistentActo 
 context become working ( newState ) 
 unstashAll ( ) 
 case msg ⇒ 
 - log . debug ( " Stashing while initializing . Message : { } " , msg ) 
 + log . warning ( " Stashing while initializing . Message : { } " , msg ) 
 stash ( ) 
 } 
 
 diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesManager . scala b / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesManager . scala 
 index 07c8777 . . 4541e2c 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesManager . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesManager . scala 
 @ @ - 135 , 7 + 135 , 6 @ @ object SeqUpdatesManager { 
 
 val fatMetaData = if ( isFat ) Some ( getFatMetaData ( update ) ) else None 
 
 - log . debug ( s " pushing update $ update to authIds : $ authIds " ) 
 persistAndPushUpdatesF ( authIds , header , serializedData , updateRefs ( update ) , pushText , getOriginPeer ( update ) , fatMetaData ) 
 } 
 
 diff - - git a / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / messaging / HistoryHandlers . scala b / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / messaging / HistoryHandlers . scala 
 index ac20104 . . 7884fb0 100644 
 - - - a / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / messaging / HistoryHandlers . scala 
 + + + b / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / messaging / HistoryHandlers . scala 
 @ @ - 253 , 7 + 253 , 7 @ @ trait HistoryHandlers { 
 for { 
 groups ← DBIO . from ( Future . sequence ( groupIds map ( GroupOffice . getApiStruct ( _ , client . userId ) ) ) ) 
 groupUserIds = groups . map ( g ⇒ g . members . map ( m ⇒ Seq ( m . userId , m . inviterUserId ) ) . flatten : + g . creatorUserId ) . flatten 
 - users ← getUserStructs ( userIds + + groupUserIds , client . userId , client . authId ) 
 + users ← DBIO . from ( Future . sequence ( ( userIds + + groupUserIds ) . filterNot ( _ = = 0 ) map ( UserOffice . getApiStruct ( _ , client . userId , client . authId ) ) ) ) 
 } yield ( users , groups ) 
 }
