BLEU SCORE: 0.24177037175577334

TEST MSG: fix ( server : rpc ) : rewrite credentials on RequestRegisterGooglePush
GENERATED MSG: fix ( server : push ) : delete old push credentials by token

TEST DIFF (one line): diff - - git a / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / GooglePushCredentialsRepo . scala b / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / GooglePushCredentialsRepo . scala < nl > index 26fea88 . . 8401ccf 100644 < nl > - - - a / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / GooglePushCredentialsRepo . scala < nl > + + + b / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / GooglePushCredentialsRepo . scala < nl > @ @ - 18 , 14 + 18 , 13 @ @ final class GooglePushCredentialsTable ( tag : Tag ) extends Table [ GooglePushCredent < nl > } < nl > < nl > object GooglePushCredentialsRepo { < nl > - val creds = TableQuery [ GooglePushCredentialsTable ] < nl > + private val creds = TableQuery [ GooglePushCredentialsTable ] < nl > < nl > - def createOrUpdate ( c : GooglePushCredentials ) = < nl > - creds . insertOrUpdate ( c ) < nl > + def create ( c : GooglePushCredentials ) = creds + = c < nl > < nl > - def byAuthId ( authId : Rep [ Long ] ) = creds . filter ( _ . authId = = = authId ) < nl > + private def byAuthId ( authId : Rep [ Long ] ) = creds . filter ( _ . authId = = = authId ) < nl > < nl > - val byAuthIdC = Compiled ( byAuthId _ ) < nl > + private val byAuthIdC = Compiled ( byAuthId _ ) < nl > < nl > def find ( authId : Long ) = < nl > byAuthIdC ( authId ) . result . headOption < nl > @ @ - 47 , 4 + 46 , 4 @ @ object GooglePushCredentialsRepo { < nl > < nl > def deleteByToken ( token : String ) = < nl > creds . filter ( _ . regId = = = token ) . delete < nl > - } < nl > \ No newline at end of file < nl > + } < nl > diff - - git a / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / push / PushServiceImpl . scala b / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / push / PushServiceImpl . scala < nl > index a1913cc . . 85b600b 100644 < nl > - - - a / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / push / PushServiceImpl . scala < nl > + + + b / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / push / PushServiceImpl . scala < nl > @ @ - 35 , 11 + 35 , 14 @ @ final class PushServiceImpl ( < nl > < nl > override def doHandleRegisterGooglePush ( projectId : Long , token : String , clientData : ClientData ) : Future [ HandlerResult [ ResponseVoid ] ] = { < nl > val creds = GooglePushCredentials ( clientData . authId , projectId , token ) < nl > - for { < nl > - _ ← db . run ( GooglePushCredentialsRepo . deleteByToken ( token ) ) < nl > - _ ← db . run ( GooglePushCredentialsRepo . createOrUpdate ( creds ) ) < nl > + val action : DBIO [ HandlerResult [ ResponseVoid ] ] = for { < nl > + _ ← GooglePushCredentialsRepo . deleteByToken ( token ) < nl > + _ ← GooglePushCredentialsRepo . delete ( clientData . authId ) < nl > + _ ← GooglePushCredentialsRepo . create ( creds ) < nl > _ = seqUpdExt . registerGooglePushCredentials ( creds ) < nl > } yield OkVoid < nl > + < nl > + db . run ( action ) < nl > } < nl > < nl > override def doHandleRegisterApplePush ( apnsKey : Int , token : String , clientData : ClientData ) : Future [ HandlerResult [ ResponseVoid ] ] =
NEAREST DIFF (one line): diff - - git a / actor - server / actor - persist / src / main / resources / sql / migration / V20150727191745 _ _ AddAppleTokenIndex . sql b / actor - server / actor - persist / src / main / resources / sql / migration / V20150727191745 _ _ AddAppleTokenIndex . sql < nl > new file mode 100644 < nl > index 0000000 . . 1ea6555 < nl > - - - / dev / null < nl > + + + b / actor - server / actor - persist / src / main / resources / sql / migration / V20150727191745 _ _ AddAppleTokenIndex . sql < nl > @ @ - 0 , 0 + 1 @ @ < nl > + CREATE INDEX idx _ apple _ push _ credentials _ token on apple _ push _ credentials ( token ) ; < nl > \ No newline at end of file < nl > diff - - git a / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / ApplePushCredentials . scala b / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / ApplePushCredentials . scala < nl > index 8bfec9d . . 106b7d3 100644 < nl > - - - a / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / ApplePushCredentials . scala < nl > + + + b / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / ApplePushCredentials . scala < nl > @ @ - 34 , 4 + 34 , 7 @ @ object ApplePushCredentials { < nl > < nl > def delete ( authId : Long ) = < nl > creds . filter ( _ . authId = = = authId ) . delete < nl > + < nl > + def deleteByToken ( token : Array [ Byte ] ) = < nl > + creds . filter ( _ . token = = = token ) . delete < nl > } < nl > \ No newline at end of file < nl > diff - - git a / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / GooglePushCredentials . scala b / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / GooglePushCredentials . scala < nl > index 2a5cb2d . . 22294d2 100644 < nl > - - - a / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / GooglePushCredentials . scala < nl > + + + b / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / GooglePushCredentials . scala < nl > @ @ - 34 , 4 + 34 , 7 @ @ object GooglePushCredentials { < nl > < nl > def delete ( authId : Long ) = < nl > creds . filter ( _ . authId = = = authId ) . delete < nl > + < nl > + def deleteByToken ( token : String ) = < nl > + creds . filter ( _ . regId = = = token ) . delete < nl > } < nl > \ No newline at end of file < nl > diff - - git a / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / auth / AuthHelpers . scala b / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / auth / AuthHelpers . scala < nl > index 73221d1 . . 79a6261 100644 < nl > - - - a / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / auth / AuthHelpers . scala < nl > + + + b / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / auth / AuthHelpers . scala < nl > @ @ - 143 , 7 + 143 , 7 @ @ trait AuthHelpers extends Helpers { < nl > } < nl > < nl > / * * < nl > - * Terminate all sessions associated with given ` deviceHash ` for user with id ` userId ` < nl > + * Terminate all sessions associated with given ` deviceHash ` < nl > * and create new session < nl > * / < nl > protected def refreshAuthSession ( deviceHash : Array [ Byte ] , newSession : models . AuthSession ) : DBIO [ Unit ] = < nl > diff - - git a / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / push / PushServiceImpl . scala b / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / push / PushServiceImpl . scala < nl > index 8991e3d . . 86d2927 100644 < nl > - - - a / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / push / PushServiceImpl . scala < nl > + + + b / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / push / PushServiceImpl . scala < nl > @ @ - 4 , 8 + 4 , 8 @ @ import akka . actor . ActorSystem < nl > import im . actor . api . rpc . _ < nl > import im . actor . api . rpc . misc . ResponseVoid < nl > import im . actor . api . rpc . push . PushService < nl > - import im . actor . server . models < nl > import im . actor . server . push . { SeqUpdatesManager , SeqUpdatesManagerRegion } < nl > + import im . actor . server . { models , persist } < nl > import scodec . bits . BitVector < nl > import slick . driver . PostgresDriver . api . _ < nl > < nl > @ @ - 26 , 16 + 26 , 23 @ @ class PushServiceImpl ( < nl > < nl > override def jhandleRegisterGooglePush ( projectId : Long , token : String , clientData : ClientData ) : Future [ HandlerResult [ ResponseVoid ] ] = { < nl > val creds = models . push . GooglePushCredentials ( clientData . authId , projectId , token ) < nl > - SeqUpdatesManager . setPushCredentials ( clientData . authId , creds ) < nl > - Future . successful ( Ok ( ResponseVoid ) ) < nl > + val action : DBIO [ HandlerResult [ ResponseVoid ] ] = for { < nl > + _ ← persist . push . GooglePushCredentials . deleteByToken ( token ) < nl > + _ ← DBIO . successful ( SeqUpdatesManager . setPushCredentials ( clientData . authId , creds ) ) < nl > + } yield Ok ( ResponseVoid ) < nl > + db . run ( action ) < nl > } < nl > < nl > override def jhandleRegisterApplePush ( apnsKey : Int , token : String , clientData : ClientData ) : Future [ HandlerResult [ ResponseVoid ] ] = { < nl > BitVector . fromHex ( token ) match { < nl > case Some ( tokenBits ) ⇒ < nl > - val creds = models . push . ApplePushCredentials ( clientData . authId , apnsKey , tokenBits . toByteArray ) < nl > - SeqUpdatesManager . setPushCredentials ( clientData . authId , creds ) < nl > - Future . successful ( Ok ( ResponseVoid ) ) < nl > + val tokenBytes = tokenBits . toByteArray < nl > + val creds = models . push . ApplePushCredentials ( clientData . authId , apnsKey , tokenBytes ) < nl > + val action : DBIO [ HandlerResult [ ResponseVoid ] ] = for { < nl > + _ ← persist . push . ApplePushCredentials . deleteByToken ( tokenBytes ) < nl > + _ ← DBIO . successful ( SeqUpdatesManager . setPushCredentials ( clientData . authId , creds ) ) < nl > + } yield Ok ( ResponseVoid ) < nl > + db . run ( action ) < nl > case None ⇒ < nl > Future . successful ( Error ( RpcError ( 400 , " WRONG _ TOKEN " , " Wrong APNS Token " , false , None ) ) ) < nl > }

TEST DIFF:
diff - - git a / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / GooglePushCredentialsRepo . scala b / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / GooglePushCredentialsRepo . scala 
 index 26fea88 . . 8401ccf 100644 
 - - - a / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / GooglePushCredentialsRepo . scala 
 + + + b / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / GooglePushCredentialsRepo . scala 
 @ @ - 18 , 14 + 18 , 13 @ @ final class GooglePushCredentialsTable ( tag : Tag ) extends Table [ GooglePushCredent 
 } 
 
 object GooglePushCredentialsRepo { 
 - val creds = TableQuery [ GooglePushCredentialsTable ] 
 + private val creds = TableQuery [ GooglePushCredentialsTable ] 
 
 - def createOrUpdate ( c : GooglePushCredentials ) = 
 - creds . insertOrUpdate ( c ) 
 + def create ( c : GooglePushCredentials ) = creds + = c 
 
 - def byAuthId ( authId : Rep [ Long ] ) = creds . filter ( _ . authId = = = authId ) 
 + private def byAuthId ( authId : Rep [ Long ] ) = creds . filter ( _ . authId = = = authId ) 
 
 - val byAuthIdC = Compiled ( byAuthId _ ) 
 + private val byAuthIdC = Compiled ( byAuthId _ ) 
 
 def find ( authId : Long ) = 
 byAuthIdC ( authId ) . result . headOption 
 @ @ - 47 , 4 + 46 , 4 @ @ object GooglePushCredentialsRepo { 
 
 def deleteByToken ( token : String ) = 
 creds . filter ( _ . regId = = = token ) . delete 
 - } 
 \ No newline at end of file 
 + } 
 diff - - git a / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / push / PushServiceImpl . scala b / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / push / PushServiceImpl . scala 
 index a1913cc . . 85b600b 100644 
 - - - a / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / push / PushServiceImpl . scala 
 + + + b / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / push / PushServiceImpl . scala 
 @ @ - 35 , 11 + 35 , 14 @ @ final class PushServiceImpl ( 
 
 override def doHandleRegisterGooglePush ( projectId : Long , token : String , clientData : ClientData ) : Future [ HandlerResult [ ResponseVoid ] ] = { 
 val creds = GooglePushCredentials ( clientData . authId , projectId , token ) 
 - for { 
 - _ ← db . run ( GooglePushCredentialsRepo . deleteByToken ( token ) ) 
 - _ ← db . run ( GooglePushCredentialsRepo . createOrUpdate ( creds ) ) 
 + val action : DBIO [ HandlerResult [ ResponseVoid ] ] = for { 
 + _ ← GooglePushCredentialsRepo . deleteByToken ( token ) 
 + _ ← GooglePushCredentialsRepo . delete ( clientData . authId ) 
 + _ ← GooglePushCredentialsRepo . create ( creds ) 
 _ = seqUpdExt . registerGooglePushCredentials ( creds ) 
 } yield OkVoid 
 + 
 + db . run ( action ) 
 } 
 
 override def doHandleRegisterApplePush ( apnsKey : Int , token : String , clientData : ClientData ) : Future [ HandlerResult [ ResponseVoid ] ] =

NEAREST DIFF:
diff - - git a / actor - server / actor - persist / src / main / resources / sql / migration / V20150727191745 _ _ AddAppleTokenIndex . sql b / actor - server / actor - persist / src / main / resources / sql / migration / V20150727191745 _ _ AddAppleTokenIndex . sql 
 new file mode 100644 
 index 0000000 . . 1ea6555 
 - - - / dev / null 
 + + + b / actor - server / actor - persist / src / main / resources / sql / migration / V20150727191745 _ _ AddAppleTokenIndex . sql 
 @ @ - 0 , 0 + 1 @ @ 
 + CREATE INDEX idx _ apple _ push _ credentials _ token on apple _ push _ credentials ( token ) ; 
 \ No newline at end of file 
 diff - - git a / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / ApplePushCredentials . scala b / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / ApplePushCredentials . scala 
 index 8bfec9d . . 106b7d3 100644 
 - - - a / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / ApplePushCredentials . scala 
 + + + b / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / ApplePushCredentials . scala 
 @ @ - 34 , 4 + 34 , 7 @ @ object ApplePushCredentials { 
 
 def delete ( authId : Long ) = 
 creds . filter ( _ . authId = = = authId ) . delete 
 + 
 + def deleteByToken ( token : Array [ Byte ] ) = 
 + creds . filter ( _ . token = = = token ) . delete 
 } 
 \ No newline at end of file 
 diff - - git a / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / GooglePushCredentials . scala b / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / GooglePushCredentials . scala 
 index 2a5cb2d . . 22294d2 100644 
 - - - a / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / GooglePushCredentials . scala 
 + + + b / actor - server / actor - persist / src / main / scala / im / actor / server / persist / push / GooglePushCredentials . scala 
 @ @ - 34 , 4 + 34 , 7 @ @ object GooglePushCredentials { 
 
 def delete ( authId : Long ) = 
 creds . filter ( _ . authId = = = authId ) . delete 
 + 
 + def deleteByToken ( token : String ) = 
 + creds . filter ( _ . regId = = = token ) . delete 
 } 
 \ No newline at end of file 
 diff - - git a / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / auth / AuthHelpers . scala b / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / auth / AuthHelpers . scala 
 index 73221d1 . . 79a6261 100644 
 - - - a / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / auth / AuthHelpers . scala 
 + + + b / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / auth / AuthHelpers . scala 
 @ @ - 143 , 7 + 143 , 7 @ @ trait AuthHelpers extends Helpers { 
 } 
 
 / * * 
 - * Terminate all sessions associated with given ` deviceHash ` for user with id ` userId ` 
 + * Terminate all sessions associated with given ` deviceHash ` 
 * and create new session 
 * / 
 protected def refreshAuthSession ( deviceHash : Array [ Byte ] , newSession : models . AuthSession ) : DBIO [ Unit ] = 
 diff - - git a / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / push / PushServiceImpl . scala b / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / push / PushServiceImpl . scala 
 index 8991e3d . . 86d2927 100644 
 - - - a / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / push / PushServiceImpl . scala 
 + + + b / actor - server / actor - rpc - api / src / main / scala / im / actor / server / api / rpc / service / push / PushServiceImpl . scala 
 @ @ - 4 , 8 + 4 , 8 @ @ import akka . actor . ActorSystem 
 import im . actor . api . rpc . _ 
 import im . actor . api . rpc . misc . ResponseVoid 
 import im . actor . api . rpc . push . PushService 
 - import im . actor . server . models 
 import im . actor . server . push . { SeqUpdatesManager , SeqUpdatesManagerRegion } 
 + import im . actor . server . { models , persist } 
 import scodec . bits . BitVector 
 import slick . driver . PostgresDriver . api . _ 
 
 @ @ - 26 , 16 + 26 , 23 @ @ class PushServiceImpl ( 
 
 override def jhandleRegisterGooglePush ( projectId : Long , token : String , clientData : ClientData ) : Future [ HandlerResult [ ResponseVoid ] ] = { 
 val creds = models . push . GooglePushCredentials ( clientData . authId , projectId , token ) 
 - SeqUpdatesManager . setPushCredentials ( clientData . authId , creds ) 
 - Future . successful ( Ok ( ResponseVoid ) ) 
 + val action : DBIO [ HandlerResult [ ResponseVoid ] ] = for { 
 + _ ← persist . push . GooglePushCredentials . deleteByToken ( token ) 
 + _ ← DBIO . successful ( SeqUpdatesManager . setPushCredentials ( clientData . authId , creds ) ) 
 + } yield Ok ( ResponseVoid ) 
 + db . run ( action ) 
 } 
 
 override def jhandleRegisterApplePush ( apnsKey : Int , token : String , clientData : ClientData ) : Future [ HandlerResult [ ResponseVoid ] ] = { 
 BitVector . fromHex ( token ) match { 
 case Some ( tokenBits ) ⇒ 
 - val creds = models . push . ApplePushCredentials ( clientData . authId , apnsKey , tokenBits . toByteArray ) 
 - SeqUpdatesManager . setPushCredentials ( clientData . authId , creds ) 
 - Future . successful ( Ok ( ResponseVoid ) ) 
 + val tokenBytes = tokenBits . toByteArray 
 + val creds = models . push . ApplePushCredentials ( clientData . authId , apnsKey , tokenBytes ) 
 + val action : DBIO [ HandlerResult [ ResponseVoid ] ] = for { 
 + _ ← persist . push . ApplePushCredentials . deleteByToken ( tokenBytes ) 
 + _ ← DBIO . successful ( SeqUpdatesManager . setPushCredentials ( clientData . authId , creds ) ) 
 + } yield Ok ( ResponseVoid ) 
 + db . run ( action ) 
 case None ⇒ 
 Future . successful ( Error ( RpcError ( 400 , " WRONG _ TOKEN " , " Wrong APNS Token " , false , None ) ) ) 
 }
