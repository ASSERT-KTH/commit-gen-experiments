BLEU SCORE: 0.3672056269893592

TEST MSG: wip ( android ) : move peer connection binding to core
GENERATED MSG: refactor ( android ) : move group invites to sdk

TEST DIFF (one line): diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java < nl > index d95e4f6 . . c9b24ac 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java < nl > @ @ - 14 , 7 + 14 , 6 @ @ import android . media . AudioManager ; < nl > import android . media . Ringtone ; < nl > import android . media . RingtoneManager ; < nl > import android . net . Uri ; < nl > - import android . opengl . GLSurfaceView ; < nl > import android . os . Bundle ; < nl > import android . os . PowerManager ; < nl > import android . os . Vibrator ; < nl > @ @ - 31 , 16 + 30 , 18 @ @ import android . widget . ImageButton ; < nl > import android . widget . TextView ; < nl > < nl > import org . webrtc . EglBase ; < nl > - import org . webrtc . RendererCommon ; < nl > + import org . webrtc . MediaStream ; < nl > import org . webrtc . SurfaceViewRenderer ; < nl > import org . webrtc . VideoRenderer ; < nl > - import org . webrtc . VideoRendererGui ; < nl > import org . webrtc . VideoSource ; < nl > < nl > import java . text . DateFormat ; < nl > import java . text . SimpleDateFormat ; < nl > import java . util . ArrayList ; < nl > import java . util . Date ; < nl > + import java . util . HashMap ; < nl > + import java . util . HashSet ; < nl > + import java . util . Set ; < nl > import java . util . TimeZone ; < nl > < nl > import im . actor . core . entity . PeerType ; < nl > @ @ - 63 , 6 + 64 , 9 @ @ import im . actor . runtime . android . webrtc . AndroidPeerConnection ; < nl > import im . actor . runtime . mvvm . Value ; < nl > import im . actor . runtime . mvvm . ValueChangedListener ; < nl > import im . actor . runtime . mvvm . ValueModel ; < nl > + import im . actor . runtime . webrtc . WebRTCMediaStream ; < nl > + import im . actor . runtime . webrtc . WebRTCPeerConnection ; < nl > + import im . actor . runtime . webrtc . WebRTCPeerConnectionCallback ; < nl > import im . actor . sdk . ActorSDK ; < nl > import im . actor . sdk . R ; < nl > import im . actor . sdk . controllers . calls . view . CallAvatarLayerAnimator ; < nl > @ @ - 109 , 8 + 113 , 19 @ @ public class CallFragment extends BaseFragment { < nl > private View layer3 ; < nl > private VideoSource source ; < nl > private EglBase rootEglBase ; < nl > - private SurfaceViewRenderer localRender ; < nl > - private SurfaceViewRenderer remoteRender ; < nl > + private VideoRenderer localRender ; < nl > + private VideoRenderer remoteRender ; < nl > + private SurfaceViewRenderer localVideoView ; < nl > + private SurfaceViewRenderer remoteVideoView ; < nl > + < nl > + private TextView muteCallTv ; < nl > + private TextView videoTv ; < nl > + private ViewGroup container ; < nl > + private TintImageView speaker ; < nl > + private TintImageView muteCall ; < nl > + private TextView speakerTV ; < nl > + private boolean sourceIsStopped = false ; < nl > + private WebRTCPeerConnectionCallback webRTCPeerConnectionCallback ; < nl > < nl > public CallFragment ( ) { < nl > < nl > @ @ - 132 , 7 + 147 , 7 @ @ public class CallFragment extends BaseFragment { < nl > public View onCreateView ( LayoutInflater inflater , ViewGroup container , < nl > Bundle savedInstanceState ) { < nl > < nl > - < nl > + this . container = container ; < nl > manager = ( NotificationManager ) getActivity ( ) . getSystemService ( Context . NOTIFICATION _ SERVICE ) ; < nl > < nl > FrameLayout cont = ( FrameLayout ) inflater . inflate ( R . layout . fragment _ call , container , false ) ; < nl > @ @ - 269 , 9 + 284 , 9 @ @ public class CallFragment extends BaseFragment { < nl > < nl > < nl > audioManager . getStreamVolume ( AudioManager . STREAM _ VOICE _ CALL ) ; < nl > - final TintImageView speaker = ( TintImageView ) cont . findViewById ( R . id . speaker ) ; < nl > + speaker = ( TintImageView ) cont . findViewById ( R . id . speaker ) ; < nl > speaker . setResource ( R . drawable . ic _ volume _ up _ white _ 24dp ) ; < nl > - final TextView speakerTV = ( TextView ) cont . findViewById ( R . id . speaker _ tv ) ; < nl > + speakerTV = ( TextView ) cont . findViewById ( R . id . speaker _ tv ) ; < nl > cont . findViewById ( R . id . speaker _ btn ) . setOnClickListener ( new View . OnClickListener ( ) { < nl > @ Override < nl > public void onClick ( View v ) { < nl > @ @ - 280 , 8 + 295 , 8 @ @ public class CallFragment extends BaseFragment { < nl > } ) ; < nl > checkSpeaker ( speaker , speakerTV ) ; < nl > < nl > - final TintImageView muteCall = ( TintImageView ) cont . findViewById ( R . id . mute ) ; < nl > - final TextView muteCallTv = ( TextView ) cont . findViewById ( R . id . mute _ tv ) ; < nl > + muteCall = ( TintImageView ) cont . findViewById ( R . id . mute ) ; < nl > + muteCallTv = ( TextView ) cont . findViewById ( R . id . mute _ tv ) ; < nl > muteCall . setResource ( R . drawable . ic _ mic _ off _ white _ 24dp ) ; < nl > cont . findViewById ( R . id . mute _ btn ) . setOnClickListener ( new View . OnClickListener ( ) { < nl > @ Override < nl > @ @ - 292 , 7 + 307 , 7 @ @ public class CallFragment extends BaseFragment { < nl > < nl > final TintImageView video = ( TintImageView ) cont . findViewById ( R . id . video ) ; < nl > video . setResource ( R . drawable . ic _ videocam _ white _ 24dp ) ; < nl > - TextView videoTv = ( TextView ) cont . findViewById ( R . id . video _ tv ) ; < nl > + videoTv = ( TextView ) cont . findViewById ( R . id . video _ tv ) ; < nl > videoTv . setTextColor ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; < nl > video . setTint ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; < nl > < nl > @ @ - 313 , 128 + 328 , 81 @ @ public class CallFragment extends BaseFragment { < nl > < nl > rootEglBase = EglBase . create ( ) ; < nl > < nl > - AndroidWebRTCRuntimeProvider . bindPeerConnection ( new AndroidWebRTCRuntimeProvider . PeerConnectionCallback ( ) { < nl > - @ Override < nl > - public void onPeerConncetionAvailable ( AndroidPeerConnection peerConnection ) { < nl > - peerConnection . bind ( new AndroidPeerConnection . OwnStreamCallback ( ) { < nl > - @ Override < nl > - public void onLocalStreamAvailable ( AndroidMediaStream stream ) { < nl > - if ( stream . getVideoTrack ( ) ! = null ) { < nl > - < nl > - < nl > - getActivity ( ) . runOnUiThread ( new Runnable ( ) { < nl > - @ Override < nl > - public void run ( ) { < nl > - source = stream . getVideoSource ( ) ; < nl > - localRender = new SurfaceViewRenderer ( getActivity ( ) ) ; < nl > - localRender . setZOrderMediaOverlay ( true ) ; < nl > - localRender . init ( rootEglBase . getEglBaseContext ( ) , null ) ; < nl > - < nl > - stream . getVideoTrack ( ) . addRenderer ( new VideoRenderer ( localRender ) ) ; < nl > - container . addView ( localRender , Screen . dp ( 200 ) , Screen . dp ( 200 ) ) ; < nl > - } < nl > - } ) ; < nl > - } < nl > - } < nl > - < nl > - @ Override < nl > - public void onRemoteStreamAdd ( AndroidMediaStream stream ) { < nl > - if ( stream . getVideoTrack ( ) ! = null ) { < nl > - < nl > - getActivity ( ) . runOnUiThread ( new Runnable ( ) { < nl > - @ Override < nl > - public void run ( ) { < nl > - remoteRender = new SurfaceViewRenderer ( getActivity ( ) ) ; < nl > - remoteRender . init ( rootEglBase . getEglBaseContext ( ) , null ) ; < nl > - stream . getVideoTrack ( ) . addRenderer ( new VideoRenderer ( remoteRender ) ) ; < nl > - container . addView ( remoteRender , Screen . dp ( 400 ) , Screen . dp ( 400 ) ) ; < nl > - } < nl > - } ) ; < nl > - } < nl > - } < nl > + remoteVideoView = ( SurfaceViewRenderer ) cont . findViewById ( R . id . remote _ renderer ) ; < nl > + remoteVideoView . init ( rootEglBase . getEglBaseContext ( ) , null ) ; < nl > < nl > - @ Override < nl > - public void onRemoteStreamRemove ( AndroidMediaStream stream ) { < nl > + localVideoView = ( SurfaceViewRenderer ) cont . findViewById ( R . id . local _ renderer ) ; < nl > + / / localVideoView . setZOrderMediaOverlay ( true ) ; < nl > + localVideoView . init ( rootEglBase . getEglBaseContext ( ) , null ) ; < nl > < nl > - } < nl > < nl > - @ Override < nl > - public void onOwnRemoved ( ) { < nl > - < nl > - } < nl > - < nl > - @ Override < nl > - public void onDispose ( ) { < nl > - if ( localRender ! = null ) { < nl > - localRender . release ( ) ; < nl > - } < nl > + webRTCPeerConnectionCallback = new WebRTCPeerConnectionCallback ( ) { < nl > + @ Override < nl > + public void onCandidate ( int label , String id , String candidate ) { < nl > < nl > - if ( remoteRender ! = null ) { < nl > - remoteRender . release ( ) ; < nl > - } < nl > - } < nl > - } ) ; < nl > } < nl > - } ) ; < nl > - < nl > - if ( call ! = null ) { < nl > - bind ( call . getIsMuted ( ) , new ValueChangedListener < Boolean > ( ) { < nl > - @ Override < nl > - public void onChanged ( Boolean val , Value < Boolean > valueModel ) { < nl > - if ( getActivity ( ) ! = null ) { < nl > - if ( val ) { < nl > < nl > - muteCallTv . setTextColor ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; < nl > - muteCall . setTint ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; < nl > - } else { < nl > - muteCallTv . setTextColor ( Color . WHITE ) ; < nl > - muteCall . setTint ( Color . WHITE ) ; < nl > + @ Override < nl > + public void onStreamAdded ( WebRTCMediaStream remoteStream ) { < nl > + AndroidMediaStream stream = ( AndroidMediaStream ) remoteStream ; < nl > + if ( stream . getVideoTrack ( ) ! = null ) { < nl > + < nl > + getActivity ( ) . runOnUiThread ( new Runnable ( ) { < nl > + @ Override < nl > + public void run ( ) { < nl > + remoteRender = new VideoRenderer ( remoteVideoView ) ; < nl > + stream . getVideoTrack ( ) . addRenderer ( remoteRender ) ; < nl > + remoteVideoView . setVisibility ( View . VISIBLE ) ; < nl > } < nl > - } < nl > + } ) ; < nl > } < nl > - } ) ; < nl > + } < nl > < nl > - bind ( call . getState ( ) , new ValueChangedListener < CallState > ( ) { < nl > - @ Override < nl > - public void onChanged ( CallState val , Value < CallState > valueModel ) { < nl > - if ( currentState ! = val ) { < nl > - currentState = val ; < nl > - switch ( val ) { < nl > + @ Override < nl > + public void onStreamRemoved ( WebRTCMediaStream stream ) { < nl > < nl > - case RINGING : < nl > - if ( call . isOutgoing ( ) ) { < nl > - statusTV . setText ( R . string . call _ outgoing ) ; < nl > - } else { < nl > - statusTV . setText ( R . string . call _ incoming ) ; < nl > - toggleSpeaker ( speaker , speakerTV , true ) ; < nl > - initIncoming ( ) ; < nl > - } < nl > - break ; < nl > + } < nl > < nl > - case CONNECTING : < nl > - statusTV . setText ( R . string . call _ connecting ) ; < nl > - break ; < nl > + @ Override < nl > + public void onOwnStreamAdded ( WebRTCMediaStream ownStream ) { < nl > + AndroidMediaStream stream = ( AndroidMediaStream ) ownStream ; < nl > + if ( stream . getVideoTrack ( ) ! = null ) { < nl > < nl > - case IN _ PROGRESS : < nl > - toggleSpeaker ( speaker , speakerTV , false ) ; < nl > - onConnected ( ) ; < nl > - startTimer ( ) ; < nl > - break ; < nl > < nl > - case ENDED : < nl > - statusTV . setText ( R . string . call _ ended ) ; < nl > - onCallEnd ( ) ; < nl > - break ; < nl > + getActivity ( ) . runOnUiThread ( new Runnable ( ) { < nl > + @ Override < nl > + public void run ( ) { < nl > + source = stream . getVideoSource ( ) ; < nl > < nl > + localRender = new VideoRenderer ( localVideoView ) ; < nl > + stream . getVideoTrack ( ) . addRenderer ( localRender ) ; < nl > + localVideoView . setVisibility ( View . VISIBLE ) ; < nl > } < nl > - } < nl > + } ) ; < nl > } < nl > - } ) ; < nl > + } < nl > < nl > - } < nl > + @ Override < nl > + public void onOwnStreamRemoved ( WebRTCMediaStream stream ) { < nl > < nl > + } < nl > < nl > + @ Override < nl > + public void onRenegotiationNeeded ( ) { < nl > + < nl > + } < nl > + < nl > + @ Override < nl > + public void onDisposed ( ) { < nl > + if ( localVideoView ! = null ) { < nl > + localVideoView . release ( ) ; < nl > + } < nl > < nl > + if ( remoteVideoView ! = null ) { < nl > + remoteVideoView . release ( ) ; < nl > + } < nl > + } < nl > + } ; < nl > < nl > return cont ; < nl > } < nl > @ @ - 630 , 10 + 598 , 9 @ @ public class CallFragment extends BaseFragment { < nl > super . onPause ( ) ; < nl > if ( source ! = null ) { < nl > source . stop ( ) ; < nl > + sourceIsStopped = true ; < nl > } < nl > < nl > - AndroidWebRTCRuntimeProvider . unbindPeerConnection ( ) ; < nl > - < nl > if ( call ! = null & & call . getState ( ) . get ( ) ! = CallState . ENDED ) { < nl > final NotificationCompat . Builder builder = new NotificationCompat . Builder ( getActivity ( ) ) ; < nl > builder . setAutoCancel ( true ) ; < nl > @ @ - 654 , 6 + 621 , 24 @ @ public class CallFragment extends BaseFragment { < nl > manager . notify ( NOTIFICATION _ ID , n ) ; < nl > } < nl > < nl > + if ( call ! = null ) { < nl > + AndroidPeerConnection webRTCPeerConnection = ( AndroidPeerConnection ) call . getPeerConnection ( ) . get ( ) ; < nl > + if ( webRTCPeerConnection ! = null ) { < nl > + webRTCPeerConnection . removeCallback ( webRTCPeerConnectionCallback ) ; < nl > + < nl > + HashMap < MediaStream , AndroidMediaStream > mediaStreams = ( ( AndroidPeerConnection ) webRTCPeerConnection ) . getStreams ( ) ; < nl > + for ( MediaStream mediaStream : mediaStreams . keySet ( ) ) { < nl > + mediaStreams . get ( mediaStream ) . removeRenderer ( remoteRender ) ; < nl > + } < nl > + < nl > + AndroidMediaStream stream = webRTCPeerConnection . getStream ( ) ; < nl > + if ( stream ! = null ) { < nl > + stream . removeRenderer ( localRender ) ; < nl > + } < nl > + } < nl > + < nl > + } < nl > + < nl > disableWakeLock ( ) ; < nl > < nl > } < nl > @ @ - 663 , 9 + 648 , 78 @ @ public class CallFragment extends BaseFragment { < nl > super . onResume ( ) ; < nl > enableWakeLock ( ) ; < nl > < nl > + if ( source ! = null ) { < nl > + source . restart ( ) ; < nl > + sourceIsStopped = false ; < nl > + } < nl > + < nl > manager . cancel ( NOTIFICATION _ ID ) ; < nl > / / animator . popAnimation ( true ) ; < nl > + if ( call ! = null ) { < nl > + < nl > + bind ( call . getPeerConnection ( ) , new ValueChangedListener < WebRTCPeerConnection > ( ) { < nl > + @ Override < nl > + public void onChanged ( WebRTCPeerConnection val , Value < WebRTCPeerConnection > valueModel ) { < nl > + if ( val ! = null ) { < nl > + val . addCallback ( webRTCPeerConnectionCallback ) ; < nl > + } < nl > + } < nl > + } ) ; < nl > + < nl > + bind ( call . getIsMuted ( ) , new ValueChangedListener < Boolean > ( ) { < nl > + @ Override < nl > + public void onChanged ( Boolean val , Value < Boolean > valueModel ) { < nl > + if ( getActivity ( ) ! = null ) { < nl > + if ( val ) { < nl > < nl > + muteCallTv . setTextColor ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; < nl > + muteCall . setTint ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; < nl > + } else { < nl > + muteCallTv . setTextColor ( Color . WHITE ) ; < nl > + muteCall . setTint ( Color . WHITE ) ; < nl > + } < nl > + } < nl > + } < nl > + } ) ; < nl > + < nl > + bind ( call . getState ( ) , new ValueChangedListener < CallState > ( ) { < nl > + @ Override < nl > + public void onChanged ( CallState val , Value < CallState > valueModel ) { < nl > + if ( currentState ! = val ) { < nl > + currentState = val ; < nl > + switch ( val ) { < nl > + < nl > + case RINGING : < nl > + if ( call . isOutgoing ( ) ) { < nl > + statusTV . setText ( R . string . call _ outgoing ) ; < nl > + } else { < nl > + statusTV . setText ( R . string . call _ incoming ) ; < nl > + toggleSpeaker ( speaker , speakerTV , true ) ; < nl > + initIncoming ( ) ; < nl > + } < nl > + break ; < nl > + < nl > + case CONNECTING : < nl > + statusTV . setText ( R . string . call _ connecting ) ; < nl > + break ; < nl > + < nl > + case IN _ PROGRESS : < nl > + toggleSpeaker ( speaker , speakerTV , false ) ; < nl > + onConnected ( ) ; < nl > + startTimer ( ) ; < nl > + break ; < nl > + < nl > + case ENDED : < nl > + statusTV . setText ( R . string . call _ ended ) ; < nl > + onCallEnd ( ) ; < nl > + break ; < nl > + < nl > + } < nl > + } < nl > + } < nl > + } ) ; < nl > + < nl > + } < nl > } < nl > < nl > class CallMembersAdapter extends HolderAdapter < CallMember > { < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml < nl > index fff1bef . . 9d7aeac 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml < nl > @ @ - 10 , 6 + 10 , 21 @ @ < nl > android : layout _ width = " match _ parent " < nl > android : layout _ height = " match _ parent " / > < nl > < nl > + < org . webrtc . SurfaceViewRenderer < nl > + android : visibility = " invisible " < nl > + android : id = " @ + id / remote _ renderer " < nl > + android : layout _ width = " match _ parent " < nl > + android : layout _ height = " match _ parent " / > < nl > + < nl > + < org . webrtc . SurfaceViewRenderer < nl > + android : visibility = " invisible " < nl > + android : id = " @ + id / local _ renderer " < nl > + android : layout _ width = " 100dp " < nl > + android : layout _ height = " 50dp " < nl > + android : layout _ gravity = " bottom | left " < nl > + android : layout _ marginLeft = " 50dp " < nl > + android : layout _ marginBottom = " 50dp " / > < nl > + < nl > < LinearLayout < nl > android : layout _ width = " match _ parent " < nl > android : layout _ height = " match _ parent " < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java < nl > index 1cdce73 . . 2c38104 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java < nl > @ @ - 1 , 5 + 1 , 7 @ @ < nl > package im . actor . core . modules . calls ; < nl > < nl > + import org . jetbrains . annotations . NotNull ; < nl > + < nl > import im . actor . core . api . rpc . RequestDoCall ; < nl > import im . actor . core . api . rpc . RequestGetCallInfo ; < nl > import im . actor . core . api . rpc . RequestJoinCall ; < nl > @ @ - 16 , 6 + 18 , 7 @ @ import im . actor . core . viewmodel . CommandCallback ; < nl > import im . actor . runtime . actors . messages . PoisonPill ; < nl > import im . actor . runtime . function . Consumer ; < nl > import im . actor . runtime . power . WakeLock ; < nl > + import im . actor . runtime . webrtc . WebRTCPeerConnection ; < nl > < nl > import static im . actor . core . entity . EntityConverter . convert ; < nl > < nl > @ @ - 88 , 6 + 91 , 11 @ @ public class CallActor extends AbsCallActor { < nl > } < nl > < nl > @ Override < nl > + public void onPeerConnectionCreated ( @ NotNull WebRTCPeerConnection peerConnection ) { < nl > + callVM . getPeerConnection ( ) . change ( peerConnection ) ; < nl > + } < nl > + < nl > + @ Override < nl > public void onCallEnabled ( ) { < nl > isActive = true ; < nl > if ( isAnswered ) { < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / AbsCallActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / AbsCallActor . java < nl > index 8f64516 . . 0298a0b 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / AbsCallActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / AbsCallActor . java < nl > @ @ - 7 , 6 + 7 , 7 @ @ import im . actor . runtime . WebRTC ; < nl > import im . actor . runtime . actors . Actor ; < nl > import im . actor . runtime . actors . ActorCreator ; < nl > import im . actor . runtime . actors . ActorRef ; < nl > + import im . actor . runtime . webrtc . WebRTCPeerConnection ; < nl > < nl > public abstract class AbsCallActor extends ModuleActor implements CallBusCallback { < nl > < nl > @ @ - 83 , 5 + 84 , 10 @ @ public abstract class AbsCallActor extends ModuleActor implements CallBusCallbac < nl > public void onBusStopped ( ) { < nl > self ( ) . send ( ( Runnable ) ( ) - > AbsCallActor . this . onBusStopped ( ) ) ; < nl > } < nl > + < nl > + @ Override < nl > + public void onPeerConnectionCreated ( WebRTCPeerConnection peerConnection ) { < nl > + self ( ) . send ( ( Runnable ) ( ) - > AbsCallActor . this . onPeerConnectionCreated ( peerConnection ) ) ; < nl > + } < nl > } < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java < nl > index 437cbb0 . . 5107836 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java < nl > @ @ - 23 , 6 + 23 , 7 @ @ import im . actor . runtime . actors . Actor ; < nl > import im . actor . runtime . actors . ActorCreator ; < nl > import im . actor . runtime . actors . ActorRef ; < nl > import im . actor . runtime . webrtc . WebRTCMediaStream ; < nl > + import im . actor . runtime . webrtc . WebRTCPeerConnection ; < nl > < nl > / * - [ < nl > # pragma clang diagnostic ignored " - Wnullability - completeness " < nl > @ @ - 125 , 6 + 126 , 11 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { < nl > < nl > } < nl > < nl > + @ Override < nl > + public void onPeerConnectionCreated ( WebRTCPeerConnection peerConnection ) { < nl > + < nl > + } < nl > + < nl > < nl > / / < nl > / / Actions < nl > @ @ - 343 , 5 + 349 , 11 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { < nl > public void onStreamRemoved ( final long deviceId , @ NotNull final WebRTCMediaStream stream ) { < nl > self ( ) . send ( ( Runnable ) ( ) - > callCallback . onStreamRemoved ( deviceId , stream ) ) ; < nl > } < nl > + < nl > + @ Override < nl > + public void onPeerConnectionCreated ( WebRTCPeerConnection peerConnection ) { < nl > + self ( ) . send ( ( Runnable ) ( ) - > callCallback . onPeerConnectionCreated ( peerConnection ) ) ; < nl > + < nl > + } < nl > } < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java < nl > index 51028fe . . f94a823 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java < nl > @ @ - 2 , 6 + 2 , 8 @ @ package im . actor . core . modules . calls . peers ; < nl > < nl > import org . jetbrains . annotations . NotNull ; < nl > < nl > + import im . actor . runtime . webrtc . WebRTCPeerConnection ; < nl > + < nl > public interface CallBusCallback { < nl > < nl > void onBusStarted ( @ NotNull String busId ) ; < nl > @ @ - 11 , 4 + 13 , 6 @ @ public interface CallBusCallback { < nl > void onCallEnabled ( ) ; < nl > < nl > void onBusStopped ( ) ; < nl > + < nl > + void onPeerConnectionCreated ( @ NotNull WebRTCPeerConnection peerConnection ) ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallActor . java < nl > index 6781870 . . c73ea77 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallActor . java < nl > @ @ - 20 , 6 + 20 , 7 @ @ import im . actor . runtime . WebRTC ; < nl > import im . actor . runtime . actors . messages . PoisonPill ; < nl > import im . actor . runtime . function . Consumer ; < nl > import im . actor . runtime . webrtc . WebRTCMediaStream ; < nl > + import im . actor . runtime . webrtc . WebRTCPeerConnection ; < nl > < nl > public class PeerCallActor extends ModuleActor { < nl > < nl > @ @ - 256 , 5 + 257 , 10 @ @ public class PeerCallActor extends ModuleActor { < nl > public void onStreamRemoved ( long deviceId , WebRTCMediaStream stream ) { < nl > callback . onStreamRemoved ( deviceId , stream ) ; < nl > } < nl > + < nl > + @ Override < nl > + public void onPeerConnectionCreated ( WebRTCPeerConnection peerConnection ) { < nl > + callback . onPeerConnectionCreated ( peerConnection ) ; < nl > + } < nl > } < nl > } < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallCallback . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallCallback . java < nl > index 2a31283 . . 0382386 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallCallback . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallCallback . java < nl > @ @ - 1 , 6 + 1 , 7 @ @ < nl > package im . actor . core . modules . calls . peers ; < nl > < nl > import im . actor . runtime . webrtc . WebRTCMediaStream ; < nl > + import im . actor . runtime . webrtc . WebRTCPeerConnection ; < nl > < nl > public interface PeerCallCallback { < nl > < nl > @ @ - 17 , 4 + 18 , 6 @ @ public interface PeerCallCallback { < nl > void onStreamAdded ( long deviceId , WebRTCMediaStream stream ) ; < nl > < nl > void onStreamRemoved ( long deviceId , WebRTCMediaStream stream ) ; < nl > + < nl > + void onPeerConnectionCreated ( WebRTCPeerConnection peerConnection ) ; < nl > } < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerConnectionActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerConnectionActor . java < nl > index dabd3e8 . . 9e27a2f 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerConnectionActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerConnectionActor . java < nl > @ @ - 104 , 6 + 104 , 21 @ @ public class PeerConnectionActor extends ModuleActor { < nl > public void onRenegotiationNeeded ( ) { < nl > < nl > } < nl > + < nl > + @ Override < nl > + public void onOwnStreamAdded ( WebRTCMediaStream stream ) { < nl > + < nl > + } < nl > + < nl > + @ Override < nl > + public void onOwnStreamRemoved ( WebRTCMediaStream stream ) { < nl > + < nl > + } < nl > + < nl > + @ Override < nl > + public void onDisposed ( ) { < nl > + < nl > + } < nl > } ) ; < nl > state = PeerConnectionState . WAITING _ HANDSHAKE ; < nl > onReady ( ) ; < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeCallback . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeCallback . java < nl > index 44ea48e . . fabfcf6 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeCallback . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeCallback . java < nl > @ @ - 1 , 6 + 1 , 7 @ @ < nl > package im . actor . core . modules . calls . peers ; < nl > < nl > import im . actor . runtime . webrtc . WebRTCMediaStream ; < nl > + import im . actor . runtime . webrtc . WebRTCPeerConnection ; < nl > < nl > / * * < nl > * Peer Node callback < nl > @ @ - 64 , 7 + 65 , 9 @ @ public interface PeerNodeCallback { < nl > * Called when stream removed < nl > * < nl > * @ param deviceId Device Id < nl > - * @ param stream removed stream < nl > + * @ param stream removed strea < nl > * / < nl > void onStreamRemoved ( long deviceId , WebRTCMediaStream stream ) ; < nl > + < nl > + void onPeerConnectionCreated ( WebRTCPeerConnection peerConnection ) ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeInt . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeInt . java < nl > index 01ddee3 . . ec6f301 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeInt . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeInt . java < nl > @ @ - 18 , 6 + 18 , 7 @ @ import im . actor . runtime . actors . ActorCreator ; < nl > import im . actor . runtime . actors . ActorInterface ; < nl > import im . actor . runtime . actors . ActorRef ; < nl > import im . actor . runtime . webrtc . WebRTCMediaStream ; < nl > + import im . actor . runtime . webrtc . WebRTCPeerConnection ; < nl > < nl > import static im . actor . runtime . actors . ActorSystem . system ; < nl > < nl > @ @ - 165 , 5 + 166 , 10 @ @ public class PeerNodeInt extends ActorInterface { < nl > public void onStreamRemoved ( final long deviceId , final WebRTCMediaStream stream ) { < nl > callbackDest . send ( ( Runnable ) ( ) - > callback . onStreamRemoved ( deviceId , stream ) ) ; < nl > } < nl > + < nl > + @ Override < nl > + public void onPeerConnectionCreated ( WebRTCPeerConnection peerConnection ) { < nl > + callbackDest . send ( ( Runnable ) ( ) - > callback . onPeerConnectionCreated ( peerConnection ) ) ; < nl > + } < nl > } < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / CallVM . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / CallVM . java < nl > index 70f6102 . . 9e014d6 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / CallVM . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / CallVM . java < nl > @ @ - 86 , 4 + 86 , 8 @ @ public class CallVM { < nl > public void setCallEnd ( long callEnd ) { < nl > this . callEnd = callEnd ; < nl > } < nl > + < nl > + public ValueModel < WebRTCPeerConnection > getPeerConnection ( ) { < nl > + return peerConnection ; < nl > + } < nl > } < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / AndroidWebRTCRuntimeProvider . java b / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / AndroidWebRTCRuntimeProvider . java < nl > index ab2753a . . 0141deb 100644 < nl > - - - a / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / AndroidWebRTCRuntimeProvider . java < nl > + + + b / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / AndroidWebRTCRuntimeProvider . java < nl > @ @ - 25 , 8 + 25 , 6 @ @ public class AndroidWebRTCRuntimeProvider implements WebRTCRuntime { < nl > public static final PeerConnectionFactory FACTORY ; < nl > private static Object sVcLock = new Object ( ) ; < nl > private static Handler sVcHandler = null ; < nl > - private static PeerConnectionCallback connectionCallback ; < nl > - private static AndroidPeerConnection currentPeerConnection ; < nl > < nl > static { < nl > PeerConnectionFactory . initializeAndroidGlobals ( AndroidContext . getContext ( ) , true , true , true ) ; < nl > @ @ - 48 , 13 + 46 , 7 @ @ public class AndroidWebRTCRuntimeProvider implements WebRTCRuntime { < nl > return new Promise < > ( new PromiseFunc < WebRTCPeerConnection > ( ) { < nl > @ Override < nl > public void exec ( @ NonNull @ NotNull final PromiseResolver < WebRTCPeerConnection > resolver ) { < nl > - currentPeerConnection = new AndroidPeerConnection ( webRTCIceServers , settings ) ; < nl > - resolver . result ( currentPeerConnection ) ; < nl > - if ( connectionCallback ! = null ) { < nl > - connectionCallback . onPeerConncetionAvailable ( currentPeerConnection ) ; < nl > - connectionCallback = null ; < nl > - } < nl > - < nl > + resolver . result ( new AndroidPeerConnection ( webRTCIceServers , settings ) ) ; < nl > } < nl > } ) ; < nl > } < nl > @ @ - 83 , 27 + 75 , 4 @ @ public class AndroidWebRTCRuntimeProvider implements WebRTCRuntime { < nl > public static void postToHandler ( Runnable r ) { < nl > sVcHandler . post ( r ) ; < nl > } < nl > - < nl > - public AndroidPeerConnection getCurrentPeerConnection ( ) { < nl > - return currentPeerConnection ; < nl > - } < nl > - < nl > - public static void bindPeerConnection ( PeerConnectionCallback callback ) { < nl > - if ( currentPeerConnection ! = null ) { < nl > - callback . onPeerConncetionAvailable ( currentPeerConnection ) ; < nl > - } else { < nl > - connectionCallback = callback ; < nl > - } < nl > - } < nl > - < nl > - public static void unbindPeerConnection ( ) { < nl > - if ( currentPeerConnection ! = null ) { < nl > - currentPeerConnection . unbind ( ) ; < nl > - } < nl > - currentPeerConnection = null ; < nl > - } < nl > - < nl > - public interface PeerConnectionCallback { < nl > - void onPeerConncetionAvailable ( AndroidPeerConnection peerConnection ) ; < nl > - } < nl > } < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / webrtc / AndroidMediaStream . java b / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / webrtc / AndroidMediaStream . java < nl > index b00cd12 . . b2deaef 100644 < nl > - - - a / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / webrtc / AndroidMediaStream . java < nl > + + + b / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / webrtc / AndroidMediaStream . java < nl > @ @ - 7 , 6 + 7 , 7 @ @ import org . webrtc . AudioTrack ; < nl > import org . webrtc . MediaConstraints ; < nl > import org . webrtc . MediaStream ; < nl > import org . webrtc . VideoCapturer ; < nl > + import org . webrtc . VideoRenderer ; < nl > import org . webrtc . VideoSource ; < nl > import org . webrtc . VideoTrack ; < nl > < nl > @ @ - 113 , 6 + 114 , 12 @ @ public class AndroidMediaStream implements WebRTCMediaStream { < nl > return videoTrack ; < nl > } < nl > < nl > + public void removeRenderer ( VideoRenderer renderer ) { < nl > + if ( videoTrack ! = null ) { < nl > + videoTrack . removeRenderer ( renderer ) ; < nl > + } < nl > + } < nl > + < nl > public VideoSource getVideoSource ( ) { < nl > return videoSource ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / webrtc / AndroidPeerConnection . java b / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / webrtc / AndroidPeerConnection . java < nl > index 72e9326 . . e7decdf 100644 < nl > - - - a / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / webrtc / AndroidPeerConnection . java < nl > + + + b / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / webrtc / AndroidPeerConnection . java < nl > @ @ - 18 , 6 + 18 , 7 @ @ import java . util . ArrayList ; < nl > import java . util . EnumSet ; < nl > import java . util . HashMap ; < nl > < nl > + import im . actor . core . AndroidMessenger ; < nl > import im . actor . runtime . android . AndroidWebRTCRuntimeProvider ; < nl > import im . actor . runtime . promise . Promise ; < nl > import im . actor . runtime . promise . PromiseFunc ; < nl > @ @ - 33 , 7 + 34 , 6 @ @ public class AndroidPeerConnection implements WebRTCPeerConnection { < nl > < nl > private static final boolean LIBJINGLE _ LOGS = true ; < nl > < nl > - private OwnStreamCallback mediaStreamCallback ; < nl > private AndroidMediaStream stream ; < nl > private boolean videoCallEnabled = true ; < nl > < nl > @ @ - 95 , 9 + 95 , 6 @ @ public class AndroidPeerConnection implements WebRTCPeerConnection { < nl > public void onAddStream ( MediaStream stream ) { < nl > AndroidMediaStream stream1 = new AndroidMediaStream ( stream ) ; < nl > streams . put ( stream , stream1 ) ; < nl > - if ( mediaStreamCallback ! = null & & ! stream1 . isLocal ( ) ) { < nl > - mediaStreamCallback . onRemoteStreamAdd ( stream1 ) ; < nl > - } < nl > for ( WebRTCPeerConnectionCallback c : callbacks ) { < nl > c . onStreamAdded ( stream1 ) ; < nl > } < nl > @ @ - 112 , 10 + 109 , 6 @ @ public class AndroidPeerConnection implements WebRTCPeerConnection { < nl > } < nl > } < nl > < nl > - if ( mediaStreamCallback ! = null ) { < nl > - mediaStreamCallback . onRemoteStreamRemove ( stream1 ) ; < nl > - } < nl > - < nl > try { < nl > stream . videoTracks . get ( 0 ) . dispose ( ) ; < nl > } catch ( Exception e ) { < nl > @ @ - 149 , 6 + 142 , 13 @ @ public class AndroidPeerConnection implements WebRTCPeerConnection { < nl > if ( ! callbacks . contains ( callback ) ) { < nl > callbacks . add ( callback ) ; < nl > } < nl > + if ( stream ! = null ) { < nl > + callback . onOwnStreamAdded ( stream ) ; < nl > + } < nl > + < nl > + for ( MediaStream mediaStream : streams . keySet ( ) ) { < nl > + callback . onOwnStreamAdded ( streams . get ( mediaStream ) ) ; < nl > + } < nl > } < nl > < nl > @ Override < nl > @ @ - 172 , 8 + 172 , 8 @ @ public class AndroidPeerConnection implements WebRTCPeerConnection { < nl > @ Override < nl > public void run ( ) { < nl > AndroidPeerConnection . this . stream = ( AndroidMediaStream ) stream ; < nl > - if ( mediaStreamCallback ! = null ) { < nl > - mediaStreamCallback . onLocalStreamAvailable ( ( AndroidMediaStream ) stream ) ; < nl > + for ( WebRTCPeerConnectionCallback c : callbacks ) { < nl > + c . onOwnStreamAdded ( stream ) ; < nl > } < nl > peerConnection . addStream ( AndroidPeerConnection . this . stream . getStream ( ) ) ; < nl > } < nl > @ @ - 185 , 8 + 185 , 8 @ @ public class AndroidPeerConnection implements WebRTCPeerConnection { < nl > AndroidWebRTCRuntimeProvider . postToHandler ( new Runnable ( ) { < nl > @ Override < nl > public void run ( ) { < nl > - if ( mediaStreamCallback ! = null ) { < nl > - mediaStreamCallback . onOwnRemoved ( ) ; < nl > + for ( WebRTCPeerConnectionCallback c : callbacks ) { < nl > + c . onOwnStreamRemoved ( stream ) ; < nl > } < nl > peerConnection . removeStream ( ( ( AndroidMediaStream ) stream ) . getStream ( ) ) ; < nl > } < nl > @ @ - 367 , 8 + 367 , 8 @ @ public class AndroidPeerConnection implements WebRTCPeerConnection { < nl > public void run ( ) { < nl > peerConnection . dispose ( ) ; < nl > < nl > - if ( mediaStreamCallback ! = null ) { < nl > - mediaStreamCallback . onDispose ( ) ; < nl > + for ( WebRTCPeerConnectionCallback c : callbacks ) { < nl > + c . onDisposed ( ) ; < nl > } < nl > < nl > if ( stream ! = null & & stream . isLocal ( ) ) { < nl > @ @ - 382 , 26 + 382 , 11 @ @ public class AndroidPeerConnection implements WebRTCPeerConnection { < nl > < nl > } < nl > < nl > - public void bind ( OwnStreamCallback callback ) { < nl > - if ( stream ! = null ) { < nl > - callback . onLocalStreamAvailable ( stream ) ; < nl > - } < nl > - mediaStreamCallback = callback ; < nl > - } < nl > - < nl > - public void unbind ( ) { < nl > - mediaStreamCallback = null ; < nl > + public HashMap < MediaStream , AndroidMediaStream > getStreams ( ) { < nl > + return streams ; < nl > } < nl > < nl > - public interface OwnStreamCallback { < nl > - void onLocalStreamAvailable ( AndroidMediaStream stream ) ; < nl > - < nl > - void onRemoteStreamAdd ( AndroidMediaStream stream ) ; < nl > - < nl > - void onRemoteStreamRemove ( AndroidMediaStream stream ) ; < nl > - < nl > - void onOwnRemoved ( ) ; < nl > - < nl > - void onDispose ( ) ; < nl > + public AndroidMediaStream getStream ( ) { < nl > + return stream ; < nl > } < nl > } < nl > diff - - git a / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / webrtc / WebRTCPeerConnectionCallback . java b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / webrtc / WebRTCPeerConnectionCallback . java < nl > index 8051a3a . . cf65c56 100644 < nl > - - - a / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / webrtc / WebRTCPeerConnectionCallback . java < nl > + + + b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / webrtc / WebRTCPeerConnectionCallback . java < nl > @ @ - 38 , 4 + 38 , 29 @ @ public interface WebRTCPeerConnectionCallback { < nl > * / < nl > @ ObjectiveCName ( " onRenegotiationNeeded " ) < nl > void onRenegotiationNeeded ( ) ; < nl > + < nl > + / * * < nl > + * On Own Stream Added < nl > + * < nl > + * @ param stream stream < nl > + * / < nl > + @ ObjectiveCName ( " onOwnStreamAdded : " ) < nl > + void onOwnStreamAdded ( WebRTCMediaStream stream ) ; < nl > + < nl > + / * * < nl > + * On Own Stream Removed < nl > + * < nl > + * @ param stream removed stream . References can be different from that passed in onStreamAdded < nl > + * / < nl > + @ ObjectiveCName ( " onOwnStreamRemoved : " ) < nl > + void onOwnStreamRemoved ( WebRTCMediaStream stream ) ; < nl > + < nl > + < nl > + / * * < nl > + * Peer connection disposed < nl > + * / < nl > + @ ObjectiveCName ( " onDisposed " ) < nl > + void onDisposed ( ) ; < nl > + < nl > + < nl > } < nl > \ No newline at end of file
NEAREST DIFF (one line): diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteAdapter . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteAdapter . java < nl > new file mode 100644 < nl > index 0000000 . . 8382dc9 < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteAdapter . java < nl > @ @ - 0 , 0 + 1 , 105 @ @ < nl > + package im . actor . sdk . controllers . contacts ; < nl > + < nl > + import android . content . Context ; < nl > + import android . support . v7 . widget . RecyclerView ; < nl > + import android . view . ViewGroup ; < nl > + import android . widget . FrameLayout ; < nl > + < nl > + import java . util . ArrayList ; < nl > + import java . util . HashMap ; < nl > + import java . util . HashSet ; < nl > + import java . util . List ; < nl > + < nl > + import im . actor . core . entity . PhoneBookContact ; < nl > + import im . actor . core . entity . PhoneBookIds ; < nl > + import im . actor . runtime . android . AndroidContext ; < nl > + import im . actor . runtime . android . view . BindedListAdapter ; < nl > + import im . actor . runtime . bser . Bser ; < nl > + import im . actor . runtime . generic . mvvm . BindedDisplayList ; < nl > + import im . actor . sdk . view . adapters . HolderAdapter ; < nl > + import im . actor . sdk . view . adapters . OnItemClickedListener ; < nl > + import im . actor . sdk . view . adapters . RecyclerListView ; < nl > + import im . actor . sdk . view . adapters . ViewHolder ; < nl > + < nl > + import static im . actor . sdk . util . ActorSDKMessenger . messenger ; < nl > + < nl > + public class InviteAdapter extends HolderAdapter < PhoneBookContact > { < nl > + < nl > + List < PhoneBookContact > phoneBook ; < nl > + Context context ; < nl > + < nl > + private final HashSet < PhoneBookContact > selectedUsers = new HashSet < PhoneBookContact > ( ) ; < nl > + private final HashMap < PhoneBookContact , Integer > selectedContactType = new HashMap < PhoneBookContact , Integer > ( ) ; < nl > + < nl > + private final OnItemClickedListener < PhoneBookContact > onItemClickedListener ; < nl > + < nl > + < nl > + public InviteAdapter ( Context context , List < PhoneBookContact > phoneBook , OnItemClickedListener < PhoneBookContact > onItemClickedListener ) { < nl > + super ( context ) ; < nl > + this . phoneBook = phoneBook ; < nl > + selectedUsers . addAll ( phoneBook ) ; < nl > + this . context = context ; < nl > + this . onItemClickedListener = onItemClickedListener ; < nl > + } < nl > + < nl > + < nl > + @ Override < nl > + protected void onBindViewHolder ( ViewHolder < PhoneBookContact > holder , PhoneBookContact obj , int index , Context context ) { < nl > + PhoneBookContact item = phoneBook . get ( index ) ; < nl > + String fastName = null ; < nl > + if ( index = = 0 ) { < nl > + fastName = messenger ( ) . getFormatter ( ) . formatFastName ( item . getName ( ) ) ; < nl > + } else { < nl > + String prevName = messenger ( ) . getFormatter ( ) . formatFastName ( phoneBook . get ( index - 1 ) . getName ( ) ) ; < nl > + String currentFastName = messenger ( ) . getFormatter ( ) . formatFastName ( item . getName ( ) ) ; < nl > + if ( ! prevName . equals ( currentFastName ) ) { < nl > + fastName = currentFastName ; < nl > + } < nl > + } < nl > + Integer type = selectedContactType . get ( item ) ; < nl > + ( ( InviteContactHolder ) holder ) . bind ( item , fastName , " " , selectedUsers . contains ( item ) , type = = null ? - 1 : type , index = = getCount ( ) - 1 ) ; < nl > + } < nl > + < nl > + < nl > + < nl > + public void select ( PhoneBookContact contact , int type ) { < nl > + selectedUsers . add ( contact ) ; < nl > + selectedContactType . put ( contact , type ) ; < nl > + } < nl > + < nl > + public void unselect ( PhoneBookContact uid ) { < nl > + selectedUsers . remove ( uid ) ; < nl > + } < nl > + < nl > + public PhoneBookContact [ ] getSelected ( ) { < nl > + return selectedUsers . toArray ( new PhoneBookContact [ selectedUsers . size ( ) ] ) ; < nl > + } < nl > + < nl > + public HashMap < PhoneBookContact , Integer > getSelectedContactsTypes ( ) { < nl > + return selectedContactType ; < nl > + } < nl > + < nl > + public boolean isSelected ( PhoneBookContact id ) { < nl > + return selectedUsers . contains ( id ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public int getCount ( ) { < nl > + return phoneBook . size ( ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public PhoneBookContact getItem ( int position ) { < nl > + return phoneBook . get ( position ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public long getItemId ( int position ) { < nl > + return phoneBook . get ( position ) . getContactId ( ) ; < nl > + } < nl > + < nl > + @ Override < nl > + protected ViewHolder < PhoneBookContact > createHolder ( PhoneBookContact obj ) { < nl > + return new InviteContactHolder ( new FrameLayout ( context ) , context , onItemClickedListener ) ; < nl > + } < nl > + } < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteContactAdapter . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteContactAdapter . java < nl > deleted file mode 100644 < nl > index 2a220aa . . 0000000 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteContactAdapter . java < nl > + + + / dev / null < nl > @ @ - 1 , 106 + 0 , 0 @ @ < nl > - package im . actor . sdk . controllers . contacts ; < nl > - < nl > - import android . content . Context ; < nl > - import android . view . ViewGroup ; < nl > - import android . widget . FrameLayout ; < nl > - < nl > - import java . io . IOException ; < nl > - import java . util . HashMap ; < nl > - import java . util . HashSet ; < nl > - < nl > - import im . actor . core . entity . Contact ; < nl > - import im . actor . core . entity . PhoneBookContact ; < nl > - import im . actor . core . entity . PhoneBookIds ; < nl > - import im . actor . runtime . android . view . BindedListAdapter ; < nl > - import im . actor . runtime . bser . Bser ; < nl > - import im . actor . runtime . generic . mvvm . BindedDisplayList ; < nl > - import im . actor . sdk . controllers . contacts . view . ContactHolder ; < nl > - import im . actor . sdk . view . adapters . OnItemClickedListener ; < nl > - < nl > - import static im . actor . sdk . util . ActorSDKMessenger . messenger ; < nl > - < nl > - public class InviteContactAdapter extends BindedListAdapter < PhoneBookContact , InviteContactHolder > { < nl > - < nl > - private final HashSet < Long > selectedUsers = new HashSet < Long > ( ) ; < nl > - private final HashMap < Long , Integer > selectedContactType = new HashMap < Long , Integer > ( ) ; < nl > - < nl > - private final OnItemClickedListener < PhoneBookContact > onItemClickedListener ; < nl > - < nl > - < nl > - private final Context context ; < nl > - < nl > - private String query = " " ; < nl > - < nl > - public InviteContactAdapter ( BindedDisplayList < PhoneBookContact > displayList , Context context , < nl > - OnItemClickedListener < PhoneBookContact > onItemClickedListener ) { < nl > - super ( displayList ) ; < nl > - this . context = context ; < nl > - this . onItemClickedListener = onItemClickedListener ; < nl > - < nl > - updateIds ( ) ; < nl > - < nl > - } < nl > - < nl > - public void setQuery ( String query ) { < nl > - this . query = query ; < nl > - notifyDataSetChanged ( ) ; < nl > - } < nl > - < nl > - public void select ( long id , int type ) { < nl > - selectedUsers . add ( id ) ; < nl > - selectedContactType . put ( id , type ) ; < nl > - } < nl > - < nl > - public void unselect ( long uid ) { < nl > - selectedUsers . remove ( uid ) ; < nl > - } < nl > - < nl > - public Long [ ] getSelected ( ) { < nl > - return selectedUsers . toArray ( new Long [ selectedUsers . size ( ) ] ) ; < nl > - } < nl > - < nl > - public HashMap < Long , Integer > getSelectedContactsTypes ( ) { < nl > - return selectedContactType ; < nl > - } < nl > - < nl > - public boolean isSelected ( long id ) { < nl > - return selectedUsers . contains ( id ) ; < nl > - } < nl > - < nl > - public int getSelectedCount ( ) { < nl > - return selectedUsers . size ( ) ; < nl > - } < nl > - < nl > - @ Override < nl > - public void onBindViewHolder ( InviteContactHolder contactHolder , int index , PhoneBookContact item ) { < nl > - String fastName = null ; < nl > - if ( index = = 0 ) { < nl > - fastName = messenger ( ) . getFormatter ( ) . formatFastName ( item . getName ( ) ) ; < nl > - } else { < nl > - String prevName = messenger ( ) . getFormatter ( ) . formatFastName ( getItem ( index - 1 ) . getName ( ) ) ; < nl > - String currentFastName = messenger ( ) . getFormatter ( ) . formatFastName ( item . getName ( ) ) ; < nl > - if ( ! prevName . equals ( currentFastName ) ) { < nl > - fastName = currentFastName ; < nl > - } < nl > - } < nl > - Integer type = selectedContactType . get ( item . getContactId ( ) ) ; < nl > - contactHolder . bind ( item , fastName , query , selectedUsers . contains ( item . getContactId ( ) ) , type = = null ? - 1 : type , index = = getItemCount ( ) - 1 ) ; < nl > - } < nl > - < nl > - @ Override < nl > - public InviteContactHolder onCreateViewHolder ( ViewGroup viewGroup , int viewType ) { < nl > - return new InviteContactHolder ( new FrameLayout ( context ) , context , onItemClickedListener ) ; < nl > - } < nl > - < nl > - public void updateIds ( ) { < nl > - try { < nl > - PhoneBookIds ids = Bser . parse ( new PhoneBookIds ( ) , messenger ( ) . getPreferences ( ) . getBytes ( " phone _ book _ ids " ) ) ; < nl > - for ( long id : ids . getIds ( ) ) { < nl > - selectedUsers . add ( id ) ; < nl > - } < nl > - notifyDataSetChanged ( ) ; < nl > - } catch ( Exception e ) { < nl > - e . printStackTrace ( ) ; < nl > - } < nl > - } < nl > - } < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteContactHolder . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteContactHolder . java < nl > index 4216000 . . 9fb6622 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteContactHolder . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteContactHolder . java < nl > @ @ - 1 , 6 + 1 , 7 @ @ < nl > package im . actor . sdk . controllers . contacts ; < nl > < nl > import android . content . Context ; < nl > + import android . support . v7 . widget . AppCompatCheckBox ; < nl > import android . support . v7 . widget . RecyclerView ; < nl > import android . text . TextUtils ; < nl > import android . view . Gravity ; < nl > @ @ - 17 , 13 + 18 , 14 @ @ import im . actor . runtime . android . view . BindedViewHolder ; < nl > import im . actor . sdk . ActorSDK ; < nl > import im . actor . sdk . R ; < nl > import im . actor . sdk . util . Screen ; < nl > + import im . actor . sdk . view . adapters . ViewHolder ; < nl > import im . actor . sdk . view . avatar . AvatarView ; < nl > import im . actor . sdk . util . Fonts ; < nl > import im . actor . sdk . view . adapters . OnItemClickedListener ; < nl > import im . actor . sdk . view . SearchHighlight ; < nl > import im . actor . core . entity . Contact ; < nl > < nl > - public class InviteContactHolder extends BindedViewHolder { < nl > + public class InviteContactHolder extends ViewHolder < PhoneBookContact > { < nl > < nl > public static final int TYPE _ PHONE = 0 ; < nl > public static final int TYPE _ EMAIL = 1 ; < nl > @ @ - 39 , 18 + 41 , 20 @ @ public class InviteContactHolder extends BindedViewHolder { < nl > < nl > private FrameLayout cont ; < nl > < nl > + private FrameLayout fl ; < nl > + < nl > < nl > private OnItemClickedListener < PhoneBookContact > onItemClickedListener ; < nl > private final View separator ; < nl > < nl > public InviteContactHolder ( FrameLayout fl , Context context , OnItemClickedListener < PhoneBookContact > onItemClickedListener ) { < nl > - super ( fl ) ; < nl > < nl > + this . fl = fl ; < nl > this . onItemClickedListener = onItemClickedListener ; < nl > < nl > int padding = Screen . dp ( 16 ) ; < nl > < nl > - fl . setLayoutParams ( new RecyclerView . LayoutParams ( ViewGroup . LayoutParams . MATCH _ PARENT , Screen . dp ( 64 ) ) ) ; < nl > + fl . setLayoutParams ( new ViewGroup . LayoutParams ( ViewGroup . LayoutParams . MATCH _ PARENT , Screen . dp ( 64 ) ) ) ; < nl > < nl > cont = new FrameLayout ( context ) ; < nl > cont . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainBackgroundColor ( ) ) ; < nl > @ @ - 107 , 7 + 111 , 7 @ @ public class InviteContactHolder extends BindedViewHolder { < nl > subtitle = new TextView ( context ) ; < nl > subtitle . setTextColor ( ActorSDK . sharedActor ( ) . style . getTextSecondaryColor ( ) ) ; < nl > subtitle . setPadding ( Screen . dp ( 72 ) , 0 , Screen . dp ( 64 ) , 0 ) ; < nl > - subtitle . setTextSize ( 15 ) ; < nl > + subtitle . setTextSize ( 14 ) ; < nl > subtitle . setGravity ( Gravity . CENTER _ VERTICAL ) ; < nl > subtitle . setSingleLine ( true ) ; < nl > subtitle . setEllipsize ( TextUtils . TruncateAt . END ) ; < nl > @ @ - 116 , 8 + 120 , 8 @ @ public class InviteContactHolder extends BindedViewHolder { < nl > { < nl > FrameLayout . LayoutParams layoutParams = new FrameLayout . LayoutParams ( ViewGroup . LayoutParams . WRAP _ CONTENT , ViewGroup . LayoutParams . WRAP _ CONTENT ) ; < nl > layoutParams . gravity = Gravity . CENTER _ VERTICAL ; < nl > - layoutParams . topMargin = Screen . dp ( 14 ) ; < nl > - layoutParams . bottomMargin = Screen . dp ( 14 ) ; < nl > + layoutParams . topMargin = Screen . dp ( 12 ) ; < nl > + layoutParams . bottomMargin = Screen . dp ( 12 ) ; < nl > < nl > LinearLayout ll = new LinearLayout ( context ) ; < nl > LinearLayout . LayoutParams llp = new LinearLayout . LayoutParams ( LinearLayout . LayoutParams . WRAP _ CONTENT , LinearLayout . LayoutParams . WRAP _ CONTENT ) ; < nl > @ @ - 145 , 6 + 149 , 8 @ @ public class InviteContactHolder extends BindedViewHolder { < nl > layoutParams . leftMargin = Screen . dp ( 72 ) ; < nl > cont . addView ( separator , layoutParams ) ; < nl > } < nl > + < nl > + < nl > } < nl > < nl > public void bind ( final PhoneBookContact data , String shortName , String query , boolean selected , int type , boolean isLast ) { < nl > @ @ - 176 , 7 + 182 , 6 @ @ public class InviteContactHolder extends BindedViewHolder { < nl > < nl > isSelected . setChecked ( selected ) ; < nl > < nl > - < nl > cont . setOnClickListener ( new View . OnClickListener ( ) { < nl > @ Override < nl > public void onClick ( View v ) { < nl > @ @ - 184 , 6 + 189 , 14 @ @ public class InviteContactHolder extends BindedViewHolder { < nl > } < nl > } ) ; < nl > < nl > + cont . setOnLongClickListener ( new View . OnLongClickListener ( ) { < nl > + @ Override < nl > + public boolean onLongClick ( View v ) { < nl > + return onItemClickedListener . onLongClicked ( data ) ; < nl > + } < nl > + } ) ; < nl > + < nl > + < nl > < nl > if ( isLast ) { < nl > separator . setVisibility ( View . GONE ) ; < nl > @ @ - 192 , 6 + 205 , 16 @ @ public class InviteContactHolder extends BindedViewHolder { < nl > } < nl > } < nl > < nl > + @ Override < nl > + public View init ( PhoneBookContact data , ViewGroup viewGroup , Context context ) { < nl > + return fl ; < nl > + } < nl > + < nl > + @ Override < nl > + public void bind ( PhoneBookContact data , int position , Context context ) { < nl > + < nl > + } < nl > + < nl > public void unbind ( ) { < nl > avatar . unbind ( ) ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteFragment . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteFragment . java < nl > index 4509af7 . . bde4106 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteFragment . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteFragment . java < nl > @ @ - 1 , 6 + 1 , 5 @ @ < nl > package im . actor . sdk . controllers . contacts ; < nl > < nl > - import android . app . Activity ; < nl > import android . content . DialogInterface ; < nl > import android . content . Intent ; < nl > import android . net . Uri ; < nl > @ @ - 12 , 105 + 11 , 89 @ @ import android . view . MenuInflater ; < nl > import android . view . MenuItem ; < nl > import android . view . View ; < nl > import android . view . ViewGroup ; < nl > - import android . widget . FrameLayout ; < nl > import android . widget . TextView ; < nl > < nl > import java . util . ArrayList ; < nl > import java . util . HashMap ; < nl > + import java . util . List ; < nl > < nl > import im . actor . core . entity . PhoneBookContact ; < nl > - import im . actor . runtime . android . view . BindedListAdapter ; < nl > - import im . actor . runtime . generic . mvvm . BindedDisplayList ; < nl > - import im . actor . runtime . mvvm . Value ; < nl > - import im . actor . runtime . mvvm . ValueChangedListener ; < nl > import im . actor . sdk . ActorSDK ; < nl > import im . actor . sdk . R ; < nl > - import im . actor . sdk . controllers . fragment . DisplayListFragment ; < nl > - import im . actor . sdk . util . Screen ; < nl > + import im . actor . sdk . controllers . fragment . BaseFragment ; < nl > + import im . actor . sdk . core . AndroidPhoneBook ; < nl > import im . actor . sdk . view . adapters . OnItemClickedListener ; < nl > + import im . actor . sdk . view . adapters . RecyclerListView ; < nl > < nl > - import static im . actor . sdk . util . ActorSDKMessenger . messenger ; < nl > + public class InviteFragment extends BaseFragment { < nl > < nl > - public class InviteFragment extends DisplayListFragment < PhoneBookContact , InviteContactHolder > { < nl > < nl > - < nl > - private View emptyView ; < nl > private MenuItem sendButton ; < nl > + private RecyclerListView collection ; < nl > + private InviteAdapter adapter ; < nl > + private List < PhoneBookContact > contacts ; < nl > + private TextView emptyText ; < nl > < nl > public InviteFragment ( ) { < nl > } < nl > < nl > @ Override < nl > public View onCreateView ( LayoutInflater inflater , ViewGroup container , Bundle savedInstanceState ) { < nl > - return onCreateContactsView ( R . layout . fragment _ base _ contacts , inflater , container , savedInstanceState ) ; < nl > - } < nl > + View res = inflater . inflate ( R . layout . fragment _ list , container , false ) ; < nl > < nl > - protected View onCreateContactsView ( int layoutId , LayoutInflater inflater , ViewGroup container , Bundle savedInstanceState ) { < nl > - View res = inflate ( inflater , container , layoutId , messenger ( ) . buildPhoneBookContactsDisplayList ( ) ) ; < nl > - res . findViewById ( R . id . collection ) . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainBackgroundColor ( ) ) ; < nl > - emptyView = res . findViewById ( R . id . emptyCollection ) ; < nl > - if ( emptyView ! = null ) { < nl > - emptyView . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainBackgroundColor ( ) ) ; < nl > - emptyView . findViewById ( R . id . empty _ collection _ bg ) . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainColor ( ) ) ; < nl > - ( ( TextView ) emptyView . findViewById ( R . id . empty _ collection _ text ) ) . setTextColor ( ActorSDK . sharedActor ( ) . style . getMainColor ( ) ) ; < nl > - } else { < nl > - emptyView = res . findViewById ( R . id . empty _ collection _ text ) ; < nl > - if ( emptyView ! = null & & emptyView instanceof TextView ) { < nl > - ( ( TextView ) emptyView . findViewById ( R . id . empty _ collection _ text ) ) . setTextColor ( ActorSDK . sharedActor ( ) . style . getMainColor ( ) ) ; < nl > - } < nl > - } < nl > + res . findViewById ( R . id . listView ) . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainBackgroundColor ( ) ) ; < nl > < nl > - View headerPadding = new View ( getActivity ( ) ) ; < nl > - headerPadding . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainBackgroundColor ( ) ) ; < nl > - headerPadding . setLayoutParams ( new FrameLayout . LayoutParams ( ViewGroup . LayoutParams . MATCH _ PARENT , Screen . dp ( 8 ) ) ) ; < nl > - addHeaderView ( headerPadding ) ; < nl > + emptyText = ( TextView ) res . findViewById ( R . id . emptyView ) ; < nl > + emptyText . setTextColor ( ActorSDK . sharedActor ( ) . style . getTextSecondaryColor ( ) ) ; < nl > + emptyText . setText ( R . string . progress _ common ) ; < nl > < nl > + collection = ( RecyclerListView ) res . findViewById ( R . id . listView ) ; < nl > + AndroidPhoneBook phoneBookLoader = new AndroidPhoneBook ( ) ; < nl > + phoneBookLoader . useDelay ( false ) ; < nl > < nl > - if ( emptyView ! = null ) { < nl > - if ( messenger ( ) . getAppState ( ) . getIsContactsEmpty ( ) . get ( ) ) { < nl > - emptyView . setVisibility ( View . VISIBLE ) ; < nl > - } else { < nl > - emptyView . setVisibility ( View . GONE ) ; < nl > - } < nl > - } < nl > - bind ( messenger ( ) . getAppState ( ) . getIsContactsEmpty ( ) , new ValueChangedListener < Boolean > ( ) { < nl > - @ Override < nl > - public void onChanged ( Boolean val , Value < Boolean > Value ) { < nl > - if ( emptyView ! = null ) { < nl > - if ( val ) { < nl > - emptyView . setVisibility ( View . VISIBLE ) ; < nl > - } else { < nl > - emptyView . setVisibility ( View . GONE ) ; < nl > - } < nl > - } < nl > - } < nl > - } ) ; < nl > - res . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainBackgroundColor ( ) ) ; < nl > + phoneBookLoader . loadPhoneBook ( contacts - > { < nl > + if ( contacts . size ( ) > 0 ) { < nl > < nl > - return res ; < nl > - } < nl > + getActivity ( ) . runOnUiThread ( ( ) - > { < nl > + InviteFragment . this . contacts = contacts ; < nl > < nl > + adapter = new InviteAdapter ( getActivity ( ) , contacts , new OnItemClickedListener < PhoneBookContact > ( ) { < nl > + @ Override < nl > + public void onClicked ( PhoneBookContact item ) { < nl > < nl > - @ Override < nl > - protected BindedListAdapter < PhoneBookContact , InviteContactHolder > onCreateAdapter ( BindedDisplayList < PhoneBookContact > displayList , Activity activity ) { < nl > - return new InviteContactAdapter ( displayList , activity , new OnItemClickedListener < PhoneBookContact > ( ) { < nl > - @ Override < nl > - public void onClicked ( PhoneBookContact item ) { < nl > + onItemClicked ( item ) ; < nl > + } < nl > < nl > - onItemClicked ( item ) ; < nl > - } < nl > + @ Override < nl > + public boolean onLongClicked ( PhoneBookContact item ) { < nl > + return false ; < nl > + } < nl > < nl > - @ Override < nl > - public boolean onLongClicked ( PhoneBookContact item ) { < nl > - return false ; < nl > - } < nl > + } ) ; < nl > < nl > + collection . setAdapter ( adapter ) ; < nl > + < nl > + hideView ( emptyText ) ; < nl > + showView ( collection ) ; < nl > + < nl > + < nl > + if ( sendButton ! = null ) { < nl > + sendButton . setVisible ( true ) ; < nl > + } < nl > + } ) ; < nl > + < nl > + } < nl > } ) ; < nl > + < nl > + < nl > + res . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainBackgroundColor ( ) ) ; < nl > + < nl > + return res ; < nl > } < nl > < nl > + < nl > public void onItemClicked ( PhoneBookContact contact ) { < nl > - long contactId = contact . getContactId ( ) ; < nl > - boolean selected = isSelected ( contactId ) ; < nl > + boolean selected = isSelected ( contact ) ; < nl > boolean needDialog = contact . getEmails ( ) . size ( ) > 0 & & contact . getPhones ( ) . size ( ) > 0 ; < nl > < nl > if ( needDialog ) { < nl > @ @ - 123 , 9 + 106 , 9 @ @ public class InviteFragment extends DisplayListFragment < PhoneBookContact , Invite < nl > AlertDialog . Builder builder = new AlertDialog . Builder ( getActivity ( ) ) ; < nl > builder . setItems ( items , ( dialog , which ) - > { < nl > if ( which = = 2 ) { < nl > - unselect ( contactId ) ; < nl > + unselect ( contact ) ; < nl > } else { < nl > - select ( contactId , which ) ; < nl > + select ( contact , which ) ; < nl > } < nl > getAdapter ( ) . notifyDataSetChanged ( ) ; < nl > < nl > @ @ - 134 , 24 + 117 , 24 @ @ public class InviteFragment extends DisplayListFragment < PhoneBookContact , Invite < nl > < nl > } else { < nl > if ( selected ) { < nl > - unselect ( contactId ) ; < nl > + unselect ( contact ) ; < nl > } else { < nl > - select ( contactId , - 1 ) ; < nl > + select ( contact , - 1 ) ; < nl > } < nl > getAdapter ( ) . notifyDataSetChanged ( ) ; < nl > } < nl > } < nl > < nl > - public void select ( long id , int type ) { < nl > - ( ( InviteContactAdapter ) getAdapter ( ) ) . select ( id , type ) ; < nl > + public void select ( PhoneBookContact id , int type ) { < nl > + getAdapter ( ) . select ( id , type ) ; < nl > } < nl > < nl > - public void unselect ( long id ) { < nl > - ( ( InviteContactAdapter ) getAdapter ( ) ) . unselect ( id ) ; < nl > + public void unselect ( PhoneBookContact id ) { < nl > + getAdapter ( ) . unselect ( id ) ; < nl > } < nl > < nl > - public boolean isSelected ( long id ) { < nl > - return ( ( InviteContactAdapter ) getAdapter ( ) ) . isSelected ( id ) ; < nl > + public boolean isSelected ( PhoneBookContact id ) { < nl > + return getAdapter ( ) . isSelected ( id ) ; < nl > } < nl > < nl > @ Override < nl > @ @ - 159 , 7 + 142 , 9 @ @ public class InviteFragment extends DisplayListFragment < PhoneBookContact , Invite < nl > super . onCreateOptionsMenu ( menu , inflater ) ; < nl > inflater . inflate ( R . menu . invite , menu ) ; < nl > sendButton = menu . getItem ( 0 ) ; < nl > - checkSendButton ( ) ; < nl > + if ( adapter ! = null & & adapter . getCount ( ) > 0 ) { < nl > + sendButton . setVisible ( true ) ; < nl > + } < nl > } < nl > < nl > @ Override < nl > @ @ - 174 , 9 + 159 , 9 @ @ public class InviteFragment extends DisplayListFragment < PhoneBookContact , Invite < nl > private void sendInvites ( ) { < nl > ArrayList < Long > phones = new ArrayList < Long > ( ) ; < nl > ArrayList < String > emails = new ArrayList < String > ( ) ; < nl > - Long [ ] selected = ( ( InviteContactAdapter ) getAdapter ( ) ) . getSelected ( ) ; < nl > - HashMap < Long , Integer > selectedTypes = ( ( InviteContactAdapter ) getAdapter ( ) ) . getSelectedContactsTypes ( ) ; < nl > - PhoneBookContact contact ; < nl > + PhoneBookContact [ ] selected = getAdapter ( ) . getSelected ( ) ; < nl > + HashMap < PhoneBookContact , Integer > selectedTypes = getAdapter ( ) . getSelectedContactsTypes ( ) ; < nl > + < nl > Integer selectedType ; < nl > < nl > / / Prepare email / phones lists < nl > @ @ - 185 , 9 + 170 , 9 @ @ public class InviteFragment extends DisplayListFragment < PhoneBookContact , Invite < nl > String email ; < nl > long number ; < nl > < nl > - for ( long s : selected ) { < nl > - contact = messenger ( ) . getPhoneBookContact ( s ) ; < nl > - selectedType = selectedTypes . get ( s ) ; < nl > + for ( PhoneBookContact contact : selected ) { < nl > + < nl > + selectedType = selectedTypes . get ( contact ) ; < nl > selectedType = selectedType ! = null ? selectedType : InviteContactHolder . TYPE _ PHONE ; < nl > if ( ( selectedType = = InviteContactHolder . TYPE _ EMAIL & & contact . getEmails ( ) . size ( ) > 0 ) | | contact . getPhones ( ) . size ( ) = = 0 ) { < nl > email = contact . getEmails ( ) . get ( 0 ) . getEmail ( ) ; < nl > @ @ - 245 , 20 + 230 , 16 @ @ public class InviteFragment extends DisplayListFragment < PhoneBookContact , Invite < nl > startActivity ( i ) ; < nl > } < nl > < nl > - public void checkSendButton ( ) { < nl > - if ( sendButton ! = null ) { < nl > - sendButton . setVisible ( getDisplayList ( ) . getSize ( ) ! = 0 ) ; < nl > - } < nl > + < nl > + public InviteAdapter getAdapter ( ) { < nl > + return adapter ; < nl > } < nl > < nl > @ Override < nl > - public void onCollectionChanged ( ) { < nl > - super . onCollectionChanged ( ) ; < nl > - checkSendButton ( ) ; < nl > - InviteContactAdapter adapter = ( InviteContactAdapter ) getAdapter ( ) ; < nl > + public void onDestroy ( ) { < nl > + super . onDestroy ( ) ; < nl > if ( adapter ! = null ) { < nl > - adapter . updateIds ( ) ; < nl > + adapter . dispose ( ) ; < nl > } < nl > } < nl > - < nl > } < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / core / AndroidPhoneBook . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / core / AndroidPhoneBook . java < nl > index 241a93a . . 0b3bbd2 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / core / AndroidPhoneBook . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / core / AndroidPhoneBook . java < nl > @ @ - 33 , 16 + 33 , 20 @ @ public class AndroidPhoneBook implements PhoneBookProvider { < nl > private static final boolean DISABLE _ PHONE _ BOOK = false ; < nl > private static final String TAG = " PhoneBookLoader " ; < nl > private static PhoneNumberUtil phoneUtil = PhoneNumberUtil . getInstance ( ) ; < nl > + private boolean useDelay = true ; < nl > < nl > @ Override < nl > public void loadPhoneBook ( final Callback callback ) { < nl > new Thread ( ) { < nl > @ Override < nl > public void run ( ) { < nl > - try { < nl > - Thread . sleep ( PRELOAD _ DELAY ) ; < nl > - } catch ( InterruptedException e ) { < nl > - e . printStackTrace ( ) ; < nl > + if ( useDelay ) { < nl > + try { < nl > + Thread . sleep ( PRELOAD _ DELAY ) ; < nl > + } catch ( InterruptedException e ) { < nl > + e . printStackTrace ( ) ; < nl > + } < nl > + < nl > } < nl > ArrayList < PhoneBookContact > contacts = loadPhoneBook ( AndroidContext . getContext ( ) , < nl > Devices . getDeviceCountry ( ) ) ; < nl > @ @ - 243 , 4 + 247 , 8 @ @ public class AndroidPhoneBook implements PhoneBookProvider { < nl > Log . d ( TAG , " Phone book loaded in " + ( SystemClock . uptimeMillis ( ) - start ) + " ms in " + ( index ) + " iterations " ) ; < nl > return res ; < nl > } < nl > + < nl > + public void useDelay ( boolean useDelay ) { < nl > + this . useDelay = useDelay ; < nl > + } < nl > } < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / view / adapters / HolderAdapter . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / view / adapters / HolderAdapter . java < nl > index 5d09246 . . 5bf7599 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / view / adapters / HolderAdapter . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / view / adapters / HolderAdapter . java < nl > @ @ - 36 , 7 + 36 , 7 @ @ public abstract class HolderAdapter < V > extends BaseAdapter { < nl > view = convertView ; < nl > } < nl > < nl > - holder . bind ( obj , position , context ) ; < nl > + onBindViewHolder ( holder , obj , position , context ) ; < nl > < nl > return view ; < nl > } < nl > @ @ - 53 , 5 + 53 , 9 @ @ public abstract class HolderAdapter < V > extends BaseAdapter { < nl > } < nl > } < nl > < nl > + protected void onBindViewHolder ( ViewHolder < V > holder , V obj , int position , Context context ) { < nl > + holder . bind ( obj , position , context ) ; < nl > + } < nl > + < nl > protected abstract ViewHolder < V > createHolder ( V obj ) ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ invites . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ invites . xml < nl > new file mode 100644 < nl > index 0000000 . . c65edb1 < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ invites . xml < nl > @ @ - 0 , 0 + 1 , 20 @ @ < nl > + < ? xml version = " 1 . 0 " encoding = " utf - 8 " ? > < nl > + < FrameLayout xmlns : android = " http : / / schemas . android . com / apk / res / android " < nl > + android : layout _ width = " match _ parent " < nl > + android : layout _ height = " match _ parent " > < nl > + < nl > + < android . support . v7 . widget . RecyclerView < nl > + android : id = " @ + id / listView " < nl > + android : layout _ width = " match _ parent " < nl > + android : layout _ height = " match _ parent " < nl > + android : scrollbars = " vertical " / > < nl > + < nl > + < TextView < nl > + android : padding = " 20dp " < nl > + android : id = " @ + id / emptyView " < nl > + android : layout _ width = " match _ parent " < nl > + android : layout _ height = " wrap _ content " < nl > + android : layout _ marginTop = " 16dp " < nl > + android : gravity = " center " < nl > + android : textSize = " 18sp " / > < nl > + < / FrameLayout > < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / menu / invite . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / menu / invite . xml < nl > index 84f3a1d . . cddbf65 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / res / menu / invite . xml < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / menu / invite . xml < nl > @ @ - 8 , 6 + 8 , 7 @ @ < nl > xmlns : app = " http : / / schemas . android . com / apk / res - auto " > < nl > < nl > < item < nl > + android : visible = " false " < nl > android : id = " @ + id / send _ invites " < nl > android : icon = " @ drawable / attach _ send2 " < nl > android : title = " @ string / contacts _ invite _ via _ link " < nl > diff - - git a / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / AndroidMessenger . java b / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / AndroidMessenger . java < nl > index 62774f1 . . ecb3ac2 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / AndroidMessenger . java < nl > + + + b / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / AndroidMessenger . java < nl > @ @ - 383 , 10 + 383 , 6 @ @ public class AndroidMessenger extends im . actor . core . Messenger { < nl > return ( BindedDisplayList < Contact > ) modules . getDisplayListsModule ( ) . buildContactList ( false ) ; < nl > } < nl > < nl > - public BindedDisplayList < PhoneBookContact > buildPhoneBookContactsDisplayList ( ) { < nl > - return ( BindedDisplayList < PhoneBookContact > ) modules . getDisplayListsModule ( ) . buildPhoneBookContactList ( ) ; < nl > - } < nl > - < nl > private boolean isScreenOn ( ) { < nl > if ( android . os . Build . VERSION . SDK _ INT > = Build . VERSION _ CODES . KITKAT _ WATCH ) { < nl > DisplayManager dm = ( DisplayManager ) context . getSystemService ( Context . DISPLAY _ SERVICE ) ; < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java < nl > index 4664bc2 . . 49b417a 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java < nl > @ @ - 1652 , 10 + 1652 , 6 @ @ public class Messenger { < nl > . failure ( e - > callback . onError ( e ) ) ; < nl > } < nl > < nl > - public PhoneBookContact getPhoneBookContact ( long contactId ) { < nl > - return modules . getContactsModule ( ) . getPhoneBook ( ) . getValue ( contactId ) ; < nl > - } < nl > - < nl > / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / < nl > / / Bindings < nl > / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / contacts / BookImportActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / contacts / BookImportActor . java < nl > index 35e9776 . . d45528a 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / contacts / BookImportActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / contacts / BookImportActor . java < nl > @ @ - 107 , 13 + 107 , 7 @ @ public class BookImportActor extends ModuleActor { < nl > < nl > int newPhones = 0 ; < nl > int newEmails = 0 ; < nl > - ArrayList < Long > newids = new ArrayList < Long > ( ) ; < nl > - List < Long > oldids = new ArrayList < Long > ( ) ; < nl > - try { < nl > - oldids . addAll ( Bser . parse ( new PhoneBookIds ( ) , preferences ( ) . getBytes ( " phone _ book _ ids " ) ) . getIds ( ) ) ; < nl > - } catch ( Exception e ) { < nl > - e . printStackTrace ( ) ; < nl > - } < nl > + < nl > for ( PhoneBookContact record : phoneBook ) { < nl > for ( PhoneBookPhone phone : record . getPhones ( ) ) { < nl > if ( storage . isImported ( phone . getNumber ( ) ) ) { < nl > @ @ - 139 , 29 + 133 , 7 @ @ public class BookImportActor extends ModuleActor { < nl > newEmails + + ; < nl > } < nl > < nl > - newids . add ( record . getContactId ( ) ) ; < nl > - } < nl > - < nl > - int size = phoneBook . size ( ) ; < nl > - for ( PhoneBookContact c : phoneBook ) { < nl > - if ( ! oldids . contains ( c . getContactId ( ) ) ) { < nl > - context ( ) . getContactsModule ( ) . getPhoneBook ( ) . addOrUpdateItem ( c . setSortId ( size - - ) ) ; < nl > - } < nl > - } < nl > - < nl > - ArrayList < Long > toRemove = new ArrayList < Long > ( ) ; < nl > - for ( long oldId : oldids ) { < nl > - if ( ! newids . contains ( oldId ) ) { < nl > - toRemove . add ( oldId ) ; < nl > - } < nl > - } < nl > - < nl > - long [ ] toRemoveArray = new long [ toRemove . size ( ) ] ; < nl > - for ( int i = 0 ; i < toRemove . size ( ) ; i + + ) { < nl > - toRemoveArray [ i ] = toRemove . get ( i ) ; < nl > } < nl > - context ( ) . getContactsModule ( ) . getPhoneBook ( ) . removeItems ( toRemoveArray ) ; < nl > - context ( ) . getPreferences ( ) . putBytes ( " phone _ book _ ids " , new PhoneBookIds ( newids ) . toByteArray ( ) ) ; < nl > < nl > if ( ENABLE _ LOG ) { < nl > if ( newPhones = = 0 & & newEmails = = 0 ) { < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / contacts / ContactsModule . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / contacts / ContactsModule . java < nl > index 2014fa8 . . 760df24 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / contacts / ContactsModule . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / contacts / ContactsModule . java < nl > @ @ - 15 , 7 + 15 , 6 @ @ import im . actor . core . api . rpc . ResponseSearchContacts ; < nl > import im . actor . core . api . rpc . ResponseSeq ; < nl > import im . actor . core . api . updates . UpdateContactsAdded ; < nl > import im . actor . core . api . updates . UpdateContactsRemoved ; < nl > - import im . actor . core . entity . PhoneBookContact ; < nl > import im . actor . core . entity . User ; < nl > import im . actor . core . modules . AbsModule ; < nl > import im . actor . core . modules . Configuration ; < nl > @ @ - 38 , 7 + 37 , 6 @ @ import static im . actor . runtime . actors . ActorSystem . system ; < nl > public class ContactsModule extends AbsModule { < nl > < nl > private ListEngine < Contact > contacts ; < nl > - private ListEngine < PhoneBookContact > phoneBook ; < nl > private ActorRef bookImportActor ; < nl > private ActorRef contactSyncActor ; < nl > private SyncKeyValue bookImportState ; < nl > @ @ - 47 , 7 + 45 , 6 @ @ public class ContactsModule extends AbsModule { < nl > super ( modules ) ; < nl > < nl > contacts = Storage . createList ( STORAGE _ CONTACTS , Contact . CREATOR ) ; < nl > - phoneBook = Storage . createList ( STORAGE _ PHONE _ BOOK , PhoneBookContact . CREATOR ) ; < nl > bookImportState = new SyncKeyValue ( Storage . createKeyValue ( STORAGE _ BOOK _ IMPORT ) ) ; < nl > } < nl > < nl > @ @ - 64 , 11 + 61 , 6 @ @ public class ContactsModule extends AbsModule { < nl > return contacts ; < nl > } < nl > < nl > - public ListEngine < PhoneBookContact > getPhoneBook ( ) { < nl > - / / This one < nl > - return phoneBook ; < nl > - } < nl > - < nl > public void onPhoneBookChanged ( ) { < nl > bookImportActor . send ( new BookImportActor . PerformSync ( ) ) ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / misc / DisplayLists . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / misc / DisplayLists . java < nl > index 504ca13 . . 756dd9e 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / misc / DisplayLists . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / misc / DisplayLists . java < nl > @ @ - 10 , 7 + 10 , 6 @ @ import im . actor . core . entity . Contact ; < nl > import im . actor . core . entity . Dialog ; < nl > import im . actor . core . entity . Message ; < nl > import im . actor . core . entity . Peer ; < nl > - import im . actor . core . entity . PhoneBookContact ; < nl > import im . actor . core . entity . SearchEntity ; < nl > import im . actor . core . modules . AbsModule ; < nl > import im . actor . core . modules . ModuleContext ; < nl > @ @ - 91 , 15 + 90 , 6 @ @ public class DisplayLists extends AbsModule { < nl > return res ; < nl > } < nl > < nl > - public PlatformDisplayList < PhoneBookContact > buildPhoneBookContactList ( ) { < nl > - im . actor . runtime . Runtime . checkMainThread ( ) ; < nl > - < nl > - PlatformDisplayList < PhoneBookContact > res = Storage . createDisplayList ( context ( ) . getContactsModule ( ) . getPhoneBook ( ) , < nl > - false , PhoneBookContact . ENTITY _ NAME ) ; < nl > - res . initTop ( ) ; < nl > - return res ; < nl > - } < nl > - < nl > public PlatformDisplayList < Message > buildChatList ( final Peer peer , boolean isShared ) { < nl > im . actor . runtime . Runtime . checkMainThread ( ) ;

TEST DIFF:
diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java 
 index d95e4f6 . . c9b24ac 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java 
 @ @ - 14 , 7 + 14 , 6 @ @ import android . media . AudioManager ; 
 import android . media . Ringtone ; 
 import android . media . RingtoneManager ; 
 import android . net . Uri ; 
 - import android . opengl . GLSurfaceView ; 
 import android . os . Bundle ; 
 import android . os . PowerManager ; 
 import android . os . Vibrator ; 
 @ @ - 31 , 16 + 30 , 18 @ @ import android . widget . ImageButton ; 
 import android . widget . TextView ; 
 
 import org . webrtc . EglBase ; 
 - import org . webrtc . RendererCommon ; 
 + import org . webrtc . MediaStream ; 
 import org . webrtc . SurfaceViewRenderer ; 
 import org . webrtc . VideoRenderer ; 
 - import org . webrtc . VideoRendererGui ; 
 import org . webrtc . VideoSource ; 
 
 import java . text . DateFormat ; 
 import java . text . SimpleDateFormat ; 
 import java . util . ArrayList ; 
 import java . util . Date ; 
 + import java . util . HashMap ; 
 + import java . util . HashSet ; 
 + import java . util . Set ; 
 import java . util . TimeZone ; 
 
 import im . actor . core . entity . PeerType ; 
 @ @ - 63 , 6 + 64 , 9 @ @ import im . actor . runtime . android . webrtc . AndroidPeerConnection ; 
 import im . actor . runtime . mvvm . Value ; 
 import im . actor . runtime . mvvm . ValueChangedListener ; 
 import im . actor . runtime . mvvm . ValueModel ; 
 + import im . actor . runtime . webrtc . WebRTCMediaStream ; 
 + import im . actor . runtime . webrtc . WebRTCPeerConnection ; 
 + import im . actor . runtime . webrtc . WebRTCPeerConnectionCallback ; 
 import im . actor . sdk . ActorSDK ; 
 import im . actor . sdk . R ; 
 import im . actor . sdk . controllers . calls . view . CallAvatarLayerAnimator ; 
 @ @ - 109 , 8 + 113 , 19 @ @ public class CallFragment extends BaseFragment { 
 private View layer3 ; 
 private VideoSource source ; 
 private EglBase rootEglBase ; 
 - private SurfaceViewRenderer localRender ; 
 - private SurfaceViewRenderer remoteRender ; 
 + private VideoRenderer localRender ; 
 + private VideoRenderer remoteRender ; 
 + private SurfaceViewRenderer localVideoView ; 
 + private SurfaceViewRenderer remoteVideoView ; 
 + 
 + private TextView muteCallTv ; 
 + private TextView videoTv ; 
 + private ViewGroup container ; 
 + private TintImageView speaker ; 
 + private TintImageView muteCall ; 
 + private TextView speakerTV ; 
 + private boolean sourceIsStopped = false ; 
 + private WebRTCPeerConnectionCallback webRTCPeerConnectionCallback ; 
 
 public CallFragment ( ) { 
 
 @ @ - 132 , 7 + 147 , 7 @ @ public class CallFragment extends BaseFragment { 
 public View onCreateView ( LayoutInflater inflater , ViewGroup container , 
 Bundle savedInstanceState ) { 
 
 - 
 + this . container = container ; 
 manager = ( NotificationManager ) getActivity ( ) . getSystemService ( Context . NOTIFICATION _ SERVICE ) ; 
 
 FrameLayout cont = ( FrameLayout ) inflater . inflate ( R . layout . fragment _ call , container , false ) ; 
 @ @ - 269 , 9 + 284 , 9 @ @ public class CallFragment extends BaseFragment { 
 
 
 audioManager . getStreamVolume ( AudioManager . STREAM _ VOICE _ CALL ) ; 
 - final TintImageView speaker = ( TintImageView ) cont . findViewById ( R . id . speaker ) ; 
 + speaker = ( TintImageView ) cont . findViewById ( R . id . speaker ) ; 
 speaker . setResource ( R . drawable . ic _ volume _ up _ white _ 24dp ) ; 
 - final TextView speakerTV = ( TextView ) cont . findViewById ( R . id . speaker _ tv ) ; 
 + speakerTV = ( TextView ) cont . findViewById ( R . id . speaker _ tv ) ; 
 cont . findViewById ( R . id . speaker _ btn ) . setOnClickListener ( new View . OnClickListener ( ) { 
 @ Override 
 public void onClick ( View v ) { 
 @ @ - 280 , 8 + 295 , 8 @ @ public class CallFragment extends BaseFragment { 
 } ) ; 
 checkSpeaker ( speaker , speakerTV ) ; 
 
 - final TintImageView muteCall = ( TintImageView ) cont . findViewById ( R . id . mute ) ; 
 - final TextView muteCallTv = ( TextView ) cont . findViewById ( R . id . mute _ tv ) ; 
 + muteCall = ( TintImageView ) cont . findViewById ( R . id . mute ) ; 
 + muteCallTv = ( TextView ) cont . findViewById ( R . id . mute _ tv ) ; 
 muteCall . setResource ( R . drawable . ic _ mic _ off _ white _ 24dp ) ; 
 cont . findViewById ( R . id . mute _ btn ) . setOnClickListener ( new View . OnClickListener ( ) { 
 @ Override 
 @ @ - 292 , 7 + 307 , 7 @ @ public class CallFragment extends BaseFragment { 
 
 final TintImageView video = ( TintImageView ) cont . findViewById ( R . id . video ) ; 
 video . setResource ( R . drawable . ic _ videocam _ white _ 24dp ) ; 
 - TextView videoTv = ( TextView ) cont . findViewById ( R . id . video _ tv ) ; 
 + videoTv = ( TextView ) cont . findViewById ( R . id . video _ tv ) ; 
 videoTv . setTextColor ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; 
 video . setTint ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; 
 
 @ @ - 313 , 128 + 328 , 81 @ @ public class CallFragment extends BaseFragment { 
 
 rootEglBase = EglBase . create ( ) ; 
 
 - AndroidWebRTCRuntimeProvider . bindPeerConnection ( new AndroidWebRTCRuntimeProvider . PeerConnectionCallback ( ) { 
 - @ Override 
 - public void onPeerConncetionAvailable ( AndroidPeerConnection peerConnection ) { 
 - peerConnection . bind ( new AndroidPeerConnection . OwnStreamCallback ( ) { 
 - @ Override 
 - public void onLocalStreamAvailable ( AndroidMediaStream stream ) { 
 - if ( stream . getVideoTrack ( ) ! = null ) { 
 - 
 - 
 - getActivity ( ) . runOnUiThread ( new Runnable ( ) { 
 - @ Override 
 - public void run ( ) { 
 - source = stream . getVideoSource ( ) ; 
 - localRender = new SurfaceViewRenderer ( getActivity ( ) ) ; 
 - localRender . setZOrderMediaOverlay ( true ) ; 
 - localRender . init ( rootEglBase . getEglBaseContext ( ) , null ) ; 
 - 
 - stream . getVideoTrack ( ) . addRenderer ( new VideoRenderer ( localRender ) ) ; 
 - container . addView ( localRender , Screen . dp ( 200 ) , Screen . dp ( 200 ) ) ; 
 - } 
 - } ) ; 
 - } 
 - } 
 - 
 - @ Override 
 - public void onRemoteStreamAdd ( AndroidMediaStream stream ) { 
 - if ( stream . getVideoTrack ( ) ! = null ) { 
 - 
 - getActivity ( ) . runOnUiThread ( new Runnable ( ) { 
 - @ Override 
 - public void run ( ) { 
 - remoteRender = new SurfaceViewRenderer ( getActivity ( ) ) ; 
 - remoteRender . init ( rootEglBase . getEglBaseContext ( ) , null ) ; 
 - stream . getVideoTrack ( ) . addRenderer ( new VideoRenderer ( remoteRender ) ) ; 
 - container . addView ( remoteRender , Screen . dp ( 400 ) , Screen . dp ( 400 ) ) ; 
 - } 
 - } ) ; 
 - } 
 - } 
 + remoteVideoView = ( SurfaceViewRenderer ) cont . findViewById ( R . id . remote _ renderer ) ; 
 + remoteVideoView . init ( rootEglBase . getEglBaseContext ( ) , null ) ; 
 
 - @ Override 
 - public void onRemoteStreamRemove ( AndroidMediaStream stream ) { 
 + localVideoView = ( SurfaceViewRenderer ) cont . findViewById ( R . id . local _ renderer ) ; 
 + / / localVideoView . setZOrderMediaOverlay ( true ) ; 
 + localVideoView . init ( rootEglBase . getEglBaseContext ( ) , null ) ; 
 
 - } 
 
 - @ Override 
 - public void onOwnRemoved ( ) { 
 - 
 - } 
 - 
 - @ Override 
 - public void onDispose ( ) { 
 - if ( localRender ! = null ) { 
 - localRender . release ( ) ; 
 - } 
 + webRTCPeerConnectionCallback = new WebRTCPeerConnectionCallback ( ) { 
 + @ Override 
 + public void onCandidate ( int label , String id , String candidate ) { 
 
 - if ( remoteRender ! = null ) { 
 - remoteRender . release ( ) ; 
 - } 
 - } 
 - } ) ; 
 } 
 - } ) ; 
 - 
 - if ( call ! = null ) { 
 - bind ( call . getIsMuted ( ) , new ValueChangedListener < Boolean > ( ) { 
 - @ Override 
 - public void onChanged ( Boolean val , Value < Boolean > valueModel ) { 
 - if ( getActivity ( ) ! = null ) { 
 - if ( val ) { 
 
 - muteCallTv . setTextColor ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; 
 - muteCall . setTint ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; 
 - } else { 
 - muteCallTv . setTextColor ( Color . WHITE ) ; 
 - muteCall . setTint ( Color . WHITE ) ; 
 + @ Override 
 + public void onStreamAdded ( WebRTCMediaStream remoteStream ) { 
 + AndroidMediaStream stream = ( AndroidMediaStream ) remoteStream ; 
 + if ( stream . getVideoTrack ( ) ! = null ) { 
 + 
 + getActivity ( ) . runOnUiThread ( new Runnable ( ) { 
 + @ Override 
 + public void run ( ) { 
 + remoteRender = new VideoRenderer ( remoteVideoView ) ; 
 + stream . getVideoTrack ( ) . addRenderer ( remoteRender ) ; 
 + remoteVideoView . setVisibility ( View . VISIBLE ) ; 
 } 
 - } 
 + } ) ; 
 } 
 - } ) ; 
 + } 
 
 - bind ( call . getState ( ) , new ValueChangedListener < CallState > ( ) { 
 - @ Override 
 - public void onChanged ( CallState val , Value < CallState > valueModel ) { 
 - if ( currentState ! = val ) { 
 - currentState = val ; 
 - switch ( val ) { 
 + @ Override 
 + public void onStreamRemoved ( WebRTCMediaStream stream ) { 
 
 - case RINGING : 
 - if ( call . isOutgoing ( ) ) { 
 - statusTV . setText ( R . string . call _ outgoing ) ; 
 - } else { 
 - statusTV . setText ( R . string . call _ incoming ) ; 
 - toggleSpeaker ( speaker , speakerTV , true ) ; 
 - initIncoming ( ) ; 
 - } 
 - break ; 
 + } 
 
 - case CONNECTING : 
 - statusTV . setText ( R . string . call _ connecting ) ; 
 - break ; 
 + @ Override 
 + public void onOwnStreamAdded ( WebRTCMediaStream ownStream ) { 
 + AndroidMediaStream stream = ( AndroidMediaStream ) ownStream ; 
 + if ( stream . getVideoTrack ( ) ! = null ) { 
 
 - case IN _ PROGRESS : 
 - toggleSpeaker ( speaker , speakerTV , false ) ; 
 - onConnected ( ) ; 
 - startTimer ( ) ; 
 - break ; 
 
 - case ENDED : 
 - statusTV . setText ( R . string . call _ ended ) ; 
 - onCallEnd ( ) ; 
 - break ; 
 + getActivity ( ) . runOnUiThread ( new Runnable ( ) { 
 + @ Override 
 + public void run ( ) { 
 + source = stream . getVideoSource ( ) ; 
 
 + localRender = new VideoRenderer ( localVideoView ) ; 
 + stream . getVideoTrack ( ) . addRenderer ( localRender ) ; 
 + localVideoView . setVisibility ( View . VISIBLE ) ; 
 } 
 - } 
 + } ) ; 
 } 
 - } ) ; 
 + } 
 
 - } 
 + @ Override 
 + public void onOwnStreamRemoved ( WebRTCMediaStream stream ) { 
 
 + } 
 
 + @ Override 
 + public void onRenegotiationNeeded ( ) { 
 + 
 + } 
 + 
 + @ Override 
 + public void onDisposed ( ) { 
 + if ( localVideoView ! = null ) { 
 + localVideoView . release ( ) ; 
 + } 
 
 + if ( remoteVideoView ! = null ) { 
 + remoteVideoView . release ( ) ; 
 + } 
 + } 
 + } ; 
 
 return cont ; 
 } 
 @ @ - 630 , 10 + 598 , 9 @ @ public class CallFragment extends BaseFragment { 
 super . onPause ( ) ; 
 if ( source ! = null ) { 
 source . stop ( ) ; 
 + sourceIsStopped = true ; 
 } 
 
 - AndroidWebRTCRuntimeProvider . unbindPeerConnection ( ) ; 
 - 
 if ( call ! = null & & call . getState ( ) . get ( ) ! = CallState . ENDED ) { 
 final NotificationCompat . Builder builder = new NotificationCompat . Builder ( getActivity ( ) ) ; 
 builder . setAutoCancel ( true ) ; 
 @ @ - 654 , 6 + 621 , 24 @ @ public class CallFragment extends BaseFragment { 
 manager . notify ( NOTIFICATION _ ID , n ) ; 
 } 
 
 + if ( call ! = null ) { 
 + AndroidPeerConnection webRTCPeerConnection = ( AndroidPeerConnection ) call . getPeerConnection ( ) . get ( ) ; 
 + if ( webRTCPeerConnection ! = null ) { 
 + webRTCPeerConnection . removeCallback ( webRTCPeerConnectionCallback ) ; 
 + 
 + HashMap < MediaStream , AndroidMediaStream > mediaStreams = ( ( AndroidPeerConnection ) webRTCPeerConnection ) . getStreams ( ) ; 
 + for ( MediaStream mediaStream : mediaStreams . keySet ( ) ) { 
 + mediaStreams . get ( mediaStream ) . removeRenderer ( remoteRender ) ; 
 + } 
 + 
 + AndroidMediaStream stream = webRTCPeerConnection . getStream ( ) ; 
 + if ( stream ! = null ) { 
 + stream . removeRenderer ( localRender ) ; 
 + } 
 + } 
 + 
 + } 
 + 
 disableWakeLock ( ) ; 
 
 } 
 @ @ - 663 , 9 + 648 , 78 @ @ public class CallFragment extends BaseFragment { 
 super . onResume ( ) ; 
 enableWakeLock ( ) ; 
 
 + if ( source ! = null ) { 
 + source . restart ( ) ; 
 + sourceIsStopped = false ; 
 + } 
 + 
 manager . cancel ( NOTIFICATION _ ID ) ; 
 / / animator . popAnimation ( true ) ; 
 + if ( call ! = null ) { 
 + 
 + bind ( call . getPeerConnection ( ) , new ValueChangedListener < WebRTCPeerConnection > ( ) { 
 + @ Override 
 + public void onChanged ( WebRTCPeerConnection val , Value < WebRTCPeerConnection > valueModel ) { 
 + if ( val ! = null ) { 
 + val . addCallback ( webRTCPeerConnectionCallback ) ; 
 + } 
 + } 
 + } ) ; 
 + 
 + bind ( call . getIsMuted ( ) , new ValueChangedListener < Boolean > ( ) { 
 + @ Override 
 + public void onChanged ( Boolean val , Value < Boolean > valueModel ) { 
 + if ( getActivity ( ) ! = null ) { 
 + if ( val ) { 
 
 + muteCallTv . setTextColor ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; 
 + muteCall . setTint ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; 
 + } else { 
 + muteCallTv . setTextColor ( Color . WHITE ) ; 
 + muteCall . setTint ( Color . WHITE ) ; 
 + } 
 + } 
 + } 
 + } ) ; 
 + 
 + bind ( call . getState ( ) , new ValueChangedListener < CallState > ( ) { 
 + @ Override 
 + public void onChanged ( CallState val , Value < CallState > valueModel ) { 
 + if ( currentState ! = val ) { 
 + currentState = val ; 
 + switch ( val ) { 
 + 
 + case RINGING : 
 + if ( call . isOutgoing ( ) ) { 
 + statusTV . setText ( R . string . call _ outgoing ) ; 
 + } else { 
 + statusTV . setText ( R . string . call _ incoming ) ; 
 + toggleSpeaker ( speaker , speakerTV , true ) ; 
 + initIncoming ( ) ; 
 + } 
 + break ; 
 + 
 + case CONNECTING : 
 + statusTV . setText ( R . string . call _ connecting ) ; 
 + break ; 
 + 
 + case IN _ PROGRESS : 
 + toggleSpeaker ( speaker , speakerTV , false ) ; 
 + onConnected ( ) ; 
 + startTimer ( ) ; 
 + break ; 
 + 
 + case ENDED : 
 + statusTV . setText ( R . string . call _ ended ) ; 
 + onCallEnd ( ) ; 
 + break ; 
 + 
 + } 
 + } 
 + } 
 + } ) ; 
 + 
 + } 
 } 
 
 class CallMembersAdapter extends HolderAdapter < CallMember > { 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml 
 index fff1bef . . 9d7aeac 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml 
 @ @ - 10 , 6 + 10 , 21 @ @ 
 android : layout _ width = " match _ parent " 
 android : layout _ height = " match _ parent " / > 
 
 + < org . webrtc . SurfaceViewRenderer 
 + android : visibility = " invisible " 
 + android : id = " @ + id / remote _ renderer " 
 + android : layout _ width = " match _ parent " 
 + android : layout _ height = " match _ parent " / > 
 + 
 + < org . webrtc . SurfaceViewRenderer 
 + android : visibility = " invisible " 
 + android : id = " @ + id / local _ renderer " 
 + android : layout _ width = " 100dp " 
 + android : layout _ height = " 50dp " 
 + android : layout _ gravity = " bottom | left " 
 + android : layout _ marginLeft = " 50dp " 
 + android : layout _ marginBottom = " 50dp " / > 
 + 
 < LinearLayout 
 android : layout _ width = " match _ parent " 
 android : layout _ height = " match _ parent " 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java 
 index 1cdce73 . . 2c38104 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java 
 @ @ - 1 , 5 + 1 , 7 @ @ 
 package im . actor . core . modules . calls ; 
 
 + import org . jetbrains . annotations . NotNull ; 
 + 
 import im . actor . core . api . rpc . RequestDoCall ; 
 import im . actor . core . api . rpc . RequestGetCallInfo ; 
 import im . actor . core . api . rpc . RequestJoinCall ; 
 @ @ - 16 , 6 + 18 , 7 @ @ import im . actor . core . viewmodel . CommandCallback ; 
 import im . actor . runtime . actors . messages . PoisonPill ; 
 import im . actor . runtime . function . Consumer ; 
 import im . actor . runtime . power . WakeLock ; 
 + import im . actor . runtime . webrtc . WebRTCPeerConnection ; 
 
 import static im . actor . core . entity . EntityConverter . convert ; 
 
 @ @ - 88 , 6 + 91 , 11 @ @ public class CallActor extends AbsCallActor { 
 } 
 
 @ Override 
 + public void onPeerConnectionCreated ( @ NotNull WebRTCPeerConnection peerConnection ) { 
 + callVM . getPeerConnection ( ) . change ( peerConnection ) ; 
 + } 
 + 
 + @ Override 
 public void onCallEnabled ( ) { 
 isActive = true ; 
 if ( isAnswered ) { 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / AbsCallActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / AbsCallActor . java 
 index 8f64516 . . 0298a0b 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / AbsCallActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / AbsCallActor . java 
 @ @ - 7 , 6 + 7 , 7 @ @ import im . actor . runtime . WebRTC ; 
 import im . actor . runtime . actors . Actor ; 
 import im . actor . runtime . actors . ActorCreator ; 
 import im . actor . runtime . actors . ActorRef ; 
 + import im . actor . runtime . webrtc . WebRTCPeerConnection ; 
 
 public abstract class AbsCallActor extends ModuleActor implements CallBusCallback { 
 
 @ @ - 83 , 5 + 84 , 10 @ @ public abstract class AbsCallActor extends ModuleActor implements CallBusCallbac 
 public void onBusStopped ( ) { 
 self ( ) . send ( ( Runnable ) ( ) - > AbsCallActor . this . onBusStopped ( ) ) ; 
 } 
 + 
 + @ Override 
 + public void onPeerConnectionCreated ( WebRTCPeerConnection peerConnection ) { 
 + self ( ) . send ( ( Runnable ) ( ) - > AbsCallActor . this . onPeerConnectionCreated ( peerConnection ) ) ; 
 + } 
 } 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java 
 index 437cbb0 . . 5107836 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java 
 @ @ - 23 , 6 + 23 , 7 @ @ import im . actor . runtime . actors . Actor ; 
 import im . actor . runtime . actors . ActorCreator ; 
 import im . actor . runtime . actors . ActorRef ; 
 import im . actor . runtime . webrtc . WebRTCMediaStream ; 
 + import im . actor . runtime . webrtc . WebRTCPeerConnection ; 
 
 / * - [ 
 # pragma clang diagnostic ignored " - Wnullability - completeness " 
 @ @ - 125 , 6 + 126 , 11 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { 
 
 } 
 
 + @ Override 
 + public void onPeerConnectionCreated ( WebRTCPeerConnection peerConnection ) { 
 + 
 + } 
 + 
 
 / / 
 / / Actions 
 @ @ - 343 , 5 + 349 , 11 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { 
 public void onStreamRemoved ( final long deviceId , @ NotNull final WebRTCMediaStream stream ) { 
 self ( ) . send ( ( Runnable ) ( ) - > callCallback . onStreamRemoved ( deviceId , stream ) ) ; 
 } 
 + 
 + @ Override 
 + public void onPeerConnectionCreated ( WebRTCPeerConnection peerConnection ) { 
 + self ( ) . send ( ( Runnable ) ( ) - > callCallback . onPeerConnectionCreated ( peerConnection ) ) ; 
 + 
 + } 
 } 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java 
 index 51028fe . . f94a823 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java 
 @ @ - 2 , 6 + 2 , 8 @ @ package im . actor . core . modules . calls . peers ; 
 
 import org . jetbrains . annotations . NotNull ; 
 
 + import im . actor . runtime . webrtc . WebRTCPeerConnection ; 
 + 
 public interface CallBusCallback { 
 
 void onBusStarted ( @ NotNull String busId ) ; 
 @ @ - 11 , 4 + 13 , 6 @ @ public interface CallBusCallback { 
 void onCallEnabled ( ) ; 
 
 void onBusStopped ( ) ; 
 + 
 + void onPeerConnectionCreated ( @ NotNull WebRTCPeerConnection peerConnection ) ; 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallActor . java 
 index 6781870 . . c73ea77 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallActor . java 
 @ @ - 20 , 6 + 20 , 7 @ @ import im . actor . runtime . WebRTC ; 
 import im . actor . runtime . actors . messages . PoisonPill ; 
 import im . actor . runtime . function . Consumer ; 
 import im . actor . runtime . webrtc . WebRTCMediaStream ; 
 + import im . actor . runtime . webrtc . WebRTCPeerConnection ; 
 
 public class PeerCallActor extends ModuleActor { 
 
 @ @ - 256 , 5 + 257 , 10 @ @ public class PeerCallActor extends ModuleActor { 
 public void onStreamRemoved ( long deviceId , WebRTCMediaStream stream ) { 
 callback . onStreamRemoved ( deviceId , stream ) ; 
 } 
 + 
 + @ Override 
 + public void onPeerConnectionCreated ( WebRTCPeerConnection peerConnection ) { 
 + callback . onPeerConnectionCreated ( peerConnection ) ; 
 + } 
 } 
 } 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallCallback . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallCallback . java 
 index 2a31283 . . 0382386 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallCallback . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallCallback . java 
 @ @ - 1 , 6 + 1 , 7 @ @ 
 package im . actor . core . modules . calls . peers ; 
 
 import im . actor . runtime . webrtc . WebRTCMediaStream ; 
 + import im . actor . runtime . webrtc . WebRTCPeerConnection ; 
 
 public interface PeerCallCallback { 
 
 @ @ - 17 , 4 + 18 , 6 @ @ public interface PeerCallCallback { 
 void onStreamAdded ( long deviceId , WebRTCMediaStream stream ) ; 
 
 void onStreamRemoved ( long deviceId , WebRTCMediaStream stream ) ; 
 + 
 + void onPeerConnectionCreated ( WebRTCPeerConnection peerConnection ) ; 
 } 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerConnectionActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerConnectionActor . java 
 index dabd3e8 . . 9e27a2f 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerConnectionActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerConnectionActor . java 
 @ @ - 104 , 6 + 104 , 21 @ @ public class PeerConnectionActor extends ModuleActor { 
 public void onRenegotiationNeeded ( ) { 
 
 } 
 + 
 + @ Override 
 + public void onOwnStreamAdded ( WebRTCMediaStream stream ) { 
 + 
 + } 
 + 
 + @ Override 
 + public void onOwnStreamRemoved ( WebRTCMediaStream stream ) { 
 + 
 + } 
 + 
 + @ Override 
 + public void onDisposed ( ) { 
 + 
 + } 
 } ) ; 
 state = PeerConnectionState . WAITING _ HANDSHAKE ; 
 onReady ( ) ; 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeCallback . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeCallback . java 
 index 44ea48e . . fabfcf6 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeCallback . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeCallback . java 
 @ @ - 1 , 6 + 1 , 7 @ @ 
 package im . actor . core . modules . calls . peers ; 
 
 import im . actor . runtime . webrtc . WebRTCMediaStream ; 
 + import im . actor . runtime . webrtc . WebRTCPeerConnection ; 
 
 / * * 
 * Peer Node callback 
 @ @ - 64 , 7 + 65 , 9 @ @ public interface PeerNodeCallback { 
 * Called when stream removed 
 * 
 * @ param deviceId Device Id 
 - * @ param stream removed stream 
 + * @ param stream removed strea 
 * / 
 void onStreamRemoved ( long deviceId , WebRTCMediaStream stream ) ; 
 + 
 + void onPeerConnectionCreated ( WebRTCPeerConnection peerConnection ) ; 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeInt . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeInt . java 
 index 01ddee3 . . ec6f301 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeInt . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeInt . java 
 @ @ - 18 , 6 + 18 , 7 @ @ import im . actor . runtime . actors . ActorCreator ; 
 import im . actor . runtime . actors . ActorInterface ; 
 import im . actor . runtime . actors . ActorRef ; 
 import im . actor . runtime . webrtc . WebRTCMediaStream ; 
 + import im . actor . runtime . webrtc . WebRTCPeerConnection ; 
 
 import static im . actor . runtime . actors . ActorSystem . system ; 
 
 @ @ - 165 , 5 + 166 , 10 @ @ public class PeerNodeInt extends ActorInterface { 
 public void onStreamRemoved ( final long deviceId , final WebRTCMediaStream stream ) { 
 callbackDest . send ( ( Runnable ) ( ) - > callback . onStreamRemoved ( deviceId , stream ) ) ; 
 } 
 + 
 + @ Override 
 + public void onPeerConnectionCreated ( WebRTCPeerConnection peerConnection ) { 
 + callbackDest . send ( ( Runnable ) ( ) - > callback . onPeerConnectionCreated ( peerConnection ) ) ; 
 + } 
 } 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / CallVM . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / CallVM . java 
 index 70f6102 . . 9e014d6 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / CallVM . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / CallVM . java 
 @ @ - 86 , 4 + 86 , 8 @ @ public class CallVM { 
 public void setCallEnd ( long callEnd ) { 
 this . callEnd = callEnd ; 
 } 
 + 
 + public ValueModel < WebRTCPeerConnection > getPeerConnection ( ) { 
 + return peerConnection ; 
 + } 
 } 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / AndroidWebRTCRuntimeProvider . java b / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / AndroidWebRTCRuntimeProvider . java 
 index ab2753a . . 0141deb 100644 
 - - - a / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / AndroidWebRTCRuntimeProvider . java 
 + + + b / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / AndroidWebRTCRuntimeProvider . java 
 @ @ - 25 , 8 + 25 , 6 @ @ public class AndroidWebRTCRuntimeProvider implements WebRTCRuntime { 
 public static final PeerConnectionFactory FACTORY ; 
 private static Object sVcLock = new Object ( ) ; 
 private static Handler sVcHandler = null ; 
 - private static PeerConnectionCallback connectionCallback ; 
 - private static AndroidPeerConnection currentPeerConnection ; 
 
 static { 
 PeerConnectionFactory . initializeAndroidGlobals ( AndroidContext . getContext ( ) , true , true , true ) ; 
 @ @ - 48 , 13 + 46 , 7 @ @ public class AndroidWebRTCRuntimeProvider implements WebRTCRuntime { 
 return new Promise < > ( new PromiseFunc < WebRTCPeerConnection > ( ) { 
 @ Override 
 public void exec ( @ NonNull @ NotNull final PromiseResolver < WebRTCPeerConnection > resolver ) { 
 - currentPeerConnection = new AndroidPeerConnection ( webRTCIceServers , settings ) ; 
 - resolver . result ( currentPeerConnection ) ; 
 - if ( connectionCallback ! = null ) { 
 - connectionCallback . onPeerConncetionAvailable ( currentPeerConnection ) ; 
 - connectionCallback = null ; 
 - } 
 - 
 + resolver . result ( new AndroidPeerConnection ( webRTCIceServers , settings ) ) ; 
 } 
 } ) ; 
 } 
 @ @ - 83 , 27 + 75 , 4 @ @ public class AndroidWebRTCRuntimeProvider implements WebRTCRuntime { 
 public static void postToHandler ( Runnable r ) { 
 sVcHandler . post ( r ) ; 
 } 
 - 
 - public AndroidPeerConnection getCurrentPeerConnection ( ) { 
 - return currentPeerConnection ; 
 - } 
 - 
 - public static void bindPeerConnection ( PeerConnectionCallback callback ) { 
 - if ( currentPeerConnection ! = null ) { 
 - callback . onPeerConncetionAvailable ( currentPeerConnection ) ; 
 - } else { 
 - connectionCallback = callback ; 
 - } 
 - } 
 - 
 - public static void unbindPeerConnection ( ) { 
 - if ( currentPeerConnection ! = null ) { 
 - currentPeerConnection . unbind ( ) ; 
 - } 
 - currentPeerConnection = null ; 
 - } 
 - 
 - public interface PeerConnectionCallback { 
 - void onPeerConncetionAvailable ( AndroidPeerConnection peerConnection ) ; 
 - } 
 } 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / webrtc / AndroidMediaStream . java b / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / webrtc / AndroidMediaStream . java 
 index b00cd12 . . b2deaef 100644 
 - - - a / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / webrtc / AndroidMediaStream . java 
 + + + b / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / webrtc / AndroidMediaStream . java 
 @ @ - 7 , 6 + 7 , 7 @ @ import org . webrtc . AudioTrack ; 
 import org . webrtc . MediaConstraints ; 
 import org . webrtc . MediaStream ; 
 import org . webrtc . VideoCapturer ; 
 + import org . webrtc . VideoRenderer ; 
 import org . webrtc . VideoSource ; 
 import org . webrtc . VideoTrack ; 
 
 @ @ - 113 , 6 + 114 , 12 @ @ public class AndroidMediaStream implements WebRTCMediaStream { 
 return videoTrack ; 
 } 
 
 + public void removeRenderer ( VideoRenderer renderer ) { 
 + if ( videoTrack ! = null ) { 
 + videoTrack . removeRenderer ( renderer ) ; 
 + } 
 + } 
 + 
 public VideoSource getVideoSource ( ) { 
 return videoSource ; 
 } 
 diff - - git a / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / webrtc / AndroidPeerConnection . java b / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / webrtc / AndroidPeerConnection . java 
 index 72e9326 . . e7decdf 100644 
 - - - a / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / webrtc / AndroidPeerConnection . java 
 + + + b / actor - sdk / sdk - core / runtime / runtime - android / src / main / java / im / actor / runtime / android / webrtc / AndroidPeerConnection . java 
 @ @ - 18 , 6 + 18 , 7 @ @ import java . util . ArrayList ; 
 import java . util . EnumSet ; 
 import java . util . HashMap ; 
 
 + import im . actor . core . AndroidMessenger ; 
 import im . actor . runtime . android . AndroidWebRTCRuntimeProvider ; 
 import im . actor . runtime . promise . Promise ; 
 import im . actor . runtime . promise . PromiseFunc ; 
 @ @ - 33 , 7 + 34 , 6 @ @ public class AndroidPeerConnection implements WebRTCPeerConnection { 
 
 private static final boolean LIBJINGLE _ LOGS = true ; 
 
 - private OwnStreamCallback mediaStreamCallback ; 
 private AndroidMediaStream stream ; 
 private boolean videoCallEnabled = true ; 
 
 @ @ - 95 , 9 + 95 , 6 @ @ public class AndroidPeerConnection implements WebRTCPeerConnection { 
 public void onAddStream ( MediaStream stream ) { 
 AndroidMediaStream stream1 = new AndroidMediaStream ( stream ) ; 
 streams . put ( stream , stream1 ) ; 
 - if ( mediaStreamCallback ! = null & & ! stream1 . isLocal ( ) ) { 
 - mediaStreamCallback . onRemoteStreamAdd ( stream1 ) ; 
 - } 
 for ( WebRTCPeerConnectionCallback c : callbacks ) { 
 c . onStreamAdded ( stream1 ) ; 
 } 
 @ @ - 112 , 10 + 109 , 6 @ @ public class AndroidPeerConnection implements WebRTCPeerConnection { 
 } 
 } 
 
 - if ( mediaStreamCallback ! = null ) { 
 - mediaStreamCallback . onRemoteStreamRemove ( stream1 ) ; 
 - } 
 - 
 try { 
 stream . videoTracks . get ( 0 ) . dispose ( ) ; 
 } catch ( Exception e ) { 
 @ @ - 149 , 6 + 142 , 13 @ @ public class AndroidPeerConnection implements WebRTCPeerConnection { 
 if ( ! callbacks . contains ( callback ) ) { 
 callbacks . add ( callback ) ; 
 } 
 + if ( stream ! = null ) { 
 + callback . onOwnStreamAdded ( stream ) ; 
 + } 
 + 
 + for ( MediaStream mediaStream : streams . keySet ( ) ) { 
 + callback . onOwnStreamAdded ( streams . get ( mediaStream ) ) ; 
 + } 
 } 
 
 @ Override 
 @ @ - 172 , 8 + 172 , 8 @ @ public class AndroidPeerConnection implements WebRTCPeerConnection { 
 @ Override 
 public void run ( ) { 
 AndroidPeerConnection . this . stream = ( AndroidMediaStream ) stream ; 
 - if ( mediaStreamCallback ! = null ) { 
 - mediaStreamCallback . onLocalStreamAvailable ( ( AndroidMediaStream ) stream ) ; 
 + for ( WebRTCPeerConnectionCallback c : callbacks ) { 
 + c . onOwnStreamAdded ( stream ) ; 
 } 
 peerConnection . addStream ( AndroidPeerConnection . this . stream . getStream ( ) ) ; 
 } 
 @ @ - 185 , 8 + 185 , 8 @ @ public class AndroidPeerConnection implements WebRTCPeerConnection { 
 AndroidWebRTCRuntimeProvider . postToHandler ( new Runnable ( ) { 
 @ Override 
 public void run ( ) { 
 - if ( mediaStreamCallback ! = null ) { 
 - mediaStreamCallback . onOwnRemoved ( ) ; 
 + for ( WebRTCPeerConnectionCallback c : callbacks ) { 
 + c . onOwnStreamRemoved ( stream ) ; 
 } 
 peerConnection . removeStream ( ( ( AndroidMediaStream ) stream ) . getStream ( ) ) ; 
 } 
 @ @ - 367 , 8 + 367 , 8 @ @ public class AndroidPeerConnection implements WebRTCPeerConnection { 
 public void run ( ) { 
 peerConnection . dispose ( ) ; 
 
 - if ( mediaStreamCallback ! = null ) { 
 - mediaStreamCallback . onDispose ( ) ; 
 + for ( WebRTCPeerConnectionCallback c : callbacks ) { 
 + c . onDisposed ( ) ; 
 } 
 
 if ( stream ! = null & & stream . isLocal ( ) ) { 
 @ @ - 382 , 26 + 382 , 11 @ @ public class AndroidPeerConnection implements WebRTCPeerConnection { 
 
 } 
 
 - public void bind ( OwnStreamCallback callback ) { 
 - if ( stream ! = null ) { 
 - callback . onLocalStreamAvailable ( stream ) ; 
 - } 
 - mediaStreamCallback = callback ; 
 - } 
 - 
 - public void unbind ( ) { 
 - mediaStreamCallback = null ; 
 + public HashMap < MediaStream , AndroidMediaStream > getStreams ( ) { 
 + return streams ; 
 } 
 
 - public interface OwnStreamCallback { 
 - void onLocalStreamAvailable ( AndroidMediaStream stream ) ; 
 - 
 - void onRemoteStreamAdd ( AndroidMediaStream stream ) ; 
 - 
 - void onRemoteStreamRemove ( AndroidMediaStream stream ) ; 
 - 
 - void onOwnRemoved ( ) ; 
 - 
 - void onDispose ( ) ; 
 + public AndroidMediaStream getStream ( ) { 
 + return stream ; 
 } 
 } 
 diff - - git a / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / webrtc / WebRTCPeerConnectionCallback . java b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / webrtc / WebRTCPeerConnectionCallback . java 
 index 8051a3a . . cf65c56 100644 
 - - - a / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / webrtc / WebRTCPeerConnectionCallback . java 
 + + + b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / webrtc / WebRTCPeerConnectionCallback . java 
 @ @ - 38 , 4 + 38 , 29 @ @ public interface WebRTCPeerConnectionCallback { 
 * / 
 @ ObjectiveCName ( " onRenegotiationNeeded " ) 
 void onRenegotiationNeeded ( ) ; 
 + 
 + / * * 
 + * On Own Stream Added 
 + * 
 + * @ param stream stream 
 + * / 
 + @ ObjectiveCName ( " onOwnStreamAdded : " ) 
 + void onOwnStreamAdded ( WebRTCMediaStream stream ) ; 
 + 
 + / * * 
 + * On Own Stream Removed 
 + * 
 + * @ param stream removed stream . References can be different from that passed in onStreamAdded 
 + * / 
 + @ ObjectiveCName ( " onOwnStreamRemoved : " ) 
 + void onOwnStreamRemoved ( WebRTCMediaStream stream ) ; 
 + 
 + 
 + / * * 
 + * Peer connection disposed 
 + * / 
 + @ ObjectiveCName ( " onDisposed " ) 
 + void onDisposed ( ) ; 
 + 
 + 
 } 
 \ No newline at end of file

NEAREST DIFF:
diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteAdapter . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteAdapter . java 
 new file mode 100644 
 index 0000000 . . 8382dc9 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteAdapter . java 
 @ @ - 0 , 0 + 1 , 105 @ @ 
 + package im . actor . sdk . controllers . contacts ; 
 + 
 + import android . content . Context ; 
 + import android . support . v7 . widget . RecyclerView ; 
 + import android . view . ViewGroup ; 
 + import android . widget . FrameLayout ; 
 + 
 + import java . util . ArrayList ; 
 + import java . util . HashMap ; 
 + import java . util . HashSet ; 
 + import java . util . List ; 
 + 
 + import im . actor . core . entity . PhoneBookContact ; 
 + import im . actor . core . entity . PhoneBookIds ; 
 + import im . actor . runtime . android . AndroidContext ; 
 + import im . actor . runtime . android . view . BindedListAdapter ; 
 + import im . actor . runtime . bser . Bser ; 
 + import im . actor . runtime . generic . mvvm . BindedDisplayList ; 
 + import im . actor . sdk . view . adapters . HolderAdapter ; 
 + import im . actor . sdk . view . adapters . OnItemClickedListener ; 
 + import im . actor . sdk . view . adapters . RecyclerListView ; 
 + import im . actor . sdk . view . adapters . ViewHolder ; 
 + 
 + import static im . actor . sdk . util . ActorSDKMessenger . messenger ; 
 + 
 + public class InviteAdapter extends HolderAdapter < PhoneBookContact > { 
 + 
 + List < PhoneBookContact > phoneBook ; 
 + Context context ; 
 + 
 + private final HashSet < PhoneBookContact > selectedUsers = new HashSet < PhoneBookContact > ( ) ; 
 + private final HashMap < PhoneBookContact , Integer > selectedContactType = new HashMap < PhoneBookContact , Integer > ( ) ; 
 + 
 + private final OnItemClickedListener < PhoneBookContact > onItemClickedListener ; 
 + 
 + 
 + public InviteAdapter ( Context context , List < PhoneBookContact > phoneBook , OnItemClickedListener < PhoneBookContact > onItemClickedListener ) { 
 + super ( context ) ; 
 + this . phoneBook = phoneBook ; 
 + selectedUsers . addAll ( phoneBook ) ; 
 + this . context = context ; 
 + this . onItemClickedListener = onItemClickedListener ; 
 + } 
 + 
 + 
 + @ Override 
 + protected void onBindViewHolder ( ViewHolder < PhoneBookContact > holder , PhoneBookContact obj , int index , Context context ) { 
 + PhoneBookContact item = phoneBook . get ( index ) ; 
 + String fastName = null ; 
 + if ( index = = 0 ) { 
 + fastName = messenger ( ) . getFormatter ( ) . formatFastName ( item . getName ( ) ) ; 
 + } else { 
 + String prevName = messenger ( ) . getFormatter ( ) . formatFastName ( phoneBook . get ( index - 1 ) . getName ( ) ) ; 
 + String currentFastName = messenger ( ) . getFormatter ( ) . formatFastName ( item . getName ( ) ) ; 
 + if ( ! prevName . equals ( currentFastName ) ) { 
 + fastName = currentFastName ; 
 + } 
 + } 
 + Integer type = selectedContactType . get ( item ) ; 
 + ( ( InviteContactHolder ) holder ) . bind ( item , fastName , " " , selectedUsers . contains ( item ) , type = = null ? - 1 : type , index = = getCount ( ) - 1 ) ; 
 + } 
 + 
 + 
 + 
 + public void select ( PhoneBookContact contact , int type ) { 
 + selectedUsers . add ( contact ) ; 
 + selectedContactType . put ( contact , type ) ; 
 + } 
 + 
 + public void unselect ( PhoneBookContact uid ) { 
 + selectedUsers . remove ( uid ) ; 
 + } 
 + 
 + public PhoneBookContact [ ] getSelected ( ) { 
 + return selectedUsers . toArray ( new PhoneBookContact [ selectedUsers . size ( ) ] ) ; 
 + } 
 + 
 + public HashMap < PhoneBookContact , Integer > getSelectedContactsTypes ( ) { 
 + return selectedContactType ; 
 + } 
 + 
 + public boolean isSelected ( PhoneBookContact id ) { 
 + return selectedUsers . contains ( id ) ; 
 + } 
 + 
 + @ Override 
 + public int getCount ( ) { 
 + return phoneBook . size ( ) ; 
 + } 
 + 
 + @ Override 
 + public PhoneBookContact getItem ( int position ) { 
 + return phoneBook . get ( position ) ; 
 + } 
 + 
 + @ Override 
 + public long getItemId ( int position ) { 
 + return phoneBook . get ( position ) . getContactId ( ) ; 
 + } 
 + 
 + @ Override 
 + protected ViewHolder < PhoneBookContact > createHolder ( PhoneBookContact obj ) { 
 + return new InviteContactHolder ( new FrameLayout ( context ) , context , onItemClickedListener ) ; 
 + } 
 + } 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteContactAdapter . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteContactAdapter . java 
 deleted file mode 100644 
 index 2a220aa . . 0000000 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteContactAdapter . java 
 + + + / dev / null 
 @ @ - 1 , 106 + 0 , 0 @ @ 
 - package im . actor . sdk . controllers . contacts ; 
 - 
 - import android . content . Context ; 
 - import android . view . ViewGroup ; 
 - import android . widget . FrameLayout ; 
 - 
 - import java . io . IOException ; 
 - import java . util . HashMap ; 
 - import java . util . HashSet ; 
 - 
 - import im . actor . core . entity . Contact ; 
 - import im . actor . core . entity . PhoneBookContact ; 
 - import im . actor . core . entity . PhoneBookIds ; 
 - import im . actor . runtime . android . view . BindedListAdapter ; 
 - import im . actor . runtime . bser . Bser ; 
 - import im . actor . runtime . generic . mvvm . BindedDisplayList ; 
 - import im . actor . sdk . controllers . contacts . view . ContactHolder ; 
 - import im . actor . sdk . view . adapters . OnItemClickedListener ; 
 - 
 - import static im . actor . sdk . util . ActorSDKMessenger . messenger ; 
 - 
 - public class InviteContactAdapter extends BindedListAdapter < PhoneBookContact , InviteContactHolder > { 
 - 
 - private final HashSet < Long > selectedUsers = new HashSet < Long > ( ) ; 
 - private final HashMap < Long , Integer > selectedContactType = new HashMap < Long , Integer > ( ) ; 
 - 
 - private final OnItemClickedListener < PhoneBookContact > onItemClickedListener ; 
 - 
 - 
 - private final Context context ; 
 - 
 - private String query = " " ; 
 - 
 - public InviteContactAdapter ( BindedDisplayList < PhoneBookContact > displayList , Context context , 
 - OnItemClickedListener < PhoneBookContact > onItemClickedListener ) { 
 - super ( displayList ) ; 
 - this . context = context ; 
 - this . onItemClickedListener = onItemClickedListener ; 
 - 
 - updateIds ( ) ; 
 - 
 - } 
 - 
 - public void setQuery ( String query ) { 
 - this . query = query ; 
 - notifyDataSetChanged ( ) ; 
 - } 
 - 
 - public void select ( long id , int type ) { 
 - selectedUsers . add ( id ) ; 
 - selectedContactType . put ( id , type ) ; 
 - } 
 - 
 - public void unselect ( long uid ) { 
 - selectedUsers . remove ( uid ) ; 
 - } 
 - 
 - public Long [ ] getSelected ( ) { 
 - return selectedUsers . toArray ( new Long [ selectedUsers . size ( ) ] ) ; 
 - } 
 - 
 - public HashMap < Long , Integer > getSelectedContactsTypes ( ) { 
 - return selectedContactType ; 
 - } 
 - 
 - public boolean isSelected ( long id ) { 
 - return selectedUsers . contains ( id ) ; 
 - } 
 - 
 - public int getSelectedCount ( ) { 
 - return selectedUsers . size ( ) ; 
 - } 
 - 
 - @ Override 
 - public void onBindViewHolder ( InviteContactHolder contactHolder , int index , PhoneBookContact item ) { 
 - String fastName = null ; 
 - if ( index = = 0 ) { 
 - fastName = messenger ( ) . getFormatter ( ) . formatFastName ( item . getName ( ) ) ; 
 - } else { 
 - String prevName = messenger ( ) . getFormatter ( ) . formatFastName ( getItem ( index - 1 ) . getName ( ) ) ; 
 - String currentFastName = messenger ( ) . getFormatter ( ) . formatFastName ( item . getName ( ) ) ; 
 - if ( ! prevName . equals ( currentFastName ) ) { 
 - fastName = currentFastName ; 
 - } 
 - } 
 - Integer type = selectedContactType . get ( item . getContactId ( ) ) ; 
 - contactHolder . bind ( item , fastName , query , selectedUsers . contains ( item . getContactId ( ) ) , type = = null ? - 1 : type , index = = getItemCount ( ) - 1 ) ; 
 - } 
 - 
 - @ Override 
 - public InviteContactHolder onCreateViewHolder ( ViewGroup viewGroup , int viewType ) { 
 - return new InviteContactHolder ( new FrameLayout ( context ) , context , onItemClickedListener ) ; 
 - } 
 - 
 - public void updateIds ( ) { 
 - try { 
 - PhoneBookIds ids = Bser . parse ( new PhoneBookIds ( ) , messenger ( ) . getPreferences ( ) . getBytes ( " phone _ book _ ids " ) ) ; 
 - for ( long id : ids . getIds ( ) ) { 
 - selectedUsers . add ( id ) ; 
 - } 
 - notifyDataSetChanged ( ) ; 
 - } catch ( Exception e ) { 
 - e . printStackTrace ( ) ; 
 - } 
 - } 
 - } 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteContactHolder . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteContactHolder . java 
 index 4216000 . . 9fb6622 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteContactHolder . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteContactHolder . java 
 @ @ - 1 , 6 + 1 , 7 @ @ 
 package im . actor . sdk . controllers . contacts ; 
 
 import android . content . Context ; 
 + import android . support . v7 . widget . AppCompatCheckBox ; 
 import android . support . v7 . widget . RecyclerView ; 
 import android . text . TextUtils ; 
 import android . view . Gravity ; 
 @ @ - 17 , 13 + 18 , 14 @ @ import im . actor . runtime . android . view . BindedViewHolder ; 
 import im . actor . sdk . ActorSDK ; 
 import im . actor . sdk . R ; 
 import im . actor . sdk . util . Screen ; 
 + import im . actor . sdk . view . adapters . ViewHolder ; 
 import im . actor . sdk . view . avatar . AvatarView ; 
 import im . actor . sdk . util . Fonts ; 
 import im . actor . sdk . view . adapters . OnItemClickedListener ; 
 import im . actor . sdk . view . SearchHighlight ; 
 import im . actor . core . entity . Contact ; 
 
 - public class InviteContactHolder extends BindedViewHolder { 
 + public class InviteContactHolder extends ViewHolder < PhoneBookContact > { 
 
 public static final int TYPE _ PHONE = 0 ; 
 public static final int TYPE _ EMAIL = 1 ; 
 @ @ - 39 , 18 + 41 , 20 @ @ public class InviteContactHolder extends BindedViewHolder { 
 
 private FrameLayout cont ; 
 
 + private FrameLayout fl ; 
 + 
 
 private OnItemClickedListener < PhoneBookContact > onItemClickedListener ; 
 private final View separator ; 
 
 public InviteContactHolder ( FrameLayout fl , Context context , OnItemClickedListener < PhoneBookContact > onItemClickedListener ) { 
 - super ( fl ) ; 
 
 + this . fl = fl ; 
 this . onItemClickedListener = onItemClickedListener ; 
 
 int padding = Screen . dp ( 16 ) ; 
 
 - fl . setLayoutParams ( new RecyclerView . LayoutParams ( ViewGroup . LayoutParams . MATCH _ PARENT , Screen . dp ( 64 ) ) ) ; 
 + fl . setLayoutParams ( new ViewGroup . LayoutParams ( ViewGroup . LayoutParams . MATCH _ PARENT , Screen . dp ( 64 ) ) ) ; 
 
 cont = new FrameLayout ( context ) ; 
 cont . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainBackgroundColor ( ) ) ; 
 @ @ - 107 , 7 + 111 , 7 @ @ public class InviteContactHolder extends BindedViewHolder { 
 subtitle = new TextView ( context ) ; 
 subtitle . setTextColor ( ActorSDK . sharedActor ( ) . style . getTextSecondaryColor ( ) ) ; 
 subtitle . setPadding ( Screen . dp ( 72 ) , 0 , Screen . dp ( 64 ) , 0 ) ; 
 - subtitle . setTextSize ( 15 ) ; 
 + subtitle . setTextSize ( 14 ) ; 
 subtitle . setGravity ( Gravity . CENTER _ VERTICAL ) ; 
 subtitle . setSingleLine ( true ) ; 
 subtitle . setEllipsize ( TextUtils . TruncateAt . END ) ; 
 @ @ - 116 , 8 + 120 , 8 @ @ public class InviteContactHolder extends BindedViewHolder { 
 { 
 FrameLayout . LayoutParams layoutParams = new FrameLayout . LayoutParams ( ViewGroup . LayoutParams . WRAP _ CONTENT , ViewGroup . LayoutParams . WRAP _ CONTENT ) ; 
 layoutParams . gravity = Gravity . CENTER _ VERTICAL ; 
 - layoutParams . topMargin = Screen . dp ( 14 ) ; 
 - layoutParams . bottomMargin = Screen . dp ( 14 ) ; 
 + layoutParams . topMargin = Screen . dp ( 12 ) ; 
 + layoutParams . bottomMargin = Screen . dp ( 12 ) ; 
 
 LinearLayout ll = new LinearLayout ( context ) ; 
 LinearLayout . LayoutParams llp = new LinearLayout . LayoutParams ( LinearLayout . LayoutParams . WRAP _ CONTENT , LinearLayout . LayoutParams . WRAP _ CONTENT ) ; 
 @ @ - 145 , 6 + 149 , 8 @ @ public class InviteContactHolder extends BindedViewHolder { 
 layoutParams . leftMargin = Screen . dp ( 72 ) ; 
 cont . addView ( separator , layoutParams ) ; 
 } 
 + 
 + 
 } 
 
 public void bind ( final PhoneBookContact data , String shortName , String query , boolean selected , int type , boolean isLast ) { 
 @ @ - 176 , 7 + 182 , 6 @ @ public class InviteContactHolder extends BindedViewHolder { 
 
 isSelected . setChecked ( selected ) ; 
 
 - 
 cont . setOnClickListener ( new View . OnClickListener ( ) { 
 @ Override 
 public void onClick ( View v ) { 
 @ @ - 184 , 6 + 189 , 14 @ @ public class InviteContactHolder extends BindedViewHolder { 
 } 
 } ) ; 
 
 + cont . setOnLongClickListener ( new View . OnLongClickListener ( ) { 
 + @ Override 
 + public boolean onLongClick ( View v ) { 
 + return onItemClickedListener . onLongClicked ( data ) ; 
 + } 
 + } ) ; 
 + 
 + 
 
 if ( isLast ) { 
 separator . setVisibility ( View . GONE ) ; 
 @ @ - 192 , 6 + 205 , 16 @ @ public class InviteContactHolder extends BindedViewHolder { 
 } 
 } 
 
 + @ Override 
 + public View init ( PhoneBookContact data , ViewGroup viewGroup , Context context ) { 
 + return fl ; 
 + } 
 + 
 + @ Override 
 + public void bind ( PhoneBookContact data , int position , Context context ) { 
 + 
 + } 
 + 
 public void unbind ( ) { 
 avatar . unbind ( ) ; 
 } 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteFragment . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteFragment . java 
 index 4509af7 . . bde4106 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteFragment . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / contacts / InviteFragment . java 
 @ @ - 1 , 6 + 1 , 5 @ @ 
 package im . actor . sdk . controllers . contacts ; 
 
 - import android . app . Activity ; 
 import android . content . DialogInterface ; 
 import android . content . Intent ; 
 import android . net . Uri ; 
 @ @ - 12 , 105 + 11 , 89 @ @ import android . view . MenuInflater ; 
 import android . view . MenuItem ; 
 import android . view . View ; 
 import android . view . ViewGroup ; 
 - import android . widget . FrameLayout ; 
 import android . widget . TextView ; 
 
 import java . util . ArrayList ; 
 import java . util . HashMap ; 
 + import java . util . List ; 
 
 import im . actor . core . entity . PhoneBookContact ; 
 - import im . actor . runtime . android . view . BindedListAdapter ; 
 - import im . actor . runtime . generic . mvvm . BindedDisplayList ; 
 - import im . actor . runtime . mvvm . Value ; 
 - import im . actor . runtime . mvvm . ValueChangedListener ; 
 import im . actor . sdk . ActorSDK ; 
 import im . actor . sdk . R ; 
 - import im . actor . sdk . controllers . fragment . DisplayListFragment ; 
 - import im . actor . sdk . util . Screen ; 
 + import im . actor . sdk . controllers . fragment . BaseFragment ; 
 + import im . actor . sdk . core . AndroidPhoneBook ; 
 import im . actor . sdk . view . adapters . OnItemClickedListener ; 
 + import im . actor . sdk . view . adapters . RecyclerListView ; 
 
 - import static im . actor . sdk . util . ActorSDKMessenger . messenger ; 
 + public class InviteFragment extends BaseFragment { 
 
 - public class InviteFragment extends DisplayListFragment < PhoneBookContact , InviteContactHolder > { 
 
 - 
 - private View emptyView ; 
 private MenuItem sendButton ; 
 + private RecyclerListView collection ; 
 + private InviteAdapter adapter ; 
 + private List < PhoneBookContact > contacts ; 
 + private TextView emptyText ; 
 
 public InviteFragment ( ) { 
 } 
 
 @ Override 
 public View onCreateView ( LayoutInflater inflater , ViewGroup container , Bundle savedInstanceState ) { 
 - return onCreateContactsView ( R . layout . fragment _ base _ contacts , inflater , container , savedInstanceState ) ; 
 - } 
 + View res = inflater . inflate ( R . layout . fragment _ list , container , false ) ; 
 
 - protected View onCreateContactsView ( int layoutId , LayoutInflater inflater , ViewGroup container , Bundle savedInstanceState ) { 
 - View res = inflate ( inflater , container , layoutId , messenger ( ) . buildPhoneBookContactsDisplayList ( ) ) ; 
 - res . findViewById ( R . id . collection ) . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainBackgroundColor ( ) ) ; 
 - emptyView = res . findViewById ( R . id . emptyCollection ) ; 
 - if ( emptyView ! = null ) { 
 - emptyView . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainBackgroundColor ( ) ) ; 
 - emptyView . findViewById ( R . id . empty _ collection _ bg ) . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainColor ( ) ) ; 
 - ( ( TextView ) emptyView . findViewById ( R . id . empty _ collection _ text ) ) . setTextColor ( ActorSDK . sharedActor ( ) . style . getMainColor ( ) ) ; 
 - } else { 
 - emptyView = res . findViewById ( R . id . empty _ collection _ text ) ; 
 - if ( emptyView ! = null & & emptyView instanceof TextView ) { 
 - ( ( TextView ) emptyView . findViewById ( R . id . empty _ collection _ text ) ) . setTextColor ( ActorSDK . sharedActor ( ) . style . getMainColor ( ) ) ; 
 - } 
 - } 
 + res . findViewById ( R . id . listView ) . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainBackgroundColor ( ) ) ; 
 
 - View headerPadding = new View ( getActivity ( ) ) ; 
 - headerPadding . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainBackgroundColor ( ) ) ; 
 - headerPadding . setLayoutParams ( new FrameLayout . LayoutParams ( ViewGroup . LayoutParams . MATCH _ PARENT , Screen . dp ( 8 ) ) ) ; 
 - addHeaderView ( headerPadding ) ; 
 + emptyText = ( TextView ) res . findViewById ( R . id . emptyView ) ; 
 + emptyText . setTextColor ( ActorSDK . sharedActor ( ) . style . getTextSecondaryColor ( ) ) ; 
 + emptyText . setText ( R . string . progress _ common ) ; 
 
 + collection = ( RecyclerListView ) res . findViewById ( R . id . listView ) ; 
 + AndroidPhoneBook phoneBookLoader = new AndroidPhoneBook ( ) ; 
 + phoneBookLoader . useDelay ( false ) ; 
 
 - if ( emptyView ! = null ) { 
 - if ( messenger ( ) . getAppState ( ) . getIsContactsEmpty ( ) . get ( ) ) { 
 - emptyView . setVisibility ( View . VISIBLE ) ; 
 - } else { 
 - emptyView . setVisibility ( View . GONE ) ; 
 - } 
 - } 
 - bind ( messenger ( ) . getAppState ( ) . getIsContactsEmpty ( ) , new ValueChangedListener < Boolean > ( ) { 
 - @ Override 
 - public void onChanged ( Boolean val , Value < Boolean > Value ) { 
 - if ( emptyView ! = null ) { 
 - if ( val ) { 
 - emptyView . setVisibility ( View . VISIBLE ) ; 
 - } else { 
 - emptyView . setVisibility ( View . GONE ) ; 
 - } 
 - } 
 - } 
 - } ) ; 
 - res . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainBackgroundColor ( ) ) ; 
 + phoneBookLoader . loadPhoneBook ( contacts - > { 
 + if ( contacts . size ( ) > 0 ) { 
 
 - return res ; 
 - } 
 + getActivity ( ) . runOnUiThread ( ( ) - > { 
 + InviteFragment . this . contacts = contacts ; 
 
 + adapter = new InviteAdapter ( getActivity ( ) , contacts , new OnItemClickedListener < PhoneBookContact > ( ) { 
 + @ Override 
 + public void onClicked ( PhoneBookContact item ) { 
 
 - @ Override 
 - protected BindedListAdapter < PhoneBookContact , InviteContactHolder > onCreateAdapter ( BindedDisplayList < PhoneBookContact > displayList , Activity activity ) { 
 - return new InviteContactAdapter ( displayList , activity , new OnItemClickedListener < PhoneBookContact > ( ) { 
 - @ Override 
 - public void onClicked ( PhoneBookContact item ) { 
 + onItemClicked ( item ) ; 
 + } 
 
 - onItemClicked ( item ) ; 
 - } 
 + @ Override 
 + public boolean onLongClicked ( PhoneBookContact item ) { 
 + return false ; 
 + } 
 
 - @ Override 
 - public boolean onLongClicked ( PhoneBookContact item ) { 
 - return false ; 
 - } 
 + } ) ; 
 
 + collection . setAdapter ( adapter ) ; 
 + 
 + hideView ( emptyText ) ; 
 + showView ( collection ) ; 
 + 
 + 
 + if ( sendButton ! = null ) { 
 + sendButton . setVisible ( true ) ; 
 + } 
 + } ) ; 
 + 
 + } 
 } ) ; 
 + 
 + 
 + res . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainBackgroundColor ( ) ) ; 
 + 
 + return res ; 
 } 
 
 + 
 public void onItemClicked ( PhoneBookContact contact ) { 
 - long contactId = contact . getContactId ( ) ; 
 - boolean selected = isSelected ( contactId ) ; 
 + boolean selected = isSelected ( contact ) ; 
 boolean needDialog = contact . getEmails ( ) . size ( ) > 0 & & contact . getPhones ( ) . size ( ) > 0 ; 
 
 if ( needDialog ) { 
 @ @ - 123 , 9 + 106 , 9 @ @ public class InviteFragment extends DisplayListFragment < PhoneBookContact , Invite 
 AlertDialog . Builder builder = new AlertDialog . Builder ( getActivity ( ) ) ; 
 builder . setItems ( items , ( dialog , which ) - > { 
 if ( which = = 2 ) { 
 - unselect ( contactId ) ; 
 + unselect ( contact ) ; 
 } else { 
 - select ( contactId , which ) ; 
 + select ( contact , which ) ; 
 } 
 getAdapter ( ) . notifyDataSetChanged ( ) ; 
 
 @ @ - 134 , 24 + 117 , 24 @ @ public class InviteFragment extends DisplayListFragment < PhoneBookContact , Invite 
 
 } else { 
 if ( selected ) { 
 - unselect ( contactId ) ; 
 + unselect ( contact ) ; 
 } else { 
 - select ( contactId , - 1 ) ; 
 + select ( contact , - 1 ) ; 
 } 
 getAdapter ( ) . notifyDataSetChanged ( ) ; 
 } 
 } 
 
 - public void select ( long id , int type ) { 
 - ( ( InviteContactAdapter ) getAdapter ( ) ) . select ( id , type ) ; 
 + public void select ( PhoneBookContact id , int type ) { 
 + getAdapter ( ) . select ( id , type ) ; 
 } 
 
 - public void unselect ( long id ) { 
 - ( ( InviteContactAdapter ) getAdapter ( ) ) . unselect ( id ) ; 
 + public void unselect ( PhoneBookContact id ) { 
 + getAdapter ( ) . unselect ( id ) ; 
 } 
 
 - public boolean isSelected ( long id ) { 
 - return ( ( InviteContactAdapter ) getAdapter ( ) ) . isSelected ( id ) ; 
 + public boolean isSelected ( PhoneBookContact id ) { 
 + return getAdapter ( ) . isSelected ( id ) ; 
 } 
 
 @ Override 
 @ @ - 159 , 7 + 142 , 9 @ @ public class InviteFragment extends DisplayListFragment < PhoneBookContact , Invite 
 super . onCreateOptionsMenu ( menu , inflater ) ; 
 inflater . inflate ( R . menu . invite , menu ) ; 
 sendButton = menu . getItem ( 0 ) ; 
 - checkSendButton ( ) ; 
 + if ( adapter ! = null & & adapter . getCount ( ) > 0 ) { 
 + sendButton . setVisible ( true ) ; 
 + } 
 } 
 
 @ Override 
 @ @ - 174 , 9 + 159 , 9 @ @ public class InviteFragment extends DisplayListFragment < PhoneBookContact , Invite 
 private void sendInvites ( ) { 
 ArrayList < Long > phones = new ArrayList < Long > ( ) ; 
 ArrayList < String > emails = new ArrayList < String > ( ) ; 
 - Long [ ] selected = ( ( InviteContactAdapter ) getAdapter ( ) ) . getSelected ( ) ; 
 - HashMap < Long , Integer > selectedTypes = ( ( InviteContactAdapter ) getAdapter ( ) ) . getSelectedContactsTypes ( ) ; 
 - PhoneBookContact contact ; 
 + PhoneBookContact [ ] selected = getAdapter ( ) . getSelected ( ) ; 
 + HashMap < PhoneBookContact , Integer > selectedTypes = getAdapter ( ) . getSelectedContactsTypes ( ) ; 
 + 
 Integer selectedType ; 
 
 / / Prepare email / phones lists 
 @ @ - 185 , 9 + 170 , 9 @ @ public class InviteFragment extends DisplayListFragment < PhoneBookContact , Invite 
 String email ; 
 long number ; 
 
 - for ( long s : selected ) { 
 - contact = messenger ( ) . getPhoneBookContact ( s ) ; 
 - selectedType = selectedTypes . get ( s ) ; 
 + for ( PhoneBookContact contact : selected ) { 
 + 
 + selectedType = selectedTypes . get ( contact ) ; 
 selectedType = selectedType ! = null ? selectedType : InviteContactHolder . TYPE _ PHONE ; 
 if ( ( selectedType = = InviteContactHolder . TYPE _ EMAIL & & contact . getEmails ( ) . size ( ) > 0 ) | | contact . getPhones ( ) . size ( ) = = 0 ) { 
 email = contact . getEmails ( ) . get ( 0 ) . getEmail ( ) ; 
 @ @ - 245 , 20 + 230 , 16 @ @ public class InviteFragment extends DisplayListFragment < PhoneBookContact , Invite 
 startActivity ( i ) ; 
 } 
 
 - public void checkSendButton ( ) { 
 - if ( sendButton ! = null ) { 
 - sendButton . setVisible ( getDisplayList ( ) . getSize ( ) ! = 0 ) ; 
 - } 
 + 
 + public InviteAdapter getAdapter ( ) { 
 + return adapter ; 
 } 
 
 @ Override 
 - public void onCollectionChanged ( ) { 
 - super . onCollectionChanged ( ) ; 
 - checkSendButton ( ) ; 
 - InviteContactAdapter adapter = ( InviteContactAdapter ) getAdapter ( ) ; 
 + public void onDestroy ( ) { 
 + super . onDestroy ( ) ; 
 if ( adapter ! = null ) { 
 - adapter . updateIds ( ) ; 
 + adapter . dispose ( ) ; 
 } 
 } 
 - 
 } 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / core / AndroidPhoneBook . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / core / AndroidPhoneBook . java 
 index 241a93a . . 0b3bbd2 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / core / AndroidPhoneBook . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / core / AndroidPhoneBook . java 
 @ @ - 33 , 16 + 33 , 20 @ @ public class AndroidPhoneBook implements PhoneBookProvider { 
 private static final boolean DISABLE _ PHONE _ BOOK = false ; 
 private static final String TAG = " PhoneBookLoader " ; 
 private static PhoneNumberUtil phoneUtil = PhoneNumberUtil . getInstance ( ) ; 
 + private boolean useDelay = true ; 
 
 @ Override 
 public void loadPhoneBook ( final Callback callback ) { 
 new Thread ( ) { 
 @ Override 
 public void run ( ) { 
 - try { 
 - Thread . sleep ( PRELOAD _ DELAY ) ; 
 - } catch ( InterruptedException e ) { 
 - e . printStackTrace ( ) ; 
 + if ( useDelay ) { 
 + try { 
 + Thread . sleep ( PRELOAD _ DELAY ) ; 
 + } catch ( InterruptedException e ) { 
 + e . printStackTrace ( ) ; 
 + } 
 + 
 } 
 ArrayList < PhoneBookContact > contacts = loadPhoneBook ( AndroidContext . getContext ( ) , 
 Devices . getDeviceCountry ( ) ) ; 
 @ @ - 243 , 4 + 247 , 8 @ @ public class AndroidPhoneBook implements PhoneBookProvider { 
 Log . d ( TAG , " Phone book loaded in " + ( SystemClock . uptimeMillis ( ) - start ) + " ms in " + ( index ) + " iterations " ) ; 
 return res ; 
 } 
 + 
 + public void useDelay ( boolean useDelay ) { 
 + this . useDelay = useDelay ; 
 + } 
 } 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / view / adapters / HolderAdapter . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / view / adapters / HolderAdapter . java 
 index 5d09246 . . 5bf7599 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / view / adapters / HolderAdapter . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / view / adapters / HolderAdapter . java 
 @ @ - 36 , 7 + 36 , 7 @ @ public abstract class HolderAdapter < V > extends BaseAdapter { 
 view = convertView ; 
 } 
 
 - holder . bind ( obj , position , context ) ; 
 + onBindViewHolder ( holder , obj , position , context ) ; 
 
 return view ; 
 } 
 @ @ - 53 , 5 + 53 , 9 @ @ public abstract class HolderAdapter < V > extends BaseAdapter { 
 } 
 } 
 
 + protected void onBindViewHolder ( ViewHolder < V > holder , V obj , int position , Context context ) { 
 + holder . bind ( obj , position , context ) ; 
 + } 
 + 
 protected abstract ViewHolder < V > createHolder ( V obj ) ; 
 } 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ invites . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ invites . xml 
 new file mode 100644 
 index 0000000 . . c65edb1 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ invites . xml 
 @ @ - 0 , 0 + 1 , 20 @ @ 
 + < ? xml version = " 1 . 0 " encoding = " utf - 8 " ? > 
 + < FrameLayout xmlns : android = " http : / / schemas . android . com / apk / res / android " 
 + android : layout _ width = " match _ parent " 
 + android : layout _ height = " match _ parent " > 
 + 
 + < android . support . v7 . widget . RecyclerView 
 + android : id = " @ + id / listView " 
 + android : layout _ width = " match _ parent " 
 + android : layout _ height = " match _ parent " 
 + android : scrollbars = " vertical " / > 
 + 
 + < TextView 
 + android : padding = " 20dp " 
 + android : id = " @ + id / emptyView " 
 + android : layout _ width = " match _ parent " 
 + android : layout _ height = " wrap _ content " 
 + android : layout _ marginTop = " 16dp " 
 + android : gravity = " center " 
 + android : textSize = " 18sp " / > 
 + < / FrameLayout > 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / menu / invite . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / menu / invite . xml 
 index 84f3a1d . . cddbf65 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / res / menu / invite . xml 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / menu / invite . xml 
 @ @ - 8 , 6 + 8 , 7 @ @ 
 xmlns : app = " http : / / schemas . android . com / apk / res - auto " > 
 
 < item 
 + android : visible = " false " 
 android : id = " @ + id / send _ invites " 
 android : icon = " @ drawable / attach _ send2 " 
 android : title = " @ string / contacts _ invite _ via _ link " 
 diff - - git a / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / AndroidMessenger . java b / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / AndroidMessenger . java 
 index 62774f1 . . ecb3ac2 100644 
 - - - a / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / AndroidMessenger . java 
 + + + b / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / AndroidMessenger . java 
 @ @ - 383 , 10 + 383 , 6 @ @ public class AndroidMessenger extends im . actor . core . Messenger { 
 return ( BindedDisplayList < Contact > ) modules . getDisplayListsModule ( ) . buildContactList ( false ) ; 
 } 
 
 - public BindedDisplayList < PhoneBookContact > buildPhoneBookContactsDisplayList ( ) { 
 - return ( BindedDisplayList < PhoneBookContact > ) modules . getDisplayListsModule ( ) . buildPhoneBookContactList ( ) ; 
 - } 
 - 
 private boolean isScreenOn ( ) { 
 if ( android . os . Build . VERSION . SDK _ INT > = Build . VERSION _ CODES . KITKAT _ WATCH ) { 
 DisplayManager dm = ( DisplayManager ) context . getSystemService ( Context . DISPLAY _ SERVICE ) ; 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java 
 index 4664bc2 . . 49b417a 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java 
 @ @ - 1652 , 10 + 1652 , 6 @ @ public class Messenger { 
 . failure ( e - > callback . onError ( e ) ) ; 
 } 
 
 - public PhoneBookContact getPhoneBookContact ( long contactId ) { 
 - return modules . getContactsModule ( ) . getPhoneBook ( ) . getValue ( contactId ) ; 
 - } 
 - 
 / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / 
 / / Bindings 
 / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / contacts / BookImportActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / contacts / BookImportActor . java 
 index 35e9776 . . d45528a 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / contacts / BookImportActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / contacts / BookImportActor . java 
 @ @ - 107 , 13 + 107 , 7 @ @ public class BookImportActor extends ModuleActor { 
 
 int newPhones = 0 ; 
 int newEmails = 0 ; 
 - ArrayList < Long > newids = new ArrayList < Long > ( ) ; 
 - List < Long > oldids = new ArrayList < Long > ( ) ; 
 - try { 
 - oldids . addAll ( Bser . parse ( new PhoneBookIds ( ) , preferences ( ) . getBytes ( " phone _ book _ ids " ) ) . getIds ( ) ) ; 
 - } catch ( Exception e ) { 
 - e . printStackTrace ( ) ; 
 - } 
 + 
 for ( PhoneBookContact record : phoneBook ) { 
 for ( PhoneBookPhone phone : record . getPhones ( ) ) { 
 if ( storage . isImported ( phone . getNumber ( ) ) ) { 
 @ @ - 139 , 29 + 133 , 7 @ @ public class BookImportActor extends ModuleActor { 
 newEmails + + ; 
 } 
 
 - newids . add ( record . getContactId ( ) ) ; 
 - } 
 - 
 - int size = phoneBook . size ( ) ; 
 - for ( PhoneBookContact c : phoneBook ) { 
 - if ( ! oldids . contains ( c . getContactId ( ) ) ) { 
 - context ( ) . getContactsModule ( ) . getPhoneBook ( ) . addOrUpdateItem ( c . setSortId ( size - - ) ) ; 
 - } 
 - } 
 - 
 - ArrayList < Long > toRemove = new ArrayList < Long > ( ) ; 
 - for ( long oldId : oldids ) { 
 - if ( ! newids . contains ( oldId ) ) { 
 - toRemove . add ( oldId ) ; 
 - } 
 - } 
 - 
 - long [ ] toRemoveArray = new long [ toRemove . size ( ) ] ; 
 - for ( int i = 0 ; i < toRemove . size ( ) ; i + + ) { 
 - toRemoveArray [ i ] = toRemove . get ( i ) ; 
 } 
 - context ( ) . getContactsModule ( ) . getPhoneBook ( ) . removeItems ( toRemoveArray ) ; 
 - context ( ) . getPreferences ( ) . putBytes ( " phone _ book _ ids " , new PhoneBookIds ( newids ) . toByteArray ( ) ) ; 
 
 if ( ENABLE _ LOG ) { 
 if ( newPhones = = 0 & & newEmails = = 0 ) { 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / contacts / ContactsModule . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / contacts / ContactsModule . java 
 index 2014fa8 . . 760df24 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / contacts / ContactsModule . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / contacts / ContactsModule . java 
 @ @ - 15 , 7 + 15 , 6 @ @ import im . actor . core . api . rpc . ResponseSearchContacts ; 
 import im . actor . core . api . rpc . ResponseSeq ; 
 import im . actor . core . api . updates . UpdateContactsAdded ; 
 import im . actor . core . api . updates . UpdateContactsRemoved ; 
 - import im . actor . core . entity . PhoneBookContact ; 
 import im . actor . core . entity . User ; 
 import im . actor . core . modules . AbsModule ; 
 import im . actor . core . modules . Configuration ; 
 @ @ - 38 , 7 + 37 , 6 @ @ import static im . actor . runtime . actors . ActorSystem . system ; 
 public class ContactsModule extends AbsModule { 
 
 private ListEngine < Contact > contacts ; 
 - private ListEngine < PhoneBookContact > phoneBook ; 
 private ActorRef bookImportActor ; 
 private ActorRef contactSyncActor ; 
 private SyncKeyValue bookImportState ; 
 @ @ - 47 , 7 + 45 , 6 @ @ public class ContactsModule extends AbsModule { 
 super ( modules ) ; 
 
 contacts = Storage . createList ( STORAGE _ CONTACTS , Contact . CREATOR ) ; 
 - phoneBook = Storage . createList ( STORAGE _ PHONE _ BOOK , PhoneBookContact . CREATOR ) ; 
 bookImportState = new SyncKeyValue ( Storage . createKeyValue ( STORAGE _ BOOK _ IMPORT ) ) ; 
 } 
 
 @ @ - 64 , 11 + 61 , 6 @ @ public class ContactsModule extends AbsModule { 
 return contacts ; 
 } 
 
 - public ListEngine < PhoneBookContact > getPhoneBook ( ) { 
 - / / This one 
 - return phoneBook ; 
 - } 
 - 
 public void onPhoneBookChanged ( ) { 
 bookImportActor . send ( new BookImportActor . PerformSync ( ) ) ; 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / misc / DisplayLists . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / misc / DisplayLists . java 
 index 504ca13 . . 756dd9e 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / misc / DisplayLists . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / misc / DisplayLists . java 
 @ @ - 10 , 7 + 10 , 6 @ @ import im . actor . core . entity . Contact ; 
 import im . actor . core . entity . Dialog ; 
 import im . actor . core . entity . Message ; 
 import im . actor . core . entity . Peer ; 
 - import im . actor . core . entity . PhoneBookContact ; 
 import im . actor . core . entity . SearchEntity ; 
 import im . actor . core . modules . AbsModule ; 
 import im . actor . core . modules . ModuleContext ; 
 @ @ - 91 , 15 + 90 , 6 @ @ public class DisplayLists extends AbsModule { 
 return res ; 
 } 
 
 - public PlatformDisplayList < PhoneBookContact > buildPhoneBookContactList ( ) { 
 - im . actor . runtime . Runtime . checkMainThread ( ) ; 
 - 
 - PlatformDisplayList < PhoneBookContact > res = Storage . createDisplayList ( context ( ) . getContactsModule ( ) . getPhoneBook ( ) , 
 - false , PhoneBookContact . ENTITY _ NAME ) ; 
 - res . initTop ( ) ; 
 - return res ; 
 - } 
 - 
 public PlatformDisplayList < Message > buildChatList ( final Peer peer , boolean isShared ) { 
 im . actor . runtime . Runtime . checkMainThread ( ) ;
