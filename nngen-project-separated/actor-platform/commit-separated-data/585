BLEU SCORE: 0.0688037070798893

TEST MSG: feat ( core ) : Caching read states in OwnReadActor
GENERATED MSG: wip ( sdk ) : Grouped dialogs counter updated , peer information changes

TEST DIFF (one line): diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / messaging / actors / OwnReadActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / messaging / actors / OwnReadActor . java < nl > index c7a5091 . . e1672a9 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / messaging / actors / OwnReadActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / messaging / actors / OwnReadActor . java < nl > @ @ - 4 , 6 + 4 , 8 @ @ < nl > < nl > package im . actor . core . modules . messaging . actors ; < nl > < nl > + import java . util . HashMap ; < nl > + < nl > import im . actor . core . entity . ContentDescription ; < nl > import im . actor . core . entity . Message ; < nl > import im . actor . core . entity . Peer ; < nl > @ @ - 14 , 6 + 16 , 7 @ @ import im . actor . core . modules . ModuleActor ; < nl > public class OwnReadActor extends ModuleActor { < nl > < nl > private boolean isInDifference = false ; < nl > + private HashMap < Peer , Long > cachedReadStates = new HashMap < > ( ) ; < nl > < nl > public OwnReadActor ( ModuleContext context ) { < nl > super ( context ) ; < nl > @ @ - 39 , 7 + 42 , 7 @ @ public class OwnReadActor extends ModuleActor { < nl > < nl > public void onInMessage ( Peer peer , Message message ) { < nl > / / Detecting if message already read < nl > - long readState = context ( ) . getMessagesModule ( ) . loadReadState ( peer ) ; < nl > + long readState = loadReadState ( peer ) ; < nl > if ( message . getSortDate ( ) < = readState ) { < nl > / / Already read < nl > return ; < nl > @ @ - 58 , 7 + 61 , 7 @ @ public class OwnReadActor extends ModuleActor { < nl > < nl > public void onMessageRead ( Peer peer , long sortingDate ) { < nl > / / Detecting if message already read < nl > - long readState = context ( ) . getMessagesModule ( ) . loadReadState ( peer ) ; < nl > + long readState = loadReadState ( peer ) ; < nl > if ( sortingDate < = readState ) { < nl > / / Already read < nl > return ; < nl > @ @ - 72 , 14 + 75 , 14 @ @ public class OwnReadActor extends ModuleActor { < nl > context ( ) . getMessagesModule ( ) . getConversationActor ( peer ) . send ( new ConversationActor . MessageReadByMe ( sortingDate ) ) ; < nl > < nl > / / Saving last read message < nl > - context ( ) . getMessagesModule ( ) . saveReadState ( peer , sortingDate ) ; < nl > + saveReadState ( peer , sortingDate ) ; < nl > < nl > / / Clearing notifications < nl > context ( ) . getNotificationsModule ( ) . onOwnRead ( peer , sortingDate ) ; < nl > } < nl > < nl > public void onMessageReadByMe ( Peer peer , long sortingDate ) { < nl > - long readState = context ( ) . getMessagesModule ( ) . loadReadState ( peer ) ; < nl > + long readState = loadReadState ( peer ) ; < nl > if ( sortingDate < = readState ) { < nl > / / Already read < nl > return ; < nl > @ @ - 89 , 12 + 92 , 27 @ @ public class OwnReadActor extends ModuleActor { < nl > context ( ) . getMessagesModule ( ) . getConversationActor ( peer ) . send ( new ConversationActor . MessageReadByMe ( sortingDate ) ) ; < nl > < nl > / / Saving read state < nl > - context ( ) . getMessagesModule ( ) . saveReadState ( peer , sortingDate ) ; < nl > + saveReadState ( peer , sortingDate ) ; < nl > < nl > / / Clearing notifications < nl > context ( ) . getNotificationsModule ( ) . onOwnRead ( peer , sortingDate ) ; < nl > } < nl > < nl > + private long loadReadState ( Peer peer ) { < nl > + Long res = cachedReadStates . get ( peer ) ; < nl > + if ( res ! = null ) { < nl > + return res ; < nl > + } < nl > + res = context ( ) . getMessagesModule ( ) . loadReadState ( peer ) ; < nl > + cachedReadStates . put ( peer , res ) ; < nl > + return res ; < nl > + } < nl > + < nl > + private void saveReadState ( Peer peer , long date ) { < nl > + cachedReadStates . put ( peer , date ) ; < nl > + context ( ) . getMessagesModule ( ) . saveReadState ( peer , date ) ; < nl > + } < nl > + < nl > / / Messages < nl > < nl > @ Override
NEAREST DIFF (one line): diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java < nl > index 8bf76dc . . 5f112bd 100644 < nl > - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java < nl > + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java < nl > @ @ - 137 , 10 + 137 , 10 @ @ public class ConversationActor extends ModuleActor { < nl > / / Update dialogs < nl > if ( topMessage ! = null ) { < nl > if ( ! isHiddenPeer ) { < nl > - dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , < nl > - topMessage . getSortDate ( ) ) ) ; < nl > dialogsActor . send ( new DialogsActor . InMessage ( peer , topMessage , inPendingIndex . getCount ( ) ) ) ; < nl > } < nl > + dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , < nl > + topMessage . getSortDate ( ) ) ) ; < nl > } < nl > } < nl > < nl > @ @ - 189 , 9 + 189 , 9 @ @ public class ConversationActor extends ModuleActor { < nl > < nl > if ( ! isHiddenPeer ) { < nl > dialogsActor . send ( new DialogsActor . InMessage ( peer , message , inPendingIndex . getCount ( ) ) ) ; < nl > - dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , < nl > - message . getSortDate ( ) ) ) ; < nl > } < nl > + dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , < nl > + message . getSortDate ( ) ) ) ; < nl > } < nl > } < nl > < nl > @ @ - 276 , 6 + 276 , 7 @ @ public class ConversationActor extends ModuleActor { < nl > dialogsActor . send ( new DialogsActor . MessageStateChanged ( peer , rid , < nl > MessageState . ERROR ) ) ; < nl > } < nl > + dialogsGroupedActor . send ( new GroupedDialogsActor . CounterChanged ( peer , inPendingIndex . getCount ( ) ) ) ; < nl > } < nl > } < nl > < nl > @ @ - 369 , 8 + 370 , 8 @ @ public class ConversationActor extends ModuleActor { < nl > < nl > if ( ! isHiddenPeer ) { < nl > dialogsActor . send ( new DialogsActor . CounterChanged ( peer , inPendingIndex . getCount ( ) ) ) ; < nl > - / / TODO : Implement for grouped < nl > } < nl > + dialogsGroupedActor . send ( new GroupedDialogsActor . CounterChanged ( peer , inPendingIndex . getCount ( ) ) ) ; < nl > } < nl > < nl > / / Deletions < nl > @ @ - 402 , 6 + 403 , 7 @ @ public class ConversationActor extends ModuleActor { < nl > inPendingIndex . clear ( ) ; < nl > outPendingIndex . clear ( ) ; < nl > dialogsActor . send ( new DialogsActor . ChatClear ( peer ) ) ; < nl > + / / TODO : Implement for grouped < nl > } < nl > < nl > @ Verified < nl > diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java < nl > index dc1143a . . b6d002a 100644 < nl > - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java < nl > + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java < nl > @ @ - 52 , 6 + 52 , 13 @ @ public class GroupedDialogsActor extends ModuleActor { < nl > DialogSpec spec = new DialogSpec ( peer , false , counter ) ; < nl > specs . getEngine ( ) . addOrUpdateItem ( spec ) ; < nl > < nl > + / / Doesn ' t create dialogs for hidden groups < nl > + if ( peer . getPeerType ( ) = = PeerType . GROUP ) { < nl > + if ( getGroup ( peer . getPeerId ( ) ) . isHidden ( ) ) { < nl > + return ; < nl > + } < nl > + } < nl > + < nl > boolean found = false ; < nl > for ( Peer p : storage . getPrivatePeers ( ) ) { < nl > if ( p . equals ( peer ) ) { < nl > @ @ - 120 , 8 + 127 , 55 @ @ public class GroupedDialogsActor extends ModuleActor { < nl > context ( ) . getMessagesModule ( ) . getDialogGroupsVM ( ) . getGroupsValueModel ( ) . change ( groups ) ; < nl > } < nl > < nl > + private void onCounterChanged ( Peer peer , int counter ) { < nl > + < nl > + DialogSpec spec = new DialogSpec ( peer , false , counter ) ; < nl > + specs . getEngine ( ) . addOrUpdateItem ( spec ) ; < nl > + < nl > + / / Hidden groups doesn ' t present in storage < nl > + / / and there are no need to explicit checking < nl > + < nl > + boolean found = false ; < nl > + for ( Peer p : storage . getPrivatePeers ( ) ) { < nl > + if ( p . equals ( peer ) ) { < nl > + found = true ; < nl > + break ; < nl > + } < nl > + } < nl > + for ( Peer p : storage . getGroupPeers ( ) ) { < nl > + if ( p . equals ( peer ) ) { < nl > + found = true ; < nl > + break ; < nl > + } < nl > + } < nl > + < nl > + if ( found ) { < nl > + notifyVM ( ) ; < nl > + } < nl > + } < nl > + < nl > private void onPeerInfoChanged ( Peer peer , String title , Avatar avatar ) { < nl > - / / TODO : Implement < nl > + < nl > + / / Hidden groups doesn ' t present in storage < nl > + / / and there are no need to explicit checking < nl > + < nl > + boolean found = false ; < nl > + for ( Peer p : storage . getPrivatePeers ( ) ) { < nl > + if ( p . equals ( peer ) ) { < nl > + found = true ; < nl > + break ; < nl > + } < nl > + } < nl > + for ( Peer p : storage . getGroupPeers ( ) ) { < nl > + if ( p . equals ( peer ) ) { < nl > + found = true ; < nl > + break ; < nl > + } < nl > + } < nl > + < nl > + if ( found ) { < nl > + notifyVM ( ) ; < nl > + } < nl > } < nl > < nl > < nl > @ @ - 139 , 6 + 193 , 9 @ @ public class GroupedDialogsActor extends ModuleActor { < nl > } else if ( message instanceof NewMessage ) { < nl > NewMessage newMessage = ( NewMessage ) message ; < nl > onNewMessage ( newMessage . peer , newMessage . sortDate , newMessage . counter ) ; < nl > + } else if ( message instanceof CounterChanged ) { < nl > + CounterChanged counterChanged = ( CounterChanged ) message ; < nl > + onCounterChanged ( counterChanged . getPeer ( ) , counterChanged . getCounter ( ) ) ; < nl > } else { < nl > super . onReceive ( message ) ; < nl > } < nl > @ @ - 188 , 7 + 245 , 6 @ @ public class GroupedDialogsActor extends ModuleActor { < nl > } < nl > < nl > public static class NewMessage { < nl > - < nl > private Peer peer ; < nl > private int counter ; < nl > private long sortDate ; < nl > @ @ - 199 , 52 + 255 , 4 @ @ public class GroupedDialogsActor extends ModuleActor { < nl > this . sortDate = sortDate ; < nl > } < nl > } < nl > - < nl > - private class PeerGroup { < nl > - < nl > - private String key ; < nl > - private String title ; < nl > - private ArrayList < PeerDesc > peers ; < nl > - < nl > - public PeerGroup ( String key , String title ) { < nl > - this . key = key ; < nl > - this . title = title ; < nl > - this . peers = new ArrayList < PeerDesc > ( ) ; < nl > - } < nl > - < nl > - public String getKey ( ) { < nl > - return key ; < nl > - } < nl > - < nl > - public String getTitle ( ) { < nl > - return title ; < nl > - } < nl > - < nl > - public ArrayList < PeerDesc > getPeers ( ) { < nl > - return peers ; < nl > - } < nl > - } < nl > - < nl > - private class PeerDesc { < nl > - < nl > - private Peer peer ; < nl > - private int counter ; < nl > - < nl > - public PeerDesc ( Peer peer , int counter ) { < nl > - this . peer = peer ; < nl > - this . counter = counter ; < nl > - } < nl > - < nl > - public Peer getPeer ( ) { < nl > - return peer ; < nl > - } < nl > - < nl > - public int getCounter ( ) { < nl > - return counter ; < nl > - } < nl > - < nl > - public void setCounter ( int counter ) { < nl > - this . counter = counter ; < nl > - } < nl > - } < nl > } < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / users / UsersProcessor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / users / UsersProcessor . java < nl > index 74487be . . dfbc311 100644 < nl > - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / users / UsersProcessor . java < nl > + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / users / UsersProcessor . java < nl > @ @ - 10 , 12 + 10 , 14 @ @ import im . actor . core . api . updates . UpdateUserAvatarChanged ; < nl > import im . actor . core . api . updates . UpdateUserLocalNameChanged ; < nl > import im . actor . core . api . updates . UpdateUserNameChanged ; < nl > import im . actor . core . api . updates . UpdateUserNickChanged ; < nl > + import im . actor . core . entity . Peer ; < nl > import im . actor . core . entity . User ; < nl > import im . actor . core . modules . AbsModule ; < nl > import im . actor . core . modules . ModuleContext ; < nl > import im . actor . core . modules . Processor ; < nl > import im . actor . core . modules . internal . contacts . ContactsSyncActor ; < nl > import im . actor . core . modules . internal . messages . DialogsActor ; < nl > + import im . actor . core . modules . internal . messages . GroupedDialogsActor ; < nl > import im . actor . runtime . annotations . Verified ; < nl > < nl > import static im . actor . core . util . JavaUtil . equalsE ; < nl > @ @ - 193 , 6 + 195 , 9 @ @ public class UsersProcessor extends AbsModule implements Processor { < nl > private void onUserDescChanged ( User u ) { < nl > context ( ) . getMessagesModule ( ) . getDialogsActor ( ) . send ( < nl > new DialogsActor . UserChanged ( u ) ) ; < nl > + context ( ) . getMessagesModule ( ) . getDialogsGroupedActor ( ) . send ( < nl > + new GroupedDialogsActor . PeerInformationChanged ( Peer . user ( u . getUid ( ) ) , < nl > + u . getName ( ) , u . getAvatar ( ) ) ) ; < nl > context ( ) . getContactsModule ( ) . getContactSyncActor ( ) < nl > . send ( new ContactsSyncActor . UserChanged ( u ) ) ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / updates / GroupsProcessor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / updates / GroupsProcessor . java < nl > index 0c0a457 . . e430293 100644 < nl > - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / updates / GroupsProcessor . java < nl > + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / updates / GroupsProcessor . java < nl > @ @ - 16 , 6 + 16 , 7 @ @ import im . actor . core . api . ApiMember ; < nl > import im . actor . core . entity . Group ; < nl > import im . actor . core . entity . Message ; < nl > import im . actor . core . entity . MessageState ; < nl > + import im . actor . core . entity . Peer ; < nl > import im . actor . core . entity . content . ServiceGroupAvatarChanged ; < nl > import im . actor . core . entity . content . ServiceGroupCreated ; < nl > import im . actor . core . entity . content . ServiceGroupTitleChanged ; < nl > @ @ - 25 , 6 + 26 , 7 @ @ import im . actor . core . entity . content . ServiceGroupUserLeave ; < nl > import im . actor . core . modules . AbsModule ; < nl > import im . actor . core . modules . ModuleContext ; < nl > import im . actor . core . modules . internal . messages . DialogsActor ; < nl > + import im . actor . core . modules . internal . messages . GroupedDialogsActor ; < nl > import im . actor . core . modules . internal . messages . entity . EntityConverter ; < nl > import im . actor . runtime . annotations . Verified ; < nl > < nl > @ @ - 298 , 5 + 300 , 8 @ @ public class GroupsProcessor extends AbsModule { < nl > private void onGroupDescChanged ( Group group ) { < nl > context ( ) . getMessagesModule ( ) . getDialogsActor ( ) < nl > . send ( new DialogsActor . GroupChanged ( group ) ) ; < nl > + context ( ) . getMessagesModule ( ) . getDialogsGroupedActor ( ) . send ( < nl > + new GroupedDialogsActor . PeerInformationChanged ( Peer . group ( group . getGroupId ( ) ) , < nl > + group . getTitle ( ) , group . getAvatar ( ) ) ) ; < nl > } < nl > } < nl > \ No newline at end of file

TEST DIFF:
diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / messaging / actors / OwnReadActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / messaging / actors / OwnReadActor . java 
 index c7a5091 . . e1672a9 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / messaging / actors / OwnReadActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / messaging / actors / OwnReadActor . java 
 @ @ - 4 , 6 + 4 , 8 @ @ 
 
 package im . actor . core . modules . messaging . actors ; 
 
 + import java . util . HashMap ; 
 + 
 import im . actor . core . entity . ContentDescription ; 
 import im . actor . core . entity . Message ; 
 import im . actor . core . entity . Peer ; 
 @ @ - 14 , 6 + 16 , 7 @ @ import im . actor . core . modules . ModuleActor ; 
 public class OwnReadActor extends ModuleActor { 
 
 private boolean isInDifference = false ; 
 + private HashMap < Peer , Long > cachedReadStates = new HashMap < > ( ) ; 
 
 public OwnReadActor ( ModuleContext context ) { 
 super ( context ) ; 
 @ @ - 39 , 7 + 42 , 7 @ @ public class OwnReadActor extends ModuleActor { 
 
 public void onInMessage ( Peer peer , Message message ) { 
 / / Detecting if message already read 
 - long readState = context ( ) . getMessagesModule ( ) . loadReadState ( peer ) ; 
 + long readState = loadReadState ( peer ) ; 
 if ( message . getSortDate ( ) < = readState ) { 
 / / Already read 
 return ; 
 @ @ - 58 , 7 + 61 , 7 @ @ public class OwnReadActor extends ModuleActor { 
 
 public void onMessageRead ( Peer peer , long sortingDate ) { 
 / / Detecting if message already read 
 - long readState = context ( ) . getMessagesModule ( ) . loadReadState ( peer ) ; 
 + long readState = loadReadState ( peer ) ; 
 if ( sortingDate < = readState ) { 
 / / Already read 
 return ; 
 @ @ - 72 , 14 + 75 , 14 @ @ public class OwnReadActor extends ModuleActor { 
 context ( ) . getMessagesModule ( ) . getConversationActor ( peer ) . send ( new ConversationActor . MessageReadByMe ( sortingDate ) ) ; 
 
 / / Saving last read message 
 - context ( ) . getMessagesModule ( ) . saveReadState ( peer , sortingDate ) ; 
 + saveReadState ( peer , sortingDate ) ; 
 
 / / Clearing notifications 
 context ( ) . getNotificationsModule ( ) . onOwnRead ( peer , sortingDate ) ; 
 } 
 
 public void onMessageReadByMe ( Peer peer , long sortingDate ) { 
 - long readState = context ( ) . getMessagesModule ( ) . loadReadState ( peer ) ; 
 + long readState = loadReadState ( peer ) ; 
 if ( sortingDate < = readState ) { 
 / / Already read 
 return ; 
 @ @ - 89 , 12 + 92 , 27 @ @ public class OwnReadActor extends ModuleActor { 
 context ( ) . getMessagesModule ( ) . getConversationActor ( peer ) . send ( new ConversationActor . MessageReadByMe ( sortingDate ) ) ; 
 
 / / Saving read state 
 - context ( ) . getMessagesModule ( ) . saveReadState ( peer , sortingDate ) ; 
 + saveReadState ( peer , sortingDate ) ; 
 
 / / Clearing notifications 
 context ( ) . getNotificationsModule ( ) . onOwnRead ( peer , sortingDate ) ; 
 } 
 
 + private long loadReadState ( Peer peer ) { 
 + Long res = cachedReadStates . get ( peer ) ; 
 + if ( res ! = null ) { 
 + return res ; 
 + } 
 + res = context ( ) . getMessagesModule ( ) . loadReadState ( peer ) ; 
 + cachedReadStates . put ( peer , res ) ; 
 + return res ; 
 + } 
 + 
 + private void saveReadState ( Peer peer , long date ) { 
 + cachedReadStates . put ( peer , date ) ; 
 + context ( ) . getMessagesModule ( ) . saveReadState ( peer , date ) ; 
 + } 
 + 
 / / Messages 
 
 @ Override

NEAREST DIFF:
diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java 
 index 8bf76dc . . 5f112bd 100644 
 - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java 
 + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java 
 @ @ - 137 , 10 + 137 , 10 @ @ public class ConversationActor extends ModuleActor { 
 / / Update dialogs 
 if ( topMessage ! = null ) { 
 if ( ! isHiddenPeer ) { 
 - dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , 
 - topMessage . getSortDate ( ) ) ) ; 
 dialogsActor . send ( new DialogsActor . InMessage ( peer , topMessage , inPendingIndex . getCount ( ) ) ) ; 
 } 
 + dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , 
 + topMessage . getSortDate ( ) ) ) ; 
 } 
 } 
 
 @ @ - 189 , 9 + 189 , 9 @ @ public class ConversationActor extends ModuleActor { 
 
 if ( ! isHiddenPeer ) { 
 dialogsActor . send ( new DialogsActor . InMessage ( peer , message , inPendingIndex . getCount ( ) ) ) ; 
 - dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , 
 - message . getSortDate ( ) ) ) ; 
 } 
 + dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , 
 + message . getSortDate ( ) ) ) ; 
 } 
 } 
 
 @ @ - 276 , 6 + 276 , 7 @ @ public class ConversationActor extends ModuleActor { 
 dialogsActor . send ( new DialogsActor . MessageStateChanged ( peer , rid , 
 MessageState . ERROR ) ) ; 
 } 
 + dialogsGroupedActor . send ( new GroupedDialogsActor . CounterChanged ( peer , inPendingIndex . getCount ( ) ) ) ; 
 } 
 } 
 
 @ @ - 369 , 8 + 370 , 8 @ @ public class ConversationActor extends ModuleActor { 
 
 if ( ! isHiddenPeer ) { 
 dialogsActor . send ( new DialogsActor . CounterChanged ( peer , inPendingIndex . getCount ( ) ) ) ; 
 - / / TODO : Implement for grouped 
 } 
 + dialogsGroupedActor . send ( new GroupedDialogsActor . CounterChanged ( peer , inPendingIndex . getCount ( ) ) ) ; 
 } 
 
 / / Deletions 
 @ @ - 402 , 6 + 403 , 7 @ @ public class ConversationActor extends ModuleActor { 
 inPendingIndex . clear ( ) ; 
 outPendingIndex . clear ( ) ; 
 dialogsActor . send ( new DialogsActor . ChatClear ( peer ) ) ; 
 + / / TODO : Implement for grouped 
 } 
 
 @ Verified 
 diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java 
 index dc1143a . . b6d002a 100644 
 - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java 
 + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java 
 @ @ - 52 , 6 + 52 , 13 @ @ public class GroupedDialogsActor extends ModuleActor { 
 DialogSpec spec = new DialogSpec ( peer , false , counter ) ; 
 specs . getEngine ( ) . addOrUpdateItem ( spec ) ; 
 
 + / / Doesn ' t create dialogs for hidden groups 
 + if ( peer . getPeerType ( ) = = PeerType . GROUP ) { 
 + if ( getGroup ( peer . getPeerId ( ) ) . isHidden ( ) ) { 
 + return ; 
 + } 
 + } 
 + 
 boolean found = false ; 
 for ( Peer p : storage . getPrivatePeers ( ) ) { 
 if ( p . equals ( peer ) ) { 
 @ @ - 120 , 8 + 127 , 55 @ @ public class GroupedDialogsActor extends ModuleActor { 
 context ( ) . getMessagesModule ( ) . getDialogGroupsVM ( ) . getGroupsValueModel ( ) . change ( groups ) ; 
 } 
 
 + private void onCounterChanged ( Peer peer , int counter ) { 
 + 
 + DialogSpec spec = new DialogSpec ( peer , false , counter ) ; 
 + specs . getEngine ( ) . addOrUpdateItem ( spec ) ; 
 + 
 + / / Hidden groups doesn ' t present in storage 
 + / / and there are no need to explicit checking 
 + 
 + boolean found = false ; 
 + for ( Peer p : storage . getPrivatePeers ( ) ) { 
 + if ( p . equals ( peer ) ) { 
 + found = true ; 
 + break ; 
 + } 
 + } 
 + for ( Peer p : storage . getGroupPeers ( ) ) { 
 + if ( p . equals ( peer ) ) { 
 + found = true ; 
 + break ; 
 + } 
 + } 
 + 
 + if ( found ) { 
 + notifyVM ( ) ; 
 + } 
 + } 
 + 
 private void onPeerInfoChanged ( Peer peer , String title , Avatar avatar ) { 
 - / / TODO : Implement 
 + 
 + / / Hidden groups doesn ' t present in storage 
 + / / and there are no need to explicit checking 
 + 
 + boolean found = false ; 
 + for ( Peer p : storage . getPrivatePeers ( ) ) { 
 + if ( p . equals ( peer ) ) { 
 + found = true ; 
 + break ; 
 + } 
 + } 
 + for ( Peer p : storage . getGroupPeers ( ) ) { 
 + if ( p . equals ( peer ) ) { 
 + found = true ; 
 + break ; 
 + } 
 + } 
 + 
 + if ( found ) { 
 + notifyVM ( ) ; 
 + } 
 } 
 
 
 @ @ - 139 , 6 + 193 , 9 @ @ public class GroupedDialogsActor extends ModuleActor { 
 } else if ( message instanceof NewMessage ) { 
 NewMessage newMessage = ( NewMessage ) message ; 
 onNewMessage ( newMessage . peer , newMessage . sortDate , newMessage . counter ) ; 
 + } else if ( message instanceof CounterChanged ) { 
 + CounterChanged counterChanged = ( CounterChanged ) message ; 
 + onCounterChanged ( counterChanged . getPeer ( ) , counterChanged . getCounter ( ) ) ; 
 } else { 
 super . onReceive ( message ) ; 
 } 
 @ @ - 188 , 7 + 245 , 6 @ @ public class GroupedDialogsActor extends ModuleActor { 
 } 
 
 public static class NewMessage { 
 - 
 private Peer peer ; 
 private int counter ; 
 private long sortDate ; 
 @ @ - 199 , 52 + 255 , 4 @ @ public class GroupedDialogsActor extends ModuleActor { 
 this . sortDate = sortDate ; 
 } 
 } 
 - 
 - private class PeerGroup { 
 - 
 - private String key ; 
 - private String title ; 
 - private ArrayList < PeerDesc > peers ; 
 - 
 - public PeerGroup ( String key , String title ) { 
 - this . key = key ; 
 - this . title = title ; 
 - this . peers = new ArrayList < PeerDesc > ( ) ; 
 - } 
 - 
 - public String getKey ( ) { 
 - return key ; 
 - } 
 - 
 - public String getTitle ( ) { 
 - return title ; 
 - } 
 - 
 - public ArrayList < PeerDesc > getPeers ( ) { 
 - return peers ; 
 - } 
 - } 
 - 
 - private class PeerDesc { 
 - 
 - private Peer peer ; 
 - private int counter ; 
 - 
 - public PeerDesc ( Peer peer , int counter ) { 
 - this . peer = peer ; 
 - this . counter = counter ; 
 - } 
 - 
 - public Peer getPeer ( ) { 
 - return peer ; 
 - } 
 - 
 - public int getCounter ( ) { 
 - return counter ; 
 - } 
 - 
 - public void setCounter ( int counter ) { 
 - this . counter = counter ; 
 - } 
 - } 
 } 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / users / UsersProcessor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / users / UsersProcessor . java 
 index 74487be . . dfbc311 100644 
 - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / users / UsersProcessor . java 
 + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / users / UsersProcessor . java 
 @ @ - 10 , 12 + 10 , 14 @ @ import im . actor . core . api . updates . UpdateUserAvatarChanged ; 
 import im . actor . core . api . updates . UpdateUserLocalNameChanged ; 
 import im . actor . core . api . updates . UpdateUserNameChanged ; 
 import im . actor . core . api . updates . UpdateUserNickChanged ; 
 + import im . actor . core . entity . Peer ; 
 import im . actor . core . entity . User ; 
 import im . actor . core . modules . AbsModule ; 
 import im . actor . core . modules . ModuleContext ; 
 import im . actor . core . modules . Processor ; 
 import im . actor . core . modules . internal . contacts . ContactsSyncActor ; 
 import im . actor . core . modules . internal . messages . DialogsActor ; 
 + import im . actor . core . modules . internal . messages . GroupedDialogsActor ; 
 import im . actor . runtime . annotations . Verified ; 
 
 import static im . actor . core . util . JavaUtil . equalsE ; 
 @ @ - 193 , 6 + 195 , 9 @ @ public class UsersProcessor extends AbsModule implements Processor { 
 private void onUserDescChanged ( User u ) { 
 context ( ) . getMessagesModule ( ) . getDialogsActor ( ) . send ( 
 new DialogsActor . UserChanged ( u ) ) ; 
 + context ( ) . getMessagesModule ( ) . getDialogsGroupedActor ( ) . send ( 
 + new GroupedDialogsActor . PeerInformationChanged ( Peer . user ( u . getUid ( ) ) , 
 + u . getName ( ) , u . getAvatar ( ) ) ) ; 
 context ( ) . getContactsModule ( ) . getContactSyncActor ( ) 
 . send ( new ContactsSyncActor . UserChanged ( u ) ) ; 
 } 
 diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / updates / GroupsProcessor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / updates / GroupsProcessor . java 
 index 0c0a457 . . e430293 100644 
 - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / updates / GroupsProcessor . java 
 + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / updates / GroupsProcessor . java 
 @ @ - 16 , 6 + 16 , 7 @ @ import im . actor . core . api . ApiMember ; 
 import im . actor . core . entity . Group ; 
 import im . actor . core . entity . Message ; 
 import im . actor . core . entity . MessageState ; 
 + import im . actor . core . entity . Peer ; 
 import im . actor . core . entity . content . ServiceGroupAvatarChanged ; 
 import im . actor . core . entity . content . ServiceGroupCreated ; 
 import im . actor . core . entity . content . ServiceGroupTitleChanged ; 
 @ @ - 25 , 6 + 26 , 7 @ @ import im . actor . core . entity . content . ServiceGroupUserLeave ; 
 import im . actor . core . modules . AbsModule ; 
 import im . actor . core . modules . ModuleContext ; 
 import im . actor . core . modules . internal . messages . DialogsActor ; 
 + import im . actor . core . modules . internal . messages . GroupedDialogsActor ; 
 import im . actor . core . modules . internal . messages . entity . EntityConverter ; 
 import im . actor . runtime . annotations . Verified ; 
 
 @ @ - 298 , 5 + 300 , 8 @ @ public class GroupsProcessor extends AbsModule { 
 private void onGroupDescChanged ( Group group ) { 
 context ( ) . getMessagesModule ( ) . getDialogsActor ( ) 
 . send ( new DialogsActor . GroupChanged ( group ) ) ; 
 + context ( ) . getMessagesModule ( ) . getDialogsGroupedActor ( ) . send ( 
 + new GroupedDialogsActor . PeerInformationChanged ( Peer . group ( group . getGroupId ( ) ) , 
 + group . getTitle ( ) , group . getAvatar ( ) ) ) ; 
 } 
 } 
 \ No newline at end of file
