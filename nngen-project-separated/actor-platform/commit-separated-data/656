BLEU SCORE: 0.5766735394403276

TEST MSG: refactor ( server : push ) : flatten google push stream
GENERATED MSG: refactor ( server : push ) : more debug on google push

TEST DIFF (one line): diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / sequence / GooglePushExtension . scala b / actor - server / actor - core / src / main / scala / im / actor / server / sequence / GooglePushExtension . scala < nl > index 7a2edaa . . e4af2ce 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / sequence / GooglePushExtension . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / sequence / GooglePushExtension . scala < nl > @ @ - 5 , 6 + 5 , 7 @ @ import akka . event . Logging < nl > import akka . http . scaladsl . Http < nl > import akka . http . scaladsl . model . _ < nl > import akka . http . scaladsl . settings . ConnectionPoolSettings < nl > + import akka . http . scaladsl . util . FastFuture < nl > import akka . stream . { ActorMaterializer , Materializer } < nl > import akka . stream . actor . ActorPublisher < nl > import akka . stream . scaladsl . Source < nl > @ @ - 70 , 38 + 71 , 40 @ @ final class GooglePushExtension ( system : ActorSystem ) extends Extension { < nl > private val config = GooglePushManagerConfig . load ( system . settings . config . getConfig ( " services . google . push " ) ) . get < nl > private val deliveryPublisher = system . actorOf ( GooglePushDelivery . props , " google - push - delivery " ) < nl > < nl > - / / TODO : flatten < nl > Source . fromPublisher ( ActorPublisher [ ( HttpRequest , GooglePushDelivery . Delivery ) ] ( deliveryPublisher ) ) < nl > . via ( GooglePushDelivery . flow ) < nl > - . runForeach { < nl > + . mapAsync ( 1 ) { < nl > case ( Success ( resp ) , delivery ) ⇒ < nl > if ( resp . status = = StatusCodes . OK ) { < nl > - resp . entity . dataBytes . runFold ( ByteString . empty ) ( _ + + _ ) foreach { bs ⇒ < nl > - parse ( new String ( bs . toArray , " UTF - 8 " ) ) match { < nl > - case Xor . Right ( json ) ⇒ < nl > - json . asObject match { < nl > - case Some ( obj ) ⇒ < nl > - obj ( " error " ) map ( _ . asString ) foreach { < nl > - case Some ( " InvalidRegistration " ) ⇒ < nl > - log . warning ( " Invalid registration , deleting " ) < nl > - remove ( delivery . m . to ) < nl > - case Some ( " NotRegistered " ) ⇒ < nl > - log . warning ( " Token is not registered , deleting " ) < nl > - remove ( delivery . m . to ) < nl > - case Some ( other ) ⇒ < nl > - log . warning ( " Error in GCM response : { } " , other ) < nl > - case None ⇒ < nl > - log . debug ( " Delivered successfully " ) < nl > - } < nl > + resp . entity . dataBytes . runFold ( ByteString . empty ) ( _ + + _ ) map ( _ → delivery ) < nl > + } else FastFuture . failed ( new RuntimeException ( s " Failed to deliver message , StatusCode was not OK : $ { resp . status } " ) ) < nl > + case ( Failure ( e ) , delivery ) ⇒ < nl > + FastFuture . failed ( e ) < nl > + } < nl > + . runForeach { < nl > + / / TODO : flatten < nl > + case ( bs , delivery ) ⇒ < nl > + parse ( new String ( bs . toArray , " UTF - 8 " ) ) match { < nl > + case Xor . Right ( json ) ⇒ < nl > + json . asObject match { < nl > + case Some ( obj ) ⇒ < nl > + obj ( " error " ) map ( _ . asString ) foreach { < nl > + case Some ( " InvalidRegistration " ) ⇒ < nl > + log . warning ( " Invalid registration , deleting " ) < nl > + remove ( delivery . m . to ) < nl > + case Some ( " NotRegistered " ) ⇒ < nl > + log . warning ( " Token is not registered , deleting " ) < nl > + remove ( delivery . m . to ) < nl > + case Some ( other ) ⇒ < nl > + log . warning ( " Error in GCM response : { } " , other ) < nl > case None ⇒ < nl > - log . error ( " Expected JSON Object but got : { } " , json ) < nl > + log . debug ( " Delivered successfully " ) < nl > } < nl > - case Xor . Left ( failure ) ⇒ log . error ( failure . underlying , " Failed to parse response " ) < nl > + case None ⇒ < nl > + log . error ( " Expected JSON Object but got : { } " , json ) < nl > } < nl > - } < nl > - } else log . error ( " Failed to deliver message , StatusCode was not OK : { } " , resp . status ) < nl > - case ( Failure ( e ) , delivery ) ⇒ < nl > - log . error ( e , " Failed to deliver message : { } " , delivery . m ) < nl > + case Xor . Left ( failure ) ⇒ log . error ( failure . underlying , " Failed to parse response " ) < nl > + } < nl > } onComplete { < nl > case Failure ( e ) ⇒ log . error ( e , " Failure in stream " ) < nl > case Success ( _ ) ⇒ log . debug ( " Stream completed " )
NEAREST DIFF (one line): diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / sequence / GooglePushManager . scala b / actor - server / actor - core / src / main / scala / im / actor / server / sequence / GooglePushManager . scala < nl > index 06345e9 . . 27f6650 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / sequence / GooglePushManager . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / sequence / GooglePushManager . scala < nl > @ @ - 69 , 15 + 69 , 17 @ @ final class GooglePushManager ( config : GooglePushManagerConfig ) ( implicit system : < nl > case Xor . Right ( json ) ⇒ < nl > json . asObject match { < nl > case Some ( obj ) ⇒ < nl > - obj ( " error " ) flatMap ( _ . asString ) foreach { < nl > - case " InvalidRegistration " ⇒ < nl > + obj ( " error " ) map ( _ . asString ) foreach { < nl > + case Some ( " InvalidRegistration " ) ⇒ < nl > log . warning ( " Invalid registration , deleting " ) < nl > remove ( delivery . regId ) < nl > - case " NotRegistered " ⇒ < nl > + case Some ( " NotRegistered " ) ⇒ < nl > log . warning ( " Token is not registered , deleting " ) < nl > remove ( delivery . regId ) < nl > - case other ⇒ < nl > + case Some ( other ) ⇒ < nl > log . warning ( " Error in GCM response : { } " , other ) < nl > + case None = > < nl > + log . debug ( " Delivered successfully " ) < nl > } < nl > case None ⇒ < nl > log . error ( " Expected JSON Object but got : { } " , json ) < nl > @ @ - 85 , 10 + 87 , 13 @ @ final class GooglePushManager ( config : GooglePushManagerConfig ) ( implicit system : < nl > case Xor . Left ( failure ) ⇒ log . error ( failure . underlying , " Failed to parse response " ) < nl > } < nl > } < nl > - } else log . error ( " Status code was not OK : { } " , resp . status ) < nl > + } else log . error ( " Failed to deliver message , StatusCode was not OK : { } " , resp . status ) < nl > case ( Failure ( e ) , delivery ) ⇒ < nl > log . error ( e , " Failed to deliver message : { } " , delivery . m ) < nl > - } < nl > + } onComplete { < nl > + case Failure ( e ) = > log . error ( e , " Failure in stream " ) < nl > + case Success ( _ ) = > log . debug ( " Stream completed " ) < nl > + } < nl > < nl > private def remove ( regId : String ) : Future [ Int ] = db . run ( GooglePushCredentialsRepo . deleteByToken ( regId ) ) < nl > < nl > @ @ - 135 , 6 + 140 , 8 @ @ private final class GooglePushDelivery extends ActorPublisher [ ( HttpRequest , Goog < nl > case d : Delivery if buf . size = = MaxQueue ⇒ < nl > log . error ( " Current queue is already at size MaxQueue : { } , ignoring delivery " , MaxQueue ) < nl > case d : Delivery ⇒ < nl > + log . debug ( " New delivery " ) < nl > + < nl > if ( buf . isEmpty & & totalDemand > 0 ) < nl > onNext ( mkJob ( d ) ) < nl > else {

TEST DIFF:
diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / sequence / GooglePushExtension . scala b / actor - server / actor - core / src / main / scala / im / actor / server / sequence / GooglePushExtension . scala 
 index 7a2edaa . . e4af2ce 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / sequence / GooglePushExtension . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / sequence / GooglePushExtension . scala 
 @ @ - 5 , 6 + 5 , 7 @ @ import akka . event . Logging 
 import akka . http . scaladsl . Http 
 import akka . http . scaladsl . model . _ 
 import akka . http . scaladsl . settings . ConnectionPoolSettings 
 + import akka . http . scaladsl . util . FastFuture 
 import akka . stream . { ActorMaterializer , Materializer } 
 import akka . stream . actor . ActorPublisher 
 import akka . stream . scaladsl . Source 
 @ @ - 70 , 38 + 71 , 40 @ @ final class GooglePushExtension ( system : ActorSystem ) extends Extension { 
 private val config = GooglePushManagerConfig . load ( system . settings . config . getConfig ( " services . google . push " ) ) . get 
 private val deliveryPublisher = system . actorOf ( GooglePushDelivery . props , " google - push - delivery " ) 
 
 - / / TODO : flatten 
 Source . fromPublisher ( ActorPublisher [ ( HttpRequest , GooglePushDelivery . Delivery ) ] ( deliveryPublisher ) ) 
 . via ( GooglePushDelivery . flow ) 
 - . runForeach { 
 + . mapAsync ( 1 ) { 
 case ( Success ( resp ) , delivery ) ⇒ 
 if ( resp . status = = StatusCodes . OK ) { 
 - resp . entity . dataBytes . runFold ( ByteString . empty ) ( _ + + _ ) foreach { bs ⇒ 
 - parse ( new String ( bs . toArray , " UTF - 8 " ) ) match { 
 - case Xor . Right ( json ) ⇒ 
 - json . asObject match { 
 - case Some ( obj ) ⇒ 
 - obj ( " error " ) map ( _ . asString ) foreach { 
 - case Some ( " InvalidRegistration " ) ⇒ 
 - log . warning ( " Invalid registration , deleting " ) 
 - remove ( delivery . m . to ) 
 - case Some ( " NotRegistered " ) ⇒ 
 - log . warning ( " Token is not registered , deleting " ) 
 - remove ( delivery . m . to ) 
 - case Some ( other ) ⇒ 
 - log . warning ( " Error in GCM response : { } " , other ) 
 - case None ⇒ 
 - log . debug ( " Delivered successfully " ) 
 - } 
 + resp . entity . dataBytes . runFold ( ByteString . empty ) ( _ + + _ ) map ( _ → delivery ) 
 + } else FastFuture . failed ( new RuntimeException ( s " Failed to deliver message , StatusCode was not OK : $ { resp . status } " ) ) 
 + case ( Failure ( e ) , delivery ) ⇒ 
 + FastFuture . failed ( e ) 
 + } 
 + . runForeach { 
 + / / TODO : flatten 
 + case ( bs , delivery ) ⇒ 
 + parse ( new String ( bs . toArray , " UTF - 8 " ) ) match { 
 + case Xor . Right ( json ) ⇒ 
 + json . asObject match { 
 + case Some ( obj ) ⇒ 
 + obj ( " error " ) map ( _ . asString ) foreach { 
 + case Some ( " InvalidRegistration " ) ⇒ 
 + log . warning ( " Invalid registration , deleting " ) 
 + remove ( delivery . m . to ) 
 + case Some ( " NotRegistered " ) ⇒ 
 + log . warning ( " Token is not registered , deleting " ) 
 + remove ( delivery . m . to ) 
 + case Some ( other ) ⇒ 
 + log . warning ( " Error in GCM response : { } " , other ) 
 case None ⇒ 
 - log . error ( " Expected JSON Object but got : { } " , json ) 
 + log . debug ( " Delivered successfully " ) 
 } 
 - case Xor . Left ( failure ) ⇒ log . error ( failure . underlying , " Failed to parse response " ) 
 + case None ⇒ 
 + log . error ( " Expected JSON Object but got : { } " , json ) 
 } 
 - } 
 - } else log . error ( " Failed to deliver message , StatusCode was not OK : { } " , resp . status ) 
 - case ( Failure ( e ) , delivery ) ⇒ 
 - log . error ( e , " Failed to deliver message : { } " , delivery . m ) 
 + case Xor . Left ( failure ) ⇒ log . error ( failure . underlying , " Failed to parse response " ) 
 + } 
 } onComplete { 
 case Failure ( e ) ⇒ log . error ( e , " Failure in stream " ) 
 case Success ( _ ) ⇒ log . debug ( " Stream completed " )

NEAREST DIFF:
diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / sequence / GooglePushManager . scala b / actor - server / actor - core / src / main / scala / im / actor / server / sequence / GooglePushManager . scala 
 index 06345e9 . . 27f6650 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / sequence / GooglePushManager . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / sequence / GooglePushManager . scala 
 @ @ - 69 , 15 + 69 , 17 @ @ final class GooglePushManager ( config : GooglePushManagerConfig ) ( implicit system : 
 case Xor . Right ( json ) ⇒ 
 json . asObject match { 
 case Some ( obj ) ⇒ 
 - obj ( " error " ) flatMap ( _ . asString ) foreach { 
 - case " InvalidRegistration " ⇒ 
 + obj ( " error " ) map ( _ . asString ) foreach { 
 + case Some ( " InvalidRegistration " ) ⇒ 
 log . warning ( " Invalid registration , deleting " ) 
 remove ( delivery . regId ) 
 - case " NotRegistered " ⇒ 
 + case Some ( " NotRegistered " ) ⇒ 
 log . warning ( " Token is not registered , deleting " ) 
 remove ( delivery . regId ) 
 - case other ⇒ 
 + case Some ( other ) ⇒ 
 log . warning ( " Error in GCM response : { } " , other ) 
 + case None = > 
 + log . debug ( " Delivered successfully " ) 
 } 
 case None ⇒ 
 log . error ( " Expected JSON Object but got : { } " , json ) 
 @ @ - 85 , 10 + 87 , 13 @ @ final class GooglePushManager ( config : GooglePushManagerConfig ) ( implicit system : 
 case Xor . Left ( failure ) ⇒ log . error ( failure . underlying , " Failed to parse response " ) 
 } 
 } 
 - } else log . error ( " Status code was not OK : { } " , resp . status ) 
 + } else log . error ( " Failed to deliver message , StatusCode was not OK : { } " , resp . status ) 
 case ( Failure ( e ) , delivery ) ⇒ 
 log . error ( e , " Failed to deliver message : { } " , delivery . m ) 
 - } 
 + } onComplete { 
 + case Failure ( e ) = > log . error ( e , " Failure in stream " ) 
 + case Success ( _ ) = > log . debug ( " Stream completed " ) 
 + } 
 
 private def remove ( regId : String ) : Future [ Int ] = db . run ( GooglePushCredentialsRepo . deleteByToken ( regId ) ) 
 
 @ @ - 135 , 6 + 140 , 8 @ @ private final class GooglePushDelivery extends ActorPublisher [ ( HttpRequest , Goog 
 case d : Delivery if buf . size = = MaxQueue ⇒ 
 log . error ( " Current queue is already at size MaxQueue : { } , ignoring delivery " , MaxQueue ) 
 case d : Delivery ⇒ 
 + log . debug ( " New delivery " ) 
 + 
 if ( buf . isEmpty & & totalDemand > 0 ) 
 onNext ( mkJob ( d ) ) 
 else {
