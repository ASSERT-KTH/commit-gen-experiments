BLEU SCORE: 0.08209664081048344

TEST MSG: feat ( core ) : Implemented Call Attempt support
GENERATED MSG: feat ( ios + core ) : Integrated Wake Locks , passing call id from PuskKit to core

TEST DIFF (one line): diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift < nl > index 6dfb37a . . 1511ed9 100644 < nl > - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift < nl > + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift < nl > @ @ - 340 , 7 + 340 , 11 @ @ import PushKit < nl > if ( type = = PKPushTypeVoIP ) { < nl > let aps = payload . dictionaryPayload [ " aps " ] as ! [ NSString : AnyObject ] < nl > if let callId = aps [ " callId " ] as ? String { < nl > - Actor . checkCall ( jlong ( callId ) ! ) < nl > + if let attempt = aps [ " attempt " ] as ? String { < nl > + Actor . checkCall ( jlong ( callId ) ! , withAttempt : jint ( attempt ) ! ) < nl > + } else { < nl > + Actor . checkCall ( jlong ( callId ) ! , withAttempt : 0 ) < nl > + } < nl > } < nl > } < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java < nl > index c7a2b48 . . 176cefd 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java < nl > @ @ - 1075 , 12 + 1075 , 13 @ @ public class Messenger { < nl > / * * < nl > * Checking incoming call from push notification < nl > * < nl > - * @ param callId Call Id < nl > + * @ param callId Call Id < nl > + * @ param attempt Call Attempt < nl > * / < nl > - @ ObjectiveCName ( " checkCall : " ) < nl > - public void checkCall ( long callId ) { < nl > + @ ObjectiveCName ( " checkCall : withAttempt : " ) < nl > + public void checkCall ( long callId , int attempt ) { < nl > if ( modules . getCallsModule ( ) ! = null ) { < nl > - modules . getCallsModule ( ) . checkCall ( callId ) ; < nl > + modules . getCallsModule ( ) . checkCall ( callId , attempt ) ; < nl > } < nl > } < nl > < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / api / updates / UpdateCallHandled . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / api / updates / UpdateCallHandled . java < nl > index 9238e3a . . d0191e9 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / api / updates / UpdateCallHandled . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / api / updates / UpdateCallHandled . java < nl > @ @ - 23 , 9 + 23 , 11 @ @ public class UpdateCallHandled extends Update { < nl > } < nl > < nl > private long callId ; < nl > + private Integer attemptIndex ; < nl > < nl > - public UpdateCallHandled ( long callId ) { < nl > + public UpdateCallHandled ( long callId , @ Nullable Integer attemptIndex ) { < nl > this . callId = callId ; < nl > + this . attemptIndex = attemptIndex ; < nl > } < nl > < nl > public UpdateCallHandled ( ) { < nl > @ @ - 36 , 20 + 38 , 30 @ @ public class UpdateCallHandled extends Update { < nl > return this . callId ; < nl > } < nl > < nl > + @ Nullable < nl > + public Integer getAttemptIndex ( ) { < nl > + return this . attemptIndex ; < nl > + } < nl > + < nl > @ Override < nl > public void parse ( BserValues values ) throws IOException { < nl > this . callId = values . getLong ( 1 ) ; < nl > + this . attemptIndex = values . optInt ( 2 ) ; < nl > } < nl > < nl > @ Override < nl > public void serialize ( BserWriter writer ) throws IOException { < nl > writer . writeLong ( 1 , this . callId ) ; < nl > + if ( this . attemptIndex ! = null ) { < nl > + writer . writeInt ( 2 , this . attemptIndex ) ; < nl > + } < nl > } < nl > < nl > @ Override < nl > public String toString ( ) { < nl > String res = " update CallHandled { " ; < nl > res + = " callId = " + this . callId ; < nl > + res + = " , attemptIndex = " + this . attemptIndex ; < nl > res + = " } " ; < nl > return res ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / api / updates / UpdateIncomingCall . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / api / updates / UpdateIncomingCall . java < nl > index 4187e41 . . 2189a1b 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / api / updates / UpdateIncomingCall . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / api / updates / UpdateIncomingCall . java < nl > @ @ - 23 , 9 + 23 , 11 @ @ public class UpdateIncomingCall extends Update { < nl > } < nl > < nl > private long callId ; < nl > + private Integer attemptIndex ; < nl > < nl > - public UpdateIncomingCall ( long callId ) { < nl > + public UpdateIncomingCall ( long callId , @ Nullable Integer attemptIndex ) { < nl > this . callId = callId ; < nl > + this . attemptIndex = attemptIndex ; < nl > } < nl > < nl > public UpdateIncomingCall ( ) { < nl > @ @ - 36 , 20 + 38 , 30 @ @ public class UpdateIncomingCall extends Update { < nl > return this . callId ; < nl > } < nl > < nl > + @ Nullable < nl > + public Integer getAttemptIndex ( ) { < nl > + return this . attemptIndex ; < nl > + } < nl > + < nl > @ Override < nl > public void parse ( BserValues values ) throws IOException { < nl > this . callId = values . getLong ( 1 ) ; < nl > + this . attemptIndex = values . optInt ( 2 ) ; < nl > } < nl > < nl > @ Override < nl > public void serialize ( BserWriter writer ) throws IOException { < nl > writer . writeLong ( 1 , this . callId ) ; < nl > + if ( this . attemptIndex ! = null ) { < nl > + writer . writeInt ( 2 , this . attemptIndex ) ; < nl > + } < nl > } < nl > < nl > @ Override < nl > public String toString ( ) { < nl > String res = " update IncomingCall { " ; < nl > res + = " callId = " + this . callId ; < nl > + res + = " , attemptIndex = " + this . attemptIndex ; < nl > res + = " } " ; < nl > return res ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java < nl > index f50de67 . . 65be7e0 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java < nl > @ @ - 34 , 6 + 34 , 7 @ @ public class CallManagerActor extends ModuleActor { < nl > < nl > private CallsProvider provider ; < nl > private HashSet < Long > handledCalls = new HashSet < > ( ) ; < nl > + private HashMap < Long , Integer > handledCallAttempts = new HashMap < > ( ) ; < nl > private HashSet < Long > answeredCalls = new HashSet < > ( ) ; < nl > < nl > private Long currentCall ; < nl > @ @ - 62 , 10 + 63 , 7 @ @ public class CallManagerActor extends ModuleActor { < nl > / / Stopping current call as we started new done < nl > / / < nl > if ( currentCall ! = null ) { < nl > - ActorRef dest = runningCalls . remove ( currentCall ) ; < nl > - if ( dest ! = null ) { < nl > - dest . send ( PoisonPill . INSTANCE ) ; < nl > - } < nl > + terminalCall ( currentCall ) ; < nl > currentCall = null ; < nl > } < nl > < nl > @ @ - 87 , 15 + 85 , 13 @ @ public class CallManagerActor extends ModuleActor { < nl > / / Stopping current call some are started during call establishing < nl > / / < nl > if ( currentCall ! = null ) { < nl > - ActorRef dest = runningCalls . remove ( currentCall ) ; < nl > - if ( dest ! = null ) { < nl > - dest . send ( PoisonPill . INSTANCE ) ; < nl > - } < nl > + terminalCall ( currentCall ) ; < nl > + currentCall = null ; < nl > + < nl > if ( isBeeping ) { < nl > isBeeping = false ; < nl > provider . stopOutgoingBeep ( ) ; < nl > } < nl > - currentCall = null ; < nl > } < nl > < nl > / / < nl > @ @ - 104 , 7 + 100 , 7 @ @ public class CallManagerActor extends ModuleActor { < nl > runningCalls . put ( callId , ref ) ; < nl > < nl > / / < nl > - / / Marking outgoing call as answered to avoid call rejects on call ending < nl > + / / Marking outgoing call as answered < nl > / / < nl > answeredCalls . add ( callId ) ; < nl > < nl > @ @ - 126 , 19 + 122 , 40 @ @ public class CallManagerActor extends ModuleActor { < nl > / / Incoming call < nl > / / < nl > < nl > - private void onIncomingCall ( final long callId , WakeLock wakeLock ) { < nl > + private void onIncomingCall ( final long callId , final int attempt , WakeLock wakeLock ) { < nl > Log . d ( TAG , " onIncomingCall ( " + callId + " ) " ) ; < nl > < nl > / / < nl > / / Filter double updates about incoming call < nl > / / < nl > if ( handledCalls . contains ( callId ) ) { < nl > + if ( handledCallAttempts . get ( callId ) > = attempt ) { < nl > + if ( wakeLock ! = null ) { < nl > + wakeLock . releaseLock ( ) ; < nl > + } < nl > + return ; < nl > + } < nl > + } < nl > + < nl > + / / < nl > + / / Ignore any incoming call if we already have running call with such call id < nl > + / / < nl > + if ( runningCalls . containsKey ( callId ) ) { < nl > if ( wakeLock ! = null ) { < nl > wakeLock . releaseLock ( ) ; < nl > } < nl > return ; < nl > } < nl > + < nl > + / / < nl > + / / Marking handled calls as handled < nl > + / / < nl > handledCalls . add ( callId ) ; < nl > + handledCallAttempts . put ( callId , attempt ) ; < nl > + < nl > + / / < nl > + / / Creating wake lock if needed < nl > + / / < nl > if ( wakeLock = = null ) { < nl > wakeLock = Runtime . makeWakeLock ( ) ; < nl > } < nl > @ @ - 187 , 10 + 204 , 7 @ @ public class CallManagerActor extends ModuleActor { < nl > / / < nl > / / Shutdown call actor < nl > / / < nl > - ActorRef ref = runningCalls . remove ( callId ) ; < nl > - if ( ref ! = null ) { < nl > - ref . send ( PoisonPill . INSTANCE ) ; < nl > - } < nl > + terminalCall ( callId ) ; < nl > } < nl > } < nl > < nl > @ @ - 207 , 7 + 221 , 6 @ @ public class CallManagerActor extends ModuleActor { < nl > < nl > / / < nl > / / Sending answer message to actor . < nl > - / / Hint : If we will send message to master call actor nothing will happen < nl > / / < nl > ActorRef ref = runningCalls . get ( callId ) ; < nl > if ( ref ! = null ) { < nl > @ @ - 316 , 6 + 329 , 20 @ @ public class CallManagerActor extends ModuleActor { < nl > } < nl > } < nl > < nl > + private void terminalCall ( long callId ) { < nl > + ActorRef dest = runningCalls . remove ( callId ) ; < nl > + if ( dest ! = null ) { < nl > + dest . send ( PoisonPill . INSTANCE ) ; < nl > + } < nl > + } < nl > + < nl > + private void sendToCall ( long callId , Object message ) { < nl > + ActorRef dest = runningCalls . get ( callId ) ; < nl > + if ( dest ! = null ) { < nl > + dest . send ( message ) ; < nl > + } < nl > + } < nl > + < nl > < nl > / / < nl > / / Messages < nl > @ @ - 325 , 10 + 352 , 10 @ @ public class CallManagerActor extends ModuleActor { < nl > public void onReceive ( Object message ) { < nl > if ( message instanceof OnIncomingCall ) { < nl > OnIncomingCall call = ( OnIncomingCall ) message ; < nl > - onIncomingCall ( call . getCallId ( ) , null ) ; < nl > + onIncomingCall ( call . getCallId ( ) , call . getAttempt ( ) , null ) ; < nl > } else if ( message instanceof OnIncomingCallLocked ) { < nl > OnIncomingCallLocked locked = ( OnIncomingCallLocked ) message ; < nl > - onIncomingCall ( locked . getCallId ( ) , locked . getWakeLock ( ) ) ; < nl > + onIncomingCall ( locked . getCallId ( ) , locked . getAttempt ( ) , locked . getWakeLock ( ) ) ; < nl > } else if ( message instanceof OnIncomingCallHandled ) { < nl > OnIncomingCallHandled incomingCallHandled = ( OnIncomingCallHandled ) message ; < nl > onIncomingCallHandled ( incomingCallHandled . getCallId ( ) ) ; < nl > @ @ - 364 , 24 + 391 , 32 @ @ public class CallManagerActor extends ModuleActor { < nl > public static class OnIncomingCall { < nl > < nl > private long callId ; < nl > + private int attempt ; < nl > < nl > - public OnIncomingCall ( long callId ) { < nl > + public OnIncomingCall ( long callId , int attempt ) { < nl > this . callId = callId ; < nl > + this . attempt = attempt ; < nl > } < nl > < nl > public long getCallId ( ) { < nl > return callId ; < nl > } < nl > + < nl > + public int getAttempt ( ) { < nl > + return attempt ; < nl > + } < nl > } < nl > < nl > public static class OnIncomingCallLocked { < nl > < nl > private long callId ; < nl > + private int attempt ; < nl > private WakeLock wakeLock ; < nl > < nl > - public OnIncomingCallLocked ( long callId , WakeLock wakeLock ) { < nl > + public OnIncomingCallLocked ( long callId , int attempt , WakeLock wakeLock ) { < nl > this . callId = callId ; < nl > this . wakeLock = wakeLock ; < nl > + this . attempt = attempt ; < nl > } < nl > < nl > public long getCallId ( ) { < nl > @ @ - 391 , 14 + 426 , 24 @ @ public class CallManagerActor extends ModuleActor { < nl > public WakeLock getWakeLock ( ) { < nl > return wakeLock ; < nl > } < nl > + < nl > + public int getAttempt ( ) { < nl > + return attempt ; < nl > + } < nl > } < nl > < nl > public static class OnIncomingCallHandled { < nl > < nl > private long callId ; < nl > + private int attempt ; < nl > < nl > - public OnIncomingCallHandled ( long callId ) { < nl > + public OnIncomingCallHandled ( long callId , int attempt ) { < nl > this . callId = callId ; < nl > + this . attempt = attempt ; < nl > + } < nl > + < nl > + public int getAttempt ( ) { < nl > + return attempt ; < nl > } < nl > < nl > public long getCallId ( ) { < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsModule . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsModule . java < nl > index 745d76f . . 8c3a81e 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsModule . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsModule . java < nl > @ @ - 45 , 8 + 45 , 8 @ @ public class CallsModule extends AbsModule { < nl > return callManager ; < nl > } < nl > < nl > - public void checkCall ( long callId ) { < nl > - callManager . send ( new CallManagerActor . OnIncomingCallLocked ( callId , im . actor . runtime . Runtime . makeWakeLock ( ) ) ) ; < nl > + public void checkCall ( long callId , int attempt ) { < nl > + callManager . send ( new CallManagerActor . OnIncomingCallLocked ( callId , attempt , im . actor . runtime . Runtime . makeWakeLock ( ) ) ) ; < nl > } < nl > < nl > public void probablyEndCall ( ) { < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsProcessor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsProcessor . java < nl > index f8d3c7c . . cd88f53 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsProcessor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsProcessor . java < nl > @ @ - 17 , 17 + 17 , 21 @ @ public class CallsProcessor implements Processor { < nl > if ( update instanceof UpdateIncomingCall ) { < nl > UpdateIncomingCall updateIncomingCall = ( UpdateIncomingCall ) update ; < nl > if ( context . getConfiguration ( ) . isVoiceCallsEnabled ( ) ) { < nl > + int index = updateIncomingCall . getAttemptIndex ( ) ! = null ? updateIncomingCall . getAttemptIndex ( ) : 0 ; < nl > context . getCallsModule ( ) . getCallManager ( ) . send ( < nl > new CallManagerActor . OnIncomingCall ( < nl > - updateIncomingCall . getCallId ( ) ) ) ; < nl > + updateIncomingCall . getCallId ( ) , < nl > + index ) ) ; < nl > } < nl > return true ; < nl > } else if ( update instanceof UpdateCallHandled ) { < nl > UpdateCallHandled updateCallHandled = ( UpdateCallHandled ) update ; < nl > if ( context . getConfiguration ( ) . isVoiceCallsEnabled ( ) ) { < nl > + int index = updateCallHandled . getAttemptIndex ( ) ! = null ? updateCallHandled . getAttemptIndex ( ) : 0 ; < nl > context . getCallsModule ( ) . getCallManager ( ) . send ( < nl > new CallManagerActor . OnIncomingCallHandled ( < nl > - updateCallHandled . getCallId ( ) ) ) ; < nl > + updateCallHandled . getCallId ( ) , < nl > + index ) ) ; < nl > } < nl > return true ; < nl > }
NEAREST DIFF (one line): diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift < nl > index 58a48b5 . . 7b136d7 100644 < nl > - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift < nl > + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift < nl > @ @ - 342 , 7 + 342 , 6 @ @ import PushKit < nl > @ objc public func pushRegistry ( registry : PKPushRegistry ! , didUpdatePushCredentials credentials : PKPushCredentials ! , forType type : String ! ) { < nl > if ( type = = PKPushTypeVoIP ) { < nl > let tokenString = " \ ( credentials . token ) " . replace ( " " , dest : " " ) . replace ( " < " , dest : " " ) . replace ( " > " , dest : " " ) < nl > - print ( " PushKit : \ ( tokenString ) " ) < nl > pushRegisterKitToken ( tokenString ) < nl > } < nl > } < nl > @ @ - 355 , 7 + 354 , 10 @ @ import PushKit < nl > < nl > @ objc public func pushRegistry ( registry : PKPushRegistry ! , didReceiveIncomingPushWithPayload payload : PKPushPayload ! , forType type : String ! ) { < nl > if ( type = = PKPushTypeVoIP ) { < nl > - print ( " PushKit Payload : \ ( payload ) " ) < nl > + let aps = payload . dictionaryPayload [ " aps " ] as ! [ NSString : AnyObject ] < nl > + if let callId = aps [ " callId " ] as ? String { < nl > + Actor . checkCall ( jlong ( callId ) ! ) < nl > + } < nl > } < nl > } < nl > < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java < nl > index 53a7cd1 . . d868238 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java < nl > @ @ - 1072 , 6 + 1072 , 18 @ @ public class Messenger { < nl > } < nl > } < nl > < nl > + / * * < nl > + * Checking incoming call from push notification < nl > + * < nl > + * @ param callId Call Id < nl > + * / < nl > + @ ObjectiveCName ( " checkCall : " ) < nl > + public void checkCall ( long callId ) { < nl > + if ( modules . getCallsModule ( ) ! = null ) { < nl > + modules . getCallsModule ( ) . checkCall ( callId ) ; < nl > + } < nl > + } < nl > + < nl > / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / < nl > / / Peer operations < nl > / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java < nl > index 59a2d11 . . f544d1d 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java < nl > @ @ - 14 , 12 + 14 , 14 @ @ import im . actor . core . viewmodel . CallVM ; < nl > import im . actor . core . viewmodel . CommandCallback ; < nl > import im . actor . runtime . actors . messages . PoisonPill ; < nl > import im . actor . runtime . function . Consumer ; < nl > + import im . actor . runtime . power . WakeLock ; < nl > < nl > import static im . actor . core . modules . internal . messages . entity . EntityConverter . convert ; < nl > < nl > public class CallActor extends AbsCallActor { < nl > < nl > private final boolean isMaster ; < nl > + private final WakeLock wakeLock ; < nl > private long callId ; < nl > private Peer peer ; < nl > private CallVM callVM ; < nl > @ @ - 29 , 16 + 31 , 18 @ @ public class CallActor extends AbsCallActor { < nl > private boolean isAnswered ; < nl > private boolean isRejected ; < nl > < nl > - public CallActor ( long callId , ModuleContext context ) { < nl > + public CallActor ( long callId , WakeLock wakeLock , ModuleContext context ) { < nl > super ( context ) ; < nl > + this . wakeLock = wakeLock ; < nl > this . isMaster = false ; < nl > this . callId = callId ; < nl > this . isAnswered = false ; < nl > this . isActive = false ; < nl > } < nl > < nl > - public CallActor ( Peer peer , CommandCallback < Long > callback , ModuleContext context ) { < nl > + public CallActor ( Peer peer , CommandCallback < Long > callback , WakeLock wakeLock , ModuleContext context ) { < nl > super ( context ) ; < nl > + this . wakeLock = wakeLock ; < nl > this . isMaster = true ; < nl > this . callback = callback ; < nl > this . peer = peer ; < nl > @ @ - 154 , 6 + 158 , 7 @ @ public class CallActor extends AbsCallActor { < nl > if ( callId ! = 0 ) { < nl > callManager . send ( new CallManagerActor . OnCallEnded ( callId ) , self ( ) ) ; < nl > } < nl > + wakeLock . releaseLock ( ) ; < nl > } < nl > < nl > / / < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java < nl > index 525b26a . . 0194b2a 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java < nl > @ @ - 11 , 11 + 11 , 13 @ @ import im . actor . core . providers . CallsProvider ; < nl > import im . actor . core . util . RandomUtils ; < nl > import im . actor . core . viewmodel . CommandCallback ; < nl > import im . actor . runtime . * ; < nl > + import im . actor . runtime . Runtime ; < nl > import im . actor . runtime . actors . Actor ; < nl > import im . actor . runtime . actors . ActorCreator ; < nl > import im . actor . runtime . actors . ActorRef ; < nl > import im . actor . runtime . actors . messages . PoisonPill ; < nl > import im . actor . runtime . function . Constructor ; < nl > + import im . actor . runtime . power . WakeLock ; < nl > < nl > public class CallManagerActor extends ModuleActor { < nl > < nl > @ @ - 70 , 10 + 72 , 11 @ @ public class CallManagerActor extends ModuleActor { < nl > / / < nl > / / Spawning new Actor for call < nl > / / < nl > + final WakeLock wakeLock = Runtime . makeWakeLock ( ) ; < nl > system ( ) . actorOf ( " actor / master / " + RandomUtils . nextRid ( ) , new ActorCreator ( ) { < nl > @ Override < nl > public Actor create ( ) { < nl > - return new CallActor ( peer , callback , context ( ) ) ; < nl > + return new CallActor ( peer , callback , wakeLock , context ( ) ) ; < nl > } < nl > } ) ; < nl > } < nl > @ @ - 118 , 24 + 121 , 31 @ @ public class CallManagerActor extends ModuleActor { < nl > / / Incoming call < nl > / / < nl > < nl > - private void onIncomingCall ( final long callId ) { < nl > + private void onIncomingCall ( final long callId , WakeLock wakeLock ) { < nl > Log . d ( TAG , " onIncomingCall ( " + callId + " ) " ) ; < nl > < nl > / / < nl > / / Filter double updates about incoming call < nl > / / < nl > if ( handledCalls . contains ( callId ) ) { < nl > + if ( wakeLock ! = null ) { < nl > + wakeLock . releaseLock ( ) ; < nl > + } < nl > return ; < nl > } < nl > handledCalls . add ( callId ) ; < nl > + if ( wakeLock = = null ) { < nl > + wakeLock = Runtime . makeWakeLock ( ) ; < nl > + } < nl > < nl > / / < nl > / / Spawning new Actor for call < nl > / / < nl > - system ( ) . actorOf ( " actor / slave / " + RandomUtils . nextRid ( ) , new ActorCreator ( ) { < nl > + final WakeLock finalWakeLock = wakeLock ; < nl > + system ( ) . actorOf ( " actor / call " + RandomUtils . nextRid ( ) , new ActorCreator ( ) { < nl > @ Override < nl > public Actor create ( ) { < nl > - return new CallActor ( callId , context ( ) ) ; < nl > + return new CallActor ( callId , finalWakeLock , context ( ) ) ; < nl > } < nl > } ) ; < nl > } < nl > @ @ - 306 , 7 + 316 , 10 @ @ public class CallManagerActor extends ModuleActor { < nl > public void onReceive ( Object message ) { < nl > if ( message instanceof OnIncomingCall ) { < nl > OnIncomingCall call = ( OnIncomingCall ) message ; < nl > - onIncomingCall ( call . getCallId ( ) ) ; < nl > + onIncomingCall ( call . getCallId ( ) , null ) ; < nl > + } else if ( message instanceof OnIncomingCallLocked ) { < nl > + OnIncomingCallLocked locked = ( OnIncomingCallLocked ) message ; < nl > + onIncomingCall ( locked . getCallId ( ) , locked . getWakeLock ( ) ) ; < nl > } else if ( message instanceof OnIncomingCallHandled ) { < nl > OnIncomingCallHandled incomingCallHandled = ( OnIncomingCallHandled ) message ; < nl > onIncomingCallHandled ( incomingCallHandled . getCallId ( ) ) ; < nl > @ @ - 352 , 6 + 365 , 25 @ @ public class CallManagerActor extends ModuleActor { < nl > } < nl > } < nl > < nl > + public static class OnIncomingCallLocked { < nl > + < nl > + private long callId ; < nl > + private WakeLock wakeLock ; < nl > + < nl > + public OnIncomingCallLocked ( long callId , WakeLock wakeLock ) { < nl > + this . callId = callId ; < nl > + this . wakeLock = wakeLock ; < nl > + } < nl > + < nl > + public long getCallId ( ) { < nl > + return callId ; < nl > + } < nl > + < nl > + public WakeLock getWakeLock ( ) { < nl > + return wakeLock ; < nl > + } < nl > + } < nl > + < nl > public static class OnIncomingCallHandled { < nl > < nl > private long callId ; < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsModule . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsModule . java < nl > index fb0d93d . . 745d76f 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsModule . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsModule . java < nl > @ @ - 7 , 6 + 7 , 7 @ @ import im . actor . core . providers . CallsProvider ; < nl > import im . actor . core . modules . AbsModule ; < nl > import im . actor . core . modules . ModuleContext ; < nl > import im . actor . core . viewmodel . Command ; < nl > + import im . actor . runtime . * ; < nl > import im . actor . runtime . actors . ActorRef ; < nl > < nl > import static im . actor . runtime . actors . ActorSystem . system ; < nl > @ @ - 44 , 6 + 45 , 10 @ @ public class CallsModule extends AbsModule { < nl > return callManager ; < nl > } < nl > < nl > + public void checkCall ( long callId ) { < nl > + callManager . send ( new CallManagerActor . OnIncomingCallLocked ( callId , im . actor . runtime . Runtime . makeWakeLock ( ) ) ) ; < nl > + } < nl > + < nl > public void probablyEndCall ( ) { < nl > callManager . send ( new CallManagerActor . ProbablyEndCall ( ) ) ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / SenderActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / SenderActor . java < nl > index 4f9f421 . . 94e71f1 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / SenderActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / SenderActor . java < nl > @ @ - 9 , 6 + 9 , 7 @ @ import org . jetbrains . annotations . Nullable ; < nl > < nl > import java . io . IOException ; < nl > import java . util . ArrayList ; < nl > + import java . util . HashMap ; < nl > import java . util . List ; < nl > < nl > import im . actor . core . api . ApiDocumentExVoice ; < nl > @ @ - 59 , 8 + 60 , 10 @ @ import im . actor . core . util . ModuleActor ; < nl > import im . actor . core . util . RandomUtils ; < nl > import im . actor . core . network . RpcCallback ; < nl > import im . actor . core . network . RpcException ; < nl > - import im . actor . runtime . Storage ; < nl > + import im . actor . runtime . * ; < nl > + import im . actor . runtime . Runtime ; < nl > import im . actor . runtime . actors . ask . AskCallback ; < nl > + import im . actor . runtime . power . WakeLock ; < nl > < nl > public class SenderActor extends ModuleActor { < nl > < nl > @ @ - 69 , 6 + 72 , 7 @ @ public class SenderActor extends ModuleActor { < nl > private PendingMessagesStorage pendingMessages ; < nl > < nl > private long lastSendDate = 0 ; < nl > + private HashMap < Long , WakeLock > fileUplaodingWakeLocks = new HashMap < > ( ) ; < nl > < nl > public SenderActor ( ModuleContext context ) { < nl > super ( context ) ; < nl > @ @ - 321 , 6 + 325 , 7 @ @ public class SenderActor extends ModuleActor { < nl > } < nl > < nl > private void performUploadFile ( long rid , String descriptor , String fileName ) { < nl > + fileUplaodingWakeLocks . put ( rid , Runtime . makeWakeLock ( ) ) ; < nl > context ( ) . getFilesModule ( ) . requestUpload ( rid , descriptor , fileName , self ( ) ) ; < nl > } < nl > < nl > @ @ - 354 , 8 + 359 , 8 @ @ public class SenderActor extends ModuleActor { < nl > < nl > pendingMessages . getPendingMessages ( ) . add ( new PendingMessage ( msg . getPeer ( ) , msg . getRid ( ) , nContent ) ) ; < nl > context ( ) . getMessagesModule ( ) . getConversationActor ( msg . getPeer ( ) ) . send ( new ConversationActor . MessageContentUpdated ( msg . getRid ( ) , nContent ) ) ; < nl > - < nl > performSendContent ( msg . getPeer ( ) , rid , nContent ) ; < nl > + fileUplaodingWakeLocks . remove ( rid ) . releaseLock ( ) ; < nl > } < nl > < nl > private void onFileUploadError ( long rid ) { < nl > @ @ - 365 , 11 + 370 , 13 @ @ public class SenderActor extends ModuleActor { < nl > } < nl > < nl > self ( ) . send ( new MessageError ( msg . getPeer ( ) , msg . getRid ( ) ) ) ; < nl > + fileUplaodingWakeLocks . remove ( rid ) . releaseLock ( ) ; < nl > } < nl > < nl > / / Sending content < nl > < nl > private void performSendContent ( final Peer peer , final long rid , AbsContent content ) { < nl > + WakeLock wakeLock = im . actor . runtime . Runtime . makeWakeLock ( ) ; < nl > < nl > ApiMessage message ; < nl > if ( content instanceof TextContent ) { < nl > @ @ - 420 , 10 + 427 , 10 @ @ public class SenderActor extends ModuleActor { < nl > return ; < nl > } < nl > < nl > - performSendApiContent ( peer , rid , message ) ; < nl > + performSendApiContent ( peer , rid , message , wakeLock ) ; < nl > } < nl > < nl > - private void performSendApiContent ( final Peer peer , final long rid , ApiMessage message ) { < nl > + private void performSendApiContent ( final Peer peer , final long rid , ApiMessage message , final WakeLock wakeLock ) { < nl > final ApiOutPeer outPeer = buidOutPeer ( peer ) ; < nl > final ApiPeer apiPeer = buildApiPeer ( peer ) ; < nl > if ( outPeer = = null | | apiPeer = = null ) { < nl > @ @ - 438 , 11 + 445 , 13 @ @ public class SenderActor extends ModuleActor { < nl > response . getState ( ) , < nl > UpdateMessageSent . HEADER , < nl > new UpdateMessageSent ( apiPeer , rid , response . getDate ( ) ) . toByteArray ( ) ) ) ; < nl > + wakeLock . releaseLock ( ) ; < nl > } < nl > < nl > @ Override < nl > public void onError ( RpcException e ) { < nl > self ( ) . send ( new MessageError ( peer , rid ) ) ; < nl > + wakeLock . releaseLock ( ) ; < nl > } < nl > } ) ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / SequenceActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / SequenceActor . java < nl > index ef9026d . . 3cf9d18 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / SequenceActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / SequenceActor . java < nl > @ @ - 22 , 10 + 22 , 12 @ @ import im . actor . core . modules . updates . internal . ExecuteAfter ; < nl > import im . actor . core . network . RpcCallback ; < nl > import im . actor . core . network . RpcException ; < nl > import im . actor . core . util . ModuleActor ; < nl > - import im . actor . runtime . Log ; < nl > + import im . actor . runtime . * ; < nl > + import im . actor . runtime . Runtime ; < nl > import im . actor . runtime . actors . Cancellable ; < nl > import im . actor . runtime . function . Constructor ; < nl > import im . actor . runtime . function . Consumer ; < nl > + import im . actor . runtime . power . WakeLock ; < nl > < nl > public class SequenceActor extends ModuleActor { < nl > < nl > @ @ - 59 , 6 + 61 , 8 @ @ public class SequenceActor extends ModuleActor { < nl > < nl > private SequenceHandlerInt handler ; < nl > < nl > + private WakeLock currentWakeLock ; < nl > + < nl > public SequenceActor ( ModuleContext modules ) { < nl > super ( modules ) ; < nl > } < nl > @ @ - 71 , 6 + 75 , 8 @ @ public class SequenceActor extends ModuleActor { < nl > < nl > handler = context ( ) . getUpdatesModule ( ) . getUpdateHandler ( ) ; < nl > < nl > + currentWakeLock = im . actor . runtime . Runtime . makeWakeLock ( ) ; < nl > + < nl > self ( ) . send ( new Invalidate ( ) ) ; < nl > } < nl > < nl > @ @ - 127 , 6 + 133 , 7 @ @ public class SequenceActor extends ModuleActor { < nl > } < nl > < nl > Log . d ( TAG , " Handling update # " + seq ) ; < nl > + startWakeLock ( ) ; < nl > handler . onSeqUpdate ( type , body , users , groups ) . then ( new Consumer < SequenceHandlerActor . UpdateProcessed > ( ) { < nl > @ Override < nl > public void apply ( SequenceHandlerActor . UpdateProcessed updateProcessed ) { < nl > @ @ - 157 , 6 + 164 , 8 @ @ public class SequenceActor extends ModuleActor { < nl > } < nl > isValidated = false ; < nl > < nl > + startWakeLock ( ) ; < nl > + < nl > if ( seq < 0 ) { < nl > Log . d ( TAG , " Loading fresh state . . . " ) ; < nl > ArrayList < ApiUpdateOptimization > optimizations = new ArrayList < > ( ) ; < nl > @ @ - 173 , 6 + 182 , 9 @ @ public class SequenceActor extends ModuleActor { < nl > seq = response . getSeq ( ) ; < nl > state = response . getState ( ) ; < nl > persistState ( seq , state ) ; < nl > + < nl > + stopWakeLock ( ) ; < nl > + < nl > onBecomeValid ( response . getSeq ( ) , response . getState ( ) ) ; < nl > } < nl > < nl > @ @ - 237 , 6 + 249 , 7 @ @ public class SequenceActor extends ModuleActor { < nl > persistState ( seq , state ) ; < nl > if ( this . seq = = seq ) { < nl > Log . d ( TAG , " All updates applied { seq : " + seq + " } " ) ; < nl > + stopWakeLock ( ) ; < nl > } else { < nl > Log . d ( TAG , " Updates applied { seq : " + seq + " , finishedSeq : " + finishedSeq + " } " ) ; < nl > } < nl > @ @ - 314 , 6 + 327 , 27 @ @ public class SequenceActor extends ModuleActor { < nl > isTimerStarted = false ; < nl > } < nl > < nl > + < nl > + / / < nl > + / / Weak Locks < nl > + / / < nl > + < nl > + private void startWakeLock ( ) { < nl > + if ( currentWakeLock = = null ) { < nl > + currentWakeLock = Runtime . makeWakeLock ( ) ; < nl > + Log . w ( TAG , " Starting Wake Lock " ) ; < nl > + } < nl > + } < nl > + < nl > + private void stopWakeLock ( ) { < nl > + if ( currentWakeLock ! = null ) { < nl > + currentWakeLock . releaseLock ( ) ; < nl > + currentWakeLock = null ; < nl > + Log . w ( TAG , " Released Wake Lock " ) ; < nl > + } < nl > + } < nl > + < nl > + < nl > / / < nl > / / Messages < nl > / / < nl > diff - - git a / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / Runtime . java b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / Runtime . java < nl > index a9a88b1 . . 7e624bd 100644 < nl > - - - a / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / Runtime . java < nl > + + + b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / Runtime . java < nl > @ @ - 1 , 6 + 1 , 7 @ @ < nl > package im . actor . runtime ; < nl > < nl > import im . actor . runtime . actors . ThreadPriority ; < nl > + import im . actor . runtime . power . WakeLock ; < nl > import im . actor . runtime . threading . Dispatcher ; < nl > import im . actor . runtime . threading . AtomicIntegerCompat ; < nl > import im . actor . runtime . threading . AtomicLongCompat ; < nl > @ @ - 79 , 4 + 80 , 8 @ @ public class Runtime { < nl > public static void killApp ( ) { < nl > lifecycleRuntime . killApp ( ) ; < nl > } < nl > + < nl > + public static WakeLock makeWakeLock ( ) { < nl > + return lifecycleRuntime . makeWakeLock ( ) ; < nl > + } < nl > } < nl > \ No newline at end of file

TEST DIFF:
diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift 
 index 6dfb37a . . 1511ed9 100644 
 - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift 
 + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift 
 @ @ - 340 , 7 + 340 , 11 @ @ import PushKit 
 if ( type = = PKPushTypeVoIP ) { 
 let aps = payload . dictionaryPayload [ " aps " ] as ! [ NSString : AnyObject ] 
 if let callId = aps [ " callId " ] as ? String { 
 - Actor . checkCall ( jlong ( callId ) ! ) 
 + if let attempt = aps [ " attempt " ] as ? String { 
 + Actor . checkCall ( jlong ( callId ) ! , withAttempt : jint ( attempt ) ! ) 
 + } else { 
 + Actor . checkCall ( jlong ( callId ) ! , withAttempt : 0 ) 
 + } 
 } 
 } 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java 
 index c7a2b48 . . 176cefd 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java 
 @ @ - 1075 , 12 + 1075 , 13 @ @ public class Messenger { 
 / * * 
 * Checking incoming call from push notification 
 * 
 - * @ param callId Call Id 
 + * @ param callId Call Id 
 + * @ param attempt Call Attempt 
 * / 
 - @ ObjectiveCName ( " checkCall : " ) 
 - public void checkCall ( long callId ) { 
 + @ ObjectiveCName ( " checkCall : withAttempt : " ) 
 + public void checkCall ( long callId , int attempt ) { 
 if ( modules . getCallsModule ( ) ! = null ) { 
 - modules . getCallsModule ( ) . checkCall ( callId ) ; 
 + modules . getCallsModule ( ) . checkCall ( callId , attempt ) ; 
 } 
 } 
 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / api / updates / UpdateCallHandled . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / api / updates / UpdateCallHandled . java 
 index 9238e3a . . d0191e9 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / api / updates / UpdateCallHandled . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / api / updates / UpdateCallHandled . java 
 @ @ - 23 , 9 + 23 , 11 @ @ public class UpdateCallHandled extends Update { 
 } 
 
 private long callId ; 
 + private Integer attemptIndex ; 
 
 - public UpdateCallHandled ( long callId ) { 
 + public UpdateCallHandled ( long callId , @ Nullable Integer attemptIndex ) { 
 this . callId = callId ; 
 + this . attemptIndex = attemptIndex ; 
 } 
 
 public UpdateCallHandled ( ) { 
 @ @ - 36 , 20 + 38 , 30 @ @ public class UpdateCallHandled extends Update { 
 return this . callId ; 
 } 
 
 + @ Nullable 
 + public Integer getAttemptIndex ( ) { 
 + return this . attemptIndex ; 
 + } 
 + 
 @ Override 
 public void parse ( BserValues values ) throws IOException { 
 this . callId = values . getLong ( 1 ) ; 
 + this . attemptIndex = values . optInt ( 2 ) ; 
 } 
 
 @ Override 
 public void serialize ( BserWriter writer ) throws IOException { 
 writer . writeLong ( 1 , this . callId ) ; 
 + if ( this . attemptIndex ! = null ) { 
 + writer . writeInt ( 2 , this . attemptIndex ) ; 
 + } 
 } 
 
 @ Override 
 public String toString ( ) { 
 String res = " update CallHandled { " ; 
 res + = " callId = " + this . callId ; 
 + res + = " , attemptIndex = " + this . attemptIndex ; 
 res + = " } " ; 
 return res ; 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / api / updates / UpdateIncomingCall . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / api / updates / UpdateIncomingCall . java 
 index 4187e41 . . 2189a1b 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / api / updates / UpdateIncomingCall . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / api / updates / UpdateIncomingCall . java 
 @ @ - 23 , 9 + 23 , 11 @ @ public class UpdateIncomingCall extends Update { 
 } 
 
 private long callId ; 
 + private Integer attemptIndex ; 
 
 - public UpdateIncomingCall ( long callId ) { 
 + public UpdateIncomingCall ( long callId , @ Nullable Integer attemptIndex ) { 
 this . callId = callId ; 
 + this . attemptIndex = attemptIndex ; 
 } 
 
 public UpdateIncomingCall ( ) { 
 @ @ - 36 , 20 + 38 , 30 @ @ public class UpdateIncomingCall extends Update { 
 return this . callId ; 
 } 
 
 + @ Nullable 
 + public Integer getAttemptIndex ( ) { 
 + return this . attemptIndex ; 
 + } 
 + 
 @ Override 
 public void parse ( BserValues values ) throws IOException { 
 this . callId = values . getLong ( 1 ) ; 
 + this . attemptIndex = values . optInt ( 2 ) ; 
 } 
 
 @ Override 
 public void serialize ( BserWriter writer ) throws IOException { 
 writer . writeLong ( 1 , this . callId ) ; 
 + if ( this . attemptIndex ! = null ) { 
 + writer . writeInt ( 2 , this . attemptIndex ) ; 
 + } 
 } 
 
 @ Override 
 public String toString ( ) { 
 String res = " update IncomingCall { " ; 
 res + = " callId = " + this . callId ; 
 + res + = " , attemptIndex = " + this . attemptIndex ; 
 res + = " } " ; 
 return res ; 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java 
 index f50de67 . . 65be7e0 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java 
 @ @ - 34 , 6 + 34 , 7 @ @ public class CallManagerActor extends ModuleActor { 
 
 private CallsProvider provider ; 
 private HashSet < Long > handledCalls = new HashSet < > ( ) ; 
 + private HashMap < Long , Integer > handledCallAttempts = new HashMap < > ( ) ; 
 private HashSet < Long > answeredCalls = new HashSet < > ( ) ; 
 
 private Long currentCall ; 
 @ @ - 62 , 10 + 63 , 7 @ @ public class CallManagerActor extends ModuleActor { 
 / / Stopping current call as we started new done 
 / / 
 if ( currentCall ! = null ) { 
 - ActorRef dest = runningCalls . remove ( currentCall ) ; 
 - if ( dest ! = null ) { 
 - dest . send ( PoisonPill . INSTANCE ) ; 
 - } 
 + terminalCall ( currentCall ) ; 
 currentCall = null ; 
 } 
 
 @ @ - 87 , 15 + 85 , 13 @ @ public class CallManagerActor extends ModuleActor { 
 / / Stopping current call some are started during call establishing 
 / / 
 if ( currentCall ! = null ) { 
 - ActorRef dest = runningCalls . remove ( currentCall ) ; 
 - if ( dest ! = null ) { 
 - dest . send ( PoisonPill . INSTANCE ) ; 
 - } 
 + terminalCall ( currentCall ) ; 
 + currentCall = null ; 
 + 
 if ( isBeeping ) { 
 isBeeping = false ; 
 provider . stopOutgoingBeep ( ) ; 
 } 
 - currentCall = null ; 
 } 
 
 / / 
 @ @ - 104 , 7 + 100 , 7 @ @ public class CallManagerActor extends ModuleActor { 
 runningCalls . put ( callId , ref ) ; 
 
 / / 
 - / / Marking outgoing call as answered to avoid call rejects on call ending 
 + / / Marking outgoing call as answered 
 / / 
 answeredCalls . add ( callId ) ; 
 
 @ @ - 126 , 19 + 122 , 40 @ @ public class CallManagerActor extends ModuleActor { 
 / / Incoming call 
 / / 
 
 - private void onIncomingCall ( final long callId , WakeLock wakeLock ) { 
 + private void onIncomingCall ( final long callId , final int attempt , WakeLock wakeLock ) { 
 Log . d ( TAG , " onIncomingCall ( " + callId + " ) " ) ; 
 
 / / 
 / / Filter double updates about incoming call 
 / / 
 if ( handledCalls . contains ( callId ) ) { 
 + if ( handledCallAttempts . get ( callId ) > = attempt ) { 
 + if ( wakeLock ! = null ) { 
 + wakeLock . releaseLock ( ) ; 
 + } 
 + return ; 
 + } 
 + } 
 + 
 + / / 
 + / / Ignore any incoming call if we already have running call with such call id 
 + / / 
 + if ( runningCalls . containsKey ( callId ) ) { 
 if ( wakeLock ! = null ) { 
 wakeLock . releaseLock ( ) ; 
 } 
 return ; 
 } 
 + 
 + / / 
 + / / Marking handled calls as handled 
 + / / 
 handledCalls . add ( callId ) ; 
 + handledCallAttempts . put ( callId , attempt ) ; 
 + 
 + / / 
 + / / Creating wake lock if needed 
 + / / 
 if ( wakeLock = = null ) { 
 wakeLock = Runtime . makeWakeLock ( ) ; 
 } 
 @ @ - 187 , 10 + 204 , 7 @ @ public class CallManagerActor extends ModuleActor { 
 / / 
 / / Shutdown call actor 
 / / 
 - ActorRef ref = runningCalls . remove ( callId ) ; 
 - if ( ref ! = null ) { 
 - ref . send ( PoisonPill . INSTANCE ) ; 
 - } 
 + terminalCall ( callId ) ; 
 } 
 } 
 
 @ @ - 207 , 7 + 221 , 6 @ @ public class CallManagerActor extends ModuleActor { 
 
 / / 
 / / Sending answer message to actor . 
 - / / Hint : If we will send message to master call actor nothing will happen 
 / / 
 ActorRef ref = runningCalls . get ( callId ) ; 
 if ( ref ! = null ) { 
 @ @ - 316 , 6 + 329 , 20 @ @ public class CallManagerActor extends ModuleActor { 
 } 
 } 
 
 + private void terminalCall ( long callId ) { 
 + ActorRef dest = runningCalls . remove ( callId ) ; 
 + if ( dest ! = null ) { 
 + dest . send ( PoisonPill . INSTANCE ) ; 
 + } 
 + } 
 + 
 + private void sendToCall ( long callId , Object message ) { 
 + ActorRef dest = runningCalls . get ( callId ) ; 
 + if ( dest ! = null ) { 
 + dest . send ( message ) ; 
 + } 
 + } 
 + 
 
 / / 
 / / Messages 
 @ @ - 325 , 10 + 352 , 10 @ @ public class CallManagerActor extends ModuleActor { 
 public void onReceive ( Object message ) { 
 if ( message instanceof OnIncomingCall ) { 
 OnIncomingCall call = ( OnIncomingCall ) message ; 
 - onIncomingCall ( call . getCallId ( ) , null ) ; 
 + onIncomingCall ( call . getCallId ( ) , call . getAttempt ( ) , null ) ; 
 } else if ( message instanceof OnIncomingCallLocked ) { 
 OnIncomingCallLocked locked = ( OnIncomingCallLocked ) message ; 
 - onIncomingCall ( locked . getCallId ( ) , locked . getWakeLock ( ) ) ; 
 + onIncomingCall ( locked . getCallId ( ) , locked . getAttempt ( ) , locked . getWakeLock ( ) ) ; 
 } else if ( message instanceof OnIncomingCallHandled ) { 
 OnIncomingCallHandled incomingCallHandled = ( OnIncomingCallHandled ) message ; 
 onIncomingCallHandled ( incomingCallHandled . getCallId ( ) ) ; 
 @ @ - 364 , 24 + 391 , 32 @ @ public class CallManagerActor extends ModuleActor { 
 public static class OnIncomingCall { 
 
 private long callId ; 
 + private int attempt ; 
 
 - public OnIncomingCall ( long callId ) { 
 + public OnIncomingCall ( long callId , int attempt ) { 
 this . callId = callId ; 
 + this . attempt = attempt ; 
 } 
 
 public long getCallId ( ) { 
 return callId ; 
 } 
 + 
 + public int getAttempt ( ) { 
 + return attempt ; 
 + } 
 } 
 
 public static class OnIncomingCallLocked { 
 
 private long callId ; 
 + private int attempt ; 
 private WakeLock wakeLock ; 
 
 - public OnIncomingCallLocked ( long callId , WakeLock wakeLock ) { 
 + public OnIncomingCallLocked ( long callId , int attempt , WakeLock wakeLock ) { 
 this . callId = callId ; 
 this . wakeLock = wakeLock ; 
 + this . attempt = attempt ; 
 } 
 
 public long getCallId ( ) { 
 @ @ - 391 , 14 + 426 , 24 @ @ public class CallManagerActor extends ModuleActor { 
 public WakeLock getWakeLock ( ) { 
 return wakeLock ; 
 } 
 + 
 + public int getAttempt ( ) { 
 + return attempt ; 
 + } 
 } 
 
 public static class OnIncomingCallHandled { 
 
 private long callId ; 
 + private int attempt ; 
 
 - public OnIncomingCallHandled ( long callId ) { 
 + public OnIncomingCallHandled ( long callId , int attempt ) { 
 this . callId = callId ; 
 + this . attempt = attempt ; 
 + } 
 + 
 + public int getAttempt ( ) { 
 + return attempt ; 
 } 
 
 public long getCallId ( ) { 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsModule . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsModule . java 
 index 745d76f . . 8c3a81e 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsModule . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsModule . java 
 @ @ - 45 , 8 + 45 , 8 @ @ public class CallsModule extends AbsModule { 
 return callManager ; 
 } 
 
 - public void checkCall ( long callId ) { 
 - callManager . send ( new CallManagerActor . OnIncomingCallLocked ( callId , im . actor . runtime . Runtime . makeWakeLock ( ) ) ) ; 
 + public void checkCall ( long callId , int attempt ) { 
 + callManager . send ( new CallManagerActor . OnIncomingCallLocked ( callId , attempt , im . actor . runtime . Runtime . makeWakeLock ( ) ) ) ; 
 } 
 
 public void probablyEndCall ( ) { 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsProcessor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsProcessor . java 
 index f8d3c7c . . cd88f53 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsProcessor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsProcessor . java 
 @ @ - 17 , 17 + 17 , 21 @ @ public class CallsProcessor implements Processor { 
 if ( update instanceof UpdateIncomingCall ) { 
 UpdateIncomingCall updateIncomingCall = ( UpdateIncomingCall ) update ; 
 if ( context . getConfiguration ( ) . isVoiceCallsEnabled ( ) ) { 
 + int index = updateIncomingCall . getAttemptIndex ( ) ! = null ? updateIncomingCall . getAttemptIndex ( ) : 0 ; 
 context . getCallsModule ( ) . getCallManager ( ) . send ( 
 new CallManagerActor . OnIncomingCall ( 
 - updateIncomingCall . getCallId ( ) ) ) ; 
 + updateIncomingCall . getCallId ( ) , 
 + index ) ) ; 
 } 
 return true ; 
 } else if ( update instanceof UpdateCallHandled ) { 
 UpdateCallHandled updateCallHandled = ( UpdateCallHandled ) update ; 
 if ( context . getConfiguration ( ) . isVoiceCallsEnabled ( ) ) { 
 + int index = updateCallHandled . getAttemptIndex ( ) ! = null ? updateCallHandled . getAttemptIndex ( ) : 0 ; 
 context . getCallsModule ( ) . getCallManager ( ) . send ( 
 new CallManagerActor . OnIncomingCallHandled ( 
 - updateCallHandled . getCallId ( ) ) ) ; 
 + updateCallHandled . getCallId ( ) , 
 + index ) ) ; 
 } 
 return true ; 
 }

NEAREST DIFF:
diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift 
 index 58a48b5 . . 7b136d7 100644 
 - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift 
 + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift 
 @ @ - 342 , 7 + 342 , 6 @ @ import PushKit 
 @ objc public func pushRegistry ( registry : PKPushRegistry ! , didUpdatePushCredentials credentials : PKPushCredentials ! , forType type : String ! ) { 
 if ( type = = PKPushTypeVoIP ) { 
 let tokenString = " \ ( credentials . token ) " . replace ( " " , dest : " " ) . replace ( " < " , dest : " " ) . replace ( " > " , dest : " " ) 
 - print ( " PushKit : \ ( tokenString ) " ) 
 pushRegisterKitToken ( tokenString ) 
 } 
 } 
 @ @ - 355 , 7 + 354 , 10 @ @ import PushKit 
 
 @ objc public func pushRegistry ( registry : PKPushRegistry ! , didReceiveIncomingPushWithPayload payload : PKPushPayload ! , forType type : String ! ) { 
 if ( type = = PKPushTypeVoIP ) { 
 - print ( " PushKit Payload : \ ( payload ) " ) 
 + let aps = payload . dictionaryPayload [ " aps " ] as ! [ NSString : AnyObject ] 
 + if let callId = aps [ " callId " ] as ? String { 
 + Actor . checkCall ( jlong ( callId ) ! ) 
 + } 
 } 
 } 
 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java 
 index 53a7cd1 . . d868238 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / Messenger . java 
 @ @ - 1072 , 6 + 1072 , 18 @ @ public class Messenger { 
 } 
 } 
 
 + / * * 
 + * Checking incoming call from push notification 
 + * 
 + * @ param callId Call Id 
 + * / 
 + @ ObjectiveCName ( " checkCall : " ) 
 + public void checkCall ( long callId ) { 
 + if ( modules . getCallsModule ( ) ! = null ) { 
 + modules . getCallsModule ( ) . checkCall ( callId ) ; 
 + } 
 + } 
 + 
 / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / 
 / / Peer operations 
 / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / / 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java 
 index 59a2d11 . . f544d1d 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java 
 @ @ - 14 , 12 + 14 , 14 @ @ import im . actor . core . viewmodel . CallVM ; 
 import im . actor . core . viewmodel . CommandCallback ; 
 import im . actor . runtime . actors . messages . PoisonPill ; 
 import im . actor . runtime . function . Consumer ; 
 + import im . actor . runtime . power . WakeLock ; 
 
 import static im . actor . core . modules . internal . messages . entity . EntityConverter . convert ; 
 
 public class CallActor extends AbsCallActor { 
 
 private final boolean isMaster ; 
 + private final WakeLock wakeLock ; 
 private long callId ; 
 private Peer peer ; 
 private CallVM callVM ; 
 @ @ - 29 , 16 + 31 , 18 @ @ public class CallActor extends AbsCallActor { 
 private boolean isAnswered ; 
 private boolean isRejected ; 
 
 - public CallActor ( long callId , ModuleContext context ) { 
 + public CallActor ( long callId , WakeLock wakeLock , ModuleContext context ) { 
 super ( context ) ; 
 + this . wakeLock = wakeLock ; 
 this . isMaster = false ; 
 this . callId = callId ; 
 this . isAnswered = false ; 
 this . isActive = false ; 
 } 
 
 - public CallActor ( Peer peer , CommandCallback < Long > callback , ModuleContext context ) { 
 + public CallActor ( Peer peer , CommandCallback < Long > callback , WakeLock wakeLock , ModuleContext context ) { 
 super ( context ) ; 
 + this . wakeLock = wakeLock ; 
 this . isMaster = true ; 
 this . callback = callback ; 
 this . peer = peer ; 
 @ @ - 154 , 6 + 158 , 7 @ @ public class CallActor extends AbsCallActor { 
 if ( callId ! = 0 ) { 
 callManager . send ( new CallManagerActor . OnCallEnded ( callId ) , self ( ) ) ; 
 } 
 + wakeLock . releaseLock ( ) ; 
 } 
 
 / / 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java 
 index 525b26a . . 0194b2a 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java 
 @ @ - 11 , 11 + 11 , 13 @ @ import im . actor . core . providers . CallsProvider ; 
 import im . actor . core . util . RandomUtils ; 
 import im . actor . core . viewmodel . CommandCallback ; 
 import im . actor . runtime . * ; 
 + import im . actor . runtime . Runtime ; 
 import im . actor . runtime . actors . Actor ; 
 import im . actor . runtime . actors . ActorCreator ; 
 import im . actor . runtime . actors . ActorRef ; 
 import im . actor . runtime . actors . messages . PoisonPill ; 
 import im . actor . runtime . function . Constructor ; 
 + import im . actor . runtime . power . WakeLock ; 
 
 public class CallManagerActor extends ModuleActor { 
 
 @ @ - 70 , 10 + 72 , 11 @ @ public class CallManagerActor extends ModuleActor { 
 / / 
 / / Spawning new Actor for call 
 / / 
 + final WakeLock wakeLock = Runtime . makeWakeLock ( ) ; 
 system ( ) . actorOf ( " actor / master / " + RandomUtils . nextRid ( ) , new ActorCreator ( ) { 
 @ Override 
 public Actor create ( ) { 
 - return new CallActor ( peer , callback , context ( ) ) ; 
 + return new CallActor ( peer , callback , wakeLock , context ( ) ) ; 
 } 
 } ) ; 
 } 
 @ @ - 118 , 24 + 121 , 31 @ @ public class CallManagerActor extends ModuleActor { 
 / / Incoming call 
 / / 
 
 - private void onIncomingCall ( final long callId ) { 
 + private void onIncomingCall ( final long callId , WakeLock wakeLock ) { 
 Log . d ( TAG , " onIncomingCall ( " + callId + " ) " ) ; 
 
 / / 
 / / Filter double updates about incoming call 
 / / 
 if ( handledCalls . contains ( callId ) ) { 
 + if ( wakeLock ! = null ) { 
 + wakeLock . releaseLock ( ) ; 
 + } 
 return ; 
 } 
 handledCalls . add ( callId ) ; 
 + if ( wakeLock = = null ) { 
 + wakeLock = Runtime . makeWakeLock ( ) ; 
 + } 
 
 / / 
 / / Spawning new Actor for call 
 / / 
 - system ( ) . actorOf ( " actor / slave / " + RandomUtils . nextRid ( ) , new ActorCreator ( ) { 
 + final WakeLock finalWakeLock = wakeLock ; 
 + system ( ) . actorOf ( " actor / call " + RandomUtils . nextRid ( ) , new ActorCreator ( ) { 
 @ Override 
 public Actor create ( ) { 
 - return new CallActor ( callId , context ( ) ) ; 
 + return new CallActor ( callId , finalWakeLock , context ( ) ) ; 
 } 
 } ) ; 
 } 
 @ @ - 306 , 7 + 316 , 10 @ @ public class CallManagerActor extends ModuleActor { 
 public void onReceive ( Object message ) { 
 if ( message instanceof OnIncomingCall ) { 
 OnIncomingCall call = ( OnIncomingCall ) message ; 
 - onIncomingCall ( call . getCallId ( ) ) ; 
 + onIncomingCall ( call . getCallId ( ) , null ) ; 
 + } else if ( message instanceof OnIncomingCallLocked ) { 
 + OnIncomingCallLocked locked = ( OnIncomingCallLocked ) message ; 
 + onIncomingCall ( locked . getCallId ( ) , locked . getWakeLock ( ) ) ; 
 } else if ( message instanceof OnIncomingCallHandled ) { 
 OnIncomingCallHandled incomingCallHandled = ( OnIncomingCallHandled ) message ; 
 onIncomingCallHandled ( incomingCallHandled . getCallId ( ) ) ; 
 @ @ - 352 , 6 + 365 , 25 @ @ public class CallManagerActor extends ModuleActor { 
 } 
 } 
 
 + public static class OnIncomingCallLocked { 
 + 
 + private long callId ; 
 + private WakeLock wakeLock ; 
 + 
 + public OnIncomingCallLocked ( long callId , WakeLock wakeLock ) { 
 + this . callId = callId ; 
 + this . wakeLock = wakeLock ; 
 + } 
 + 
 + public long getCallId ( ) { 
 + return callId ; 
 + } 
 + 
 + public WakeLock getWakeLock ( ) { 
 + return wakeLock ; 
 + } 
 + } 
 + 
 public static class OnIncomingCallHandled { 
 
 private long callId ; 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsModule . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsModule . java 
 index fb0d93d . . 745d76f 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsModule . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallsModule . java 
 @ @ - 7 , 6 + 7 , 7 @ @ import im . actor . core . providers . CallsProvider ; 
 import im . actor . core . modules . AbsModule ; 
 import im . actor . core . modules . ModuleContext ; 
 import im . actor . core . viewmodel . Command ; 
 + import im . actor . runtime . * ; 
 import im . actor . runtime . actors . ActorRef ; 
 
 import static im . actor . runtime . actors . ActorSystem . system ; 
 @ @ - 44 , 6 + 45 , 10 @ @ public class CallsModule extends AbsModule { 
 return callManager ; 
 } 
 
 + public void checkCall ( long callId ) { 
 + callManager . send ( new CallManagerActor . OnIncomingCallLocked ( callId , im . actor . runtime . Runtime . makeWakeLock ( ) ) ) ; 
 + } 
 + 
 public void probablyEndCall ( ) { 
 callManager . send ( new CallManagerActor . ProbablyEndCall ( ) ) ; 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / SenderActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / SenderActor . java 
 index 4f9f421 . . 94e71f1 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / SenderActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / SenderActor . java 
 @ @ - 9 , 6 + 9 , 7 @ @ import org . jetbrains . annotations . Nullable ; 
 
 import java . io . IOException ; 
 import java . util . ArrayList ; 
 + import java . util . HashMap ; 
 import java . util . List ; 
 
 import im . actor . core . api . ApiDocumentExVoice ; 
 @ @ - 59 , 8 + 60 , 10 @ @ import im . actor . core . util . ModuleActor ; 
 import im . actor . core . util . RandomUtils ; 
 import im . actor . core . network . RpcCallback ; 
 import im . actor . core . network . RpcException ; 
 - import im . actor . runtime . Storage ; 
 + import im . actor . runtime . * ; 
 + import im . actor . runtime . Runtime ; 
 import im . actor . runtime . actors . ask . AskCallback ; 
 + import im . actor . runtime . power . WakeLock ; 
 
 public class SenderActor extends ModuleActor { 
 
 @ @ - 69 , 6 + 72 , 7 @ @ public class SenderActor extends ModuleActor { 
 private PendingMessagesStorage pendingMessages ; 
 
 private long lastSendDate = 0 ; 
 + private HashMap < Long , WakeLock > fileUplaodingWakeLocks = new HashMap < > ( ) ; 
 
 public SenderActor ( ModuleContext context ) { 
 super ( context ) ; 
 @ @ - 321 , 6 + 325 , 7 @ @ public class SenderActor extends ModuleActor { 
 } 
 
 private void performUploadFile ( long rid , String descriptor , String fileName ) { 
 + fileUplaodingWakeLocks . put ( rid , Runtime . makeWakeLock ( ) ) ; 
 context ( ) . getFilesModule ( ) . requestUpload ( rid , descriptor , fileName , self ( ) ) ; 
 } 
 
 @ @ - 354 , 8 + 359 , 8 @ @ public class SenderActor extends ModuleActor { 
 
 pendingMessages . getPendingMessages ( ) . add ( new PendingMessage ( msg . getPeer ( ) , msg . getRid ( ) , nContent ) ) ; 
 context ( ) . getMessagesModule ( ) . getConversationActor ( msg . getPeer ( ) ) . send ( new ConversationActor . MessageContentUpdated ( msg . getRid ( ) , nContent ) ) ; 
 - 
 performSendContent ( msg . getPeer ( ) , rid , nContent ) ; 
 + fileUplaodingWakeLocks . remove ( rid ) . releaseLock ( ) ; 
 } 
 
 private void onFileUploadError ( long rid ) { 
 @ @ - 365 , 11 + 370 , 13 @ @ public class SenderActor extends ModuleActor { 
 } 
 
 self ( ) . send ( new MessageError ( msg . getPeer ( ) , msg . getRid ( ) ) ) ; 
 + fileUplaodingWakeLocks . remove ( rid ) . releaseLock ( ) ; 
 } 
 
 / / Sending content 
 
 private void performSendContent ( final Peer peer , final long rid , AbsContent content ) { 
 + WakeLock wakeLock = im . actor . runtime . Runtime . makeWakeLock ( ) ; 
 
 ApiMessage message ; 
 if ( content instanceof TextContent ) { 
 @ @ - 420 , 10 + 427 , 10 @ @ public class SenderActor extends ModuleActor { 
 return ; 
 } 
 
 - performSendApiContent ( peer , rid , message ) ; 
 + performSendApiContent ( peer , rid , message , wakeLock ) ; 
 } 
 
 - private void performSendApiContent ( final Peer peer , final long rid , ApiMessage message ) { 
 + private void performSendApiContent ( final Peer peer , final long rid , ApiMessage message , final WakeLock wakeLock ) { 
 final ApiOutPeer outPeer = buidOutPeer ( peer ) ; 
 final ApiPeer apiPeer = buildApiPeer ( peer ) ; 
 if ( outPeer = = null | | apiPeer = = null ) { 
 @ @ - 438 , 11 + 445 , 13 @ @ public class SenderActor extends ModuleActor { 
 response . getState ( ) , 
 UpdateMessageSent . HEADER , 
 new UpdateMessageSent ( apiPeer , rid , response . getDate ( ) ) . toByteArray ( ) ) ) ; 
 + wakeLock . releaseLock ( ) ; 
 } 
 
 @ Override 
 public void onError ( RpcException e ) { 
 self ( ) . send ( new MessageError ( peer , rid ) ) ; 
 + wakeLock . releaseLock ( ) ; 
 } 
 } ) ; 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / SequenceActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / SequenceActor . java 
 index ef9026d . . 3cf9d18 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / SequenceActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / SequenceActor . java 
 @ @ - 22 , 10 + 22 , 12 @ @ import im . actor . core . modules . updates . internal . ExecuteAfter ; 
 import im . actor . core . network . RpcCallback ; 
 import im . actor . core . network . RpcException ; 
 import im . actor . core . util . ModuleActor ; 
 - import im . actor . runtime . Log ; 
 + import im . actor . runtime . * ; 
 + import im . actor . runtime . Runtime ; 
 import im . actor . runtime . actors . Cancellable ; 
 import im . actor . runtime . function . Constructor ; 
 import im . actor . runtime . function . Consumer ; 
 + import im . actor . runtime . power . WakeLock ; 
 
 public class SequenceActor extends ModuleActor { 
 
 @ @ - 59 , 6 + 61 , 8 @ @ public class SequenceActor extends ModuleActor { 
 
 private SequenceHandlerInt handler ; 
 
 + private WakeLock currentWakeLock ; 
 + 
 public SequenceActor ( ModuleContext modules ) { 
 super ( modules ) ; 
 } 
 @ @ - 71 , 6 + 75 , 8 @ @ public class SequenceActor extends ModuleActor { 
 
 handler = context ( ) . getUpdatesModule ( ) . getUpdateHandler ( ) ; 
 
 + currentWakeLock = im . actor . runtime . Runtime . makeWakeLock ( ) ; 
 + 
 self ( ) . send ( new Invalidate ( ) ) ; 
 } 
 
 @ @ - 127 , 6 + 133 , 7 @ @ public class SequenceActor extends ModuleActor { 
 } 
 
 Log . d ( TAG , " Handling update # " + seq ) ; 
 + startWakeLock ( ) ; 
 handler . onSeqUpdate ( type , body , users , groups ) . then ( new Consumer < SequenceHandlerActor . UpdateProcessed > ( ) { 
 @ Override 
 public void apply ( SequenceHandlerActor . UpdateProcessed updateProcessed ) { 
 @ @ - 157 , 6 + 164 , 8 @ @ public class SequenceActor extends ModuleActor { 
 } 
 isValidated = false ; 
 
 + startWakeLock ( ) ; 
 + 
 if ( seq < 0 ) { 
 Log . d ( TAG , " Loading fresh state . . . " ) ; 
 ArrayList < ApiUpdateOptimization > optimizations = new ArrayList < > ( ) ; 
 @ @ - 173 , 6 + 182 , 9 @ @ public class SequenceActor extends ModuleActor { 
 seq = response . getSeq ( ) ; 
 state = response . getState ( ) ; 
 persistState ( seq , state ) ; 
 + 
 + stopWakeLock ( ) ; 
 + 
 onBecomeValid ( response . getSeq ( ) , response . getState ( ) ) ; 
 } 
 
 @ @ - 237 , 6 + 249 , 7 @ @ public class SequenceActor extends ModuleActor { 
 persistState ( seq , state ) ; 
 if ( this . seq = = seq ) { 
 Log . d ( TAG , " All updates applied { seq : " + seq + " } " ) ; 
 + stopWakeLock ( ) ; 
 } else { 
 Log . d ( TAG , " Updates applied { seq : " + seq + " , finishedSeq : " + finishedSeq + " } " ) ; 
 } 
 @ @ - 314 , 6 + 327 , 27 @ @ public class SequenceActor extends ModuleActor { 
 isTimerStarted = false ; 
 } 
 
 + 
 + / / 
 + / / Weak Locks 
 + / / 
 + 
 + private void startWakeLock ( ) { 
 + if ( currentWakeLock = = null ) { 
 + currentWakeLock = Runtime . makeWakeLock ( ) ; 
 + Log . w ( TAG , " Starting Wake Lock " ) ; 
 + } 
 + } 
 + 
 + private void stopWakeLock ( ) { 
 + if ( currentWakeLock ! = null ) { 
 + currentWakeLock . releaseLock ( ) ; 
 + currentWakeLock = null ; 
 + Log . w ( TAG , " Released Wake Lock " ) ; 
 + } 
 + } 
 + 
 + 
 / / 
 / / Messages 
 / / 
 diff - - git a / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / Runtime . java b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / Runtime . java 
 index a9a88b1 . . 7e624bd 100644 
 - - - a / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / Runtime . java 
 + + + b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / Runtime . java 
 @ @ - 1 , 6 + 1 , 7 @ @ 
 package im . actor . runtime ; 
 
 import im . actor . runtime . actors . ThreadPriority ; 
 + import im . actor . runtime . power . WakeLock ; 
 import im . actor . runtime . threading . Dispatcher ; 
 import im . actor . runtime . threading . AtomicIntegerCompat ; 
 import im . actor . runtime . threading . AtomicLongCompat ; 
 @ @ - 79 , 4 + 80 , 8 @ @ public class Runtime { 
 public static void killApp ( ) { 
 lifecycleRuntime . killApp ( ) ; 
 } 
 + 
 + public static WakeLock makeWakeLock ( ) { 
 + return lifecycleRuntime . makeWakeLock ( ) ; 
 + } 
 } 
 \ No newline at end of file
