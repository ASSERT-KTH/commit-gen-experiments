BLEU SCORE: 0.08541226358487464

TEST MSG: wip ( core ) : Missing files
GENERATED MSG: fix ( core ) : Fixing compilation error , implemented missing method in bser , implemented typing cancelling

TEST DIFF (one line): diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / AbsCallActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / AbsCallActor . java < nl > index ed05fe8 . . 120a018 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / AbsCallActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / AbsCallActor . java < nl > @ @ - 9 , 6 + 9 , 7 @ @ import im . actor . core . modules . calls . bus . CallBusCallback ; < nl > import im . actor . core . modules . calls . bus . CallBusInt ; < nl > import im . actor . core . modules . calls . peers . PeerCallInt ; < nl > import im . actor . core . modules . calls . peers . PeerSettings ; < nl > + import im . actor . core . modules . calls . peers . PeerState ; < nl > import im . actor . core . modules . eventbus . EventBusActor ; < nl > import im . actor . runtime . actors . Actor ; < nl > import im . actor . runtime . actors . ActorCreator ; < nl > @ @ - 62 , 6 + 63 , 11 @ @ public abstract class AbsCallActor extends EventBusActor implements CallBusCallb < nl > < nl > } < nl > < nl > + @ Override < nl > + public void onPeerStateChanged ( int uid , long deviceId , PeerState state ) { < nl > + < nl > + } < nl > + < nl > / / < nl > / / Wrapper < nl > / / < nl > @ @ - 97 , 5 + 103 , 15 @ @ public abstract class AbsCallActor extends EventBusActor implements CallBusCallb < nl > } < nl > } ) ; < nl > } < nl > + < nl > + @ Override < nl > + public void onPeerStateChanged ( final int uid , final long deviceId , final PeerState state ) { < nl > + self ( ) . send ( new Runnable ( ) { < nl > + @ Override < nl > + public void run ( ) { < nl > + AbsCallActor . this . onPeerStateChanged ( uid , deviceId , state ) ; < nl > + } < nl > + } ) ; < nl > + } < nl > } < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java < nl > index e3ac82b . . 5929861 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java < nl > @ @ - 10 , 9 + 10 , 11 @ @ import im . actor . core . api . rpc . RequestGetCallInfo ; < nl > import im . actor . core . api . rpc . ResponseGetCallInfo ; < nl > import im . actor . core . entity . Peer ; < nl > import im . actor . core . modules . ModuleContext ; < nl > + import im . actor . core . modules . calls . peers . PeerState ; < nl > import im . actor . core . viewmodel . CallMember ; < nl > import im . actor . core . viewmodel . CallState ; < nl > import im . actor . core . viewmodel . CallVM ; < nl > + import im . actor . runtime . Log ; < nl > import im . actor . runtime . actors . messages . PoisonPill ; < nl > import im . actor . runtime . function . Consumer ; < nl > < nl > @ @ - 40 , 6 + 42 , 7 @ @ public class CallActor extends AbsCallActor { < nl > < nl > @ Override < nl > public void callPreStart ( ) { < nl > + Log . d ( TAG , " callPreStart " ) ; < nl > api ( new RequestGetCallInfo ( callId ) ) . then ( new Consumer < ResponseGetCallInfo > ( ) { < nl > @ Override < nl > public void apply ( final ResponseGetCallInfo responseGetCallInfo ) { < nl > @ @ - 57 , 9 + 60 , 9 @ @ public class CallActor extends AbsCallActor { < nl > < nl > @ Override < nl > public void onBusStarted ( String busId ) { < nl > - super . onBusStarted ( busId ) ; < nl > + Log . d ( TAG , " onBusStarted " ) ; < nl > < nl > - callManager . send ( new CallManagerActor . OnIncomingCall ( callId ) ) ; < nl > + callManager . send ( new CallManagerActor . IncomingCallReady ( callId ) , self ( ) ) ; < nl > } < nl > < nl > @ Override < nl > @ @ - 69 , 6 + 72 , 12 @ @ public class CallActor extends AbsCallActor { < nl > / / < nl > } < nl > < nl > + @ Override < nl > + public void onPeerStateChanged ( int uid , long deviceId , PeerState state ) { < nl > + Log . d ( TAG , " onPeerStateChanged " + deviceId + " ( " + state + " ) " ) ; < nl > + < nl > + } < nl > + < nl > public void onAnswerCall ( ) { < nl > if ( ! isAnswered & & ! isRejected ) { < nl > isAnswered = true ; < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / bus / CallBusActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / bus / CallBusActor . java < nl > index 868ea55 . . a03827c 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / bus / CallBusActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / bus / CallBusActor . java < nl > @ @ - 7 , 11 + 7 , 13 @ @ import java . util . HashMap ; < nl > < nl > import im . actor . core . api . ApiAdvertiseSelf ; < nl > import im . actor . core . api . ApiAnswer ; < nl > + import im . actor . core . api . ApiAnswerCall ; < nl > import im . actor . core . api . ApiCandidate ; < nl > import im . actor . core . api . ApiMembersChanged ; < nl > import im . actor . core . api . ApiNeedOffer ; < nl > import im . actor . core . api . ApiOffer ; < nl > import im . actor . core . api . ApiOnAnswer ; < nl > + import im . actor . core . api . ApiRejectCall ; < nl > import im . actor . core . api . ApiSwitchMaster ; < nl > import im . actor . core . api . ApiWebRTCSignaling ; < nl > import im . actor . core . modules . ModuleContext ; < nl > @ @ - 19 , 6 + 21 , 7 @ @ import im . actor . core . modules . calls . peers . PeerCallActor ; < nl > import im . actor . core . modules . calls . peers . PeerCallCallback ; < nl > import im . actor . core . modules . calls . peers . PeerCallInt ; < nl > import im . actor . core . modules . calls . peers . PeerSettings ; < nl > + import im . actor . core . modules . calls . peers . PeerState ; < nl > import im . actor . core . modules . eventbus . EventBusActor ; < nl > import im . actor . runtime . Log ; < nl > import im . actor . runtime . actors . Actor ; < nl > @ @ - 39 , 7 + 42 , 7 @ @ public class CallBusActor extends EventBusActor { < nl > private long masterDeviceId ; < nl > private PeerCallInt peerCall ; < nl > < nl > - public CallBusActor ( CallBusCallback callBusCallback , PeerSettings selfSettings , ModuleContext context ) { < nl > + public CallBusActor ( final CallBusCallback callBusCallback , PeerSettings selfSettings , ModuleContext context ) { < nl > super ( context ) ; < nl > < nl > this . selfSettings = selfSettings ; < nl > @ @ - 61 , 18 + 64 , 8 @ @ public class CallBusActor extends EventBusActor { < nl > } < nl > < nl > @ Override < nl > - public void onHandshakeSuccessful ( long deviceId ) { < nl > - < nl > - } < nl > - < nl > - @ Override < nl > - public void onConnectionStarted ( long deviceId ) { < nl > - < nl > - } < nl > - < nl > - @ Override < nl > - public void onConnectionEstablished ( long deviceId ) { < nl > - < nl > + public void onPeerStateChanged ( long deviceId , PeerState state ) { < nl > + callBusCallback . onPeerStateChanged ( deviceIds . get ( deviceId ) , deviceId , state ) ; < nl > } < nl > < nl > @ Override < nl > @ @ - 110 , 7 + 103 , 11 @ @ public class CallBusActor extends EventBusActor { < nl > } < nl > < nl > public void onAnswerCall ( ) { < nl > + sendSignal ( masterUid , masterDeviceId , new ApiAnswerCall ( ) ) ; < nl > + } < nl > < nl > + public void onRejectCall ( ) { < nl > + sendSignal ( masterUid , masterDeviceId , new ApiRejectCall ( ) ) ; < nl > } < nl > < nl > @ Override < nl > @ @ - 179 , 8 + 176 , 7 @ @ public class CallBusActor extends EventBusActor { < nl > } < nl > < nl > public final void sendSignal ( long deviceId , ApiWebRTCSignaling signal ) { < nl > - int uid = deviceIds . get ( deviceId ) ; < nl > - sendSignal ( uid , deviceId , signal ) ; < nl > + sendSignal ( deviceIds . get ( deviceId ) , deviceId , signal ) ; < nl > } < nl > < nl > public final void sendSignal ( int uid , long deviceId , ApiWebRTCSignaling signal ) { < nl > @ @ - 204 , 8 + 200 , 15 @ @ public class CallBusActor extends EventBusActor { < nl > } else if ( message instanceof AnswerCall ) { < nl > if ( ! isMasterReady ) { < nl > stash ( STASH ) ; < nl > + return ; < nl > } < nl > onAnswerCall ( ) ; < nl > + } else if ( message instanceof RejectCall ) { < nl > + if ( ! isMasterReady ) { < nl > + stash ( STASH ) ; < nl > + return ; < nl > + } < nl > + onRejectCall ( ) ; < nl > } else { < nl > super . onReceive ( message ) ; < nl > } < nl > @ @ - 300 , 31 + 303 , 11 @ @ public class CallBusActor extends EventBusActor { < nl > } < nl > < nl > @ Override < nl > - public void onHandshakeSuccessful ( final long deviceId ) { < nl > - self ( ) . send ( new Runnable ( ) { < nl > - @ Override < nl > - public void run ( ) { < nl > - callCallback . onHandshakeSuccessful ( deviceId ) ; < nl > - } < nl > - } ) ; < nl > - } < nl > - < nl > - @ Override < nl > - public void onConnectionStarted ( final long deviceId ) { < nl > - self ( ) . send ( new Runnable ( ) { < nl > - @ Override < nl > - public void run ( ) { < nl > - callCallback . onConnectionStarted ( deviceId ) ; < nl > - } < nl > - } ) ; < nl > - } < nl > - < nl > - @ Override < nl > - public void onConnectionEstablished ( final long deviceId ) { < nl > + public void onPeerStateChanged ( final long deviceId , final PeerState state ) { < nl > self ( ) . send ( new Runnable ( ) { < nl > @ Override < nl > public void run ( ) { < nl > - callCallback . onConnectionEstablished ( deviceId ) ; < nl > + callCallback . onPeerStateChanged ( deviceId , state ) ; < nl > } < nl > } ) ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / bus / CallBusCallback . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / bus / CallBusCallback . java < nl > index 258f807 . . d523f9c 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / bus / CallBusCallback . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / bus / CallBusCallback . java < nl > @ @ - 4 , 6 + 4 , 7 @ @ import java . util . List ; < nl > < nl > import im . actor . core . api . ApiCallMember ; < nl > import im . actor . core . modules . calls . peers . PeerCallInt ; < nl > + import im . actor . core . modules . calls . peers . PeerState ; < nl > < nl > public interface CallBusCallback { < nl > < nl > @ @ - 12 , 4 + 13 , 6 @ @ public interface CallBusCallback { < nl > void onBusStarted ( String busId ) ; < nl > < nl > void onMembersChanged ( List < ApiCallMember > members ) ; < nl > + < nl > + void onPeerStateChanged ( int uid , long deviceId , PeerState state ) ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallActor . java < nl > index 54cc145 . . bd807fb 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallActor . java < nl > @ @ - 192 , 18 + 192 , 8 @ @ public class PeerCallActor extends ModuleActor { < nl > } < nl > < nl > @ Override < nl > - public void onHandshakeSuccessful ( long deviceId ) { < nl > - callback . onHandshakeSuccessful ( deviceId ) ; < nl > - } < nl > - < nl > - @ Override < nl > - public void onConnectionStarted ( long deviceId ) { < nl > - callback . onConnectionStarted ( deviceId ) ; < nl > - } < nl > - < nl > - @ Override < nl > - public void onConnectionEstablished ( long deviceId ) { < nl > - callback . onConnectionEstablished ( deviceId ) ; < nl > + public void onPeerStateChanged ( long deviceId , PeerState state ) { < nl > + callback . onPeerStateChanged ( deviceId , state ) ; < nl > } < nl > < nl > @ Override < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallCallback . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallCallback . java < nl > index bf25d3a . . b1f9306 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallCallback . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallCallback . java < nl > @ @ - 10 , 11 + 10 , 7 @ @ public interface PeerCallCallback { < nl > < nl > void onCandidate ( long deviceId , int mdpIndex , String id , String sdp ) ; < nl > < nl > - void onHandshakeSuccessful ( long deviceId ) ; < nl > - < nl > - void onConnectionStarted ( long deviceId ) ; < nl > - < nl > - void onConnectionEstablished ( long deviceId ) ; < nl > + void onPeerStateChanged ( long deviceId , PeerState state ) ; < nl > < nl > void onStreamAdded ( long deviceId , WebRTCMediaStream stream ) ; < nl > < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeActor . java < nl > index 0aaf20d . . 857729a 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeActor . java < nl > @ @ - 24 , 6 + 24 , 7 @ @ public class PeerNodeActor extends ModuleActor implements PeerConnectionCallback < nl > private final PeerSettings ownSettings ; < nl > private final ArrayList < WebRTCMediaStream > theirMediaStreams = new ArrayList < > ( ) ; < nl > < nl > + private PeerState state = PeerState . PENDING ; < nl > private PeerConnectionInt peerConnection ; < nl > private PeerSettings theirSettings ; < nl > private WebRTCMediaStream ownMediaStream ; < nl > @ @ - 48 , 6 + 49 , 7 @ @ public class PeerNodeActor extends ModuleActor implements PeerConnectionCallback < nl > / / Starting up peer nodes < nl > / / < nl > / / Stages : < nl > + / / 0 . Notify about new peer node < nl > / / 1 . Waiting for advertise of a node < nl > / / 2 . If both peers supports pre connection , create new connection < nl > / / 3 . Enabling Own and Their peers < nl > @ @ - 55 , 6 + 57 , 11 @ @ public class PeerNodeActor extends ModuleActor implements PeerConnectionCallback < nl > / / 5 . Creation of peer connection < nl > / / < nl > < nl > + @ Override < nl > + public void preStart ( ) { < nl > + callback . onPeerStateChanged ( deviceId , state ) ; < nl > + } < nl > + < nl > public void onAdvertised ( PeerSettings settings ) { < nl > if ( this . theirSettings = = null ) { < nl > this . theirSettings = settings ; < nl > @ @ - 96 , 7 + 103 , 8 @ @ public class PeerNodeActor extends ModuleActor implements PeerConnectionCallback < nl > < nl > if ( ( isOwnEnabled & & isTheirEnabled ) | | < nl > ( theirSettings . isPreConnectionEnabled ( ) & & ownSettings . isPreConnectionEnabled ( ) ) ) { < nl > - < nl > + state = PeerState . CONNECTING ; < nl > + callback . onPeerStateChanged ( deviceId , state ) ; < nl > peerConnection = new PeerConnectionInt ( < nl > ownSettings , theirSettings , < nl > ownMediaStream , this , context ( ) , self ( ) , " connection " ) ; < nl > @ @ - 120 , 7 + 128 , 9 @ @ public class PeerNodeActor extends ModuleActor implements PeerConnectionCallback < nl > if ( isEnabled & & isConnected & & ! isStarted ) { < nl > isStarted = true ; < nl > < nl > - callback . onConnectionStarted ( deviceId ) ; < nl > + state = PeerState . ACTIVE ; < nl > + callback . onPeerStateChanged ( deviceId , state ) ; < nl > + < nl > for ( WebRTCMediaStream mediaStream : theirMediaStreams ) { < nl > callback . onStreamAdded ( deviceId , mediaStream ) ; < nl > } < nl > @ @ - 149 , 7 + 159 , 7 @ @ public class PeerNodeActor extends ModuleActor implements PeerConnectionCallback < nl > < nl > @ Override < nl > public void onHandshakeSuccessful ( ) { < nl > - callback . onHandshakeSuccessful ( deviceId ) ; < nl > + < nl > } < nl > < nl > @ Override < nl > @ @ - 163 , 7 + 173 , 8 @ @ public class PeerNodeActor extends ModuleActor implements PeerConnectionCallback < nl > if ( ! isConnected ) { < nl > isConnected = true ; < nl > if ( ! isEnabled ) { < nl > - callback . onConnectionEstablished ( deviceId ) ; < nl > + state = PeerState . CONNECTED ; < nl > + callback . onPeerStateChanged ( deviceId , state ) ; < nl > } else { < nl > / / This case is handled in startIfNeeded ( ) ; < nl > } < nl > @ @ - 191 , 6 + 202 , 8 @ @ public class PeerNodeActor extends ModuleActor implements PeerConnectionCallback < nl > peerConnection . kill ( ) ; < nl > peerConnection = null ; < nl > } < nl > + state = PeerState . DISPOSED ; < nl > + callback . onPeerStateChanged ( deviceId , state ) ; < nl > } < nl > < nl > < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeCallback . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeCallback . java < nl > index d11afa5 . . 77cfaa2 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeCallback . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeCallback . java < nl > @ @ - 37 , 25 + 37 , 11 @ @ public interface PeerNodeCallback { < nl > void onCandidate ( long deviceId , int mdpIndex , String id , String sdp ) ; < nl > < nl > / * * < nl > - * Called when handshake was successful < nl > + * Called when peer state changed < nl > * < nl > * @ param deviceId Device Id < nl > * / < nl > - void onHandshakeSuccessful ( long deviceId ) ; < nl > - < nl > - / * * < nl > - * Called when connection started < nl > - * < nl > - * @ param deviceId Device Id < nl > - * / < nl > - void onConnectionStarted ( long deviceId ) ; < nl > - < nl > - / * * < nl > - * Called when connection established < nl > - * < nl > - * @ param deviceId Device Id < nl > - * / < nl > - void onConnectionEstablished ( long deviceId ) ; < nl > + void onPeerStateChanged ( long deviceId , PeerState state ) ; < nl > < nl > / * * < nl > * Called when stream added < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeInt . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeInt . java < nl > index 89abb45 . . b7f471c 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeInt . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeInt . java < nl > @ @ - 145 , 31 + 145 , 11 @ @ public class PeerNodeInt extends ActorInterface { < nl > } < nl > < nl > @ Override < nl > - public void onHandshakeSuccessful ( final long deviceId ) { < nl > + public void onPeerStateChanged ( final long deviceId , final PeerState state ) { < nl > callbackDest . send ( new Runnable ( ) { < nl > @ Override < nl > public void run ( ) { < nl > - callback . onHandshakeSuccessful ( deviceId ) ; < nl > - } < nl > - } ) ; < nl > - } < nl > - < nl > - @ Override < nl > - public void onConnectionStarted ( final long deviceId ) { < nl > - callbackDest . send ( new Runnable ( ) { < nl > - @ Override < nl > - public void run ( ) { < nl > - callback . onConnectionStarted ( deviceId ) ; < nl > - } < nl > - } ) ; < nl > - } < nl > - < nl > - @ Override < nl > - public void onConnectionEstablished ( final long deviceId ) { < nl > - callbackDest . send ( new Runnable ( ) { < nl > - @ Override < nl > - public void run ( ) { < nl > - callback . onConnectionEstablished ( deviceId ) ; < nl > + callback . onPeerStateChanged ( deviceId , state ) ; < nl > } < nl > } ) ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerState . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerState . java < nl > index 3a00ef9 . . 3fa6438 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerState . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerState . java < nl > @ @ - 1 , 5 + 1 , 5 @ @ < nl > package im . actor . core . modules . calls . peers ; < nl > < nl > public enum PeerState { < nl > - CONNECTING , CONNECTED , ACTIVE < nl > + PENDING , CONNECTING , CONNECTED , ACTIVE , DISPOSED < nl > } < nl > \ No newline at end of file
NEAREST DIFF (one line): diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / entity / User . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / entity / User . java < nl > index fb24226 . . 779750d 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / entity / User . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / entity / User . java < nl > @ @ - 150 , 7 + 150 , 9 @ @ public class User extends WrapperEntity < ApiUser > implements KeyValueItem { < nl > w . isBot ( ) , < nl > w . getNick ( ) , < nl > w . getAbout ( ) , < nl > - w . getExternal ( ) ) ; < nl > + w . getExternal ( ) , < nl > + w . getPreferredLanguages ( ) , < nl > + w . getTimeZone ( ) ) ; < nl > res . setUnmappedObjects ( w . getUnmappedObjects ( ) ) ; < nl > return new User ( res ) ; < nl > } < nl > @ @ - 168 , 7 + 170 , 9 @ @ public class User extends WrapperEntity < ApiUser > implements KeyValueItem { < nl > w . isBot ( ) , < nl > w . getNick ( ) , < nl > w . getAbout ( ) , < nl > - w . getExternal ( ) ) ; < nl > + w . getExternal ( ) , < nl > + w . getPreferredLanguages ( ) , < nl > + w . getTimeZone ( ) ) ; < nl > res . setUnmappedObjects ( w . getUnmappedObjects ( ) ) ; < nl > return new User ( res ) ; < nl > } < nl > @ @ - 186 , 7 + 190 , 9 @ @ public class User extends WrapperEntity < ApiUser > implements KeyValueItem { < nl > w . isBot ( ) , < nl > nick , < nl > w . getAbout ( ) , < nl > - w . getExternal ( ) ) ; < nl > + w . getExternal ( ) , < nl > + w . getPreferredLanguages ( ) , < nl > + w . getTimeZone ( ) ) ; < nl > res . setUnmappedObjects ( w . getUnmappedObjects ( ) ) ; < nl > return new User ( res ) ; < nl > } < nl > @ @ - 204 , 7 + 210 , 9 @ @ public class User extends WrapperEntity < ApiUser > implements KeyValueItem { < nl > w . isBot ( ) , < nl > w . getNick ( ) , < nl > about , < nl > - w . getExternal ( ) ) ; < nl > + w . getExternal ( ) , < nl > + w . getPreferredLanguages ( ) , < nl > + w . getTimeZone ( ) ) ; < nl > res . setUnmappedObjects ( w . getUnmappedObjects ( ) ) ; < nl > return new User ( res ) ; < nl > } < nl > @ @ - 222 , 7 + 230 , 9 @ @ public class User extends WrapperEntity < ApiUser > implements KeyValueItem { < nl > w . isBot ( ) , < nl > w . getNick ( ) , < nl > w . getAbout ( ) , < nl > - w . getExternal ( ) ) ; < nl > + w . getExternal ( ) , < nl > + w . getPreferredLanguages ( ) , < nl > + w . getTimeZone ( ) ) ; < nl > res . setUnmappedObjects ( w . getUnmappedObjects ( ) ) ; < nl > return new User ( res ) ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / Authentication . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / Authentication . java < nl > index 2f83c05 . . 8a0b75a 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / Authentication . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / Authentication . java < nl > @ @ - 118 , 7 + 118 , 8 @ @ public class Authentication { < nl > apiConfiguration . getAppId ( ) , < nl > apiConfiguration . getAppKey ( ) , < nl > deviceHash , < nl > - apiConfiguration . getDeviceTitle ( ) < nl > + apiConfiguration . getDeviceTitle ( ) , < nl > + null , new ArrayList < String > ( ) < nl > ) , new RpcCallback < ResponseStartEmailAuth > ( ) { < nl > @ Override < nl > public void onResult ( ResponseStartEmailAuth response ) { < nl > @ @ - 163 , 7 + 164 , 8 @ @ public class Authentication { < nl > apiConfiguration . getAppId ( ) , < nl > apiConfiguration . getAppKey ( ) , < nl > deviceHash , < nl > - apiConfiguration . getDeviceTitle ( ) < nl > + apiConfiguration . getDeviceTitle ( ) , < nl > + null , new ArrayList < String > ( ) < nl > ) , new RpcCallback < ResponseStartPhoneAuth > ( ) { < nl > @ Override < nl > public void onResult ( ResponseStartPhoneAuth response ) { < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java < nl > index 11630f1 . . bfbd171 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java < nl > @ @ - 288 , 6 + 288 , 8 @ @ public class MessagesModule extends AbsModule implements BusSubscriber { < nl > < nl > public void sendMessage ( @ NotNull Peer peer , @ NotNull String message , @ Nullable String markDownText , < nl > @ Nullable ArrayList < Integer > mentions , boolean autoDetect ) { < nl > + / / Notify typing about message sent < nl > + context ( ) . getTypingModule ( ) . onMessageSent ( peer ) ; < nl > sendMessageActor . send ( new SenderActor . SendText ( peer , message , markDownText , mentions , < nl > autoDetect ) ) ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / TypingModule . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / TypingModule . java < nl > index 72ce08e . . c867fb0 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / TypingModule . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / TypingModule . java < nl > @ @ - 51 , 6 + 51 , 10 @ @ public class TypingModule extends AbsModule { < nl > ownTypingActor . send ( new OwnTypingActor . Typing ( peer ) ) ; < nl > } < nl > < nl > + public void onMessageSent ( Peer peer ) { < nl > + ownTypingActor . send ( new OwnTypingActor . MessageSent ( peer ) ) ; < nl > + } < nl > + < nl > public void resetModule ( ) { < nl > / / TODO : Implement < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / typing / OwnTypingActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / typing / OwnTypingActor . java < nl > index 341880a . . faf08d0 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / typing / OwnTypingActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / typing / OwnTypingActor . java < nl > @ @ - 6 , 6 + 6 , 7 @ @ package im . actor . core . modules . internal . typing ; < nl > < nl > import im . actor . core . api . ApiOutPeer ; < nl > import im . actor . core . api . ApiTypingType ; < nl > + import im . actor . core . api . rpc . RequestStopTyping ; < nl > import im . actor . core . api . rpc . RequestTyping ; < nl > import im . actor . core . entity . Peer ; < nl > import im . actor . core . modules . ModuleContext ; < nl > @ @ - 30 , 9 + 31 , 12 @ @ public class OwnTypingActor extends ModuleActor { < nl > } < nl > < nl > private static final long TYPING _ DELAY = 3000L ; < nl > + private static final long TYPING _ CANCEL _ DELAY = 4000L ; < nl > < nl > private long lastTypingTime = 0 ; < nl > < nl > + private long prevRid = 0 ; < nl > + < nl > @ Verified < nl > public OwnTypingActor ( ModuleContext messenger ) { < nl > super ( messenger ) ; < nl > @ @ - 50 , 7 + 54 , 31 @ @ public class OwnTypingActor extends ModuleActor { < nl > return ; < nl > } < nl > < nl > - request ( new RequestTyping ( outPeer , ApiTypingType . TEXT ) ) ; < nl > + cancelPrevRequest ( ) ; < nl > + prevRid = request ( new RequestTyping ( outPeer , ApiTypingType . TEXT ) ) ; < nl > + self ( ) . sendOnce ( new AbortTyping ( peer ) , TYPING _ CANCEL _ DELAY ) ; < nl > + } < nl > + < nl > + private void onMessageSent ( Peer peer ) { < nl > + cancelPrevRequest ( ) ; < nl > + lastTypingTime = 0 ; < nl > + self ( ) . sendOnce ( new AbortTyping ( peer ) , 24 * 60 * 60 * 1000L ) ; < nl > + } < nl > + < nl > + private void onAbortTyping ( Peer peer ) { < nl > + ApiOutPeer outPeer = buidOutPeer ( peer ) ; < nl > + if ( outPeer = = null ) { < nl > + return ; < nl > + } < nl > + cancelPrevRequest ( ) ; < nl > + prevRid = request ( new RequestStopTyping ( outPeer , ApiTypingType . TEXT ) ) ; < nl > + } < nl > + < nl > + private void cancelPrevRequest ( ) { < nl > + if ( prevRid ! = 0 ) { < nl > + cancelRequest ( prevRid ) ; < nl > + prevRid = 0 ; < nl > + } < nl > } < nl > < nl > / / Messages < nl > @ @ - 59 , 11 + 87 , 27 @ @ public class OwnTypingActor extends ModuleActor { < nl > public void onReceive ( Object message ) { < nl > if ( message instanceof Typing ) { < nl > onTyping ( ( ( Typing ) message ) . getPeer ( ) ) ; < nl > + } else if ( message instanceof MessageSent ) { < nl > + onMessageSent ( ( ( MessageSent ) message ) . getPeer ( ) ) ; < nl > + } else if ( message instanceof AbortTyping ) { < nl > + onAbortTyping ( ( ( AbortTyping ) message ) . getPeer ( ) ) ; < nl > } else { < nl > drop ( message ) ; < nl > } < nl > } < nl > < nl > + private static class AbortTyping { < nl > + private Peer peer ; < nl > + < nl > + public AbortTyping ( Peer peer ) { < nl > + this . peer = peer ; < nl > + } < nl > + < nl > + public Peer getPeer ( ) { < nl > + return peer ; < nl > + } < nl > + } < nl > + < nl > public static class Typing { < nl > private Peer peer ; < nl > < nl > @ @ - 75 , 4 + 119 , 17 @ @ public class OwnTypingActor extends ModuleActor { < nl > return peer ; < nl > } < nl > } < nl > + < nl > + public static class MessageSent { < nl > + < nl > + private Peer peer ; < nl > + < nl > + public MessageSent ( Peer peer ) { < nl > + this . peer = peer ; < nl > + } < nl > + < nl > + public Peer getPeer ( ) { < nl > + return peer ; < nl > + } < nl > + } < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / updates / TypingProcessor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / updates / TypingProcessor . java < nl > index ace0a50 . . 674756e 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / updates / TypingProcessor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / updates / TypingProcessor . java < nl > @ @ - 32 , 8 + 32 , 18 @ @ public class TypingProcessor extends AbsModule { < nl > } < nl > } < nl > < nl > + @ Verified < nl > public void onTypingStop ( ApiPeer peer , int uid , ApiTypingType typingType ) { < nl > - < nl > + / / Other types are unsupported < nl > + / / TODO : Move to Actor < nl > + if ( typingType ! = ApiTypingType . TEXT ) { < nl > + return ; < nl > + } < nl > + if ( peer . getType ( ) = = ApiPeerType . PRIVATE ) { < nl > + typingActor . sendOnce ( new TypingActor . StopTyping ( uid ) ) ; < nl > + } else if ( peer . getType ( ) = = ApiPeerType . GROUP ) { < nl > + typingActor . sendOnce ( new TypingActor . StopGroupTyping ( peer . getId ( ) , uid ) ) ; < nl > + } < nl > } < nl > < nl > @ Verified < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / updates / UpdateProcessor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / updates / UpdateProcessor . java < nl > index 8a2998c . . ab71f3a 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / updates / UpdateProcessor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / updates / UpdateProcessor . java < nl > @ @ - 40 , 6 + 40 , 7 @ @ import im . actor . core . api . updates . UpdateMessageReceived ; < nl > import im . actor . core . api . updates . UpdateMessageSent ; < nl > import im . actor . core . api . updates . UpdateParameterChanged ; < nl > import im . actor . core . api . updates . UpdateTyping ; < nl > + import im . actor . core . api . updates . UpdateTypingStop ; < nl > import im . actor . core . api . updates . UpdateUserLastSeen ; < nl > import im . actor . core . api . updates . UpdateUserLocalNameChanged ; < nl > import im . actor . core . api . updates . UpdateUserOffline ; < nl > @ @ - 198 , 6 + 199 , 9 @ @ public class UpdateProcessor extends AbsModule { < nl > } else if ( update instanceof UpdateTyping ) { < nl > UpdateTyping typing = ( UpdateTyping ) update ; < nl > typingProcessor . onTyping ( typing . getPeer ( ) , typing . getUid ( ) , typing . getTypingType ( ) ) ; < nl > + } else if ( update instanceof UpdateTypingStop ) { < nl > + UpdateTypingStop typing = ( UpdateTypingStop ) update ; < nl > + typingProcessor . onTypingStop ( typing . getPeer ( ) , typing . getUid ( ) , typing . getTypingType ( ) ) ; < nl > } < nl > } < nl > < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / utils / ModuleActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / utils / ModuleActor . java < nl > index 67b681e . . 072af9f 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / utils / ModuleActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / utils / ModuleActor . java < nl > @ @ - 130 , 8 + 130 , 8 @ @ public class ModuleActor extends Actor implements BusSubscriber { < nl > return context ; < nl > } < nl > < nl > - public < T extends Response > void request ( Request < T > request ) { < nl > - request ( request , new RpcCallback < T > ( ) { < nl > + public < T extends Response > long request ( Request < T > request ) { < nl > + return request ( request , new RpcCallback < T > ( ) { < nl > @ Override < nl > public void onResult ( T response ) { < nl > < nl > @ @ - 144 , 8 + 144 , 8 @ @ public class ModuleActor extends Actor implements BusSubscriber { < nl > } ) ; < nl > } < nl > < nl > - public < T extends Response > void request ( final Request < T > request , final RpcCallback < T > callback ) { < nl > - context . getActorApi ( ) . request ( request , new RpcCallback < T > ( ) { < nl > + public < T extends Response > long request ( final Request < T > request , final RpcCallback < T > callback ) { < nl > + return context . getActorApi ( ) . request ( request , new RpcCallback < T > ( ) { < nl > @ Override < nl > public void onResult ( final T response ) { < nl > self ( ) . send ( new Runnable ( ) { < nl > @ @ - 178 , 6 + 178 , 10 @ @ public class ModuleActor extends Actor implements BusSubscriber { < nl > } ) ; < nl > } < nl > < nl > + public void cancelRequest ( long rid ) { < nl > + context . getActorApi ( ) . cancelRequest ( rid ) ; < nl > + } < nl > + < nl > @ Override < nl > public void onBusEvent ( Event event ) { < nl > < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / network / ActorApi . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / network / ActorApi . java < nl > index a019d60 . . acfcafa 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / network / ActorApi . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / network / ActorApi . java < nl > @ @ - 11 , 6 + 11 , 7 @ @ import im . actor . core . network . api . ApiBroker ; < nl > import im . actor . core . network . parser . Request ; < nl > import im . actor . core . network . parser . Response ; < nl > import im . actor . runtime . threading . AtomicIntegerCompat ; < nl > + import im . actor . runtime . threading . AtomicLongCompat ; < nl > < nl > / * * < nl > * Actor API Object for connecting to Actor ' s servers < nl > @ @ - 22 , 6 + 23 , 7 @ @ public class ActorApi { < nl > public static final int API _ MINOR _ VERSION = ApiVersion . VERSION _ MINOR ; < nl > < nl > private static final AtomicIntegerCompat NEXT _ ID = im . actor . runtime . Runtime . createAtomicInt ( 1 ) ; < nl > + private static final AtomicLongCompat NEXT _ RPC _ ID = im . actor . runtime . Runtime . createAtomicLong ( 1 ) ; < nl > < nl > private final Endpoints endpoints ; < nl > private final AuthKeyStorage keyStorage ; < nl > @ @ - 62 , 13 + 64 , 24 @ @ public class ActorApi { < nl > * @ param request request body < nl > * @ param callback request callback < nl > * @ param < T > type of response < nl > + * @ return rid of request < nl > * / < nl > - public synchronized < T extends Response > void request ( Request < T > request , RpcCallback < T > callback ) { < nl > + public synchronized < T extends Response > long request ( Request < T > request , RpcCallback < T > callback ) { < nl > if ( request = = null ) { < nl > throw new RuntimeException ( " Request can ' t be null " ) ; < nl > } < nl > + long rid = NEXT _ RPC _ ID . incrementAndGet ( ) ; < nl > + this . apiBroker . send ( new ApiBroker . PerformRequest ( rid , request , callback ) ) ; < nl > + return rid ; < nl > + } < nl > < nl > - this . apiBroker . send ( new ApiBroker . PerformRequest ( request , callback ) ) ; < nl > + / * * < nl > + * Cancelling API Request < nl > + * < nl > + * @ param rid request rid < nl > + * / < nl > + public synchronized void cancelRequest ( long rid ) { < nl > + this . apiBroker . send ( new ApiBroker . CancelRequest ( rid ) ) ; < nl > } < nl > < nl > / * * < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / network / api / ApiBroker . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / network / api / ApiBroker . java < nl > index 207ffca . . 06f4742 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / network / api / ApiBroker . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / network / api / ApiBroker . java < nl > @ @ - 60 , 7 + 60 , 7 @ @ public class ApiBroker extends Actor { < nl > } < nl > < nl > private static final String TAG = " ApiBroker " ; < nl > - private static final AtomicLongCompat NEXT _ RPC _ ID = im . actor . runtime . Runtime . createAtomicLong ( 1 ) ; < nl > + < nl > private static final AtomicIntegerCompat NEXT _ PROTO _ ID = im . actor . runtime . Runtime . createAtomicInt ( 1 ) ; < nl > < nl > private final Endpoints endpoints ; < nl > @ @ - 360 , 14 + 360 , 21 @ @ public class ApiBroker extends Actor { < nl > } < nl > < nl > public static class PerformRequest { < nl > + < nl > private Request message ; < nl > private RpcCallback callback ; < nl > + private long rid ; < nl > < nl > - public PerformRequest ( Request message , RpcCallback callback ) { < nl > + public PerformRequest ( long rid , Request message , RpcCallback callback ) { < nl > + this . rid = rid ; < nl > this . message = message ; < nl > this . callback = callback ; < nl > } < nl > < nl > + public long getRid ( ) { < nl > + return rid ; < nl > + } < nl > + < nl > public Request getMessage ( ) { < nl > return message ; < nl > } < nl > @ @ - 577 , 8 + 584 , 7 @ @ public class ApiBroker extends Actor { < nl > createMtProto ( initMTProto . getAuthId ( ) ) ; < nl > } else if ( message instanceof PerformRequest ) { < nl > PerformRequest request = ( PerformRequest ) message ; < nl > - performRequest ( NEXT _ RPC _ ID . getAndIncrement ( ) , < nl > - request . getMessage ( ) , request . getCallback ( ) ) ; < nl > + performRequest ( request . getRid ( ) , request . getMessage ( ) , request . getCallback ( ) ) ; < nl > } else if ( message instanceof CancelRequest ) { < nl > CancelRequest cancelRequest = ( CancelRequest ) message ; < nl > cancelRequest ( cancelRequest . getRandomId ( ) ) ; < nl > diff - - git a / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / bser / BserWriter . java b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / bser / BserWriter . java < nl > index f203ad1 . . 6aee0c3 100755 < nl > - - - a / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / bser / BserWriter . java < nl > + + + b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / bser / BserWriter . java < nl > @ @ - 116 , 6 + 116 , 22 @ @ public class BserWriter { < nl > } < nl > } < nl > < nl > + public void writeRepeatedString ( int fieldNumber , @ NotNull List < String > values ) throws IOException { < nl > + if ( values = = null ) { < nl > + throw new IllegalArgumentException ( " Values can not be null " ) ; < nl > + } < nl > + if ( values . size ( ) > BserLimits . MAX _ PROTO _ REPEATED ) { < nl > + throw new IllegalArgumentException ( " Too many values " ) ; < nl > + } < nl > + writtenFields . put ( fieldNumber , true ) ; < nl > + for ( String l : values ) { < nl > + if ( l = = null ) { < nl > + throw new IllegalArgumentException ( " Value can not be null " ) ; < nl > + } < nl > + writeString ( fieldNumber , l ) ; < nl > + } < nl > + } < nl > + < nl > public void writeRepeatedBytes ( int fieldNumber , @ NotNull List < byte [ ] > values ) throws IOException { < nl > if ( values = = null ) { < nl > throw new IllegalArgumentException ( " Values can not be null " ) ;

TEST DIFF:
diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / AbsCallActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / AbsCallActor . java 
 index ed05fe8 . . 120a018 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / AbsCallActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / AbsCallActor . java 
 @ @ - 9 , 6 + 9 , 7 @ @ import im . actor . core . modules . calls . bus . CallBusCallback ; 
 import im . actor . core . modules . calls . bus . CallBusInt ; 
 import im . actor . core . modules . calls . peers . PeerCallInt ; 
 import im . actor . core . modules . calls . peers . PeerSettings ; 
 + import im . actor . core . modules . calls . peers . PeerState ; 
 import im . actor . core . modules . eventbus . EventBusActor ; 
 import im . actor . runtime . actors . Actor ; 
 import im . actor . runtime . actors . ActorCreator ; 
 @ @ - 62 , 6 + 63 , 11 @ @ public abstract class AbsCallActor extends EventBusActor implements CallBusCallb 
 
 } 
 
 + @ Override 
 + public void onPeerStateChanged ( int uid , long deviceId , PeerState state ) { 
 + 
 + } 
 + 
 / / 
 / / Wrapper 
 / / 
 @ @ - 97 , 5 + 103 , 15 @ @ public abstract class AbsCallActor extends EventBusActor implements CallBusCallb 
 } 
 } ) ; 
 } 
 + 
 + @ Override 
 + public void onPeerStateChanged ( final int uid , final long deviceId , final PeerState state ) { 
 + self ( ) . send ( new Runnable ( ) { 
 + @ Override 
 + public void run ( ) { 
 + AbsCallActor . this . onPeerStateChanged ( uid , deviceId , state ) ; 
 + } 
 + } ) ; 
 + } 
 } 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java 
 index e3ac82b . . 5929861 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java 
 @ @ - 10 , 9 + 10 , 11 @ @ import im . actor . core . api . rpc . RequestGetCallInfo ; 
 import im . actor . core . api . rpc . ResponseGetCallInfo ; 
 import im . actor . core . entity . Peer ; 
 import im . actor . core . modules . ModuleContext ; 
 + import im . actor . core . modules . calls . peers . PeerState ; 
 import im . actor . core . viewmodel . CallMember ; 
 import im . actor . core . viewmodel . CallState ; 
 import im . actor . core . viewmodel . CallVM ; 
 + import im . actor . runtime . Log ; 
 import im . actor . runtime . actors . messages . PoisonPill ; 
 import im . actor . runtime . function . Consumer ; 
 
 @ @ - 40 , 6 + 42 , 7 @ @ public class CallActor extends AbsCallActor { 
 
 @ Override 
 public void callPreStart ( ) { 
 + Log . d ( TAG , " callPreStart " ) ; 
 api ( new RequestGetCallInfo ( callId ) ) . then ( new Consumer < ResponseGetCallInfo > ( ) { 
 @ Override 
 public void apply ( final ResponseGetCallInfo responseGetCallInfo ) { 
 @ @ - 57 , 9 + 60 , 9 @ @ public class CallActor extends AbsCallActor { 
 
 @ Override 
 public void onBusStarted ( String busId ) { 
 - super . onBusStarted ( busId ) ; 
 + Log . d ( TAG , " onBusStarted " ) ; 
 
 - callManager . send ( new CallManagerActor . OnIncomingCall ( callId ) ) ; 
 + callManager . send ( new CallManagerActor . IncomingCallReady ( callId ) , self ( ) ) ; 
 } 
 
 @ Override 
 @ @ - 69 , 6 + 72 , 12 @ @ public class CallActor extends AbsCallActor { 
 / / 
 } 
 
 + @ Override 
 + public void onPeerStateChanged ( int uid , long deviceId , PeerState state ) { 
 + Log . d ( TAG , " onPeerStateChanged " + deviceId + " ( " + state + " ) " ) ; 
 + 
 + } 
 + 
 public void onAnswerCall ( ) { 
 if ( ! isAnswered & & ! isRejected ) { 
 isAnswered = true ; 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / bus / CallBusActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / bus / CallBusActor . java 
 index 868ea55 . . a03827c 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / bus / CallBusActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / bus / CallBusActor . java 
 @ @ - 7 , 11 + 7 , 13 @ @ import java . util . HashMap ; 
 
 import im . actor . core . api . ApiAdvertiseSelf ; 
 import im . actor . core . api . ApiAnswer ; 
 + import im . actor . core . api . ApiAnswerCall ; 
 import im . actor . core . api . ApiCandidate ; 
 import im . actor . core . api . ApiMembersChanged ; 
 import im . actor . core . api . ApiNeedOffer ; 
 import im . actor . core . api . ApiOffer ; 
 import im . actor . core . api . ApiOnAnswer ; 
 + import im . actor . core . api . ApiRejectCall ; 
 import im . actor . core . api . ApiSwitchMaster ; 
 import im . actor . core . api . ApiWebRTCSignaling ; 
 import im . actor . core . modules . ModuleContext ; 
 @ @ - 19 , 6 + 21 , 7 @ @ import im . actor . core . modules . calls . peers . PeerCallActor ; 
 import im . actor . core . modules . calls . peers . PeerCallCallback ; 
 import im . actor . core . modules . calls . peers . PeerCallInt ; 
 import im . actor . core . modules . calls . peers . PeerSettings ; 
 + import im . actor . core . modules . calls . peers . PeerState ; 
 import im . actor . core . modules . eventbus . EventBusActor ; 
 import im . actor . runtime . Log ; 
 import im . actor . runtime . actors . Actor ; 
 @ @ - 39 , 7 + 42 , 7 @ @ public class CallBusActor extends EventBusActor { 
 private long masterDeviceId ; 
 private PeerCallInt peerCall ; 
 
 - public CallBusActor ( CallBusCallback callBusCallback , PeerSettings selfSettings , ModuleContext context ) { 
 + public CallBusActor ( final CallBusCallback callBusCallback , PeerSettings selfSettings , ModuleContext context ) { 
 super ( context ) ; 
 
 this . selfSettings = selfSettings ; 
 @ @ - 61 , 18 + 64 , 8 @ @ public class CallBusActor extends EventBusActor { 
 } 
 
 @ Override 
 - public void onHandshakeSuccessful ( long deviceId ) { 
 - 
 - } 
 - 
 - @ Override 
 - public void onConnectionStarted ( long deviceId ) { 
 - 
 - } 
 - 
 - @ Override 
 - public void onConnectionEstablished ( long deviceId ) { 
 - 
 + public void onPeerStateChanged ( long deviceId , PeerState state ) { 
 + callBusCallback . onPeerStateChanged ( deviceIds . get ( deviceId ) , deviceId , state ) ; 
 } 
 
 @ Override 
 @ @ - 110 , 7 + 103 , 11 @ @ public class CallBusActor extends EventBusActor { 
 } 
 
 public void onAnswerCall ( ) { 
 + sendSignal ( masterUid , masterDeviceId , new ApiAnswerCall ( ) ) ; 
 + } 
 
 + public void onRejectCall ( ) { 
 + sendSignal ( masterUid , masterDeviceId , new ApiRejectCall ( ) ) ; 
 } 
 
 @ Override 
 @ @ - 179 , 8 + 176 , 7 @ @ public class CallBusActor extends EventBusActor { 
 } 
 
 public final void sendSignal ( long deviceId , ApiWebRTCSignaling signal ) { 
 - int uid = deviceIds . get ( deviceId ) ; 
 - sendSignal ( uid , deviceId , signal ) ; 
 + sendSignal ( deviceIds . get ( deviceId ) , deviceId , signal ) ; 
 } 
 
 public final void sendSignal ( int uid , long deviceId , ApiWebRTCSignaling signal ) { 
 @ @ - 204 , 8 + 200 , 15 @ @ public class CallBusActor extends EventBusActor { 
 } else if ( message instanceof AnswerCall ) { 
 if ( ! isMasterReady ) { 
 stash ( STASH ) ; 
 + return ; 
 } 
 onAnswerCall ( ) ; 
 + } else if ( message instanceof RejectCall ) { 
 + if ( ! isMasterReady ) { 
 + stash ( STASH ) ; 
 + return ; 
 + } 
 + onRejectCall ( ) ; 
 } else { 
 super . onReceive ( message ) ; 
 } 
 @ @ - 300 , 31 + 303 , 11 @ @ public class CallBusActor extends EventBusActor { 
 } 
 
 @ Override 
 - public void onHandshakeSuccessful ( final long deviceId ) { 
 - self ( ) . send ( new Runnable ( ) { 
 - @ Override 
 - public void run ( ) { 
 - callCallback . onHandshakeSuccessful ( deviceId ) ; 
 - } 
 - } ) ; 
 - } 
 - 
 - @ Override 
 - public void onConnectionStarted ( final long deviceId ) { 
 - self ( ) . send ( new Runnable ( ) { 
 - @ Override 
 - public void run ( ) { 
 - callCallback . onConnectionStarted ( deviceId ) ; 
 - } 
 - } ) ; 
 - } 
 - 
 - @ Override 
 - public void onConnectionEstablished ( final long deviceId ) { 
 + public void onPeerStateChanged ( final long deviceId , final PeerState state ) { 
 self ( ) . send ( new Runnable ( ) { 
 @ Override 
 public void run ( ) { 
 - callCallback . onConnectionEstablished ( deviceId ) ; 
 + callCallback . onPeerStateChanged ( deviceId , state ) ; 
 } 
 } ) ; 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / bus / CallBusCallback . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / bus / CallBusCallback . java 
 index 258f807 . . d523f9c 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / bus / CallBusCallback . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / bus / CallBusCallback . java 
 @ @ - 4 , 6 + 4 , 7 @ @ import java . util . List ; 
 
 import im . actor . core . api . ApiCallMember ; 
 import im . actor . core . modules . calls . peers . PeerCallInt ; 
 + import im . actor . core . modules . calls . peers . PeerState ; 
 
 public interface CallBusCallback { 
 
 @ @ - 12 , 4 + 13 , 6 @ @ public interface CallBusCallback { 
 void onBusStarted ( String busId ) ; 
 
 void onMembersChanged ( List < ApiCallMember > members ) ; 
 + 
 + void onPeerStateChanged ( int uid , long deviceId , PeerState state ) ; 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallActor . java 
 index 54cc145 . . bd807fb 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallActor . java 
 @ @ - 192 , 18 + 192 , 8 @ @ public class PeerCallActor extends ModuleActor { 
 } 
 
 @ Override 
 - public void onHandshakeSuccessful ( long deviceId ) { 
 - callback . onHandshakeSuccessful ( deviceId ) ; 
 - } 
 - 
 - @ Override 
 - public void onConnectionStarted ( long deviceId ) { 
 - callback . onConnectionStarted ( deviceId ) ; 
 - } 
 - 
 - @ Override 
 - public void onConnectionEstablished ( long deviceId ) { 
 - callback . onConnectionEstablished ( deviceId ) ; 
 + public void onPeerStateChanged ( long deviceId , PeerState state ) { 
 + callback . onPeerStateChanged ( deviceId , state ) ; 
 } 
 
 @ Override 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallCallback . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallCallback . java 
 index bf25d3a . . b1f9306 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallCallback . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallCallback . java 
 @ @ - 10 , 11 + 10 , 7 @ @ public interface PeerCallCallback { 
 
 void onCandidate ( long deviceId , int mdpIndex , String id , String sdp ) ; 
 
 - void onHandshakeSuccessful ( long deviceId ) ; 
 - 
 - void onConnectionStarted ( long deviceId ) ; 
 - 
 - void onConnectionEstablished ( long deviceId ) ; 
 + void onPeerStateChanged ( long deviceId , PeerState state ) ; 
 
 void onStreamAdded ( long deviceId , WebRTCMediaStream stream ) ; 
 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeActor . java 
 index 0aaf20d . . 857729a 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeActor . java 
 @ @ - 24 , 6 + 24 , 7 @ @ public class PeerNodeActor extends ModuleActor implements PeerConnectionCallback 
 private final PeerSettings ownSettings ; 
 private final ArrayList < WebRTCMediaStream > theirMediaStreams = new ArrayList < > ( ) ; 
 
 + private PeerState state = PeerState . PENDING ; 
 private PeerConnectionInt peerConnection ; 
 private PeerSettings theirSettings ; 
 private WebRTCMediaStream ownMediaStream ; 
 @ @ - 48 , 6 + 49 , 7 @ @ public class PeerNodeActor extends ModuleActor implements PeerConnectionCallback 
 / / Starting up peer nodes 
 / / 
 / / Stages : 
 + / / 0 . Notify about new peer node 
 / / 1 . Waiting for advertise of a node 
 / / 2 . If both peers supports pre connection , create new connection 
 / / 3 . Enabling Own and Their peers 
 @ @ - 55 , 6 + 57 , 11 @ @ public class PeerNodeActor extends ModuleActor implements PeerConnectionCallback 
 / / 5 . Creation of peer connection 
 / / 
 
 + @ Override 
 + public void preStart ( ) { 
 + callback . onPeerStateChanged ( deviceId , state ) ; 
 + } 
 + 
 public void onAdvertised ( PeerSettings settings ) { 
 if ( this . theirSettings = = null ) { 
 this . theirSettings = settings ; 
 @ @ - 96 , 7 + 103 , 8 @ @ public class PeerNodeActor extends ModuleActor implements PeerConnectionCallback 
 
 if ( ( isOwnEnabled & & isTheirEnabled ) | | 
 ( theirSettings . isPreConnectionEnabled ( ) & & ownSettings . isPreConnectionEnabled ( ) ) ) { 
 - 
 + state = PeerState . CONNECTING ; 
 + callback . onPeerStateChanged ( deviceId , state ) ; 
 peerConnection = new PeerConnectionInt ( 
 ownSettings , theirSettings , 
 ownMediaStream , this , context ( ) , self ( ) , " connection " ) ; 
 @ @ - 120 , 7 + 128 , 9 @ @ public class PeerNodeActor extends ModuleActor implements PeerConnectionCallback 
 if ( isEnabled & & isConnected & & ! isStarted ) { 
 isStarted = true ; 
 
 - callback . onConnectionStarted ( deviceId ) ; 
 + state = PeerState . ACTIVE ; 
 + callback . onPeerStateChanged ( deviceId , state ) ; 
 + 
 for ( WebRTCMediaStream mediaStream : theirMediaStreams ) { 
 callback . onStreamAdded ( deviceId , mediaStream ) ; 
 } 
 @ @ - 149 , 7 + 159 , 7 @ @ public class PeerNodeActor extends ModuleActor implements PeerConnectionCallback 
 
 @ Override 
 public void onHandshakeSuccessful ( ) { 
 - callback . onHandshakeSuccessful ( deviceId ) ; 
 + 
 } 
 
 @ Override 
 @ @ - 163 , 7 + 173 , 8 @ @ public class PeerNodeActor extends ModuleActor implements PeerConnectionCallback 
 if ( ! isConnected ) { 
 isConnected = true ; 
 if ( ! isEnabled ) { 
 - callback . onConnectionEstablished ( deviceId ) ; 
 + state = PeerState . CONNECTED ; 
 + callback . onPeerStateChanged ( deviceId , state ) ; 
 } else { 
 / / This case is handled in startIfNeeded ( ) ; 
 } 
 @ @ - 191 , 6 + 202 , 8 @ @ public class PeerNodeActor extends ModuleActor implements PeerConnectionCallback 
 peerConnection . kill ( ) ; 
 peerConnection = null ; 
 } 
 + state = PeerState . DISPOSED ; 
 + callback . onPeerStateChanged ( deviceId , state ) ; 
 } 
 
 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeCallback . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeCallback . java 
 index d11afa5 . . 77cfaa2 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeCallback . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeCallback . java 
 @ @ - 37 , 25 + 37 , 11 @ @ public interface PeerNodeCallback { 
 void onCandidate ( long deviceId , int mdpIndex , String id , String sdp ) ; 
 
 / * * 
 - * Called when handshake was successful 
 + * Called when peer state changed 
 * 
 * @ param deviceId Device Id 
 * / 
 - void onHandshakeSuccessful ( long deviceId ) ; 
 - 
 - / * * 
 - * Called when connection started 
 - * 
 - * @ param deviceId Device Id 
 - * / 
 - void onConnectionStarted ( long deviceId ) ; 
 - 
 - / * * 
 - * Called when connection established 
 - * 
 - * @ param deviceId Device Id 
 - * / 
 - void onConnectionEstablished ( long deviceId ) ; 
 + void onPeerStateChanged ( long deviceId , PeerState state ) ; 
 
 / * * 
 * Called when stream added 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeInt . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeInt . java 
 index 89abb45 . . b7f471c 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeInt . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerNodeInt . java 
 @ @ - 145 , 31 + 145 , 11 @ @ public class PeerNodeInt extends ActorInterface { 
 } 
 
 @ Override 
 - public void onHandshakeSuccessful ( final long deviceId ) { 
 + public void onPeerStateChanged ( final long deviceId , final PeerState state ) { 
 callbackDest . send ( new Runnable ( ) { 
 @ Override 
 public void run ( ) { 
 - callback . onHandshakeSuccessful ( deviceId ) ; 
 - } 
 - } ) ; 
 - } 
 - 
 - @ Override 
 - public void onConnectionStarted ( final long deviceId ) { 
 - callbackDest . send ( new Runnable ( ) { 
 - @ Override 
 - public void run ( ) { 
 - callback . onConnectionStarted ( deviceId ) ; 
 - } 
 - } ) ; 
 - } 
 - 
 - @ Override 
 - public void onConnectionEstablished ( final long deviceId ) { 
 - callbackDest . send ( new Runnable ( ) { 
 - @ Override 
 - public void run ( ) { 
 - callback . onConnectionEstablished ( deviceId ) ; 
 + callback . onPeerStateChanged ( deviceId , state ) ; 
 } 
 } ) ; 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerState . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerState . java 
 index 3a00ef9 . . 3fa6438 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerState . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerState . java 
 @ @ - 1 , 5 + 1 , 5 @ @ 
 package im . actor . core . modules . calls . peers ; 
 
 public enum PeerState { 
 - CONNECTING , CONNECTED , ACTIVE 
 + PENDING , CONNECTING , CONNECTED , ACTIVE , DISPOSED 
 } 
 \ No newline at end of file

NEAREST DIFF:
diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / entity / User . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / entity / User . java 
 index fb24226 . . 779750d 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / entity / User . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / entity / User . java 
 @ @ - 150 , 7 + 150 , 9 @ @ public class User extends WrapperEntity < ApiUser > implements KeyValueItem { 
 w . isBot ( ) , 
 w . getNick ( ) , 
 w . getAbout ( ) , 
 - w . getExternal ( ) ) ; 
 + w . getExternal ( ) , 
 + w . getPreferredLanguages ( ) , 
 + w . getTimeZone ( ) ) ; 
 res . setUnmappedObjects ( w . getUnmappedObjects ( ) ) ; 
 return new User ( res ) ; 
 } 
 @ @ - 168 , 7 + 170 , 9 @ @ public class User extends WrapperEntity < ApiUser > implements KeyValueItem { 
 w . isBot ( ) , 
 w . getNick ( ) , 
 w . getAbout ( ) , 
 - w . getExternal ( ) ) ; 
 + w . getExternal ( ) , 
 + w . getPreferredLanguages ( ) , 
 + w . getTimeZone ( ) ) ; 
 res . setUnmappedObjects ( w . getUnmappedObjects ( ) ) ; 
 return new User ( res ) ; 
 } 
 @ @ - 186 , 7 + 190 , 9 @ @ public class User extends WrapperEntity < ApiUser > implements KeyValueItem { 
 w . isBot ( ) , 
 nick , 
 w . getAbout ( ) , 
 - w . getExternal ( ) ) ; 
 + w . getExternal ( ) , 
 + w . getPreferredLanguages ( ) , 
 + w . getTimeZone ( ) ) ; 
 res . setUnmappedObjects ( w . getUnmappedObjects ( ) ) ; 
 return new User ( res ) ; 
 } 
 @ @ - 204 , 7 + 210 , 9 @ @ public class User extends WrapperEntity < ApiUser > implements KeyValueItem { 
 w . isBot ( ) , 
 w . getNick ( ) , 
 about , 
 - w . getExternal ( ) ) ; 
 + w . getExternal ( ) , 
 + w . getPreferredLanguages ( ) , 
 + w . getTimeZone ( ) ) ; 
 res . setUnmappedObjects ( w . getUnmappedObjects ( ) ) ; 
 return new User ( res ) ; 
 } 
 @ @ - 222 , 7 + 230 , 9 @ @ public class User extends WrapperEntity < ApiUser > implements KeyValueItem { 
 w . isBot ( ) , 
 w . getNick ( ) , 
 w . getAbout ( ) , 
 - w . getExternal ( ) ) ; 
 + w . getExternal ( ) , 
 + w . getPreferredLanguages ( ) , 
 + w . getTimeZone ( ) ) ; 
 res . setUnmappedObjects ( w . getUnmappedObjects ( ) ) ; 
 return new User ( res ) ; 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / Authentication . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / Authentication . java 
 index 2f83c05 . . 8a0b75a 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / Authentication . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / Authentication . java 
 @ @ - 118 , 7 + 118 , 8 @ @ public class Authentication { 
 apiConfiguration . getAppId ( ) , 
 apiConfiguration . getAppKey ( ) , 
 deviceHash , 
 - apiConfiguration . getDeviceTitle ( ) 
 + apiConfiguration . getDeviceTitle ( ) , 
 + null , new ArrayList < String > ( ) 
 ) , new RpcCallback < ResponseStartEmailAuth > ( ) { 
 @ Override 
 public void onResult ( ResponseStartEmailAuth response ) { 
 @ @ - 163 , 7 + 164 , 8 @ @ public class Authentication { 
 apiConfiguration . getAppId ( ) , 
 apiConfiguration . getAppKey ( ) , 
 deviceHash , 
 - apiConfiguration . getDeviceTitle ( ) 
 + apiConfiguration . getDeviceTitle ( ) , 
 + null , new ArrayList < String > ( ) 
 ) , new RpcCallback < ResponseStartPhoneAuth > ( ) { 
 @ Override 
 public void onResult ( ResponseStartPhoneAuth response ) { 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java 
 index 11630f1 . . bfbd171 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java 
 @ @ - 288 , 6 + 288 , 8 @ @ public class MessagesModule extends AbsModule implements BusSubscriber { 
 
 public void sendMessage ( @ NotNull Peer peer , @ NotNull String message , @ Nullable String markDownText , 
 @ Nullable ArrayList < Integer > mentions , boolean autoDetect ) { 
 + / / Notify typing about message sent 
 + context ( ) . getTypingModule ( ) . onMessageSent ( peer ) ; 
 sendMessageActor . send ( new SenderActor . SendText ( peer , message , markDownText , mentions , 
 autoDetect ) ) ; 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / TypingModule . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / TypingModule . java 
 index 72ce08e . . c867fb0 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / TypingModule . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / TypingModule . java 
 @ @ - 51 , 6 + 51 , 10 @ @ public class TypingModule extends AbsModule { 
 ownTypingActor . send ( new OwnTypingActor . Typing ( peer ) ) ; 
 } 
 
 + public void onMessageSent ( Peer peer ) { 
 + ownTypingActor . send ( new OwnTypingActor . MessageSent ( peer ) ) ; 
 + } 
 + 
 public void resetModule ( ) { 
 / / TODO : Implement 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / typing / OwnTypingActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / typing / OwnTypingActor . java 
 index 341880a . . faf08d0 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / typing / OwnTypingActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / typing / OwnTypingActor . java 
 @ @ - 6 , 6 + 6 , 7 @ @ package im . actor . core . modules . internal . typing ; 
 
 import im . actor . core . api . ApiOutPeer ; 
 import im . actor . core . api . ApiTypingType ; 
 + import im . actor . core . api . rpc . RequestStopTyping ; 
 import im . actor . core . api . rpc . RequestTyping ; 
 import im . actor . core . entity . Peer ; 
 import im . actor . core . modules . ModuleContext ; 
 @ @ - 30 , 9 + 31 , 12 @ @ public class OwnTypingActor extends ModuleActor { 
 } 
 
 private static final long TYPING _ DELAY = 3000L ; 
 + private static final long TYPING _ CANCEL _ DELAY = 4000L ; 
 
 private long lastTypingTime = 0 ; 
 
 + private long prevRid = 0 ; 
 + 
 @ Verified 
 public OwnTypingActor ( ModuleContext messenger ) { 
 super ( messenger ) ; 
 @ @ - 50 , 7 + 54 , 31 @ @ public class OwnTypingActor extends ModuleActor { 
 return ; 
 } 
 
 - request ( new RequestTyping ( outPeer , ApiTypingType . TEXT ) ) ; 
 + cancelPrevRequest ( ) ; 
 + prevRid = request ( new RequestTyping ( outPeer , ApiTypingType . TEXT ) ) ; 
 + self ( ) . sendOnce ( new AbortTyping ( peer ) , TYPING _ CANCEL _ DELAY ) ; 
 + } 
 + 
 + private void onMessageSent ( Peer peer ) { 
 + cancelPrevRequest ( ) ; 
 + lastTypingTime = 0 ; 
 + self ( ) . sendOnce ( new AbortTyping ( peer ) , 24 * 60 * 60 * 1000L ) ; 
 + } 
 + 
 + private void onAbortTyping ( Peer peer ) { 
 + ApiOutPeer outPeer = buidOutPeer ( peer ) ; 
 + if ( outPeer = = null ) { 
 + return ; 
 + } 
 + cancelPrevRequest ( ) ; 
 + prevRid = request ( new RequestStopTyping ( outPeer , ApiTypingType . TEXT ) ) ; 
 + } 
 + 
 + private void cancelPrevRequest ( ) { 
 + if ( prevRid ! = 0 ) { 
 + cancelRequest ( prevRid ) ; 
 + prevRid = 0 ; 
 + } 
 } 
 
 / / Messages 
 @ @ - 59 , 11 + 87 , 27 @ @ public class OwnTypingActor extends ModuleActor { 
 public void onReceive ( Object message ) { 
 if ( message instanceof Typing ) { 
 onTyping ( ( ( Typing ) message ) . getPeer ( ) ) ; 
 + } else if ( message instanceof MessageSent ) { 
 + onMessageSent ( ( ( MessageSent ) message ) . getPeer ( ) ) ; 
 + } else if ( message instanceof AbortTyping ) { 
 + onAbortTyping ( ( ( AbortTyping ) message ) . getPeer ( ) ) ; 
 } else { 
 drop ( message ) ; 
 } 
 } 
 
 + private static class AbortTyping { 
 + private Peer peer ; 
 + 
 + public AbortTyping ( Peer peer ) { 
 + this . peer = peer ; 
 + } 
 + 
 + public Peer getPeer ( ) { 
 + return peer ; 
 + } 
 + } 
 + 
 public static class Typing { 
 private Peer peer ; 
 
 @ @ - 75 , 4 + 119 , 17 @ @ public class OwnTypingActor extends ModuleActor { 
 return peer ; 
 } 
 } 
 + 
 + public static class MessageSent { 
 + 
 + private Peer peer ; 
 + 
 + public MessageSent ( Peer peer ) { 
 + this . peer = peer ; 
 + } 
 + 
 + public Peer getPeer ( ) { 
 + return peer ; 
 + } 
 + } 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / updates / TypingProcessor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / updates / TypingProcessor . java 
 index ace0a50 . . 674756e 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / updates / TypingProcessor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / updates / TypingProcessor . java 
 @ @ - 32 , 8 + 32 , 18 @ @ public class TypingProcessor extends AbsModule { 
 } 
 } 
 
 + @ Verified 
 public void onTypingStop ( ApiPeer peer , int uid , ApiTypingType typingType ) { 
 - 
 + / / Other types are unsupported 
 + / / TODO : Move to Actor 
 + if ( typingType ! = ApiTypingType . TEXT ) { 
 + return ; 
 + } 
 + if ( peer . getType ( ) = = ApiPeerType . PRIVATE ) { 
 + typingActor . sendOnce ( new TypingActor . StopTyping ( uid ) ) ; 
 + } else if ( peer . getType ( ) = = ApiPeerType . GROUP ) { 
 + typingActor . sendOnce ( new TypingActor . StopGroupTyping ( peer . getId ( ) , uid ) ) ; 
 + } 
 } 
 
 @ Verified 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / updates / UpdateProcessor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / updates / UpdateProcessor . java 
 index 8a2998c . . ab71f3a 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / updates / UpdateProcessor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / updates / UpdateProcessor . java 
 @ @ - 40 , 6 + 40 , 7 @ @ import im . actor . core . api . updates . UpdateMessageReceived ; 
 import im . actor . core . api . updates . UpdateMessageSent ; 
 import im . actor . core . api . updates . UpdateParameterChanged ; 
 import im . actor . core . api . updates . UpdateTyping ; 
 + import im . actor . core . api . updates . UpdateTypingStop ; 
 import im . actor . core . api . updates . UpdateUserLastSeen ; 
 import im . actor . core . api . updates . UpdateUserLocalNameChanged ; 
 import im . actor . core . api . updates . UpdateUserOffline ; 
 @ @ - 198 , 6 + 199 , 9 @ @ public class UpdateProcessor extends AbsModule { 
 } else if ( update instanceof UpdateTyping ) { 
 UpdateTyping typing = ( UpdateTyping ) update ; 
 typingProcessor . onTyping ( typing . getPeer ( ) , typing . getUid ( ) , typing . getTypingType ( ) ) ; 
 + } else if ( update instanceof UpdateTypingStop ) { 
 + UpdateTypingStop typing = ( UpdateTypingStop ) update ; 
 + typingProcessor . onTypingStop ( typing . getPeer ( ) , typing . getUid ( ) , typing . getTypingType ( ) ) ; 
 } 
 } 
 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / utils / ModuleActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / utils / ModuleActor . java 
 index 67b681e . . 072af9f 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / utils / ModuleActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / utils / ModuleActor . java 
 @ @ - 130 , 8 + 130 , 8 @ @ public class ModuleActor extends Actor implements BusSubscriber { 
 return context ; 
 } 
 
 - public < T extends Response > void request ( Request < T > request ) { 
 - request ( request , new RpcCallback < T > ( ) { 
 + public < T extends Response > long request ( Request < T > request ) { 
 + return request ( request , new RpcCallback < T > ( ) { 
 @ Override 
 public void onResult ( T response ) { 
 
 @ @ - 144 , 8 + 144 , 8 @ @ public class ModuleActor extends Actor implements BusSubscriber { 
 } ) ; 
 } 
 
 - public < T extends Response > void request ( final Request < T > request , final RpcCallback < T > callback ) { 
 - context . getActorApi ( ) . request ( request , new RpcCallback < T > ( ) { 
 + public < T extends Response > long request ( final Request < T > request , final RpcCallback < T > callback ) { 
 + return context . getActorApi ( ) . request ( request , new RpcCallback < T > ( ) { 
 @ Override 
 public void onResult ( final T response ) { 
 self ( ) . send ( new Runnable ( ) { 
 @ @ - 178 , 6 + 178 , 10 @ @ public class ModuleActor extends Actor implements BusSubscriber { 
 } ) ; 
 } 
 
 + public void cancelRequest ( long rid ) { 
 + context . getActorApi ( ) . cancelRequest ( rid ) ; 
 + } 
 + 
 @ Override 
 public void onBusEvent ( Event event ) { 
 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / network / ActorApi . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / network / ActorApi . java 
 index a019d60 . . acfcafa 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / network / ActorApi . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / network / ActorApi . java 
 @ @ - 11 , 6 + 11 , 7 @ @ import im . actor . core . network . api . ApiBroker ; 
 import im . actor . core . network . parser . Request ; 
 import im . actor . core . network . parser . Response ; 
 import im . actor . runtime . threading . AtomicIntegerCompat ; 
 + import im . actor . runtime . threading . AtomicLongCompat ; 
 
 / * * 
 * Actor API Object for connecting to Actor ' s servers 
 @ @ - 22 , 6 + 23 , 7 @ @ public class ActorApi { 
 public static final int API _ MINOR _ VERSION = ApiVersion . VERSION _ MINOR ; 
 
 private static final AtomicIntegerCompat NEXT _ ID = im . actor . runtime . Runtime . createAtomicInt ( 1 ) ; 
 + private static final AtomicLongCompat NEXT _ RPC _ ID = im . actor . runtime . Runtime . createAtomicLong ( 1 ) ; 
 
 private final Endpoints endpoints ; 
 private final AuthKeyStorage keyStorage ; 
 @ @ - 62 , 13 + 64 , 24 @ @ public class ActorApi { 
 * @ param request request body 
 * @ param callback request callback 
 * @ param < T > type of response 
 + * @ return rid of request 
 * / 
 - public synchronized < T extends Response > void request ( Request < T > request , RpcCallback < T > callback ) { 
 + public synchronized < T extends Response > long request ( Request < T > request , RpcCallback < T > callback ) { 
 if ( request = = null ) { 
 throw new RuntimeException ( " Request can ' t be null " ) ; 
 } 
 + long rid = NEXT _ RPC _ ID . incrementAndGet ( ) ; 
 + this . apiBroker . send ( new ApiBroker . PerformRequest ( rid , request , callback ) ) ; 
 + return rid ; 
 + } 
 
 - this . apiBroker . send ( new ApiBroker . PerformRequest ( request , callback ) ) ; 
 + / * * 
 + * Cancelling API Request 
 + * 
 + * @ param rid request rid 
 + * / 
 + public synchronized void cancelRequest ( long rid ) { 
 + this . apiBroker . send ( new ApiBroker . CancelRequest ( rid ) ) ; 
 } 
 
 / * * 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / network / api / ApiBroker . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / network / api / ApiBroker . java 
 index 207ffca . . 06f4742 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / network / api / ApiBroker . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / network / api / ApiBroker . java 
 @ @ - 60 , 7 + 60 , 7 @ @ public class ApiBroker extends Actor { 
 } 
 
 private static final String TAG = " ApiBroker " ; 
 - private static final AtomicLongCompat NEXT _ RPC _ ID = im . actor . runtime . Runtime . createAtomicLong ( 1 ) ; 
 + 
 private static final AtomicIntegerCompat NEXT _ PROTO _ ID = im . actor . runtime . Runtime . createAtomicInt ( 1 ) ; 
 
 private final Endpoints endpoints ; 
 @ @ - 360 , 14 + 360 , 21 @ @ public class ApiBroker extends Actor { 
 } 
 
 public static class PerformRequest { 
 + 
 private Request message ; 
 private RpcCallback callback ; 
 + private long rid ; 
 
 - public PerformRequest ( Request message , RpcCallback callback ) { 
 + public PerformRequest ( long rid , Request message , RpcCallback callback ) { 
 + this . rid = rid ; 
 this . message = message ; 
 this . callback = callback ; 
 } 
 
 + public long getRid ( ) { 
 + return rid ; 
 + } 
 + 
 public Request getMessage ( ) { 
 return message ; 
 } 
 @ @ - 577 , 8 + 584 , 7 @ @ public class ApiBroker extends Actor { 
 createMtProto ( initMTProto . getAuthId ( ) ) ; 
 } else if ( message instanceof PerformRequest ) { 
 PerformRequest request = ( PerformRequest ) message ; 
 - performRequest ( NEXT _ RPC _ ID . getAndIncrement ( ) , 
 - request . getMessage ( ) , request . getCallback ( ) ) ; 
 + performRequest ( request . getRid ( ) , request . getMessage ( ) , request . getCallback ( ) ) ; 
 } else if ( message instanceof CancelRequest ) { 
 CancelRequest cancelRequest = ( CancelRequest ) message ; 
 cancelRequest ( cancelRequest . getRandomId ( ) ) ; 
 diff - - git a / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / bser / BserWriter . java b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / bser / BserWriter . java 
 index f203ad1 . . 6aee0c3 100755 
 - - - a / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / bser / BserWriter . java 
 + + + b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / bser / BserWriter . java 
 @ @ - 116 , 6 + 116 , 22 @ @ public class BserWriter { 
 } 
 } 
 
 + public void writeRepeatedString ( int fieldNumber , @ NotNull List < String > values ) throws IOException { 
 + if ( values = = null ) { 
 + throw new IllegalArgumentException ( " Values can not be null " ) ; 
 + } 
 + if ( values . size ( ) > BserLimits . MAX _ PROTO _ REPEATED ) { 
 + throw new IllegalArgumentException ( " Too many values " ) ; 
 + } 
 + writtenFields . put ( fieldNumber , true ) ; 
 + for ( String l : values ) { 
 + if ( l = = null ) { 
 + throw new IllegalArgumentException ( " Value can not be null " ) ; 
 + } 
 + writeString ( fieldNumber , l ) ; 
 + } 
 + } 
 + 
 public void writeRepeatedBytes ( int fieldNumber , @ NotNull List < byte [ ] > values ) throws IOException { 
 if ( values = = null ) { 
 throw new IllegalArgumentException ( " Values can not be null " ) ;
