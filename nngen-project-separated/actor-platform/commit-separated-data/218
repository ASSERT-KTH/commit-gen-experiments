BLEU SCORE: 0.345720784641941

TEST MSG: fix ( android ) : faster gallery scanner
GENERATED MSG: refactor ( android ) : GalleryScannerActor

TEST DIFF (one line): diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / AndroidManifest . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / AndroidManifest . xml < nl > index 73b6404 . . 343b5e3 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / AndroidManifest . xml < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / AndroidManifest . xml < nl > @ @ - 247 , 7 + 247 , 6 @ @ < nl > android : theme = " @ style / CommonActivityTheme " < nl > android : windowSoftInputMode = " adjustResize " / > < nl > < nl > - < nl > < ! - - Actions - - > < nl > < activity < nl > android : name = " . controllers . settings . EditNameActivity " < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java < nl > index 8e39e1a . . 3b01739 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java < nl > @ @ - 811 , 6 + 811 , 9 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > checkEmptyBot ( ) ; < nl > } < nl > < nl > + if ( isShareVisible ) { < nl > + messenger ( ) . getGalleryScannerActor ( ) . send ( new GalleryScannerActor . Show ( ) ) ; < nl > + } < nl > < nl > } < nl > < nl > @ @ - 949 , 7 + 952 , 7 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > AudioHolder . stopPlaying ( ) ; < nl > / / Saving draft < nl > messenger ( ) . saveDraft ( peer , messageEditText . getText ( ) . toString ( ) ) ; < nl > - < nl > + messenger ( ) . getGalleryScannerActor ( ) . send ( new GalleryScannerActor . Hide ( ) ) ; < nl > } < nl > < nl > / / Message send < nl > diff - - git a / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java b / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java < nl > index ae014c0 . . d525e76 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java < nl > @ @ - 5 , 13 + 5 , 15 @ @ import android . database . Cursor ; < nl > import android . graphics . Bitmap ; < nl > import android . graphics . BitmapFactory ; < nl > import android . net . Uri ; < nl > + import android . os . Environment ; < nl > import android . provider . MediaStore ; < nl > < nl > import java . util . ArrayList ; < nl > - < nl > + import java . util . HashMap ; < nl > import im . actor . core . viewmodel . GalleryVM ; < nl > import im . actor . runtime . Log ; < nl > import im . actor . runtime . actors . Actor ; < nl > + import im . actor . runtime . collections . SparseArray ; < nl > < nl > public class GalleryScannerActor extends Actor { < nl > < nl > @ @ - 22 , 7 + 24 , 7 @ @ public class GalleryScannerActor extends Actor { < nl > Uri uri ; < nl > Cursor cursor ; < nl > int offset = 0 ; < nl > - int column _ index _ data , column _ index _ folder _ name , column _ index _ date ; < nl > + int column _ index _ data , column _ index _ folder _ name , column _ index _ date , column _ index _ id , column _ index _ folder _ id ; < nl > < nl > ArrayList < String > listOfAllImages = new ArrayList < > ( ) ; < nl > ArrayList < String > newMedia = new ArrayList < > ( ) ; < nl > @ @ - 50 , 15 + 52 , 19 @ @ public class GalleryScannerActor extends Actor { < nl > < nl > private void initScan ( ) { < nl > Log . d ( TAG , " init scan " ) ; < nl > - projection = new String [ ] { MediaStore . MediaColumns . DATA , < nl > + projection = new String [ ] { MediaStore . Images . Media . DATA , < nl > + MediaStore . Images . Media . _ ID , < nl > + MediaStore . Images . Media . BUCKET _ ID , < nl > MediaStore . Images . Media . BUCKET _ DISPLAY _ NAME , < nl > - MediaStore . Images . Media . DATE _ MODIFIED } ; < nl > + MediaStore . Images . Media . DATE _ TAKEN } ; < nl > < nl > cursor = getQuery ( ) ; < nl > < nl > if ( cursor ! = null & & cursor . getCount ( ) > 0 ) { < nl > - column _ index _ data = cursor . getColumnIndexOrThrow ( MediaStore . MediaColumns . DATA ) ; < nl > - column _ index _ date = cursor . getColumnIndexOrThrow ( MediaStore . MediaColumns . DATE _ MODIFIED ) ; < nl > + column _ index _ data = cursor . getColumnIndexOrThrow ( MediaStore . Images . Media . DATA ) ; < nl > + column _ index _ id = cursor . getColumnIndexOrThrow ( MediaStore . Images . Media . _ ID ) ; < nl > + column _ index _ folder _ id = cursor . getColumnIndexOrThrow ( MediaStore . Images . Media . BUCKET _ ID ) ; < nl > + column _ index _ date = cursor . getColumnIndexOrThrow ( MediaStore . Images . Media . DATE _ TAKEN ) ; < nl > column _ index _ folder _ name = cursor < nl > . getColumnIndexOrThrow ( MediaStore . Images . Media . BUCKET _ DISPLAY _ NAME ) ; < nl > < nl > @ @ - 68 , 7 + 74 , 9 @ @ public class GalleryScannerActor extends Actor { < nl > self ( ) . send ( new Scan ( ) ) ; < nl > } else { < nl > Log . d ( TAG , " init scan - no media , let ' s check it in " + CHECK _ NEW _ DELAY ) ; < nl > - schedule ( new InitScan ( ) , CHECK _ NEW _ DELAY ) ; < nl > + if ( visible ) { < nl > + schedule ( new InitScan ( ) , CHECK _ NEW _ DELAY ) ; < nl > + } < nl > } < nl > < nl > } < nl > @ @ - 76 , 7 + 84 , 7 @ @ public class GalleryScannerActor extends Actor { < nl > private Cursor getQuery ( ) { < nl > try { < nl > return context . getContentResolver ( ) . query ( uri , projection , null , < nl > - null , MediaStore . MediaColumns . DATE _ MODIFIED + " DESC " ) ; < nl > + null , MediaStore . Images . Media . DATE _ TAKEN + " DESC " ) ; < nl > } catch ( Exception e ) { < nl > return null ; < nl > } < nl > @ @ - 92 , 19 + 100 , 23 @ @ public class GalleryScannerActor extends Actor { < nl > } < nl > < nl > offset + = SCAN _ COUNT ; < nl > - if ( offset < cursor . getCount ( ) ) { < nl > - Log . d ( TAG , " scan - iterations , offset - " + offset + " , schedule next in " + SCAN _ DELAY ) ; < nl > - schedule ( new Scan ( ) , SCAN _ DELAY ) ; < nl > - } else { < nl > - Log . d ( TAG , " scanned to end , offset - " + offset + " , schedule check new in " + CHECK _ NEW _ DELAY ) ; < nl > - scanned = true ; < nl > - schedule ( new CheckNew ( ) , CHECK _ NEW _ DELAY ) ; < nl > - } < nl > + scanned = offset > = cursor . getCount ( ) ; < nl > < nl > - if ( offset % 100 = = 0 | | scanned ) { < nl > + / / < nl > + / / Update VM after 1st batch , every 100 photos , when scanned to end < nl > + / / < nl > + if ( offset = = SCAN _ COUNT | | offset % 100 = = 0 | | scanned ) { < nl > Log . d ( TAG , " scan - update vm , offset - " + offset ) ; < nl > galleryVM . getGalleryMediaPath ( ) . change ( new ArrayList < String > ( listOfAllImages ) ) ; < nl > } < nl > + < nl > + if ( visible ) { < nl > + if ( ! scanned ) { < nl > + schedule ( new Scan ( ) , SCAN _ DELAY ) ; < nl > + } else { < nl > + schedule ( new CheckNew ( ) , CHECK _ NEW _ DELAY ) ; < nl > + } < nl > + } < nl > } < nl > < nl > private void checkNew ( ) { < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / GalleryVM . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / GalleryVM . java < nl > index 9a3eb07 . . 660001d 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / GalleryVM . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / GalleryVM . java < nl > @ @ - 1 , 8 + 1 , 6 @ @ < nl > package im . actor . core . viewmodel ; < nl > < nl > import java . util . ArrayList ; < nl > - < nl > - import im . actor . core . entity . StickerPack ; < nl > import im . actor . runtime . mvvm . ValueModel ; < nl > < nl > public class GalleryVM {
NEAREST DIFF (one line): diff - - git a / actor - sdk / sdk - core - android / android - app / src / main / java / im / actor / Application . java b / actor - sdk / sdk - core - android / android - app / src / main / java / im / actor / Application . java < nl > index 5446f7a . . 091801e 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - app / src / main / java / im / actor / Application . java < nl > + + + b / actor - sdk / sdk - core - android / android - app / src / main / java / im / actor / Application . java < nl > @ @ - 33 , 6 + 33 , 8 @ @ public class Application extends ActorSDKApplication { < nl > < nl > ActorStyle style = ActorSDK . sharedActor ( ) . style ; < nl > style . setDialogsActiveTextColor ( 0xff5882ac ) ; < nl > + < nl > + ActorSDK . sharedActor ( ) . setFastShareEnabled ( true ) ; < nl > / / ActorSDK . sharedActor ( ) . setTwitter ( " " ) ; < nl > / / ActorSDK . sharedActor ( ) . setHomePage ( " http : / / www . foo . com " ) ; < nl > / / ActorSDK . sharedActor ( ) . setInviteUrl ( " http : / / www . foo . com " ) ; < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / ActorSDK . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / ActorSDK . java < nl > index 516b460 . . 8e7c65f 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / ActorSDK . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / ActorSDK . java < nl > @ @ - 574 , 7 + 574 , 7 @ @ public class ActorSDK { < nl > * @ param fastShareEnabled < nl > * / < nl > public void setFastShareEnabled ( boolean fastShareEnabled ) { < nl > - this . fastShareEnabled = this . fastShareEnabled ; < nl > + this . fastShareEnabled = fastShareEnabled ; < nl > } < nl > < nl > / * * < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java < nl > index 3e6ba78 . . 320137d 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java < nl > @ @ - 6 , 7 + 6 , 6 @ @ import android . app . AlertDialog ; < nl > import android . content . Context ; < nl > import android . content . DialogInterface ; < nl > import android . content . Intent ; < nl > - import android . content . pm . ApplicationInfo ; < nl > import android . content . pm . PackageManager ; < nl > import android . content . res . Configuration ; < nl > import android . database . Cursor ; < nl > @ @ - 38 , 7 + 37 , 6 @ @ import android . view . animation . AlphaAnimation ; < nl > import android . view . animation . Animation ; < nl > import android . view . animation . TranslateAnimation ; < nl > import android . widget . AdapterView ; < nl > - import android . widget . Button ; < nl > import android . widget . FrameLayout ; < nl > import android . widget . ImageButton ; < nl > import android . widget . ImageView ; < nl > @ @ - 302 , 6 + 300 , 7 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > < nl > / / share menu < nl > findViewById ( R . id . share _ menu ) . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainBackgroundColor ( ) ) ; < nl > + findViewById ( R . id . fast _ share ) . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainBackgroundColor ( ) ) ; < nl > shareMenu = findViewById ( R . id . share _ container ) ; < nl > shareMenu . setOnClickListener ( new View . OnClickListener ( ) { < nl > @ Override < nl > @ @ - 1433 , 7 + 1432 , 7 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > shareMenu . setVisibility ( View . VISIBLE ) ; < nl > isShareVisible = true ; < nl > if ( ActorSDK . sharedActor ( ) . isFastShareEnabled ( ) ) { < nl > - messenger ( ) . getGalleryScannerActor ( ) . send ( new GalleryScannerActor . Visible ( true ) ) ; < nl > + messenger ( ) . getGalleryScannerActor ( ) . send ( new GalleryScannerActor . Show ( ) ) ; < nl > } < nl > } < nl > < nl > @ @ - 1452 , 7 + 1451 , 7 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > shareMenu . setVisibility ( View . GONE ) ; < nl > shareContainer . setVisibility ( View . GONE ) ; < nl > if ( ActorSDK . sharedActor ( ) . isFastShareEnabled ( ) ) { < nl > - messenger ( ) . getGalleryScannerActor ( ) . send ( new GalleryScannerActor . Visible ( false ) ) ; < nl > + messenger ( ) . getGalleryScannerActor ( ) . send ( new GalleryScannerActor . Hide ( ) ) ; < nl > } < nl > < nl > } < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / activity _ dialog . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / activity _ dialog . xml < nl > index 9dc67c7 . . 7c7230f 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / activity _ dialog . xml < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / activity _ dialog . xml < nl > @ @ - 95 , 6 + 95 , 11 @ @ < nl > android : scaleType = " fitXY " < nl > android : src = " @ drawable / conv _ field _ shadow " / > < nl > < nl > + < android . support . v7 . widget . RecyclerView < nl > + android : id = " @ + id / fast _ share " < nl > + android : layout _ width = " match _ parent " < nl > + android : layout _ height = " @ dimen / fast _ share _ size " / > < nl > + < nl > < TableLayout < nl > android : id = " @ + id / share _ menu " < nl > android : paddingTop = " 5dp " < nl > @ @ - 106 , 15 + 111 , 6 @ @ < nl > < nl > < TableRow > < nl > < nl > - < android . support . v7 . widget . RecyclerView < nl > - android : id = " @ + id / fast _ share " < nl > - android : layout _ width = " 0dp " < nl > - android : layout _ weight = " 1 " < nl > - android : layout _ height = " @ dimen / fast _ share _ size " / > < nl > - < / TableRow > < nl > - < nl > - < TableRow > < nl > - < nl > < LinearLayout < nl > android : gravity = " center _ horizontal " < nl > android : layout _ width = " wrap _ content " < nl > diff - - git a / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java b / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java < nl > index 8b29b71 . . 6d0acc9 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java < nl > @ @ - 1 , 19 + 1 , 14 @ @ < nl > package im . actor . core . utils ; < nl > < nl > - import android . content . BroadcastReceiver ; < nl > import android . content . Context ; < nl > - import android . content . Intent ; < nl > - import android . content . IntentFilter ; < nl > import android . database . Cursor ; < nl > import android . graphics . Bitmap ; < nl > import android . graphics . BitmapFactory ; < nl > import android . net . Uri ; < nl > import android . provider . MediaStore ; < nl > < nl > - import java . io . File ; < nl > import java . util . ArrayList ; < nl > < nl > - import im . actor . core . utils . ImageHelper ; < nl > import im . actor . core . viewmodel . GalleryVM ; < nl > import im . actor . runtime . Log ; < nl > import im . actor . runtime . actors . Actor ; < nl > @ @ - 29 , 18 + 24 , 19 @ @ public class GalleryScannerActor extends Actor { < nl > int offset = 0 ; < nl > int column _ index _ data , column _ index _ folder _ name , column _ index _ date ; < nl > < nl > - ArrayList < String > listOfAllImages = new ArrayList < String > ( ) ; < nl > + ArrayList < String > listOfAllImages = new ArrayList < > ( ) ; < nl > ArrayList < String > newMedia = new ArrayList < > ( ) ; < nl > < nl > String absolutePathOfImage = null ; < nl > GalleryVM galleryVM ; < nl > < nl > - private static final int SCAN _ COUNT = 9 ; < nl > + private static final int SCAN _ COUNT = 10 ; < nl > < nl > - ArrayList < String > loaded = new ArrayList < > ( ) ; < nl > private boolean visible = false ; < nl > private boolean scanned = false ; < nl > private String [ ] projection ; < nl > + private boolean inited = false ; < nl > + private Bitmap bitmap ; < nl > < nl > public GalleryScannerActor ( Context context , GalleryVM galleryVM ) { < nl > this . context = context ; < nl > @ @ - 52 , 7 + 48 , 7 @ @ public class GalleryScannerActor extends Actor { < nl > uri = android . provider . MediaStore . Images . Media . EXTERNAL _ CONTENT _ URI ; < nl > } < nl > < nl > - public void initScan ( ) { < nl > + private void initScan ( ) { < nl > Log . d ( TAG , " init scan " ) ; < nl > projection = new String [ ] { MediaStore . MediaColumns . DATA , < nl > MediaStore . Images . Media . BUCKET _ DISPLAY _ NAME , < nl > @ @ - 68 , 6 + 64 , 7 @ @ public class GalleryScannerActor extends Actor { < nl > < nl > < nl > Log . d ( TAG , " init scan ok - starting scan iterations " ) ; < nl > + inited = true ; < nl > self ( ) . send ( new Scan ( ) ) ; < nl > } else { < nl > Log . d ( TAG , " init scan - no media , let ' s check it in " + CHECK _ NEW _ DELAY ) ; < nl > @ @ - 76 , 7 + 73 , 7 @ @ public class GalleryScannerActor extends Actor { < nl > < nl > } < nl > < nl > - public Cursor getQuery ( ) { < nl > + private Cursor getQuery ( ) { < nl > return context . getContentResolver ( ) . query ( uri , projection , null , < nl > null , MediaStore . MediaColumns . DATE _ MODIFIED + " DESC " ) ; < nl > } < nl > @ @ - 84 , 50 + 81 , 53 @ @ public class GalleryScannerActor extends Actor { < nl > private void scan ( ) { < nl > < nl > Log . d ( TAG , " scan " ) ; < nl > - int i = 0 ; < nl > - while ( offset + i + + < offset + SCAN _ COUNT & & cursor . moveToNext ( ) ) { < nl > - absolutePathOfImage = cursor . getString ( column _ index _ data ) ; < nl > < nl > + for ( int i = 0 ; i < = SCAN _ COUNT & & cursor . moveToNext ( ) ; i + + ) { < nl > + absolutePathOfImage = cursor . getString ( column _ index _ data ) ; < nl > listOfAllImages . add ( absolutePathOfImage ) ; < nl > } < nl > - boolean added = false ; < nl > - if ( offset % 100 = = 0 ) { < nl > - Log . d ( TAG , " scan - update vm , offset - " + offset ) ; < nl > - galleryVM . getGalleryMediaPath ( ) . change ( new ArrayList < String > ( listOfAllImages ) ) ; < nl > - added = true ; < nl > - } < nl > - offset + = i ; < nl > + < nl > + offset + = SCAN _ COUNT ; < nl > if ( offset < cursor . getCount ( ) ) { < nl > - Log . d ( TAG , " scan - " + i + " iterations , offset - " + offset + " , schedule next in " + SCAN _ DELAY ) ; < nl > + Log . d ( TAG , " scan - iterations , offset - " + offset + " , schedule next in " + SCAN _ DELAY ) ; < nl > schedule ( new Scan ( ) , SCAN _ DELAY ) ; < nl > } else { < nl > - if ( ! added ) { < nl > - galleryVM . getGalleryMediaPath ( ) . change ( new ArrayList < String > ( listOfAllImages ) ) ; < nl > - } < nl > Log . d ( TAG , " scanned to end , offset - " + offset + " , schedule check new in " + CHECK _ NEW _ DELAY ) ; < nl > scanned = true ; < nl > schedule ( new CheckNew ( ) , CHECK _ NEW _ DELAY ) ; < nl > } < nl > + < nl > + if ( offset % 100 = = 0 | | scanned ) { < nl > + Log . d ( TAG , " scan - update vm , offset - " + offset ) ; < nl > + galleryVM . getGalleryMediaPath ( ) . change ( new ArrayList < String > ( listOfAllImages ) ) ; < nl > + } < nl > } < nl > < nl > private void checkNew ( ) { < nl > Log . d ( TAG , " checkNew " ) ; < nl > cursor = getQuery ( ) ; < nl > newMedia . clear ( ) ; < nl > + boolean firstCycle = true ; < nl > while ( cursor ! = null & & cursor . moveToNext ( ) ) { < nl > absolutePathOfImage = cursor . getString ( column _ index _ data ) ; < nl > if ( ! listOfAllImages . contains ( absolutePathOfImage ) ) { < nl > - Bitmap bitmap = ImageHelper . loadOptimizedHQ ( absolutePathOfImage ) ; < nl > - if ( bitmap ! = null ) { < nl > - bitmap . recycle ( ) ; < nl > - newMedia . add ( absolutePathOfImage ) ; < nl > - Log . d ( TAG , " checkNew - new media " ) ; < nl > - < nl > + if ( firstCycle ) { < nl > + firstCycle = false ; < nl > + bitmap = BitmapFactory . decodeFile ( absolutePathOfImage ) ; < nl > + if ( bitmap ! = null ) { < nl > + bitmap . recycle ( ) ; < nl > + newMedia . add ( absolutePathOfImage ) ; < nl > + Log . d ( TAG , " checkNew - new media " ) ; < nl > + < nl > + } else { < nl > + Log . d ( TAG , " checkNew - new media writing , breaking for wait " ) ; < nl > + < nl > + break ; < nl > + } < nl > } else { < nl > - Log . d ( TAG , " checkNew - new media writing , breaking for wait " ) ; < nl > - < nl > - break ; < nl > + newMedia . add ( absolutePathOfImage ) ; < nl > } < nl > + < nl > } else { < nl > Log . d ( TAG , " checkNew - found old media , break " ) ; < nl > < nl > @ @ - 136 , 13 + 136 , 11 @ @ public class GalleryScannerActor extends Actor { < nl > } < nl > if ( newMedia . size ( ) > 0 ) { < nl > listOfAllImages . addAll ( 0 , newMedia ) ; < nl > - galleryVM . getGalleryMediaPath ( ) . change ( new ArrayList < String > ( listOfAllImages ) ) ; < nl > + galleryVM . getGalleryMediaPath ( ) . change ( new ArrayList < > ( listOfAllImages ) ) ; < nl > Log . d ( TAG , " checkNew - new media add - " + newMedia . size ( ) ) ; < nl > - < nl > } < nl > if ( visible ) { < nl > Log . d ( TAG , " checkNew - visible , schedule next check in " + CHECK _ NEW _ DELAY ) ; < nl > - < nl > schedule ( new CheckNew ( ) , CHECK _ NEW _ DELAY ) ; < nl > } < nl > } < nl > @ @ - 155 , 17 + 153 , 17 @ @ public class GalleryScannerActor extends Actor { < nl > initScan ( ) ; < nl > } else if ( message instanceof CheckNew ) { < nl > checkNew ( ) ; < nl > - } else if ( message instanceof Visible ) { < nl > - if ( ( ( Visible ) message ) . isVisible ( ) ) { < nl > - visible = true ; < nl > - if ( scanned ) { < nl > - self ( ) . send ( new CheckNew ( ) ) ; < nl > - } else { < nl > + } else if ( message instanceof Show ) { < nl > + visible = true ; < nl > + if ( scanned ) { < nl > + self ( ) . send ( new CheckNew ( ) ) ; < nl > + } else { < nl > + if ( ! inited ) { < nl > self ( ) . send ( new InitScan ( ) ) ; < nl > } < nl > - } else { < nl > - visible = false ; < nl > } < nl > + } else if ( message instanceof Hide ) { < nl > + visible = false ; < nl > } < nl > } < nl > < nl > @ @ - 181 , 15 + 179 , 11 @ @ public class GalleryScannerActor extends Actor { < nl > < nl > } < nl > < nl > - public static class Visible { < nl > - boolean visible ; < nl > + public static class Show { < nl > < nl > - public Visible ( boolean visible ) { < nl > - this . visible = visible ; < nl > - } < nl > + } < nl > + < nl > + public static class Hide { < nl > < nl > - public boolean isVisible ( ) { < nl > - return visible ; < nl > - } < nl > } < nl > }

TEST DIFF:
diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / AndroidManifest . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / AndroidManifest . xml 
 index 73b6404 . . 343b5e3 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / AndroidManifest . xml 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / AndroidManifest . xml 
 @ @ - 247 , 7 + 247 , 6 @ @ 
 android : theme = " @ style / CommonActivityTheme " 
 android : windowSoftInputMode = " adjustResize " / > 
 
 - 
 < ! - - Actions - - > 
 < activity 
 android : name = " . controllers . settings . EditNameActivity " 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java 
 index 8e39e1a . . 3b01739 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java 
 @ @ - 811 , 6 + 811 , 9 @ @ public class ChatActivity extends ActorEditTextActivity { 
 checkEmptyBot ( ) ; 
 } 
 
 + if ( isShareVisible ) { 
 + messenger ( ) . getGalleryScannerActor ( ) . send ( new GalleryScannerActor . Show ( ) ) ; 
 + } 
 
 } 
 
 @ @ - 949 , 7 + 952 , 7 @ @ public class ChatActivity extends ActorEditTextActivity { 
 AudioHolder . stopPlaying ( ) ; 
 / / Saving draft 
 messenger ( ) . saveDraft ( peer , messageEditText . getText ( ) . toString ( ) ) ; 
 - 
 + messenger ( ) . getGalleryScannerActor ( ) . send ( new GalleryScannerActor . Hide ( ) ) ; 
 } 
 
 / / Message send 
 diff - - git a / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java b / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java 
 index ae014c0 . . d525e76 100644 
 - - - a / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java 
 + + + b / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java 
 @ @ - 5 , 13 + 5 , 15 @ @ import android . database . Cursor ; 
 import android . graphics . Bitmap ; 
 import android . graphics . BitmapFactory ; 
 import android . net . Uri ; 
 + import android . os . Environment ; 
 import android . provider . MediaStore ; 
 
 import java . util . ArrayList ; 
 - 
 + import java . util . HashMap ; 
 import im . actor . core . viewmodel . GalleryVM ; 
 import im . actor . runtime . Log ; 
 import im . actor . runtime . actors . Actor ; 
 + import im . actor . runtime . collections . SparseArray ; 
 
 public class GalleryScannerActor extends Actor { 
 
 @ @ - 22 , 7 + 24 , 7 @ @ public class GalleryScannerActor extends Actor { 
 Uri uri ; 
 Cursor cursor ; 
 int offset = 0 ; 
 - int column _ index _ data , column _ index _ folder _ name , column _ index _ date ; 
 + int column _ index _ data , column _ index _ folder _ name , column _ index _ date , column _ index _ id , column _ index _ folder _ id ; 
 
 ArrayList < String > listOfAllImages = new ArrayList < > ( ) ; 
 ArrayList < String > newMedia = new ArrayList < > ( ) ; 
 @ @ - 50 , 15 + 52 , 19 @ @ public class GalleryScannerActor extends Actor { 
 
 private void initScan ( ) { 
 Log . d ( TAG , " init scan " ) ; 
 - projection = new String [ ] { MediaStore . MediaColumns . DATA , 
 + projection = new String [ ] { MediaStore . Images . Media . DATA , 
 + MediaStore . Images . Media . _ ID , 
 + MediaStore . Images . Media . BUCKET _ ID , 
 MediaStore . Images . Media . BUCKET _ DISPLAY _ NAME , 
 - MediaStore . Images . Media . DATE _ MODIFIED } ; 
 + MediaStore . Images . Media . DATE _ TAKEN } ; 
 
 cursor = getQuery ( ) ; 
 
 if ( cursor ! = null & & cursor . getCount ( ) > 0 ) { 
 - column _ index _ data = cursor . getColumnIndexOrThrow ( MediaStore . MediaColumns . DATA ) ; 
 - column _ index _ date = cursor . getColumnIndexOrThrow ( MediaStore . MediaColumns . DATE _ MODIFIED ) ; 
 + column _ index _ data = cursor . getColumnIndexOrThrow ( MediaStore . Images . Media . DATA ) ; 
 + column _ index _ id = cursor . getColumnIndexOrThrow ( MediaStore . Images . Media . _ ID ) ; 
 + column _ index _ folder _ id = cursor . getColumnIndexOrThrow ( MediaStore . Images . Media . BUCKET _ ID ) ; 
 + column _ index _ date = cursor . getColumnIndexOrThrow ( MediaStore . Images . Media . DATE _ TAKEN ) ; 
 column _ index _ folder _ name = cursor 
 . getColumnIndexOrThrow ( MediaStore . Images . Media . BUCKET _ DISPLAY _ NAME ) ; 
 
 @ @ - 68 , 7 + 74 , 9 @ @ public class GalleryScannerActor extends Actor { 
 self ( ) . send ( new Scan ( ) ) ; 
 } else { 
 Log . d ( TAG , " init scan - no media , let ' s check it in " + CHECK _ NEW _ DELAY ) ; 
 - schedule ( new InitScan ( ) , CHECK _ NEW _ DELAY ) ; 
 + if ( visible ) { 
 + schedule ( new InitScan ( ) , CHECK _ NEW _ DELAY ) ; 
 + } 
 } 
 
 } 
 @ @ - 76 , 7 + 84 , 7 @ @ public class GalleryScannerActor extends Actor { 
 private Cursor getQuery ( ) { 
 try { 
 return context . getContentResolver ( ) . query ( uri , projection , null , 
 - null , MediaStore . MediaColumns . DATE _ MODIFIED + " DESC " ) ; 
 + null , MediaStore . Images . Media . DATE _ TAKEN + " DESC " ) ; 
 } catch ( Exception e ) { 
 return null ; 
 } 
 @ @ - 92 , 19 + 100 , 23 @ @ public class GalleryScannerActor extends Actor { 
 } 
 
 offset + = SCAN _ COUNT ; 
 - if ( offset < cursor . getCount ( ) ) { 
 - Log . d ( TAG , " scan - iterations , offset - " + offset + " , schedule next in " + SCAN _ DELAY ) ; 
 - schedule ( new Scan ( ) , SCAN _ DELAY ) ; 
 - } else { 
 - Log . d ( TAG , " scanned to end , offset - " + offset + " , schedule check new in " + CHECK _ NEW _ DELAY ) ; 
 - scanned = true ; 
 - schedule ( new CheckNew ( ) , CHECK _ NEW _ DELAY ) ; 
 - } 
 + scanned = offset > = cursor . getCount ( ) ; 
 
 - if ( offset % 100 = = 0 | | scanned ) { 
 + / / 
 + / / Update VM after 1st batch , every 100 photos , when scanned to end 
 + / / 
 + if ( offset = = SCAN _ COUNT | | offset % 100 = = 0 | | scanned ) { 
 Log . d ( TAG , " scan - update vm , offset - " + offset ) ; 
 galleryVM . getGalleryMediaPath ( ) . change ( new ArrayList < String > ( listOfAllImages ) ) ; 
 } 
 + 
 + if ( visible ) { 
 + if ( ! scanned ) { 
 + schedule ( new Scan ( ) , SCAN _ DELAY ) ; 
 + } else { 
 + schedule ( new CheckNew ( ) , CHECK _ NEW _ DELAY ) ; 
 + } 
 + } 
 } 
 
 private void checkNew ( ) { 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / GalleryVM . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / GalleryVM . java 
 index 9a3eb07 . . 660001d 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / GalleryVM . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / GalleryVM . java 
 @ @ - 1 , 8 + 1 , 6 @ @ 
 package im . actor . core . viewmodel ; 
 
 import java . util . ArrayList ; 
 - 
 - import im . actor . core . entity . StickerPack ; 
 import im . actor . runtime . mvvm . ValueModel ; 
 
 public class GalleryVM {

NEAREST DIFF:
diff - - git a / actor - sdk / sdk - core - android / android - app / src / main / java / im / actor / Application . java b / actor - sdk / sdk - core - android / android - app / src / main / java / im / actor / Application . java 
 index 5446f7a . . 091801e 100644 
 - - - a / actor - sdk / sdk - core - android / android - app / src / main / java / im / actor / Application . java 
 + + + b / actor - sdk / sdk - core - android / android - app / src / main / java / im / actor / Application . java 
 @ @ - 33 , 6 + 33 , 8 @ @ public class Application extends ActorSDKApplication { 
 
 ActorStyle style = ActorSDK . sharedActor ( ) . style ; 
 style . setDialogsActiveTextColor ( 0xff5882ac ) ; 
 + 
 + ActorSDK . sharedActor ( ) . setFastShareEnabled ( true ) ; 
 / / ActorSDK . sharedActor ( ) . setTwitter ( " " ) ; 
 / / ActorSDK . sharedActor ( ) . setHomePage ( " http : / / www . foo . com " ) ; 
 / / ActorSDK . sharedActor ( ) . setInviteUrl ( " http : / / www . foo . com " ) ; 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / ActorSDK . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / ActorSDK . java 
 index 516b460 . . 8e7c65f 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / ActorSDK . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / ActorSDK . java 
 @ @ - 574 , 7 + 574 , 7 @ @ public class ActorSDK { 
 * @ param fastShareEnabled 
 * / 
 public void setFastShareEnabled ( boolean fastShareEnabled ) { 
 - this . fastShareEnabled = this . fastShareEnabled ; 
 + this . fastShareEnabled = fastShareEnabled ; 
 } 
 
 / * * 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java 
 index 3e6ba78 . . 320137d 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java 
 @ @ - 6 , 7 + 6 , 6 @ @ import android . app . AlertDialog ; 
 import android . content . Context ; 
 import android . content . DialogInterface ; 
 import android . content . Intent ; 
 - import android . content . pm . ApplicationInfo ; 
 import android . content . pm . PackageManager ; 
 import android . content . res . Configuration ; 
 import android . database . Cursor ; 
 @ @ - 38 , 7 + 37 , 6 @ @ import android . view . animation . AlphaAnimation ; 
 import android . view . animation . Animation ; 
 import android . view . animation . TranslateAnimation ; 
 import android . widget . AdapterView ; 
 - import android . widget . Button ; 
 import android . widget . FrameLayout ; 
 import android . widget . ImageButton ; 
 import android . widget . ImageView ; 
 @ @ - 302 , 6 + 300 , 7 @ @ public class ChatActivity extends ActorEditTextActivity { 
 
 / / share menu 
 findViewById ( R . id . share _ menu ) . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainBackgroundColor ( ) ) ; 
 + findViewById ( R . id . fast _ share ) . setBackgroundColor ( ActorSDK . sharedActor ( ) . style . getMainBackgroundColor ( ) ) ; 
 shareMenu = findViewById ( R . id . share _ container ) ; 
 shareMenu . setOnClickListener ( new View . OnClickListener ( ) { 
 @ Override 
 @ @ - 1433 , 7 + 1432 , 7 @ @ public class ChatActivity extends ActorEditTextActivity { 
 shareMenu . setVisibility ( View . VISIBLE ) ; 
 isShareVisible = true ; 
 if ( ActorSDK . sharedActor ( ) . isFastShareEnabled ( ) ) { 
 - messenger ( ) . getGalleryScannerActor ( ) . send ( new GalleryScannerActor . Visible ( true ) ) ; 
 + messenger ( ) . getGalleryScannerActor ( ) . send ( new GalleryScannerActor . Show ( ) ) ; 
 } 
 } 
 
 @ @ - 1452 , 7 + 1451 , 7 @ @ public class ChatActivity extends ActorEditTextActivity { 
 shareMenu . setVisibility ( View . GONE ) ; 
 shareContainer . setVisibility ( View . GONE ) ; 
 if ( ActorSDK . sharedActor ( ) . isFastShareEnabled ( ) ) { 
 - messenger ( ) . getGalleryScannerActor ( ) . send ( new GalleryScannerActor . Visible ( false ) ) ; 
 + messenger ( ) . getGalleryScannerActor ( ) . send ( new GalleryScannerActor . Hide ( ) ) ; 
 } 
 
 } 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / activity _ dialog . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / activity _ dialog . xml 
 index 9dc67c7 . . 7c7230f 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / activity _ dialog . xml 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / activity _ dialog . xml 
 @ @ - 95 , 6 + 95 , 11 @ @ 
 android : scaleType = " fitXY " 
 android : src = " @ drawable / conv _ field _ shadow " / > 
 
 + < android . support . v7 . widget . RecyclerView 
 + android : id = " @ + id / fast _ share " 
 + android : layout _ width = " match _ parent " 
 + android : layout _ height = " @ dimen / fast _ share _ size " / > 
 + 
 < TableLayout 
 android : id = " @ + id / share _ menu " 
 android : paddingTop = " 5dp " 
 @ @ - 106 , 15 + 111 , 6 @ @ 
 
 < TableRow > 
 
 - < android . support . v7 . widget . RecyclerView 
 - android : id = " @ + id / fast _ share " 
 - android : layout _ width = " 0dp " 
 - android : layout _ weight = " 1 " 
 - android : layout _ height = " @ dimen / fast _ share _ size " / > 
 - < / TableRow > 
 - 
 - < TableRow > 
 - 
 < LinearLayout 
 android : gravity = " center _ horizontal " 
 android : layout _ width = " wrap _ content " 
 diff - - git a / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java b / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java 
 index 8b29b71 . . 6d0acc9 100644 
 - - - a / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java 
 + + + b / actor - sdk / sdk - core / core / core - android / src / main / java / im / actor / core / utils / GalleryScannerActor . java 
 @ @ - 1 , 19 + 1 , 14 @ @ 
 package im . actor . core . utils ; 
 
 - import android . content . BroadcastReceiver ; 
 import android . content . Context ; 
 - import android . content . Intent ; 
 - import android . content . IntentFilter ; 
 import android . database . Cursor ; 
 import android . graphics . Bitmap ; 
 import android . graphics . BitmapFactory ; 
 import android . net . Uri ; 
 import android . provider . MediaStore ; 
 
 - import java . io . File ; 
 import java . util . ArrayList ; 
 
 - import im . actor . core . utils . ImageHelper ; 
 import im . actor . core . viewmodel . GalleryVM ; 
 import im . actor . runtime . Log ; 
 import im . actor . runtime . actors . Actor ; 
 @ @ - 29 , 18 + 24 , 19 @ @ public class GalleryScannerActor extends Actor { 
 int offset = 0 ; 
 int column _ index _ data , column _ index _ folder _ name , column _ index _ date ; 
 
 - ArrayList < String > listOfAllImages = new ArrayList < String > ( ) ; 
 + ArrayList < String > listOfAllImages = new ArrayList < > ( ) ; 
 ArrayList < String > newMedia = new ArrayList < > ( ) ; 
 
 String absolutePathOfImage = null ; 
 GalleryVM galleryVM ; 
 
 - private static final int SCAN _ COUNT = 9 ; 
 + private static final int SCAN _ COUNT = 10 ; 
 
 - ArrayList < String > loaded = new ArrayList < > ( ) ; 
 private boolean visible = false ; 
 private boolean scanned = false ; 
 private String [ ] projection ; 
 + private boolean inited = false ; 
 + private Bitmap bitmap ; 
 
 public GalleryScannerActor ( Context context , GalleryVM galleryVM ) { 
 this . context = context ; 
 @ @ - 52 , 7 + 48 , 7 @ @ public class GalleryScannerActor extends Actor { 
 uri = android . provider . MediaStore . Images . Media . EXTERNAL _ CONTENT _ URI ; 
 } 
 
 - public void initScan ( ) { 
 + private void initScan ( ) { 
 Log . d ( TAG , " init scan " ) ; 
 projection = new String [ ] { MediaStore . MediaColumns . DATA , 
 MediaStore . Images . Media . BUCKET _ DISPLAY _ NAME , 
 @ @ - 68 , 6 + 64 , 7 @ @ public class GalleryScannerActor extends Actor { 
 
 
 Log . d ( TAG , " init scan ok - starting scan iterations " ) ; 
 + inited = true ; 
 self ( ) . send ( new Scan ( ) ) ; 
 } else { 
 Log . d ( TAG , " init scan - no media , let ' s check it in " + CHECK _ NEW _ DELAY ) ; 
 @ @ - 76 , 7 + 73 , 7 @ @ public class GalleryScannerActor extends Actor { 
 
 } 
 
 - public Cursor getQuery ( ) { 
 + private Cursor getQuery ( ) { 
 return context . getContentResolver ( ) . query ( uri , projection , null , 
 null , MediaStore . MediaColumns . DATE _ MODIFIED + " DESC " ) ; 
 } 
 @ @ - 84 , 50 + 81 , 53 @ @ public class GalleryScannerActor extends Actor { 
 private void scan ( ) { 
 
 Log . d ( TAG , " scan " ) ; 
 - int i = 0 ; 
 - while ( offset + i + + < offset + SCAN _ COUNT & & cursor . moveToNext ( ) ) { 
 - absolutePathOfImage = cursor . getString ( column _ index _ data ) ; 
 
 + for ( int i = 0 ; i < = SCAN _ COUNT & & cursor . moveToNext ( ) ; i + + ) { 
 + absolutePathOfImage = cursor . getString ( column _ index _ data ) ; 
 listOfAllImages . add ( absolutePathOfImage ) ; 
 } 
 - boolean added = false ; 
 - if ( offset % 100 = = 0 ) { 
 - Log . d ( TAG , " scan - update vm , offset - " + offset ) ; 
 - galleryVM . getGalleryMediaPath ( ) . change ( new ArrayList < String > ( listOfAllImages ) ) ; 
 - added = true ; 
 - } 
 - offset + = i ; 
 + 
 + offset + = SCAN _ COUNT ; 
 if ( offset < cursor . getCount ( ) ) { 
 - Log . d ( TAG , " scan - " + i + " iterations , offset - " + offset + " , schedule next in " + SCAN _ DELAY ) ; 
 + Log . d ( TAG , " scan - iterations , offset - " + offset + " , schedule next in " + SCAN _ DELAY ) ; 
 schedule ( new Scan ( ) , SCAN _ DELAY ) ; 
 } else { 
 - if ( ! added ) { 
 - galleryVM . getGalleryMediaPath ( ) . change ( new ArrayList < String > ( listOfAllImages ) ) ; 
 - } 
 Log . d ( TAG , " scanned to end , offset - " + offset + " , schedule check new in " + CHECK _ NEW _ DELAY ) ; 
 scanned = true ; 
 schedule ( new CheckNew ( ) , CHECK _ NEW _ DELAY ) ; 
 } 
 + 
 + if ( offset % 100 = = 0 | | scanned ) { 
 + Log . d ( TAG , " scan - update vm , offset - " + offset ) ; 
 + galleryVM . getGalleryMediaPath ( ) . change ( new ArrayList < String > ( listOfAllImages ) ) ; 
 + } 
 } 
 
 private void checkNew ( ) { 
 Log . d ( TAG , " checkNew " ) ; 
 cursor = getQuery ( ) ; 
 newMedia . clear ( ) ; 
 + boolean firstCycle = true ; 
 while ( cursor ! = null & & cursor . moveToNext ( ) ) { 
 absolutePathOfImage = cursor . getString ( column _ index _ data ) ; 
 if ( ! listOfAllImages . contains ( absolutePathOfImage ) ) { 
 - Bitmap bitmap = ImageHelper . loadOptimizedHQ ( absolutePathOfImage ) ; 
 - if ( bitmap ! = null ) { 
 - bitmap . recycle ( ) ; 
 - newMedia . add ( absolutePathOfImage ) ; 
 - Log . d ( TAG , " checkNew - new media " ) ; 
 - 
 + if ( firstCycle ) { 
 + firstCycle = false ; 
 + bitmap = BitmapFactory . decodeFile ( absolutePathOfImage ) ; 
 + if ( bitmap ! = null ) { 
 + bitmap . recycle ( ) ; 
 + newMedia . add ( absolutePathOfImage ) ; 
 + Log . d ( TAG , " checkNew - new media " ) ; 
 + 
 + } else { 
 + Log . d ( TAG , " checkNew - new media writing , breaking for wait " ) ; 
 + 
 + break ; 
 + } 
 } else { 
 - Log . d ( TAG , " checkNew - new media writing , breaking for wait " ) ; 
 - 
 - break ; 
 + newMedia . add ( absolutePathOfImage ) ; 
 } 
 + 
 } else { 
 Log . d ( TAG , " checkNew - found old media , break " ) ; 
 
 @ @ - 136 , 13 + 136 , 11 @ @ public class GalleryScannerActor extends Actor { 
 } 
 if ( newMedia . size ( ) > 0 ) { 
 listOfAllImages . addAll ( 0 , newMedia ) ; 
 - galleryVM . getGalleryMediaPath ( ) . change ( new ArrayList < String > ( listOfAllImages ) ) ; 
 + galleryVM . getGalleryMediaPath ( ) . change ( new ArrayList < > ( listOfAllImages ) ) ; 
 Log . d ( TAG , " checkNew - new media add - " + newMedia . size ( ) ) ; 
 - 
 } 
 if ( visible ) { 
 Log . d ( TAG , " checkNew - visible , schedule next check in " + CHECK _ NEW _ DELAY ) ; 
 - 
 schedule ( new CheckNew ( ) , CHECK _ NEW _ DELAY ) ; 
 } 
 } 
 @ @ - 155 , 17 + 153 , 17 @ @ public class GalleryScannerActor extends Actor { 
 initScan ( ) ; 
 } else if ( message instanceof CheckNew ) { 
 checkNew ( ) ; 
 - } else if ( message instanceof Visible ) { 
 - if ( ( ( Visible ) message ) . isVisible ( ) ) { 
 - visible = true ; 
 - if ( scanned ) { 
 - self ( ) . send ( new CheckNew ( ) ) ; 
 - } else { 
 + } else if ( message instanceof Show ) { 
 + visible = true ; 
 + if ( scanned ) { 
 + self ( ) . send ( new CheckNew ( ) ) ; 
 + } else { 
 + if ( ! inited ) { 
 self ( ) . send ( new InitScan ( ) ) ; 
 } 
 - } else { 
 - visible = false ; 
 } 
 + } else if ( message instanceof Hide ) { 
 + visible = false ; 
 } 
 } 
 
 @ @ - 181 , 15 + 179 , 11 @ @ public class GalleryScannerActor extends Actor { 
 
 } 
 
 - public static class Visible { 
 - boolean visible ; 
 + public static class Show { 
 
 - public Visible ( boolean visible ) { 
 - this . visible = visible ; 
 - } 
 + } 
 + 
 + public static class Hide { 
 
 - public boolean isVisible ( ) { 
 - return visible ; 
 - } 
 } 
 }
