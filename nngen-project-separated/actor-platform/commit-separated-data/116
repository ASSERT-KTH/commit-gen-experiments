BLEU SCORE: 0.11868405219520975

TEST MSG: feat ( server : groups ) : new permissions added
GENERATED MSG: fix ( server ) : fix service messages in channels

TEST DIFF (one line): diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupState . scala b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupState . scala < nl > index 3f2959e . . 2d683a4 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupState . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupState . scala < nl > @ @ - 359 , 16 + 359 , 30 @ @ private [ group ] final case class GroupState ( < nl > * 5 - canEditAdminSettings . Default is FALSE . < nl > * 6 - canViewAdmins . Default is FALSE . < nl > * 7 - canEditAdmins . Default is FALSE . < nl > + * < nl > + * NOT DOCUMENTED YET : < nl > + * 8 - canKickInvited . Default is FALSE . < nl > + * 9 - canKickAnyone . Default is FALSE . < nl > + * 10 - canEditForeign . Default is FALSE . < nl > + * 11 - canDeleteForeign . Default is FALSE . < nl > * / < nl > def fullFor ( userId : Int ) : Long = { < nl > - ( ( toInt ( canEditInfo ( userId ) ) < < 0 ) + < nl > + ( < nl > + ( toInt ( canEditInfo ( userId ) ) < < 0 ) + < nl > ( toInt ( canViewMembers ( userId ) ) < < 1 ) + < nl > ( toInt ( canInviteMembers ( userId ) ) < < 2 ) + < nl > ( toInt ( canInviteViaLink ( userId ) ) < < 3 ) + < nl > ( toInt ( canCall ( userId ) ) < < 4 ) + < nl > ( toInt ( canEditAdminSettings ( userId ) ) < < 5 ) + < nl > ( toInt ( canViewAdmins ( userId ) ) < < 6 ) + < nl > - ( toInt ( canEditAdmins ( userId ) ) < < 7 ) ) . toLong < nl > + ( toInt ( canEditAdmins ( userId ) ) < < 7 ) + < nl > + < nl > + / / NOT DOCUMENTED YET : < nl > + ( toInt ( canKickInvited ( userId ) ) < < 8 ) + < nl > + ( toInt ( canKickAnyone ( userId ) ) < < 9 ) + < nl > + ( toInt ( canEditForeign ( userId ) ) < < 10 ) + < nl > + ( toInt ( canDeleteForeign ( userId ) ) < < 11 ) < nl > + ) . toLong < nl > } < nl > < nl > / * * < nl > @ @ - 424 , 15 + 438 , 37 @ @ private [ group ] final case class GroupState ( < nl > def canEditAdmins ( clientUserId : Int ) : Boolean = < nl > isOwner ( clientUserId ) | | isAdmin ( clientUserId ) < nl > < nl > - / / / / / / / / / / / / / / / / / / / / / / / / / / / / < nl > - / / Internal permissions / / < nl > - / / / / / / / / / / / / / / / / / / / / / / / / / / / / < nl > + / * * < nl > + * In General group members can kick people they invited < nl > + * In Channel only owner and admins can kick invited people < nl > + * / < nl > + def canKickInvited ( userId : Int ) : Boolean = < nl > + groupType match { < nl > + case General ⇒ isMember ( userId ) < nl > + case Channel ⇒ isAdmin ( userId ) | | isOwner ( userId ) < nl > + } < nl > < nl > / * * < nl > - * owner and admins can kick members < nl > + * Only owner and admins can kick anyone < nl > * / < nl > - def canKickMember ( clientUserId : Int ) = < nl > - isOwner ( clientUserId ) | | isAdmin ( clientUserId ) < nl > + def canKickAnyone ( userId : Int ) : Boolean = < nl > + isOwner ( userId ) | | isAdmin ( userId ) < nl > + < nl > + / * * < nl > + * Only owner and admins can edit foreign messages < nl > + * / < nl > + private def canEditForeign ( userId : Int ) : Boolean = < nl > + isOwner ( userId ) | | isAdmin ( userId ) < nl > + < nl > + / * * < nl > + * Only owner and admins can delete foreign messages < nl > + * / < nl > + private def canDeleteForeign ( userId : Int ) : Boolean = < nl > + isOwner ( userId ) | | isAdmin ( userId ) < nl > + < nl > + / / / / / / / / / / / / / / / / / / / / / / / / / / / / < nl > + / / Internal permissions / / < nl > + / / / / / / / / / / / / / / / / / / / / / / / / / / / / < nl > < nl > / / only owner can change short name < nl > def canEditShortName ( clientUserId : Int ) : Boolean = isOwner ( clientUserId ) < nl > diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / group / MemberCommandHandlers . scala b / actor - server / actor - core / src / main / scala / im / actor / server / group / MemberCommandHandlers . scala < nl > index 3fd617a . . efbd494 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / group / MemberCommandHandlers . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / group / MemberCommandHandlers . scala < nl > @ @ - 459 , 7 + 459 , 13 @ @ private [ group ] trait MemberCommandHandlers extends GroupsImplicits { < nl > } < nl > < nl > protected def kick ( cmd : Kick ) : Unit = { < nl > - if ( ! state . permissions . canKickMember ( cmd . kickerUserId ) ) { < nl > + val canKick = < nl > + state . permissions . canKickAnyone ( cmd . kickerUserId ) | | < nl > + ( < nl > + state . permissions . canKickInvited ( cmd . kickerUserId ) & & < nl > + state . members . get ( cmd . kickedUserId ) . exists ( _ . inviterUserId = = cmd . kickerUserId ) / / user we kick invited by kicker < nl > + ) < nl > + if ( ! canKick ) { < nl > sender ( ) ! noPermission < nl > } else if ( state . nonMember ( cmd . kickedUserId ) ) { < nl > sender ( ) ! notMember
NEAREST DIFF (one line): diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupCommandHandlers . scala b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupCommandHandlers . scala < nl > index c3fe238 . . 9794afa 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupCommandHandlers . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupCommandHandlers . scala < nl > @ @ - 8 , 7 + 8 , 7 @ @ import akka . pattern . pipe < nl > import im . actor . api . rpc . Update < nl > import im . actor . api . rpc . files . ApiAvatar < nl > import im . actor . api . rpc . groups . _ < nl > - import im . actor . api . rpc . messaging . { ApiMessage , UpdateMessage } < nl > + import im . actor . api . rpc . messaging . { ApiMessage , ApiServiceMessage , UpdateMessage } < nl > import im . actor . api . rpc . users . ApiSex < nl > import im . actor . concurrent . FutureExt < nl > import im . actor . server . CommonErrors < nl > @ @ - 274 , 22 + 274 , 17 @ @ private [ group ] trait GroupCommandHandlers extends GroupsImplicits with UserAcl { < nl > UpdateGroupMembersCountChanged ( groupId , newState . membersCount ) < nl > ) < nl > < nl > - / / push service message to invitee < nl > - _ ← pushUpdateMessage ( < nl > - userId = cmd . inviteeUserId , < nl > - authId = 0L , < nl > - ts = dateMillis , < nl > - randomId = cmd . randomId , < nl > - serviceMessage < nl > - ) < nl > - < nl > - / / push service message to inviter and return seqState < nl > - SeqState ( seq , state ) ← pushUpdateMessage ( < nl > + / / push service message to invitee and inviter < nl > + SeqState ( seq , state ) ← seqUpdExt . broadcastClientUpdate ( < nl > userId = cmd . inviterUserId , < nl > authId = cmd . inviterAuthId , < nl > - ts = dateMillis , < nl > - randomId = cmd . randomId , < nl > - serviceMessage < nl > + Set ( cmd . inviteeUserId ) , < nl > + update = serviceMessageUpdate ( < nl > + cmd . inviterUserId , < nl > + dateMillis , < nl > + cmd . randomId , < nl > + serviceMessage < nl > + ) < nl > ) < nl > } yield SeqStateDate ( seq , state , dateMillis ) < nl > < nl > @ @ - 349 , 6 + 344 , 11 @ @ private [ group ] trait GroupCommandHandlers extends GroupsImplicits with UserAcl { < nl > / / user was invited in group by other group user < nl > val wasInvited = state . isInvited ( cmd . joiningUserId ) < nl > < nl > + / / trying to figure out who invited joining user . < nl > + / / Descdending priority : < nl > + / / • inviter defined in ` Join ` command ( when invited via token ) < nl > + / / • inviter from members list ( when invited by other user ) < nl > + / / • group creator ( safe fallback ) < nl > val optMember = state . members . get ( cmd . joiningUserId ) < nl > val inviterUserId = cmd . invitingUserId < nl > . orElse ( optMember . map ( _ . inviterUserId ) ) < nl > @ @ - 459 , 13 + 459 , 15 @ @ private [ group ] trait GroupCommandHandlers extends GroupsImplicits with UserAcl { < nl > UpdateGroupMembersCountChanged ( groupId , newState . membersCount ) < nl > ) < nl > < nl > - / / push service message to joining user and return seqState < nl > - _ ← pushUpdateMessage ( < nl > - userId = cmd . joiningUserId , < nl > - authId = cmd . joiningUserAuthId , < nl > - ts = dateMillis , < nl > - randomId = randomId , < nl > - serviceMessage < nl > + / / push service message only to inviter < nl > + _ ← seqUpdExt . deliverUserUpdate ( < nl > + userId = inviterUserId , < nl > + update = serviceMessageUpdate ( < nl > + cmd . joiningUserId , < nl > + dateMillis , < nl > + randomId , < nl > + serviceMessage < nl > + ) < nl > ) < nl > } yield SeqStateDate ( seq , state , dateMillis ) < nl > < nl > @ @ - 581 , 14 + 583 , 19 @ @ private [ group ] trait GroupCommandHandlers extends GroupsImplicits with UserAcl { < nl > UpdateGroupMembersCountChanged ( groupId , state . membersCount - 1 ) < nl > ) < nl > < nl > - / / push service message to left user < nl > - _ ← pushUpdateMessage ( < nl > - userId = cmd . userId , < nl > - authId = cmd . authId , < nl > - ts = dateMillis , < nl > - randomId = cmd . randomId , < nl > - message = serviceMessage < nl > - ) < nl > + / / push service message to user , who invited leaving user < nl > + optInviter = state . members . get ( cmd . userId ) map ( _ . inviterUserId ) < nl > + _ ← optInviter map { inviter ⇒ < nl > + seqUpdExt . deliverUserUpdate ( < nl > + userId = cmd . userId , < nl > + update = serviceMessageUpdate ( < nl > + cmd . userId , < nl > + dateMillis , < nl > + cmd . randomId , < nl > + serviceMessage < nl > + ) < nl > + ) < nl > + } getOrElse FastFuture . successful ( ( ) ) < nl > < nl > / / push left user that he is no longer a member < nl > SeqState ( seq , state ) ← seqUpdExt . deliverClientUpdate ( < nl > @ @ - 713 , 22 + 720 , 15 @ @ private [ group ] trait GroupCommandHandlers extends GroupsImplicits with UserAcl { < nl > UpdateGroupMembersCountChanged ( groupId , newState . membersCount ) < nl > ) < nl > < nl > - / / push service message to kicker user < nl > - _ ← pushUpdateMessage ( < nl > - userId = cmd . kickerUserId , < nl > - authId = cmd . kickerAuthId , / / ? ? ? what ' s a point ? < nl > - ts = dateMillis , < nl > - randomId = cmd . randomId , < nl > - serviceMessage < nl > - ) < nl > - < nl > - / / push service message to kicked user < nl > - _ ← pushUpdateMessage ( < nl > - userId = cmd . kickedUserId , < nl > - authId = 0L , < nl > - ts = dateMillis , < nl > - randomId = cmd . randomId , < nl > - serviceMessage < nl > + / / push service message to kicker and kicked users . < nl > + _ ← seqUpdExt . broadcastPeopleUpdate ( < nl > + userIds = Set ( cmd . kickedUserId , cmd . kickerUserId ) , < nl > + update = serviceMessageUpdate ( < nl > + cmd . kickerUserId , < nl > + dateMillis , < nl > + cmd . randomId , < nl > + serviceMessage < nl > + ) < nl > ) < nl > < nl > / / push kicked user updates < nl > @ @ - 1147 , 25 + 1147 , 16 @ @ private [ group ] trait GroupCommandHandlers extends GroupsImplicits with UserAcl { < nl > } < nl > } < nl > < nl > - / / и л и в с е т а к и б у д е т broadcast ? < nl > - private def pushUpdateMessage ( userId : Int , authId : Long , ts : Long , randomId : Long , message : ApiMessage ) : Future [ SeqState ] = { < nl > - val messUpdate = UpdateMessage ( < nl > + private def serviceMessageUpdate ( senderUserId : Int , date : Long , randomId : Long , message : ApiServiceMessage ) = < nl > + UpdateMessage ( < nl > peer = apiGroupPeer , < nl > - senderUserId = userId , < nl > - date = ts , < nl > + senderUserId = senderUserId , < nl > + date = date , < nl > randomId = randomId , < nl > message = message , < nl > attributes = None , < nl > quotedMessage = None < nl > ) < nl > - seqUpdExt . deliverClientUpdate ( < nl > - userId = userId , < nl > - authId = authId , < nl > - update = messUpdate , < nl > - deliveryId = seqUpdExt . msgDeliveryId ( apiGroupPeer . asModel , randomId ) , < nl > - deliveryTag = Some ( Optimization . GroupV2 ) < nl > - ) < nl > - } < nl > < nl > private def trimToEmpty ( s : Option [ String ] ) : Option [ String ] = < nl > s map ( _ . trim ) filter ( _ . nonEmpty ) < nl > diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupOperations . scala b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupOperations . scala < nl > index b599ef8 . . adcfb28 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupOperations . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupOperations . scala < nl > @ @ - 46 , 8 + 46 , 7 @ @ private [ group ] sealed trait Commands extends UserAcl { < nl > def joinGroup ( groupId : Int , joiningUserId : Int , joiningUserAuthId : Long , invitingUserId : Option [ Int ] ) : Future [ ( SeqStateDate , Vector [ Int ] , Long ) ] = < nl > ( processorRegion . ref ? < nl > GroupEnvelope ( groupId ) < nl > - . withJoin ( Join ( joiningUserId , joiningUserAuthId , invitingUserId = None ) ) / / None ? < nl > - ) . mapTo [ ( SeqStateDate , Vector [ Int ] , Long ) ] < nl > + . withJoin ( Join ( joiningUserId , joiningUserAuthId , invitingUserId = invitingUserId ) ) ) . mapTo [ ( SeqStateDate , Vector [ Int ] , Long ) ] < nl > < nl > def inviteToGroup ( groupId : Int , inviteeUserId : Int , randomId : Long ) ( implicit client : AuthorizedClientData ) : Future [ SeqStateDate ] = < nl > inviteToGroup ( client . userId , client . authId , groupId , inviteeUserId , randomId ) < nl > diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupQueryHandlers . scala b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupQueryHandlers . scala < nl > index 1500067 . . 2e390f8 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupQueryHandlers . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupQueryHandlers . scala < nl > @ @ - 122 , 7 + 122 , 7 @ @ trait GroupQueryHandlers { < nl > canViewMembers = Some ( state . canViewMembers ( clientUserId ) ) , < nl > canInvitePeople = Some ( state . canInvitePeople ( clientUserId ) ) , < nl > isSharedHistory = Some ( state . isHistoryShared ) , < nl > - isAsyncMembers = Some ( state . members . size > 100 ) , < nl > + isAsyncMembers = Some ( state . isAsyncMembers ) , < nl > members = membersAndCount ( state , clientUserId ) . _ 1 < nl > ) < nl > ) < nl > diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupState . scala b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupState . scala < nl > index 5844d86 . . 77ed12f 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupState . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupState . scala < nl > @ @ - 116 , 6 + 116 , 12 @ @ private [ group ] final case class GroupState ( < nl > < nl > def isCreated = createdAt . nonEmpty / / TODO : Maybe val . immutable anyway < nl > < nl > + def isAsyncMembers = < nl > + typ match { < nl > + case General | Public ⇒ members . size > 100 < nl > + case Channel ⇒ true < nl > + } < nl > + < nl > override def updated ( e : Event ) : GroupState = e match { < nl > case evt : Created ⇒ < nl > this . copy (

TEST DIFF:
diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupState . scala b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupState . scala 
 index 3f2959e . . 2d683a4 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupState . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupState . scala 
 @ @ - 359 , 16 + 359 , 30 @ @ private [ group ] final case class GroupState ( 
 * 5 - canEditAdminSettings . Default is FALSE . 
 * 6 - canViewAdmins . Default is FALSE . 
 * 7 - canEditAdmins . Default is FALSE . 
 + * 
 + * NOT DOCUMENTED YET : 
 + * 8 - canKickInvited . Default is FALSE . 
 + * 9 - canKickAnyone . Default is FALSE . 
 + * 10 - canEditForeign . Default is FALSE . 
 + * 11 - canDeleteForeign . Default is FALSE . 
 * / 
 def fullFor ( userId : Int ) : Long = { 
 - ( ( toInt ( canEditInfo ( userId ) ) < < 0 ) + 
 + ( 
 + ( toInt ( canEditInfo ( userId ) ) < < 0 ) + 
 ( toInt ( canViewMembers ( userId ) ) < < 1 ) + 
 ( toInt ( canInviteMembers ( userId ) ) < < 2 ) + 
 ( toInt ( canInviteViaLink ( userId ) ) < < 3 ) + 
 ( toInt ( canCall ( userId ) ) < < 4 ) + 
 ( toInt ( canEditAdminSettings ( userId ) ) < < 5 ) + 
 ( toInt ( canViewAdmins ( userId ) ) < < 6 ) + 
 - ( toInt ( canEditAdmins ( userId ) ) < < 7 ) ) . toLong 
 + ( toInt ( canEditAdmins ( userId ) ) < < 7 ) + 
 + 
 + / / NOT DOCUMENTED YET : 
 + ( toInt ( canKickInvited ( userId ) ) < < 8 ) + 
 + ( toInt ( canKickAnyone ( userId ) ) < < 9 ) + 
 + ( toInt ( canEditForeign ( userId ) ) < < 10 ) + 
 + ( toInt ( canDeleteForeign ( userId ) ) < < 11 ) 
 + ) . toLong 
 } 
 
 / * * 
 @ @ - 424 , 15 + 438 , 37 @ @ private [ group ] final case class GroupState ( 
 def canEditAdmins ( clientUserId : Int ) : Boolean = 
 isOwner ( clientUserId ) | | isAdmin ( clientUserId ) 
 
 - / / / / / / / / / / / / / / / / / / / / / / / / / / / / 
 - / / Internal permissions / / 
 - / / / / / / / / / / / / / / / / / / / / / / / / / / / / 
 + / * * 
 + * In General group members can kick people they invited 
 + * In Channel only owner and admins can kick invited people 
 + * / 
 + def canKickInvited ( userId : Int ) : Boolean = 
 + groupType match { 
 + case General ⇒ isMember ( userId ) 
 + case Channel ⇒ isAdmin ( userId ) | | isOwner ( userId ) 
 + } 
 
 / * * 
 - * owner and admins can kick members 
 + * Only owner and admins can kick anyone 
 * / 
 - def canKickMember ( clientUserId : Int ) = 
 - isOwner ( clientUserId ) | | isAdmin ( clientUserId ) 
 + def canKickAnyone ( userId : Int ) : Boolean = 
 + isOwner ( userId ) | | isAdmin ( userId ) 
 + 
 + / * * 
 + * Only owner and admins can edit foreign messages 
 + * / 
 + private def canEditForeign ( userId : Int ) : Boolean = 
 + isOwner ( userId ) | | isAdmin ( userId ) 
 + 
 + / * * 
 + * Only owner and admins can delete foreign messages 
 + * / 
 + private def canDeleteForeign ( userId : Int ) : Boolean = 
 + isOwner ( userId ) | | isAdmin ( userId ) 
 + 
 + / / / / / / / / / / / / / / / / / / / / / / / / / / / / 
 + / / Internal permissions / / 
 + / / / / / / / / / / / / / / / / / / / / / / / / / / / / 
 
 / / only owner can change short name 
 def canEditShortName ( clientUserId : Int ) : Boolean = isOwner ( clientUserId ) 
 diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / group / MemberCommandHandlers . scala b / actor - server / actor - core / src / main / scala / im / actor / server / group / MemberCommandHandlers . scala 
 index 3fd617a . . efbd494 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / group / MemberCommandHandlers . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / group / MemberCommandHandlers . scala 
 @ @ - 459 , 7 + 459 , 13 @ @ private [ group ] trait MemberCommandHandlers extends GroupsImplicits { 
 } 
 
 protected def kick ( cmd : Kick ) : Unit = { 
 - if ( ! state . permissions . canKickMember ( cmd . kickerUserId ) ) { 
 + val canKick = 
 + state . permissions . canKickAnyone ( cmd . kickerUserId ) | | 
 + ( 
 + state . permissions . canKickInvited ( cmd . kickerUserId ) & & 
 + state . members . get ( cmd . kickedUserId ) . exists ( _ . inviterUserId = = cmd . kickerUserId ) / / user we kick invited by kicker 
 + ) 
 + if ( ! canKick ) { 
 sender ( ) ! noPermission 
 } else if ( state . nonMember ( cmd . kickedUserId ) ) { 
 sender ( ) ! notMember

NEAREST DIFF:
diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupCommandHandlers . scala b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupCommandHandlers . scala 
 index c3fe238 . . 9794afa 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupCommandHandlers . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupCommandHandlers . scala 
 @ @ - 8 , 7 + 8 , 7 @ @ import akka . pattern . pipe 
 import im . actor . api . rpc . Update 
 import im . actor . api . rpc . files . ApiAvatar 
 import im . actor . api . rpc . groups . _ 
 - import im . actor . api . rpc . messaging . { ApiMessage , UpdateMessage } 
 + import im . actor . api . rpc . messaging . { ApiMessage , ApiServiceMessage , UpdateMessage } 
 import im . actor . api . rpc . users . ApiSex 
 import im . actor . concurrent . FutureExt 
 import im . actor . server . CommonErrors 
 @ @ - 274 , 22 + 274 , 17 @ @ private [ group ] trait GroupCommandHandlers extends GroupsImplicits with UserAcl { 
 UpdateGroupMembersCountChanged ( groupId , newState . membersCount ) 
 ) 
 
 - / / push service message to invitee 
 - _ ← pushUpdateMessage ( 
 - userId = cmd . inviteeUserId , 
 - authId = 0L , 
 - ts = dateMillis , 
 - randomId = cmd . randomId , 
 - serviceMessage 
 - ) 
 - 
 - / / push service message to inviter and return seqState 
 - SeqState ( seq , state ) ← pushUpdateMessage ( 
 + / / push service message to invitee and inviter 
 + SeqState ( seq , state ) ← seqUpdExt . broadcastClientUpdate ( 
 userId = cmd . inviterUserId , 
 authId = cmd . inviterAuthId , 
 - ts = dateMillis , 
 - randomId = cmd . randomId , 
 - serviceMessage 
 + Set ( cmd . inviteeUserId ) , 
 + update = serviceMessageUpdate ( 
 + cmd . inviterUserId , 
 + dateMillis , 
 + cmd . randomId , 
 + serviceMessage 
 + ) 
 ) 
 } yield SeqStateDate ( seq , state , dateMillis ) 
 
 @ @ - 349 , 6 + 344 , 11 @ @ private [ group ] trait GroupCommandHandlers extends GroupsImplicits with UserAcl { 
 / / user was invited in group by other group user 
 val wasInvited = state . isInvited ( cmd . joiningUserId ) 
 
 + / / trying to figure out who invited joining user . 
 + / / Descdending priority : 
 + / / • inviter defined in ` Join ` command ( when invited via token ) 
 + / / • inviter from members list ( when invited by other user ) 
 + / / • group creator ( safe fallback ) 
 val optMember = state . members . get ( cmd . joiningUserId ) 
 val inviterUserId = cmd . invitingUserId 
 . orElse ( optMember . map ( _ . inviterUserId ) ) 
 @ @ - 459 , 13 + 459 , 15 @ @ private [ group ] trait GroupCommandHandlers extends GroupsImplicits with UserAcl { 
 UpdateGroupMembersCountChanged ( groupId , newState . membersCount ) 
 ) 
 
 - / / push service message to joining user and return seqState 
 - _ ← pushUpdateMessage ( 
 - userId = cmd . joiningUserId , 
 - authId = cmd . joiningUserAuthId , 
 - ts = dateMillis , 
 - randomId = randomId , 
 - serviceMessage 
 + / / push service message only to inviter 
 + _ ← seqUpdExt . deliverUserUpdate ( 
 + userId = inviterUserId , 
 + update = serviceMessageUpdate ( 
 + cmd . joiningUserId , 
 + dateMillis , 
 + randomId , 
 + serviceMessage 
 + ) 
 ) 
 } yield SeqStateDate ( seq , state , dateMillis ) 
 
 @ @ - 581 , 14 + 583 , 19 @ @ private [ group ] trait GroupCommandHandlers extends GroupsImplicits with UserAcl { 
 UpdateGroupMembersCountChanged ( groupId , state . membersCount - 1 ) 
 ) 
 
 - / / push service message to left user 
 - _ ← pushUpdateMessage ( 
 - userId = cmd . userId , 
 - authId = cmd . authId , 
 - ts = dateMillis , 
 - randomId = cmd . randomId , 
 - message = serviceMessage 
 - ) 
 + / / push service message to user , who invited leaving user 
 + optInviter = state . members . get ( cmd . userId ) map ( _ . inviterUserId ) 
 + _ ← optInviter map { inviter ⇒ 
 + seqUpdExt . deliverUserUpdate ( 
 + userId = cmd . userId , 
 + update = serviceMessageUpdate ( 
 + cmd . userId , 
 + dateMillis , 
 + cmd . randomId , 
 + serviceMessage 
 + ) 
 + ) 
 + } getOrElse FastFuture . successful ( ( ) ) 
 
 / / push left user that he is no longer a member 
 SeqState ( seq , state ) ← seqUpdExt . deliverClientUpdate ( 
 @ @ - 713 , 22 + 720 , 15 @ @ private [ group ] trait GroupCommandHandlers extends GroupsImplicits with UserAcl { 
 UpdateGroupMembersCountChanged ( groupId , newState . membersCount ) 
 ) 
 
 - / / push service message to kicker user 
 - _ ← pushUpdateMessage ( 
 - userId = cmd . kickerUserId , 
 - authId = cmd . kickerAuthId , / / ? ? ? what ' s a point ? 
 - ts = dateMillis , 
 - randomId = cmd . randomId , 
 - serviceMessage 
 - ) 
 - 
 - / / push service message to kicked user 
 - _ ← pushUpdateMessage ( 
 - userId = cmd . kickedUserId , 
 - authId = 0L , 
 - ts = dateMillis , 
 - randomId = cmd . randomId , 
 - serviceMessage 
 + / / push service message to kicker and kicked users . 
 + _ ← seqUpdExt . broadcastPeopleUpdate ( 
 + userIds = Set ( cmd . kickedUserId , cmd . kickerUserId ) , 
 + update = serviceMessageUpdate ( 
 + cmd . kickerUserId , 
 + dateMillis , 
 + cmd . randomId , 
 + serviceMessage 
 + ) 
 ) 
 
 / / push kicked user updates 
 @ @ - 1147 , 25 + 1147 , 16 @ @ private [ group ] trait GroupCommandHandlers extends GroupsImplicits with UserAcl { 
 } 
 } 
 
 - / / и л и в с е т а к и б у д е т broadcast ? 
 - private def pushUpdateMessage ( userId : Int , authId : Long , ts : Long , randomId : Long , message : ApiMessage ) : Future [ SeqState ] = { 
 - val messUpdate = UpdateMessage ( 
 + private def serviceMessageUpdate ( senderUserId : Int , date : Long , randomId : Long , message : ApiServiceMessage ) = 
 + UpdateMessage ( 
 peer = apiGroupPeer , 
 - senderUserId = userId , 
 - date = ts , 
 + senderUserId = senderUserId , 
 + date = date , 
 randomId = randomId , 
 message = message , 
 attributes = None , 
 quotedMessage = None 
 ) 
 - seqUpdExt . deliverClientUpdate ( 
 - userId = userId , 
 - authId = authId , 
 - update = messUpdate , 
 - deliveryId = seqUpdExt . msgDeliveryId ( apiGroupPeer . asModel , randomId ) , 
 - deliveryTag = Some ( Optimization . GroupV2 ) 
 - ) 
 - } 
 
 private def trimToEmpty ( s : Option [ String ] ) : Option [ String ] = 
 s map ( _ . trim ) filter ( _ . nonEmpty ) 
 diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupOperations . scala b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupOperations . scala 
 index b599ef8 . . adcfb28 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupOperations . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupOperations . scala 
 @ @ - 46 , 8 + 46 , 7 @ @ private [ group ] sealed trait Commands extends UserAcl { 
 def joinGroup ( groupId : Int , joiningUserId : Int , joiningUserAuthId : Long , invitingUserId : Option [ Int ] ) : Future [ ( SeqStateDate , Vector [ Int ] , Long ) ] = 
 ( processorRegion . ref ? 
 GroupEnvelope ( groupId ) 
 - . withJoin ( Join ( joiningUserId , joiningUserAuthId , invitingUserId = None ) ) / / None ? 
 - ) . mapTo [ ( SeqStateDate , Vector [ Int ] , Long ) ] 
 + . withJoin ( Join ( joiningUserId , joiningUserAuthId , invitingUserId = invitingUserId ) ) ) . mapTo [ ( SeqStateDate , Vector [ Int ] , Long ) ] 
 
 def inviteToGroup ( groupId : Int , inviteeUserId : Int , randomId : Long ) ( implicit client : AuthorizedClientData ) : Future [ SeqStateDate ] = 
 inviteToGroup ( client . userId , client . authId , groupId , inviteeUserId , randomId ) 
 diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupQueryHandlers . scala b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupQueryHandlers . scala 
 index 1500067 . . 2e390f8 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupQueryHandlers . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupQueryHandlers . scala 
 @ @ - 122 , 7 + 122 , 7 @ @ trait GroupQueryHandlers { 
 canViewMembers = Some ( state . canViewMembers ( clientUserId ) ) , 
 canInvitePeople = Some ( state . canInvitePeople ( clientUserId ) ) , 
 isSharedHistory = Some ( state . isHistoryShared ) , 
 - isAsyncMembers = Some ( state . members . size > 100 ) , 
 + isAsyncMembers = Some ( state . isAsyncMembers ) , 
 members = membersAndCount ( state , clientUserId ) . _ 1 
 ) 
 ) 
 diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupState . scala b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupState . scala 
 index 5844d86 . . 77ed12f 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupState . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupState . scala 
 @ @ - 116 , 6 + 116 , 12 @ @ private [ group ] final case class GroupState ( 
 
 def isCreated = createdAt . nonEmpty / / TODO : Maybe val . immutable anyway 
 
 + def isAsyncMembers = 
 + typ match { 
 + case General | Public ⇒ members . size > 100 
 + case Channel ⇒ true 
 + } 
 + 
 override def updated ( e : Event ) : GroupState = e match { 
 case evt : Created ⇒ 
 this . copy (
