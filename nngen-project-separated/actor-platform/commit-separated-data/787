BLEU SCORE: 0.016087046643979717

TEST MSG: Merge commit ' f7e393d33561b1ab3cfe46334b451741407962c0 '
GENERATED MSG: feat ( android ) calls mute / speaker , new design

TEST DIFF (one line): diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java < nl > index 1c81113 . . 4cb5158 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java < nl > @ @ - 10 , 7 + 10 , 6 @ @ import android . content . Intent ; < nl > import android . content . pm . PackageManager ; < nl > import android . graphics . Color ; < nl > import android . graphics . drawable . GradientDrawable ; < nl > - import android . graphics . drawable . ShapeDrawable ; < nl > import android . media . AudioManager ; < nl > import android . media . Ringtone ; < nl > import android . media . RingtoneManager ; < nl > @ @ - 136 , 7 + 135 , 7 @ @ public class CallFragment extends BaseFragment { < nl > for ( int i = 0 ; i < avatarLayers . length ; i + + ) { < nl > View layer = avatarLayers [ i ] ; < nl > ( ( GradientDrawable ) layer . getBackground ( ) ) . setColor ( Color . WHITE ) ; < nl > - ( ( GradientDrawable ) layer . getBackground ( ) ) . setAlpha ( 150 ) ; < nl > + ( ( GradientDrawable ) layer . getBackground ( ) ) . setAlpha ( 50 ) ; < nl > } < nl > < nl > answerContainer = cont . findViewById ( R . id . answer _ container ) ; < nl > @ @ - 180 , 6 + 179 , 8 @ @ public class CallFragment extends BaseFragment { < nl > bind ( nameTV , g . getName ( ) ) ; < nl > } < nl > < nl > + nameTV . setSelected ( true ) ; < nl > + < nl > / / < nl > / / Members list < nl > / / < nl > @ @ - 234 , 19 + 235 , 13 @ @ public class CallFragment extends BaseFragment { < nl > cont . findViewById ( R . id . speaker _ btn ) . setOnClickListener ( new View . OnClickListener ( ) { < nl > @ Override < nl > public void onClick ( View v ) { < nl > - speakerOn = ! speakerOn ; < nl > - audioManager . setSpeakerphoneOn ( speakerOn ) ; < nl > - if ( speakerOn ) { < nl > - speaker . setTint ( Color . WHITE ) ; < nl > - speakerTV . setTextColor ( Color . WHITE ) ; < nl > - } else { < nl > - speaker . setTint ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; < nl > - speakerTV . setTextColor ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; < nl > - } < nl > + toggleSpeaker ( speaker , speakerTV ) ; < nl > } < nl > } ) ; < nl > + checkSpeaker ( speaker , speakerTV ) ; < nl > < nl > final TintImageView muteCall = ( TintImageView ) cont . findViewById ( R . id . mute ) ; < nl > + final TextView muteCallTv = ( TextView ) cont . findViewById ( R . id . mute _ tv ) ; < nl > muteCall . setResource ( R . drawable . ic _ mic _ off _ white _ 24dp ) ; < nl > cont . findViewById ( R . id . mute _ btn ) . setOnClickListener ( new View . OnClickListener ( ) { < nl > @ Override < nl > @ @ - 257 , 24 + 252 , 35 @ @ public class CallFragment extends BaseFragment { < nl > < nl > final TintImageView video = ( TintImageView ) cont . findViewById ( R . id . video ) ; < nl > video . setResource ( R . drawable . ic _ videocam _ white _ 24dp ) ; < nl > + TextView videoTv = ( TextView ) cont . findViewById ( R . id . video _ tv ) ; < nl > + videoTv . setTextColor ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; < nl > + video . setTint ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; < nl > < nl > final TintImageView back = ( TintImageView ) cont . findViewById ( R . id . back ) ; < nl > back . setResource ( R . drawable . ic _ message _ white _ 24dp ) ; < nl > + cont . findViewById ( R . id . back _ btn ) . setOnClickListener ( new View . OnClickListener ( ) { < nl > + @ Override < nl > + public void onClick ( View v ) { < nl > + getActivity ( ) . onBackPressed ( ) ; < nl > + } < nl > + } ) ; < nl > < nl > final TintImageView add = ( TintImageView ) cont . findViewById ( R . id . add ) ; < nl > add . setResource ( R . drawable . ic _ person _ add _ white _ 24dp ) ; < nl > - < nl > + TextView addTv = ( TextView ) cont . findViewById ( R . id . add _ user _ tv ) ; < nl > + addTv . setTextColor ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; < nl > + add . setTint ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; < nl > < nl > if ( call ! = null ) { < nl > call . getIsMuted ( ) . subscribe ( new ValueChangedListener < Boolean > ( ) { < nl > @ Override < nl > public void onChanged ( Boolean val , Value < Boolean > valueModel ) { < nl > if ( val ) { < nl > - muteCall . setBackgroundResource ( R . drawable . call _ action _ background _ active ) ; < nl > - muteCall . setTint ( Color . WHITE ) ; < nl > + muteCallTv . setTextColor ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; < nl > + muteCall . setTint ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; < nl > } else { < nl > - muteCall . setBackgroundResource ( R . drawable . call _ action _ background ) ; < nl > - muteCall . setTint ( getResources ( ) . getColor ( R . color . primary ) ) ; < nl > + muteCallTv . setTextColor ( Color . WHITE ) ; < nl > + muteCall . setTint ( Color . WHITE ) ; < nl > } < nl > } < nl > } ) ; < nl > @ @ - 323 , 6 + 329 , 22 @ @ public class CallFragment extends BaseFragment { < nl > return cont ; < nl > } < nl > < nl > + public void toggleSpeaker ( TintImageView speaker , TextView speakerTV ) { < nl > + speakerOn = ! speakerOn ; < nl > + audioManager . setSpeakerphoneOn ( speakerOn ) ; < nl > + checkSpeaker ( speaker , speakerTV ) ; < nl > + } < nl > + < nl > + public void checkSpeaker ( TintImageView speaker , TextView speakerTV ) { < nl > + if ( speakerOn ) { < nl > + speaker . setTint ( Color . WHITE ) ; < nl > + speakerTV . setTextColor ( Color . WHITE ) ; < nl > + } else { < nl > + speaker . setTint ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; < nl > + speakerTV . setTextColor ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; < nl > + } < nl > + } < nl > + < nl > public void switchAvatarMembers ( ) { < nl > if ( peer . getPeerType ( ) = = PeerType . GROUP ) { < nl > if ( avatarView . getVisibility ( ) = = View . VISIBLE ) { < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml < nl > index d295f55 . . 7cd8351 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml < nl > @ @ - 4 , 7 + 4 , 6 @ @ < nl > android : layout _ width = " match _ parent " < nl > android : layout _ height = " match _ parent " > < nl > < nl > - < nl > < LinearLayout < nl > android : layout _ width = " match _ parent " < nl > android : layout _ height = " match _ parent " < nl > @ @ - 14 , 14 + 13 , 14 @ @ < nl > < nl > < TextView < nl > android : id = " @ + id / status " < nl > - android : layout _ marginTop = " 40dp " < nl > + android : layout _ marginTop = " 37 . 5dp " < nl > android : layout _ gravity = " center " < nl > android : gravity = " center " < nl > android : layout _ width = " wrap _ content " < nl > android : layout _ height = " wrap _ content " < nl > - android : textSize = " 20sp " < nl > - android : textColor = " @ android : color / white " < nl > - android : text = " Ringing . . . " / > < nl > + android : textSize = " 17 . 3sp " < nl > + android : fontFamily = " sans - serif - light " < nl > + android : textColor = " @ android : color / white " / > < nl > < nl > < RelativeLayout < nl > < nl > @ @ - 71 , 7 + 70 , 6 @ @ < nl > android : layout _ centerHorizontal = " true " < nl > android : background = " @ drawable / call _ avatar _ background " / > < nl > < nl > - < nl > < im . actor . sdk . view . avatar . AvatarView < nl > android : id = " @ + id / avatar " < nl > android : layout _ width = " 100dp " < nl > @ @ - 79 , 8 + 77 , 6 @ @ < nl > android : layout _ centerVertical = " true " < nl > android : layout _ centerHorizontal = " true " / > < nl > < nl > - < nl > - < nl > < ListView < nl > android : paddingLeft = " 20dp " < nl > android : paddingRight = " 20dp " < nl > @ @ - 94 , 21 + 90 , 22 @ @ < nl > < TextView < nl > android : textColor = " @ android : color / white " < nl > android : paddingTop = " 5dp " < nl > + android : paddingLeft = " 5dp " < nl > + android : paddingRight = " 5dp " < nl > android : gravity = " center _ horizontal | bottom " < nl > - < nl > - android : fontFamily = " sans - serif - thin " < nl > + android : ellipsize = " marquee " < nl > + android : scrollHorizontally = " true " < nl > + android : marqueeRepeatLimit = " marquee _ forever " < nl > + android : fontFamily = " sans - serif - light " < nl > android : id = " @ + id / name " < nl > android : layout _ width = " wrap _ content " < nl > android : layout _ height = " wrap _ content " < nl > + android : singleLine = " true " < nl > android : lines = " 1 " < nl > - android : textSize = " 32sp " < nl > + android : textSize = " 30sp " < nl > android : layout _ below = " @ + id / layer4 " < nl > android : layout _ centerHorizontal = " true " / > < nl > < nl > - < nl > - < nl > - < nl > - < nl > < / RelativeLayout > < nl > < nl > < FrameLayout < nl > @ @ - 138 , 14 + 135 , 15 @ @ < nl > android : layout _ width = " 60dp " < nl > android : layout _ height = " 60dp " < nl > android : src = " @ drawable / ic _ call _ end _ white _ 36dp " < nl > - android : background = " @ drawable / end _ call _ background " < nl > - / > < nl > + android : background = " @ drawable / end _ call _ background " / > < nl > + < nl > < / FrameLayout > < nl > < nl > < FrameLayout < nl > android : layout _ width = " 0dp " < nl > android : layout _ weight = " 1 " < nl > android : layout _ height = " 60dp " > < nl > + < nl > < ImageButton < nl > android : layout _ gravity = " center " < nl > android : id = " @ + id / answer " < nl > @ @ - 159 , 26 + 157 , 33 @ @ < nl > < / LinearLayout > < nl > < nl > < TableLayout < nl > - android : layout _ width = " match _ parent " < nl > - android : layout _ height = " match _ parent " < nl > + android : paddingBottom = " 15dp " < nl > + android : paddingLeft = " 10dp " < nl > + android : paddingRight = " 10dp " < nl > + android : layout _ gravity = " bottom | center _ horizontal " < nl > + android : layout _ width = " wrap _ content " < nl > + android : layout _ height = " wrap _ content " < nl > android : stretchColumns = " * " > < nl > + < nl > < TableRow < nl > + android : minHeight = " 110dp " < nl > android : layout _ weight = " 1 " < nl > android : gravity = " center " > < nl > + < nl > < LinearLayout < nl > android : id = " @ + id / mute _ btn " < nl > android : orientation = " vertical " < nl > android : layout _ weight = " 1 " < nl > android : layout _ width = " 0dp " < nl > android : layout _ height = " wrap _ content " > < nl > + < nl > < im . actor . sdk . view . TintImageView < nl > android : id = " @ + id / mute " < nl > android : layout _ gravity = " center _ horizontal " < nl > android : layout _ height = " @ dimen / call _ btn _ size " < nl > android : scaleType = " centerInside " < nl > - android : layout _ width = " @ dimen / call _ btn _ size " < nl > - < nl > - / > < nl > + android : layout _ width = " @ dimen / call _ btn _ size " / > < nl > + < nl > < TextView < nl > android : id = " @ + id / mute _ tv " < nl > android : layout _ gravity = " center " < nl > @ @ - 195 , 14 + 200 , 14 @ @ < nl > android : layout _ weight = " 1 " < nl > android : layout _ width = " 0dp " < nl > android : layout _ height = " wrap _ content " > < nl > + < nl > < im . actor . sdk . view . TintImageView < nl > android : id = " @ + id / speaker " < nl > android : layout _ gravity = " center _ horizontal " < nl > android : layout _ height = " @ dimen / call _ btn _ size " < nl > android : scaleType = " centerInside " < nl > - android : layout _ width = " @ dimen / call _ btn _ size " < nl > - < nl > - / > < nl > + android : layout _ width = " @ dimen / call _ btn _ size " / > < nl > + < nl > < TextView < nl > android : id = " @ + id / speaker _ tv " < nl > android : layout _ gravity = " center " < nl > @ @ - 219 , 14 + 224 , 14 @ @ < nl > android : layout _ weight = " 1 " < nl > android : layout _ width = " 0dp " < nl > android : layout _ height = " wrap _ content " > < nl > + < nl > < im . actor . sdk . view . TintImageView < nl > android : id = " @ + id / video " < nl > android : layout _ gravity = " center _ horizontal " < nl > android : layout _ height = " @ dimen / call _ btn _ size " < nl > android : scaleType = " centerInside " < nl > - android : layout _ width = " @ dimen / call _ btn _ size " < nl > - < nl > - / > < nl > + android : layout _ width = " @ dimen / call _ btn _ size " / > < nl > + < nl > < TextView < nl > android : id = " @ + id / video _ tv " < nl > android : layout _ gravity = " center " < nl > @ @ - 234 , 12 + 239 , 14 @ @ < nl > android : text = " video " < nl > android : gravity = " center " < nl > android : layout _ width = " wrap _ content " < nl > - android : layout _ height = " wrap _ content " / > < nl > + android : layout _ height = " wrap _ content " / > < nl > + < nl > < / LinearLayout > < nl > < nl > < / TableRow > < nl > < nl > < TableRow < nl > + android : minHeight = " 110dp " < nl > android : layout _ weight = " 1 " < nl > android : gravity = " center " > < nl > < nl > @ @ - 249 , 14 + 256 , 14 @ @ < nl > android : layout _ weight = " 1 " < nl > android : layout _ width = " 0dp " < nl > android : layout _ height = " wrap _ content " > < nl > + < nl > < im . actor . sdk . view . TintImageView < nl > android : id = " @ + id / back " < nl > android : layout _ gravity = " center _ horizontal " < nl > android : layout _ height = " @ dimen / call _ btn _ size " < nl > android : scaleType = " centerInside " < nl > - android : layout _ width = " @ dimen / call _ btn _ size " < nl > - < nl > - / > < nl > + android : layout _ width = " @ dimen / call _ btn _ size " / > < nl > + < nl > < TextView < nl > android : id = " @ + id / back _ tv " < nl > android : layout _ gravity = " center " < nl > @ @ - 265 , 12 + 272 , 14 @ @ < nl > android : gravity = " center " < nl > android : layout _ width = " wrap _ content " < nl > android : layout _ height = " wrap _ content " / > < nl > + < nl > < / LinearLayout > < nl > < nl > < FrameLayout < nl > android : layout _ weight = " 1 " < nl > android : layout _ width = " 0dp " < nl > android : layout _ height = " wrap _ content " > < nl > + < nl > < ImageButton < nl > android : layout _ gravity = " center " < nl > android : visibility = " visible " < nl > @ @ - 287 , 14 + 296 , 14 @ @ < nl > android : layout _ weight = " 1 " < nl > android : layout _ width = " 0dp " < nl > android : layout _ height = " wrap _ content " > < nl > + < nl > < im . actor . sdk . view . TintImageView < nl > android : id = " @ + id / add " < nl > android : layout _ gravity = " center _ horizontal " < nl > android : layout _ height = " @ dimen / call _ btn _ size " < nl > android : scaleType = " centerInside " < nl > - android : layout _ width = " @ dimen / call _ btn _ size " < nl > - < nl > - / > < nl > + android : layout _ width = " @ dimen / call _ btn _ size " / > < nl > + < nl > < TextView < nl > android : id = " @ + id / add _ user _ tv " < nl > android : layout _ gravity = " center " < nl > @ @ - 305 , 17 + 314 , 12 @ @ < nl > android : layout _ height = " wrap _ content " / > < nl > < / LinearLayout > < nl > < nl > - < nl > < / TableRow > < nl > - < / TableLayout > < nl > - < nl > - < nl > - < nl > < nl > + < / TableLayout > < nl > < nl > < / FrameLayout > < nl > < nl > < / LinearLayout > < nl > < nl > - < nl > < / FrameLayout > < nl > diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / webrtc / WebrtcCallActor . scala b / actor - server / actor - core / src / main / scala / im / actor / server / webrtc / WebrtcCallActor . scala < nl > index 66edf9c . . 062069f 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / webrtc / WebrtcCallActor . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / webrtc / WebrtcCallActor . scala < nl > @ @ - 58 , 7 + 58 , 79 @ @ object WebrtcCallActor { < nl > def props = Props ( classOf [ WebrtcCallActor ] ) < nl > } < nl > < nl > - private final class WebrtcCallActor extends StashingActor with ActorLogging { < nl > + private trait Members { < nl > + this : ActorLogging ⇒ < nl > + < nl > + private var members = Map . empty [ UserId , Member ] < nl > + < nl > + sealed trait MemberState < nl > + < nl > + object MemberStates { < nl > + object Ringing extends MemberState < nl > + object RingingReached extends MemberState < nl > + object Connecting extends MemberState < nl > + object Connected extends MemberState < nl > + object Ended extends MemberState < nl > + } < nl > + < nl > + case class Member ( userId : UserId , state : MemberState , isJoined : Boolean ) { < nl > + import MemberStates . _ < nl > + < nl > + lazy val apiState = state match { < nl > + case Ringing ⇒ ApiCallMemberState . RINGING < nl > + case RingingReached ⇒ ApiCallMemberState . RINGING _ REACHED < nl > + case Connecting ⇒ ApiCallMemberState . CONNECTING < nl > + case Connected ⇒ ApiCallMemberState . CONNECTED < nl > + case Ended ⇒ ApiCallMemberState . ENDED < nl > + } < nl > + } < nl > + < nl > + def addMember ( userId : UserId , initState : MemberState , isJoined : Boolean = false ) : Unit = { < nl > + members get userId match { < nl > + case Some ( _ ) ⇒ throw new RuntimeException ( " Attempt to add already existing member " ) < nl > + case None ⇒ < nl > + val member = Member ( userId , initState , isJoined ) < nl > + log . debug ( " Adding member : { } " , member ) < nl > + members + = ( userId → member ) < nl > + } < nl > + } < nl > + < nl > + def setMemberJoined ( userId : UserId , isJoined : Boolean = true ) : Unit = < nl > + members get userId match { < nl > + case Some ( member ) if ! member . isJoined ⇒ members + = userId → member . copy ( isJoined = true ) < nl > + case Some ( _ ) ⇒ throw new RuntimeException ( " Attempt to set member joined who is already joined " ) < nl > + case None ⇒ throw new RuntimeException ( " Attempt to set an unexistent member joined " ) < nl > + } < nl > + < nl > + def setMemberState ( userId : UserId , state : MemberState ) : Unit = < nl > + members get userId match { < nl > + case Some ( member ) ⇒ < nl > + log . debug ( " Changing member [ userId : { } ] state from : { } to : { } " , userId , member . state , state ) < nl > + members + = userId → member . copy ( state = state ) < nl > + case None ⇒ throw new RuntimeException ( " Attempt to change an unexistend member state " ) < nl > + } < nl > + < nl > + def getMember ( userId : UserId ) = members get userId < nl > + < nl > + def memberUserIds = members . keySet < nl > + < nl > + def getMembers = members < nl > + < nl > + def everyoneRejected ( callerUserId : Int ) = < nl > + members . values < nl > + . filterNot ( _ . userId = = callerUserId ) < nl > + . filterNot ( _ . state = = MemberStates . Ended ) < nl > + . isEmpty < nl > + < nl > + def everyoneLeft ( callerUserId : Int ) = { < nl > + val ringing = members . values . filter ( _ . state = = MemberStates . Ringing ) < nl > + val joined = members . values . filter ( _ . isJoined ) < nl > + < nl > + joined . isEmpty & & ringing . isEmpty < nl > + } < nl > + } < nl > + < nl > + private final class WebrtcCallActor extends StashingActor with ActorLogging with Members { < nl > import WebrtcCallMessages . _ < nl > import context . dispatcher < nl > < nl > @ @ - 100 , 7 + 172 , 6 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { < nl > private var scheduledUpds = Map . empty [ UserId , Cancellable ] < nl > private var devices = Map . empty [ EventBus . DeviceId , Device ] < nl > private var clients = Map . empty [ EventBus . Client , EventBus . DeviceId ] < nl > - private var participants = Map . empty [ UserId , ApiCallMemberState . Value ] < nl > private var sessions = Map . empty [ Pair , SessionId ] < nl > private var isConversationStarted : Boolean = false < nl > private var peer = Peer ( ) < nl > @ @ - 129 , 8 + 200 , 8 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { < nl > < nl > advertiseMaster ( eventBusId , callerDeviceId ) < nl > < nl > - callees foreach ( putParticipant ( _ , ApiCallMemberState . RINGING ) ) < nl > - putParticipant ( callerUserId , ApiCallMemberState . CONNECTED ) < nl > + callees foreach ( userId ⇒ addMember ( userId , MemberStates . Ringing ) ) < nl > + addMember ( callerUserId , MemberStates . Connected , isJoined = true ) < nl > broadcastSyncedSet ( ) < nl > < nl > context become callInProgress ( peer , eventBusId , callerDeviceId , System . currentTimeMillis ( ) , callerUserId ) < nl > @ @ - 158 , 7 + 229 , 7 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { < nl > else ApiServiceMessage ( " Missed call " , Some ( ApiServiceExPhoneMissed ) ) < nl > < nl > ( for { < nl > - _ ← if ( peer . ` type ` . isPrivate ) FutureExt . ftraverse ( participants . keySet . toSeq ) ( userId ⇒ dialogExt . sendMessage ( < nl > + _ ← if ( peer . ` type ` . isPrivate ) FutureExt . ftraverse ( memberUserIds . toSeq ) ( userId ⇒ dialogExt . sendMessage ( < nl > peer = ApiPeer ( ApiPeerType . Private , callerUserId ) , < nl > senderUserId = callerUserId , < nl > senderAuthId = None , < nl > @ @ - 203 , 6 + 274 , 7 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { < nl > } yield device ) match { < nl > case Some ( device ) ⇒ < nl > putDevice ( device . deviceId , client , device . copy ( isJoined = true ) ) < nl > + setMemberJoined ( userId ) < nl > cancelIncomingCallUpdates ( userId ) < nl > < nl > weakUpdExt . broadcastUserWeakUpdate ( userId , UpdateCallHandled ( id ) , excludeAuthIds = Set ( authId ) ) < nl > @ @ - 232 , 7 + 304 , 7 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { < nl > this . isConversationStarted = true < nl > < nl > if ( ! isConnected ( userId ) ) { < nl > - putParticipant ( userId , ApiCallMemberState . CONNECTING ) < nl > + setMemberState ( userId , MemberStates . Connecting ) < nl > broadcastSyncedSet ( ) < nl > } < nl > < nl > @ @ - 242 , 6 + 314 , 12 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { < nl > } < nl > case RejectCall ( userId , authId ) ⇒ < nl > cancelIncomingCallUpdates ( userId ) < nl > + setMemberState ( userId , MemberStates . Ended ) < nl > + val client = EventBus . ExternalClient ( userId , authId ) < nl > + for ( deviceId ← clients get client ) { < nl > + clients - = client < nl > + devices - = deviceId < nl > + } < nl > weakUpdExt . broadcastUserWeakUpdate ( userId , UpdateCallHandled ( id ) , excludeAuthIds = Set ( authId ) ) < nl > broadcastSyncedSet ( ) < nl > sender ( ) ! RejectCallAck < nl > @ @ - 249 , 11 + 327 , 9 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { < nl > if ( / / If caller changed his mind until anyone picked up < nl > ( ! this . isConversationStarted & & userId = = callerUserId ) | | < nl > / / If everyone rejected dialing , there will no any conversation ; ( < nl > - ( ! this . isConversationStarted & & < nl > - devices . size = = 1 & & < nl > - devices . headOption . exists ( _ . _ 2 . deviceId = = callerDeviceId ) ) ) end ( ) < nl > + ( ! this . isConversationStarted & & everyoneRejected ( callerUserId ) ) ) end ( ) < nl > case GetInfo ⇒ < nl > - sender ( ) ! GetInfoAck ( eventBusId , peer , participants . keySet . toSeq ) < nl > + sender ( ) ! GetInfoAck ( eventBusId , peer , memberUserIds . toSeq ) < nl > case EventBus . Joined ( _ , client , deviceId ) ⇒ < nl > if ( client . isExternal ) < nl > advertiseMaster ( eventBusId , deviceId ) < nl > @ @ - 271 , 12 + 347 , 15 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { < nl > < nl > for { < nl > userId ← ebMessage . client . externalUserId < nl > - state ← participants . get ( userId ) < nl > - } yield if ( state = = ApiCallMemberState . RINGING ) putParticipant ( userId , ApiCallMemberState . RINGING _ REACHED ) < nl > + member ← getMember ( userId ) < nl > + } yield { < nl > + if ( member . state = = MemberStates . Ringing ) < nl > + setMemberState ( userId , MemberStates . RingingReached ) < nl > + } < nl > } < nl > case msg : ApiNegotinationSuccessful ⇒ < nl > ebMessage . client . externalUserId foreach { userId ⇒ < nl > - putParticipant ( userId , ApiCallMemberState . CONNECTED ) < nl > + setMemberState ( userId , MemberStates . Connected ) < nl > broadcastSyncedSet ( ) < nl > } < nl > case msg : ApiOnRenegotiationNeeded ⇒ < nl > @ @ - 300 , 12 + 379 , 16 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { < nl > case EventBus . Disconnected ( _ , client , deviceId ) ⇒ < nl > removeDevice ( deviceId ) < nl > client . externalUserId foreach { userId ⇒ < nl > - putParticipant ( userId , ApiCallMemberState . ENDED ) < nl > - broadcastSyncedSet ( ) < nl > + if ( ! devices . values . exists ( _ . client . externalUserId . contains ( userId ) ) ) { < nl > + setMemberState ( userId , MemberStates . Ended ) < nl > + broadcastSyncedSet ( ) < nl > + } < nl > } < nl > < nl > - if ( ( ! isConversationStarted & & client . externalUserId . contains ( callerUserId ) ) | | < nl > - ( isConversationStarted & & ! devices . exists ( _ . _ 2 . isJoined ) ) ) end ( ) < nl > + if ( / / no one have been reached and caller left < nl > + ( ! isConversationStarted & & client . externalUserId . contains ( callerUserId ) ) | | < nl > + / / there is no one left who can have a conversation < nl > + ( isConversationStarted & & everyoneLeft ( callerUserId ) ) ) end ( ) < nl > case EventBus . Disposed ( _ ) ⇒ < nl > end ( ) < nl > deleteSyncedSet ( ) < nl > @ @ - 326 , 19 + 409 , 6 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { < nl > sessions . keySet . exists ( pair ⇒ userDevices . contains ( pair . left ) | | userDevices . contains ( pair . right ) ) < nl > } < nl > < nl > - private def putParticipant ( userId : Int , state : ApiCallMemberState . Value ) : Unit = { < nl > - participants get userId match { < nl > - case Some ( oldState ) ⇒ < nl > - if ( oldState ! = state ) { < nl > - log . debug ( " Changing participant { } state from { } to { } " , userId , oldState , state ) < nl > - participants + = userId → state < nl > - } else log . error ( " Attempt to change participant state to the same value { } " , state ) < nl > - case None ⇒ < nl > - log . debug ( " Adding participant { } with state { } " , userId , state ) < nl > - participants + = userId → state < nl > - } < nl > - } < nl > - < nl > private def putDevice ( deviceId : EventBus . DeviceId , client : EventBus . Client , device : Device ) : Unit = { < nl > devices + = deviceId → device < nl > clients + = client → deviceId < nl > @ @ - 360 , 31 + 430 , 28 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { < nl > < nl > private def scheduleIncomingCallUpdates ( callees : Seq [ UserId ] ) : Future [ Unit ] = { < nl > for { < nl > - authIdsMap ← userExt . getAuthIdsMap ( callees . toSet ) < nl > - credsMap ← FutureExt . ftraverse ( authIdsMap . toSeq ) { < nl > - case ( userId , authIds ) ⇒ < nl > - apnsExt . findVoipCreds ( authIds . toSet ) map ( userId → _ ) < nl > - } < nl > + authIds ← userExt . getAuthIds ( callees . toSet ) < nl > + credss ← apnsExt . findVoipCreds ( authIds . toSet ) < nl > } yield { < nl > + credss foreach { creds ⇒ < nl > + val payload = ( new ApnsPayloadBuilder ) . addCustomProperty ( " callId " , id ) . buildWithDefaultMaximumLength ( ) < nl > + < nl > + val instanceCreds = apnsExt . getVoipInstance ( creds . apnsKey ) map ( _ → creds ) < nl > + for ( ( instance , cred ) ← instanceCreds ) { < nl > + val notif = new SimpleApnsPushNotification ( cred . token . toByteArray , payload ) < nl > + instance . getQueue . add ( notif ) < nl > + } < nl > + } < nl > + < nl > scheduledUpds = < nl > - credsMap < nl > - . map { < nl > - case ( userId , creds ) ⇒ < nl > - ( < nl > - userId , < nl > - context . system . scheduler . schedule ( 0 . seconds , 5 . seconds ) { < nl > - weakUpdExt . broadcastUserWeakUpdate ( userId , UpdateIncomingCall ( id ) , reduceKey = Some ( s " call _ $ id " ) ) < nl > - < nl > - val payload = ( new ApnsPayloadBuilder ) . addCustomProperty ( " callId " , id ) . buildWithDefaultMaximumLength ( ) < nl > - < nl > - val instanceCreds = creds flatMap ( c ⇒ apnsExt . getVoipInstance ( c . apnsKey ) map ( _ → c ) ) < nl > - for ( ( instance , cred ) ← instanceCreds ) { < nl > - val notif = new SimpleApnsPushNotification ( cred . token . toByteArray , payload ) < nl > - instance . getQueue . add ( notif ) < nl > - } < nl > - } < nl > - ) < nl > - } < nl > + callees . map { userId ⇒ < nl > + ( < nl > + userId , < nl > + context . system . scheduler . schedule ( 0 . seconds , 5 . seconds ) { < nl > + weakUpdExt . broadcastUserWeakUpdate ( userId , UpdateIncomingCall ( id ) , reduceKey = Some ( s " call _ $ id " ) ) < nl > + } < nl > + ) < nl > + } < nl > . toMap < nl > } < nl > } < nl > @ @ - 397 , 8 + 464 , 9 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { < nl > < nl > private def broadcastSyncedSet ( ) : Unit = { < nl > val activeCall = < nl > - ApiActiveCall ( id , peer . asStruct , participants . toVector map { < nl > - case ( userId , state ) ⇒ < nl > + ApiActiveCall ( id , peer . asStruct , getMembers . toVector map { < nl > + case ( userId , member ) ⇒ < nl > + val state = member . apiState < nl > < nl > ApiCallMember ( userId , ApiCallMemberStateHolder ( < nl > state = state , < nl > @ @ - 409 , 11 + 477 , 11 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { < nl > fallbackIsEnded = Some ( state = = ApiCallMemberState . ENDED ) < nl > ) ) < nl > } ) . toByteArray < nl > - participants . keySet foreach ( valuesExt . syncedSet . put ( _ , Webrtc . SyncedSetName , id , activeCall ) ) < nl > + memberUserIds foreach ( valuesExt . syncedSet . put ( _ , Webrtc . SyncedSetName , id , activeCall ) ) < nl > } < nl > < nl > private def deleteSyncedSet ( ) : Unit = < nl > - participants . keySet foreach { userId ⇒ < nl > + memberUserIds foreach { userId ⇒ < nl > valuesExt . syncedSet . delete ( userId , Webrtc . SyncedSetName , id ) < nl > }
NEAREST DIFF (one line): diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / AndroidManifest . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / AndroidManifest . xml < nl > index 45a21b1 . . 9b27d04 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / AndroidManifest . xml < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / AndroidManifest . xml < nl > @ @ - 21 , 6 + 21 , 7 @ @ < nl > < uses - permission android : name = " android . permission . CAMERA " / > < nl > < uses - permission android : name = " android . permission . MODIFY _ AUDIO _ SETTINGS " / > < nl > < uses - permission android : name = " android . permission . LOCATION _ HARDWARE " / > < nl > + < uses - permission android : name = " android . permission . MODIFY _ AUDIO _ SETTINGS " / > < nl > < uses - permission android : name = " com . android . launcher . permission . INSTALL _ SHORTCUT " / > < nl > < nl > < uses - feature < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / AudioActorEx . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / AudioActorEx . java < nl > index ab63452 . . d2e9acc 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / AudioActorEx . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / AudioActorEx . java < nl > @ @ - 30 , 17 + 30 , 17 @ @ public class AudioActorEx extends AndroidPlayerActor { < nl > state = STATE _ NONE ; < nl > < nl > try { < nl > - < nl > - mplayer = new MediaPlayer ( ) ; < nl > + if ( mplayer = = null ) { < nl > + mplayer = new MediaPlayer ( ) ; < nl > + } < nl > mplayer . setAudioStreamType ( AudioManager . STREAM _ VOICE _ CALL ) ; < nl > mplayer . setDataSource ( context , Uri . parse ( " android . resource : / / " + context . getPackageName ( ) + " / " + R . raw . tone ) ) ; < nl > mplayer . prepare ( ) ; < nl > - mplayer . setLooping ( true ) ; < nl > mplayer . start ( ) ; < nl > mplayer . setOnCompletionListener ( new MediaPlayer . OnCompletionListener ( ) { < nl > @ Override < nl > public void onCompletion ( MediaPlayer mp ) { < nl > - self ( ) . send ( new Stop ( ) ) ; < nl > + self ( ) . send ( new Play ( " " ) ) ; < nl > } < nl > } ) ; < nl > mplayer . setOnErrorListener ( new MediaPlayer . OnErrorListener ( ) { < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallActivity . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallActivity . java < nl > index aa7899c . . 9bcba50 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallActivity . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallActivity . java < nl > @ @ - 1 , 14 + 1 , 22 @ @ < nl > package im . actor . sdk . controllers . calls ; < nl > < nl > import android . os . Bundle ; < nl > + import android . view . Menu ; < nl > import android . view . WindowManager ; < nl > < nl > + import im . actor . core . entity . PeerType ; < nl > + import im . actor . sdk . R ; < nl > import im . actor . sdk . controllers . activity . BaseFragmentActivity ; < nl > < nl > + import static im . actor . sdk . util . ActorSDKMessenger . messenger ; < nl > + < nl > / * * < nl > * Created by ex3ndr on 30 . 09 . 14 . < nl > * / < nl > public class CallActivity extends BaseFragmentActivity { < nl > + < nl > + private long callId ; < nl > + < nl > @ Override < nl > protected void onCreate ( Bundle savedInstanceState ) { < nl > super . onCreate ( savedInstanceState ) ; < nl > @ @ - 23 , 8 + 31 , 18 @ @ public class CallActivity extends BaseFragmentActivity { < nl > WindowManager . LayoutParams . FLAG _ SHOW _ WHEN _ LOCKED | < nl > WindowManager . LayoutParams . FLAG _ TURN _ SCREEN _ ON ) ; < nl > } < nl > - showFragment ( new CallFragment ( getIntent ( ) . getLongExtra ( " callId " , - 1 ) , incoming ) , false , false ) ; < nl > + callId = getIntent ( ) . getLongExtra ( " callId " , - 1 ) ; < nl > + showFragment ( new CallFragment ( callId , incoming ) , false , false ) ; < nl > } < nl > } < nl > < nl > + @ Override < nl > + public boolean onCreateOptionsMenu ( Menu menu ) { < nl > + / / Inflating menu < nl > + getMenuInflater ( ) . inflate ( R . menu . call _ menu , menu ) ; < nl > + if ( messenger ( ) . getCall ( callId ) . getPeer ( ) . getPeerType ( ) ! = PeerType . GROUP ) { < nl > + menu . findItem ( R . id . members ) . setVisible ( false ) ; < nl > + } < nl > + return super . onCreateOptionsMenu ( menu ) ; < nl > + } < nl > } < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java < nl > index 5bb61e2 . . 48a9000 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java < nl > @ @ - 8 , 6 + 8 , 8 @ @ import android . app . PendingIntent ; < nl > import android . content . Context ; < nl > import android . content . Intent ; < nl > import android . content . pm . PackageManager ; < nl > + import android . graphics . Color ; < nl > + import android . media . AudioManager ; < nl > import android . media . Ringtone ; < nl > import android . media . RingtoneManager ; < nl > import android . net . Uri ; < nl > @ @ - 17 , 11 + 19 , 12 @ @ import android . os . Vibrator ; < nl > import android . support . v4 . app . NotificationCompat ; < nl > import android . support . v4 . content . ContextCompat ; < nl > import android . view . LayoutInflater ; < nl > + import android . view . MenuItem ; < nl > import android . view . View ; < nl > import android . view . ViewGroup ; < nl > + import android . widget . AdapterView ; < nl > import android . widget . FrameLayout ; < nl > import android . widget . ImageButton ; < nl > - import android . widget . ImageView ; < nl > import android . widget . ListView ; < nl > import android . widget . TextView ; < nl > < nl > @ @ - 52 , 11 + 55 , 10 @ @ import im . actor . sdk . ActorSDK ; < nl > import im . actor . sdk . R ; < nl > import im . actor . sdk . controllers . fragment . BaseFragment ; < nl > import im . actor . sdk . util . Screen ; < nl > - import im . actor . sdk . view . SearchHighlight ; < nl > + import im . actor . sdk . view . TintImageView ; < nl > import im . actor . sdk . view . adapters . HolderAdapter ; < nl > import im . actor . sdk . view . adapters . ViewHolder ; < nl > import im . actor . sdk . view . avatar . AvatarView ; < nl > - import im . actor . sdk . view . avatar . CoverAvatarView ; < nl > < nl > import static im . actor . sdk . util . ActorSDKMessenger . groups ; < nl > import static im . actor . sdk . util . ActorSDKMessenger . messenger ; < nl > @ @ - 75 , 8 + 77 , 14 @ @ public class CallFragment extends BaseFragment { < nl > private Ringtone ringtone ; < nl > private CallVM call ; < nl > private ActorRef timer ; < nl > - private TextView timerTV ; < nl > + private TextView statusTV ; < nl > private NotificationManager manager ; < nl > + private CallState currentState ; < nl > + private ImageButton endCall ; < nl > + private boolean speakerOn = false ; < nl > + private AudioManager audioManager ; < nl > + private AvatarView avatarView ; < nl > + private ListView membersList ; < nl > < nl > public CallFragment ( ) { < nl > < nl > @ @ - 111 , 7 + 119 , 7 @ @ public class CallFragment extends BaseFragment { < nl > } < nl > } ) ; < nl > ImageButton notAnswer = ( ImageButton ) cont . findViewById ( R . id . notAnswer ) ; < nl > - ImageButton endCall = ( ImageButton ) cont . findViewById ( R . id . end _ call ) ; < nl > + endCall = ( ImageButton ) cont . findViewById ( R . id . end _ call ) ; < nl > notAnswer . setOnClickListener ( new View . OnClickListener ( ) { < nl > @ Override < nl > public void onClick ( View v ) { < nl > @ @ - 126 , 61 + 134 , 145 @ @ public class CallFragment extends BaseFragment { < nl > } ) ; < nl > < nl > / / < nl > - / / Avatar / Name < nl > + / / Avatar / Name bind < nl > / / < nl > - CoverAvatarView avatarView = ( CoverAvatarView ) cont . findViewById ( R . id . avatar ) ; < nl > - avatarView . setBkgrnd ( ( ImageView ) cont . findViewById ( R . id . avatar _ bgrnd ) ) ; < nl > - TextView nameTV = ( TextView ) cont . findViewById ( R . id . name ) ; < nl > - nameTV . setTextColor ( ActorSDK . sharedActor ( ) . style . getProfileTitleColor ( ) ) ; < nl > + avatarView = ( AvatarView ) cont . findViewById ( R . id . avatar ) ; < nl > + avatarView . init ( Screen . dp ( 130 ) , 50 ) ; < nl > < nl > + TextView nameTV = ( TextView ) cont . findViewById ( R . id . name ) ; < nl > + nameTV . setTextColor ( ActorSDK . sharedActor ( ) . style . getTextPrimaryColor ( ) ) ; < nl > if ( peer . getPeerType ( ) = = PeerType . PRIVATE ) { < nl > - < nl > UserVM user = users ( ) . get ( peer . getPeerId ( ) ) ; < nl > - bind ( avatarView , user . getAvatar ( ) ) ; < nl > + avatarView . bind ( user ) ; < nl > bind ( nameTV , user . getName ( ) ) ; < nl > } else if ( peer . getPeerType ( ) = = PeerType . GROUP ) { < nl > GroupVM g = groups ( ) . get ( peer . getPeerId ( ) ) ; < nl > - bind ( avatarView , g . getAvatar ( ) ) ; < nl > + avatarView . bind ( g ) ; < nl > bind ( nameTV , g . getName ( ) ) ; < nl > } < nl > < nl > - ListView membersList = ( ListView ) cont . findViewById ( R . id . members _ list ) ; < nl > + / / < nl > + / / Members list < nl > + / / < nl > + membersList = ( ListView ) cont . findViewById ( R . id . members _ list ) ; < nl > CallMembersAdapter membersAdapter = new CallMembersAdapter ( getActivity ( ) , call . getMembers ( ) ) ; < nl > membersList . setAdapter ( membersAdapter ) ; < nl > < nl > - timerTV = ( TextView ) cont . findViewById ( R . id . timer ) ; < nl > - timerTV . setTextColor ( ActorSDK . sharedActor ( ) . style . getProfileSubtitleColor ( ) ) ; < nl > + / / < nl > + / / Members list / avatar switch < nl > + / / < nl > + View . OnClickListener listener = new View . OnClickListener ( ) { < nl > + @ Override < nl > + public void onClick ( View v ) { < nl > + switchAvatarMembers ( ) ; < nl > + } < nl > + } ; < nl > + avatarView . setOnClickListener ( listener ) ; < nl > + cont . findViewById ( R . id . background ) . setOnClickListener ( listener ) ; < nl > + < nl > + membersList . setOnItemClickListener ( new AdapterView . OnItemClickListener ( ) { < nl > + @ Override < nl > + public void onItemClick ( AdapterView < ? > parent , View view , int position , long id ) { < nl > + switchAvatarMembers ( ) ; < nl > + } < nl > + < nl > + } ) ; < nl > + < nl > + < nl > + < nl > + statusTV = ( TextView ) cont . findViewById ( R . id . status ) ; < nl > + statusTV . setTextColor ( ActorSDK . sharedActor ( ) . style . getTextSecondaryColor ( ) ) ; < nl > < nl > / / < nl > / / Check permission < nl > / / < nl > if ( ContextCompat . checkSelfPermission ( getActivity ( ) , Manifest . permission . RECORD _ AUDIO ) ! = PackageManager . PERMISSION _ GRANTED | | < nl > ContextCompat . checkSelfPermission ( getActivity ( ) , Manifest . permission . VIBRATE ) ! = PackageManager . PERMISSION _ GRANTED | | < nl > + ContextCompat . checkSelfPermission ( getActivity ( ) , Manifest . permission . MODIFY _ AUDIO _ SETTINGS ) ! = PackageManager . PERMISSION _ GRANTED | | < nl > ContextCompat . checkSelfPermission ( getActivity ( ) , Manifest . permission . WAKE _ LOCK ) ! = PackageManager . PERMISSION _ GRANTED ) { < nl > Log . d ( " Permissions " , " call - no permission : c " ) ; < nl > - CallFragment . this . requestPermissions ( new String [ ] { Manifest . permission . RECORD _ AUDIO , Manifest . permission . VIBRATE , Manifest . permission . WAKE _ LOCK } , < nl > + CallFragment . this . requestPermissions ( new String [ ] { Manifest . permission . RECORD _ AUDIO , Manifest . permission . VIBRATE , Manifest . permission . MODIFY _ AUDIO _ SETTINGS , Manifest . permission . WAKE _ LOCK } , < nl > PERMISSIONS _ REQUEST _ FOR _ CALL ) ; < nl > < nl > } < nl > < nl > + audioManager = ( AudioManager ) getActivity ( ) . getSystemService ( Context . AUDIO _ SERVICE ) ; < nl > + final TintImageView speaker = ( TintImageView ) cont . findViewById ( R . id . speaker ) ; < nl > + speaker . setResource ( R . drawable . ic _ volume _ up _ white _ 36dp ) ; < nl > + speaker . setTint ( getResources ( ) . getColor ( R . color . primary ) ) ; < nl > + speaker . setOnClickListener ( new View . OnClickListener ( ) { < nl > + @ Override < nl > + public void onClick ( View v ) { < nl > + speakerOn = ! speakerOn ; < nl > + audioManager . setSpeakerphoneOn ( speakerOn ) ; < nl > + if ( speakerOn ) { < nl > + speaker . setBackgroundResource ( R . drawable . call _ action _ background _ active ) ; < nl > + speaker . setTint ( Color . WHITE ) ; < nl > + } else { < nl > + speaker . setBackgroundResource ( R . drawable . call _ action _ background ) ; < nl > + speaker . setTint ( getResources ( ) . getColor ( R . color . primary ) ) ; < nl > + } < nl > + } < nl > + } ) ; < nl > + < nl > + final TintImageView muteCall = ( TintImageView ) cont . findViewById ( R . id . mute ) ; < nl > + muteCall . setResource ( R . drawable . ic _ mic _ off _ white _ 36dp ) ; < nl > + muteCall . setOnClickListener ( new View . OnClickListener ( ) { < nl > + @ Override < nl > + public void onClick ( View v ) { < nl > + messenger ( ) . toggleCallMute ( callId ) ; < nl > + } < nl > + } ) ; < nl > + < nl > + < nl > + < nl > + call . getIsMuted ( ) . subscribe ( new ValueChangedListener < Boolean > ( ) { < nl > + @ Override < nl > + public void onChanged ( Boolean val , Value < Boolean > valueModel ) { < nl > + if ( val ) { < nl > + muteCall . setBackgroundResource ( R . drawable . call _ action _ background _ active ) ; < nl > + muteCall . setTint ( Color . WHITE ) ; < nl > + } else { < nl > + muteCall . setBackgroundResource ( R . drawable . call _ action _ background ) ; < nl > + muteCall . setTint ( getResources ( ) . getColor ( R . color . primary ) ) ; < nl > + } < nl > + } < nl > + } ) ; < nl > + < nl > call . getState ( ) . subscribe ( new ValueChangedListener < CallState > ( ) { < nl > @ Override < nl > public void onChanged ( CallState val , Value < CallState > valueModel ) { < nl > - switch ( val ) { < nl > - case ENDED : < nl > + if ( currentState ! = val ) { < nl > + currentState = val ; < nl > + switch ( val ) { < nl > + < nl > + case CALLING : < nl > + if ( call . isOutgoing ( ) ) { < nl > + statusTV . setText ( R . string . call _ outgoing ) ; < nl > + } else { < nl > + statusTV . setText ( R . string . call _ incoming ) ; < nl > + initIncoming ( ) ; < nl > + } < nl > + enableWakeLock ( ) ; < nl > + break ; < nl > + < nl > + case CONNECTING : < nl > + statusTV . setText ( R . string . call _ connecting ) ; < nl > + break ; < nl > + < nl > + case IN _ PROGRESS : < nl > + onConnected ( ) ; < nl > + startTimer ( ) ; < nl > + break ; < nl > + < nl > + case ENDED : < nl > + statusTV . setText ( R . string . call _ ended ) ; < nl > onCallEnd ( ) ; < nl > break ; < nl > - case IN _ PROGRESS : < nl > - onConnected ( ) ; < nl > - startTimer ( ) ; < nl > - break ; < nl > - case CALLING _ INCOMING : < nl > - initIncoming ( ) ; < nl > - break ; < nl > - case CALLING _ OUTGOING : < nl > - onConnecting ( ) ; < nl > - break ; < nl > + < nl > + } < nl > } < nl > + < nl > } < nl > } , true ) ; < nl > < nl > @ @ - 188 , 6 + 280 , 18 @ @ public class CallFragment extends BaseFragment { < nl > return cont ; < nl > } < nl > < nl > + public void switchAvatarMembers ( ) { < nl > + if ( peer . getPeerType ( ) = = PeerType . GROUP ) { < nl > + if ( avatarView . getVisibility ( ) = = View . VISIBLE ) { < nl > + hideView ( avatarView ) ; < nl > + showView ( membersList ) ; < nl > + } else { < nl > + hideView ( membersList ) ; < nl > + showView ( avatarView ) ; < nl > + } < nl > + } < nl > + } < nl > + < nl > private void startTimer ( ) { < nl > < nl > final DateFormat formatter = new SimpleDateFormat ( " HH : mm : ss " ) ; < nl > @ @ - 207 , 7 + 311 , 9 @ @ public class CallFragment extends BaseFragment { < nl > getActivity ( ) . runOnUiThread ( new Runnable ( ) { < nl > @ Override < nl > public void run ( ) { < nl > - timerTV . setText ( formatter . format ( new Date ( timeFromRegister ) ) ) ; < nl > + if ( currentState = = CallState . IN _ PROGRESS ) { < nl > + statusTV . setText ( formatter . format ( new Date ( timeFromRegister ) ) ) ; < nl > + } < nl > } < nl > } ) ; < nl > } < nl > @ @ - 231 , 6 + 337 , 7 @ @ public class CallFragment extends BaseFragment { < nl > < nl > private void initIncoming ( ) { < nl > answerContainer . setVisibility ( View . VISIBLE ) ; < nl > + endCall . setVisibility ( View . INVISIBLE ) ; < nl > < nl > new Thread ( new Runnable ( ) { < nl > @ Override < nl > @ @ - 239 , 7 + 346 , 7 @ @ public class CallFragment extends BaseFragment { < nl > Thread . sleep ( 1100 ) ; < nl > Uri notification = RingtoneManager . getDefaultUri ( RingtoneManager . TYPE _ RINGTONE ) ; < nl > ringtone = RingtoneManager . getRingtone ( getActivity ( ) , notification ) ; < nl > - if ( getActivity ( ) ! = null & answerContainer . getVisibility ( ) = = View . VISIBLE ) { < nl > + if ( getActivity ( ) ! = null & answerContainer . getVisibility ( ) = = View . VISIBLE & & currentState = = CallState . CALLING ) { < nl > if ( ringtone ! = null ) { < nl > ringtone . play ( ) ; < nl > } < nl > @ @ - 255 , 7 + 362 , 7 @ @ public class CallFragment extends BaseFragment { < nl > < nl > private void onAnswer ( ) { < nl > < nl > - onConnecting ( ) ; < nl > + endCall . setVisibility ( View . VISIBLE ) ; < nl > answerContainer . setVisibility ( View . INVISIBLE ) ; < nl > if ( ringtone ! = null ) { < nl > ringtone . stop ( ) ; < nl > @ @ - 278 , 7 + 385 , 7 @ @ public class CallFragment extends BaseFragment { < nl > private int field = 0x00000020 ; < nl > < nl > < nl > - public void onConnecting ( ) { < nl > + public void enableWakeLock ( ) { < nl > powerManager = ( PowerManager ) getActivity ( ) . getSystemService ( Context . POWER _ SERVICE ) ; < nl > wakeLock = powerManager . newWakeLock ( field , getActivity ( ) . getLocalClassName ( ) ) ; < nl > < nl > @ @ - 296 , 6 + 403 , 7 @ @ public class CallFragment extends BaseFragment { < nl > } < nl > < nl > public void onCallEnd ( ) { < nl > + audioManager . setSpeakerphoneOn ( false ) ; < nl > vibrate = false ; < nl > if ( ringtone ! = null ) { < nl > ringtone . stop ( ) ; < nl > @ @ - 321 , 6 + 429 , 15 @ @ public class CallFragment extends BaseFragment { < nl > } < nl > < nl > @ Override < nl > + public boolean onOptionsItemSelected ( MenuItem item ) { < nl > + if ( item . getItemId ( ) = = R . id . members ) { < nl > + switchAvatarMembers ( ) ; < nl > + } < nl > + return super . onOptionsItemSelected ( item ) ; < nl > + } < nl > + < nl > + < nl > + @ Override < nl > public void onPause ( ) { < nl > super . onPause ( ) ; < nl > if ( call . getState ( ) . get ( ) ! = CallState . ENDED ) { < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / view / avatar / AvatarView . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / view / avatar / AvatarView . java < nl > index f00df38 . . 59d1838 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / view / avatar / AvatarView . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / view / avatar / AvatarView . java < nl > @ @ - 17 , 6 + 17 , 7 @ @ import com . facebook . imagepipeline . request . ImageRequestBuilder ; < nl > import java . io . File ; < nl > < nl > import im . actor . core . entity . Avatar ; < nl > + import im . actor . core . entity . AvatarImage ; < nl > import im . actor . core . entity . Contact ; < nl > import im . actor . core . entity . Dialog ; < nl > import im . actor . core . entity . PublicGroup ; < nl > @ @ - 91 , 8 + 92 , 8 @ @ public class AvatarView extends SimpleDraweeView { < nl > < nl > public void bind ( Avatar avatar , String title , int id ) { < nl > / / Same avatar < nl > - if ( avatar ! = null & & avatar . getSmallImage ( ) ! = null < nl > - & & avatar . getSmallImage ( ) . getFileReference ( ) . getFileId ( ) = = currentId ) { < nl > + if ( avatar ! = null & & getImage ( avatar ) ! = null < nl > + & & getImage ( avatar ) . getFileReference ( ) . getFileId ( ) = = currentId ) { < nl > return ; < nl > } < nl > < nl > @ @ - 105 , 13 + 106 , 13 @ @ public class AvatarView extends SimpleDraweeView { < nl > < nl > setImageURI ( null ) ; < nl > < nl > - if ( avatar = = null | | avatar . getSmallImage ( ) = = null ) { < nl > + if ( avatar = = null | | getImage ( avatar ) = = null ) { < nl > currentId = 0 ; < nl > return ; < nl > } < nl > - currentId = avatar . getSmallImage ( ) . getFileReference ( ) . getFileId ( ) ; < nl > + currentId = getImage ( avatar ) . getFileReference ( ) . getFileId ( ) ; < nl > < nl > - bindedFile = messenger ( ) . bindFile ( avatar . getSmallImage ( ) . getFileReference ( ) , true , new FileVMCallback ( ) { < nl > + bindedFile = messenger ( ) . bindFile ( getImage ( avatar ) . getFileReference ( ) , true , new FileVMCallback ( ) { < nl > @ Override < nl > public void onNotDownloaded ( ) { < nl > < nl > @ @ - 137 , 6 + 138 , 11 @ @ public class AvatarView extends SimpleDraweeView { < nl > } ) ; < nl > } < nl > < nl > + public AvatarImage getImage ( Avatar avatar ) { < nl > + < nl > + return size > = 100 ? avatar . getLargeImage ( ) : avatar . getSmallImage ( ) ; < nl > + } < nl > + < nl > public void bindRaw ( String fileName ) { < nl > if ( bindedFile ! = null ) { < nl > bindedFile . detach ( ) ; < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / answer _ background . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / answer _ background . xml < nl > new file mode 100644 < nl > index 0000000 . . 729e3ca < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / answer _ background . xml < nl > @ @ - 0 , 0 + 1 , 9 @ @ < nl > + < ? xml version = " 1 . 0 " encoding = " utf - 8 " ? > < nl > + < ! - - < nl > + ~ Copyright ( C ) 2015 Actor LLC . < https : / / actor . im > < nl > + - - > < nl > + < nl > + < shape xmlns : android = " http : / / schemas . android . com / apk / res / android " < nl > + android : shape = " oval " > < nl > + < solid android : color = " @ color / primary _ alt " / > < nl > + < / shape > < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / call _ action _ background . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / call _ action _ background . xml < nl > new file mode 100644 < nl > index 0000000 . . 3597075 < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / call _ action _ background . xml < nl > @ @ - 0 , 0 + 1 , 10 @ @ < nl > + < ? xml version = " 1 . 0 " encoding = " utf - 8 " ? > < nl > + < ! - - < nl > + ~ Copyright ( C ) 2015 Actor LLC . < https : / / actor . im > < nl > + - - > < nl > + < nl > + < shape xmlns : android = " http : / / schemas . android . com / apk / res / android " < nl > + android : shape = " oval " > < nl > + < solid android : color = " @ android : color / transparent " / > < nl > + < stroke android : width = " 2dp " android : color = " @ color / primary " / > < nl > + < / shape > < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / call _ action _ background _ active . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / call _ action _ background _ active . xml < nl > new file mode 100644 < nl > index 0000000 . . f1c872d < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / call _ action _ background _ active . xml < nl > @ @ - 0 , 0 + 1 , 10 @ @ < nl > + < ? xml version = " 1 . 0 " encoding = " utf - 8 " ? > < nl > + < ! - - < nl > + ~ Copyright ( C ) 2015 Actor LLC . < https : / / actor . im > < nl > + - - > < nl > + < nl > + < shape xmlns : android = " http : / / schemas . android . com / apk / res / android " < nl > + android : shape = " oval " > < nl > + < solid android : color = " @ color / primary " / > < nl > + < stroke android : width = " 2dp " android : color = " @ color / primary " / > < nl > + < / shape > < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / end _ call _ background . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / end _ call _ background . xml < nl > new file mode 100644 < nl > index 0000000 . . dd3a7f9 < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / end _ call _ background . xml < nl > @ @ - 0 , 0 + 1 , 9 @ @ < nl > + < ? xml version = " 1 . 0 " encoding = " utf - 8 " ? > < nl > + < ! - - < nl > + ~ Copyright ( C ) 2015 Actor LLC . < https : / / actor . im > < nl > + - - > < nl > + < nl > + < shape xmlns : android = " http : / / schemas . android . com / apk / res / android " < nl > + android : shape = " oval " > < nl > + < solid android : color = " @ color / accent " / > < nl > + < / shape > < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml < nl > index 6ce5969 . . 1150291 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml < nl > @ @ - 4 , 80 + 4 , 165 @ @ < nl > android : layout _ width = " match _ parent " < nl > android : layout _ height = " match _ parent " > < nl > < nl > - < ImageView < nl > - android : id = " @ + id / avatar _ bgrnd " < nl > + < im . actor . sdk . controllers . conversation . view . ChatBackgroundView < nl > + android : id = " @ + id / background " < nl > android : layout _ width = " match _ parent " < nl > - android : layout _ height = " match _ parent " < nl > - android : src = " @ drawable / img _ profile _ avatar _ default " < nl > - android : scaleType = " centerCrop " / > < nl > + android : layout _ height = " match _ parent " / > < nl > < nl > - < im . actor . sdk . view . avatar . CoverAvatarView < nl > - android : id = " @ + id / avatar " < nl > + < LinearLayout < nl > android : layout _ width = " match _ parent " < nl > - android : layout _ height = " match _ parent " / > < nl > + android : layout _ height = " match _ parent " < nl > + android : weightSum = " 2 " < nl > + android : orientation = " vertical " > < nl > < nl > - < LinearLayout < nl > - android : layout _ width = " wrap _ content " < nl > - android : layout _ height = " wrap _ content " < nl > - android : layout _ gravity = " top | left " < nl > - android : orientation = " vertical " < nl > - android : layout _ margin = " 40dp " < nl > - > < nl > - < TextView < nl > - android : id = " @ + id / name " < nl > - android : layout _ width = " wrap _ content " < nl > - android : layout _ height = " wrap _ content " < nl > - android : ellipsize = " end " < nl > - android : includeFontPadding = " false " < nl > - android : lines = " 1 " < nl > - android : textSize = " 26sp " / > < nl > - < nl > - < TextView < nl > - android : id = " @ + id / timer " < nl > - android : layout _ width = " wrap _ content " < nl > - android : layout _ height = " wrap _ content " < nl > - android : textSize = " @ dimen / text _ secondary " / > < nl > - < nl > - < ListView < nl > - android : id = " @ + id / members _ list " < nl > - android : layout _ width = " wrap _ content " < nl > - android : layout _ height = " wrap _ content " / > < nl > - < / LinearLayout > < nl > + < RelativeLayout < nl > + < nl > + android : layout _ width = " match _ parent " < nl > + android : layout _ height = " 0dp " < nl > + android : layout _ gravity = " top | center _ horizontal " < nl > + android : orientation = " vertical " < nl > + android : layout _ weight = " 1 " > < nl > + < nl > + < im . actor . sdk . view . avatar . AvatarView < nl > + android : id = " @ + id / avatar " < nl > + android : layout _ width = " 130dp " < nl > + android : layout _ height = " 130dp " < nl > + android : layout _ centerVertical = " true " < nl > + android : layout _ centerHorizontal = " true " / > < nl > + < nl > + < ListView < nl > + android : paddingLeft = " 20dp " < nl > + android : paddingRight = " 20dp " < nl > + android : visibility = " invisible " < nl > + android : id = " @ + id / members _ list " < nl > + android : layout _ centerVertical = " true " < nl > + android : layout _ centerHorizontal = " true " < nl > + android : layout _ width = " match _ parent " < nl > + android : layout _ height = " 130dp " / > < nl > + < nl > + < TextView < nl > + android : gravity = " center " < nl > + android : layout _ centerHorizontal = " true " < nl > + android : layout _ below = " @ id / avatar " < nl > + android : id = " @ + id / name " < nl > + android : layout _ width = " wrap _ content " < nl > + android : layout _ height = " match _ parent " < nl > + android : lines = " 1 " < nl > + android : textSize = " 26sp " < nl > + android : layout _ alignParentBottom = " true " / > < nl > + < nl > + < nl > + < nl > + < nl > + < nl > + < / RelativeLayout > < nl > + < nl > + < FrameLayout < nl > + android : layout _ width = " match _ parent " < nl > + android : layout _ height = " 0dp " < nl > + android : layout _ gravity = " top | center _ horizontal " < nl > + android : orientation = " vertical " < nl > + android : layout _ weight = " 1 " > < nl > + < nl > + < LinearLayout < nl > + android : id = " @ + id / answer _ container " < nl > + android : visibility = " invisible " < nl > + android : layout _ width = " match _ parent " < nl > + android : layout _ height = " 60dp " < nl > + android : orientation = " horizontal " < nl > + android : layout _ gravity = " bottom " < nl > + android : layout _ marginBottom = " 20dp " > < nl > + < nl > + < FrameLayout < nl > + android : layout _ width = " 0dp " < nl > + android : layout _ weight = " 1 " < nl > + android : layout _ height = " 60dp " > < nl > + < nl > + < ImageButton < nl > + android : layout _ gravity = " center " < nl > + android : id = " @ + id / notAnswer " < nl > + android : layout _ width = " 60dp " < nl > + android : layout _ height = " 60dp " < nl > + android : background = " @ drawable / end _ call _ background " < nl > + android : src = " @ drawable / ic _ call _ end _ white _ 36dp " / > < nl > + < / FrameLayout > < nl > + < nl > + < FrameLayout < nl > + android : layout _ width = " 0dp " < nl > + android : layout _ weight = " 1 " < nl > + android : layout _ height = " 60dp " > < nl > + < ImageButton < nl > + android : layout _ gravity = " center " < nl > + android : id = " @ + id / answer " < nl > + android : layout _ width = " 60dp " < nl > + android : layout _ height = " 60dp " < nl > + android : background = " @ drawable / answer _ background " < nl > + android : src = " @ drawable / ic _ call _ white _ 36dp " / > < nl > + < nl > + < / FrameLayout > < nl > + < nl > + < / LinearLayout > < nl > + < nl > + < ImageButton < nl > + android : visibility = " visible " < nl > + android : layout _ gravity = " bottom | center _ horizontal " < nl > + android : id = " @ + id / end _ call " < nl > + android : layout _ width = " 60dp " < nl > + android : layout _ height = " 60dp " < nl > + android : background = " @ drawable / end _ call _ background " < nl > + android : src = " @ drawable / ic _ call _ end _ white _ 36dp " < nl > + android : layout _ marginBottom = " 20dp " / > < nl > + < nl > + < TextView < nl > + android : layout _ gravity = " center _ horizontal | top " < nl > + android : id = " @ + id / status " < nl > + android : layout _ width = " wrap _ content " < nl > + android : layout _ height = " wrap _ content " < nl > + android : textSize = " 20sp " / > < nl > + < nl > + < LinearLayout < nl > + android : layout _ width = " match _ parent " < nl > + android : layout _ height = " wrap _ content " < nl > + android : orientation = " horizontal " < nl > + android : weightSum = " 2 " < nl > + android : layout _ gravity = " center " > < nl > + < nl > + < nl > + < FrameLayout < nl > + android : layout _ weight = " 1 " < nl > + android : layout _ width = " 0dp " < nl > + android : layout _ height = " wrap _ content " > < nl > + < im . actor . sdk . view . TintImageView < nl > + android : id = " @ + id / speaker " < nl > + android : layout _ gravity = " center _ horizontal " < nl > + android : layout _ height = " 60dp " < nl > + android : scaleType = " centerInside " < nl > + android : layout _ width = " 60dp " < nl > + android : background = " @ drawable / call _ action _ background " < nl > + / > < nl > + < / FrameLayout > < nl > + < nl > + < FrameLayout < nl > + android : layout _ weight = " 1 " < nl > + android : layout _ width = " 0dp " < nl > + android : layout _ height = " wrap _ content " > < nl > + < im . actor . sdk . view . TintImageView < nl > + android : id = " @ + id / mute " < nl > + android : layout _ gravity = " center _ horizontal " < nl > + android : layout _ height = " 60dp " < nl > + android : scaleType = " centerInside " < nl > + android : layout _ width = " 60dp " < nl > + android : background = " @ drawable / call _ action _ background " < nl > + / > < nl > + < / FrameLayout > < nl > + < nl > + < / LinearLayout > < nl > + < nl > + < / FrameLayout > < nl > < nl > < nl > - < ImageButton < nl > - android : layout _ gravity = " bottom " < nl > - android : id = " @ + id / end _ call " < nl > - android : layout _ width = " match _ parent " < nl > - android : layout _ height = " 60dp " < nl > - android : background = " @ color / accent " < nl > - android : src = " @ drawable / ic _ call _ white _ 36dp " / > < nl > < nl > - < LinearLayout < nl > - android : id = " @ + id / answer _ container " < nl > - android : visibility = " invisible " < nl > - android : layout _ width = " match _ parent " < nl > - android : layout _ height = " 60dp " < nl > - android : orientation = " horizontal " < nl > - android : layout _ gravity = " bottom " > < nl > - < nl > - < ImageButton < nl > - android : layout _ gravity = " bottom " < nl > - android : id = " @ + id / answer " < nl > - android : layout _ width = " 0dp " < nl > - android : layout _ weight = " 1 " < nl > - android : layout _ height = " 60dp " < nl > - android : background = " @ color / primary _ alt " < nl > - android : src = " @ drawable / ic _ call _ white _ 36dp " / > < nl > - < nl > - < ImageButton < nl > - android : layout _ gravity = " bottom " < nl > - android : id = " @ + id / notAnswer " < nl > - android : layout _ width = " 0dp " < nl > - android : layout _ weight = " 1 " < nl > - android : layout _ height = " 60dp " < nl > - android : background = " @ color / accent " < nl > - android : src = " @ drawable / ic _ call _ white _ 36dp " / > < nl > < / LinearLayout > < nl > < nl > + < nl > < / FrameLayout > < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / menu / call _ menu . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / menu / call _ menu . xml < nl > new file mode 100644 < nl > index 0000000 . . c7dfa0e < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / menu / call _ menu . xml < nl > @ @ - 0 , 0 + 1 , 17 @ @ < nl > + < ? xml version = " 1 . 0 " encoding = " utf - 8 " ? > < nl > + < nl > + < ! - - < nl > + ~ Copyright ( C ) 2015 Actor LLC . < https : / / actor . im > < nl > + - - > < nl > + < nl > + < menu xmlns : android = " http : / / schemas . android . com / apk / res / android " < nl > + xmlns : app = " http : / / schemas . android . com / apk / res - auto " > < nl > + < nl > + < item < nl > + android : id = " @ + id / members " < nl > + android : icon = " @ drawable / main _ bar _ contacts _ active " < nl > + android : title = " " < nl > + app : showAsAction = " always " / > < nl > + < nl > + < nl > + < / menu > < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / values / ui _ text . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / values / ui _ text . xml < nl > index 5461c8d . . 0ac8749 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / res / values / ui _ text . xml < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / values / ui _ text . xml < nl > @ @ - 458 , 6 + 458 , 12 @ @ < nl > < string name = " media _ pager " formatted = " false " > % d of % d < / string > < nl > < string name = " emoji _ no _ recent " > no recent emoji yet < / string > < nl > < nl > + < ! - - Calls - - > < nl > + < string name = " call _ ended " > Call ended < / string > < nl > + < string name = " call _ incoming " > Incoming call < / string > < nl > + < string name = " call _ outgoing " > Ringing … < / string > < nl > + < string name = " call _ connecting " > Connecting … < / string > < nl > + < nl > < ! - - Dialogs - - > < nl > < string name = " alert _ leave _ group _ message " > Are you sure want to exit group " % 1 $ s " ? < / string > < nl > < string name = " alert _ leave _ group _ yes " > Exit < / string >

TEST DIFF:
diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java 
 index 1c81113 . . 4cb5158 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java 
 @ @ - 10 , 7 + 10 , 6 @ @ import android . content . Intent ; 
 import android . content . pm . PackageManager ; 
 import android . graphics . Color ; 
 import android . graphics . drawable . GradientDrawable ; 
 - import android . graphics . drawable . ShapeDrawable ; 
 import android . media . AudioManager ; 
 import android . media . Ringtone ; 
 import android . media . RingtoneManager ; 
 @ @ - 136 , 7 + 135 , 7 @ @ public class CallFragment extends BaseFragment { 
 for ( int i = 0 ; i < avatarLayers . length ; i + + ) { 
 View layer = avatarLayers [ i ] ; 
 ( ( GradientDrawable ) layer . getBackground ( ) ) . setColor ( Color . WHITE ) ; 
 - ( ( GradientDrawable ) layer . getBackground ( ) ) . setAlpha ( 150 ) ; 
 + ( ( GradientDrawable ) layer . getBackground ( ) ) . setAlpha ( 50 ) ; 
 } 
 
 answerContainer = cont . findViewById ( R . id . answer _ container ) ; 
 @ @ - 180 , 6 + 179 , 8 @ @ public class CallFragment extends BaseFragment { 
 bind ( nameTV , g . getName ( ) ) ; 
 } 
 
 + nameTV . setSelected ( true ) ; 
 + 
 / / 
 / / Members list 
 / / 
 @ @ - 234 , 19 + 235 , 13 @ @ public class CallFragment extends BaseFragment { 
 cont . findViewById ( R . id . speaker _ btn ) . setOnClickListener ( new View . OnClickListener ( ) { 
 @ Override 
 public void onClick ( View v ) { 
 - speakerOn = ! speakerOn ; 
 - audioManager . setSpeakerphoneOn ( speakerOn ) ; 
 - if ( speakerOn ) { 
 - speaker . setTint ( Color . WHITE ) ; 
 - speakerTV . setTextColor ( Color . WHITE ) ; 
 - } else { 
 - speaker . setTint ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; 
 - speakerTV . setTextColor ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; 
 - } 
 + toggleSpeaker ( speaker , speakerTV ) ; 
 } 
 } ) ; 
 + checkSpeaker ( speaker , speakerTV ) ; 
 
 final TintImageView muteCall = ( TintImageView ) cont . findViewById ( R . id . mute ) ; 
 + final TextView muteCallTv = ( TextView ) cont . findViewById ( R . id . mute _ tv ) ; 
 muteCall . setResource ( R . drawable . ic _ mic _ off _ white _ 24dp ) ; 
 cont . findViewById ( R . id . mute _ btn ) . setOnClickListener ( new View . OnClickListener ( ) { 
 @ Override 
 @ @ - 257 , 24 + 252 , 35 @ @ public class CallFragment extends BaseFragment { 
 
 final TintImageView video = ( TintImageView ) cont . findViewById ( R . id . video ) ; 
 video . setResource ( R . drawable . ic _ videocam _ white _ 24dp ) ; 
 + TextView videoTv = ( TextView ) cont . findViewById ( R . id . video _ tv ) ; 
 + videoTv . setTextColor ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; 
 + video . setTint ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; 
 
 final TintImageView back = ( TintImageView ) cont . findViewById ( R . id . back ) ; 
 back . setResource ( R . drawable . ic _ message _ white _ 24dp ) ; 
 + cont . findViewById ( R . id . back _ btn ) . setOnClickListener ( new View . OnClickListener ( ) { 
 + @ Override 
 + public void onClick ( View v ) { 
 + getActivity ( ) . onBackPressed ( ) ; 
 + } 
 + } ) ; 
 
 final TintImageView add = ( TintImageView ) cont . findViewById ( R . id . add ) ; 
 add . setResource ( R . drawable . ic _ person _ add _ white _ 24dp ) ; 
 - 
 + TextView addTv = ( TextView ) cont . findViewById ( R . id . add _ user _ tv ) ; 
 + addTv . setTextColor ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; 
 + add . setTint ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; 
 
 if ( call ! = null ) { 
 call . getIsMuted ( ) . subscribe ( new ValueChangedListener < Boolean > ( ) { 
 @ Override 
 public void onChanged ( Boolean val , Value < Boolean > valueModel ) { 
 if ( val ) { 
 - muteCall . setBackgroundResource ( R . drawable . call _ action _ background _ active ) ; 
 - muteCall . setTint ( Color . WHITE ) ; 
 + muteCallTv . setTextColor ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; 
 + muteCall . setTint ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; 
 } else { 
 - muteCall . setBackgroundResource ( R . drawable . call _ action _ background ) ; 
 - muteCall . setTint ( getResources ( ) . getColor ( R . color . primary ) ) ; 
 + muteCallTv . setTextColor ( Color . WHITE ) ; 
 + muteCall . setTint ( Color . WHITE ) ; 
 } 
 } 
 } ) ; 
 @ @ - 323 , 6 + 329 , 22 @ @ public class CallFragment extends BaseFragment { 
 return cont ; 
 } 
 
 + public void toggleSpeaker ( TintImageView speaker , TextView speakerTV ) { 
 + speakerOn = ! speakerOn ; 
 + audioManager . setSpeakerphoneOn ( speakerOn ) ; 
 + checkSpeaker ( speaker , speakerTV ) ; 
 + } 
 + 
 + public void checkSpeaker ( TintImageView speaker , TextView speakerTV ) { 
 + if ( speakerOn ) { 
 + speaker . setTint ( Color . WHITE ) ; 
 + speakerTV . setTextColor ( Color . WHITE ) ; 
 + } else { 
 + speaker . setTint ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; 
 + speakerTV . setTextColor ( getResources ( ) . getColor ( R . color . picker _ grey ) ) ; 
 + } 
 + } 
 + 
 public void switchAvatarMembers ( ) { 
 if ( peer . getPeerType ( ) = = PeerType . GROUP ) { 
 if ( avatarView . getVisibility ( ) = = View . VISIBLE ) { 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml 
 index d295f55 . . 7cd8351 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml 
 @ @ - 4 , 7 + 4 , 6 @ @ 
 android : layout _ width = " match _ parent " 
 android : layout _ height = " match _ parent " > 
 
 - 
 < LinearLayout 
 android : layout _ width = " match _ parent " 
 android : layout _ height = " match _ parent " 
 @ @ - 14 , 14 + 13 , 14 @ @ 
 
 < TextView 
 android : id = " @ + id / status " 
 - android : layout _ marginTop = " 40dp " 
 + android : layout _ marginTop = " 37 . 5dp " 
 android : layout _ gravity = " center " 
 android : gravity = " center " 
 android : layout _ width = " wrap _ content " 
 android : layout _ height = " wrap _ content " 
 - android : textSize = " 20sp " 
 - android : textColor = " @ android : color / white " 
 - android : text = " Ringing . . . " / > 
 + android : textSize = " 17 . 3sp " 
 + android : fontFamily = " sans - serif - light " 
 + android : textColor = " @ android : color / white " / > 
 
 < RelativeLayout 
 
 @ @ - 71 , 7 + 70 , 6 @ @ 
 android : layout _ centerHorizontal = " true " 
 android : background = " @ drawable / call _ avatar _ background " / > 
 
 - 
 < im . actor . sdk . view . avatar . AvatarView 
 android : id = " @ + id / avatar " 
 android : layout _ width = " 100dp " 
 @ @ - 79 , 8 + 77 , 6 @ @ 
 android : layout _ centerVertical = " true " 
 android : layout _ centerHorizontal = " true " / > 
 
 - 
 - 
 < ListView 
 android : paddingLeft = " 20dp " 
 android : paddingRight = " 20dp " 
 @ @ - 94 , 21 + 90 , 22 @ @ 
 < TextView 
 android : textColor = " @ android : color / white " 
 android : paddingTop = " 5dp " 
 + android : paddingLeft = " 5dp " 
 + android : paddingRight = " 5dp " 
 android : gravity = " center _ horizontal | bottom " 
 - 
 - android : fontFamily = " sans - serif - thin " 
 + android : ellipsize = " marquee " 
 + android : scrollHorizontally = " true " 
 + android : marqueeRepeatLimit = " marquee _ forever " 
 + android : fontFamily = " sans - serif - light " 
 android : id = " @ + id / name " 
 android : layout _ width = " wrap _ content " 
 android : layout _ height = " wrap _ content " 
 + android : singleLine = " true " 
 android : lines = " 1 " 
 - android : textSize = " 32sp " 
 + android : textSize = " 30sp " 
 android : layout _ below = " @ + id / layer4 " 
 android : layout _ centerHorizontal = " true " / > 
 
 - 
 - 
 - 
 - 
 < / RelativeLayout > 
 
 < FrameLayout 
 @ @ - 138 , 14 + 135 , 15 @ @ 
 android : layout _ width = " 60dp " 
 android : layout _ height = " 60dp " 
 android : src = " @ drawable / ic _ call _ end _ white _ 36dp " 
 - android : background = " @ drawable / end _ call _ background " 
 - / > 
 + android : background = " @ drawable / end _ call _ background " / > 
 + 
 < / FrameLayout > 
 
 < FrameLayout 
 android : layout _ width = " 0dp " 
 android : layout _ weight = " 1 " 
 android : layout _ height = " 60dp " > 
 + 
 < ImageButton 
 android : layout _ gravity = " center " 
 android : id = " @ + id / answer " 
 @ @ - 159 , 26 + 157 , 33 @ @ 
 < / LinearLayout > 
 
 < TableLayout 
 - android : layout _ width = " match _ parent " 
 - android : layout _ height = " match _ parent " 
 + android : paddingBottom = " 15dp " 
 + android : paddingLeft = " 10dp " 
 + android : paddingRight = " 10dp " 
 + android : layout _ gravity = " bottom | center _ horizontal " 
 + android : layout _ width = " wrap _ content " 
 + android : layout _ height = " wrap _ content " 
 android : stretchColumns = " * " > 
 + 
 < TableRow 
 + android : minHeight = " 110dp " 
 android : layout _ weight = " 1 " 
 android : gravity = " center " > 
 + 
 < LinearLayout 
 android : id = " @ + id / mute _ btn " 
 android : orientation = " vertical " 
 android : layout _ weight = " 1 " 
 android : layout _ width = " 0dp " 
 android : layout _ height = " wrap _ content " > 
 + 
 < im . actor . sdk . view . TintImageView 
 android : id = " @ + id / mute " 
 android : layout _ gravity = " center _ horizontal " 
 android : layout _ height = " @ dimen / call _ btn _ size " 
 android : scaleType = " centerInside " 
 - android : layout _ width = " @ dimen / call _ btn _ size " 
 - 
 - / > 
 + android : layout _ width = " @ dimen / call _ btn _ size " / > 
 + 
 < TextView 
 android : id = " @ + id / mute _ tv " 
 android : layout _ gravity = " center " 
 @ @ - 195 , 14 + 200 , 14 @ @ 
 android : layout _ weight = " 1 " 
 android : layout _ width = " 0dp " 
 android : layout _ height = " wrap _ content " > 
 + 
 < im . actor . sdk . view . TintImageView 
 android : id = " @ + id / speaker " 
 android : layout _ gravity = " center _ horizontal " 
 android : layout _ height = " @ dimen / call _ btn _ size " 
 android : scaleType = " centerInside " 
 - android : layout _ width = " @ dimen / call _ btn _ size " 
 - 
 - / > 
 + android : layout _ width = " @ dimen / call _ btn _ size " / > 
 + 
 < TextView 
 android : id = " @ + id / speaker _ tv " 
 android : layout _ gravity = " center " 
 @ @ - 219 , 14 + 224 , 14 @ @ 
 android : layout _ weight = " 1 " 
 android : layout _ width = " 0dp " 
 android : layout _ height = " wrap _ content " > 
 + 
 < im . actor . sdk . view . TintImageView 
 android : id = " @ + id / video " 
 android : layout _ gravity = " center _ horizontal " 
 android : layout _ height = " @ dimen / call _ btn _ size " 
 android : scaleType = " centerInside " 
 - android : layout _ width = " @ dimen / call _ btn _ size " 
 - 
 - / > 
 + android : layout _ width = " @ dimen / call _ btn _ size " / > 
 + 
 < TextView 
 android : id = " @ + id / video _ tv " 
 android : layout _ gravity = " center " 
 @ @ - 234 , 12 + 239 , 14 @ @ 
 android : text = " video " 
 android : gravity = " center " 
 android : layout _ width = " wrap _ content " 
 - android : layout _ height = " wrap _ content " / > 
 + android : layout _ height = " wrap _ content " / > 
 + 
 < / LinearLayout > 
 
 < / TableRow > 
 
 < TableRow 
 + android : minHeight = " 110dp " 
 android : layout _ weight = " 1 " 
 android : gravity = " center " > 
 
 @ @ - 249 , 14 + 256 , 14 @ @ 
 android : layout _ weight = " 1 " 
 android : layout _ width = " 0dp " 
 android : layout _ height = " wrap _ content " > 
 + 
 < im . actor . sdk . view . TintImageView 
 android : id = " @ + id / back " 
 android : layout _ gravity = " center _ horizontal " 
 android : layout _ height = " @ dimen / call _ btn _ size " 
 android : scaleType = " centerInside " 
 - android : layout _ width = " @ dimen / call _ btn _ size " 
 - 
 - / > 
 + android : layout _ width = " @ dimen / call _ btn _ size " / > 
 + 
 < TextView 
 android : id = " @ + id / back _ tv " 
 android : layout _ gravity = " center " 
 @ @ - 265 , 12 + 272 , 14 @ @ 
 android : gravity = " center " 
 android : layout _ width = " wrap _ content " 
 android : layout _ height = " wrap _ content " / > 
 + 
 < / LinearLayout > 
 
 < FrameLayout 
 android : layout _ weight = " 1 " 
 android : layout _ width = " 0dp " 
 android : layout _ height = " wrap _ content " > 
 + 
 < ImageButton 
 android : layout _ gravity = " center " 
 android : visibility = " visible " 
 @ @ - 287 , 14 + 296 , 14 @ @ 
 android : layout _ weight = " 1 " 
 android : layout _ width = " 0dp " 
 android : layout _ height = " wrap _ content " > 
 + 
 < im . actor . sdk . view . TintImageView 
 android : id = " @ + id / add " 
 android : layout _ gravity = " center _ horizontal " 
 android : layout _ height = " @ dimen / call _ btn _ size " 
 android : scaleType = " centerInside " 
 - android : layout _ width = " @ dimen / call _ btn _ size " 
 - 
 - / > 
 + android : layout _ width = " @ dimen / call _ btn _ size " / > 
 + 
 < TextView 
 android : id = " @ + id / add _ user _ tv " 
 android : layout _ gravity = " center " 
 @ @ - 305 , 17 + 314 , 12 @ @ 
 android : layout _ height = " wrap _ content " / > 
 < / LinearLayout > 
 
 - 
 < / TableRow > 
 - < / TableLayout > 
 - 
 - 
 - 
 
 + < / TableLayout > 
 
 < / FrameLayout > 
 
 < / LinearLayout > 
 
 - 
 < / FrameLayout > 
 diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / webrtc / WebrtcCallActor . scala b / actor - server / actor - core / src / main / scala / im / actor / server / webrtc / WebrtcCallActor . scala 
 index 66edf9c . . 062069f 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / webrtc / WebrtcCallActor . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / webrtc / WebrtcCallActor . scala 
 @ @ - 58 , 7 + 58 , 79 @ @ object WebrtcCallActor { 
 def props = Props ( classOf [ WebrtcCallActor ] ) 
 } 
 
 - private final class WebrtcCallActor extends StashingActor with ActorLogging { 
 + private trait Members { 
 + this : ActorLogging ⇒ 
 + 
 + private var members = Map . empty [ UserId , Member ] 
 + 
 + sealed trait MemberState 
 + 
 + object MemberStates { 
 + object Ringing extends MemberState 
 + object RingingReached extends MemberState 
 + object Connecting extends MemberState 
 + object Connected extends MemberState 
 + object Ended extends MemberState 
 + } 
 + 
 + case class Member ( userId : UserId , state : MemberState , isJoined : Boolean ) { 
 + import MemberStates . _ 
 + 
 + lazy val apiState = state match { 
 + case Ringing ⇒ ApiCallMemberState . RINGING 
 + case RingingReached ⇒ ApiCallMemberState . RINGING _ REACHED 
 + case Connecting ⇒ ApiCallMemberState . CONNECTING 
 + case Connected ⇒ ApiCallMemberState . CONNECTED 
 + case Ended ⇒ ApiCallMemberState . ENDED 
 + } 
 + } 
 + 
 + def addMember ( userId : UserId , initState : MemberState , isJoined : Boolean = false ) : Unit = { 
 + members get userId match { 
 + case Some ( _ ) ⇒ throw new RuntimeException ( " Attempt to add already existing member " ) 
 + case None ⇒ 
 + val member = Member ( userId , initState , isJoined ) 
 + log . debug ( " Adding member : { } " , member ) 
 + members + = ( userId → member ) 
 + } 
 + } 
 + 
 + def setMemberJoined ( userId : UserId , isJoined : Boolean = true ) : Unit = 
 + members get userId match { 
 + case Some ( member ) if ! member . isJoined ⇒ members + = userId → member . copy ( isJoined = true ) 
 + case Some ( _ ) ⇒ throw new RuntimeException ( " Attempt to set member joined who is already joined " ) 
 + case None ⇒ throw new RuntimeException ( " Attempt to set an unexistent member joined " ) 
 + } 
 + 
 + def setMemberState ( userId : UserId , state : MemberState ) : Unit = 
 + members get userId match { 
 + case Some ( member ) ⇒ 
 + log . debug ( " Changing member [ userId : { } ] state from : { } to : { } " , userId , member . state , state ) 
 + members + = userId → member . copy ( state = state ) 
 + case None ⇒ throw new RuntimeException ( " Attempt to change an unexistend member state " ) 
 + } 
 + 
 + def getMember ( userId : UserId ) = members get userId 
 + 
 + def memberUserIds = members . keySet 
 + 
 + def getMembers = members 
 + 
 + def everyoneRejected ( callerUserId : Int ) = 
 + members . values 
 + . filterNot ( _ . userId = = callerUserId ) 
 + . filterNot ( _ . state = = MemberStates . Ended ) 
 + . isEmpty 
 + 
 + def everyoneLeft ( callerUserId : Int ) = { 
 + val ringing = members . values . filter ( _ . state = = MemberStates . Ringing ) 
 + val joined = members . values . filter ( _ . isJoined ) 
 + 
 + joined . isEmpty & & ringing . isEmpty 
 + } 
 + } 
 + 
 + private final class WebrtcCallActor extends StashingActor with ActorLogging with Members { 
 import WebrtcCallMessages . _ 
 import context . dispatcher 
 
 @ @ - 100 , 7 + 172 , 6 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { 
 private var scheduledUpds = Map . empty [ UserId , Cancellable ] 
 private var devices = Map . empty [ EventBus . DeviceId , Device ] 
 private var clients = Map . empty [ EventBus . Client , EventBus . DeviceId ] 
 - private var participants = Map . empty [ UserId , ApiCallMemberState . Value ] 
 private var sessions = Map . empty [ Pair , SessionId ] 
 private var isConversationStarted : Boolean = false 
 private var peer = Peer ( ) 
 @ @ - 129 , 8 + 200 , 8 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { 
 
 advertiseMaster ( eventBusId , callerDeviceId ) 
 
 - callees foreach ( putParticipant ( _ , ApiCallMemberState . RINGING ) ) 
 - putParticipant ( callerUserId , ApiCallMemberState . CONNECTED ) 
 + callees foreach ( userId ⇒ addMember ( userId , MemberStates . Ringing ) ) 
 + addMember ( callerUserId , MemberStates . Connected , isJoined = true ) 
 broadcastSyncedSet ( ) 
 
 context become callInProgress ( peer , eventBusId , callerDeviceId , System . currentTimeMillis ( ) , callerUserId ) 
 @ @ - 158 , 7 + 229 , 7 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { 
 else ApiServiceMessage ( " Missed call " , Some ( ApiServiceExPhoneMissed ) ) 
 
 ( for { 
 - _ ← if ( peer . ` type ` . isPrivate ) FutureExt . ftraverse ( participants . keySet . toSeq ) ( userId ⇒ dialogExt . sendMessage ( 
 + _ ← if ( peer . ` type ` . isPrivate ) FutureExt . ftraverse ( memberUserIds . toSeq ) ( userId ⇒ dialogExt . sendMessage ( 
 peer = ApiPeer ( ApiPeerType . Private , callerUserId ) , 
 senderUserId = callerUserId , 
 senderAuthId = None , 
 @ @ - 203 , 6 + 274 , 7 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { 
 } yield device ) match { 
 case Some ( device ) ⇒ 
 putDevice ( device . deviceId , client , device . copy ( isJoined = true ) ) 
 + setMemberJoined ( userId ) 
 cancelIncomingCallUpdates ( userId ) 
 
 weakUpdExt . broadcastUserWeakUpdate ( userId , UpdateCallHandled ( id ) , excludeAuthIds = Set ( authId ) ) 
 @ @ - 232 , 7 + 304 , 7 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { 
 this . isConversationStarted = true 
 
 if ( ! isConnected ( userId ) ) { 
 - putParticipant ( userId , ApiCallMemberState . CONNECTING ) 
 + setMemberState ( userId , MemberStates . Connecting ) 
 broadcastSyncedSet ( ) 
 } 
 
 @ @ - 242 , 6 + 314 , 12 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { 
 } 
 case RejectCall ( userId , authId ) ⇒ 
 cancelIncomingCallUpdates ( userId ) 
 + setMemberState ( userId , MemberStates . Ended ) 
 + val client = EventBus . ExternalClient ( userId , authId ) 
 + for ( deviceId ← clients get client ) { 
 + clients - = client 
 + devices - = deviceId 
 + } 
 weakUpdExt . broadcastUserWeakUpdate ( userId , UpdateCallHandled ( id ) , excludeAuthIds = Set ( authId ) ) 
 broadcastSyncedSet ( ) 
 sender ( ) ! RejectCallAck 
 @ @ - 249 , 11 + 327 , 9 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { 
 if ( / / If caller changed his mind until anyone picked up 
 ( ! this . isConversationStarted & & userId = = callerUserId ) | | 
 / / If everyone rejected dialing , there will no any conversation ; ( 
 - ( ! this . isConversationStarted & & 
 - devices . size = = 1 & & 
 - devices . headOption . exists ( _ . _ 2 . deviceId = = callerDeviceId ) ) ) end ( ) 
 + ( ! this . isConversationStarted & & everyoneRejected ( callerUserId ) ) ) end ( ) 
 case GetInfo ⇒ 
 - sender ( ) ! GetInfoAck ( eventBusId , peer , participants . keySet . toSeq ) 
 + sender ( ) ! GetInfoAck ( eventBusId , peer , memberUserIds . toSeq ) 
 case EventBus . Joined ( _ , client , deviceId ) ⇒ 
 if ( client . isExternal ) 
 advertiseMaster ( eventBusId , deviceId ) 
 @ @ - 271 , 12 + 347 , 15 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { 
 
 for { 
 userId ← ebMessage . client . externalUserId 
 - state ← participants . get ( userId ) 
 - } yield if ( state = = ApiCallMemberState . RINGING ) putParticipant ( userId , ApiCallMemberState . RINGING _ REACHED ) 
 + member ← getMember ( userId ) 
 + } yield { 
 + if ( member . state = = MemberStates . Ringing ) 
 + setMemberState ( userId , MemberStates . RingingReached ) 
 + } 
 } 
 case msg : ApiNegotinationSuccessful ⇒ 
 ebMessage . client . externalUserId foreach { userId ⇒ 
 - putParticipant ( userId , ApiCallMemberState . CONNECTED ) 
 + setMemberState ( userId , MemberStates . Connected ) 
 broadcastSyncedSet ( ) 
 } 
 case msg : ApiOnRenegotiationNeeded ⇒ 
 @ @ - 300 , 12 + 379 , 16 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { 
 case EventBus . Disconnected ( _ , client , deviceId ) ⇒ 
 removeDevice ( deviceId ) 
 client . externalUserId foreach { userId ⇒ 
 - putParticipant ( userId , ApiCallMemberState . ENDED ) 
 - broadcastSyncedSet ( ) 
 + if ( ! devices . values . exists ( _ . client . externalUserId . contains ( userId ) ) ) { 
 + setMemberState ( userId , MemberStates . Ended ) 
 + broadcastSyncedSet ( ) 
 + } 
 } 
 
 - if ( ( ! isConversationStarted & & client . externalUserId . contains ( callerUserId ) ) | | 
 - ( isConversationStarted & & ! devices . exists ( _ . _ 2 . isJoined ) ) ) end ( ) 
 + if ( / / no one have been reached and caller left 
 + ( ! isConversationStarted & & client . externalUserId . contains ( callerUserId ) ) | | 
 + / / there is no one left who can have a conversation 
 + ( isConversationStarted & & everyoneLeft ( callerUserId ) ) ) end ( ) 
 case EventBus . Disposed ( _ ) ⇒ 
 end ( ) 
 deleteSyncedSet ( ) 
 @ @ - 326 , 19 + 409 , 6 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { 
 sessions . keySet . exists ( pair ⇒ userDevices . contains ( pair . left ) | | userDevices . contains ( pair . right ) ) 
 } 
 
 - private def putParticipant ( userId : Int , state : ApiCallMemberState . Value ) : Unit = { 
 - participants get userId match { 
 - case Some ( oldState ) ⇒ 
 - if ( oldState ! = state ) { 
 - log . debug ( " Changing participant { } state from { } to { } " , userId , oldState , state ) 
 - participants + = userId → state 
 - } else log . error ( " Attempt to change participant state to the same value { } " , state ) 
 - case None ⇒ 
 - log . debug ( " Adding participant { } with state { } " , userId , state ) 
 - participants + = userId → state 
 - } 
 - } 
 - 
 private def putDevice ( deviceId : EventBus . DeviceId , client : EventBus . Client , device : Device ) : Unit = { 
 devices + = deviceId → device 
 clients + = client → deviceId 
 @ @ - 360 , 31 + 430 , 28 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { 
 
 private def scheduleIncomingCallUpdates ( callees : Seq [ UserId ] ) : Future [ Unit ] = { 
 for { 
 - authIdsMap ← userExt . getAuthIdsMap ( callees . toSet ) 
 - credsMap ← FutureExt . ftraverse ( authIdsMap . toSeq ) { 
 - case ( userId , authIds ) ⇒ 
 - apnsExt . findVoipCreds ( authIds . toSet ) map ( userId → _ ) 
 - } 
 + authIds ← userExt . getAuthIds ( callees . toSet ) 
 + credss ← apnsExt . findVoipCreds ( authIds . toSet ) 
 } yield { 
 + credss foreach { creds ⇒ 
 + val payload = ( new ApnsPayloadBuilder ) . addCustomProperty ( " callId " , id ) . buildWithDefaultMaximumLength ( ) 
 + 
 + val instanceCreds = apnsExt . getVoipInstance ( creds . apnsKey ) map ( _ → creds ) 
 + for ( ( instance , cred ) ← instanceCreds ) { 
 + val notif = new SimpleApnsPushNotification ( cred . token . toByteArray , payload ) 
 + instance . getQueue . add ( notif ) 
 + } 
 + } 
 + 
 scheduledUpds = 
 - credsMap 
 - . map { 
 - case ( userId , creds ) ⇒ 
 - ( 
 - userId , 
 - context . system . scheduler . schedule ( 0 . seconds , 5 . seconds ) { 
 - weakUpdExt . broadcastUserWeakUpdate ( userId , UpdateIncomingCall ( id ) , reduceKey = Some ( s " call _ $ id " ) ) 
 - 
 - val payload = ( new ApnsPayloadBuilder ) . addCustomProperty ( " callId " , id ) . buildWithDefaultMaximumLength ( ) 
 - 
 - val instanceCreds = creds flatMap ( c ⇒ apnsExt . getVoipInstance ( c . apnsKey ) map ( _ → c ) ) 
 - for ( ( instance , cred ) ← instanceCreds ) { 
 - val notif = new SimpleApnsPushNotification ( cred . token . toByteArray , payload ) 
 - instance . getQueue . add ( notif ) 
 - } 
 - } 
 - ) 
 - } 
 + callees . map { userId ⇒ 
 + ( 
 + userId , 
 + context . system . scheduler . schedule ( 0 . seconds , 5 . seconds ) { 
 + weakUpdExt . broadcastUserWeakUpdate ( userId , UpdateIncomingCall ( id ) , reduceKey = Some ( s " call _ $ id " ) ) 
 + } 
 + ) 
 + } 
 . toMap 
 } 
 } 
 @ @ - 397 , 8 + 464 , 9 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { 
 
 private def broadcastSyncedSet ( ) : Unit = { 
 val activeCall = 
 - ApiActiveCall ( id , peer . asStruct , participants . toVector map { 
 - case ( userId , state ) ⇒ 
 + ApiActiveCall ( id , peer . asStruct , getMembers . toVector map { 
 + case ( userId , member ) ⇒ 
 + val state = member . apiState 
 
 ApiCallMember ( userId , ApiCallMemberStateHolder ( 
 state = state , 
 @ @ - 409 , 11 + 477 , 11 @ @ private final class WebrtcCallActor extends StashingActor with ActorLogging { 
 fallbackIsEnded = Some ( state = = ApiCallMemberState . ENDED ) 
 ) ) 
 } ) . toByteArray 
 - participants . keySet foreach ( valuesExt . syncedSet . put ( _ , Webrtc . SyncedSetName , id , activeCall ) ) 
 + memberUserIds foreach ( valuesExt . syncedSet . put ( _ , Webrtc . SyncedSetName , id , activeCall ) ) 
 } 
 
 private def deleteSyncedSet ( ) : Unit = 
 - participants . keySet foreach { userId ⇒ 
 + memberUserIds foreach { userId ⇒ 
 valuesExt . syncedSet . delete ( userId , Webrtc . SyncedSetName , id ) 
 }

NEAREST DIFF:
diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / AndroidManifest . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / AndroidManifest . xml 
 index 45a21b1 . . 9b27d04 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / AndroidManifest . xml 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / AndroidManifest . xml 
 @ @ - 21 , 6 + 21 , 7 @ @ 
 < uses - permission android : name = " android . permission . CAMERA " / > 
 < uses - permission android : name = " android . permission . MODIFY _ AUDIO _ SETTINGS " / > 
 < uses - permission android : name = " android . permission . LOCATION _ HARDWARE " / > 
 + < uses - permission android : name = " android . permission . MODIFY _ AUDIO _ SETTINGS " / > 
 < uses - permission android : name = " com . android . launcher . permission . INSTALL _ SHORTCUT " / > 
 
 < uses - feature 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / AudioActorEx . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / AudioActorEx . java 
 index ab63452 . . d2e9acc 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / AudioActorEx . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / AudioActorEx . java 
 @ @ - 30 , 17 + 30 , 17 @ @ public class AudioActorEx extends AndroidPlayerActor { 
 state = STATE _ NONE ; 
 
 try { 
 - 
 - mplayer = new MediaPlayer ( ) ; 
 + if ( mplayer = = null ) { 
 + mplayer = new MediaPlayer ( ) ; 
 + } 
 mplayer . setAudioStreamType ( AudioManager . STREAM _ VOICE _ CALL ) ; 
 mplayer . setDataSource ( context , Uri . parse ( " android . resource : / / " + context . getPackageName ( ) + " / " + R . raw . tone ) ) ; 
 mplayer . prepare ( ) ; 
 - mplayer . setLooping ( true ) ; 
 mplayer . start ( ) ; 
 mplayer . setOnCompletionListener ( new MediaPlayer . OnCompletionListener ( ) { 
 @ Override 
 public void onCompletion ( MediaPlayer mp ) { 
 - self ( ) . send ( new Stop ( ) ) ; 
 + self ( ) . send ( new Play ( " " ) ) ; 
 } 
 } ) ; 
 mplayer . setOnErrorListener ( new MediaPlayer . OnErrorListener ( ) { 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallActivity . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallActivity . java 
 index aa7899c . . 9bcba50 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallActivity . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallActivity . java 
 @ @ - 1 , 14 + 1 , 22 @ @ 
 package im . actor . sdk . controllers . calls ; 
 
 import android . os . Bundle ; 
 + import android . view . Menu ; 
 import android . view . WindowManager ; 
 
 + import im . actor . core . entity . PeerType ; 
 + import im . actor . sdk . R ; 
 import im . actor . sdk . controllers . activity . BaseFragmentActivity ; 
 
 + import static im . actor . sdk . util . ActorSDKMessenger . messenger ; 
 + 
 / * * 
 * Created by ex3ndr on 30 . 09 . 14 . 
 * / 
 public class CallActivity extends BaseFragmentActivity { 
 + 
 + private long callId ; 
 + 
 @ Override 
 protected void onCreate ( Bundle savedInstanceState ) { 
 super . onCreate ( savedInstanceState ) ; 
 @ @ - 23 , 8 + 31 , 18 @ @ public class CallActivity extends BaseFragmentActivity { 
 WindowManager . LayoutParams . FLAG _ SHOW _ WHEN _ LOCKED | 
 WindowManager . LayoutParams . FLAG _ TURN _ SCREEN _ ON ) ; 
 } 
 - showFragment ( new CallFragment ( getIntent ( ) . getLongExtra ( " callId " , - 1 ) , incoming ) , false , false ) ; 
 + callId = getIntent ( ) . getLongExtra ( " callId " , - 1 ) ; 
 + showFragment ( new CallFragment ( callId , incoming ) , false , false ) ; 
 } 
 } 
 
 + @ Override 
 + public boolean onCreateOptionsMenu ( Menu menu ) { 
 + / / Inflating menu 
 + getMenuInflater ( ) . inflate ( R . menu . call _ menu , menu ) ; 
 + if ( messenger ( ) . getCall ( callId ) . getPeer ( ) . getPeerType ( ) ! = PeerType . GROUP ) { 
 + menu . findItem ( R . id . members ) . setVisible ( false ) ; 
 + } 
 + return super . onCreateOptionsMenu ( menu ) ; 
 + } 
 } 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java 
 index 5bb61e2 . . 48a9000 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / calls / CallFragment . java 
 @ @ - 8 , 6 + 8 , 8 @ @ import android . app . PendingIntent ; 
 import android . content . Context ; 
 import android . content . Intent ; 
 import android . content . pm . PackageManager ; 
 + import android . graphics . Color ; 
 + import android . media . AudioManager ; 
 import android . media . Ringtone ; 
 import android . media . RingtoneManager ; 
 import android . net . Uri ; 
 @ @ - 17 , 11 + 19 , 12 @ @ import android . os . Vibrator ; 
 import android . support . v4 . app . NotificationCompat ; 
 import android . support . v4 . content . ContextCompat ; 
 import android . view . LayoutInflater ; 
 + import android . view . MenuItem ; 
 import android . view . View ; 
 import android . view . ViewGroup ; 
 + import android . widget . AdapterView ; 
 import android . widget . FrameLayout ; 
 import android . widget . ImageButton ; 
 - import android . widget . ImageView ; 
 import android . widget . ListView ; 
 import android . widget . TextView ; 
 
 @ @ - 52 , 11 + 55 , 10 @ @ import im . actor . sdk . ActorSDK ; 
 import im . actor . sdk . R ; 
 import im . actor . sdk . controllers . fragment . BaseFragment ; 
 import im . actor . sdk . util . Screen ; 
 - import im . actor . sdk . view . SearchHighlight ; 
 + import im . actor . sdk . view . TintImageView ; 
 import im . actor . sdk . view . adapters . HolderAdapter ; 
 import im . actor . sdk . view . adapters . ViewHolder ; 
 import im . actor . sdk . view . avatar . AvatarView ; 
 - import im . actor . sdk . view . avatar . CoverAvatarView ; 
 
 import static im . actor . sdk . util . ActorSDKMessenger . groups ; 
 import static im . actor . sdk . util . ActorSDKMessenger . messenger ; 
 @ @ - 75 , 8 + 77 , 14 @ @ public class CallFragment extends BaseFragment { 
 private Ringtone ringtone ; 
 private CallVM call ; 
 private ActorRef timer ; 
 - private TextView timerTV ; 
 + private TextView statusTV ; 
 private NotificationManager manager ; 
 + private CallState currentState ; 
 + private ImageButton endCall ; 
 + private boolean speakerOn = false ; 
 + private AudioManager audioManager ; 
 + private AvatarView avatarView ; 
 + private ListView membersList ; 
 
 public CallFragment ( ) { 
 
 @ @ - 111 , 7 + 119 , 7 @ @ public class CallFragment extends BaseFragment { 
 } 
 } ) ; 
 ImageButton notAnswer = ( ImageButton ) cont . findViewById ( R . id . notAnswer ) ; 
 - ImageButton endCall = ( ImageButton ) cont . findViewById ( R . id . end _ call ) ; 
 + endCall = ( ImageButton ) cont . findViewById ( R . id . end _ call ) ; 
 notAnswer . setOnClickListener ( new View . OnClickListener ( ) { 
 @ Override 
 public void onClick ( View v ) { 
 @ @ - 126 , 61 + 134 , 145 @ @ public class CallFragment extends BaseFragment { 
 } ) ; 
 
 / / 
 - / / Avatar / Name 
 + / / Avatar / Name bind 
 / / 
 - CoverAvatarView avatarView = ( CoverAvatarView ) cont . findViewById ( R . id . avatar ) ; 
 - avatarView . setBkgrnd ( ( ImageView ) cont . findViewById ( R . id . avatar _ bgrnd ) ) ; 
 - TextView nameTV = ( TextView ) cont . findViewById ( R . id . name ) ; 
 - nameTV . setTextColor ( ActorSDK . sharedActor ( ) . style . getProfileTitleColor ( ) ) ; 
 + avatarView = ( AvatarView ) cont . findViewById ( R . id . avatar ) ; 
 + avatarView . init ( Screen . dp ( 130 ) , 50 ) ; 
 
 + TextView nameTV = ( TextView ) cont . findViewById ( R . id . name ) ; 
 + nameTV . setTextColor ( ActorSDK . sharedActor ( ) . style . getTextPrimaryColor ( ) ) ; 
 if ( peer . getPeerType ( ) = = PeerType . PRIVATE ) { 
 - 
 UserVM user = users ( ) . get ( peer . getPeerId ( ) ) ; 
 - bind ( avatarView , user . getAvatar ( ) ) ; 
 + avatarView . bind ( user ) ; 
 bind ( nameTV , user . getName ( ) ) ; 
 } else if ( peer . getPeerType ( ) = = PeerType . GROUP ) { 
 GroupVM g = groups ( ) . get ( peer . getPeerId ( ) ) ; 
 - bind ( avatarView , g . getAvatar ( ) ) ; 
 + avatarView . bind ( g ) ; 
 bind ( nameTV , g . getName ( ) ) ; 
 } 
 
 - ListView membersList = ( ListView ) cont . findViewById ( R . id . members _ list ) ; 
 + / / 
 + / / Members list 
 + / / 
 + membersList = ( ListView ) cont . findViewById ( R . id . members _ list ) ; 
 CallMembersAdapter membersAdapter = new CallMembersAdapter ( getActivity ( ) , call . getMembers ( ) ) ; 
 membersList . setAdapter ( membersAdapter ) ; 
 
 - timerTV = ( TextView ) cont . findViewById ( R . id . timer ) ; 
 - timerTV . setTextColor ( ActorSDK . sharedActor ( ) . style . getProfileSubtitleColor ( ) ) ; 
 + / / 
 + / / Members list / avatar switch 
 + / / 
 + View . OnClickListener listener = new View . OnClickListener ( ) { 
 + @ Override 
 + public void onClick ( View v ) { 
 + switchAvatarMembers ( ) ; 
 + } 
 + } ; 
 + avatarView . setOnClickListener ( listener ) ; 
 + cont . findViewById ( R . id . background ) . setOnClickListener ( listener ) ; 
 + 
 + membersList . setOnItemClickListener ( new AdapterView . OnItemClickListener ( ) { 
 + @ Override 
 + public void onItemClick ( AdapterView < ? > parent , View view , int position , long id ) { 
 + switchAvatarMembers ( ) ; 
 + } 
 + 
 + } ) ; 
 + 
 + 
 + 
 + statusTV = ( TextView ) cont . findViewById ( R . id . status ) ; 
 + statusTV . setTextColor ( ActorSDK . sharedActor ( ) . style . getTextSecondaryColor ( ) ) ; 
 
 / / 
 / / Check permission 
 / / 
 if ( ContextCompat . checkSelfPermission ( getActivity ( ) , Manifest . permission . RECORD _ AUDIO ) ! = PackageManager . PERMISSION _ GRANTED | | 
 ContextCompat . checkSelfPermission ( getActivity ( ) , Manifest . permission . VIBRATE ) ! = PackageManager . PERMISSION _ GRANTED | | 
 + ContextCompat . checkSelfPermission ( getActivity ( ) , Manifest . permission . MODIFY _ AUDIO _ SETTINGS ) ! = PackageManager . PERMISSION _ GRANTED | | 
 ContextCompat . checkSelfPermission ( getActivity ( ) , Manifest . permission . WAKE _ LOCK ) ! = PackageManager . PERMISSION _ GRANTED ) { 
 Log . d ( " Permissions " , " call - no permission : c " ) ; 
 - CallFragment . this . requestPermissions ( new String [ ] { Manifest . permission . RECORD _ AUDIO , Manifest . permission . VIBRATE , Manifest . permission . WAKE _ LOCK } , 
 + CallFragment . this . requestPermissions ( new String [ ] { Manifest . permission . RECORD _ AUDIO , Manifest . permission . VIBRATE , Manifest . permission . MODIFY _ AUDIO _ SETTINGS , Manifest . permission . WAKE _ LOCK } , 
 PERMISSIONS _ REQUEST _ FOR _ CALL ) ; 
 
 } 
 
 + audioManager = ( AudioManager ) getActivity ( ) . getSystemService ( Context . AUDIO _ SERVICE ) ; 
 + final TintImageView speaker = ( TintImageView ) cont . findViewById ( R . id . speaker ) ; 
 + speaker . setResource ( R . drawable . ic _ volume _ up _ white _ 36dp ) ; 
 + speaker . setTint ( getResources ( ) . getColor ( R . color . primary ) ) ; 
 + speaker . setOnClickListener ( new View . OnClickListener ( ) { 
 + @ Override 
 + public void onClick ( View v ) { 
 + speakerOn = ! speakerOn ; 
 + audioManager . setSpeakerphoneOn ( speakerOn ) ; 
 + if ( speakerOn ) { 
 + speaker . setBackgroundResource ( R . drawable . call _ action _ background _ active ) ; 
 + speaker . setTint ( Color . WHITE ) ; 
 + } else { 
 + speaker . setBackgroundResource ( R . drawable . call _ action _ background ) ; 
 + speaker . setTint ( getResources ( ) . getColor ( R . color . primary ) ) ; 
 + } 
 + } 
 + } ) ; 
 + 
 + final TintImageView muteCall = ( TintImageView ) cont . findViewById ( R . id . mute ) ; 
 + muteCall . setResource ( R . drawable . ic _ mic _ off _ white _ 36dp ) ; 
 + muteCall . setOnClickListener ( new View . OnClickListener ( ) { 
 + @ Override 
 + public void onClick ( View v ) { 
 + messenger ( ) . toggleCallMute ( callId ) ; 
 + } 
 + } ) ; 
 + 
 + 
 + 
 + call . getIsMuted ( ) . subscribe ( new ValueChangedListener < Boolean > ( ) { 
 + @ Override 
 + public void onChanged ( Boolean val , Value < Boolean > valueModel ) { 
 + if ( val ) { 
 + muteCall . setBackgroundResource ( R . drawable . call _ action _ background _ active ) ; 
 + muteCall . setTint ( Color . WHITE ) ; 
 + } else { 
 + muteCall . setBackgroundResource ( R . drawable . call _ action _ background ) ; 
 + muteCall . setTint ( getResources ( ) . getColor ( R . color . primary ) ) ; 
 + } 
 + } 
 + } ) ; 
 + 
 call . getState ( ) . subscribe ( new ValueChangedListener < CallState > ( ) { 
 @ Override 
 public void onChanged ( CallState val , Value < CallState > valueModel ) { 
 - switch ( val ) { 
 - case ENDED : 
 + if ( currentState ! = val ) { 
 + currentState = val ; 
 + switch ( val ) { 
 + 
 + case CALLING : 
 + if ( call . isOutgoing ( ) ) { 
 + statusTV . setText ( R . string . call _ outgoing ) ; 
 + } else { 
 + statusTV . setText ( R . string . call _ incoming ) ; 
 + initIncoming ( ) ; 
 + } 
 + enableWakeLock ( ) ; 
 + break ; 
 + 
 + case CONNECTING : 
 + statusTV . setText ( R . string . call _ connecting ) ; 
 + break ; 
 + 
 + case IN _ PROGRESS : 
 + onConnected ( ) ; 
 + startTimer ( ) ; 
 + break ; 
 + 
 + case ENDED : 
 + statusTV . setText ( R . string . call _ ended ) ; 
 onCallEnd ( ) ; 
 break ; 
 - case IN _ PROGRESS : 
 - onConnected ( ) ; 
 - startTimer ( ) ; 
 - break ; 
 - case CALLING _ INCOMING : 
 - initIncoming ( ) ; 
 - break ; 
 - case CALLING _ OUTGOING : 
 - onConnecting ( ) ; 
 - break ; 
 + 
 + } 
 } 
 + 
 } 
 } , true ) ; 
 
 @ @ - 188 , 6 + 280 , 18 @ @ public class CallFragment extends BaseFragment { 
 return cont ; 
 } 
 
 + public void switchAvatarMembers ( ) { 
 + if ( peer . getPeerType ( ) = = PeerType . GROUP ) { 
 + if ( avatarView . getVisibility ( ) = = View . VISIBLE ) { 
 + hideView ( avatarView ) ; 
 + showView ( membersList ) ; 
 + } else { 
 + hideView ( membersList ) ; 
 + showView ( avatarView ) ; 
 + } 
 + } 
 + } 
 + 
 private void startTimer ( ) { 
 
 final DateFormat formatter = new SimpleDateFormat ( " HH : mm : ss " ) ; 
 @ @ - 207 , 7 + 311 , 9 @ @ public class CallFragment extends BaseFragment { 
 getActivity ( ) . runOnUiThread ( new Runnable ( ) { 
 @ Override 
 public void run ( ) { 
 - timerTV . setText ( formatter . format ( new Date ( timeFromRegister ) ) ) ; 
 + if ( currentState = = CallState . IN _ PROGRESS ) { 
 + statusTV . setText ( formatter . format ( new Date ( timeFromRegister ) ) ) ; 
 + } 
 } 
 } ) ; 
 } 
 @ @ - 231 , 6 + 337 , 7 @ @ public class CallFragment extends BaseFragment { 
 
 private void initIncoming ( ) { 
 answerContainer . setVisibility ( View . VISIBLE ) ; 
 + endCall . setVisibility ( View . INVISIBLE ) ; 
 
 new Thread ( new Runnable ( ) { 
 @ Override 
 @ @ - 239 , 7 + 346 , 7 @ @ public class CallFragment extends BaseFragment { 
 Thread . sleep ( 1100 ) ; 
 Uri notification = RingtoneManager . getDefaultUri ( RingtoneManager . TYPE _ RINGTONE ) ; 
 ringtone = RingtoneManager . getRingtone ( getActivity ( ) , notification ) ; 
 - if ( getActivity ( ) ! = null & answerContainer . getVisibility ( ) = = View . VISIBLE ) { 
 + if ( getActivity ( ) ! = null & answerContainer . getVisibility ( ) = = View . VISIBLE & & currentState = = CallState . CALLING ) { 
 if ( ringtone ! = null ) { 
 ringtone . play ( ) ; 
 } 
 @ @ - 255 , 7 + 362 , 7 @ @ public class CallFragment extends BaseFragment { 
 
 private void onAnswer ( ) { 
 
 - onConnecting ( ) ; 
 + endCall . setVisibility ( View . VISIBLE ) ; 
 answerContainer . setVisibility ( View . INVISIBLE ) ; 
 if ( ringtone ! = null ) { 
 ringtone . stop ( ) ; 
 @ @ - 278 , 7 + 385 , 7 @ @ public class CallFragment extends BaseFragment { 
 private int field = 0x00000020 ; 
 
 
 - public void onConnecting ( ) { 
 + public void enableWakeLock ( ) { 
 powerManager = ( PowerManager ) getActivity ( ) . getSystemService ( Context . POWER _ SERVICE ) ; 
 wakeLock = powerManager . newWakeLock ( field , getActivity ( ) . getLocalClassName ( ) ) ; 
 
 @ @ - 296 , 6 + 403 , 7 @ @ public class CallFragment extends BaseFragment { 
 } 
 
 public void onCallEnd ( ) { 
 + audioManager . setSpeakerphoneOn ( false ) ; 
 vibrate = false ; 
 if ( ringtone ! = null ) { 
 ringtone . stop ( ) ; 
 @ @ - 321 , 6 + 429 , 15 @ @ public class CallFragment extends BaseFragment { 
 } 
 
 @ Override 
 + public boolean onOptionsItemSelected ( MenuItem item ) { 
 + if ( item . getItemId ( ) = = R . id . members ) { 
 + switchAvatarMembers ( ) ; 
 + } 
 + return super . onOptionsItemSelected ( item ) ; 
 + } 
 + 
 + 
 + @ Override 
 public void onPause ( ) { 
 super . onPause ( ) ; 
 if ( call . getState ( ) . get ( ) ! = CallState . ENDED ) { 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / view / avatar / AvatarView . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / view / avatar / AvatarView . java 
 index f00df38 . . 59d1838 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / view / avatar / AvatarView . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / view / avatar / AvatarView . java 
 @ @ - 17 , 6 + 17 , 7 @ @ import com . facebook . imagepipeline . request . ImageRequestBuilder ; 
 import java . io . File ; 
 
 import im . actor . core . entity . Avatar ; 
 + import im . actor . core . entity . AvatarImage ; 
 import im . actor . core . entity . Contact ; 
 import im . actor . core . entity . Dialog ; 
 import im . actor . core . entity . PublicGroup ; 
 @ @ - 91 , 8 + 92 , 8 @ @ public class AvatarView extends SimpleDraweeView { 
 
 public void bind ( Avatar avatar , String title , int id ) { 
 / / Same avatar 
 - if ( avatar ! = null & & avatar . getSmallImage ( ) ! = null 
 - & & avatar . getSmallImage ( ) . getFileReference ( ) . getFileId ( ) = = currentId ) { 
 + if ( avatar ! = null & & getImage ( avatar ) ! = null 
 + & & getImage ( avatar ) . getFileReference ( ) . getFileId ( ) = = currentId ) { 
 return ; 
 } 
 
 @ @ - 105 , 13 + 106 , 13 @ @ public class AvatarView extends SimpleDraweeView { 
 
 setImageURI ( null ) ; 
 
 - if ( avatar = = null | | avatar . getSmallImage ( ) = = null ) { 
 + if ( avatar = = null | | getImage ( avatar ) = = null ) { 
 currentId = 0 ; 
 return ; 
 } 
 - currentId = avatar . getSmallImage ( ) . getFileReference ( ) . getFileId ( ) ; 
 + currentId = getImage ( avatar ) . getFileReference ( ) . getFileId ( ) ; 
 
 - bindedFile = messenger ( ) . bindFile ( avatar . getSmallImage ( ) . getFileReference ( ) , true , new FileVMCallback ( ) { 
 + bindedFile = messenger ( ) . bindFile ( getImage ( avatar ) . getFileReference ( ) , true , new FileVMCallback ( ) { 
 @ Override 
 public void onNotDownloaded ( ) { 
 
 @ @ - 137 , 6 + 138 , 11 @ @ public class AvatarView extends SimpleDraweeView { 
 } ) ; 
 } 
 
 + public AvatarImage getImage ( Avatar avatar ) { 
 + 
 + return size > = 100 ? avatar . getLargeImage ( ) : avatar . getSmallImage ( ) ; 
 + } 
 + 
 public void bindRaw ( String fileName ) { 
 if ( bindedFile ! = null ) { 
 bindedFile . detach ( ) ; 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / answer _ background . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / answer _ background . xml 
 new file mode 100644 
 index 0000000 . . 729e3ca 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / answer _ background . xml 
 @ @ - 0 , 0 + 1 , 9 @ @ 
 + < ? xml version = " 1 . 0 " encoding = " utf - 8 " ? > 
 + < ! - - 
 + ~ Copyright ( C ) 2015 Actor LLC . < https : / / actor . im > 
 + - - > 
 + 
 + < shape xmlns : android = " http : / / schemas . android . com / apk / res / android " 
 + android : shape = " oval " > 
 + < solid android : color = " @ color / primary _ alt " / > 
 + < / shape > 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / call _ action _ background . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / call _ action _ background . xml 
 new file mode 100644 
 index 0000000 . . 3597075 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / call _ action _ background . xml 
 @ @ - 0 , 0 + 1 , 10 @ @ 
 + < ? xml version = " 1 . 0 " encoding = " utf - 8 " ? > 
 + < ! - - 
 + ~ Copyright ( C ) 2015 Actor LLC . < https : / / actor . im > 
 + - - > 
 + 
 + < shape xmlns : android = " http : / / schemas . android . com / apk / res / android " 
 + android : shape = " oval " > 
 + < solid android : color = " @ android : color / transparent " / > 
 + < stroke android : width = " 2dp " android : color = " @ color / primary " / > 
 + < / shape > 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / call _ action _ background _ active . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / call _ action _ background _ active . xml 
 new file mode 100644 
 index 0000000 . . f1c872d 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / call _ action _ background _ active . xml 
 @ @ - 0 , 0 + 1 , 10 @ @ 
 + < ? xml version = " 1 . 0 " encoding = " utf - 8 " ? > 
 + < ! - - 
 + ~ Copyright ( C ) 2015 Actor LLC . < https : / / actor . im > 
 + - - > 
 + 
 + < shape xmlns : android = " http : / / schemas . android . com / apk / res / android " 
 + android : shape = " oval " > 
 + < solid android : color = " @ color / primary " / > 
 + < stroke android : width = " 2dp " android : color = " @ color / primary " / > 
 + < / shape > 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / end _ call _ background . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / end _ call _ background . xml 
 new file mode 100644 
 index 0000000 . . dd3a7f9 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / drawable / end _ call _ background . xml 
 @ @ - 0 , 0 + 1 , 9 @ @ 
 + < ? xml version = " 1 . 0 " encoding = " utf - 8 " ? > 
 + < ! - - 
 + ~ Copyright ( C ) 2015 Actor LLC . < https : / / actor . im > 
 + - - > 
 + 
 + < shape xmlns : android = " http : / / schemas . android . com / apk / res / android " 
 + android : shape = " oval " > 
 + < solid android : color = " @ color / accent " / > 
 + < / shape > 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml 
 index 6ce5969 . . 1150291 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / layout / fragment _ call . xml 
 @ @ - 4 , 80 + 4 , 165 @ @ 
 android : layout _ width = " match _ parent " 
 android : layout _ height = " match _ parent " > 
 
 - < ImageView 
 - android : id = " @ + id / avatar _ bgrnd " 
 + < im . actor . sdk . controllers . conversation . view . ChatBackgroundView 
 + android : id = " @ + id / background " 
 android : layout _ width = " match _ parent " 
 - android : layout _ height = " match _ parent " 
 - android : src = " @ drawable / img _ profile _ avatar _ default " 
 - android : scaleType = " centerCrop " / > 
 + android : layout _ height = " match _ parent " / > 
 
 - < im . actor . sdk . view . avatar . CoverAvatarView 
 - android : id = " @ + id / avatar " 
 + < LinearLayout 
 android : layout _ width = " match _ parent " 
 - android : layout _ height = " match _ parent " / > 
 + android : layout _ height = " match _ parent " 
 + android : weightSum = " 2 " 
 + android : orientation = " vertical " > 
 
 - < LinearLayout 
 - android : layout _ width = " wrap _ content " 
 - android : layout _ height = " wrap _ content " 
 - android : layout _ gravity = " top | left " 
 - android : orientation = " vertical " 
 - android : layout _ margin = " 40dp " 
 - > 
 - < TextView 
 - android : id = " @ + id / name " 
 - android : layout _ width = " wrap _ content " 
 - android : layout _ height = " wrap _ content " 
 - android : ellipsize = " end " 
 - android : includeFontPadding = " false " 
 - android : lines = " 1 " 
 - android : textSize = " 26sp " / > 
 - 
 - < TextView 
 - android : id = " @ + id / timer " 
 - android : layout _ width = " wrap _ content " 
 - android : layout _ height = " wrap _ content " 
 - android : textSize = " @ dimen / text _ secondary " / > 
 - 
 - < ListView 
 - android : id = " @ + id / members _ list " 
 - android : layout _ width = " wrap _ content " 
 - android : layout _ height = " wrap _ content " / > 
 - < / LinearLayout > 
 + < RelativeLayout 
 + 
 + android : layout _ width = " match _ parent " 
 + android : layout _ height = " 0dp " 
 + android : layout _ gravity = " top | center _ horizontal " 
 + android : orientation = " vertical " 
 + android : layout _ weight = " 1 " > 
 + 
 + < im . actor . sdk . view . avatar . AvatarView 
 + android : id = " @ + id / avatar " 
 + android : layout _ width = " 130dp " 
 + android : layout _ height = " 130dp " 
 + android : layout _ centerVertical = " true " 
 + android : layout _ centerHorizontal = " true " / > 
 + 
 + < ListView 
 + android : paddingLeft = " 20dp " 
 + android : paddingRight = " 20dp " 
 + android : visibility = " invisible " 
 + android : id = " @ + id / members _ list " 
 + android : layout _ centerVertical = " true " 
 + android : layout _ centerHorizontal = " true " 
 + android : layout _ width = " match _ parent " 
 + android : layout _ height = " 130dp " / > 
 + 
 + < TextView 
 + android : gravity = " center " 
 + android : layout _ centerHorizontal = " true " 
 + android : layout _ below = " @ id / avatar " 
 + android : id = " @ + id / name " 
 + android : layout _ width = " wrap _ content " 
 + android : layout _ height = " match _ parent " 
 + android : lines = " 1 " 
 + android : textSize = " 26sp " 
 + android : layout _ alignParentBottom = " true " / > 
 + 
 + 
 + 
 + 
 + 
 + < / RelativeLayout > 
 + 
 + < FrameLayout 
 + android : layout _ width = " match _ parent " 
 + android : layout _ height = " 0dp " 
 + android : layout _ gravity = " top | center _ horizontal " 
 + android : orientation = " vertical " 
 + android : layout _ weight = " 1 " > 
 + 
 + < LinearLayout 
 + android : id = " @ + id / answer _ container " 
 + android : visibility = " invisible " 
 + android : layout _ width = " match _ parent " 
 + android : layout _ height = " 60dp " 
 + android : orientation = " horizontal " 
 + android : layout _ gravity = " bottom " 
 + android : layout _ marginBottom = " 20dp " > 
 + 
 + < FrameLayout 
 + android : layout _ width = " 0dp " 
 + android : layout _ weight = " 1 " 
 + android : layout _ height = " 60dp " > 
 + 
 + < ImageButton 
 + android : layout _ gravity = " center " 
 + android : id = " @ + id / notAnswer " 
 + android : layout _ width = " 60dp " 
 + android : layout _ height = " 60dp " 
 + android : background = " @ drawable / end _ call _ background " 
 + android : src = " @ drawable / ic _ call _ end _ white _ 36dp " / > 
 + < / FrameLayout > 
 + 
 + < FrameLayout 
 + android : layout _ width = " 0dp " 
 + android : layout _ weight = " 1 " 
 + android : layout _ height = " 60dp " > 
 + < ImageButton 
 + android : layout _ gravity = " center " 
 + android : id = " @ + id / answer " 
 + android : layout _ width = " 60dp " 
 + android : layout _ height = " 60dp " 
 + android : background = " @ drawable / answer _ background " 
 + android : src = " @ drawable / ic _ call _ white _ 36dp " / > 
 + 
 + < / FrameLayout > 
 + 
 + < / LinearLayout > 
 + 
 + < ImageButton 
 + android : visibility = " visible " 
 + android : layout _ gravity = " bottom | center _ horizontal " 
 + android : id = " @ + id / end _ call " 
 + android : layout _ width = " 60dp " 
 + android : layout _ height = " 60dp " 
 + android : background = " @ drawable / end _ call _ background " 
 + android : src = " @ drawable / ic _ call _ end _ white _ 36dp " 
 + android : layout _ marginBottom = " 20dp " / > 
 + 
 + < TextView 
 + android : layout _ gravity = " center _ horizontal | top " 
 + android : id = " @ + id / status " 
 + android : layout _ width = " wrap _ content " 
 + android : layout _ height = " wrap _ content " 
 + android : textSize = " 20sp " / > 
 + 
 + < LinearLayout 
 + android : layout _ width = " match _ parent " 
 + android : layout _ height = " wrap _ content " 
 + android : orientation = " horizontal " 
 + android : weightSum = " 2 " 
 + android : layout _ gravity = " center " > 
 + 
 + 
 + < FrameLayout 
 + android : layout _ weight = " 1 " 
 + android : layout _ width = " 0dp " 
 + android : layout _ height = " wrap _ content " > 
 + < im . actor . sdk . view . TintImageView 
 + android : id = " @ + id / speaker " 
 + android : layout _ gravity = " center _ horizontal " 
 + android : layout _ height = " 60dp " 
 + android : scaleType = " centerInside " 
 + android : layout _ width = " 60dp " 
 + android : background = " @ drawable / call _ action _ background " 
 + / > 
 + < / FrameLayout > 
 + 
 + < FrameLayout 
 + android : layout _ weight = " 1 " 
 + android : layout _ width = " 0dp " 
 + android : layout _ height = " wrap _ content " > 
 + < im . actor . sdk . view . TintImageView 
 + android : id = " @ + id / mute " 
 + android : layout _ gravity = " center _ horizontal " 
 + android : layout _ height = " 60dp " 
 + android : scaleType = " centerInside " 
 + android : layout _ width = " 60dp " 
 + android : background = " @ drawable / call _ action _ background " 
 + / > 
 + < / FrameLayout > 
 + 
 + < / LinearLayout > 
 + 
 + < / FrameLayout > 
 
 
 - < ImageButton 
 - android : layout _ gravity = " bottom " 
 - android : id = " @ + id / end _ call " 
 - android : layout _ width = " match _ parent " 
 - android : layout _ height = " 60dp " 
 - android : background = " @ color / accent " 
 - android : src = " @ drawable / ic _ call _ white _ 36dp " / > 
 
 - < LinearLayout 
 - android : id = " @ + id / answer _ container " 
 - android : visibility = " invisible " 
 - android : layout _ width = " match _ parent " 
 - android : layout _ height = " 60dp " 
 - android : orientation = " horizontal " 
 - android : layout _ gravity = " bottom " > 
 - 
 - < ImageButton 
 - android : layout _ gravity = " bottom " 
 - android : id = " @ + id / answer " 
 - android : layout _ width = " 0dp " 
 - android : layout _ weight = " 1 " 
 - android : layout _ height = " 60dp " 
 - android : background = " @ color / primary _ alt " 
 - android : src = " @ drawable / ic _ call _ white _ 36dp " / > 
 - 
 - < ImageButton 
 - android : layout _ gravity = " bottom " 
 - android : id = " @ + id / notAnswer " 
 - android : layout _ width = " 0dp " 
 - android : layout _ weight = " 1 " 
 - android : layout _ height = " 60dp " 
 - android : background = " @ color / accent " 
 - android : src = " @ drawable / ic _ call _ white _ 36dp " / > 
 < / LinearLayout > 
 
 + 
 < / FrameLayout > 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / menu / call _ menu . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / menu / call _ menu . xml 
 new file mode 100644 
 index 0000000 . . c7dfa0e 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / menu / call _ menu . xml 
 @ @ - 0 , 0 + 1 , 17 @ @ 
 + < ? xml version = " 1 . 0 " encoding = " utf - 8 " ? > 
 + 
 + < ! - - 
 + ~ Copyright ( C ) 2015 Actor LLC . < https : / / actor . im > 
 + - - > 
 + 
 + < menu xmlns : android = " http : / / schemas . android . com / apk / res / android " 
 + xmlns : app = " http : / / schemas . android . com / apk / res - auto " > 
 + 
 + < item 
 + android : id = " @ + id / members " 
 + android : icon = " @ drawable / main _ bar _ contacts _ active " 
 + android : title = " " 
 + app : showAsAction = " always " / > 
 + 
 + 
 + < / menu > 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / res / values / ui _ text . xml b / actor - sdk / sdk - core - android / android - sdk / src / main / res / values / ui _ text . xml 
 index 5461c8d . . 0ac8749 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / res / values / ui _ text . xml 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / res / values / ui _ text . xml 
 @ @ - 458 , 6 + 458 , 12 @ @ 
 < string name = " media _ pager " formatted = " false " > % d of % d < / string > 
 < string name = " emoji _ no _ recent " > no recent emoji yet < / string > 
 
 + < ! - - Calls - - > 
 + < string name = " call _ ended " > Call ended < / string > 
 + < string name = " call _ incoming " > Incoming call < / string > 
 + < string name = " call _ outgoing " > Ringing … < / string > 
 + < string name = " call _ connecting " > Connecting … < / string > 
 + 
 < ! - - Dialogs - - > 
 < string name = " alert _ leave _ group _ message " > Are you sure want to exit group " % 1 $ s " ? < / string > 
 < string name = " alert _ leave _ group _ yes " > Exit < / string >
