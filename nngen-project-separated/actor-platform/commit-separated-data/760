BLEU SCORE: 0.08295193507109855

TEST MSG: fix ( iOS ) : Fixing welcome controller for iPhone 4s
GENERATED MSG: wip ( core ) : Implementation of Master Call actor

TEST DIFF (one line): diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Auth / AAAuthNavigationController . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Auth / AAAuthNavigationController . swift < nl > index dbfe321 . . 560d833 100644 < nl > - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Auth / AAAuthNavigationController . swift < nl > + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Auth / AAAuthNavigationController . swift < nl > @ @ - 22 , 6 + 22 , 12 @ @ public class AAAuthNavigationController : UINavigationController { < nl > UIApplication . sharedApplication ( ) . setStatusBarStyle ( . Default , animated : true ) < nl > } < nl > < nl > + public override func viewWillDisappear ( animated : Bool ) { < nl > + super . viewWillDisappear ( animated ) < nl > + < nl > + UIApplication . sharedApplication ( ) . setStatusBarStyle ( . LightContent , animated : true ) < nl > + } < nl > + < nl > public override func preferredStatusBarStyle ( ) - > UIStatusBarStyle { < nl > return . Default < nl > } < nl > diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Auth / AAAuthWelcomeController . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Auth / AAAuthWelcomeController . swift < nl > index eb93051 . . 8090da1 100644 < nl > - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Auth / AAAuthWelcomeController . swift < nl > + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Auth / AAAuthWelcomeController . swift < nl > @ @ - 66 , 12 + 66 , 22 @ @ public class AAWelcomeController : AAViewController { < nl > override public func viewDidLayoutSubviews ( ) { < nl > super . viewDidLayoutSubviews ( ) < nl > < nl > - logoView . frame = CGRectMake ( ( view . width - 90 ) / 2 , 145 , 90 , 90 ) < nl > - appNameLabel . frame = CGRectMake ( ( view . width - 300 ) / 2 , logoView . bottom + 35 , 300 , 29 ) < nl > - someInfoLabel . frame = CGRectMake ( ( view . width - 300 ) / 2 , appNameLabel . bottom + 8 , 300 , 46 ) < nl > + if AADevice . isiPhone4 { < nl > + logoView . frame = CGRectMake ( ( view . width - 90 ) / 2 , 90 , 90 , 90 ) < nl > + appNameLabel . frame = CGRectMake ( ( view . width - 300 ) / 2 , logoView . bottom + 30 , 300 , 29 ) < nl > + someInfoLabel . frame = CGRectMake ( ( view . width - 300 ) / 2 , appNameLabel . bottom + 8 , 300 , 46 ) < nl > + < nl > + signupButton . frame = CGRectMake ( ( view . width - 136 ) / 2 , view . height - 44 - 80 , 136 , 44 ) < nl > + signinButton . frame = CGRectMake ( ( view . width - 136 ) / 2 , view . height - 44 - 25 , 136 , 44 ) < nl > + } else { < nl > + < nl > + logoView . frame = CGRectMake ( ( view . width - 90 ) / 2 , 145 , 90 , 90 ) < nl > + appNameLabel . frame = CGRectMake ( ( view . width - 300 ) / 2 , logoView . bottom + 35 , 300 , 29 ) < nl > + someInfoLabel . frame = CGRectMake ( ( view . width - 300 ) / 2 , appNameLabel . bottom + 8 , 300 , 46 ) < nl > < nl > - signupButton . frame = CGRectMake ( ( view . width - 136 ) / 2 , view . height - 44 - 90 , 136 , 44 ) < nl > - signinButton . frame = CGRectMake ( ( view . width - 136 ) / 2 , view . height - 44 - 35 , 136 , 44 ) < nl > + signupButton . frame = CGRectMake ( ( view . width - 136 ) / 2 , view . height - 44 - 90 , 136 , 44 ) < nl > + signinButton . frame = CGRectMake ( ( view . width - 136 ) / 2 , view . height - 44 - 35 , 136 , 44 ) < nl > + } < nl > } < nl > < nl > public func signupAction ( ) { < nl > diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / SwiftExtensions / AADevice . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / SwiftExtensions / AADevice . swift < nl > index ac919fe . . 5e20b9e 100644 < nl > - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / SwiftExtensions / AADevice . swift < nl > + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / SwiftExtensions / AADevice . swift < nl > @ @ - 28 , 6 + 28 , 7 @ @ public struct AADevice { < nl > / / < nl > / / iPhone sizes < nl > / / < nl > + public static let isiPhone4 = isiPhone & & screenHeight = = 480 . 0 < nl > public static let isiPhone5 = isiPhone & & screenHeight = = 568 . 0 < nl > public static let isiPhone6 = isiPhone & & screenHeight = = 667 . 0 < nl > public static let isiPhone6P = isiPhone & & screenHeight = = 736 . 0 < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java < nl > index d0106cc . . 68bbbb8 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java < nl > @ @ - 1 , 5 + 1 , 6 @ @ < nl > package im . actor . core . modules . calls . peers ; < nl > < nl > + import org . jetbrains . annotations . NotNull ; < nl > import org . jetbrains . annotations . Nullable ; < nl > < nl > import java . io . IOException ; < nl > @ @ - 29 , 16 + 30 , 22 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { < nl > < nl > public static final long TIMEOUT = 6000 ; < nl > < nl > + @ NotNull < nl > private final PeerSettings selfSettings ; < nl > + @ NotNull < nl > private final PeerCallCallback peerCallback ; < nl > + @ NotNull < nl > private final CallBusCallback callBusCallback ; < nl > + < nl > private boolean isMasterReady ; < nl > private long masterDeviceId ; < nl > + @ Nullable < nl > private PeerCallInt peerCall ; < nl > private boolean isConnected = false ; < nl > private boolean isEnabled = false ; < nl > < nl > - public CallBusActor ( final CallBusCallback callBusCallback , PeerSettings selfSettings , ModuleContext context ) { < nl > + public CallBusActor ( @ NotNull final CallBusCallback callBusCallback , < nl > + @ NotNull PeerSettings selfSettings , @ NotNull ModuleContext context ) { < nl > super ( context ) ; < nl > < nl > this . selfSettings = selfSettings ; < nl > @ @ - 72 , 17 + 79 , 17 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { < nl > / / < nl > < nl > @ Override < nl > - public void onOffer ( long deviceId , long sessionId , String sdp ) { < nl > + public void onOffer ( long deviceId , long sessionId , @ NotNull String sdp ) { < nl > sendSignal ( deviceId , new ApiOffer ( sessionId , sdp , CallBusActor . this . selfSettings . toApi ( ) ) ) ; < nl > } < nl > < nl > @ Override < nl > - public void onAnswer ( long deviceId , long sessionId , String sdp ) { < nl > + public void onAnswer ( long deviceId , long sessionId , @ NotNull String sdp ) { < nl > sendSignal ( deviceId , new ApiAnswer ( sessionId , sdp ) ) ; < nl > } < nl > < nl > @ Override < nl > - public void onCandidate ( long deviceId , int mdpIndex , String id , String sdp ) { < nl > + public void onCandidate ( long deviceId , int mdpIndex , @ NotNull String id , @ NotNull String sdp ) { < nl > sendSignal ( deviceId , new ApiCandidate ( 0 , mdpIndex , id , sdp ) ) ; < nl > } < nl > < nl > @ @ - 96 , 7 + 103 , 7 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { < nl > } < nl > < nl > @ Override < nl > - public void onPeerStateChanged ( long deviceId , PeerState state ) { < nl > + public void onPeerStateChanged ( long deviceId , @ NotNull PeerState state ) { < nl > if ( state = = PeerState . CONNECTED & & ! isConnected & & ! isEnabled ) { < nl > isConnected = true ; < nl > callBusCallback . onCallConnected ( ) ; < nl > @ @ - 108 , 12 + 115 , 12 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { < nl > } < nl > < nl > @ Override < nl > - public void onStreamAdded ( long deviceId , WebRTCMediaStream stream ) { < nl > + public void onStreamAdded ( long deviceId , @ NotNull WebRTCMediaStream stream ) { < nl > < nl > } < nl > < nl > @ Override < nl > - public void onStreamRemoved ( long deviceId , WebRTCMediaStream stream ) { < nl > + public void onStreamRemoved ( long deviceId , @ NotNull WebRTCMediaStream stream ) { < nl > < nl > } < nl > < nl > @ @ - 205 , 7 + 212 , 7 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { < nl > } < nl > } < nl > < nl > - public final void sendSignal ( long deviceId , ApiWebRTCSignaling signal ) { < nl > + public final void sendSignal ( long deviceId , @ NotNull ApiWebRTCSignaling signal ) { < nl > Log . d ( " CallBusActor " , " Message Sent : " + signal ) ; < nl > try { < nl > sendMessage ( deviceId , signal . buildContainer ( ) ) ; < nl > @ @ - 242 , 12 + 249 , 14 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { < nl > < nl > public static class JoinBus { < nl > < nl > + @ NotNull < nl > private String busId ; < nl > < nl > - public JoinBus ( String busId ) { < nl > + public JoinBus ( @ NotNull String busId ) { < nl > this . busId = busId ; < nl > } < nl > < nl > + @ NotNull < nl > public String getBusId ( ) { < nl > return busId ; < nl > } < nl > @ @ - 255 , 14 + 264 , 16 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { < nl > < nl > public static class JoinMasterBus { < nl > < nl > + @ NotNull < nl > private String busId ; < nl > private long deviceId ; < nl > < nl > - public JoinMasterBus ( String busId , long deviceId ) { < nl > + public JoinMasterBus ( @ NotNull String busId , long deviceId ) { < nl > this . busId = busId ; < nl > this . deviceId = deviceId ; < nl > } < nl > < nl > + @ NotNull < nl > public String getBusId ( ) { < nl > return busId ; < nl > } < nl > @ @ - 290 , 14 + 301 , 15 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { < nl > < nl > public class CallbackWrapper implements PeerCallCallback { < nl > < nl > + @ NotNull < nl > private final PeerCallCallback callCallback ; < nl > < nl > - public CallbackWrapper ( PeerCallCallback callCallback ) { < nl > + public CallbackWrapper ( @ NotNull PeerCallCallback callCallback ) { < nl > this . callCallback = callCallback ; < nl > } < nl > < nl > @ Override < nl > - public void onOffer ( final long deviceId , final long sessionId , final String sdp ) { < nl > + public void onOffer ( final long deviceId , final long sessionId , @ NotNull final String sdp ) { < nl > self ( ) . send ( new Runnable ( ) { < nl > @ Override < nl > public void run ( ) { < nl > @ @ - 307 , 7 + 319 , 7 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { < nl > } < nl > < nl > @ Override < nl > - public void onAnswer ( final long deviceId , final long sessionId , final String sdp ) { < nl > + public void onAnswer ( final long deviceId , final long sessionId , @ NotNull final String sdp ) { < nl > self ( ) . send ( new Runnable ( ) { < nl > @ Override < nl > public void run ( ) { < nl > @ @ - 317 , 7 + 329 , 7 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { < nl > } < nl > < nl > @ Override < nl > - public void onCandidate ( final long deviceId , final int mdpIndex , final String id , final String sdp ) { < nl > + public void onCandidate ( final long deviceId , final int mdpIndex , @ NotNull final String id , @ NotNull final String sdp ) { < nl > self ( ) . send ( new Runnable ( ) { < nl > @ Override < nl > public void run ( ) { < nl > @ @ - 337 , 7 + 349 , 7 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { < nl > } < nl > < nl > @ Override < nl > - public void onPeerStateChanged ( final long deviceId , final PeerState state ) { < nl > + public void onPeerStateChanged ( final long deviceId , @ NotNull final PeerState state ) { < nl > self ( ) . send ( new Runnable ( ) { < nl > @ Override < nl > public void run ( ) { < nl > @ @ - 347 , 7 + 359 , 7 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { < nl > } < nl > < nl > @ Override < nl > - public void onStreamAdded ( final long deviceId , final WebRTCMediaStream stream ) { < nl > + public void onStreamAdded ( final long deviceId , @ NotNull final WebRTCMediaStream stream ) { < nl > self ( ) . send ( new Runnable ( ) { < nl > @ Override < nl > public void run ( ) { < nl > @ @ - 357 , 7 + 369 , 7 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { < nl > } < nl > < nl > @ Override < nl > - public void onStreamRemoved ( final long deviceId , final WebRTCMediaStream stream ) { < nl > + public void onStreamRemoved ( final long deviceId , @ NotNull final WebRTCMediaStream stream ) { < nl > self ( ) . send ( new Runnable ( ) { < nl > @ Override < nl > public void run ( ) { < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java < nl > index e26bff1 . . 51028fe 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java < nl > @ @ - 1 , 8 + 1 , 10 @ @ < nl > package im . actor . core . modules . calls . peers ; < nl > < nl > + import org . jetbrains . annotations . NotNull ; < nl > + < nl > public interface CallBusCallback { < nl > < nl > - void onBusStarted ( String busId ) ; < nl > + void onBusStarted ( @ NotNull String busId ) ; < nl > < nl > void onCallConnected ( ) ; < nl > < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusInt . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusInt . java < nl > index 3ac90df . . 005ff48 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusInt . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusInt . java < nl > @ @ - 1 , 19 + 1 , 21 @ @ < nl > package im . actor . core . modules . calls . peers ; < nl > < nl > + import org . jetbrains . annotations . NotNull ; < nl > + < nl > import im . actor . runtime . actors . ActorInterface ; < nl > import im . actor . runtime . actors . ActorRef ; < nl > < nl > public class CallBusInt extends ActorInterface { < nl > < nl > - public CallBusInt ( ActorRef dest ) { < nl > + public CallBusInt ( @ NotNull ActorRef dest ) { < nl > super ( dest ) ; < nl > } < nl > < nl > - public void joinBus ( String busId ) { < nl > + public void joinBus ( @ NotNull String busId ) { < nl > send ( new CallBusActor . JoinBus ( busId ) ) ; < nl > } < nl > < nl > - public void joinMasterBus ( String busId , long deviceId ) { < nl > + public void joinMasterBus ( @ NotNull String busId , long deviceId ) { < nl > send ( new CallBusActor . JoinMasterBus ( busId , deviceId ) ) ; < nl > } < nl > < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallInt . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallInt . java < nl > index bf0a068 . . 61f92ca 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallInt . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallInt . java < nl > @ @ - 1 , 5 + 1 , 7 @ @ < nl > package im . actor . core . modules . calls . peers ; < nl > < nl > + import org . jetbrains . annotations . NotNull ; < nl > + < nl > import java . util . ArrayList ; < nl > import java . util . List ; < nl > < nl > @ @ - 35 , 7 + 37 , 7 @ @ public class PeerCallInt extends ActorInterface { < nl > send ( new PeerCallActor . OwnStarted ( ) ) ; < nl > } < nl > < nl > - public void onAdvertised ( long deviceId , PeerSettings settings ) { < nl > + public void onAdvertised ( long deviceId , @ NotNull PeerSettings settings ) { < nl > send ( new RTCAdvertised ( deviceId , settings ) ) ; < nl > } < nl > < nl > diff - - git a / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / actors / ActorInterface . java b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / actors / ActorInterface . java < nl > index 9aba327 . . 80bbfcd 100644 < nl > - - - a / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / actors / ActorInterface . java < nl > + + + b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / actors / ActorInterface . java < nl > @ @ - 1 , 5 + 1 , 7 @ @ < nl > package im . actor . runtime . actors ; < nl > < nl > + import org . jetbrains . annotations . NotNull ; < nl > + < nl > import im . actor . runtime . Log ; < nl > import im . actor . runtime . actors . ask . AskIntRequest ; < nl > import im . actor . runtime . actors . ask . AskMessage ; < nl > @ @ - 12 , 9 + 14 , 10 @ @ import im . actor . runtime . promise . PromiseResolver ; < nl > < nl > public abstract class ActorInterface { < nl > < nl > + @ NotNull < nl > private ActorRef dest ; < nl > < nl > - public ActorInterface ( ActorRef dest ) { < nl > + public ActorInterface ( @ NotNull ActorRef dest ) { < nl > this . dest = dest ; < nl > } < nl > < nl > @ @ - 22 , 10 + 25 , 11 @ @ public abstract class ActorInterface { < nl > < nl > } < nl > < nl > - protected void setDest ( ActorRef ref ) { < nl > + protected void setDest ( @ NotNull ActorRef ref ) { < nl > this . dest = ref ; < nl > } < nl > < nl > + @ NotNull < nl > public ActorRef getDest ( ) { < nl > return dest ; < nl > } < nl > @ @ - 34 , 23 + 38 , 12 @ @ public abstract class ActorInterface { < nl > dest . send ( message ) ; < nl > } < nl > < nl > - protected < T > Promise < T > ask ( final AskMessage < T > message ) { < nl > - return new Promise < T > ( new PromiseFunc < T > ( ) { < nl > + protected < T > Promise < T > ask ( @ NotNull final AskMessage < T > message ) { < nl > + return new Promise < > ( new PromiseFunc < T > ( ) { < nl > @ Override < nl > public void exec ( PromiseResolver < T > executor ) { < nl > - Log . d ( " IPC " , " [ " + dest . getPath ( ) + " ] - > " + message ) ; < nl > send ( new AskIntRequest ( message , executor ) ) ; < nl > } < nl > - } ) . then ( new Consumer < T > ( ) { < nl > - @ Override < nl > - public void apply ( T t ) { < nl > - Log . d ( " IPC " , " [ " + dest . getPath ( ) + " ] < - " + message + " < - " + t ) ; < nl > - } < nl > - } ) . failure ( new Consumer < Exception > ( ) { < nl > - @ Override < nl > - public void apply ( Exception e ) { < nl > - Log . w ( " IPC " , " [ " + dest . getPath ( ) + " ] < - " + message + " < - " + e ) ; < nl > - } < nl > } ) ; < nl > }
NEAREST DIFF (one line): diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java < nl > index c2c125d . . ec0ac24 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java < nl > @ @ - 45 , 7 + 45 , 7 @ @ public class CallActor extends AbsCallActor { < nl > @ Override < nl > public void apply ( final ResponseGetCallInfo responseGetCallInfo ) { < nl > peer = convert ( responseGetCallInfo . getPeer ( ) ) ; < nl > - callBus . joinBus ( responseGetCallInfo . getEventBusId ( ) ) ; < nl > + callBus . startSlaveBus ( responseGetCallInfo . getEventBusId ( ) ) ; < nl > callVM = callViewModels . spawnNewIncomingVM ( callId , peer , CallState . RINGING ) ; < nl > } < nl > } ) . failure ( new Consumer < Exception > ( ) { < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java < nl > index d3e21a6 . . 32a8436 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java < nl > @ @ - 73 , 8 + 73 , 7 @ @ public class CallManagerActor extends ModuleActor { < nl > system ( ) . actorOf ( " actor / master / " + RandomUtils . nextRid ( ) , new ActorCreator ( ) { < nl > @ Override < nl > public Actor create ( ) { < nl > - / / return new PeerCallMasterActor ( peer , callback , context ( ) ) ; < nl > - return null ; < nl > + return new CallMasterActor ( peer , context ( ) , callback ) ; < nl > } < nl > } ) ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallMasterActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallMasterActor . java < nl > new file mode 100644 < nl > index 0000000 . . 5005b03 < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallMasterActor . java < nl > @ @ - 0 , 0 + 1 , 104 @ @ < nl > + package im . actor . core . modules . calls ; < nl > + < nl > + import java . util . HashSet ; < nl > + < nl > + import im . actor . core . api . rpc . RequestDoCall ; < nl > + import im . actor . core . api . rpc . ResponseDoCall ; < nl > + import im . actor . core . entity . GroupMember ; < nl > + import im . actor . core . entity . Peer ; < nl > + import im . actor . core . entity . PeerType ; < nl > + import im . actor . core . modules . ModuleContext ; < nl > + import im . actor . core . modules . calls . peers . AbsCallActor ; < nl > + import im . actor . core . viewmodel . CallVM ; < nl > + import im . actor . core . viewmodel . CommandCallback ; < nl > + import im . actor . runtime . Log ; < nl > + import im . actor . runtime . function . Consumer ; < nl > + < nl > + public class CallMasterActor extends AbsCallActor { < nl > + < nl > + private final Peer peer ; < nl > + private long callId ; < nl > + private CallVM callVM ; < nl > + private CommandCallback < Long > callback ; < nl > + < nl > + public CallMasterActor ( Peer peer , ModuleContext context , CommandCallback < Long > callback ) { < nl > + super ( context ) ; < nl > + this . peer = peer ; < nl > + this . callback = callback ; < nl > + } < nl > + < nl > + @ Override < nl > + public void callPreStart ( ) { < nl > + callBus . startMaster ( ) ; < nl > + peerCall . onOwnStarted ( ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public void onBusStarted ( String busId ) { < nl > + api ( new RequestDoCall ( buidOutPeer ( peer ) , busId ) ) . then ( new Consumer < ResponseDoCall > ( ) { < nl > + @ Override < nl > + public void apply ( ResponseDoCall responseDoCall ) { < nl > + < nl > + / / < nl > + / / Initialization of Call State < nl > + / / < nl > + / / TODO : Possible race conditions when members changed during call initiation < nl > + / / Need to return explicit callers in response < nl > + < nl > + if ( peer . getPeerType ( ) = = PeerType . GROUP ) { < nl > + for ( GroupMember gm : getGroup ( peer . getPeerId ( ) ) . getMembers ( ) ) { < nl > + if ( gm . getUid ( ) ! = myUid ( ) ) { < nl > + / / state . addMember ( gm . getUid ( ) , MasterCallMemberState . RINGING ) ; < nl > + } < nl > + } < nl > + } else if ( peer . getPeerType ( ) = = PeerType . PRIVATE ) { < nl > + / / state . addMember ( peer . getPeerId ( ) , MasterCallMemberState . RINGING ) ; < nl > + } else { < nl > + throw new RuntimeException ( " Unsupported Peer Type group " ) ; < nl > + } < nl > + < nl > + / / < nl > + / / Initialization of CallVM < nl > + / / < nl > + callId = responseDoCall . getCallId ( ) ; < nl > + callVM = callViewModels . spawnNewOutgoingVM ( responseDoCall . getCallId ( ) , peer ) ; < nl > + / / callVM . getIsMuted ( ) . change ( isMuted ( ) ) ; < nl > + < nl > + / / < nl > + / / Notifying about successful call creation < nl > + / / < nl > + callManager . send ( new CallManagerActor . DoCallComplete ( responseDoCall . getCallId ( ) ) , self ( ) ) ; < nl > + callback . onResult ( responseDoCall . getCallId ( ) ) ; < nl > + callback = null ; < nl > + } < nl > + } ) . failure ( new Consumer < Exception > ( ) { < nl > + @ Override < nl > + public void apply ( Exception e ) { < nl > + callback . onError ( e ) ; < nl > + callback = null ; < nl > + dispose ( ) ; < nl > + } < nl > + } ) . done ( self ( ) ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public void onAnswered ( int uid , long deviceId ) { < nl > + Log . d ( " CallMasterActor " , " On Answered : " + uid + " , device : " + deviceId ) ; < nl > + peerCall . onTheirStarted ( deviceId ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public void onPeerConnected ( int uid , long deviceId ) { < nl > + Log . d ( " CallMasterActor " , " On Peer Connected : " + uid + " , device : " + deviceId ) ; < nl > + peerCall . onOfferNeeded ( deviceId ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public void postStop ( ) { < nl > + super . postStop ( ) ; < nl > + if ( callback ! = null ) { < nl > + callback . onError ( new RuntimeException ( ) ) ; < nl > + callback = null ; < nl > + } < nl > + } < nl > + } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / AbsCallActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / AbsCallActor . java < nl > index 7817cec . . 4eebf2f 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / AbsCallActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / AbsCallActor . java < nl > @ @ - 63 , 6 + 63 , 16 @ @ public abstract class AbsCallActor extends EventBusActor implements CallBusCallb < nl > < nl > } < nl > < nl > + @ Override < nl > + public void onPeerConnected ( int uid , long deviceId ) { < nl > + < nl > + } < nl > + < nl > + @ Override < nl > + public void onAnswered ( int uid , long deviceId ) { < nl > + < nl > + } < nl > + < nl > public void onMuteChanged ( boolean isMuted ) { < nl > peerCall . onMuteChanged ( isMuted ) ; < nl > } < nl > @ @ - 126 , 6 + 136 , 16 @ @ public abstract class AbsCallActor extends EventBusActor implements CallBusCallb < nl > } < nl > < nl > @ Override < nl > + public void onPeerConnected ( final int uid , final long deviceId ) { < nl > + self ( ) . send ( new Runnable ( ) { < nl > + @ Override < nl > + public void run ( ) { < nl > + AbsCallActor . this . onPeerConnected ( uid , deviceId ) ; < nl > + } < nl > + } ) ; < nl > + } < nl > + < nl > + @ Override < nl > public void onPeerStateChanged ( final int uid , final long deviceId , final PeerState state ) { < nl > self ( ) . send ( new Runnable ( ) { < nl > @ Override < nl > @ @ - 134 , 5 + 154 , 15 @ @ public abstract class AbsCallActor extends EventBusActor implements CallBusCallb < nl > } < nl > } ) ; < nl > } < nl > + < nl > + @ Override < nl > + public void onAnswered ( final int uid , final long deviceId ) { < nl > + self ( ) . send ( new Runnable ( ) { < nl > + @ Override < nl > + public void run ( ) { < nl > + AbsCallActor . this . onAnswered ( uid , deviceId ) ; < nl > + } < nl > + } ) ; < nl > + } < nl > } < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java < nl > index 6ebd1c4 . . 89814bd 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java < nl > @ @ - 10 , 6 + 10 , 7 @ @ import im . actor . core . api . ApiAnswer ; < nl > import im . actor . core . api . ApiAnswerCall ; < nl > import im . actor . core . api . ApiCandidate ; < nl > import im . actor . core . api . ApiMembersChanged ; < nl > + import im . actor . core . api . ApiNeedDisconnect ; < nl > import im . actor . core . api . ApiNeedOffer ; < nl > import im . actor . core . api . ApiOffer ; < nl > import im . actor . core . api . ApiOnAnswer ; < nl > @ @ - 37 , 6 + 38 , 7 @ @ public class CallBusActor extends EventBusActor { < nl > private final PeerSettings selfSettings ; < nl > private final PeerCallCallback peerCallback ; < nl > private final CallBusCallback callBusCallback ; < nl > + private boolean isMasterMode ; < nl > private boolean isMasterReady ; < nl > private int masterUid ; < nl > private long masterDeviceId ; < nl > @ @ - 96 , 6 + 98 , 11 @ @ public class CallBusActor extends EventBusActor { < nl > callBusCallback . onBusCreated ( peerCall ) ; < nl > } < nl > < nl > + public void createMasterBus ( ) { < nl > + isMasterMode = true ; < nl > + createBus ( ) ; < nl > + } < nl > + < nl > @ Override < nl > public void onBusStarted ( ) { < nl > super . onBusStarted ( ) ; < nl > @ @ - 111 , 6 + 118 , 20 @ @ public class CallBusActor extends EventBusActor { < nl > } < nl > < nl > @ Override < nl > + public void onDeviceConnected ( int uid , long deviceId ) { < nl > + deviceIds . put ( deviceId , uid ) ; < nl > + if ( isMasterMode ) { < nl > + sendSignal ( uid , deviceId , new ApiSwitchMaster ( ) ) ; < nl > + } < nl > + callBusCallback . onPeerConnected ( uid , deviceId ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public void onDeviceDisconnected ( int uid , long deviceId ) { < nl > + peerCall . disposePeer ( deviceId ) ; < nl > + } < nl > + < nl > + @ Override < nl > public final void onMessageReceived ( @ Nullable Integer senderId , @ Nullable Long senderDeviceId , byte [ ] data ) { < nl > if ( senderId = = null | | senderDeviceId = = null ) { < nl > return ; < nl > @ @ - 144 , 15 + 165 , 16 @ @ public class CallBusActor extends EventBusActor { < nl > peerCall . onAdvertised ( needOffer . getDevice ( ) , new PeerSettings ( needOffer . getPeerSettings ( ) ) ) ; < nl > peerCall . onOfferNeeded ( needOffer . getDevice ( ) ) ; < nl > peerCall . onTheirStarted ( needOffer . getDevice ( ) ) ; < nl > - / / if ( needOffer . isSilent ( ) ! = null & & ! needOffer . isSilent ( ) ) { < nl > - / / peerCall . onTheirStarted ( needOffer . getDevice ( ) ) ; < nl > - / / } < nl > } else if ( signal instanceof ApiOnAnswer ) { < nl > ApiOnAnswer onAnswer = ( ApiOnAnswer ) signal ; < nl > deviceIds . put ( onAnswer . getDevice ( ) , onAnswer . getUid ( ) ) ; < nl > peerCall . onTheirStarted ( onAnswer . getDevice ( ) ) ; < nl > + } else if ( signal instanceof ApiNeedDisconnect ) { < nl > + ApiNeedDisconnect disconnect = ( ApiNeedDisconnect ) signal ; < nl > + deviceIds . put ( disconnect . getDevice ( ) , disconnect . getUid ( ) ) ; < nl > + peerCall . disposePeer ( disconnect . getDevice ( ) ) ; < nl > } else if ( signal instanceof ApiSwitchMaster ) { < nl > - if ( isMasterReady ) { < nl > + if ( isMasterReady | | isMasterMode ) { < nl > return ; < nl > } < nl > isMasterReady = true ; < nl > @ @ - 160 , 18 + 182 , 11 @ @ public class CallBusActor extends EventBusActor { < nl > masterDeviceId = senderDeviceId ; < nl > unstashAll ( STASH ) ; < nl > sendSignal ( masterUid , masterDeviceId , new ApiAdvertiseSelf ( selfSettings . toApi ( ) ) ) ; < nl > - } else { < nl > - / / if ( callBusCallback instanceof CallBusCallbackSlave ) { < nl > - / / CallBusCallbackSlave slaveCallback = ( CallBusCallbackSlave ) callBusCallback ; < nl > - / / if ( signal instanceof ApiSwitchMaster ) { < nl > - / / slaveCallback . onMasterSwitched ( senderId , senderDeviceId ) ; < nl > - / / } else if ( signal instanceof ApiMembersChanged ) { < nl > - / / ApiMembersChanged membersChanged = ( ApiMembersChanged ) signal ; < nl > - / / slaveCallback . onMembersChanged ( membersChanged . getAllMembers ( ) ) ; < nl > - / / } < nl > - / / } else { < nl > - / / / / Nothing ? < nl > - / / } < nl > + } else if ( signal instanceof ApiAdvertiseSelf ) { < nl > + ApiAdvertiseSelf advertiseSelf = ( ApiAdvertiseSelf ) signal ; < nl > + peerCall . onAdvertised ( senderDeviceId , new PeerSettings ( advertiseSelf . getPeerSettings ( ) ) ) ; < nl > + } else if ( signal instanceof ApiAnswerCall ) { < nl > + callBusCallback . onAnswered ( senderId , senderDeviceId ) ; < nl > } < nl > } < nl > < nl > @ @ - 193 , 17 + 208 , 23 @ @ public class CallBusActor extends EventBusActor { < nl > if ( message instanceof JoinBus ) { < nl > joinBus ( ( ( JoinBus ) message ) . getBusId ( ) ) ; < nl > } else if ( message instanceof CreateBus ) { < nl > - createBus ( ) ; < nl > + createMasterBus ( ) ; < nl > } else if ( message instanceof SendSignal ) { < nl > SendSignal signal = ( SendSignal ) message ; < nl > sendSignal ( signal . getUid ( ) , signal . getDeviceId ( ) , signal . getSignal ( ) ) ; < nl > } else if ( message instanceof AnswerCall ) { < nl > + if ( isMasterMode ) { < nl > + return ; < nl > + } < nl > if ( ! isMasterReady ) { < nl > stash ( STASH ) ; < nl > return ; < nl > } < nl > onAnswerCall ( ) ; < nl > } else if ( message instanceof RejectCall ) { < nl > + if ( isMasterMode ) { < nl > + return ; < nl > + } < nl > if ( ! isMasterReady ) { < nl > stash ( STASH ) ; < nl > return ; < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java < nl > index 8d21384 . . 7dc807a 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java < nl > @ @ - 14 , 5 + 14 , 9 @ @ public interface CallBusCallback { < nl > < nl > void onMembersChanged ( List < ApiCallMember > members ) ; < nl > < nl > + void onPeerConnected ( int uid , long deviceId ) ; < nl > + < nl > void onPeerStateChanged ( int uid , long deviceId , PeerState state ) ; < nl > + < nl > + void onAnswered ( int uid , long deviceId ) ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusInt . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusInt . java < nl > index 71314b3 . . 3ca058b 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusInt . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusInt . java < nl > @ @ - 10 , 11 + 10 , 11 @ @ public class CallBusInt extends ActorInterface { < nl > super ( dest ) ; < nl > } < nl > < nl > - public void joinBus ( String busId ) { < nl > + public void startSlaveBus ( String busId ) { < nl > send ( new CallBusActor . JoinBus ( busId ) ) ; < nl > } < nl > < nl > - public void createBus ( ) { < nl > + public void startMaster ( ) { < nl > send ( new CallBusActor . CreateBus ( ) ) ; < nl > }

TEST DIFF:
diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Auth / AAAuthNavigationController . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Auth / AAAuthNavigationController . swift 
 index dbfe321 . . 560d833 100644 
 - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Auth / AAAuthNavigationController . swift 
 + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Auth / AAAuthNavigationController . swift 
 @ @ - 22 , 6 + 22 , 12 @ @ public class AAAuthNavigationController : UINavigationController { 
 UIApplication . sharedApplication ( ) . setStatusBarStyle ( . Default , animated : true ) 
 } 
 
 + public override func viewWillDisappear ( animated : Bool ) { 
 + super . viewWillDisappear ( animated ) 
 + 
 + UIApplication . sharedApplication ( ) . setStatusBarStyle ( . LightContent , animated : true ) 
 + } 
 + 
 public override func preferredStatusBarStyle ( ) - > UIStatusBarStyle { 
 return . Default 
 } 
 diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Auth / AAAuthWelcomeController . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Auth / AAAuthWelcomeController . swift 
 index eb93051 . . 8090da1 100644 
 - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Auth / AAAuthWelcomeController . swift 
 + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Auth / AAAuthWelcomeController . swift 
 @ @ - 66 , 12 + 66 , 22 @ @ public class AAWelcomeController : AAViewController { 
 override public func viewDidLayoutSubviews ( ) { 
 super . viewDidLayoutSubviews ( ) 
 
 - logoView . frame = CGRectMake ( ( view . width - 90 ) / 2 , 145 , 90 , 90 ) 
 - appNameLabel . frame = CGRectMake ( ( view . width - 300 ) / 2 , logoView . bottom + 35 , 300 , 29 ) 
 - someInfoLabel . frame = CGRectMake ( ( view . width - 300 ) / 2 , appNameLabel . bottom + 8 , 300 , 46 ) 
 + if AADevice . isiPhone4 { 
 + logoView . frame = CGRectMake ( ( view . width - 90 ) / 2 , 90 , 90 , 90 ) 
 + appNameLabel . frame = CGRectMake ( ( view . width - 300 ) / 2 , logoView . bottom + 30 , 300 , 29 ) 
 + someInfoLabel . frame = CGRectMake ( ( view . width - 300 ) / 2 , appNameLabel . bottom + 8 , 300 , 46 ) 
 + 
 + signupButton . frame = CGRectMake ( ( view . width - 136 ) / 2 , view . height - 44 - 80 , 136 , 44 ) 
 + signinButton . frame = CGRectMake ( ( view . width - 136 ) / 2 , view . height - 44 - 25 , 136 , 44 ) 
 + } else { 
 + 
 + logoView . frame = CGRectMake ( ( view . width - 90 ) / 2 , 145 , 90 , 90 ) 
 + appNameLabel . frame = CGRectMake ( ( view . width - 300 ) / 2 , logoView . bottom + 35 , 300 , 29 ) 
 + someInfoLabel . frame = CGRectMake ( ( view . width - 300 ) / 2 , appNameLabel . bottom + 8 , 300 , 46 ) 
 
 - signupButton . frame = CGRectMake ( ( view . width - 136 ) / 2 , view . height - 44 - 90 , 136 , 44 ) 
 - signinButton . frame = CGRectMake ( ( view . width - 136 ) / 2 , view . height - 44 - 35 , 136 , 44 ) 
 + signupButton . frame = CGRectMake ( ( view . width - 136 ) / 2 , view . height - 44 - 90 , 136 , 44 ) 
 + signinButton . frame = CGRectMake ( ( view . width - 136 ) / 2 , view . height - 44 - 35 , 136 , 44 ) 
 + } 
 } 
 
 public func signupAction ( ) { 
 diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / SwiftExtensions / AADevice . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / SwiftExtensions / AADevice . swift 
 index ac919fe . . 5e20b9e 100644 
 - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / SwiftExtensions / AADevice . swift 
 + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / SwiftExtensions / AADevice . swift 
 @ @ - 28 , 6 + 28 , 7 @ @ public struct AADevice { 
 / / 
 / / iPhone sizes 
 / / 
 + public static let isiPhone4 = isiPhone & & screenHeight = = 480 . 0 
 public static let isiPhone5 = isiPhone & & screenHeight = = 568 . 0 
 public static let isiPhone6 = isiPhone & & screenHeight = = 667 . 0 
 public static let isiPhone6P = isiPhone & & screenHeight = = 736 . 0 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java 
 index d0106cc . . 68bbbb8 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java 
 @ @ - 1 , 5 + 1 , 6 @ @ 
 package im . actor . core . modules . calls . peers ; 
 
 + import org . jetbrains . annotations . NotNull ; 
 import org . jetbrains . annotations . Nullable ; 
 
 import java . io . IOException ; 
 @ @ - 29 , 16 + 30 , 22 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { 
 
 public static final long TIMEOUT = 6000 ; 
 
 + @ NotNull 
 private final PeerSettings selfSettings ; 
 + @ NotNull 
 private final PeerCallCallback peerCallback ; 
 + @ NotNull 
 private final CallBusCallback callBusCallback ; 
 + 
 private boolean isMasterReady ; 
 private long masterDeviceId ; 
 + @ Nullable 
 private PeerCallInt peerCall ; 
 private boolean isConnected = false ; 
 private boolean isEnabled = false ; 
 
 - public CallBusActor ( final CallBusCallback callBusCallback , PeerSettings selfSettings , ModuleContext context ) { 
 + public CallBusActor ( @ NotNull final CallBusCallback callBusCallback , 
 + @ NotNull PeerSettings selfSettings , @ NotNull ModuleContext context ) { 
 super ( context ) ; 
 
 this . selfSettings = selfSettings ; 
 @ @ - 72 , 17 + 79 , 17 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { 
 / / 
 
 @ Override 
 - public void onOffer ( long deviceId , long sessionId , String sdp ) { 
 + public void onOffer ( long deviceId , long sessionId , @ NotNull String sdp ) { 
 sendSignal ( deviceId , new ApiOffer ( sessionId , sdp , CallBusActor . this . selfSettings . toApi ( ) ) ) ; 
 } 
 
 @ Override 
 - public void onAnswer ( long deviceId , long sessionId , String sdp ) { 
 + public void onAnswer ( long deviceId , long sessionId , @ NotNull String sdp ) { 
 sendSignal ( deviceId , new ApiAnswer ( sessionId , sdp ) ) ; 
 } 
 
 @ Override 
 - public void onCandidate ( long deviceId , int mdpIndex , String id , String sdp ) { 
 + public void onCandidate ( long deviceId , int mdpIndex , @ NotNull String id , @ NotNull String sdp ) { 
 sendSignal ( deviceId , new ApiCandidate ( 0 , mdpIndex , id , sdp ) ) ; 
 } 
 
 @ @ - 96 , 7 + 103 , 7 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { 
 } 
 
 @ Override 
 - public void onPeerStateChanged ( long deviceId , PeerState state ) { 
 + public void onPeerStateChanged ( long deviceId , @ NotNull PeerState state ) { 
 if ( state = = PeerState . CONNECTED & & ! isConnected & & ! isEnabled ) { 
 isConnected = true ; 
 callBusCallback . onCallConnected ( ) ; 
 @ @ - 108 , 12 + 115 , 12 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { 
 } 
 
 @ Override 
 - public void onStreamAdded ( long deviceId , WebRTCMediaStream stream ) { 
 + public void onStreamAdded ( long deviceId , @ NotNull WebRTCMediaStream stream ) { 
 
 } 
 
 @ Override 
 - public void onStreamRemoved ( long deviceId , WebRTCMediaStream stream ) { 
 + public void onStreamRemoved ( long deviceId , @ NotNull WebRTCMediaStream stream ) { 
 
 } 
 
 @ @ - 205 , 7 + 212 , 7 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { 
 } 
 } 
 
 - public final void sendSignal ( long deviceId , ApiWebRTCSignaling signal ) { 
 + public final void sendSignal ( long deviceId , @ NotNull ApiWebRTCSignaling signal ) { 
 Log . d ( " CallBusActor " , " Message Sent : " + signal ) ; 
 try { 
 sendMessage ( deviceId , signal . buildContainer ( ) ) ; 
 @ @ - 242 , 12 + 249 , 14 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { 
 
 public static class JoinBus { 
 
 + @ NotNull 
 private String busId ; 
 
 - public JoinBus ( String busId ) { 
 + public JoinBus ( @ NotNull String busId ) { 
 this . busId = busId ; 
 } 
 
 + @ NotNull 
 public String getBusId ( ) { 
 return busId ; 
 } 
 @ @ - 255 , 14 + 264 , 16 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { 
 
 public static class JoinMasterBus { 
 
 + @ NotNull 
 private String busId ; 
 private long deviceId ; 
 
 - public JoinMasterBus ( String busId , long deviceId ) { 
 + public JoinMasterBus ( @ NotNull String busId , long deviceId ) { 
 this . busId = busId ; 
 this . deviceId = deviceId ; 
 } 
 
 + @ NotNull 
 public String getBusId ( ) { 
 return busId ; 
 } 
 @ @ - 290 , 14 + 301 , 15 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { 
 
 public class CallbackWrapper implements PeerCallCallback { 
 
 + @ NotNull 
 private final PeerCallCallback callCallback ; 
 
 - public CallbackWrapper ( PeerCallCallback callCallback ) { 
 + public CallbackWrapper ( @ NotNull PeerCallCallback callCallback ) { 
 this . callCallback = callCallback ; 
 } 
 
 @ Override 
 - public void onOffer ( final long deviceId , final long sessionId , final String sdp ) { 
 + public void onOffer ( final long deviceId , final long sessionId , @ NotNull final String sdp ) { 
 self ( ) . send ( new Runnable ( ) { 
 @ Override 
 public void run ( ) { 
 @ @ - 307 , 7 + 319 , 7 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { 
 } 
 
 @ Override 
 - public void onAnswer ( final long deviceId , final long sessionId , final String sdp ) { 
 + public void onAnswer ( final long deviceId , final long sessionId , @ NotNull final String sdp ) { 
 self ( ) . send ( new Runnable ( ) { 
 @ Override 
 public void run ( ) { 
 @ @ - 317 , 7 + 329 , 7 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { 
 } 
 
 @ Override 
 - public void onCandidate ( final long deviceId , final int mdpIndex , final String id , final String sdp ) { 
 + public void onCandidate ( final long deviceId , final int mdpIndex , @ NotNull final String id , @ NotNull final String sdp ) { 
 self ( ) . send ( new Runnable ( ) { 
 @ Override 
 public void run ( ) { 
 @ @ - 337 , 7 + 349 , 7 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { 
 } 
 
 @ Override 
 - public void onPeerStateChanged ( final long deviceId , final PeerState state ) { 
 + public void onPeerStateChanged ( final long deviceId , @ NotNull final PeerState state ) { 
 self ( ) . send ( new Runnable ( ) { 
 @ Override 
 public void run ( ) { 
 @ @ - 347 , 7 + 359 , 7 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { 
 } 
 
 @ Override 
 - public void onStreamAdded ( final long deviceId , final WebRTCMediaStream stream ) { 
 + public void onStreamAdded ( final long deviceId , @ NotNull final WebRTCMediaStream stream ) { 
 self ( ) . send ( new Runnable ( ) { 
 @ Override 
 public void run ( ) { 
 @ @ - 357 , 7 + 369 , 7 @ @ public class CallBusActor extends EventBusActor implements PeerCallCallback { 
 } 
 
 @ Override 
 - public void onStreamRemoved ( final long deviceId , final WebRTCMediaStream stream ) { 
 + public void onStreamRemoved ( final long deviceId , @ NotNull final WebRTCMediaStream stream ) { 
 self ( ) . send ( new Runnable ( ) { 
 @ Override 
 public void run ( ) { 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java 
 index e26bff1 . . 51028fe 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java 
 @ @ - 1 , 8 + 1 , 10 @ @ 
 package im . actor . core . modules . calls . peers ; 
 
 + import org . jetbrains . annotations . NotNull ; 
 + 
 public interface CallBusCallback { 
 
 - void onBusStarted ( String busId ) ; 
 + void onBusStarted ( @ NotNull String busId ) ; 
 
 void onCallConnected ( ) ; 
 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusInt . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusInt . java 
 index 3ac90df . . 005ff48 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusInt . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusInt . java 
 @ @ - 1 , 19 + 1 , 21 @ @ 
 package im . actor . core . modules . calls . peers ; 
 
 + import org . jetbrains . annotations . NotNull ; 
 + 
 import im . actor . runtime . actors . ActorInterface ; 
 import im . actor . runtime . actors . ActorRef ; 
 
 public class CallBusInt extends ActorInterface { 
 
 - public CallBusInt ( ActorRef dest ) { 
 + public CallBusInt ( @ NotNull ActorRef dest ) { 
 super ( dest ) ; 
 } 
 
 - public void joinBus ( String busId ) { 
 + public void joinBus ( @ NotNull String busId ) { 
 send ( new CallBusActor . JoinBus ( busId ) ) ; 
 } 
 
 - public void joinMasterBus ( String busId , long deviceId ) { 
 + public void joinMasterBus ( @ NotNull String busId , long deviceId ) { 
 send ( new CallBusActor . JoinMasterBus ( busId , deviceId ) ) ; 
 } 
 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallInt . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallInt . java 
 index bf0a068 . . 61f92ca 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallInt . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / PeerCallInt . java 
 @ @ - 1 , 5 + 1 , 7 @ @ 
 package im . actor . core . modules . calls . peers ; 
 
 + import org . jetbrains . annotations . NotNull ; 
 + 
 import java . util . ArrayList ; 
 import java . util . List ; 
 
 @ @ - 35 , 7 + 37 , 7 @ @ public class PeerCallInt extends ActorInterface { 
 send ( new PeerCallActor . OwnStarted ( ) ) ; 
 } 
 
 - public void onAdvertised ( long deviceId , PeerSettings settings ) { 
 + public void onAdvertised ( long deviceId , @ NotNull PeerSettings settings ) { 
 send ( new RTCAdvertised ( deviceId , settings ) ) ; 
 } 
 
 diff - - git a / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / actors / ActorInterface . java b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / actors / ActorInterface . java 
 index 9aba327 . . 80bbfcd 100644 
 - - - a / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / actors / ActorInterface . java 
 + + + b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / actors / ActorInterface . java 
 @ @ - 1 , 5 + 1 , 7 @ @ 
 package im . actor . runtime . actors ; 
 
 + import org . jetbrains . annotations . NotNull ; 
 + 
 import im . actor . runtime . Log ; 
 import im . actor . runtime . actors . ask . AskIntRequest ; 
 import im . actor . runtime . actors . ask . AskMessage ; 
 @ @ - 12 , 9 + 14 , 10 @ @ import im . actor . runtime . promise . PromiseResolver ; 
 
 public abstract class ActorInterface { 
 
 + @ NotNull 
 private ActorRef dest ; 
 
 - public ActorInterface ( ActorRef dest ) { 
 + public ActorInterface ( @ NotNull ActorRef dest ) { 
 this . dest = dest ; 
 } 
 
 @ @ - 22 , 10 + 25 , 11 @ @ public abstract class ActorInterface { 
 
 } 
 
 - protected void setDest ( ActorRef ref ) { 
 + protected void setDest ( @ NotNull ActorRef ref ) { 
 this . dest = ref ; 
 } 
 
 + @ NotNull 
 public ActorRef getDest ( ) { 
 return dest ; 
 } 
 @ @ - 34 , 23 + 38 , 12 @ @ public abstract class ActorInterface { 
 dest . send ( message ) ; 
 } 
 
 - protected < T > Promise < T > ask ( final AskMessage < T > message ) { 
 - return new Promise < T > ( new PromiseFunc < T > ( ) { 
 + protected < T > Promise < T > ask ( @ NotNull final AskMessage < T > message ) { 
 + return new Promise < > ( new PromiseFunc < T > ( ) { 
 @ Override 
 public void exec ( PromiseResolver < T > executor ) { 
 - Log . d ( " IPC " , " [ " + dest . getPath ( ) + " ] - > " + message ) ; 
 send ( new AskIntRequest ( message , executor ) ) ; 
 } 
 - } ) . then ( new Consumer < T > ( ) { 
 - @ Override 
 - public void apply ( T t ) { 
 - Log . d ( " IPC " , " [ " + dest . getPath ( ) + " ] < - " + message + " < - " + t ) ; 
 - } 
 - } ) . failure ( new Consumer < Exception > ( ) { 
 - @ Override 
 - public void apply ( Exception e ) { 
 - Log . w ( " IPC " , " [ " + dest . getPath ( ) + " ] < - " + message + " < - " + e ) ; 
 - } 
 } ) ; 
 }

NEAREST DIFF:
diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java 
 index c2c125d . . ec0ac24 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallActor . java 
 @ @ - 45 , 7 + 45 , 7 @ @ public class CallActor extends AbsCallActor { 
 @ Override 
 public void apply ( final ResponseGetCallInfo responseGetCallInfo ) { 
 peer = convert ( responseGetCallInfo . getPeer ( ) ) ; 
 - callBus . joinBus ( responseGetCallInfo . getEventBusId ( ) ) ; 
 + callBus . startSlaveBus ( responseGetCallInfo . getEventBusId ( ) ) ; 
 callVM = callViewModels . spawnNewIncomingVM ( callId , peer , CallState . RINGING ) ; 
 } 
 } ) . failure ( new Consumer < Exception > ( ) { 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java 
 index d3e21a6 . . 32a8436 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java 
 @ @ - 73 , 8 + 73 , 7 @ @ public class CallManagerActor extends ModuleActor { 
 system ( ) . actorOf ( " actor / master / " + RandomUtils . nextRid ( ) , new ActorCreator ( ) { 
 @ Override 
 public Actor create ( ) { 
 - / / return new PeerCallMasterActor ( peer , callback , context ( ) ) ; 
 - return null ; 
 + return new CallMasterActor ( peer , context ( ) , callback ) ; 
 } 
 } ) ; 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallMasterActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallMasterActor . java 
 new file mode 100644 
 index 0000000 . . 5005b03 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallMasterActor . java 
 @ @ - 0 , 0 + 1 , 104 @ @ 
 + package im . actor . core . modules . calls ; 
 + 
 + import java . util . HashSet ; 
 + 
 + import im . actor . core . api . rpc . RequestDoCall ; 
 + import im . actor . core . api . rpc . ResponseDoCall ; 
 + import im . actor . core . entity . GroupMember ; 
 + import im . actor . core . entity . Peer ; 
 + import im . actor . core . entity . PeerType ; 
 + import im . actor . core . modules . ModuleContext ; 
 + import im . actor . core . modules . calls . peers . AbsCallActor ; 
 + import im . actor . core . viewmodel . CallVM ; 
 + import im . actor . core . viewmodel . CommandCallback ; 
 + import im . actor . runtime . Log ; 
 + import im . actor . runtime . function . Consumer ; 
 + 
 + public class CallMasterActor extends AbsCallActor { 
 + 
 + private final Peer peer ; 
 + private long callId ; 
 + private CallVM callVM ; 
 + private CommandCallback < Long > callback ; 
 + 
 + public CallMasterActor ( Peer peer , ModuleContext context , CommandCallback < Long > callback ) { 
 + super ( context ) ; 
 + this . peer = peer ; 
 + this . callback = callback ; 
 + } 
 + 
 + @ Override 
 + public void callPreStart ( ) { 
 + callBus . startMaster ( ) ; 
 + peerCall . onOwnStarted ( ) ; 
 + } 
 + 
 + @ Override 
 + public void onBusStarted ( String busId ) { 
 + api ( new RequestDoCall ( buidOutPeer ( peer ) , busId ) ) . then ( new Consumer < ResponseDoCall > ( ) { 
 + @ Override 
 + public void apply ( ResponseDoCall responseDoCall ) { 
 + 
 + / / 
 + / / Initialization of Call State 
 + / / 
 + / / TODO : Possible race conditions when members changed during call initiation 
 + / / Need to return explicit callers in response 
 + 
 + if ( peer . getPeerType ( ) = = PeerType . GROUP ) { 
 + for ( GroupMember gm : getGroup ( peer . getPeerId ( ) ) . getMembers ( ) ) { 
 + if ( gm . getUid ( ) ! = myUid ( ) ) { 
 + / / state . addMember ( gm . getUid ( ) , MasterCallMemberState . RINGING ) ; 
 + } 
 + } 
 + } else if ( peer . getPeerType ( ) = = PeerType . PRIVATE ) { 
 + / / state . addMember ( peer . getPeerId ( ) , MasterCallMemberState . RINGING ) ; 
 + } else { 
 + throw new RuntimeException ( " Unsupported Peer Type group " ) ; 
 + } 
 + 
 + / / 
 + / / Initialization of CallVM 
 + / / 
 + callId = responseDoCall . getCallId ( ) ; 
 + callVM = callViewModels . spawnNewOutgoingVM ( responseDoCall . getCallId ( ) , peer ) ; 
 + / / callVM . getIsMuted ( ) . change ( isMuted ( ) ) ; 
 + 
 + / / 
 + / / Notifying about successful call creation 
 + / / 
 + callManager . send ( new CallManagerActor . DoCallComplete ( responseDoCall . getCallId ( ) ) , self ( ) ) ; 
 + callback . onResult ( responseDoCall . getCallId ( ) ) ; 
 + callback = null ; 
 + } 
 + } ) . failure ( new Consumer < Exception > ( ) { 
 + @ Override 
 + public void apply ( Exception e ) { 
 + callback . onError ( e ) ; 
 + callback = null ; 
 + dispose ( ) ; 
 + } 
 + } ) . done ( self ( ) ) ; 
 + } 
 + 
 + @ Override 
 + public void onAnswered ( int uid , long deviceId ) { 
 + Log . d ( " CallMasterActor " , " On Answered : " + uid + " , device : " + deviceId ) ; 
 + peerCall . onTheirStarted ( deviceId ) ; 
 + } 
 + 
 + @ Override 
 + public void onPeerConnected ( int uid , long deviceId ) { 
 + Log . d ( " CallMasterActor " , " On Peer Connected : " + uid + " , device : " + deviceId ) ; 
 + peerCall . onOfferNeeded ( deviceId ) ; 
 + } 
 + 
 + @ Override 
 + public void postStop ( ) { 
 + super . postStop ( ) ; 
 + if ( callback ! = null ) { 
 + callback . onError ( new RuntimeException ( ) ) ; 
 + callback = null ; 
 + } 
 + } 
 + } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / AbsCallActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / AbsCallActor . java 
 index 7817cec . . 4eebf2f 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / AbsCallActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / AbsCallActor . java 
 @ @ - 63 , 6 + 63 , 16 @ @ public abstract class AbsCallActor extends EventBusActor implements CallBusCallb 
 
 } 
 
 + @ Override 
 + public void onPeerConnected ( int uid , long deviceId ) { 
 + 
 + } 
 + 
 + @ Override 
 + public void onAnswered ( int uid , long deviceId ) { 
 + 
 + } 
 + 
 public void onMuteChanged ( boolean isMuted ) { 
 peerCall . onMuteChanged ( isMuted ) ; 
 } 
 @ @ - 126 , 6 + 136 , 16 @ @ public abstract class AbsCallActor extends EventBusActor implements CallBusCallb 
 } 
 
 @ Override 
 + public void onPeerConnected ( final int uid , final long deviceId ) { 
 + self ( ) . send ( new Runnable ( ) { 
 + @ Override 
 + public void run ( ) { 
 + AbsCallActor . this . onPeerConnected ( uid , deviceId ) ; 
 + } 
 + } ) ; 
 + } 
 + 
 + @ Override 
 public void onPeerStateChanged ( final int uid , final long deviceId , final PeerState state ) { 
 self ( ) . send ( new Runnable ( ) { 
 @ Override 
 @ @ - 134 , 5 + 154 , 15 @ @ public abstract class AbsCallActor extends EventBusActor implements CallBusCallb 
 } 
 } ) ; 
 } 
 + 
 + @ Override 
 + public void onAnswered ( final int uid , final long deviceId ) { 
 + self ( ) . send ( new Runnable ( ) { 
 + @ Override 
 + public void run ( ) { 
 + AbsCallActor . this . onAnswered ( uid , deviceId ) ; 
 + } 
 + } ) ; 
 + } 
 } 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java 
 index 6ebd1c4 . . 89814bd 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusActor . java 
 @ @ - 10 , 6 + 10 , 7 @ @ import im . actor . core . api . ApiAnswer ; 
 import im . actor . core . api . ApiAnswerCall ; 
 import im . actor . core . api . ApiCandidate ; 
 import im . actor . core . api . ApiMembersChanged ; 
 + import im . actor . core . api . ApiNeedDisconnect ; 
 import im . actor . core . api . ApiNeedOffer ; 
 import im . actor . core . api . ApiOffer ; 
 import im . actor . core . api . ApiOnAnswer ; 
 @ @ - 37 , 6 + 38 , 7 @ @ public class CallBusActor extends EventBusActor { 
 private final PeerSettings selfSettings ; 
 private final PeerCallCallback peerCallback ; 
 private final CallBusCallback callBusCallback ; 
 + private boolean isMasterMode ; 
 private boolean isMasterReady ; 
 private int masterUid ; 
 private long masterDeviceId ; 
 @ @ - 96 , 6 + 98 , 11 @ @ public class CallBusActor extends EventBusActor { 
 callBusCallback . onBusCreated ( peerCall ) ; 
 } 
 
 + public void createMasterBus ( ) { 
 + isMasterMode = true ; 
 + createBus ( ) ; 
 + } 
 + 
 @ Override 
 public void onBusStarted ( ) { 
 super . onBusStarted ( ) ; 
 @ @ - 111 , 6 + 118 , 20 @ @ public class CallBusActor extends EventBusActor { 
 } 
 
 @ Override 
 + public void onDeviceConnected ( int uid , long deviceId ) { 
 + deviceIds . put ( deviceId , uid ) ; 
 + if ( isMasterMode ) { 
 + sendSignal ( uid , deviceId , new ApiSwitchMaster ( ) ) ; 
 + } 
 + callBusCallback . onPeerConnected ( uid , deviceId ) ; 
 + } 
 + 
 + @ Override 
 + public void onDeviceDisconnected ( int uid , long deviceId ) { 
 + peerCall . disposePeer ( deviceId ) ; 
 + } 
 + 
 + @ Override 
 public final void onMessageReceived ( @ Nullable Integer senderId , @ Nullable Long senderDeviceId , byte [ ] data ) { 
 if ( senderId = = null | | senderDeviceId = = null ) { 
 return ; 
 @ @ - 144 , 15 + 165 , 16 @ @ public class CallBusActor extends EventBusActor { 
 peerCall . onAdvertised ( needOffer . getDevice ( ) , new PeerSettings ( needOffer . getPeerSettings ( ) ) ) ; 
 peerCall . onOfferNeeded ( needOffer . getDevice ( ) ) ; 
 peerCall . onTheirStarted ( needOffer . getDevice ( ) ) ; 
 - / / if ( needOffer . isSilent ( ) ! = null & & ! needOffer . isSilent ( ) ) { 
 - / / peerCall . onTheirStarted ( needOffer . getDevice ( ) ) ; 
 - / / } 
 } else if ( signal instanceof ApiOnAnswer ) { 
 ApiOnAnswer onAnswer = ( ApiOnAnswer ) signal ; 
 deviceIds . put ( onAnswer . getDevice ( ) , onAnswer . getUid ( ) ) ; 
 peerCall . onTheirStarted ( onAnswer . getDevice ( ) ) ; 
 + } else if ( signal instanceof ApiNeedDisconnect ) { 
 + ApiNeedDisconnect disconnect = ( ApiNeedDisconnect ) signal ; 
 + deviceIds . put ( disconnect . getDevice ( ) , disconnect . getUid ( ) ) ; 
 + peerCall . disposePeer ( disconnect . getDevice ( ) ) ; 
 } else if ( signal instanceof ApiSwitchMaster ) { 
 - if ( isMasterReady ) { 
 + if ( isMasterReady | | isMasterMode ) { 
 return ; 
 } 
 isMasterReady = true ; 
 @ @ - 160 , 18 + 182 , 11 @ @ public class CallBusActor extends EventBusActor { 
 masterDeviceId = senderDeviceId ; 
 unstashAll ( STASH ) ; 
 sendSignal ( masterUid , masterDeviceId , new ApiAdvertiseSelf ( selfSettings . toApi ( ) ) ) ; 
 - } else { 
 - / / if ( callBusCallback instanceof CallBusCallbackSlave ) { 
 - / / CallBusCallbackSlave slaveCallback = ( CallBusCallbackSlave ) callBusCallback ; 
 - / / if ( signal instanceof ApiSwitchMaster ) { 
 - / / slaveCallback . onMasterSwitched ( senderId , senderDeviceId ) ; 
 - / / } else if ( signal instanceof ApiMembersChanged ) { 
 - / / ApiMembersChanged membersChanged = ( ApiMembersChanged ) signal ; 
 - / / slaveCallback . onMembersChanged ( membersChanged . getAllMembers ( ) ) ; 
 - / / } 
 - / / } else { 
 - / / / / Nothing ? 
 - / / } 
 + } else if ( signal instanceof ApiAdvertiseSelf ) { 
 + ApiAdvertiseSelf advertiseSelf = ( ApiAdvertiseSelf ) signal ; 
 + peerCall . onAdvertised ( senderDeviceId , new PeerSettings ( advertiseSelf . getPeerSettings ( ) ) ) ; 
 + } else if ( signal instanceof ApiAnswerCall ) { 
 + callBusCallback . onAnswered ( senderId , senderDeviceId ) ; 
 } 
 } 
 
 @ @ - 193 , 17 + 208 , 23 @ @ public class CallBusActor extends EventBusActor { 
 if ( message instanceof JoinBus ) { 
 joinBus ( ( ( JoinBus ) message ) . getBusId ( ) ) ; 
 } else if ( message instanceof CreateBus ) { 
 - createBus ( ) ; 
 + createMasterBus ( ) ; 
 } else if ( message instanceof SendSignal ) { 
 SendSignal signal = ( SendSignal ) message ; 
 sendSignal ( signal . getUid ( ) , signal . getDeviceId ( ) , signal . getSignal ( ) ) ; 
 } else if ( message instanceof AnswerCall ) { 
 + if ( isMasterMode ) { 
 + return ; 
 + } 
 if ( ! isMasterReady ) { 
 stash ( STASH ) ; 
 return ; 
 } 
 onAnswerCall ( ) ; 
 } else if ( message instanceof RejectCall ) { 
 + if ( isMasterMode ) { 
 + return ; 
 + } 
 if ( ! isMasterReady ) { 
 stash ( STASH ) ; 
 return ; 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java 
 index 8d21384 . . 7dc807a 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusCallback . java 
 @ @ - 14 , 5 + 14 , 9 @ @ public interface CallBusCallback { 
 
 void onMembersChanged ( List < ApiCallMember > members ) ; 
 
 + void onPeerConnected ( int uid , long deviceId ) ; 
 + 
 void onPeerStateChanged ( int uid , long deviceId , PeerState state ) ; 
 + 
 + void onAnswered ( int uid , long deviceId ) ; 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusInt . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusInt . java 
 index 71314b3 . . 3ca058b 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusInt . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / peers / CallBusInt . java 
 @ @ - 10 , 11 + 10 , 11 @ @ public class CallBusInt extends ActorInterface { 
 super ( dest ) ; 
 } 
 
 - public void joinBus ( String busId ) { 
 + public void startSlaveBus ( String busId ) { 
 send ( new CallBusActor . JoinBus ( busId ) ) ; 
 } 
 
 - public void createBus ( ) { 
 + public void startMaster ( ) { 
 send ( new CallBusActor . CreateBus ( ) ) ; 
 }
