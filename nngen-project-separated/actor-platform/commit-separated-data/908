BLEU SCORE: 0.12067008283523631

TEST MSG: feat ( core ) : Delivering event bus messages
GENERATED MSG: feat ( iOS ) : Basic implementation of Call Controller

TEST DIFF (one line): diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / Providers / iOSWebRTCProvider . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / Providers / iOSWebRTCProvider . swift < nl > index 7b32ab5 . . 23cf0f5 100644 < nl > - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / Providers / iOSWebRTCProvider . swift < nl > + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / Providers / iOSWebRTCProvider . swift < nl > @ @ - 4 , 178 + 4 , 190 @ @ < nl > < nl > import Foundation < nl > < nl > - class iOSWebRTCProvider : NSObject , ACWebRTCProvider { < nl > - < nl > - private var controller : ACWebRTCController ! < nl > - private var messenger : ACMessenger ! < nl > - < nl > - private lazy var queue : dispatch _ queue _ t = dispatch _ queue _ create ( " webrtc _ queue " , DISPATCH _ QUEUE _ SERIAL ) < nl > - private let peerConnectionFactory = RTCPeerConnectionFactory ( ) < nl > - private let mediaConstraints = RTCMediaConstraints ( ) < nl > - < nl > - private var runningCallId : jlong ? < nl > - private var peerConnection : RTCPeerConnection ! < nl > - private var voiceCapture : RTCAudioTrack ! < nl > - < nl > - override init ( ) { < nl > - RTCPeerConnectionFactory . initializeSSL ( ) < nl > - } < nl > - < nl > - func initWithMessenger ( messenger : ACMessenger , withController controller : ACWebRTCController ) { < nl > - self . controller = controller < nl > - self . messenger = messenger < nl > - } < nl > - < nl > - / / < nl > - / / Start / End of calls < nl > - / / < nl > + class iOSWebRTCProvider : NSObject , ACCallsProvider { < nl > < nl > func onIncomingCallWithCallId ( callId : jlong ) { < nl > - dispatchSync ( ) { < nl > - print ( " onIncomingCallWithCallId " ) < nl > - self . runningCallId = callId < nl > - dispatchOnUi ( ) { ( ) - > Void in < nl > - let rootController = ActorSDK . sharedActor ( ) . bindedToWindow . rootViewController ! < nl > - rootController . presentViewController ( AACallViewController ( callId : callId ) , animated : true , completion : nil ) < nl > - } < nl > - } < nl > + < nl > } < nl > < nl > func onOutgoingCallWithCallId ( callId : jlong ) { < nl > - dispatchSync ( ) { < nl > - print ( " onOutgoingCallWithCallId " ) < nl > - self . runningCallId = callId < nl > - } < nl > - } < nl > - < nl > - func onCallEndWithCallId ( callId : jlong ) { < nl > - dispatchSync ( ) { < nl > - if ( self . peerConnection ! = nil ) { < nl > - self . peerConnection . close ( ) < nl > - self . peerConnection = nil < nl > - } < nl > - self . voiceCapture = nil < nl > - self . runningCallId = - 1 < nl > - } < nl > - } < nl > - < nl > - / / < nl > - / / In process < nl > - / / < nl > - < nl > - private func createPeerConnection ( callId : jlong ) { < nl > - / / < nl > - / / Create Peer Connection < nl > - / / < nl > - let iceServers = [ < nl > - RTCICEServer ( URI : NSURL ( string : " stun : 62 . 4 . 22 . 219 : 3478 " ) , username : " " , password : " " ) , < nl > - RTCICEServer ( URI : NSURL ( string : " turn : 62 . 4 . 22 . 219 : 3478 ? transport = tcp " ) , username : " actor " , password : " password " ) , < nl > - RTCICEServer ( URI : NSURL ( string : " turn : 62 . 4 . 22 . 219 : 3478 ? transport = udp " ) , username : " actor " , password : " password " ) < nl > - ] < nl > - peerConnection = peerConnectionFactory . peerConnectionWithICEServers ( iceServers , constraints : mediaConstraints , delegate : nil ) < nl > < nl > - / / < nl > - / / Crete Media Stream < nl > - / / < nl > - voiceCapture = peerConnectionFactory . audioTrackWithID ( " audio0 " ) < nl > - let mediaStream = peerConnectionFactory . mediaStreamWithLabel ( " ARDAMSa0 " ) < nl > - mediaStream . addAudioTrack ( voiceCapture ) < nl > - peerConnection . addStream ( mediaStream ) < nl > - < nl > - / / < nl > - / / Handling events from peer connection < nl > - / / < nl > - peerConnection . onCandidateReceived = { ( candidate ) in < nl > - self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > - print ( " On Candidate arrived " ) < nl > - self . controller . sendCandidateWithInt ( jint ( candidate . sdpMLineIndex ) , withNSString : candidate . sdpMid , withNSString : candidate . sdp ) < nl > - } < nl > - } < nl > - peerConnection . onStreamAdded = { ( stream ) in < nl > - self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > - print ( " On stream added " ) < nl > - } < nl > - } < nl > - } < nl > - < nl > - func onOfferNeededWithCallId ( callId : jlong ) { < nl > - self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > - print ( " onOfferNeededWithCallId " ) < nl > - } < nl > - } < nl > - < nl > - func onAnswerReceivedWithCallId ( callId : jlong , withSDP offerSDP : String ) { < nl > - self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > - print ( " onAnswerReceivedWithCallId " ) < nl > - } < nl > } < nl > < nl > - func onOfferReceivedWithCallId ( callId : jlong , withSDP offerSDP : String ) { < nl > - < nl > - / / < nl > - / / Stages : < nl > - / / 1 . Create Peer Connection < nl > - / / 2 . Set Remote description < nl > - / / 3 . Create Answer < nl > - / / 4 . Set Local description from answer < nl > - / / 5 . Send Answer and enable candidate receiving < nl > - / / < nl > + func onCallEndWithCallId ( callId : jlong ) { < nl > < nl > - self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > - self . createPeerConnection ( callId ) < nl > - self . peerConnection . setRemoteDescription ( RTCSessionDescription ( type : " offer " , sdp : offerSDP ) ) { ( error ) - > ( ) in < nl > - self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > - if ( error = = nil ) { < nl > - self . peerConnection . createAnswer ( self . mediaConstraints ) { ( sdp , error ) - > ( ) in < nl > - self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > - if ( error = = nil ) { < nl > - self . peerConnection . setLocalDescription ( sdp ) { ( error ) - > ( ) in < nl > - self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > - if ( error = = nil ) { < nl > - self . controller . sendAnswerWithNSString ( sdp . description ) < nl > - self . controller . readyForCandidates ( ) < nl > - } else { < nl > - self . controller . endCall ( ) < nl > - } < nl > - } < nl > - } < nl > - } else { < nl > - self . controller . endCall ( ) < nl > - } < nl > - } < nl > - } < nl > - } else { < nl > - self . controller . endCall ( ) < nl > - } < nl > - } < nl > - } < nl > - } < nl > } < nl > < nl > - func onCandidateWithCallId ( callId : jlong , withId id _ : String , withLabel label : jint , withSDP sdp : String ) { < nl > - dispatchAsync ( callId ) { ( ) - > ( ) in < nl > - self . peerConnection . addICECandidate ( RTCICECandidate ( mid : id _ , index : Int ( label ) , sdp : sdp ) ) < nl > - } < nl > - } < nl > - < nl > - < nl > - / / < nl > - / / Dispatching < nl > - / / < nl > - < nl > - private func dispatchSync ( closure : ( ) - > ( ) ) { < nl > - dispatch _ sync ( queue ) { ( ) - > Void in < nl > - closure ( ) < nl > - } < nl > - } < nl > - < nl > - private func dispatchAsync ( callId : jlong , closure : ( ) - > ( ) ) { < nl > - if ( self . runningCallId = = callId ) { < nl > - dispatch _ async ( queue ) { ( ) - > Void in < nl > - if ( self . runningCallId = = callId ) { < nl > - closure ( ) < nl > - } < nl > - } < nl > - } < nl > - } < nl > + / / private var controller : ACWebRTCController ! < nl > + / / private var messenger : ACMessenger ! < nl > + / / < nl > + / / private lazy var queue : dispatch _ queue _ t = dispatch _ queue _ create ( " webrtc _ queue " , DISPATCH _ QUEUE _ SERIAL ) < nl > + / / private let peerConnectionFactory = RTCPeerConnectionFactory ( ) < nl > + / / private let mediaConstraints = RTCMediaConstraints ( ) < nl > + / / < nl > + / / private var runningCallId : jlong ? < nl > + / / private var peerConnection : RTCPeerConnection ! < nl > + / / private var voiceCapture : RTCAudioTrack ! < nl > + / / < nl > + / / override init ( ) { < nl > + / / RTCPeerConnectionFactory . initializeSSL ( ) < nl > + / / } < nl > + / / < nl > + / / func initWithMessenger ( messenger : ACMessenger , withController controller : ACWebRTCController ) { < nl > + / / self . controller = controller < nl > + / / self . messenger = messenger < nl > + / / } < nl > + / / < nl > + / / / / < nl > + / / / / Start / End of calls < nl > + / / / / < nl > + / / < nl > + / / func onIncomingCallWithCallId ( callId : jlong ) { < nl > + / / dispatchSync ( ) { < nl > + / / print ( " onIncomingCallWithCallId " ) < nl > + / / self . runningCallId = callId < nl > + / / dispatchOnUi ( ) { ( ) - > Void in < nl > + / / let rootController = ActorSDK . sharedActor ( ) . bindedToWindow . rootViewController ! < nl > + / / rootController . presentViewController ( AACallViewController ( callId : callId ) , animated : true , completion : nil ) < nl > + / / } < nl > + / / } < nl > + / / } < nl > + / / < nl > + / / func onOutgoingCallWithCallId ( callId : jlong ) { < nl > + / / dispatchSync ( ) { < nl > + / / print ( " onOutgoingCallWithCallId " ) < nl > + / / self . runningCallId = callId < nl > + / / } < nl > + / / } < nl > + / / < nl > + / / func onCallEndWithCallId ( callId : jlong ) { < nl > + / / dispatchSync ( ) { < nl > + / / if ( self . peerConnection ! = nil ) { < nl > + / / self . peerConnection . close ( ) < nl > + / / self . peerConnection = nil < nl > + / / } < nl > + / / self . voiceCapture = nil < nl > + / / self . runningCallId = - 1 < nl > + / / } < nl > + / / } < nl > + / / < nl > + / / / / < nl > + / / / / In process < nl > + / / / / < nl > + / / < nl > + / / private func createPeerConnection ( callId : jlong ) { < nl > + / / / / < nl > + / / / / Create Peer Connection < nl > + / / / / < nl > + / / let iceServers = [ < nl > + / / RTCICEServer ( URI : NSURL ( string : " stun : 62 . 4 . 22 . 219 : 3478 " ) , username : " " , password : " " ) , < nl > + / / RTCICEServer ( URI : NSURL ( string : " turn : 62 . 4 . 22 . 219 : 3478 ? transport = tcp " ) , username : " actor " , password : " password " ) , < nl > + / / RTCICEServer ( URI : NSURL ( string : " turn : 62 . 4 . 22 . 219 : 3478 ? transport = udp " ) , username : " actor " , password : " password " ) < nl > + / / ] < nl > + / / peerConnection = peerConnectionFactory . peerConnectionWithICEServers ( iceServers , constraints : mediaConstraints , delegate : nil ) < nl > + / / < nl > + / / / / < nl > + / / / / Crete Media Stream < nl > + / / / / < nl > + / / voiceCapture = peerConnectionFactory . audioTrackWithID ( " audio0 " ) < nl > + / / let mediaStream = peerConnectionFactory . mediaStreamWithLabel ( " ARDAMSa0 " ) < nl > + / / mediaStream . addAudioTrack ( voiceCapture ) < nl > + / / peerConnection . addStream ( mediaStream ) < nl > + / / < nl > + / / / / < nl > + / / / / Handling events from peer connection < nl > + / / / / < nl > + / / peerConnection . onCandidateReceived = { ( candidate ) in < nl > + / / self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > + / / print ( " On Candidate arrived " ) < nl > + / / self . controller . sendCandidateWithInt ( jint ( candidate . sdpMLineIndex ) , withNSString : candidate . sdpMid , withNSString : candidate . sdp ) < nl > + / / } < nl > + / / } < nl > + / / peerConnection . onStreamAdded = { ( stream ) in < nl > + / / self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > + / / print ( " On stream added " ) < nl > + / / } < nl > + / / } < nl > + / / } < nl > + / / < nl > + / / func onOfferNeededWithCallId ( callId : jlong ) { < nl > + / / self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > + / / print ( " onOfferNeededWithCallId " ) < nl > + / / } < nl > + / / } < nl > + / / < nl > + / / func onAnswerReceivedWithCallId ( callId : jlong , withSDP offerSDP : String ) { < nl > + / / self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > + / / print ( " onAnswerReceivedWithCallId " ) < nl > + / / } < nl > + / / } < nl > + / / < nl > + / / func onOfferReceivedWithCallId ( callId : jlong , withSDP offerSDP : String ) { < nl > + / / < nl > + / / / / < nl > + / / / / Stages : < nl > + / / / / 1 . Create Peer Connection < nl > + / / / / 2 . Set Remote description < nl > + / / / / 3 . Create Answer < nl > + / / / / 4 . Set Local description from answer < nl > + / / / / 5 . Send Answer and enable candidate receiving < nl > + / / / / < nl > + / / < nl > + / / self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > + / / self . createPeerConnection ( callId ) < nl > + / / self . peerConnection . setRemoteDescription ( RTCSessionDescription ( type : " offer " , sdp : offerSDP ) ) { ( error ) - > ( ) in < nl > + / / self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > + / / if ( error = = nil ) { < nl > + / / self . peerConnection . createAnswer ( self . mediaConstraints ) { ( sdp , error ) - > ( ) in < nl > + / / self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > + / / if ( error = = nil ) { < nl > + / / self . peerConnection . setLocalDescription ( sdp ) { ( error ) - > ( ) in < nl > + / / self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > + / / if ( error = = nil ) { < nl > + / / self . controller . sendAnswerWithNSString ( sdp . description ) < nl > + / / self . controller . readyForCandidates ( ) < nl > + / / } else { < nl > + / / self . controller . endCall ( ) < nl > + / / } < nl > + / / } < nl > + / / } < nl > + / / } else { < nl > + / / self . controller . endCall ( ) < nl > + / / } < nl > + / / } < nl > + / / } < nl > + / / } else { < nl > + / / self . controller . endCall ( ) < nl > + / / } < nl > + / / } < nl > + / / } < nl > + / / } < nl > + / / } < nl > + / / < nl > + / / func onCandidateWithCallId ( callId : jlong , withId id _ : String , withLabel label : jint , withSDP sdp : String ) { < nl > + / / dispatchAsync ( callId ) { ( ) - > ( ) in < nl > + / / self . peerConnection . addICECandidate ( RTCICECandidate ( mid : id _ , index : Int ( label ) , sdp : sdp ) ) < nl > + / / } < nl > + / / } < nl > + / / < nl > + / / < nl > + / / / / < nl > + / / / / Dispatching < nl > + / / / / < nl > + / / < nl > + / / private func dispatchSync ( closure : ( ) - > ( ) ) { < nl > + / / dispatch _ sync ( queue ) { ( ) - > Void in < nl > + / / closure ( ) < nl > + / / } < nl > + / / } < nl > + / / < nl > + / / private func dispatchAsync ( callId : jlong , closure : ( ) - > ( ) ) { < nl > + / / if ( self . runningCallId = = callId ) { < nl > + / / dispatch _ async ( queue ) { ( ) - > Void in < nl > + / / if ( self . runningCallId = = callId ) { < nl > + / / closure ( ) < nl > + / / } < nl > + / / } < nl > + / / } < nl > + / / } < nl > } < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift < nl > index 817ac61 . . ce2338b 100644 < nl > - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift < nl > + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift < nl > @ @ - 162 , 7 + 162 , 7 @ @ public class ActorSDK { < nl > builder . setPhoneBookProvider ( PhoneBookProvider ( ) ) < nl > builder . setNotificationProvider ( iOSNotificationProvider ( ) ) < nl > if ( enableExperimentalFeatures ) { < nl > - builder . setWebRTCProvider ( iOSWebRTCProvider ( ) ) < nl > + builder . setCallsProvider ( iOSWebRTCProvider ( ) ) < nl > } < nl > < nl > / / Stats < nl > diff - - git a / actor - sdk / sdk - core / core / core - cocoa / prefixes . properties b / actor - sdk / sdk - core / core / core - cocoa / prefixes . properties < nl > index 22426d2 . . f4ee260 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - cocoa / prefixes . properties < nl > + + + b / actor - sdk / sdk - core / core / core - cocoa / prefixes . properties < nl > @ @ - 38 , 9 + 38 , 7 @ @ im . actor . core . modules . internal . state : AC < nl > im . actor . core . modules . internal . typing : AC < nl > im . actor . core . modules . internal . users : AC < nl > < nl > - im . actor . core . webrtc : AC < nl > - im . actor . core . notifications : AC < nl > - im . actor . core . phonebook : AC < nl > + im . actor . core . providers : AC < nl > < nl > im . actor . core . i18n : AC < nl > < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java < nl > index feeca5f . . b5fa71f 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java < nl > @ @ - 34 , 7 + 34 , 7 @ @ public class CallManagerActor extends ModuleActor { < nl > < nl > private HashSet < Long > pendingRequests = new HashSet < > ( ) ; < nl > < nl > - private WebRTCControllerImpl webRTCController ; < nl > + / / private WebRTCControllerImpl webRTCController ; < nl > private CallsProvider provider ; < nl > private boolean isStartedKeepAlive = false ; < nl > < nl > @ @ - 52 , 9 + 52 , 9 @ @ public class CallManagerActor extends ModuleActor { < nl > public void preStart ( ) { < nl > super . preStart ( ) ; < nl > < nl > - webRTCController = new WebRTCControllerImpl ( self ( ) ) ; < nl > + / / webRTCController = new WebRTCControllerImpl ( self ( ) ) ; < nl > provider = config ( ) . getCallsProvider ( ) ; < nl > - provider . init ( context ( ) . getMessenger ( ) , webRTCController ) ; < nl > + / / provider . init ( context ( ) . getMessenger ( ) , webRTCController ) ; < nl > } < nl > < nl > < nl > @ @ - 74 , 22 + 74 , 22 @ @ public class CallManagerActor extends ModuleActor { < nl > private void onIncomingCall ( long callId ) { < nl > Log . d ( TAG , " onIncomingCall ( " + callId + " ) " ) ; < nl > < nl > - if ( webRTCController . getCallId ( ) = = - 1 ) { < nl > - webRTCController . switchCallId ( callId ) ; < nl > - pendingRequests . clear ( ) ; < nl > - pendingCandidates . clear ( ) ; < nl > - isReadyReceiveCandidates = false ; < nl > - isStartedKeepAlive = false ; < nl > - isOfferRequested = true ; / / No outgoing offer needed for ingoing call < nl > - isOfferReceived = false ; < nl > - isAnswerReceived = true ; / / No incoming answers needed for ingoing call < nl > - < nl > - / / ArrayList < Integer > members = new ArrayList < > ( ) ; < nl > - / / members . add ( myUid ( ) ) ; < nl > - / / members . add ( uid ) ; < nl > - / / context ( ) . getCallsModule ( ) . spawnNewModel ( callId , Peer . user ( uid ) , members , CallState . CALLING _ INCOMING ) ; < nl > - / / provider . onIncomingCall ( callId ) ; < nl > - } < nl > + / / if ( webRTCController . getCallId ( ) = = - 1 ) { < nl > + / / webRTCController . switchCallId ( callId ) ; < nl > + / / pendingRequests . clear ( ) ; < nl > + / / pendingCandidates . clear ( ) ; < nl > + / / isReadyReceiveCandidates = false ; < nl > + / / isStartedKeepAlive = false ; < nl > + / / isOfferRequested = true ; / / No outgoing offer needed for ingoing call < nl > + / / isOfferReceived = false ; < nl > + / / isAnswerReceived = true ; / / No incoming answers needed for ingoing call < nl > + / / < nl > + / / / / ArrayList < Integer > members = new ArrayList < > ( ) ; < nl > + / / / / members . add ( myUid ( ) ) ; < nl > + / / / / members . add ( uid ) ; < nl > + / / / / context ( ) . getCallsModule ( ) . spawnNewModel ( callId , Peer . user ( uid ) , members , CallState . CALLING _ INCOMING ) ; < nl > + / / / / provider . onIncomingCall ( callId ) ; < nl > + / / } < nl > } < nl > < nl > private void onIncomingCallHandled ( long callId ) { < nl > @ @ - 99 , 21 + 99 , 21 @ @ public class CallManagerActor extends ModuleActor { < nl > private void onOutgoingCall ( long callId , int uid ) { < nl > Log . d ( TAG , " onOutgoingCall ( " + callId + " , " + uid + " ) " ) ; < nl > < nl > - if ( webRTCController . getCallId ( ) = = - 1 ) { < nl > - webRTCController . switchCallId ( callId ) ; < nl > - pendingRequests . clear ( ) ; < nl > - pendingCandidates . clear ( ) ; < nl > - isReadyReceiveCandidates = false ; < nl > - isStartedKeepAlive = false ; < nl > - isOfferRequested = false ; < nl > - isOfferReceived = true ; / / No offers needed for outgoing call < nl > - isAnswerReceived = false ; < nl > - ArrayList < Integer > members = new ArrayList < > ( ) ; < nl > - members . add ( myUid ( ) ) ; < nl > - members . add ( uid ) ; < nl > - context ( ) . getCallsModule ( ) . spawnNewModel ( callId , Peer . user ( uid ) , members , CallState . CALLING _ OUTGOING ) ; < nl > - provider . onOutgoingCall ( callId ) ; < nl > - } < nl > + / / if ( webRTCController . getCallId ( ) = = - 1 ) { < nl > + / / webRTCController . switchCallId ( callId ) ; < nl > + / / pendingRequests . clear ( ) ; < nl > + / / pendingCandidates . clear ( ) ; < nl > + / / isReadyReceiveCandidates = false ; < nl > + / / isStartedKeepAlive = false ; < nl > + / / isOfferRequested = false ; < nl > + / / isOfferReceived = true ; / / No offers needed for outgoing call < nl > + / / isAnswerReceived = false ; < nl > + / / ArrayList < Integer > members = new ArrayList < > ( ) ; < nl > + / / members . add ( myUid ( ) ) ; < nl > + / / members . add ( uid ) ; < nl > + / / context ( ) . getCallsModule ( ) . spawnNewModel ( callId , Peer . user ( uid ) , members , CallState . CALLING _ OUTGOING ) ; < nl > + / / provider . onOutgoingCall ( callId ) ; < nl > + / / } < nl > } < nl > < nl > private void doAnswerCall ( final long callId ) { < nl > @ @ - 136 , 12 + 136 , 12 @ @ public class CallManagerActor extends ModuleActor { < nl > } < nl > < nl > private void doStartKeepAlive ( long callId ) { < nl > - if ( webRTCController . getCallId ( ) = = callId ) { < nl > - if ( ! isStartedKeepAlive ) { < nl > - isStartedKeepAlive = true ; < nl > - self ( ) . send ( new DoKeepAlive ( callId ) ) ; < nl > - } < nl > - } < nl > + / / if ( webRTCController . getCallId ( ) = = callId ) { < nl > + / / if ( ! isStartedKeepAlive ) { < nl > + / / isStartedKeepAlive = true ; < nl > + / / self ( ) . send ( new DoKeepAlive ( callId ) ) ; < nl > + / / } < nl > + / / } < nl > } < nl > < nl > < nl > @ @ - 150 , 51 + 150 , 51 @ @ public class CallManagerActor extends ModuleActor { < nl > / / < nl > < nl > private void onReadyReceiveCandidates ( long callId ) { < nl > - Log . d ( TAG , " onReadyReceiveCandidates ( " + callId + " ) " ) ; < nl > - if ( webRTCController . getCallId ( ) = = callId ) { < nl > - if ( ! isReadyReceiveCandidates ) { < nl > - isReadyReceiveCandidates = true ; < nl > - for ( Candidate c : pendingCandidates ) { < nl > - provider . onCandidate ( callId , c . getId ( ) , c . getLabel ( ) , c . getSdp ( ) ) ; < nl > - } < nl > - pendingCandidates . clear ( ) ; < nl > - } < nl > - } < nl > + / / Log . d ( TAG , " onReadyReceiveCandidates ( " + callId + " ) " ) ; < nl > + / / if ( webRTCController . getCallId ( ) = = callId ) { < nl > + / / if ( ! isReadyReceiveCandidates ) { < nl > + / / isReadyReceiveCandidates = true ; < nl > + / / for ( Candidate c : pendingCandidates ) { < nl > + / / provider . onCandidate ( callId , c . getId ( ) , c . getLabel ( ) , c . getSdp ( ) ) ; < nl > + / / } < nl > + / / pendingCandidates . clear ( ) ; < nl > + / / } < nl > + / / } < nl > } < nl > < nl > private void onSignaling ( long callId , byte [ ] message ) { < nl > - Log . d ( TAG , " onSignaling ( " + callId + " ) " ) ; < nl > - if ( webRTCController . getCallId ( ) = = callId ) { < nl > - AbsSignal signal = AbsSignal . fromBytes ( message ) ; < nl > - if ( signal = = null ) { < nl > - return ; < nl > - } < nl > - < nl > - if ( signal instanceof OfferSignal ) { < nl > - OfferSignal offer = ( OfferSignal ) signal ; < nl > - if ( ! isOfferReceived ) { < nl > - isOfferReceived = true ; < nl > - context ( ) . getCallsModule ( ) . getCall ( callId ) . getCallStarted ( ) . change ( im . actor . runtime . Runtime . getCurrentTime ( ) ) ; < nl > - context ( ) . getCallsModule ( ) . getCall ( callId ) . getState ( ) . change ( CallState . IN _ PROGRESS ) ; < nl > - provider . onOfferReceived ( callId , offer . getSdp ( ) ) ; < nl > - } < nl > - } else if ( signal instanceof AnswerSignal ) { < nl > - AnswerSignal answer = ( AnswerSignal ) signal ; < nl > - if ( ! isAnswerReceived ) { < nl > - isAnswerReceived = true ; < nl > - provider . onAnswerReceived ( callId , answer . getSdp ( ) ) ; < nl > - } < nl > - } else if ( signal instanceof CandidateSignal ) { < nl > - CandidateSignal candidateSignal = ( CandidateSignal ) signal ; < nl > - if ( ! isReadyReceiveCandidates ) { < nl > - pendingCandidates . add ( new Candidate ( candidateSignal . getLabel ( ) , < nl > - candidateSignal . getId ( ) , candidateSignal . getSdp ( ) ) ) ; < nl > - } else { < nl > - provider . onCandidate ( callId , candidateSignal . getId ( ) , < nl > - candidateSignal . getLabel ( ) , candidateSignal . getSdp ( ) ) ; < nl > - } < nl > - } < nl > - } < nl > + / / Log . d ( TAG , " onSignaling ( " + callId + " ) " ) ; < nl > + / / if ( webRTCController . getCallId ( ) = = callId ) { < nl > + / / AbsSignal signal = AbsSignal . fromBytes ( message ) ; < nl > + / / if ( signal = = null ) { < nl > + / / return ; < nl > + / / } < nl > + / / < nl > + / / if ( signal instanceof OfferSignal ) { < nl > + / / OfferSignal offer = ( OfferSignal ) signal ; < nl > + / / if ( ! isOfferReceived ) { < nl > + / / isOfferReceived = true ; < nl > + / / context ( ) . getCallsModule ( ) . getCall ( callId ) . getCallStarted ( ) . change ( im . actor . runtime . Runtime . getCurrentTime ( ) ) ; < nl > + / / context ( ) . getCallsModule ( ) . getCall ( callId ) . getState ( ) . change ( CallState . IN _ PROGRESS ) ; < nl > + / / provider . onOfferReceived ( callId , offer . getSdp ( ) ) ; < nl > + / / } < nl > + / / } else if ( signal instanceof AnswerSignal ) { < nl > + / / AnswerSignal answer = ( AnswerSignal ) signal ; < nl > + / / if ( ! isAnswerReceived ) { < nl > + / / isAnswerReceived = true ; < nl > + / / provider . onAnswerReceived ( callId , answer . getSdp ( ) ) ; < nl > + / / } < nl > + / / } else if ( signal instanceof CandidateSignal ) { < nl > + / / CandidateSignal candidateSignal = ( CandidateSignal ) signal ; < nl > + / / if ( ! isReadyReceiveCandidates ) { < nl > + / / pendingCandidates . add ( new Candidate ( candidateSignal . getLabel ( ) , < nl > + / / candidateSignal . getId ( ) , candidateSignal . getSdp ( ) ) ) ; < nl > + / / } else { < nl > + / / provider . onCandidate ( callId , candidateSignal . getId ( ) , < nl > + / / candidateSignal . getLabel ( ) , candidateSignal . getSdp ( ) ) ; < nl > + / / } < nl > + / / } < nl > + / / } < nl > } < nl > < nl > private void doSendSignal ( long callId , AbsSignal signal ) { < nl > @ @ - 213 , 17 + 213 , 17 @ @ public class CallManagerActor extends ModuleActor { < nl > } < nl > < nl > private void onKeepAlive ( long callId , int timeout ) { < nl > - if ( webRTCController . getCallId ( ) = = callId ) { < nl > - if ( ! isOfferRequested ) { < nl > - isOfferRequested = true ; < nl > - context ( ) . getCallsModule ( ) . getCall ( callId ) . getCallStarted ( ) . change ( im . actor . runtime . Runtime . getCurrentTime ( ) ) ; < nl > - context ( ) . getCallsModule ( ) . getCall ( callId ) . getState ( ) . change ( CallState . IN _ PROGRESS ) ; < nl > - provider . onOfferNeeded ( callId ) ; < nl > - } < nl > - < nl > - < nl > - / / TODO : Auto kill call on timeout < nl > - } < nl > + / / if ( webRTCController . getCallId ( ) = = callId ) { < nl > + / / if ( ! isOfferRequested ) { < nl > + / / isOfferRequested = true ; < nl > + / / context ( ) . getCallsModule ( ) . getCall ( callId ) . getCallStarted ( ) . change ( im . actor . runtime . Runtime . getCurrentTime ( ) ) ; < nl > + / / context ( ) . getCallsModule ( ) . getCall ( callId ) . getState ( ) . change ( CallState . IN _ PROGRESS ) ; < nl > + / / provider . onOfferNeeded ( callId ) ; < nl > + / / } < nl > + / / < nl > + / / < nl > + / / / / TODO : Auto kill call on timeout < nl > + / / } < nl > } < nl > < nl > / / < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / WebRTCControllerImpl . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / WebRTCControllerImpl . java < nl > deleted file mode 100644 < nl > index 7412942 . . 0000000 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / WebRTCControllerImpl . java < nl > + + + / dev / null < nl > @ @ - 1 , 71 + 0 , 0 @ @ < nl > - package im . actor . core . modules . calls ; < nl > - < nl > - import im . actor . core . entity . signals . AnswerSignal ; < nl > - import im . actor . core . entity . signals . CandidateSignal ; < nl > - import im . actor . core . entity . signals . OfferSignal ; < nl > - import im . actor . core . webrtc . WebRTCController ; < nl > - import im . actor . runtime . actors . ActorRef ; < nl > - < nl > - public class WebRTCControllerImpl implements WebRTCController { < nl > - < nl > - private long callId = - 1 ; < nl > - private ActorRef ref ; < nl > - < nl > - public WebRTCControllerImpl ( ActorRef ref ) { < nl > - this . ref = ref ; < nl > - } < nl > - < nl > - public long getCallId ( ) { < nl > - return callId ; < nl > - } < nl > - < nl > - public void switchCallId ( long callId ) { < nl > - this . callId = callId ; < nl > - } < nl > - < nl > - public void clearCallId ( ) { < nl > - this . callId = - 1 ; < nl > - } < nl > - < nl > - @ Override < nl > - public void answerCall ( ) { < nl > - if ( callId ! = - 1 ) { < nl > - ref . send ( new CallManagerActor . AnswerCall ( callId ) ) ; < nl > - } < nl > - } < nl > - < nl > - @ Override < nl > - public void sendCandidate ( int label , String id , String sdp ) { < nl > - if ( callId ! = - 1 ) { < nl > - ref . send ( new CallManagerActor . SendSignaling ( callId , new CandidateSignal ( id , label , sdp ) ) ) ; < nl > - } < nl > - } < nl > - < nl > - @ Override < nl > - public void sendOffer ( String sdp ) { < nl > - if ( callId ! = - 1 ) { < nl > - ref . send ( new CallManagerActor . SendSignaling ( callId , new OfferSignal ( sdp ) ) ) ; < nl > - } < nl > - } < nl > - < nl > - @ Override < nl > - public void sendAnswer ( String sdp ) { < nl > - if ( callId ! = - 1 ) { < nl > - ref . send ( new CallManagerActor . SendSignaling ( callId , new AnswerSignal ( sdp ) ) ) ; < nl > - } < nl > - } < nl > - < nl > - @ Override < nl > - public void readyForCandidates ( ) { < nl > - if ( callId ! = - 1 ) { < nl > - ref . send ( new CallManagerActor . ReadyForCandidates ( callId ) ) ; < nl > - } < nl > - } < nl > - < nl > - @ Override < nl > - public void endCall ( ) { < nl > - if ( callId ! = - 1 ) { < nl > - ref . send ( new CallManagerActor . EndCall ( callId ) ) ; < nl > - } < nl > - } < nl > - } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / eventbus / EventBusActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / eventbus / EventBusActor . java < nl > index 65bf90e . . 93b769c 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / eventbus / EventBusActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / eventbus / EventBusActor . java < nl > @ @ - 17 , 7 + 17 , 7 @ @ import im . actor . runtime . function . Consumer ; < nl > < nl > public class EventBusActor extends ModuleActor { < nl > < nl > - private static final long TIMEOUT = 10000 ; < nl > + private static final long TIMEOUT = 15000 ; < nl > private static final long KEEP _ ALIVE = 5000 ; < nl > < nl > private boolean isProcessing ; < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / eventbus / EventBusModule . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / eventbus / EventBusModule . java < nl > index 45a60d0 . . 641eff4 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / eventbus / EventBusModule . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / eventbus / EventBusModule . java < nl > @ @ - 3 , 13 + 3 , 18 @ @ package im . actor . core . modules . eventbus ; < nl > import java . util . ArrayList ; < nl > import java . util . HashMap ; < nl > < nl > + import im . actor . core . api . updates . UpdateEventBusDeviceConnected ; < nl > + import im . actor . core . api . updates . UpdateEventBusDeviceDisconnected ; < nl > + import im . actor . core . api . updates . UpdateEventBusDisposed ; < nl > + import im . actor . core . api . updates . UpdateEventBusMessage ; < nl > import im . actor . core . modules . AbsModule ; < nl > import im . actor . core . modules . ModuleContext ; < nl > import im . actor . runtime . actors . ActorRef ; < nl > < nl > public class EventBusModule extends AbsModule { < nl > < nl > - private HashMap < String , ArrayList < ActorRef > > subscribers = new HashMap < > ( ) ; < nl > + private HashMap < String , ActorRef > subscribers = new HashMap < > ( ) ; < nl > + private HashMap < String , ArrayList < Object > > pendingMessages = new HashMap < > ( ) ; < nl > < nl > public EventBusModule ( ModuleContext context ) { < nl > super ( context ) ; < nl > @ @ - 20 , 19 + 25 , 72 @ @ public class EventBusModule extends AbsModule { < nl > } < nl > < nl > public synchronized void subscribe ( String busId , ActorRef ref ) { < nl > - if ( ! subscribers . containsKey ( busId ) ) { < nl > - subscribers . put ( busId , new ArrayList < ActorRef > ( ) ) ; < nl > + subscribers . put ( busId , ref ) ; < nl > + if ( pendingMessages . containsKey ( busId ) ) { < nl > + for ( Object o : pendingMessages . get ( busId ) ) { < nl > + onEventBusUpdate ( o ) ; < nl > + } < nl > + pendingMessages . remove ( busId ) ; < nl > } < nl > - subscribers . get ( busId ) . add ( ref ) ; < nl > } < nl > < nl > public synchronized void unsubscribe ( String busId , ActorRef ref ) { < nl > - if ( subscribers . containsKey ( busId ) ) { < nl > - subscribers . get ( busId ) . remove ( ref ) ; < nl > + if ( subscribers . get ( busId ) = = ref ) { < nl > + subscribers . remove ( busId ) ; < nl > } < nl > } < nl > < nl > public synchronized void onEventBusUpdate ( Object update ) { < nl > - < nl > + if ( update instanceof UpdateEventBusMessage ) { < nl > + UpdateEventBusMessage busMessage = ( UpdateEventBusMessage ) update ; < nl > + ActorRef dest = subscribers . get ( busMessage . getId ( ) ) ; < nl > + if ( dest ! = null ) { < nl > + dest . send ( new EventBusActor . EventBusMessage ( < nl > + busMessage . getSenderId ( ) , < nl > + busMessage . getSenderDeviceId ( ) , < nl > + busMessage . getMessage ( ) ) ) ; < nl > + } else { < nl > + if ( ! pendingMessages . containsKey ( busMessage . getId ( ) ) ) { < nl > + pendingMessages . put ( busMessage . getId ( ) , new ArrayList < > ( ) ) ; < nl > + } < nl > + pendingMessages . get ( busMessage . getId ( ) ) . add ( update ) ; < nl > + } < nl > + } else if ( update instanceof UpdateEventBusDeviceConnected ) { < nl > + UpdateEventBusDeviceConnected deviceConnected = ( UpdateEventBusDeviceConnected ) update ; < nl > + ActorRef dest = subscribers . get ( deviceConnected . getId ( ) ) ; < nl > + if ( dest ! = null ) { < nl > + dest . send ( new EventBusActor . EventBusDeviceConnected ( < nl > + deviceConnected . getUserId ( ) , < nl > + deviceConnected . getDeviceId ( ) ) ) ; < nl > + } else { < nl > + if ( ! pendingMessages . containsKey ( deviceConnected . getId ( ) ) ) { < nl > + pendingMessages . put ( deviceConnected . getId ( ) , new ArrayList < > ( ) ) ; < nl > + } < nl > + pendingMessages . get ( deviceConnected . getId ( ) ) . add ( update ) ; < nl > + } < nl > + } else if ( update instanceof UpdateEventBusDeviceDisconnected ) { < nl > + UpdateEventBusDeviceDisconnected deviceDisconnected = ( UpdateEventBusDeviceDisconnected ) update ; < nl > + ActorRef dest = subscribers . get ( deviceDisconnected . getId ( ) ) ; < nl > + if ( dest ! = null ) { < nl > + dest . send ( new EventBusActor . EventBusDeviceDisconnected ( deviceDisconnected . getUserId ( ) , < nl > + deviceDisconnected . getDeviceId ( ) ) ) ; < nl > + } else { < nl > + if ( ! pendingMessages . containsKey ( deviceDisconnected . getId ( ) ) ) { < nl > + pendingMessages . put ( deviceDisconnected . getId ( ) , new ArrayList < > ( ) ) ; < nl > + } < nl > + pendingMessages . get ( deviceDisconnected . getId ( ) ) . add ( update ) ; < nl > + } < nl > + } else if ( update instanceof UpdateEventBusDisposed ) { < nl > + UpdateEventBusDisposed disposed = ( UpdateEventBusDisposed ) update ; < nl > + ActorRef dest = subscribers . get ( disposed . getId ( ) ) ; < nl > + if ( dest ! = null ) { < nl > + dest . send ( new EventBusActor . EventBusDisposed ( ) ) ; < nl > + } else { < nl > + if ( ! pendingMessages . containsKey ( disposed . getId ( ) ) ) { < nl > + pendingMessages . put ( disposed . getId ( ) , new ArrayList < > ( ) ) ; < nl > + } < nl > + pendingMessages . get ( disposed . getId ( ) ) . add ( update ) ; < nl > + } < nl > + } < nl > } < nl > } < nl > diff - - git a / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / java / im / actor / runtime / WebRTCRuntimeProvider . java b / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / java / im / actor / runtime / WebRTCRuntimeProvider . java < nl > new file mode 100644 < nl > index 0000000 . . fc85a61 < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / java / im / actor / runtime / WebRTCRuntimeProvider . java < nl > @ @ - 0 , 0 + 1 , 7 @ @ < nl > + package im . actor . runtime ; < nl > + < nl > + import im . actor . runtime . cocoa . CocoaWebRTCProxyProvider ; < nl > + < nl > + public class WebRTCRuntimeProvider extends CocoaWebRTCProxyProvider { < nl > + < nl > + } < nl > diff - - git a / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / java / im / actor / runtime / cocoa / CocoaWebRTCProxyProvider . java b / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / java / im / actor / runtime / cocoa / CocoaWebRTCProxyProvider . java < nl > new file mode 100644 < nl > index 0000000 . . 6fc0a27 < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / java / im / actor / runtime / cocoa / CocoaWebRTCProxyProvider . java < nl > @ @ - 0 , 0 + 1 , 24 @ @ < nl > + package im . actor . runtime . cocoa ; < nl > + < nl > + import com . google . j2objc . annotations . ObjectiveCName ; < nl > + < nl > + import im . actor . runtime . WebRTCRuntime ; < nl > + import im . actor . runtime . webrtc . WebRTCPeerConnection ; < nl > + < nl > + public class CocoaWebRTCProxyProvider implements WebRTCRuntime { < nl > + < nl > + private static WebRTCRuntime rtcRuntime ; < nl > + < nl > + @ ObjectiveCName ( " setWebRTCRuntime : " ) < nl > + public static void setWebRTCRuntime ( WebRTCRuntime rtcRuntime ) { < nl > + CocoaWebRTCProxyProvider . rtcRuntime = rtcRuntime ; < nl > + } < nl > + < nl > + @ Override < nl > + public WebRTCPeerConnection createPeerConnection ( ) { < nl > + if ( rtcRuntime = = null ) { < nl > + throw new RuntimeException ( " Storage Runtime not set " ) ; < nl > + } < nl > + return rtcRuntime . createPeerConnection ( ) ; < nl > + } < nl > + } < nl > diff - - git a / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / prefixes . properties b / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / prefixes . properties < nl > index aab82d6 . . 079eb39 100644 < nl > - - - a / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / prefixes . properties < nl > + + + b / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / prefixes . properties < nl > @ @ - 37 , 6 + 37 , 9 @ @ im . actor . runtime . json : AR < nl > < nl > im . actor . runtime . mtproto : AR < nl > < nl > + im . actor . runtime . webrtc : AR < nl > + im . actor . runtime . webrtc . sdp : AR < nl > + < nl > im . actor . runtime . mvvm : AR < nl > < nl > im . actor . runtime . markdown : AR
NEAREST DIFF (one line): diff - - git a / actor - sdk / sdk - core - ios / ActorSDK . xcodeproj / project . pbxproj b / actor - sdk / sdk - core - ios / ActorSDK . xcodeproj / project . pbxproj < nl > index 418ff2b . . da865bb 100644 < nl > - - - a / actor - sdk / sdk - core - ios / ActorSDK . xcodeproj / project . pbxproj < nl > + + + b / actor - sdk / sdk - core - ios / ActorSDK . xcodeproj / project . pbxproj < nl > @ @ - 173 , 6 + 173 , 9 @ @ < nl > 	 	 06CE898C1BD841C9005A5530 / * SystemConfiguration . framework in Frameworks * / = { isa = PBXBuildFile ; fileRef = 06CE898B1BD841C9005A5530 / * SystemConfiguration . framework * / ; } ; < nl > 	 	 06CE89901BD84DF5005A5530 / * ActorSDKAnalytics . swift in Sources * / = { isa = PBXBuildFile ; fileRef = 06CE898F1BD84DF5005A5530 / * ActorSDKAnalytics . swift * / ; } ; < nl > 	 	 06E322C91C69344A00D66F53 / * iOSWebRTCProvider . swift in Sources * / = { isa = PBXBuildFile ; fileRef = 06E322C81C69344A00D66F53 / * iOSWebRTCProvider . swift * / ; } ; < nl > + 	 	 06E3230E1C69445C00D66F53 / * WebRTC . h in Headers * / = { isa = PBXBuildFile ; fileRef = 06E3230D1C6942C400D66F53 / * WebRTC . h * / ; settings = { ATTRIBUTES = ( Public , ) ; } ; } ; < nl > + 	 	 06E323111C694C1D00D66F53 / * WebRTCExt . swift in Sources * / = { isa = PBXBuildFile ; fileRef = 06E323101C694C1D00D66F53 / * WebRTCExt . swift * / ; } ; < nl > + 	 	 06E323151C6A7AC000D66F53 / * AACallViewController . swift in Sources * / = { isa = PBXBuildFile ; fileRef = 06E323141C6A7AC000D66F53 / * AACallViewController . swift * / ; } ; < nl > 	 	 06E7B2471C0F8D7A0090660C / * AALocationPickerController . swift in Sources * / = { isa = PBXBuildFile ; fileRef = 06E7B2461C0F8D7A0090660C / * AALocationPickerController . swift * / ; } ; < nl > 	 	 06E7B24A1C0F92140090660C / * AABubbleLocationCell . swift in Sources * / = { isa = PBXBuildFile ; fileRef = 06E7B2491C0F92140090660C / * AABubbleLocationCell . swift * / ; } ; < nl > 	 	 06E7B24C1C0FAB500090660C / * AAMapFastView . swift in Sources * / = { isa = PBXBuildFile ; fileRef = 06E7B24B1C0FAB500090660C / * AAMapFastView . swift * / ; } ; < nl > @ @ - 467 , 6 + 470 , 9 @ @ < nl > 	 	 06CE898B1BD841C9005A5530 / * SystemConfiguration . framework * / = { isa = PBXFileReference ; lastKnownFileType = wrapper . framework ; name = SystemConfiguration . framework ; path = System / Library / Frameworks / SystemConfiguration . framework ; sourceTree = SDKROOT ; } ; < nl > 	 	 06CE898F1BD84DF5005A5530 / * ActorSDKAnalytics . swift * / = { isa = PBXFileReference ; fileEncoding = 4 ; lastKnownFileType = sourcecode . swift ; path = ActorSDKAnalytics . swift ; sourceTree = " < group > " ; } ; < nl > 	 	 06E322C81C69344A00D66F53 / * iOSWebRTCProvider . swift * / = { isa = PBXFileReference ; fileEncoding = 4 ; lastKnownFileType = sourcecode . swift ; path = iOSWebRTCProvider . swift ; sourceTree = " < group > " ; } ; < nl > + 	 	 06E3230D1C6942C400D66F53 / * WebRTC . h * / = { isa = PBXFileReference ; lastKnownFileType = sourcecode . c . h ; path = WebRTC . h ; sourceTree = " < group > " ; } ; < nl > + 	 	 06E323101C694C1D00D66F53 / * WebRTCExt . swift * / = { isa = PBXFileReference ; fileEncoding = 4 ; lastKnownFileType = sourcecode . swift ; path = WebRTCExt . swift ; sourceTree = " < group > " ; } ; < nl > + 	 	 06E323141C6A7AC000D66F53 / * AACallViewController . swift * / = { isa = PBXFileReference ; fileEncoding = 4 ; lastKnownFileType = sourcecode . swift ; name = AACallViewController . swift ; path = Calls / AACallViewController . swift ; sourceTree = " < group > " ; } ; < nl > 	 	 06E7B2461C0F8D7A0090660C / * AALocationPickerController . swift * / = { isa = PBXFileReference ; fileEncoding = 4 ; lastKnownFileType = sourcecode . swift ; path = AALocationPickerController . swift ; sourceTree = " < group > " ; } ; < nl > 	 	 06E7B2491C0F92140090660C / * AABubbleLocationCell . swift * / = { isa = PBXFileReference ; fileEncoding = 4 ; lastKnownFileType = sourcecode . swift ; path = AABubbleLocationCell . swift ; sourceTree = " < group > " ; } ; < nl > 	 	 06E7B24B1C0FAB500090660C / * AAMapFastView . swift * / = { isa = PBXFileReference ; fileEncoding = 4 ; lastKnownFileType = sourcecode . swift ; path = AAMapFastView . swift ; sourceTree = " < group > " ; } ; < nl > @ @ - 847 , 6 + 853 , 7 @ @ < nl > 	 	 	 	 066A527B1BC51EC6000E606E / * Root * / , < nl > 	 	 	 	 066A52EB1BC52AF8000E606E / * Settings * / , < nl > 	 	 	 	 066A53091BC53197000E606E / * User * / , < nl > + 	 	 	 	 06E323131C6A7AA300D66F53 / * Calls * / , < nl > 	 	 	 ) ; < nl > 	 	 	 path = Controllers ; < nl > 	 	 	 sourceTree = " < group > " ; < nl > @ @ - 1150 , 6 + 1157 , 8 @ @ < nl > 	 	 	 isa = PBXGroup ; < nl > 	 	 	 children = ( < nl > 	 	 	 	 15D35F0A1C20182900E3717A / * AudioRecorder * / , < nl > + 	 	 	 	 06E3230D1C6942C400D66F53 / * WebRTC . h * / , < nl > + 	 	 	 	 06E323101C694C1D00D66F53 / * WebRTCExt . swift * / , < nl > 	 	 	 ) ; < nl > 	 	 	 name = Libs ; < nl > 	 	 	 sourceTree = " < group > " ; < nl > @ @ - 1161 , 6 + 1170 , 14 @ @ < nl > 	 	 	 name = Libs ; < nl > 	 	 	 sourceTree = " < group > " ; < nl > 	 	 } ; < nl > + 	 	 06E323131C6A7AA300D66F53 / * Calls * / = { < nl > + 	 	 	 isa = PBXGroup ; < nl > + 	 	 	 children = ( < nl > + 	 	 	 	 06E323141C6A7AC000D66F53 / * AACallViewController . swift * / , < nl > + 	 	 	 ) ; < nl > + 	 	 	 name = Calls ; < nl > + 	 	 	 sourceTree = " < group > " ; < nl > + 	 	 } ; < nl > 	 	 06E7B2451C0F8D410090660C / * Location * / = { < nl > 	 	 	 isa = PBXGroup ; < nl > 	 	 	 children = ( < nl > @ @ - 1535 , 6 + 1552 , 7 @ @ < nl > 	 	 	 	 15F89F0A1C211FED00776ACD / * opus . h in Headers * / , < nl > 	 	 	 	 15D35F511C20187E00E3717A / * ASQueue . h in Headers * / , < nl > 	 	 	 	 15D35F1D1C20185500E3717A / * picture . h in Headers * / , < nl > + 	 	 	 	 06E3230E1C69445C00D66F53 / * WebRTC . h in Headers * / , < nl > 	 	 	 	 06230F421BC95BD200A4807B / * RMPhoneFormat . h in Headers * / , < nl > 	 	 	 	 069CF4CE1BCB909A00C66E12 / * CLToken . h in Headers * / , < nl > 	 	 	 ) ; < nl > @ @ - 1645 , 7 + 1663 , 7 @ @ < nl > 	 	 	 ) ; < nl > 	 	 	 runOnlyForDeploymentPostprocessing = 0 ; < nl > 	 	 	 shellPath = / bin / sh ; < nl > - 	 	 	 shellScript = " set - e \ n \ ncd ActorSDK / Sources / ActorCore \ nmake translate \ nmake build - j3 \ n \ ncd \ " $ { CONFIGURATION _ TEMP _ DIR } / j2objc / \ " \ npython \ " $ { PROJECT _ DIR } / ActorSDK / Sources / ActorCore / convert . py \ " \ " $ { PROJECT _ DIR } / ActorSDK / Sources / ActorCore / ActorCore . h \ " \ n \ ncp - a \ " $ { CONFIGURATION _ TEMP _ DIR } / j2objc / Public / \ " \ " $ { CONFIGURATION _ BUILD _ DIR } / ActorSDK . framework / Headers / \ " \ n \ ncp - a \ " $ { PROJECT _ DIR } / . . / sdk - core / core / core - shared / src / main / resources / \ " \ " $ { CONFIGURATION _ BUILD _ DIR } / ActorSDK . framework / \ " " ; < nl > + 	 	 	 shellScript = " set - e \ n \ ncd ActorSDK / Sources / ActorCore \ nmake translate \ nmake build - j3 \ n \ ncd \ " $ { CONFIGURATION _ TEMP _ DIR } / j2objc / \ " \ npython \ " $ { PROJECT _ DIR } / ActorSDK / Sources / ActorCore / convert . py \ " \ " $ { PROJECT _ DIR } / ActorSDK / Sources / ActorCore / ActorCore . h \ " \ n \ ncp - af \ " $ { PODS _ ROOT } / libjingle _ peerconnection / libjingle _ peerconnection / Headers / \ " \ " $ { CONFIGURATION _ BUILD _ DIR } / ActorSDK . framework / Headers / \ " \ n \ ncp - a \ " $ { CONFIGURATION _ TEMP _ DIR } / j2objc / Public / \ " \ " $ { CONFIGURATION _ BUILD _ DIR } / ActorSDK . framework / Headers / \ " \ n \ n \ ncp - a \ " $ { PROJECT _ DIR } / . . / sdk - core / core / core - shared / src / main / resources / \ " \ " $ { CONFIGURATION _ BUILD _ DIR } / ActorSDK . framework / \ " " ; < nl > 	 	 } ; < nl > 	 	 842CC4516DA967714D224C37 / * Check Pods Manifest . lock * / = { < nl > 	 	 	 isa = PBXShellScriptBuildPhase ; < nl > @ @ - 1715 , 6 + 1733 , 7 @ @ < nl > 	 	 	 	 15D35F601C20187E00E3717A / * AAOpusAudioPlayerAU . mm in Sources * / , < nl > 	 	 	 	 15D35F1C1C20185500E3717A / * picture . c in Sources * / , < nl > 	 	 	 	 066A532B1BC53406000E606E / * AABubbleCell . swift in Sources * / , < nl > + 	 	 	 	 06E323151C6A7AC000D66F53 / * AACallViewController . swift in Sources * / , < nl > 	 	 	 	 066A52C71BC521EA000E606E / * AAEditTextController . swift in Sources * / , < nl > 	 	 	 	 153F6B5D1C2B3AC500C0B960 / * AABubbleStickerCell . swift in Sources * / , < nl > 	 	 	 	 15D35F1E1C20185500E3717A / * wav _ io . c in Sources * / , < nl > @ @ - 1880 , 6 + 1899 , 7 @ @ < nl > 	 	 	 	 066A52421BC4EECD000E606E / * AATableViewHeader . swift in Sources * / , < nl > 	 	 	 	 066A52CD1BC521FA000E606E / * AADialogsListContentControllerDelegate . swift in Sources * / , < nl > 	 	 	 	 15D35F261C20186200E3717A / * framing . c in Sources * / , < nl > + 	 	 	 	 06E323111C694C1D00D66F53 / * WebRTCExt . swift in Sources * / , < nl > 	 	 	 	 066A52231BC4EEAC000E606E / * AAManagedSection . swift in Sources * / , < nl > 	 	 	 	 066A52D11BC52204000E606E / * AADialogCell . swift in Sources * / , < nl > 	 	 	 	 066A51901BC4C383000E606E / * CocoaNetworkRuntime . swift in Sources * / , < nl > diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / ActorCoreExt . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / ActorCoreExt . swift < nl > index 1f22c74 . . 2b4bf24 100644 < nl > - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / ActorCoreExt . swift < nl > + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / ActorCoreExt . swift < nl > @ @ - 375 , 7 + 375 , 7 @ @ public class AABinder { < nl > < nl > } < nl > < nl > - public func bind < T1 , T2 , T3 > ( valueModel1 : ARValue , valueModel2 : ARValue , valueModel3 : ARValue , closure : ( value1 : T1 ? , value2 : T2 ? , value3 : T3 ? ) - > ( ) ) { < nl > + public func bind < T1 , T2 , T3 > ( valueModel1 : ARValue , valueModel2 : ARValue , valueModel3 : ARValue , closure : ( value1 : T1 ! , value2 : T2 ! , value3 : T3 ! ) - > ( ) ) { < nl > < nl > let listener1 = BindListener { ( _ value1 ) - > ( ) in < nl > closure ( value1 : _ value1 as ? T1 , value2 : valueModel2 . get ( ) as ? T2 , value3 : valueModel3 . get ( ) as ? T3 ) < nl > @ @ - 396 , 7 + 396 , 7 @ @ public class AABinder { < nl > } < nl > < nl > < nl > - public func bind < T1 , T2 > ( valueModel1 : ARValue , valueModel2 : ARValue , closure : ( value1 : T1 ? , value2 : T2 ? ) - > ( ) ) { < nl > + public func bind < T1 , T2 > ( valueModel1 : ARValue , valueModel2 : ARValue , closure : ( value1 : T1 ! , value2 : T2 ! ) - > ( ) ) { < nl > let listener1 = BindListener { ( _ value1 ) - > ( ) in < nl > closure ( value1 : _ value1 as ? T1 , value2 : valueModel2 . get ( ) as ? T2 ) < nl > } ; < nl > @ @ - 410 , 7 + 410 , 7 @ @ public class AABinder { < nl > closure ( value1 : valueModel1 . get ( ) as ? T1 , value2 : valueModel2 . get ( ) as ? T2 ) < nl > } < nl > < nl > - public func bind < T > ( value : ARValue , closure : ( value : T ? ) - > ( ) ) { < nl > + public func bind < T > ( value : ARValue , closure : ( value : T ! ) - > ( ) ) { < nl > let listener = BindListener { ( value2 ) - > ( ) in < nl > closure ( value : value2 as ? T ) < nl > } ; < nl > diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / Providers / iOSWebRTCProvider . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / Providers / iOSWebRTCProvider . swift < nl > index c608432 . . 7b32ab5 100644 < nl > - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / Providers / iOSWebRTCProvider . swift < nl > + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / Providers / iOSWebRTCProvider . swift < nl > @ @ - 3 , 43 + 3 , 179 @ @ < nl > / / < nl > < nl > import Foundation < nl > - import RTCPeerConnection < nl > < nl > class iOSWebRTCProvider : NSObject , ACWebRTCProvider { < nl > < nl > - private var controller : ACWebRTCController ! ! < nl > - private var messenger : ACMessenger ! ! < nl > + private var controller : ACWebRTCController ! < nl > + private var messenger : ACMessenger ! < nl > + < nl > + private lazy var queue : dispatch _ queue _ t = dispatch _ queue _ create ( " webrtc _ queue " , DISPATCH _ QUEUE _ SERIAL ) < nl > + private let peerConnectionFactory = RTCPeerConnectionFactory ( ) < nl > + private let mediaConstraints = RTCMediaConstraints ( ) < nl > + < nl > + private var runningCallId : jlong ? < nl > + private var peerConnection : RTCPeerConnection ! < nl > + private var voiceCapture : RTCAudioTrack ! < nl > + < nl > + override init ( ) { < nl > + RTCPeerConnectionFactory . initializeSSL ( ) < nl > + } < nl > < nl > func initWithMessenger ( messenger : ACMessenger , withController controller : ACWebRTCController ) { < nl > self . controller = controller < nl > self . messenger = messenger < nl > } < nl > < nl > + / / < nl > + / / Start / End of calls < nl > + / / < nl > + < nl > func onIncomingCallWithCallId ( callId : jlong ) { < nl > - < nl > + dispatchSync ( ) { < nl > + print ( " onIncomingCallWithCallId " ) < nl > + self . runningCallId = callId < nl > + dispatchOnUi ( ) { ( ) - > Void in < nl > + let rootController = ActorSDK . sharedActor ( ) . bindedToWindow . rootViewController ! < nl > + rootController . presentViewController ( AACallViewController ( callId : callId ) , animated : true , completion : nil ) < nl > + } < nl > + } < nl > } < nl > < nl > func onOutgoingCallWithCallId ( callId : jlong ) { < nl > + dispatchSync ( ) { < nl > + print ( " onOutgoingCallWithCallId " ) < nl > + self . runningCallId = callId < nl > + } < nl > + } < nl > + < nl > + func onCallEndWithCallId ( callId : jlong ) { < nl > + dispatchSync ( ) { < nl > + if ( self . peerConnection ! = nil ) { < nl > + self . peerConnection . close ( ) < nl > + self . peerConnection = nil < nl > + } < nl > + self . voiceCapture = nil < nl > + self . runningCallId = - 1 < nl > + } < nl > + } < nl > + < nl > + / / < nl > + / / In process < nl > + / / < nl > + < nl > + private func createPeerConnection ( callId : jlong ) { < nl > + / / < nl > + / / Create Peer Connection < nl > + / / < nl > + let iceServers = [ < nl > + RTCICEServer ( URI : NSURL ( string : " stun : 62 . 4 . 22 . 219 : 3478 " ) , username : " " , password : " " ) , < nl > + RTCICEServer ( URI : NSURL ( string : " turn : 62 . 4 . 22 . 219 : 3478 ? transport = tcp " ) , username : " actor " , password : " password " ) , < nl > + RTCICEServer ( URI : NSURL ( string : " turn : 62 . 4 . 22 . 219 : 3478 ? transport = udp " ) , username : " actor " , password : " password " ) < nl > + ] < nl > + peerConnection = peerConnectionFactory . peerConnectionWithICEServers ( iceServers , constraints : mediaConstraints , delegate : nil ) < nl > < nl > + / / < nl > + / / Crete Media Stream < nl > + / / < nl > + voiceCapture = peerConnectionFactory . audioTrackWithID ( " audio0 " ) < nl > + let mediaStream = peerConnectionFactory . mediaStreamWithLabel ( " ARDAMSa0 " ) < nl > + mediaStream . addAudioTrack ( voiceCapture ) < nl > + peerConnection . addStream ( mediaStream ) < nl > + < nl > + / / < nl > + / / Handling events from peer connection < nl > + / / < nl > + peerConnection . onCandidateReceived = { ( candidate ) in < nl > + self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > + print ( " On Candidate arrived " ) < nl > + self . controller . sendCandidateWithInt ( jint ( candidate . sdpMLineIndex ) , withNSString : candidate . sdpMid , withNSString : candidate . sdp ) < nl > + } < nl > + } < nl > + peerConnection . onStreamAdded = { ( stream ) in < nl > + self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > + print ( " On stream added " ) < nl > + } < nl > + } < nl > } < nl > < nl > func onOfferNeededWithCallId ( callId : jlong ) { < nl > - < nl > + self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > + print ( " onOfferNeededWithCallId " ) < nl > + } < nl > } < nl > < nl > func onAnswerReceivedWithCallId ( callId : jlong , withSDP offerSDP : String ) { < nl > - < nl > + self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > + print ( " onAnswerReceivedWithCallId " ) < nl > + } < nl > } < nl > < nl > func onOfferReceivedWithCallId ( callId : jlong , withSDP offerSDP : String ) { < nl > < nl > + / / < nl > + / / Stages : < nl > + / / 1 . Create Peer Connection < nl > + / / 2 . Set Remote description < nl > + / / 3 . Create Answer < nl > + / / 4 . Set Local description from answer < nl > + / / 5 . Send Answer and enable candidate receiving < nl > + / / < nl > + < nl > + self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > + self . createPeerConnection ( callId ) < nl > + self . peerConnection . setRemoteDescription ( RTCSessionDescription ( type : " offer " , sdp : offerSDP ) ) { ( error ) - > ( ) in < nl > + self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > + if ( error = = nil ) { < nl > + self . peerConnection . createAnswer ( self . mediaConstraints ) { ( sdp , error ) - > ( ) in < nl > + self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > + if ( error = = nil ) { < nl > + self . peerConnection . setLocalDescription ( sdp ) { ( error ) - > ( ) in < nl > + self . dispatchAsync ( callId ) { ( ) - > ( ) in < nl > + if ( error = = nil ) { < nl > + self . controller . sendAnswerWithNSString ( sdp . description ) < nl > + self . controller . readyForCandidates ( ) < nl > + } else { < nl > + self . controller . endCall ( ) < nl > + } < nl > + } < nl > + } < nl > + } else { < nl > + self . controller . endCall ( ) < nl > + } < nl > + } < nl > + } < nl > + } else { < nl > + self . controller . endCall ( ) < nl > + } < nl > + } < nl > + } < nl > + } < nl > } < nl > < nl > func onCandidateWithCallId ( callId : jlong , withId id _ : String , withLabel label : jint , withSDP sdp : String ) { < nl > - < nl > + dispatchAsync ( callId ) { ( ) - > ( ) in < nl > + self . peerConnection . addICECandidate ( RTCICECandidate ( mid : id _ , index : Int ( label ) , sdp : sdp ) ) < nl > + } < nl > } < nl > < nl > - func onCallEndWithCallId ( callId : jlong ) { < nl > - < nl > + < nl > + / / < nl > + / / Dispatching < nl > + / / < nl > + < nl > + private func dispatchSync ( closure : ( ) - > ( ) ) { < nl > + dispatch _ sync ( queue ) { ( ) - > Void in < nl > + closure ( ) < nl > + } < nl > + } < nl > + < nl > + private func dispatchAsync ( callId : jlong , closure : ( ) - > ( ) ) { < nl > + if ( self . runningCallId = = callId ) { < nl > + dispatch _ async ( queue ) { ( ) - > Void in < nl > + if ( self . runningCallId = = callId ) { < nl > + closure ( ) < nl > + } < nl > + } < nl > + } < nl > } < nl > } < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . h b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . h < nl > index 99f4b2f . . ec8398b 100644 < nl > - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . h < nl > + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . h < nl > @ @ - 50 , 5 + 50 , 4 @ @ FOUNDATION _ EXPORT const unsigned char ActorSDKVersionString [ ] ; < nl > < nl > # import " CLTokenView . h " < nl > < nl > - < nl > - < nl > + # import " WebRTC . h " < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Calls / AACallViewController . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Calls / AACallViewController . swift < nl > new file mode 100644 < nl > index 0000000 . . 1336eb5 < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Calls / AACallViewController . swift < nl > @ @ - 0 , 0 + 1 , 128 @ @ < nl > + / / < nl > + / / Copyright ( c ) 2014 - 2016 Actor LLC . < https : / / actor . im > < nl > + / / < nl > + < nl > + import Foundation < nl > + import PureLayout < nl > + < nl > + public class AACallViewController : AAViewController { < nl > + < nl > + public let binder = AABinder ( ) < nl > + public let callId : jlong < nl > + public let call : ACCallModel < nl > + public let bgImage = UIImageView ( image : UIImage . bundled ( " bg _ 1 . jpg " ) ) < nl > + public let bgImageOverlay = UIView ( ) < nl > + public let senderAvatar : AAAvatarView = AAAvatarView ( frameSize : 120 , type : . Rounded ) < nl > + public let peerTitle = UILabel ( ) < nl > + public let answerCall = UIButton ( frame : CGRectMake ( 0 , 0 , 80 , 80 ) ) < nl > + < nl > + public init ( callId : jlong ) { < nl > + self . callId = callId < nl > + self . call = ActorSDK . sharedActor ( ) . messenger . getCallWithCallId ( callId ) < nl > + super . init ( ) < nl > + } < nl > + < nl > + public required init ( coder aDecoder : NSCoder ) { < nl > + fatalError ( " init ( coder : ) has not been implemented " ) < nl > + } < nl > + < nl > + public override func viewDidLoad ( ) { < nl > + super . viewDidLoad ( ) < nl > + < nl > + answerCall . backgroundColor = UIColor ( rgb : 0xc04945 ) < nl > + answerCall . setTitle ( " End Call " , forState : . Normal ) < nl > + answerCall . setTitleColor ( UIColor . whiteColor ( ) , forState : . Normal ) < nl > + answerCall . viewDidTap = { < nl > + Actor . endCallWithCallId ( self . callId ) < nl > + self . navigateDetail ( ConversationViewController ( peer : self . call . getPeer ( ) ) ) < nl > + self . dismiss ( ) < nl > + } < nl > + < nl > + bgImage . contentMode = UIViewContentMode . ScaleAspectFill < nl > + bgImageOverlay . opaque = false < nl > + bgImageOverlay . backgroundColor = UIColor ( rgb : 0x86aed7 ) < nl > + peerTitle . textColor = UIColor . whiteColor ( ) < nl > + peerTitle . textAlignment = NSTextAlignment . Center < nl > + peerTitle . font = UIFont . thinSystemFontOfSize ( 32 ) < nl > + < nl > + self . view . addSubview ( bgImage ) < nl > + self . view . addSubview ( bgImageOverlay ) < nl > + self . view . addSubview ( senderAvatar ) < nl > + self . view . addSubview ( peerTitle ) < nl > + self . view . addSubview ( answerCall ) < nl > + } < nl > + < nl > + public override func viewWillLayoutSubviews ( ) { < nl > + super . viewWillLayoutSubviews ( ) < nl > + < nl > + bgImage . frame = self . view . bounds < nl > + bgImageOverlay . frame = self . view . bounds < nl > + < nl > + senderAvatar . frame = CGRectMake ( ( self . view . width - 120 ) / 2 , 100 , 120 , 120 ) < nl > + peerTitle . frame = CGRectMake ( 60 , senderAvatar . bottom + 20 , view . width - 120 , 34 ) < nl > + answerCall . frame = CGRectMake ( 0 , self . view . height - 48 , self . view . width , 48 ) < nl > + } < nl > + < nl > + public override func viewWillAppear ( animated : Bool ) { < nl > + super . viewWillAppear ( animated ) < nl > + < nl > + / / < nl > + / / Binding State < nl > + / / < nl > + binder . bind ( call . getState ( ) ) { ( value : ACCallState ! ) - > ( ) in < nl > + if ( ACCallState _ Enum . CALLING _ INCOMING = = value . toNSEnum ( ) ) { < nl > + print ( " Call \ ( self . callId ) incoming " ) < nl > + } else if ( ACCallState _ Enum . IN _ PROGRESS = = value . toNSEnum ( ) ) { < nl > + print ( " Call \ ( self . callId ) in progress " ) < nl > + } else { < nl > + print ( " Call \ ( self . callId ) unknown " ) < nl > + } < nl > + } < nl > + < nl > + / / < nl > + / / Binding Avatar < nl > + / / < nl > + binder . bind ( call . getActiveMembers ( ) ) { ( value : JavaUtilArrayList ! ) - > ( ) in < nl > + < nl > + print ( " Bind user " ) < nl > + < nl > + var users = [ ACUserVM ] ( ) < nl > + for i in 0 . . < value . size ( ) { < nl > + let uid = ( value . getWithInt ( i ) as ! JavaLangInteger ) . intValue ( ) < nl > + if ( uid ! = Actor . myUid ( ) ) { < nl > + users . append ( Actor . getUserWithUid ( uid ) ) < nl > + } < nl > + } < nl > + < nl > + print ( " Bind user \ ( users . count ) " ) < nl > + < nl > + if ( users . count = = 1 ) { < nl > + self . senderAvatar . bind ( users [ 0 ] . getNameModel ( ) . get ( ) , id : users [ 0 ] . getId ( ) , avatar : users [ 0 ] . getAvatarModel ( ) . get ( ) ) < nl > + } else { < nl > + / / TODO : Multiple Users < nl > + } < nl > + } < nl > + < nl > + / / < nl > + / / Binding Title < nl > + / / < nl > + if ( call . getPeer ( ) . peerType . toNSEnum ( ) = = ACPeerType _ Enum . PRIVATE ) { < nl > + binder . bind ( Actor . getUserWithUid ( call . getPeer ( ) . peerId ) . getNameModel ( ) , closure : { ( value : String ! ) - > ( ) in < nl > + self . peerTitle . text = value < nl > + } ) < nl > + } else if ( call . getPeer ( ) . peerType . toNSEnum ( ) = = ACPeerType _ Enum . GROUP ) { < nl > + binder . bind ( Actor . getGroupWithGid ( call . getPeer ( ) . peerId ) . getNameModel ( ) , closure : { ( value : String ! ) - > ( ) in < nl > + self . peerTitle . text = value < nl > + } ) < nl > + } < nl > + < nl > + UIApplication . sharedApplication ( ) . setStatusBarStyle ( . LightContent , animated : true ) < nl > + } < nl > + < nl > + public override func viewWillDisappear ( animated : Bool ) { < nl > + super . viewWillDisappear ( animated ) < nl > + binder . unbindAll ( ) < nl > + < nl > + UIApplication . sharedApplication ( ) . setStatusBarStyle ( ActorSDK . sharedActor ( ) . style . vcStatusBarStyle , animated : true ) < nl > + } < nl > + } < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Managed Runtime / Navigations . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Managed Runtime / Navigations . swift < nl > index 0e533ef . . 6003e79 100644 < nl > - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Managed Runtime / Navigations . swift 	 < nl > + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Managed Runtime / Navigations . swift 	 < nl > @ @ - 7 , 19 + 7 , 15 @ @ import Foundation < nl > public extension UIViewController { < nl > public func navigateDetail ( controller : UIViewController ) { < nl > if ( AADevice . isiPad ) { < nl > - let split = UIApplication . sharedApplication ( ) . keyWindow ? . rootViewController as ! UISplitViewController ; < nl > + let split = UIApplication . sharedApplication ( ) . keyWindow ? . rootViewController as ! UISplitViewController < nl > let master = split . viewControllers [ 0 ] < nl > let detail = AANavigationController ( ) < nl > detail . viewControllers = [ controller ] < nl > split . viewControllers = [ master , detail ] < nl > } else { < nl > - < nl > - if controller . isKindOfClass ( ConversationViewController . self ) { < nl > - / / navigationController ? . view . layer . speed = 1 . 5 < nl > - } < nl > - < nl > + let tabBar = UIApplication . sharedApplication ( ) . keyWindow ? . rootViewController as ! UITabBarController < nl > controller . hidesBottomBarWhenPushed = true < nl > - navigationController ? . pushViewController ( controller , animated : true ) ; < nl > + ( tabBar . selectedViewController as ! AANavigationController ) . pushViewController ( controller , animated : true ) < nl > } < nl > } < nl > } < nl > diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / User / AAUserViewController . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / User / AAUserViewController . swift < nl > index 3351f21 . . 917a3a6 100644 < nl > - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / User / AAUserViewController . swift < nl > + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / User / AAUserViewController . swift < nl > @ @ - 67 , 7 + 67 , 7 @ @ class AAUserViewController : AAContentTableController { < nl > / / Profile : Send messages < nl > s . action ( " ProfileSendMessage " ) { ( r ) - > ( ) in < nl > r . selectAction = { ( ) - > Bool in < nl > - self . navigateDetail ( ConversationViewController ( peer : ACPeer . userWithInt ( jint ( self . uid ) ) ) ) < nl > + self . navigateDetail ( ConversationViewController ( peer : ACPeer . userWithInt ( jint ( self . uid ) ) ) ) < nl > self . popover ? . dismissPopoverAnimated ( true ) < nl > return false < nl > } < nl > diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / WebRTC . h b / actor - sdk / sdk - core - ios / ActorSDK / Sources / WebRTC . h < nl > new file mode 100644 < nl > index 0000000 . . b2b2fc7 < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / WebRTC . h < nl > @ @ - 0 , 0 + 1 , 34 @ @ < nl > + / / < nl > + / / Copyright ( c ) 2014 - 2016 Actor LLC . < https : / / actor . im > < nl > + / / < nl > + < nl > + # import " RTCAudioSource . h " < nl > + # import " RTCAudioTrack . h " < nl > + # import " RTCAVFoundationVideoSource . h " < nl > + # import " RTCDataChannel . h " < nl > + # import " RTCEAGLVideoView . h " < nl > + # import " RTCFileLogger . h " < nl > + # import " RTCI420Frame . h " < nl > + # import " RTCICECandidate . h " < nl > + # import " RTCICEServer . h " < nl > + # import " RTCLogging . h " < nl > + # import " RTCMediaConstraints . h " < nl > + # import " RTCMediaSource . h " < nl > + # import " RTCMediaStream . h " < nl > + # import " RTCMediaStreamTrack . h " < nl > + # import " RTCOpenGLVideoRenderer . h " < nl > + # import " RTCPair . h " < nl > + # import " RTCPeerConnection . h " < nl > + # import " RTCPeerConnectionFactory . h " < nl > + # import " RTCMediaConstraints . h " < nl > + # import " RTCPeerConnectionDelegate . h " < nl > + # import " RTCPeerConnectionInterface . h " < nl > + # import " RTCSessionDescription . h " < nl > + # import " RTCSessionDescriptionDelegate . h " < nl > + # import " RTCStatsDelegate . h " < nl > + # import " RTCStatsReport . h " < nl > + # import " RTCTypes . h " < nl > + # import " RTCVideoCapturer . h " < nl > + # import " RTCVideoRenderer . h " < nl > + # import " RTCVideoSource . h " < nl > + # import " RTCVideoTrack . h " < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / WebRTCExt . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / WebRTCExt . swift < nl > new file mode 100644 < nl > index 0000000 . . 35197b8 < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / WebRTCExt . swift < nl > @ @ - 0 , 0 + 1 , 146 @ @ < nl > + / / < nl > + / / Copyright ( c ) 2014 - 2016 Actor LLC . < https : / / actor . im > < nl > + / / < nl > + < nl > + import Foundation < nl > + import BrightFutures < nl > + < nl > + class AAPeerConnectionDelegate : NSObject , RTCPeerConnectionDelegate { < nl > + < nl > + var onCandidateReceived : ( ( RTCICECandidate ) - > ( ) ) ? < nl > + var onStreamAdded : ( ( RTCMediaStream ) - > ( ) ) ? < nl > + < nl > + func peerConnection ( peerConnection : RTCPeerConnection ! , signalingStateChanged stateChanged : RTCSignalingState ) { < nl > + < nl > + } < nl > + < nl > + func peerConnection ( peerConnection : RTCPeerConnection ! , addedStream stream : RTCMediaStream ! ) { < nl > + onStreamAdded ? ( stream ) < nl > + } < nl > + < nl > + func peerConnection ( peerConnection : RTCPeerConnection ! , removedStream stream : RTCMediaStream ! ) { < nl > + < nl > + } < nl > + < nl > + func peerConnectionOnRenegotiationNeeded ( peerConnection : RTCPeerConnection ! ) { < nl > + < nl > + } < nl > + < nl > + func peerConnection ( peerConnection : RTCPeerConnection ! , iceConnectionChanged newState : RTCICEConnectionState ) { < nl > + < nl > + } < nl > + < nl > + func peerConnection ( peerConnection : RTCPeerConnection ! , iceGatheringChanged newState : RTCICEGatheringState ) { < nl > + < nl > + } < nl > + < nl > + func peerConnection ( peerConnection : RTCPeerConnection ! , gotICECandidate candidate : RTCICECandidate ! ) { < nl > + onCandidateReceived ? ( candidate ) < nl > + } < nl > + < nl > + func peerConnection ( peerConnection : RTCPeerConnection ! , didOpenDataChannel dataChannel : RTCDataChannel ! ) { < nl > + < nl > + } < nl > + } < nl > + < nl > + class AASessionDescriptionCreateDelegate : NSObject , RTCSessionDescriptionDelegate { < nl > + < nl > + let didCreate : ( RTCSessionDescription ! , NSError ! ) - > ( ) < nl > + let peerConnection : RTCPeerConnection < nl > + < nl > + init ( didCreate : ( RTCSessionDescription ! , NSError ! ) - > ( ) , peerConnection : RTCPeerConnection ) { < nl > + self . didCreate = didCreate < nl > + self . peerConnection = peerConnection < nl > + } < nl > + < nl > + func peerConnection ( peerConnection : RTCPeerConnection ! , didCreateSessionDescription sdp : RTCSessionDescription ! , error : NSError ! ) { < nl > + didCreate ( sdp ! , error ) < nl > + } < nl > + < nl > + func peerConnection ( peerConnection : RTCPeerConnection ! , didSetSessionDescriptionWithError error : NSError ! ) { < nl > + < nl > + } < nl > + } < nl > + < nl > + < nl > + private var sessionSetTarget = " descTarget " < nl > + class AASessionDescriptionSetDelegate : NSObject , RTCSessionDescriptionDelegate { < nl > + < nl > + let didSet : ( NSError ! ) - > ( ) < nl > + let peerConnection : RTCPeerConnection < nl > + < nl > + init ( didSet : ( NSError ! ) - > ( ) , peerConnection : RTCPeerConnection ) { < nl > + self . didSet = didSet < nl > + self . peerConnection = peerConnection < nl > + super . init ( ) < nl > + < nl > + setAssociatedObject ( peerConnection , value : self , associativeKey : & sessionSetTarget ) < nl > + } < nl > + < nl > + func peerConnection ( peerConnection : RTCPeerConnection ! , didCreateSessionDescription sdp : RTCSessionDescription ! , error : NSError ! ) { < nl > + print ( " didCreateSessionDescription " ) < nl > + } < nl > + < nl > + func peerConnection ( peerConnection : RTCPeerConnection ! , didSetSessionDescriptionWithError error : NSError ! ) { < nl > + print ( " didSetSessionDescriptionWithError " ) < nl > + < nl > + setAssociatedObject ( peerConnection , value : " " , associativeKey : & sessionSetTarget ) < nl > + < nl > + didSet ( error ) < nl > + } < nl > + } < nl > + < nl > + private var targetReference = " target " < nl > + extension RTCPeerConnection { < nl > + < nl > + public var onCandidateReceived : ( ( RTCICECandidate ) - > ( ) ) ? { < nl > + set ( value ) { < nl > + intDelegate ( ) . onCandidateReceived = value < nl > + } < nl > + get { < nl > + return intDelegate ( ) . onCandidateReceived < nl > + } < nl > + } < nl > + < nl > + public var onStreamAdded : ( ( RTCMediaStream ) - > ( ) ) ? { < nl > + set ( value ) { < nl > + intDelegate ( ) . onStreamAdded = value < nl > + } < nl > + get { < nl > + return intDelegate ( ) . onStreamAdded < nl > + } < nl > + } < nl > + < nl > + private func intDelegate ( ) - > AAPeerConnectionDelegate { < nl > + let stored = self . delegate as ? AAPeerConnectionDelegate < nl > + if ( stored ! = nil ) { < nl > + return stored ! < nl > + } < nl > + < nl > + let nDelegate = AAPeerConnectionDelegate ( ) < nl > + self . delegate = nDelegate < nl > + setAssociatedObject ( self , value : nDelegate , associativeKey : & targetReference ) < nl > + return nDelegate < nl > + } < nl > + < nl > + func createAnswer ( constraints : RTCMediaConstraints , didCreate : ( RTCSessionDescription ! , NSError ! ) - > ( ) ) { < nl > + createAnswerWithDelegate ( AASessionDescriptionCreateDelegate ( didCreate : didCreate , peerConnection : self ) , constraints : constraints ) < nl > + } < nl > + < nl > + func createOffer ( constraints : RTCMediaConstraints , didCreate : ( RTCSessionDescription ! , NSError ! ) - > ( ) ) { < nl > + createOfferWithDelegate ( AASessionDescriptionCreateDelegate ( didCreate : didCreate , peerConnection : self ) , constraints : constraints ) < nl > + } < nl > + < nl > + func setLocalDescription ( sdp : RTCSessionDescription , didSet : ( NSError ! ) - > ( ) ) { < nl > + setLocalDescriptionWithDelegate ( AASessionDescriptionSetDelegate ( didSet : didSet , peerConnection : self ) , sessionDescription : sdp ) < nl > + } < nl > + < nl > + func setRemoteDescription ( sdp : RTCSessionDescription , didSet : ( NSError ! ) - > ( ) ) { < nl > + setRemoteDescriptionWithDelegate ( AASessionDescriptionSetDelegate ( didSet : didSet , peerConnection : self ) , sessionDescription : sdp ) < nl > + } < nl > + } < nl > + < nl > + < nl > + < nl > + < nl > + < nl > diff - - git a / actor - sdk / sdk - core - ios / Podfile b / actor - sdk / sdk - core - ios / Podfile < nl > index 74047ee . . 4d64e4b 100644 < nl > - - - a / actor - sdk / sdk - core - ios / Podfile < nl > + + + b / actor - sdk / sdk - core - ios / Podfile < nl > @ @ - 22 , 12 + 22 , 15 @ @ target ' ActorApp ' do < nl > pod ' CocoaAsyncSocket ' < nl > pod ' zipzap ' < nl > pod ' YYKit ' < nl > + pod ' BrightFutures ' < nl > < nl > # Main UI < nl > pod ' TTTAttributedLabel ' < nl > pod ' RSKImageCropper ' < nl > pod ' JDStatusBarNotification ' < nl > pod ' Neon ' < nl > + pod ' Cartography ' < nl > + pod ' PureLayout ' < nl > < nl > # Small UI < nl > pod ' VBFPopFlatButton ' < nl > @ @ - 44 , 7 + 47 , 7 @ @ target ' ActorApp ' do < nl > pod ' PSTAlertController ' < nl > < nl > # Calls < nl > - pod ' libjingle _ peerconnection ' < nl > + # pod ' libjingle _ peerconnection ' < nl > end < nl > < nl > target ' ActorSDK ' do < nl > @ @ - 58 , 6 + 61 , 9 @ @ target ' ActorSDK ' do < nl > pod ' CocoaAsyncSocket ' < nl > pod ' zipzap ' < nl > pod ' YYKit ' < nl > + pod ' BrightFutures ' < nl > + pod ' Cartography ' < nl > + pod ' PureLayout ' < nl > < nl > # Main UI < nl > pod ' TTTAttributedLabel ' < nl > diff - - git a / actor - sdk / sdk - core / core / core - js / src / main / java / im / actor / core / js / providers / JsWebRTCProvider . java b / actor - sdk / sdk - core / core / core - js / src / main / java / im / actor / core / js / providers / JsWebRTCProvider . java < nl > index 510dfcd . . d0b7b19 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - js / src / main / java / im / actor / core / js / providers / JsWebRTCProvider . java < nl > + + + b / actor - sdk / sdk - core / core / core - js / src / main / java / im / actor / core / js / providers / JsWebRTCProvider . java < nl > @ @ - 3 , 6 + 3 , 8 @ @ package im . actor . core . js . providers ; < nl > import com . google . gwt . core . client . JavaScriptObject ; < nl > import com . google . gwt . core . client . JsArray ; < nl > < nl > + import org . jetbrains . annotations . NotNull ; < nl > + < nl > import im . actor . core . Messenger ; < nl > import im . actor . core . js . JsMessenger ; < nl > import im . actor . core . js . modules . JsScheduller ; < nl > @ @ - 35 , 7 + 37 , 7 @ @ public class JsWebRTCProvider implements WebRTCProvider { < nl > private long runningCallId ; < nl > < nl > @ Override < nl > - public void init ( Messenger messenger , WebRTCController controller ) { < nl > + public void init ( @ NotNull Messenger messenger , @ NotNull WebRTCController controller ) { < nl > this . controller = controller ; < nl > this . messenger = ( JsMessenger ) messenger ; < nl > } < nl > @ @ - 146 , 7 + 148 , 7 @ @ public class JsWebRTCProvider implements WebRTCProvider { < nl > } < nl > < nl > @ Override < nl > - public void onAnswerReceived ( final long callId , String offerSDP ) { < nl > + public void onAnswerReceived ( final long callId , @ NotNull String offerSDP ) { < nl > Log . d ( TAG , " onAnswerReceived " ) ; < nl > peerConnection . setRemoteDescription ( JsSessionDescription . createAnswer ( offerSDP ) ) . then ( new Consumer < JsSessionDescription > ( ) { < nl > @ Override < nl > @ @ - 167 , 7 + 169 , 7 @ @ public class JsWebRTCProvider implements WebRTCProvider { < nl > } < nl > < nl > @ Override < nl > - public void onOfferReceived ( final long callId , final String offerSDP ) { < nl > + public void onOfferReceived ( final long callId , @ NotNull final String offerSDP ) { < nl > Log . d ( TAG , " onOfferReceived " ) ; < nl > < nl > createPeerConnection ( callId ) ; < nl > @ @ - 222 , 7 + 224 , 7 @ @ public class JsWebRTCProvider implements WebRTCProvider { < nl > } < nl > < nl > @ Override < nl > - public void onCandidate ( long callId , String id , int label , String sdp ) { < nl > + public void onCandidate ( long callId , @ NotNull String id , int label , @ NotNull String sdp ) { < nl > Log . d ( TAG , " onCandidate " ) ; < nl > peerConnection . addIceCandidate ( label , sdp ) ; < nl > }

TEST DIFF:
diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / Providers / iOSWebRTCProvider . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / Providers / iOSWebRTCProvider . swift 
 index 7b32ab5 . . 23cf0f5 100644 
 - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / Providers / iOSWebRTCProvider . swift 
 + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / Providers / iOSWebRTCProvider . swift 
 @ @ - 4 , 178 + 4 , 190 @ @ 
 
 import Foundation 
 
 - class iOSWebRTCProvider : NSObject , ACWebRTCProvider { 
 - 
 - private var controller : ACWebRTCController ! 
 - private var messenger : ACMessenger ! 
 - 
 - private lazy var queue : dispatch _ queue _ t = dispatch _ queue _ create ( " webrtc _ queue " , DISPATCH _ QUEUE _ SERIAL ) 
 - private let peerConnectionFactory = RTCPeerConnectionFactory ( ) 
 - private let mediaConstraints = RTCMediaConstraints ( ) 
 - 
 - private var runningCallId : jlong ? 
 - private var peerConnection : RTCPeerConnection ! 
 - private var voiceCapture : RTCAudioTrack ! 
 - 
 - override init ( ) { 
 - RTCPeerConnectionFactory . initializeSSL ( ) 
 - } 
 - 
 - func initWithMessenger ( messenger : ACMessenger , withController controller : ACWebRTCController ) { 
 - self . controller = controller 
 - self . messenger = messenger 
 - } 
 - 
 - / / 
 - / / Start / End of calls 
 - / / 
 + class iOSWebRTCProvider : NSObject , ACCallsProvider { 
 
 func onIncomingCallWithCallId ( callId : jlong ) { 
 - dispatchSync ( ) { 
 - print ( " onIncomingCallWithCallId " ) 
 - self . runningCallId = callId 
 - dispatchOnUi ( ) { ( ) - > Void in 
 - let rootController = ActorSDK . sharedActor ( ) . bindedToWindow . rootViewController ! 
 - rootController . presentViewController ( AACallViewController ( callId : callId ) , animated : true , completion : nil ) 
 - } 
 - } 
 + 
 } 
 
 func onOutgoingCallWithCallId ( callId : jlong ) { 
 - dispatchSync ( ) { 
 - print ( " onOutgoingCallWithCallId " ) 
 - self . runningCallId = callId 
 - } 
 - } 
 - 
 - func onCallEndWithCallId ( callId : jlong ) { 
 - dispatchSync ( ) { 
 - if ( self . peerConnection ! = nil ) { 
 - self . peerConnection . close ( ) 
 - self . peerConnection = nil 
 - } 
 - self . voiceCapture = nil 
 - self . runningCallId = - 1 
 - } 
 - } 
 - 
 - / / 
 - / / In process 
 - / / 
 - 
 - private func createPeerConnection ( callId : jlong ) { 
 - / / 
 - / / Create Peer Connection 
 - / / 
 - let iceServers = [ 
 - RTCICEServer ( URI : NSURL ( string : " stun : 62 . 4 . 22 . 219 : 3478 " ) , username : " " , password : " " ) , 
 - RTCICEServer ( URI : NSURL ( string : " turn : 62 . 4 . 22 . 219 : 3478 ? transport = tcp " ) , username : " actor " , password : " password " ) , 
 - RTCICEServer ( URI : NSURL ( string : " turn : 62 . 4 . 22 . 219 : 3478 ? transport = udp " ) , username : " actor " , password : " password " ) 
 - ] 
 - peerConnection = peerConnectionFactory . peerConnectionWithICEServers ( iceServers , constraints : mediaConstraints , delegate : nil ) 
 
 - / / 
 - / / Crete Media Stream 
 - / / 
 - voiceCapture = peerConnectionFactory . audioTrackWithID ( " audio0 " ) 
 - let mediaStream = peerConnectionFactory . mediaStreamWithLabel ( " ARDAMSa0 " ) 
 - mediaStream . addAudioTrack ( voiceCapture ) 
 - peerConnection . addStream ( mediaStream ) 
 - 
 - / / 
 - / / Handling events from peer connection 
 - / / 
 - peerConnection . onCandidateReceived = { ( candidate ) in 
 - self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 - print ( " On Candidate arrived " ) 
 - self . controller . sendCandidateWithInt ( jint ( candidate . sdpMLineIndex ) , withNSString : candidate . sdpMid , withNSString : candidate . sdp ) 
 - } 
 - } 
 - peerConnection . onStreamAdded = { ( stream ) in 
 - self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 - print ( " On stream added " ) 
 - } 
 - } 
 - } 
 - 
 - func onOfferNeededWithCallId ( callId : jlong ) { 
 - self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 - print ( " onOfferNeededWithCallId " ) 
 - } 
 - } 
 - 
 - func onAnswerReceivedWithCallId ( callId : jlong , withSDP offerSDP : String ) { 
 - self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 - print ( " onAnswerReceivedWithCallId " ) 
 - } 
 } 
 
 - func onOfferReceivedWithCallId ( callId : jlong , withSDP offerSDP : String ) { 
 - 
 - / / 
 - / / Stages : 
 - / / 1 . Create Peer Connection 
 - / / 2 . Set Remote description 
 - / / 3 . Create Answer 
 - / / 4 . Set Local description from answer 
 - / / 5 . Send Answer and enable candidate receiving 
 - / / 
 + func onCallEndWithCallId ( callId : jlong ) { 
 
 - self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 - self . createPeerConnection ( callId ) 
 - self . peerConnection . setRemoteDescription ( RTCSessionDescription ( type : " offer " , sdp : offerSDP ) ) { ( error ) - > ( ) in 
 - self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 - if ( error = = nil ) { 
 - self . peerConnection . createAnswer ( self . mediaConstraints ) { ( sdp , error ) - > ( ) in 
 - self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 - if ( error = = nil ) { 
 - self . peerConnection . setLocalDescription ( sdp ) { ( error ) - > ( ) in 
 - self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 - if ( error = = nil ) { 
 - self . controller . sendAnswerWithNSString ( sdp . description ) 
 - self . controller . readyForCandidates ( ) 
 - } else { 
 - self . controller . endCall ( ) 
 - } 
 - } 
 - } 
 - } else { 
 - self . controller . endCall ( ) 
 - } 
 - } 
 - } 
 - } else { 
 - self . controller . endCall ( ) 
 - } 
 - } 
 - } 
 - } 
 } 
 
 - func onCandidateWithCallId ( callId : jlong , withId id _ : String , withLabel label : jint , withSDP sdp : String ) { 
 - dispatchAsync ( callId ) { ( ) - > ( ) in 
 - self . peerConnection . addICECandidate ( RTCICECandidate ( mid : id _ , index : Int ( label ) , sdp : sdp ) ) 
 - } 
 - } 
 - 
 - 
 - / / 
 - / / Dispatching 
 - / / 
 - 
 - private func dispatchSync ( closure : ( ) - > ( ) ) { 
 - dispatch _ sync ( queue ) { ( ) - > Void in 
 - closure ( ) 
 - } 
 - } 
 - 
 - private func dispatchAsync ( callId : jlong , closure : ( ) - > ( ) ) { 
 - if ( self . runningCallId = = callId ) { 
 - dispatch _ async ( queue ) { ( ) - > Void in 
 - if ( self . runningCallId = = callId ) { 
 - closure ( ) 
 - } 
 - } 
 - } 
 - } 
 + / / private var controller : ACWebRTCController ! 
 + / / private var messenger : ACMessenger ! 
 + / / 
 + / / private lazy var queue : dispatch _ queue _ t = dispatch _ queue _ create ( " webrtc _ queue " , DISPATCH _ QUEUE _ SERIAL ) 
 + / / private let peerConnectionFactory = RTCPeerConnectionFactory ( ) 
 + / / private let mediaConstraints = RTCMediaConstraints ( ) 
 + / / 
 + / / private var runningCallId : jlong ? 
 + / / private var peerConnection : RTCPeerConnection ! 
 + / / private var voiceCapture : RTCAudioTrack ! 
 + / / 
 + / / override init ( ) { 
 + / / RTCPeerConnectionFactory . initializeSSL ( ) 
 + / / } 
 + / / 
 + / / func initWithMessenger ( messenger : ACMessenger , withController controller : ACWebRTCController ) { 
 + / / self . controller = controller 
 + / / self . messenger = messenger 
 + / / } 
 + / / 
 + / / / / 
 + / / / / Start / End of calls 
 + / / / / 
 + / / 
 + / / func onIncomingCallWithCallId ( callId : jlong ) { 
 + / / dispatchSync ( ) { 
 + / / print ( " onIncomingCallWithCallId " ) 
 + / / self . runningCallId = callId 
 + / / dispatchOnUi ( ) { ( ) - > Void in 
 + / / let rootController = ActorSDK . sharedActor ( ) . bindedToWindow . rootViewController ! 
 + / / rootController . presentViewController ( AACallViewController ( callId : callId ) , animated : true , completion : nil ) 
 + / / } 
 + / / } 
 + / / } 
 + / / 
 + / / func onOutgoingCallWithCallId ( callId : jlong ) { 
 + / / dispatchSync ( ) { 
 + / / print ( " onOutgoingCallWithCallId " ) 
 + / / self . runningCallId = callId 
 + / / } 
 + / / } 
 + / / 
 + / / func onCallEndWithCallId ( callId : jlong ) { 
 + / / dispatchSync ( ) { 
 + / / if ( self . peerConnection ! = nil ) { 
 + / / self . peerConnection . close ( ) 
 + / / self . peerConnection = nil 
 + / / } 
 + / / self . voiceCapture = nil 
 + / / self . runningCallId = - 1 
 + / / } 
 + / / } 
 + / / 
 + / / / / 
 + / / / / In process 
 + / / / / 
 + / / 
 + / / private func createPeerConnection ( callId : jlong ) { 
 + / / / / 
 + / / / / Create Peer Connection 
 + / / / / 
 + / / let iceServers = [ 
 + / / RTCICEServer ( URI : NSURL ( string : " stun : 62 . 4 . 22 . 219 : 3478 " ) , username : " " , password : " " ) , 
 + / / RTCICEServer ( URI : NSURL ( string : " turn : 62 . 4 . 22 . 219 : 3478 ? transport = tcp " ) , username : " actor " , password : " password " ) , 
 + / / RTCICEServer ( URI : NSURL ( string : " turn : 62 . 4 . 22 . 219 : 3478 ? transport = udp " ) , username : " actor " , password : " password " ) 
 + / / ] 
 + / / peerConnection = peerConnectionFactory . peerConnectionWithICEServers ( iceServers , constraints : mediaConstraints , delegate : nil ) 
 + / / 
 + / / / / 
 + / / / / Crete Media Stream 
 + / / / / 
 + / / voiceCapture = peerConnectionFactory . audioTrackWithID ( " audio0 " ) 
 + / / let mediaStream = peerConnectionFactory . mediaStreamWithLabel ( " ARDAMSa0 " ) 
 + / / mediaStream . addAudioTrack ( voiceCapture ) 
 + / / peerConnection . addStream ( mediaStream ) 
 + / / 
 + / / / / 
 + / / / / Handling events from peer connection 
 + / / / / 
 + / / peerConnection . onCandidateReceived = { ( candidate ) in 
 + / / self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 + / / print ( " On Candidate arrived " ) 
 + / / self . controller . sendCandidateWithInt ( jint ( candidate . sdpMLineIndex ) , withNSString : candidate . sdpMid , withNSString : candidate . sdp ) 
 + / / } 
 + / / } 
 + / / peerConnection . onStreamAdded = { ( stream ) in 
 + / / self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 + / / print ( " On stream added " ) 
 + / / } 
 + / / } 
 + / / } 
 + / / 
 + / / func onOfferNeededWithCallId ( callId : jlong ) { 
 + / / self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 + / / print ( " onOfferNeededWithCallId " ) 
 + / / } 
 + / / } 
 + / / 
 + / / func onAnswerReceivedWithCallId ( callId : jlong , withSDP offerSDP : String ) { 
 + / / self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 + / / print ( " onAnswerReceivedWithCallId " ) 
 + / / } 
 + / / } 
 + / / 
 + / / func onOfferReceivedWithCallId ( callId : jlong , withSDP offerSDP : String ) { 
 + / / 
 + / / / / 
 + / / / / Stages : 
 + / / / / 1 . Create Peer Connection 
 + / / / / 2 . Set Remote description 
 + / / / / 3 . Create Answer 
 + / / / / 4 . Set Local description from answer 
 + / / / / 5 . Send Answer and enable candidate receiving 
 + / / / / 
 + / / 
 + / / self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 + / / self . createPeerConnection ( callId ) 
 + / / self . peerConnection . setRemoteDescription ( RTCSessionDescription ( type : " offer " , sdp : offerSDP ) ) { ( error ) - > ( ) in 
 + / / self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 + / / if ( error = = nil ) { 
 + / / self . peerConnection . createAnswer ( self . mediaConstraints ) { ( sdp , error ) - > ( ) in 
 + / / self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 + / / if ( error = = nil ) { 
 + / / self . peerConnection . setLocalDescription ( sdp ) { ( error ) - > ( ) in 
 + / / self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 + / / if ( error = = nil ) { 
 + / / self . controller . sendAnswerWithNSString ( sdp . description ) 
 + / / self . controller . readyForCandidates ( ) 
 + / / } else { 
 + / / self . controller . endCall ( ) 
 + / / } 
 + / / } 
 + / / } 
 + / / } else { 
 + / / self . controller . endCall ( ) 
 + / / } 
 + / / } 
 + / / } 
 + / / } else { 
 + / / self . controller . endCall ( ) 
 + / / } 
 + / / } 
 + / / } 
 + / / } 
 + / / } 
 + / / 
 + / / func onCandidateWithCallId ( callId : jlong , withId id _ : String , withLabel label : jint , withSDP sdp : String ) { 
 + / / dispatchAsync ( callId ) { ( ) - > ( ) in 
 + / / self . peerConnection . addICECandidate ( RTCICECandidate ( mid : id _ , index : Int ( label ) , sdp : sdp ) ) 
 + / / } 
 + / / } 
 + / / 
 + / / 
 + / / / / 
 + / / / / Dispatching 
 + / / / / 
 + / / 
 + / / private func dispatchSync ( closure : ( ) - > ( ) ) { 
 + / / dispatch _ sync ( queue ) { ( ) - > Void in 
 + / / closure ( ) 
 + / / } 
 + / / } 
 + / / 
 + / / private func dispatchAsync ( callId : jlong , closure : ( ) - > ( ) ) { 
 + / / if ( self . runningCallId = = callId ) { 
 + / / dispatch _ async ( queue ) { ( ) - > Void in 
 + / / if ( self . runningCallId = = callId ) { 
 + / / closure ( ) 
 + / / } 
 + / / } 
 + / / } 
 + / / } 
 } 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift 
 index 817ac61 . . ce2338b 100644 
 - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift 
 + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . swift 
 @ @ - 162 , 7 + 162 , 7 @ @ public class ActorSDK { 
 builder . setPhoneBookProvider ( PhoneBookProvider ( ) ) 
 builder . setNotificationProvider ( iOSNotificationProvider ( ) ) 
 if ( enableExperimentalFeatures ) { 
 - builder . setWebRTCProvider ( iOSWebRTCProvider ( ) ) 
 + builder . setCallsProvider ( iOSWebRTCProvider ( ) ) 
 } 
 
 / / Stats 
 diff - - git a / actor - sdk / sdk - core / core / core - cocoa / prefixes . properties b / actor - sdk / sdk - core / core / core - cocoa / prefixes . properties 
 index 22426d2 . . f4ee260 100644 
 - - - a / actor - sdk / sdk - core / core / core - cocoa / prefixes . properties 
 + + + b / actor - sdk / sdk - core / core / core - cocoa / prefixes . properties 
 @ @ - 38 , 9 + 38 , 7 @ @ im . actor . core . modules . internal . state : AC 
 im . actor . core . modules . internal . typing : AC 
 im . actor . core . modules . internal . users : AC 
 
 - im . actor . core . webrtc : AC 
 - im . actor . core . notifications : AC 
 - im . actor . core . phonebook : AC 
 + im . actor . core . providers : AC 
 
 im . actor . core . i18n : AC 
 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java 
 index feeca5f . . b5fa71f 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / CallManagerActor . java 
 @ @ - 34 , 7 + 34 , 7 @ @ public class CallManagerActor extends ModuleActor { 
 
 private HashSet < Long > pendingRequests = new HashSet < > ( ) ; 
 
 - private WebRTCControllerImpl webRTCController ; 
 + / / private WebRTCControllerImpl webRTCController ; 
 private CallsProvider provider ; 
 private boolean isStartedKeepAlive = false ; 
 
 @ @ - 52 , 9 + 52 , 9 @ @ public class CallManagerActor extends ModuleActor { 
 public void preStart ( ) { 
 super . preStart ( ) ; 
 
 - webRTCController = new WebRTCControllerImpl ( self ( ) ) ; 
 + / / webRTCController = new WebRTCControllerImpl ( self ( ) ) ; 
 provider = config ( ) . getCallsProvider ( ) ; 
 - provider . init ( context ( ) . getMessenger ( ) , webRTCController ) ; 
 + / / provider . init ( context ( ) . getMessenger ( ) , webRTCController ) ; 
 } 
 
 
 @ @ - 74 , 22 + 74 , 22 @ @ public class CallManagerActor extends ModuleActor { 
 private void onIncomingCall ( long callId ) { 
 Log . d ( TAG , " onIncomingCall ( " + callId + " ) " ) ; 
 
 - if ( webRTCController . getCallId ( ) = = - 1 ) { 
 - webRTCController . switchCallId ( callId ) ; 
 - pendingRequests . clear ( ) ; 
 - pendingCandidates . clear ( ) ; 
 - isReadyReceiveCandidates = false ; 
 - isStartedKeepAlive = false ; 
 - isOfferRequested = true ; / / No outgoing offer needed for ingoing call 
 - isOfferReceived = false ; 
 - isAnswerReceived = true ; / / No incoming answers needed for ingoing call 
 - 
 - / / ArrayList < Integer > members = new ArrayList < > ( ) ; 
 - / / members . add ( myUid ( ) ) ; 
 - / / members . add ( uid ) ; 
 - / / context ( ) . getCallsModule ( ) . spawnNewModel ( callId , Peer . user ( uid ) , members , CallState . CALLING _ INCOMING ) ; 
 - / / provider . onIncomingCall ( callId ) ; 
 - } 
 + / / if ( webRTCController . getCallId ( ) = = - 1 ) { 
 + / / webRTCController . switchCallId ( callId ) ; 
 + / / pendingRequests . clear ( ) ; 
 + / / pendingCandidates . clear ( ) ; 
 + / / isReadyReceiveCandidates = false ; 
 + / / isStartedKeepAlive = false ; 
 + / / isOfferRequested = true ; / / No outgoing offer needed for ingoing call 
 + / / isOfferReceived = false ; 
 + / / isAnswerReceived = true ; / / No incoming answers needed for ingoing call 
 + / / 
 + / / / / ArrayList < Integer > members = new ArrayList < > ( ) ; 
 + / / / / members . add ( myUid ( ) ) ; 
 + / / / / members . add ( uid ) ; 
 + / / / / context ( ) . getCallsModule ( ) . spawnNewModel ( callId , Peer . user ( uid ) , members , CallState . CALLING _ INCOMING ) ; 
 + / / / / provider . onIncomingCall ( callId ) ; 
 + / / } 
 } 
 
 private void onIncomingCallHandled ( long callId ) { 
 @ @ - 99 , 21 + 99 , 21 @ @ public class CallManagerActor extends ModuleActor { 
 private void onOutgoingCall ( long callId , int uid ) { 
 Log . d ( TAG , " onOutgoingCall ( " + callId + " , " + uid + " ) " ) ; 
 
 - if ( webRTCController . getCallId ( ) = = - 1 ) { 
 - webRTCController . switchCallId ( callId ) ; 
 - pendingRequests . clear ( ) ; 
 - pendingCandidates . clear ( ) ; 
 - isReadyReceiveCandidates = false ; 
 - isStartedKeepAlive = false ; 
 - isOfferRequested = false ; 
 - isOfferReceived = true ; / / No offers needed for outgoing call 
 - isAnswerReceived = false ; 
 - ArrayList < Integer > members = new ArrayList < > ( ) ; 
 - members . add ( myUid ( ) ) ; 
 - members . add ( uid ) ; 
 - context ( ) . getCallsModule ( ) . spawnNewModel ( callId , Peer . user ( uid ) , members , CallState . CALLING _ OUTGOING ) ; 
 - provider . onOutgoingCall ( callId ) ; 
 - } 
 + / / if ( webRTCController . getCallId ( ) = = - 1 ) { 
 + / / webRTCController . switchCallId ( callId ) ; 
 + / / pendingRequests . clear ( ) ; 
 + / / pendingCandidates . clear ( ) ; 
 + / / isReadyReceiveCandidates = false ; 
 + / / isStartedKeepAlive = false ; 
 + / / isOfferRequested = false ; 
 + / / isOfferReceived = true ; / / No offers needed for outgoing call 
 + / / isAnswerReceived = false ; 
 + / / ArrayList < Integer > members = new ArrayList < > ( ) ; 
 + / / members . add ( myUid ( ) ) ; 
 + / / members . add ( uid ) ; 
 + / / context ( ) . getCallsModule ( ) . spawnNewModel ( callId , Peer . user ( uid ) , members , CallState . CALLING _ OUTGOING ) ; 
 + / / provider . onOutgoingCall ( callId ) ; 
 + / / } 
 } 
 
 private void doAnswerCall ( final long callId ) { 
 @ @ - 136 , 12 + 136 , 12 @ @ public class CallManagerActor extends ModuleActor { 
 } 
 
 private void doStartKeepAlive ( long callId ) { 
 - if ( webRTCController . getCallId ( ) = = callId ) { 
 - if ( ! isStartedKeepAlive ) { 
 - isStartedKeepAlive = true ; 
 - self ( ) . send ( new DoKeepAlive ( callId ) ) ; 
 - } 
 - } 
 + / / if ( webRTCController . getCallId ( ) = = callId ) { 
 + / / if ( ! isStartedKeepAlive ) { 
 + / / isStartedKeepAlive = true ; 
 + / / self ( ) . send ( new DoKeepAlive ( callId ) ) ; 
 + / / } 
 + / / } 
 } 
 
 
 @ @ - 150 , 51 + 150 , 51 @ @ public class CallManagerActor extends ModuleActor { 
 / / 
 
 private void onReadyReceiveCandidates ( long callId ) { 
 - Log . d ( TAG , " onReadyReceiveCandidates ( " + callId + " ) " ) ; 
 - if ( webRTCController . getCallId ( ) = = callId ) { 
 - if ( ! isReadyReceiveCandidates ) { 
 - isReadyReceiveCandidates = true ; 
 - for ( Candidate c : pendingCandidates ) { 
 - provider . onCandidate ( callId , c . getId ( ) , c . getLabel ( ) , c . getSdp ( ) ) ; 
 - } 
 - pendingCandidates . clear ( ) ; 
 - } 
 - } 
 + / / Log . d ( TAG , " onReadyReceiveCandidates ( " + callId + " ) " ) ; 
 + / / if ( webRTCController . getCallId ( ) = = callId ) { 
 + / / if ( ! isReadyReceiveCandidates ) { 
 + / / isReadyReceiveCandidates = true ; 
 + / / for ( Candidate c : pendingCandidates ) { 
 + / / provider . onCandidate ( callId , c . getId ( ) , c . getLabel ( ) , c . getSdp ( ) ) ; 
 + / / } 
 + / / pendingCandidates . clear ( ) ; 
 + / / } 
 + / / } 
 } 
 
 private void onSignaling ( long callId , byte [ ] message ) { 
 - Log . d ( TAG , " onSignaling ( " + callId + " ) " ) ; 
 - if ( webRTCController . getCallId ( ) = = callId ) { 
 - AbsSignal signal = AbsSignal . fromBytes ( message ) ; 
 - if ( signal = = null ) { 
 - return ; 
 - } 
 - 
 - if ( signal instanceof OfferSignal ) { 
 - OfferSignal offer = ( OfferSignal ) signal ; 
 - if ( ! isOfferReceived ) { 
 - isOfferReceived = true ; 
 - context ( ) . getCallsModule ( ) . getCall ( callId ) . getCallStarted ( ) . change ( im . actor . runtime . Runtime . getCurrentTime ( ) ) ; 
 - context ( ) . getCallsModule ( ) . getCall ( callId ) . getState ( ) . change ( CallState . IN _ PROGRESS ) ; 
 - provider . onOfferReceived ( callId , offer . getSdp ( ) ) ; 
 - } 
 - } else if ( signal instanceof AnswerSignal ) { 
 - AnswerSignal answer = ( AnswerSignal ) signal ; 
 - if ( ! isAnswerReceived ) { 
 - isAnswerReceived = true ; 
 - provider . onAnswerReceived ( callId , answer . getSdp ( ) ) ; 
 - } 
 - } else if ( signal instanceof CandidateSignal ) { 
 - CandidateSignal candidateSignal = ( CandidateSignal ) signal ; 
 - if ( ! isReadyReceiveCandidates ) { 
 - pendingCandidates . add ( new Candidate ( candidateSignal . getLabel ( ) , 
 - candidateSignal . getId ( ) , candidateSignal . getSdp ( ) ) ) ; 
 - } else { 
 - provider . onCandidate ( callId , candidateSignal . getId ( ) , 
 - candidateSignal . getLabel ( ) , candidateSignal . getSdp ( ) ) ; 
 - } 
 - } 
 - } 
 + / / Log . d ( TAG , " onSignaling ( " + callId + " ) " ) ; 
 + / / if ( webRTCController . getCallId ( ) = = callId ) { 
 + / / AbsSignal signal = AbsSignal . fromBytes ( message ) ; 
 + / / if ( signal = = null ) { 
 + / / return ; 
 + / / } 
 + / / 
 + / / if ( signal instanceof OfferSignal ) { 
 + / / OfferSignal offer = ( OfferSignal ) signal ; 
 + / / if ( ! isOfferReceived ) { 
 + / / isOfferReceived = true ; 
 + / / context ( ) . getCallsModule ( ) . getCall ( callId ) . getCallStarted ( ) . change ( im . actor . runtime . Runtime . getCurrentTime ( ) ) ; 
 + / / context ( ) . getCallsModule ( ) . getCall ( callId ) . getState ( ) . change ( CallState . IN _ PROGRESS ) ; 
 + / / provider . onOfferReceived ( callId , offer . getSdp ( ) ) ; 
 + / / } 
 + / / } else if ( signal instanceof AnswerSignal ) { 
 + / / AnswerSignal answer = ( AnswerSignal ) signal ; 
 + / / if ( ! isAnswerReceived ) { 
 + / / isAnswerReceived = true ; 
 + / / provider . onAnswerReceived ( callId , answer . getSdp ( ) ) ; 
 + / / } 
 + / / } else if ( signal instanceof CandidateSignal ) { 
 + / / CandidateSignal candidateSignal = ( CandidateSignal ) signal ; 
 + / / if ( ! isReadyReceiveCandidates ) { 
 + / / pendingCandidates . add ( new Candidate ( candidateSignal . getLabel ( ) , 
 + / / candidateSignal . getId ( ) , candidateSignal . getSdp ( ) ) ) ; 
 + / / } else { 
 + / / provider . onCandidate ( callId , candidateSignal . getId ( ) , 
 + / / candidateSignal . getLabel ( ) , candidateSignal . getSdp ( ) ) ; 
 + / / } 
 + / / } 
 + / / } 
 } 
 
 private void doSendSignal ( long callId , AbsSignal signal ) { 
 @ @ - 213 , 17 + 213 , 17 @ @ public class CallManagerActor extends ModuleActor { 
 } 
 
 private void onKeepAlive ( long callId , int timeout ) { 
 - if ( webRTCController . getCallId ( ) = = callId ) { 
 - if ( ! isOfferRequested ) { 
 - isOfferRequested = true ; 
 - context ( ) . getCallsModule ( ) . getCall ( callId ) . getCallStarted ( ) . change ( im . actor . runtime . Runtime . getCurrentTime ( ) ) ; 
 - context ( ) . getCallsModule ( ) . getCall ( callId ) . getState ( ) . change ( CallState . IN _ PROGRESS ) ; 
 - provider . onOfferNeeded ( callId ) ; 
 - } 
 - 
 - 
 - / / TODO : Auto kill call on timeout 
 - } 
 + / / if ( webRTCController . getCallId ( ) = = callId ) { 
 + / / if ( ! isOfferRequested ) { 
 + / / isOfferRequested = true ; 
 + / / context ( ) . getCallsModule ( ) . getCall ( callId ) . getCallStarted ( ) . change ( im . actor . runtime . Runtime . getCurrentTime ( ) ) ; 
 + / / context ( ) . getCallsModule ( ) . getCall ( callId ) . getState ( ) . change ( CallState . IN _ PROGRESS ) ; 
 + / / provider . onOfferNeeded ( callId ) ; 
 + / / } 
 + / / 
 + / / 
 + / / / / TODO : Auto kill call on timeout 
 + / / } 
 } 
 
 / / 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / WebRTCControllerImpl . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / WebRTCControllerImpl . java 
 deleted file mode 100644 
 index 7412942 . . 0000000 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / calls / WebRTCControllerImpl . java 
 + + + / dev / null 
 @ @ - 1 , 71 + 0 , 0 @ @ 
 - package im . actor . core . modules . calls ; 
 - 
 - import im . actor . core . entity . signals . AnswerSignal ; 
 - import im . actor . core . entity . signals . CandidateSignal ; 
 - import im . actor . core . entity . signals . OfferSignal ; 
 - import im . actor . core . webrtc . WebRTCController ; 
 - import im . actor . runtime . actors . ActorRef ; 
 - 
 - public class WebRTCControllerImpl implements WebRTCController { 
 - 
 - private long callId = - 1 ; 
 - private ActorRef ref ; 
 - 
 - public WebRTCControllerImpl ( ActorRef ref ) { 
 - this . ref = ref ; 
 - } 
 - 
 - public long getCallId ( ) { 
 - return callId ; 
 - } 
 - 
 - public void switchCallId ( long callId ) { 
 - this . callId = callId ; 
 - } 
 - 
 - public void clearCallId ( ) { 
 - this . callId = - 1 ; 
 - } 
 - 
 - @ Override 
 - public void answerCall ( ) { 
 - if ( callId ! = - 1 ) { 
 - ref . send ( new CallManagerActor . AnswerCall ( callId ) ) ; 
 - } 
 - } 
 - 
 - @ Override 
 - public void sendCandidate ( int label , String id , String sdp ) { 
 - if ( callId ! = - 1 ) { 
 - ref . send ( new CallManagerActor . SendSignaling ( callId , new CandidateSignal ( id , label , sdp ) ) ) ; 
 - } 
 - } 
 - 
 - @ Override 
 - public void sendOffer ( String sdp ) { 
 - if ( callId ! = - 1 ) { 
 - ref . send ( new CallManagerActor . SendSignaling ( callId , new OfferSignal ( sdp ) ) ) ; 
 - } 
 - } 
 - 
 - @ Override 
 - public void sendAnswer ( String sdp ) { 
 - if ( callId ! = - 1 ) { 
 - ref . send ( new CallManagerActor . SendSignaling ( callId , new AnswerSignal ( sdp ) ) ) ; 
 - } 
 - } 
 - 
 - @ Override 
 - public void readyForCandidates ( ) { 
 - if ( callId ! = - 1 ) { 
 - ref . send ( new CallManagerActor . ReadyForCandidates ( callId ) ) ; 
 - } 
 - } 
 - 
 - @ Override 
 - public void endCall ( ) { 
 - if ( callId ! = - 1 ) { 
 - ref . send ( new CallManagerActor . EndCall ( callId ) ) ; 
 - } 
 - } 
 - } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / eventbus / EventBusActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / eventbus / EventBusActor . java 
 index 65bf90e . . 93b769c 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / eventbus / EventBusActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / eventbus / EventBusActor . java 
 @ @ - 17 , 7 + 17 , 7 @ @ import im . actor . runtime . function . Consumer ; 
 
 public class EventBusActor extends ModuleActor { 
 
 - private static final long TIMEOUT = 10000 ; 
 + private static final long TIMEOUT = 15000 ; 
 private static final long KEEP _ ALIVE = 5000 ; 
 
 private boolean isProcessing ; 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / eventbus / EventBusModule . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / eventbus / EventBusModule . java 
 index 45a60d0 . . 641eff4 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / eventbus / EventBusModule . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / eventbus / EventBusModule . java 
 @ @ - 3 , 13 + 3 , 18 @ @ package im . actor . core . modules . eventbus ; 
 import java . util . ArrayList ; 
 import java . util . HashMap ; 
 
 + import im . actor . core . api . updates . UpdateEventBusDeviceConnected ; 
 + import im . actor . core . api . updates . UpdateEventBusDeviceDisconnected ; 
 + import im . actor . core . api . updates . UpdateEventBusDisposed ; 
 + import im . actor . core . api . updates . UpdateEventBusMessage ; 
 import im . actor . core . modules . AbsModule ; 
 import im . actor . core . modules . ModuleContext ; 
 import im . actor . runtime . actors . ActorRef ; 
 
 public class EventBusModule extends AbsModule { 
 
 - private HashMap < String , ArrayList < ActorRef > > subscribers = new HashMap < > ( ) ; 
 + private HashMap < String , ActorRef > subscribers = new HashMap < > ( ) ; 
 + private HashMap < String , ArrayList < Object > > pendingMessages = new HashMap < > ( ) ; 
 
 public EventBusModule ( ModuleContext context ) { 
 super ( context ) ; 
 @ @ - 20 , 19 + 25 , 72 @ @ public class EventBusModule extends AbsModule { 
 } 
 
 public synchronized void subscribe ( String busId , ActorRef ref ) { 
 - if ( ! subscribers . containsKey ( busId ) ) { 
 - subscribers . put ( busId , new ArrayList < ActorRef > ( ) ) ; 
 + subscribers . put ( busId , ref ) ; 
 + if ( pendingMessages . containsKey ( busId ) ) { 
 + for ( Object o : pendingMessages . get ( busId ) ) { 
 + onEventBusUpdate ( o ) ; 
 + } 
 + pendingMessages . remove ( busId ) ; 
 } 
 - subscribers . get ( busId ) . add ( ref ) ; 
 } 
 
 public synchronized void unsubscribe ( String busId , ActorRef ref ) { 
 - if ( subscribers . containsKey ( busId ) ) { 
 - subscribers . get ( busId ) . remove ( ref ) ; 
 + if ( subscribers . get ( busId ) = = ref ) { 
 + subscribers . remove ( busId ) ; 
 } 
 } 
 
 public synchronized void onEventBusUpdate ( Object update ) { 
 - 
 + if ( update instanceof UpdateEventBusMessage ) { 
 + UpdateEventBusMessage busMessage = ( UpdateEventBusMessage ) update ; 
 + ActorRef dest = subscribers . get ( busMessage . getId ( ) ) ; 
 + if ( dest ! = null ) { 
 + dest . send ( new EventBusActor . EventBusMessage ( 
 + busMessage . getSenderId ( ) , 
 + busMessage . getSenderDeviceId ( ) , 
 + busMessage . getMessage ( ) ) ) ; 
 + } else { 
 + if ( ! pendingMessages . containsKey ( busMessage . getId ( ) ) ) { 
 + pendingMessages . put ( busMessage . getId ( ) , new ArrayList < > ( ) ) ; 
 + } 
 + pendingMessages . get ( busMessage . getId ( ) ) . add ( update ) ; 
 + } 
 + } else if ( update instanceof UpdateEventBusDeviceConnected ) { 
 + UpdateEventBusDeviceConnected deviceConnected = ( UpdateEventBusDeviceConnected ) update ; 
 + ActorRef dest = subscribers . get ( deviceConnected . getId ( ) ) ; 
 + if ( dest ! = null ) { 
 + dest . send ( new EventBusActor . EventBusDeviceConnected ( 
 + deviceConnected . getUserId ( ) , 
 + deviceConnected . getDeviceId ( ) ) ) ; 
 + } else { 
 + if ( ! pendingMessages . containsKey ( deviceConnected . getId ( ) ) ) { 
 + pendingMessages . put ( deviceConnected . getId ( ) , new ArrayList < > ( ) ) ; 
 + } 
 + pendingMessages . get ( deviceConnected . getId ( ) ) . add ( update ) ; 
 + } 
 + } else if ( update instanceof UpdateEventBusDeviceDisconnected ) { 
 + UpdateEventBusDeviceDisconnected deviceDisconnected = ( UpdateEventBusDeviceDisconnected ) update ; 
 + ActorRef dest = subscribers . get ( deviceDisconnected . getId ( ) ) ; 
 + if ( dest ! = null ) { 
 + dest . send ( new EventBusActor . EventBusDeviceDisconnected ( deviceDisconnected . getUserId ( ) , 
 + deviceDisconnected . getDeviceId ( ) ) ) ; 
 + } else { 
 + if ( ! pendingMessages . containsKey ( deviceDisconnected . getId ( ) ) ) { 
 + pendingMessages . put ( deviceDisconnected . getId ( ) , new ArrayList < > ( ) ) ; 
 + } 
 + pendingMessages . get ( deviceDisconnected . getId ( ) ) . add ( update ) ; 
 + } 
 + } else if ( update instanceof UpdateEventBusDisposed ) { 
 + UpdateEventBusDisposed disposed = ( UpdateEventBusDisposed ) update ; 
 + ActorRef dest = subscribers . get ( disposed . getId ( ) ) ; 
 + if ( dest ! = null ) { 
 + dest . send ( new EventBusActor . EventBusDisposed ( ) ) ; 
 + } else { 
 + if ( ! pendingMessages . containsKey ( disposed . getId ( ) ) ) { 
 + pendingMessages . put ( disposed . getId ( ) , new ArrayList < > ( ) ) ; 
 + } 
 + pendingMessages . get ( disposed . getId ( ) ) . add ( update ) ; 
 + } 
 + } 
 } 
 } 
 diff - - git a / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / java / im / actor / runtime / WebRTCRuntimeProvider . java b / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / java / im / actor / runtime / WebRTCRuntimeProvider . java 
 new file mode 100644 
 index 0000000 . . fc85a61 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / java / im / actor / runtime / WebRTCRuntimeProvider . java 
 @ @ - 0 , 0 + 1 , 7 @ @ 
 + package im . actor . runtime ; 
 + 
 + import im . actor . runtime . cocoa . CocoaWebRTCProxyProvider ; 
 + 
 + public class WebRTCRuntimeProvider extends CocoaWebRTCProxyProvider { 
 + 
 + } 
 diff - - git a / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / java / im / actor / runtime / cocoa / CocoaWebRTCProxyProvider . java b / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / java / im / actor / runtime / cocoa / CocoaWebRTCProxyProvider . java 
 new file mode 100644 
 index 0000000 . . 6fc0a27 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / java / im / actor / runtime / cocoa / CocoaWebRTCProxyProvider . java 
 @ @ - 0 , 0 + 1 , 24 @ @ 
 + package im . actor . runtime . cocoa ; 
 + 
 + import com . google . j2objc . annotations . ObjectiveCName ; 
 + 
 + import im . actor . runtime . WebRTCRuntime ; 
 + import im . actor . runtime . webrtc . WebRTCPeerConnection ; 
 + 
 + public class CocoaWebRTCProxyProvider implements WebRTCRuntime { 
 + 
 + private static WebRTCRuntime rtcRuntime ; 
 + 
 + @ ObjectiveCName ( " setWebRTCRuntime : " ) 
 + public static void setWebRTCRuntime ( WebRTCRuntime rtcRuntime ) { 
 + CocoaWebRTCProxyProvider . rtcRuntime = rtcRuntime ; 
 + } 
 + 
 + @ Override 
 + public WebRTCPeerConnection createPeerConnection ( ) { 
 + if ( rtcRuntime = = null ) { 
 + throw new RuntimeException ( " Storage Runtime not set " ) ; 
 + } 
 + return rtcRuntime . createPeerConnection ( ) ; 
 + } 
 + } 
 diff - - git a / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / prefixes . properties b / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / prefixes . properties 
 index aab82d6 . . 079eb39 100644 
 - - - a / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / prefixes . properties 
 + + + b / actor - sdk / sdk - core / runtime / runtime - cocoa / src / main / prefixes . properties 
 @ @ - 37 , 6 + 37 , 9 @ @ im . actor . runtime . json : AR 
 
 im . actor . runtime . mtproto : AR 
 
 + im . actor . runtime . webrtc : AR 
 + im . actor . runtime . webrtc . sdp : AR 
 + 
 im . actor . runtime . mvvm : AR 
 
 im . actor . runtime . markdown : AR

NEAREST DIFF:
diff - - git a / actor - sdk / sdk - core - ios / ActorSDK . xcodeproj / project . pbxproj b / actor - sdk / sdk - core - ios / ActorSDK . xcodeproj / project . pbxproj 
 index 418ff2b . . da865bb 100644 
 - - - a / actor - sdk / sdk - core - ios / ActorSDK . xcodeproj / project . pbxproj 
 + + + b / actor - sdk / sdk - core - ios / ActorSDK . xcodeproj / project . pbxproj 
 @ @ - 173 , 6 + 173 , 9 @ @ 
 	 	 06CE898C1BD841C9005A5530 / * SystemConfiguration . framework in Frameworks * / = { isa = PBXBuildFile ; fileRef = 06CE898B1BD841C9005A5530 / * SystemConfiguration . framework * / ; } ; 
 	 	 06CE89901BD84DF5005A5530 / * ActorSDKAnalytics . swift in Sources * / = { isa = PBXBuildFile ; fileRef = 06CE898F1BD84DF5005A5530 / * ActorSDKAnalytics . swift * / ; } ; 
 	 	 06E322C91C69344A00D66F53 / * iOSWebRTCProvider . swift in Sources * / = { isa = PBXBuildFile ; fileRef = 06E322C81C69344A00D66F53 / * iOSWebRTCProvider . swift * / ; } ; 
 + 	 	 06E3230E1C69445C00D66F53 / * WebRTC . h in Headers * / = { isa = PBXBuildFile ; fileRef = 06E3230D1C6942C400D66F53 / * WebRTC . h * / ; settings = { ATTRIBUTES = ( Public , ) ; } ; } ; 
 + 	 	 06E323111C694C1D00D66F53 / * WebRTCExt . swift in Sources * / = { isa = PBXBuildFile ; fileRef = 06E323101C694C1D00D66F53 / * WebRTCExt . swift * / ; } ; 
 + 	 	 06E323151C6A7AC000D66F53 / * AACallViewController . swift in Sources * / = { isa = PBXBuildFile ; fileRef = 06E323141C6A7AC000D66F53 / * AACallViewController . swift * / ; } ; 
 	 	 06E7B2471C0F8D7A0090660C / * AALocationPickerController . swift in Sources * / = { isa = PBXBuildFile ; fileRef = 06E7B2461C0F8D7A0090660C / * AALocationPickerController . swift * / ; } ; 
 	 	 06E7B24A1C0F92140090660C / * AABubbleLocationCell . swift in Sources * / = { isa = PBXBuildFile ; fileRef = 06E7B2491C0F92140090660C / * AABubbleLocationCell . swift * / ; } ; 
 	 	 06E7B24C1C0FAB500090660C / * AAMapFastView . swift in Sources * / = { isa = PBXBuildFile ; fileRef = 06E7B24B1C0FAB500090660C / * AAMapFastView . swift * / ; } ; 
 @ @ - 467 , 6 + 470 , 9 @ @ 
 	 	 06CE898B1BD841C9005A5530 / * SystemConfiguration . framework * / = { isa = PBXFileReference ; lastKnownFileType = wrapper . framework ; name = SystemConfiguration . framework ; path = System / Library / Frameworks / SystemConfiguration . framework ; sourceTree = SDKROOT ; } ; 
 	 	 06CE898F1BD84DF5005A5530 / * ActorSDKAnalytics . swift * / = { isa = PBXFileReference ; fileEncoding = 4 ; lastKnownFileType = sourcecode . swift ; path = ActorSDKAnalytics . swift ; sourceTree = " < group > " ; } ; 
 	 	 06E322C81C69344A00D66F53 / * iOSWebRTCProvider . swift * / = { isa = PBXFileReference ; fileEncoding = 4 ; lastKnownFileType = sourcecode . swift ; path = iOSWebRTCProvider . swift ; sourceTree = " < group > " ; } ; 
 + 	 	 06E3230D1C6942C400D66F53 / * WebRTC . h * / = { isa = PBXFileReference ; lastKnownFileType = sourcecode . c . h ; path = WebRTC . h ; sourceTree = " < group > " ; } ; 
 + 	 	 06E323101C694C1D00D66F53 / * WebRTCExt . swift * / = { isa = PBXFileReference ; fileEncoding = 4 ; lastKnownFileType = sourcecode . swift ; path = WebRTCExt . swift ; sourceTree = " < group > " ; } ; 
 + 	 	 06E323141C6A7AC000D66F53 / * AACallViewController . swift * / = { isa = PBXFileReference ; fileEncoding = 4 ; lastKnownFileType = sourcecode . swift ; name = AACallViewController . swift ; path = Calls / AACallViewController . swift ; sourceTree = " < group > " ; } ; 
 	 	 06E7B2461C0F8D7A0090660C / * AALocationPickerController . swift * / = { isa = PBXFileReference ; fileEncoding = 4 ; lastKnownFileType = sourcecode . swift ; path = AALocationPickerController . swift ; sourceTree = " < group > " ; } ; 
 	 	 06E7B2491C0F92140090660C / * AABubbleLocationCell . swift * / = { isa = PBXFileReference ; fileEncoding = 4 ; lastKnownFileType = sourcecode . swift ; path = AABubbleLocationCell . swift ; sourceTree = " < group > " ; } ; 
 	 	 06E7B24B1C0FAB500090660C / * AAMapFastView . swift * / = { isa = PBXFileReference ; fileEncoding = 4 ; lastKnownFileType = sourcecode . swift ; path = AAMapFastView . swift ; sourceTree = " < group > " ; } ; 
 @ @ - 847 , 6 + 853 , 7 @ @ 
 	 	 	 	 066A527B1BC51EC6000E606E / * Root * / , 
 	 	 	 	 066A52EB1BC52AF8000E606E / * Settings * / , 
 	 	 	 	 066A53091BC53197000E606E / * User * / , 
 + 	 	 	 	 06E323131C6A7AA300D66F53 / * Calls * / , 
 	 	 	 ) ; 
 	 	 	 path = Controllers ; 
 	 	 	 sourceTree = " < group > " ; 
 @ @ - 1150 , 6 + 1157 , 8 @ @ 
 	 	 	 isa = PBXGroup ; 
 	 	 	 children = ( 
 	 	 	 	 15D35F0A1C20182900E3717A / * AudioRecorder * / , 
 + 	 	 	 	 06E3230D1C6942C400D66F53 / * WebRTC . h * / , 
 + 	 	 	 	 06E323101C694C1D00D66F53 / * WebRTCExt . swift * / , 
 	 	 	 ) ; 
 	 	 	 name = Libs ; 
 	 	 	 sourceTree = " < group > " ; 
 @ @ - 1161 , 6 + 1170 , 14 @ @ 
 	 	 	 name = Libs ; 
 	 	 	 sourceTree = " < group > " ; 
 	 	 } ; 
 + 	 	 06E323131C6A7AA300D66F53 / * Calls * / = { 
 + 	 	 	 isa = PBXGroup ; 
 + 	 	 	 children = ( 
 + 	 	 	 	 06E323141C6A7AC000D66F53 / * AACallViewController . swift * / , 
 + 	 	 	 ) ; 
 + 	 	 	 name = Calls ; 
 + 	 	 	 sourceTree = " < group > " ; 
 + 	 	 } ; 
 	 	 06E7B2451C0F8D410090660C / * Location * / = { 
 	 	 	 isa = PBXGroup ; 
 	 	 	 children = ( 
 @ @ - 1535 , 6 + 1552 , 7 @ @ 
 	 	 	 	 15F89F0A1C211FED00776ACD / * opus . h in Headers * / , 
 	 	 	 	 15D35F511C20187E00E3717A / * ASQueue . h in Headers * / , 
 	 	 	 	 15D35F1D1C20185500E3717A / * picture . h in Headers * / , 
 + 	 	 	 	 06E3230E1C69445C00D66F53 / * WebRTC . h in Headers * / , 
 	 	 	 	 06230F421BC95BD200A4807B / * RMPhoneFormat . h in Headers * / , 
 	 	 	 	 069CF4CE1BCB909A00C66E12 / * CLToken . h in Headers * / , 
 	 	 	 ) ; 
 @ @ - 1645 , 7 + 1663 , 7 @ @ 
 	 	 	 ) ; 
 	 	 	 runOnlyForDeploymentPostprocessing = 0 ; 
 	 	 	 shellPath = / bin / sh ; 
 - 	 	 	 shellScript = " set - e \ n \ ncd ActorSDK / Sources / ActorCore \ nmake translate \ nmake build - j3 \ n \ ncd \ " $ { CONFIGURATION _ TEMP _ DIR } / j2objc / \ " \ npython \ " $ { PROJECT _ DIR } / ActorSDK / Sources / ActorCore / convert . py \ " \ " $ { PROJECT _ DIR } / ActorSDK / Sources / ActorCore / ActorCore . h \ " \ n \ ncp - a \ " $ { CONFIGURATION _ TEMP _ DIR } / j2objc / Public / \ " \ " $ { CONFIGURATION _ BUILD _ DIR } / ActorSDK . framework / Headers / \ " \ n \ ncp - a \ " $ { PROJECT _ DIR } / . . / sdk - core / core / core - shared / src / main / resources / \ " \ " $ { CONFIGURATION _ BUILD _ DIR } / ActorSDK . framework / \ " " ; 
 + 	 	 	 shellScript = " set - e \ n \ ncd ActorSDK / Sources / ActorCore \ nmake translate \ nmake build - j3 \ n \ ncd \ " $ { CONFIGURATION _ TEMP _ DIR } / j2objc / \ " \ npython \ " $ { PROJECT _ DIR } / ActorSDK / Sources / ActorCore / convert . py \ " \ " $ { PROJECT _ DIR } / ActorSDK / Sources / ActorCore / ActorCore . h \ " \ n \ ncp - af \ " $ { PODS _ ROOT } / libjingle _ peerconnection / libjingle _ peerconnection / Headers / \ " \ " $ { CONFIGURATION _ BUILD _ DIR } / ActorSDK . framework / Headers / \ " \ n \ ncp - a \ " $ { CONFIGURATION _ TEMP _ DIR } / j2objc / Public / \ " \ " $ { CONFIGURATION _ BUILD _ DIR } / ActorSDK . framework / Headers / \ " \ n \ n \ ncp - a \ " $ { PROJECT _ DIR } / . . / sdk - core / core / core - shared / src / main / resources / \ " \ " $ { CONFIGURATION _ BUILD _ DIR } / ActorSDK . framework / \ " " ; 
 	 	 } ; 
 	 	 842CC4516DA967714D224C37 / * Check Pods Manifest . lock * / = { 
 	 	 	 isa = PBXShellScriptBuildPhase ; 
 @ @ - 1715 , 6 + 1733 , 7 @ @ 
 	 	 	 	 15D35F601C20187E00E3717A / * AAOpusAudioPlayerAU . mm in Sources * / , 
 	 	 	 	 15D35F1C1C20185500E3717A / * picture . c in Sources * / , 
 	 	 	 	 066A532B1BC53406000E606E / * AABubbleCell . swift in Sources * / , 
 + 	 	 	 	 06E323151C6A7AC000D66F53 / * AACallViewController . swift in Sources * / , 
 	 	 	 	 066A52C71BC521EA000E606E / * AAEditTextController . swift in Sources * / , 
 	 	 	 	 153F6B5D1C2B3AC500C0B960 / * AABubbleStickerCell . swift in Sources * / , 
 	 	 	 	 15D35F1E1C20185500E3717A / * wav _ io . c in Sources * / , 
 @ @ - 1880 , 6 + 1899 , 7 @ @ 
 	 	 	 	 066A52421BC4EECD000E606E / * AATableViewHeader . swift in Sources * / , 
 	 	 	 	 066A52CD1BC521FA000E606E / * AADialogsListContentControllerDelegate . swift in Sources * / , 
 	 	 	 	 15D35F261C20186200E3717A / * framing . c in Sources * / , 
 + 	 	 	 	 06E323111C694C1D00D66F53 / * WebRTCExt . swift in Sources * / , 
 	 	 	 	 066A52231BC4EEAC000E606E / * AAManagedSection . swift in Sources * / , 
 	 	 	 	 066A52D11BC52204000E606E / * AADialogCell . swift in Sources * / , 
 	 	 	 	 066A51901BC4C383000E606E / * CocoaNetworkRuntime . swift in Sources * / , 
 diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / ActorCoreExt . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / ActorCoreExt . swift 
 index 1f22c74 . . 2b4bf24 100644 
 - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / ActorCoreExt . swift 
 + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / ActorCoreExt . swift 
 @ @ - 375 , 7 + 375 , 7 @ @ public class AABinder { 
 
 } 
 
 - public func bind < T1 , T2 , T3 > ( valueModel1 : ARValue , valueModel2 : ARValue , valueModel3 : ARValue , closure : ( value1 : T1 ? , value2 : T2 ? , value3 : T3 ? ) - > ( ) ) { 
 + public func bind < T1 , T2 , T3 > ( valueModel1 : ARValue , valueModel2 : ARValue , valueModel3 : ARValue , closure : ( value1 : T1 ! , value2 : T2 ! , value3 : T3 ! ) - > ( ) ) { 
 
 let listener1 = BindListener { ( _ value1 ) - > ( ) in 
 closure ( value1 : _ value1 as ? T1 , value2 : valueModel2 . get ( ) as ? T2 , value3 : valueModel3 . get ( ) as ? T3 ) 
 @ @ - 396 , 7 + 396 , 7 @ @ public class AABinder { 
 } 
 
 
 - public func bind < T1 , T2 > ( valueModel1 : ARValue , valueModel2 : ARValue , closure : ( value1 : T1 ? , value2 : T2 ? ) - > ( ) ) { 
 + public func bind < T1 , T2 > ( valueModel1 : ARValue , valueModel2 : ARValue , closure : ( value1 : T1 ! , value2 : T2 ! ) - > ( ) ) { 
 let listener1 = BindListener { ( _ value1 ) - > ( ) in 
 closure ( value1 : _ value1 as ? T1 , value2 : valueModel2 . get ( ) as ? T2 ) 
 } ; 
 @ @ - 410 , 7 + 410 , 7 @ @ public class AABinder { 
 closure ( value1 : valueModel1 . get ( ) as ? T1 , value2 : valueModel2 . get ( ) as ? T2 ) 
 } 
 
 - public func bind < T > ( value : ARValue , closure : ( value : T ? ) - > ( ) ) { 
 + public func bind < T > ( value : ARValue , closure : ( value : T ! ) - > ( ) ) { 
 let listener = BindListener { ( value2 ) - > ( ) in 
 closure ( value : value2 as ? T ) 
 } ; 
 diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / Providers / iOSWebRTCProvider . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / Providers / iOSWebRTCProvider . swift 
 index c608432 . . 7b32ab5 100644 
 - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / Providers / iOSWebRTCProvider . swift 
 + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorCore / Providers / iOSWebRTCProvider . swift 
 @ @ - 3 , 43 + 3 , 179 @ @ 
 / / 
 
 import Foundation 
 - import RTCPeerConnection 
 
 class iOSWebRTCProvider : NSObject , ACWebRTCProvider { 
 
 - private var controller : ACWebRTCController ! ! 
 - private var messenger : ACMessenger ! ! 
 + private var controller : ACWebRTCController ! 
 + private var messenger : ACMessenger ! 
 + 
 + private lazy var queue : dispatch _ queue _ t = dispatch _ queue _ create ( " webrtc _ queue " , DISPATCH _ QUEUE _ SERIAL ) 
 + private let peerConnectionFactory = RTCPeerConnectionFactory ( ) 
 + private let mediaConstraints = RTCMediaConstraints ( ) 
 + 
 + private var runningCallId : jlong ? 
 + private var peerConnection : RTCPeerConnection ! 
 + private var voiceCapture : RTCAudioTrack ! 
 + 
 + override init ( ) { 
 + RTCPeerConnectionFactory . initializeSSL ( ) 
 + } 
 
 func initWithMessenger ( messenger : ACMessenger , withController controller : ACWebRTCController ) { 
 self . controller = controller 
 self . messenger = messenger 
 } 
 
 + / / 
 + / / Start / End of calls 
 + / / 
 + 
 func onIncomingCallWithCallId ( callId : jlong ) { 
 - 
 + dispatchSync ( ) { 
 + print ( " onIncomingCallWithCallId " ) 
 + self . runningCallId = callId 
 + dispatchOnUi ( ) { ( ) - > Void in 
 + let rootController = ActorSDK . sharedActor ( ) . bindedToWindow . rootViewController ! 
 + rootController . presentViewController ( AACallViewController ( callId : callId ) , animated : true , completion : nil ) 
 + } 
 + } 
 } 
 
 func onOutgoingCallWithCallId ( callId : jlong ) { 
 + dispatchSync ( ) { 
 + print ( " onOutgoingCallWithCallId " ) 
 + self . runningCallId = callId 
 + } 
 + } 
 + 
 + func onCallEndWithCallId ( callId : jlong ) { 
 + dispatchSync ( ) { 
 + if ( self . peerConnection ! = nil ) { 
 + self . peerConnection . close ( ) 
 + self . peerConnection = nil 
 + } 
 + self . voiceCapture = nil 
 + self . runningCallId = - 1 
 + } 
 + } 
 + 
 + / / 
 + / / In process 
 + / / 
 + 
 + private func createPeerConnection ( callId : jlong ) { 
 + / / 
 + / / Create Peer Connection 
 + / / 
 + let iceServers = [ 
 + RTCICEServer ( URI : NSURL ( string : " stun : 62 . 4 . 22 . 219 : 3478 " ) , username : " " , password : " " ) , 
 + RTCICEServer ( URI : NSURL ( string : " turn : 62 . 4 . 22 . 219 : 3478 ? transport = tcp " ) , username : " actor " , password : " password " ) , 
 + RTCICEServer ( URI : NSURL ( string : " turn : 62 . 4 . 22 . 219 : 3478 ? transport = udp " ) , username : " actor " , password : " password " ) 
 + ] 
 + peerConnection = peerConnectionFactory . peerConnectionWithICEServers ( iceServers , constraints : mediaConstraints , delegate : nil ) 
 
 + / / 
 + / / Crete Media Stream 
 + / / 
 + voiceCapture = peerConnectionFactory . audioTrackWithID ( " audio0 " ) 
 + let mediaStream = peerConnectionFactory . mediaStreamWithLabel ( " ARDAMSa0 " ) 
 + mediaStream . addAudioTrack ( voiceCapture ) 
 + peerConnection . addStream ( mediaStream ) 
 + 
 + / / 
 + / / Handling events from peer connection 
 + / / 
 + peerConnection . onCandidateReceived = { ( candidate ) in 
 + self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 + print ( " On Candidate arrived " ) 
 + self . controller . sendCandidateWithInt ( jint ( candidate . sdpMLineIndex ) , withNSString : candidate . sdpMid , withNSString : candidate . sdp ) 
 + } 
 + } 
 + peerConnection . onStreamAdded = { ( stream ) in 
 + self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 + print ( " On stream added " ) 
 + } 
 + } 
 } 
 
 func onOfferNeededWithCallId ( callId : jlong ) { 
 - 
 + self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 + print ( " onOfferNeededWithCallId " ) 
 + } 
 } 
 
 func onAnswerReceivedWithCallId ( callId : jlong , withSDP offerSDP : String ) { 
 - 
 + self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 + print ( " onAnswerReceivedWithCallId " ) 
 + } 
 } 
 
 func onOfferReceivedWithCallId ( callId : jlong , withSDP offerSDP : String ) { 
 
 + / / 
 + / / Stages : 
 + / / 1 . Create Peer Connection 
 + / / 2 . Set Remote description 
 + / / 3 . Create Answer 
 + / / 4 . Set Local description from answer 
 + / / 5 . Send Answer and enable candidate receiving 
 + / / 
 + 
 + self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 + self . createPeerConnection ( callId ) 
 + self . peerConnection . setRemoteDescription ( RTCSessionDescription ( type : " offer " , sdp : offerSDP ) ) { ( error ) - > ( ) in 
 + self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 + if ( error = = nil ) { 
 + self . peerConnection . createAnswer ( self . mediaConstraints ) { ( sdp , error ) - > ( ) in 
 + self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 + if ( error = = nil ) { 
 + self . peerConnection . setLocalDescription ( sdp ) { ( error ) - > ( ) in 
 + self . dispatchAsync ( callId ) { ( ) - > ( ) in 
 + if ( error = = nil ) { 
 + self . controller . sendAnswerWithNSString ( sdp . description ) 
 + self . controller . readyForCandidates ( ) 
 + } else { 
 + self . controller . endCall ( ) 
 + } 
 + } 
 + } 
 + } else { 
 + self . controller . endCall ( ) 
 + } 
 + } 
 + } 
 + } else { 
 + self . controller . endCall ( ) 
 + } 
 + } 
 + } 
 + } 
 } 
 
 func onCandidateWithCallId ( callId : jlong , withId id _ : String , withLabel label : jint , withSDP sdp : String ) { 
 - 
 + dispatchAsync ( callId ) { ( ) - > ( ) in 
 + self . peerConnection . addICECandidate ( RTCICECandidate ( mid : id _ , index : Int ( label ) , sdp : sdp ) ) 
 + } 
 } 
 
 - func onCallEndWithCallId ( callId : jlong ) { 
 - 
 + 
 + / / 
 + / / Dispatching 
 + / / 
 + 
 + private func dispatchSync ( closure : ( ) - > ( ) ) { 
 + dispatch _ sync ( queue ) { ( ) - > Void in 
 + closure ( ) 
 + } 
 + } 
 + 
 + private func dispatchAsync ( callId : jlong , closure : ( ) - > ( ) ) { 
 + if ( self . runningCallId = = callId ) { 
 + dispatch _ async ( queue ) { ( ) - > Void in 
 + if ( self . runningCallId = = callId ) { 
 + closure ( ) 
 + } 
 + } 
 + } 
 } 
 } 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . h b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . h 
 index 99f4b2f . . ec8398b 100644 
 - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . h 
 + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / ActorSDK . h 
 @ @ - 50 , 5 + 50 , 4 @ @ FOUNDATION _ EXPORT const unsigned char ActorSDKVersionString [ ] ; 
 
 # import " CLTokenView . h " 
 
 - 
 - 
 + # import " WebRTC . h " 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Calls / AACallViewController . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Calls / AACallViewController . swift 
 new file mode 100644 
 index 0000000 . . 1336eb5 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Calls / AACallViewController . swift 
 @ @ - 0 , 0 + 1 , 128 @ @ 
 + / / 
 + / / Copyright ( c ) 2014 - 2016 Actor LLC . < https : / / actor . im > 
 + / / 
 + 
 + import Foundation 
 + import PureLayout 
 + 
 + public class AACallViewController : AAViewController { 
 + 
 + public let binder = AABinder ( ) 
 + public let callId : jlong 
 + public let call : ACCallModel 
 + public let bgImage = UIImageView ( image : UIImage . bundled ( " bg _ 1 . jpg " ) ) 
 + public let bgImageOverlay = UIView ( ) 
 + public let senderAvatar : AAAvatarView = AAAvatarView ( frameSize : 120 , type : . Rounded ) 
 + public let peerTitle = UILabel ( ) 
 + public let answerCall = UIButton ( frame : CGRectMake ( 0 , 0 , 80 , 80 ) ) 
 + 
 + public init ( callId : jlong ) { 
 + self . callId = callId 
 + self . call = ActorSDK . sharedActor ( ) . messenger . getCallWithCallId ( callId ) 
 + super . init ( ) 
 + } 
 + 
 + public required init ( coder aDecoder : NSCoder ) { 
 + fatalError ( " init ( coder : ) has not been implemented " ) 
 + } 
 + 
 + public override func viewDidLoad ( ) { 
 + super . viewDidLoad ( ) 
 + 
 + answerCall . backgroundColor = UIColor ( rgb : 0xc04945 ) 
 + answerCall . setTitle ( " End Call " , forState : . Normal ) 
 + answerCall . setTitleColor ( UIColor . whiteColor ( ) , forState : . Normal ) 
 + answerCall . viewDidTap = { 
 + Actor . endCallWithCallId ( self . callId ) 
 + self . navigateDetail ( ConversationViewController ( peer : self . call . getPeer ( ) ) ) 
 + self . dismiss ( ) 
 + } 
 + 
 + bgImage . contentMode = UIViewContentMode . ScaleAspectFill 
 + bgImageOverlay . opaque = false 
 + bgImageOverlay . backgroundColor = UIColor ( rgb : 0x86aed7 ) 
 + peerTitle . textColor = UIColor . whiteColor ( ) 
 + peerTitle . textAlignment = NSTextAlignment . Center 
 + peerTitle . font = UIFont . thinSystemFontOfSize ( 32 ) 
 + 
 + self . view . addSubview ( bgImage ) 
 + self . view . addSubview ( bgImageOverlay ) 
 + self . view . addSubview ( senderAvatar ) 
 + self . view . addSubview ( peerTitle ) 
 + self . view . addSubview ( answerCall ) 
 + } 
 + 
 + public override func viewWillLayoutSubviews ( ) { 
 + super . viewWillLayoutSubviews ( ) 
 + 
 + bgImage . frame = self . view . bounds 
 + bgImageOverlay . frame = self . view . bounds 
 + 
 + senderAvatar . frame = CGRectMake ( ( self . view . width - 120 ) / 2 , 100 , 120 , 120 ) 
 + peerTitle . frame = CGRectMake ( 60 , senderAvatar . bottom + 20 , view . width - 120 , 34 ) 
 + answerCall . frame = CGRectMake ( 0 , self . view . height - 48 , self . view . width , 48 ) 
 + } 
 + 
 + public override func viewWillAppear ( animated : Bool ) { 
 + super . viewWillAppear ( animated ) 
 + 
 + / / 
 + / / Binding State 
 + / / 
 + binder . bind ( call . getState ( ) ) { ( value : ACCallState ! ) - > ( ) in 
 + if ( ACCallState _ Enum . CALLING _ INCOMING = = value . toNSEnum ( ) ) { 
 + print ( " Call \ ( self . callId ) incoming " ) 
 + } else if ( ACCallState _ Enum . IN _ PROGRESS = = value . toNSEnum ( ) ) { 
 + print ( " Call \ ( self . callId ) in progress " ) 
 + } else { 
 + print ( " Call \ ( self . callId ) unknown " ) 
 + } 
 + } 
 + 
 + / / 
 + / / Binding Avatar 
 + / / 
 + binder . bind ( call . getActiveMembers ( ) ) { ( value : JavaUtilArrayList ! ) - > ( ) in 
 + 
 + print ( " Bind user " ) 
 + 
 + var users = [ ACUserVM ] ( ) 
 + for i in 0 . . < value . size ( ) { 
 + let uid = ( value . getWithInt ( i ) as ! JavaLangInteger ) . intValue ( ) 
 + if ( uid ! = Actor . myUid ( ) ) { 
 + users . append ( Actor . getUserWithUid ( uid ) ) 
 + } 
 + } 
 + 
 + print ( " Bind user \ ( users . count ) " ) 
 + 
 + if ( users . count = = 1 ) { 
 + self . senderAvatar . bind ( users [ 0 ] . getNameModel ( ) . get ( ) , id : users [ 0 ] . getId ( ) , avatar : users [ 0 ] . getAvatarModel ( ) . get ( ) ) 
 + } else { 
 + / / TODO : Multiple Users 
 + } 
 + } 
 + 
 + / / 
 + / / Binding Title 
 + / / 
 + if ( call . getPeer ( ) . peerType . toNSEnum ( ) = = ACPeerType _ Enum . PRIVATE ) { 
 + binder . bind ( Actor . getUserWithUid ( call . getPeer ( ) . peerId ) . getNameModel ( ) , closure : { ( value : String ! ) - > ( ) in 
 + self . peerTitle . text = value 
 + } ) 
 + } else if ( call . getPeer ( ) . peerType . toNSEnum ( ) = = ACPeerType _ Enum . GROUP ) { 
 + binder . bind ( Actor . getGroupWithGid ( call . getPeer ( ) . peerId ) . getNameModel ( ) , closure : { ( value : String ! ) - > ( ) in 
 + self . peerTitle . text = value 
 + } ) 
 + } 
 + 
 + UIApplication . sharedApplication ( ) . setStatusBarStyle ( . LightContent , animated : true ) 
 + } 
 + 
 + public override func viewWillDisappear ( animated : Bool ) { 
 + super . viewWillDisappear ( animated ) 
 + binder . unbindAll ( ) 
 + 
 + UIApplication . sharedApplication ( ) . setStatusBarStyle ( ActorSDK . sharedActor ( ) . style . vcStatusBarStyle , animated : true ) 
 + } 
 + } 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Managed Runtime / Navigations . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Managed Runtime / Navigations . swift 
 index 0e533ef . . 6003e79 100644 
 - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Managed Runtime / Navigations . swift 	 
 + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / Managed Runtime / Navigations . swift 	 
 @ @ - 7 , 19 + 7 , 15 @ @ import Foundation 
 public extension UIViewController { 
 public func navigateDetail ( controller : UIViewController ) { 
 if ( AADevice . isiPad ) { 
 - let split = UIApplication . sharedApplication ( ) . keyWindow ? . rootViewController as ! UISplitViewController ; 
 + let split = UIApplication . sharedApplication ( ) . keyWindow ? . rootViewController as ! UISplitViewController 
 let master = split . viewControllers [ 0 ] 
 let detail = AANavigationController ( ) 
 detail . viewControllers = [ controller ] 
 split . viewControllers = [ master , detail ] 
 } else { 
 - 
 - if controller . isKindOfClass ( ConversationViewController . self ) { 
 - / / navigationController ? . view . layer . speed = 1 . 5 
 - } 
 - 
 + let tabBar = UIApplication . sharedApplication ( ) . keyWindow ? . rootViewController as ! UITabBarController 
 controller . hidesBottomBarWhenPushed = true 
 - navigationController ? . pushViewController ( controller , animated : true ) ; 
 + ( tabBar . selectedViewController as ! AANavigationController ) . pushViewController ( controller , animated : true ) 
 } 
 } 
 } 
 diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / User / AAUserViewController . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / User / AAUserViewController . swift 
 index 3351f21 . . 917a3a6 100644 
 - - - a / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / User / AAUserViewController . swift 
 + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / Controllers / User / AAUserViewController . swift 
 @ @ - 67 , 7 + 67 , 7 @ @ class AAUserViewController : AAContentTableController { 
 / / Profile : Send messages 
 s . action ( " ProfileSendMessage " ) { ( r ) - > ( ) in 
 r . selectAction = { ( ) - > Bool in 
 - self . navigateDetail ( ConversationViewController ( peer : ACPeer . userWithInt ( jint ( self . uid ) ) ) ) 
 + self . navigateDetail ( ConversationViewController ( peer : ACPeer . userWithInt ( jint ( self . uid ) ) ) ) 
 self . popover ? . dismissPopoverAnimated ( true ) 
 return false 
 } 
 diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / WebRTC . h b / actor - sdk / sdk - core - ios / ActorSDK / Sources / WebRTC . h 
 new file mode 100644 
 index 0000000 . . b2b2fc7 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / WebRTC . h 
 @ @ - 0 , 0 + 1 , 34 @ @ 
 + / / 
 + / / Copyright ( c ) 2014 - 2016 Actor LLC . < https : / / actor . im > 
 + / / 
 + 
 + # import " RTCAudioSource . h " 
 + # import " RTCAudioTrack . h " 
 + # import " RTCAVFoundationVideoSource . h " 
 + # import " RTCDataChannel . h " 
 + # import " RTCEAGLVideoView . h " 
 + # import " RTCFileLogger . h " 
 + # import " RTCI420Frame . h " 
 + # import " RTCICECandidate . h " 
 + # import " RTCICEServer . h " 
 + # import " RTCLogging . h " 
 + # import " RTCMediaConstraints . h " 
 + # import " RTCMediaSource . h " 
 + # import " RTCMediaStream . h " 
 + # import " RTCMediaStreamTrack . h " 
 + # import " RTCOpenGLVideoRenderer . h " 
 + # import " RTCPair . h " 
 + # import " RTCPeerConnection . h " 
 + # import " RTCPeerConnectionFactory . h " 
 + # import " RTCMediaConstraints . h " 
 + # import " RTCPeerConnectionDelegate . h " 
 + # import " RTCPeerConnectionInterface . h " 
 + # import " RTCSessionDescription . h " 
 + # import " RTCSessionDescriptionDelegate . h " 
 + # import " RTCStatsDelegate . h " 
 + # import " RTCStatsReport . h " 
 + # import " RTCTypes . h " 
 + # import " RTCVideoCapturer . h " 
 + # import " RTCVideoRenderer . h " 
 + # import " RTCVideoSource . h " 
 + # import " RTCVideoTrack . h " 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core - ios / ActorSDK / Sources / WebRTCExt . swift b / actor - sdk / sdk - core - ios / ActorSDK / Sources / WebRTCExt . swift 
 new file mode 100644 
 index 0000000 . . 35197b8 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core - ios / ActorSDK / Sources / WebRTCExt . swift 
 @ @ - 0 , 0 + 1 , 146 @ @ 
 + / / 
 + / / Copyright ( c ) 2014 - 2016 Actor LLC . < https : / / actor . im > 
 + / / 
 + 
 + import Foundation 
 + import BrightFutures 
 + 
 + class AAPeerConnectionDelegate : NSObject , RTCPeerConnectionDelegate { 
 + 
 + var onCandidateReceived : ( ( RTCICECandidate ) - > ( ) ) ? 
 + var onStreamAdded : ( ( RTCMediaStream ) - > ( ) ) ? 
 + 
 + func peerConnection ( peerConnection : RTCPeerConnection ! , signalingStateChanged stateChanged : RTCSignalingState ) { 
 + 
 + } 
 + 
 + func peerConnection ( peerConnection : RTCPeerConnection ! , addedStream stream : RTCMediaStream ! ) { 
 + onStreamAdded ? ( stream ) 
 + } 
 + 
 + func peerConnection ( peerConnection : RTCPeerConnection ! , removedStream stream : RTCMediaStream ! ) { 
 + 
 + } 
 + 
 + func peerConnectionOnRenegotiationNeeded ( peerConnection : RTCPeerConnection ! ) { 
 + 
 + } 
 + 
 + func peerConnection ( peerConnection : RTCPeerConnection ! , iceConnectionChanged newState : RTCICEConnectionState ) { 
 + 
 + } 
 + 
 + func peerConnection ( peerConnection : RTCPeerConnection ! , iceGatheringChanged newState : RTCICEGatheringState ) { 
 + 
 + } 
 + 
 + func peerConnection ( peerConnection : RTCPeerConnection ! , gotICECandidate candidate : RTCICECandidate ! ) { 
 + onCandidateReceived ? ( candidate ) 
 + } 
 + 
 + func peerConnection ( peerConnection : RTCPeerConnection ! , didOpenDataChannel dataChannel : RTCDataChannel ! ) { 
 + 
 + } 
 + } 
 + 
 + class AASessionDescriptionCreateDelegate : NSObject , RTCSessionDescriptionDelegate { 
 + 
 + let didCreate : ( RTCSessionDescription ! , NSError ! ) - > ( ) 
 + let peerConnection : RTCPeerConnection 
 + 
 + init ( didCreate : ( RTCSessionDescription ! , NSError ! ) - > ( ) , peerConnection : RTCPeerConnection ) { 
 + self . didCreate = didCreate 
 + self . peerConnection = peerConnection 
 + } 
 + 
 + func peerConnection ( peerConnection : RTCPeerConnection ! , didCreateSessionDescription sdp : RTCSessionDescription ! , error : NSError ! ) { 
 + didCreate ( sdp ! , error ) 
 + } 
 + 
 + func peerConnection ( peerConnection : RTCPeerConnection ! , didSetSessionDescriptionWithError error : NSError ! ) { 
 + 
 + } 
 + } 
 + 
 + 
 + private var sessionSetTarget = " descTarget " 
 + class AASessionDescriptionSetDelegate : NSObject , RTCSessionDescriptionDelegate { 
 + 
 + let didSet : ( NSError ! ) - > ( ) 
 + let peerConnection : RTCPeerConnection 
 + 
 + init ( didSet : ( NSError ! ) - > ( ) , peerConnection : RTCPeerConnection ) { 
 + self . didSet = didSet 
 + self . peerConnection = peerConnection 
 + super . init ( ) 
 + 
 + setAssociatedObject ( peerConnection , value : self , associativeKey : & sessionSetTarget ) 
 + } 
 + 
 + func peerConnection ( peerConnection : RTCPeerConnection ! , didCreateSessionDescription sdp : RTCSessionDescription ! , error : NSError ! ) { 
 + print ( " didCreateSessionDescription " ) 
 + } 
 + 
 + func peerConnection ( peerConnection : RTCPeerConnection ! , didSetSessionDescriptionWithError error : NSError ! ) { 
 + print ( " didSetSessionDescriptionWithError " ) 
 + 
 + setAssociatedObject ( peerConnection , value : " " , associativeKey : & sessionSetTarget ) 
 + 
 + didSet ( error ) 
 + } 
 + } 
 + 
 + private var targetReference = " target " 
 + extension RTCPeerConnection { 
 + 
 + public var onCandidateReceived : ( ( RTCICECandidate ) - > ( ) ) ? { 
 + set ( value ) { 
 + intDelegate ( ) . onCandidateReceived = value 
 + } 
 + get { 
 + return intDelegate ( ) . onCandidateReceived 
 + } 
 + } 
 + 
 + public var onStreamAdded : ( ( RTCMediaStream ) - > ( ) ) ? { 
 + set ( value ) { 
 + intDelegate ( ) . onStreamAdded = value 
 + } 
 + get { 
 + return intDelegate ( ) . onStreamAdded 
 + } 
 + } 
 + 
 + private func intDelegate ( ) - > AAPeerConnectionDelegate { 
 + let stored = self . delegate as ? AAPeerConnectionDelegate 
 + if ( stored ! = nil ) { 
 + return stored ! 
 + } 
 + 
 + let nDelegate = AAPeerConnectionDelegate ( ) 
 + self . delegate = nDelegate 
 + setAssociatedObject ( self , value : nDelegate , associativeKey : & targetReference ) 
 + return nDelegate 
 + } 
 + 
 + func createAnswer ( constraints : RTCMediaConstraints , didCreate : ( RTCSessionDescription ! , NSError ! ) - > ( ) ) { 
 + createAnswerWithDelegate ( AASessionDescriptionCreateDelegate ( didCreate : didCreate , peerConnection : self ) , constraints : constraints ) 
 + } 
 + 
 + func createOffer ( constraints : RTCMediaConstraints , didCreate : ( RTCSessionDescription ! , NSError ! ) - > ( ) ) { 
 + createOfferWithDelegate ( AASessionDescriptionCreateDelegate ( didCreate : didCreate , peerConnection : self ) , constraints : constraints ) 
 + } 
 + 
 + func setLocalDescription ( sdp : RTCSessionDescription , didSet : ( NSError ! ) - > ( ) ) { 
 + setLocalDescriptionWithDelegate ( AASessionDescriptionSetDelegate ( didSet : didSet , peerConnection : self ) , sessionDescription : sdp ) 
 + } 
 + 
 + func setRemoteDescription ( sdp : RTCSessionDescription , didSet : ( NSError ! ) - > ( ) ) { 
 + setRemoteDescriptionWithDelegate ( AASessionDescriptionSetDelegate ( didSet : didSet , peerConnection : self ) , sessionDescription : sdp ) 
 + } 
 + } 
 + 
 + 
 + 
 + 
 + 
 diff - - git a / actor - sdk / sdk - core - ios / Podfile b / actor - sdk / sdk - core - ios / Podfile 
 index 74047ee . . 4d64e4b 100644 
 - - - a / actor - sdk / sdk - core - ios / Podfile 
 + + + b / actor - sdk / sdk - core - ios / Podfile 
 @ @ - 22 , 12 + 22 , 15 @ @ target ' ActorApp ' do 
 pod ' CocoaAsyncSocket ' 
 pod ' zipzap ' 
 pod ' YYKit ' 
 + pod ' BrightFutures ' 
 
 # Main UI 
 pod ' TTTAttributedLabel ' 
 pod ' RSKImageCropper ' 
 pod ' JDStatusBarNotification ' 
 pod ' Neon ' 
 + pod ' Cartography ' 
 + pod ' PureLayout ' 
 
 # Small UI 
 pod ' VBFPopFlatButton ' 
 @ @ - 44 , 7 + 47 , 7 @ @ target ' ActorApp ' do 
 pod ' PSTAlertController ' 
 
 # Calls 
 - pod ' libjingle _ peerconnection ' 
 + # pod ' libjingle _ peerconnection ' 
 end 
 
 target ' ActorSDK ' do 
 @ @ - 58 , 6 + 61 , 9 @ @ target ' ActorSDK ' do 
 pod ' CocoaAsyncSocket ' 
 pod ' zipzap ' 
 pod ' YYKit ' 
 + pod ' BrightFutures ' 
 + pod ' Cartography ' 
 + pod ' PureLayout ' 
 
 # Main UI 
 pod ' TTTAttributedLabel ' 
 diff - - git a / actor - sdk / sdk - core / core / core - js / src / main / java / im / actor / core / js / providers / JsWebRTCProvider . java b / actor - sdk / sdk - core / core / core - js / src / main / java / im / actor / core / js / providers / JsWebRTCProvider . java 
 index 510dfcd . . d0b7b19 100644 
 - - - a / actor - sdk / sdk - core / core / core - js / src / main / java / im / actor / core / js / providers / JsWebRTCProvider . java 
 + + + b / actor - sdk / sdk - core / core / core - js / src / main / java / im / actor / core / js / providers / JsWebRTCProvider . java 
 @ @ - 3 , 6 + 3 , 8 @ @ package im . actor . core . js . providers ; 
 import com . google . gwt . core . client . JavaScriptObject ; 
 import com . google . gwt . core . client . JsArray ; 
 
 + import org . jetbrains . annotations . NotNull ; 
 + 
 import im . actor . core . Messenger ; 
 import im . actor . core . js . JsMessenger ; 
 import im . actor . core . js . modules . JsScheduller ; 
 @ @ - 35 , 7 + 37 , 7 @ @ public class JsWebRTCProvider implements WebRTCProvider { 
 private long runningCallId ; 
 
 @ Override 
 - public void init ( Messenger messenger , WebRTCController controller ) { 
 + public void init ( @ NotNull Messenger messenger , @ NotNull WebRTCController controller ) { 
 this . controller = controller ; 
 this . messenger = ( JsMessenger ) messenger ; 
 } 
 @ @ - 146 , 7 + 148 , 7 @ @ public class JsWebRTCProvider implements WebRTCProvider { 
 } 
 
 @ Override 
 - public void onAnswerReceived ( final long callId , String offerSDP ) { 
 + public void onAnswerReceived ( final long callId , @ NotNull String offerSDP ) { 
 Log . d ( TAG , " onAnswerReceived " ) ; 
 peerConnection . setRemoteDescription ( JsSessionDescription . createAnswer ( offerSDP ) ) . then ( new Consumer < JsSessionDescription > ( ) { 
 @ Override 
 @ @ - 167 , 7 + 169 , 7 @ @ public class JsWebRTCProvider implements WebRTCProvider { 
 } 
 
 @ Override 
 - public void onOfferReceived ( final long callId , final String offerSDP ) { 
 + public void onOfferReceived ( final long callId , @ NotNull final String offerSDP ) { 
 Log . d ( TAG , " onOfferReceived " ) ; 
 
 createPeerConnection ( callId ) ; 
 @ @ - 222 , 7 + 224 , 7 @ @ public class JsWebRTCProvider implements WebRTCProvider { 
 } 
 
 @ Override 
 - public void onCandidate ( long callId , String id , int label , String sdp ) { 
 + public void onCandidate ( long callId , @ NotNull String id , int label , @ NotNull String sdp ) { 
 Log . d ( TAG , " onCandidate " ) ; 
 peerConnection . addIceCandidate ( label , sdp ) ; 
 }
