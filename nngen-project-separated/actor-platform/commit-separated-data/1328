BLEU SCORE: 0.13485111859503685

TEST MSG: wip ( core ) : Stashing book import optimizations
GENERATED MSG: wip ( sdk ) : Grouped active dialogs list

TEST DIFF (one line): diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / contacts / BookImportActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / contacts / BookImportActor . java < nl > index d06466a . . 4c2123f 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / contacts / BookImportActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / contacts / BookImportActor . java < nl > @ @ - 21 , 6 + 21 , 7 @ @ import im . actor . core . entity . PhoneBookContact ; < nl > import im . actor . core . entity . PhoneBookEmail ; < nl > import im . actor . core . entity . PhoneBookPhone ; < nl > import im . actor . core . modules . ModuleContext ; < nl > + import im . actor . core . modules . internal . contacts . entity . BookImportStorage ; < nl > import im . actor . core . modules . utils . ModuleActor ; < nl > import im . actor . core . network . RpcCallback ; < nl > import im . actor . core . network . RpcException ; < nl > @ @ - 38 , 6 + 39 , 7 @ @ public class BookImportActor extends ModuleActor { < nl > private HashSet < String > importingEmails = new HashSet < String > ( ) ; < nl > < nl > private boolean isSyncInProgress = false ; < nl > + private BookImportStorage storage = new BookImportStorage ( ) ; < nl > < nl > public BookImportActor ( ModuleContext context ) { < nl > super ( context ) ; < nl > @ @ - 47 , 6 + 49 , 7 @ @ public class BookImportActor extends ModuleActor { < nl > @ Override < nl > public void preStart ( ) { < nl > super . preStart ( ) ; < nl > + < nl > self ( ) . send ( new PerformSync ( ) ) ; < nl > } < nl > < nl > @ @ - 210 , 21 + 213 , 21 @ @ public class BookImportActor extends ModuleActor { < nl > } ) ; < nl > } < nl > < nl > - private boolean isImported ( long phone ) { < nl > - return preferences ( ) . getBool ( " book _ phone _ " + phone , false ) ; < nl > - } < nl > - < nl > - private boolean isImported ( String email ) { < nl > - return preferences ( ) . getBool ( " book _ email _ " + email . toLowerCase ( ) , false ) ; < nl > - } < nl > - < nl > - private void markImported ( long phone ) { < nl > - preferences ( ) . putBool ( " book _ phone _ " + phone , true ) ; < nl > - } < nl > - < nl > - private void markImported ( String email ) { < nl > - preferences ( ) . putBool ( " book _ email _ " + email . toLowerCase ( ) , true ) ; < nl > - } < nl > + / / private boolean isImported ( long phone ) { < nl > + / / return preferences ( ) . getBool ( " book _ phone _ " + phone , false ) ; < nl > + / / } < nl > + / / < nl > + / / private boolean isImported ( String email ) { < nl > + / / return preferences ( ) . getBool ( " book _ email _ " + email . toLowerCase ( ) , false ) ; < nl > + / / } < nl > + / / < nl > + / / private void markImported ( long phone ) { < nl > + / / preferences ( ) . putBool ( " book _ phone _ " + phone , true ) ; < nl > + / / } < nl > + / / < nl > + / / private void markImported ( String email ) { < nl > + / / preferences ( ) . putBool ( " book _ email _ " + email . toLowerCase ( ) , true ) ; < nl > + / / } < nl > < nl > private void markImported ( ) { < nl > context ( ) . getAppStateModule ( ) . onBookImported ( ) ; < nl > @ @ - 256 , 4 + 259 , 45 @ @ public class BookImportActor extends ModuleActor { < nl > return phoneBook ; < nl > } < nl > } < nl > + < nl > + private static abstract class ImportQueueItem { < nl > + < nl > + } < nl > + < nl > + private static class ImportPhoneQueueItem extends ImportQueueItem { < nl > + < nl > + private long phoneNumber ; < nl > + private String name ; < nl > + < nl > + public ImportPhoneQueueItem ( long phoneNumber , String name ) { < nl > + this . phoneNumber = phoneNumber ; < nl > + this . name = name ; < nl > + } < nl > + < nl > + public long getPhoneNumber ( ) { < nl > + return phoneNumber ; < nl > + } < nl > + < nl > + public String getName ( ) { < nl > + return name ; < nl > + } < nl > + } < nl > + < nl > + private static class ImportEmailQueueItem extends ImportQueueItem { < nl > + private String email ; < nl > + private String name ; < nl > + < nl > + public ImportEmailQueueItem ( String email , String name ) { < nl > + this . email = email ; < nl > + this . name = name ; < nl > + } < nl > + < nl > + public String getEmail ( ) { < nl > + return email ; < nl > + } < nl > + < nl > + public String getName ( ) { < nl > + return name ; < nl > + } < nl > + } < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / contacts / entity / BookImportStorage . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / contacts / entity / BookImportStorage . java < nl > new file mode 100644 < nl > index 0000000 . . 093eb8f < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / contacts / entity / BookImportStorage . java < nl > @ @ - 0 , 0 + 1 , 68 @ @ < nl > + package im . actor . core . modules . internal . contacts . entity ; < nl > + < nl > + import java . io . IOException ; < nl > + import java . util . HashSet ; < nl > + < nl > + import im . actor . runtime . bser . BserObject ; < nl > + import im . actor . runtime . bser . BserValues ; < nl > + import im . actor . runtime . bser . BserWriter ; < nl > + < nl > + public class BookImportStorage extends BserObject { < nl > + < nl > + private HashSet < String > importedEmails = new HashSet < String > ( ) ; < nl > + private HashSet < Long > importedPhones = new HashSet < Long > ( ) ; < nl > + < nl > + public BookImportStorage ( ) { < nl > + } < nl > + < nl > + public BookImportStorage ( byte [ ] data ) { < nl > + super ( ) ; < nl > + try { < nl > + super . load ( data ) ; < nl > + } catch ( IOException e ) { < nl > + e . printStackTrace ( ) ; < nl > + importedEmails = new HashSet < String > ( ) ; < nl > + importedPhones = new HashSet < Long > ( ) ; < nl > + } < nl > + } < nl > + < nl > + public void markAsImported ( String email ) { < nl > + importedEmails . add ( email ) ; < nl > + } < nl > + < nl > + public void markAsImported ( long phone ) { < nl > + importedPhones . add ( ( Long ) phone ) ; < nl > + } < nl > + < nl > + public boolean isImported ( String email ) { < nl > + return importedEmails . contains ( email ) ; < nl > + } < nl > + < nl > + public boolean isImported ( long phone ) { < nl > + return importedPhones . contains ( phone ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public void parse ( BserValues values ) throws IOException { < nl > + importedEmails = new HashSet < String > ( ) ; < nl > + importedPhones = new HashSet < Long > ( ) ; < nl > + < nl > + for ( String s : values . getRepeatedString ( 1 ) ) { < nl > + importedEmails . add ( s ) ; < nl > + } < nl > + < nl > + for ( Long p : values . getRepeatedLong ( 2 ) ) { < nl > + importedPhones . add ( p ) ; < nl > + } < nl > + } < nl > + < nl > + @ Override < nl > + public void serialize ( BserWriter writer ) throws IOException { < nl > + for ( String s : importedEmails ) { < nl > + writer . writeString ( 1 , s ) ; < nl > + } < nl > + for ( Long p : importedPhones ) { < nl > + writer . writeLong ( 2 , p ) ; < nl > + } < nl > + } < nl > + }
NEAREST DIFF (one line): diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / entity / DialogDesc . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / entity / DialogDesc . java < nl > new file mode 100644 < nl > index 0000000 . . bb8078b < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / entity / DialogDesc . java < nl > @ @ - 0 , 0 + 1 , 80 @ @ < nl > + package im . actor . core . entity ; < nl > + < nl > + import com . google . j2objc . annotations . Property ; < nl > + < nl > + import java . io . IOException ; < nl > + < nl > + import im . actor . runtime . bser . BserObject ; < nl > + import im . actor . runtime . bser . BserValues ; < nl > + import im . actor . runtime . bser . BserWriter ; < nl > + import im . actor . runtime . storage . KeyValueItem ; < nl > + < nl > + public class DialogDesc extends BserObject implements KeyValueItem { < nl > + < nl > + @ Property ( " readonly , nonatomic " ) < nl > + private Peer peer ; < nl > + @ Property ( " readonly , nonatomic " ) < nl > + private String title ; < nl > + @ Property ( " readonly , nonatomic " ) < nl > + private Avatar avatar ; < nl > + @ Property ( " readonly , nonatomic " ) < nl > + private boolean isUnread ; < nl > + @ Property ( " readonly , nonatomic " ) < nl > + private int counter ; < nl > + < nl > + public DialogDesc ( Peer peer , String title , Avatar avatar , boolean isUnread , int counter ) { < nl > + this . peer = peer ; < nl > + this . title = title ; < nl > + this . avatar = avatar ; < nl > + this . isUnread = isUnread ; < nl > + this . counter = counter ; < nl > + } < nl > + < nl > + public Peer getPeer ( ) { < nl > + return peer ; < nl > + } < nl > + < nl > + public String getTitle ( ) { < nl > + return title ; < nl > + } < nl > + < nl > + public Avatar getAvatar ( ) { < nl > + return avatar ; < nl > + } < nl > + < nl > + public int getCounter ( ) { < nl > + return counter ; < nl > + } < nl > + < nl > + public boolean isUnread ( ) { < nl > + return isUnread ; < nl > + } < nl > + < nl > + @ Override < nl > + public void parse ( BserValues values ) throws IOException { < nl > + peer = Peer . fromBytes ( values . getBytes ( 1 ) ) ; < nl > + title = values . getString ( 2 ) ; < nl > + byte [ ] av = values . getBytes ( 3 ) ; < nl > + if ( av ! = null ) { < nl > + avatar = new Avatar ( av ) ; < nl > + } < nl > + counter = values . getInt ( 4 ) ; < nl > + isUnread = values . getBool ( 5 ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public void serialize ( BserWriter writer ) throws IOException { < nl > + writer . writeObject ( 1 , peer ) ; < nl > + writer . writeString ( 2 , title ) ; < nl > + if ( avatar ! = null ) { < nl > + writer . writeObject ( 3 , avatar ) ; < nl > + } < nl > + writer . writeInt ( 4 , counter ) ; < nl > + writer . writeBool ( 5 , isUnread ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public long getEngineId ( ) { < nl > + return peer . getUnuqueId ( ) ; < nl > + } < nl > + } < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java < nl > index 85714e6 . . 30e0d85 100644 < nl > - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java < nl > + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java < nl > @ @ - 35 , 6 + 35 , 7 @ @ import im . actor . core . modules . internal . messages . CursorReaderActor ; < nl > import im . actor . core . modules . internal . messages . CursorReceiverActor ; < nl > import im . actor . core . modules . internal . messages . DialogsActor ; < nl > import im . actor . core . modules . internal . messages . DialogsHistoryActor ; < nl > + import im . actor . core . modules . internal . messages . GroupedDialogsActor ; < nl > import im . actor . core . modules . internal . messages . MessageDeleteActor ; < nl > import im . actor . core . modules . internal . messages . MessageShownActor ; < nl > import im . actor . core . modules . internal . messages . MessageShownFilter ; < nl > @ @ - 46 , 6 + 47 , 7 @ @ import im . actor . core . network . RpcException ; < nl > import im . actor . core . network . RpcInternalException ; < nl > import im . actor . core . viewmodel . Command ; < nl > import im . actor . core . viewmodel . CommandCallback ; < nl > + import im . actor . core . viewmodel . DialogGroupsVM ; < nl > import im . actor . runtime . Storage ; < nl > import im . actor . runtime . actors . ActorCreator ; < nl > import im . actor . runtime . actors . ActorRef ; < nl > @ @ - 62 , 8 + 64 , 10 @ @ import static im . actor . runtime . actors . ActorSystem . system ; < nl > public class MessagesModule extends AbsModule implements BusSubscriber { < nl > < nl > private ListEngine < Dialog > dialogs ; < nl > + < nl > private ActorRef dialogsActor ; < nl > private ActorRef dialogsHistoryActor ; < nl > + private ActorRef dialogsGroupedActor ; < nl > private ActorRef ownReadActor ; < nl > private ActorRef plainReadActor ; < nl > private ActorRef plainReceiverActor ; < nl > @ @ - 79 , 6 + 83 , 8 @ @ public class MessagesModule extends AbsModule implements BusSubscriber { < nl > < nl > private final SyncKeyValue cursorStorage ; < nl > < nl > + private final DialogGroupsVM dialogGroups = new DialogGroupsVM ( ) ; < nl > + < nl > public MessagesModule ( final ModuleContext context ) { < nl > super ( context ) ; < nl > < nl > @ @ - 99 , 6 + 105 , 14 @ @ public class MessagesModule extends AbsModule implements BusSubscriber { < nl > return new DialogsHistoryActor ( context ( ) ) ; < nl > } < nl > } ) , " actor / dialogs / history " ) ; < nl > + < nl > + this . dialogsGroupedActor = system ( ) . actorOf ( Props . create ( GroupedDialogsActor . class , new ActorCreator < GroupedDialogsActor > ( ) { < nl > + @ Override < nl > + public GroupedDialogsActor create ( ) { < nl > + return new GroupedDialogsActor ( context ( ) ) ; < nl > + } < nl > + } ) , " actor / dialogs / grouped " ) ; < nl > + < nl > this . ownReadActor = system ( ) . actorOf ( Props . create ( OwnReadActor . class , new ActorCreator < OwnReadActor > ( ) { < nl > @ Override < nl > public OwnReadActor create ( ) { < nl > @ @ - 139 , 6 + 153 , 10 @ @ public class MessagesModule extends AbsModule implements BusSubscriber { < nl > context ( ) . getEvents ( ) . subscribe ( this , PeerChatOpened . EVENT ) ; < nl > } < nl > < nl > + public DialogGroupsVM getDialogGroupsVM ( ) { < nl > + return dialogGroups ; < nl > + } < nl > + < nl > public ActorRef getSendMessageActor ( ) { < nl > return sendMessageActor ; < nl > } < nl > @ @ - 221 , 6 + 239 , 10 @ @ public class MessagesModule extends AbsModule implements BusSubscriber { < nl > return dialogsHistoryActor ; < nl > } < nl > < nl > + public ActorRef getDialogsGroupedActor ( ) { < nl > + return dialogsGroupedActor ; < nl > + } < nl > + < nl > public ListEngine < Dialog > getDialogsEngine ( ) { < nl > return dialogs ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java < nl > index 6641ed9 . . 8bf76dc 100644 < nl > - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java < nl > + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java < nl > @ @ - 44 , 6 + 44 , 7 @ @ public class ConversationActor extends ModuleActor { < nl > private IndexStorage outPendingIndex ; < nl > private IndexStorage inPendingIndex ; < nl > private ActorRef dialogsActor ; < nl > + private ActorRef dialogsGroupedActor ; < nl > private long inReadState ; < nl > private long outReadState ; < nl > private long outReceiveState ; < nl > @ @ - 62 , 6 + 63 , 7 @ @ public class ConversationActor extends ModuleActor { < nl > docs = context ( ) . getMessagesModule ( ) . getConversationDocsEngine ( peer ) ; < nl > < nl > dialogsActor = context ( ) . getMessagesModule ( ) . getDialogsActor ( ) ; < nl > + dialogsGroupedActor = context ( ) . getMessagesModule ( ) . getDialogsGroupedActor ( ) ; < nl > outPendingIndex = Storage . createIndex ( " out _ pending _ " + peer . getPeerType ( ) + " _ " + peer . getPeerId ( ) ) ; < nl > inPendingIndex = Storage . createIndex ( " in _ pending _ " + peer . getPeerType ( ) + " _ " + peer . getPeerId ( ) ) ; < nl > < nl > @ @ - 135 , 6 + 137 , 8 @ @ public class ConversationActor extends ModuleActor { < nl > / / Update dialogs < nl > if ( topMessage ! = null ) { < nl > if ( ! isHiddenPeer ) { < nl > + dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , < nl > + topMessage . getSortDate ( ) ) ) ; < nl > dialogsActor . send ( new DialogsActor . InMessage ( peer , topMessage , inPendingIndex . getCount ( ) ) ) ; < nl > } < nl > } < nl > @ @ - 185 , 6 + 189 , 8 @ @ public class ConversationActor extends ModuleActor { < nl > < nl > if ( ! isHiddenPeer ) { < nl > dialogsActor . send ( new DialogsActor . InMessage ( peer , message , inPendingIndex . getCount ( ) ) ) ; < nl > + dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , < nl > + message . getSortDate ( ) ) ) ; < nl > } < nl > } < nl > } < nl > @ @ - 239 , 6 + 245 , 8 @ @ public class ConversationActor extends ModuleActor { < nl > if ( ! isHiddenPeer ) { < nl > / / Updating dialog < nl > dialogsActor . send ( new DialogsActor . InMessage ( peer , updatedMsg , inPendingIndex . getCount ( ) ) ) ; < nl > + dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , < nl > + updatedMsg . getSortDate ( ) ) ) ; < nl > } < nl > < nl > / / Updating pending index < nl > @ @ - 361 , 6 + 369 , 7 @ @ public class ConversationActor extends ModuleActor { < nl > < nl > if ( ! isHiddenPeer ) { < nl > dialogsActor . send ( new DialogsActor . CounterChanged ( peer , inPendingIndex . getCount ( ) ) ) ; < nl > + / / TODO : Implement for grouped < nl > } < nl > } < nl > < nl > @ @ - 402 , 6 + 411 , 7 @ @ public class ConversationActor extends ModuleActor { < nl > inPendingIndex . clear ( ) ; < nl > outPendingIndex . clear ( ) ; < nl > dialogsActor . send ( new DialogsActor . ChatDelete ( peer ) ) ; < nl > + / / TODO : Implement for grouped < nl > } < nl > < nl > / / History < nl > diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / DialogsActor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / DialogsActor . java < nl > index 311de19 . . b77ac37 100644 < nl > - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / DialogsActor . java < nl > + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / DialogsActor . java < nl > @ @ - 50 , 7 + 50 , 7 @ @ public class DialogsActor extends ModuleActor { < nl > long start = im . actor . runtime . Runtime . getCurrentTime ( ) ; < nl > PeerDesc peerDesc = buildPeerDesc ( peer ) ; < nl > if ( peerDesc = = null ) { < nl > - Log . d ( " DialogsActor " , " unknown peer desk " ) ; < nl > + Log . d ( " DialogsActor " , " unknown peer desc " ) ; < nl > return ; < nl > } < nl > < nl > @ @ - 75 , 8 + 75 , 11 @ @ public class DialogsActor extends ModuleActor { < nl > . setText ( contentDescription . getText ( ) ) < nl > . setRelatedUid ( contentDescription . getRelatedUser ( ) ) < nl > . setStatus ( message . getMessageState ( ) ) < nl > - . setSenderId ( message . getSenderId ( ) ) < nl > - . setUnreadCount ( counter ) ; < nl > + . setSenderId ( message . getSenderId ( ) ) ; < nl > + < nl > + if ( counter > = 0 ) { < nl > + builder . setUnreadCount ( counter ) ; < nl > + } < nl > < nl > boolean forceUpdate = false ; < nl > < nl > diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java < nl > new file mode 100644 < nl > index 0000000 . . f0fdf00 < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java < nl > @ @ - 0 , 0 + 1 , 184 @ @ < nl > + package im . actor . core . modules . internal . messages ; < nl > + < nl > + import java . util . ArrayList ; < nl > + import java . util . HashMap ; < nl > + < nl > + import im . actor . core . entity . Avatar ; < nl > + import im . actor . core . entity . DialogDesc ; < nl > + import im . actor . core . entity . Peer ; < nl > + import im . actor . core . entity . PeerType ; < nl > + import im . actor . core . modules . ModuleContext ; < nl > + import im . actor . core . modules . utils . ModuleActor ; < nl > + import im . actor . core . viewmodel . DialogGroup ; < nl > + < nl > + public class GroupedDialogsActor extends ModuleActor { < nl > + < nl > + private PeerGroup groups = new PeerGroup ( " groups " , " Groups " ) ; < nl > + private PeerGroup privates = new PeerGroup ( " private " , " Private " ) ; < nl > + < nl > + public GroupedDialogsActor ( ModuleContext context ) { < nl > + super ( context ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public void preStart ( ) { < nl > + super . preStart ( ) ; < nl > + } < nl > + < nl > + private void onPeerInfoChanged ( Peer peer , String title , Avatar avatar ) { < nl > + < nl > + } < nl > + < nl > + private void onNewMessage ( Peer peer , long sortDate , int counter ) { < nl > + < nl > + PeerGroup peerGroup ; < nl > + if ( peer . getPeerType ( ) = = PeerType . GROUP ) { < nl > + peerGroup = groups ; < nl > + } else if ( peer . getPeerType ( ) = = PeerType . PRIVATE ) { < nl > + peerGroup = privates ; < nl > + } else { < nl > + return ; < nl > + } < nl > + < nl > + boolean found = false ; < nl > + for ( PeerDesc d : peerGroup . getPeers ( ) ) { < nl > + if ( d . getPeer ( ) . equals ( peer ) ) { < nl > + d . setCounter ( counter ) ; < nl > + found = true ; < nl > + } < nl > + } < nl > + < nl > + if ( ! found ) { < nl > + peerGroup . getPeers ( ) . add ( new PeerDesc ( peer , counter ) ) ; < nl > + } < nl > + < nl > + ArrayList < DialogGroup > groups = new ArrayList < DialogGroup > ( ) ; < nl > + ArrayList < DialogDesc > groupDescs = new ArrayList < DialogDesc > ( ) ; < nl > + for ( PeerDesc d : peerGroup . getPeers ( ) ) { < nl > + groupDescs . add ( new DialogDesc ( d . getPeer ( ) , " GRPOUP # " + d . getPeer ( ) . getPeerId ( ) , < nl > + null , false , d . counter ) ) ; < nl > + } < nl > + groups . add ( new DialogGroup ( " Groups " , " group " , groupDescs ) ) ; < nl > + < nl > + context ( ) . getMessagesModule ( ) . getDialogGroupsVM ( ) . getGroupsValueModel ( ) . change ( groups ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public void onReceive ( Object message ) { < nl > + if ( message instanceof PeerInformationChanged ) { < nl > + PeerInformationChanged informationChanged = ( PeerInformationChanged ) message ; < nl > + onPeerInfoChanged ( informationChanged . getPeer ( ) , < nl > + informationChanged . getTitle ( ) , < nl > + informationChanged . getAvatar ( ) ) ; < nl > + } else if ( message instanceof NewMessage ) { < nl > + NewMessage newMessage = ( NewMessage ) message ; < nl > + onNewMessage ( newMessage . peer , newMessage . sortDate , newMessage . counter ) ; < nl > + } else { < nl > + super . onReceive ( message ) ; < nl > + } < nl > + } < nl > + < nl > + public static class PeerInformationChanged { < nl > + < nl > + private Peer peer ; < nl > + private String title ; < nl > + private Avatar avatar ; < nl > + < nl > + public PeerInformationChanged ( Peer peer , String title , Avatar avatar ) { < nl > + this . peer = peer ; < nl > + this . title = title ; < nl > + this . avatar = avatar ; < nl > + } < nl > + < nl > + public Peer getPeer ( ) { < nl > + return peer ; < nl > + } < nl > + < nl > + public String getTitle ( ) { < nl > + return title ; < nl > + } < nl > + < nl > + public Avatar getAvatar ( ) { < nl > + return avatar ; < nl > + } < nl > + } < nl > + < nl > + public static class CounterChanged { < nl > + private Peer peer ; < nl > + private int counter ; < nl > + < nl > + public CounterChanged ( Peer peer , int counter ) { < nl > + this . peer = peer ; < nl > + this . counter = counter ; < nl > + } < nl > + < nl > + public Peer getPeer ( ) { < nl > + return peer ; < nl > + } < nl > + < nl > + public int getCounter ( ) { < nl > + return counter ; < nl > + } < nl > + } < nl > + < nl > + public static class NewMessage { < nl > + < nl > + private Peer peer ; < nl > + private int counter ; < nl > + private long sortDate ; < nl > + < nl > + public NewMessage ( Peer peer , int counter , long sortDate ) { < nl > + this . peer = peer ; < nl > + this . counter = counter ; < nl > + this . sortDate = sortDate ; < nl > + } < nl > + } < nl > + < nl > + private class PeerGroup { < nl > + < nl > + private String key ; < nl > + private String title ; < nl > + private ArrayList < PeerDesc > peers ; < nl > + < nl > + public PeerGroup ( String key , String title ) { < nl > + this . key = key ; < nl > + this . title = title ; < nl > + this . peers = new ArrayList < PeerDesc > ( ) ; < nl > + } < nl > + < nl > + public String getKey ( ) { < nl > + return key ; < nl > + } < nl > + < nl > + public String getTitle ( ) { < nl > + return title ; < nl > + } < nl > + < nl > + public ArrayList < PeerDesc > getPeers ( ) { < nl > + return peers ; < nl > + } < nl > + } < nl > + < nl > + private class PeerDesc { < nl > + < nl > + private Peer peer ; < nl > + private int counter ; < nl > + < nl > + public PeerDesc ( Peer peer , int counter ) { < nl > + this . peer = peer ; < nl > + this . counter = counter ; < nl > + } < nl > + < nl > + public Peer getPeer ( ) { < nl > + return peer ; < nl > + } < nl > + < nl > + public int getCounter ( ) { < nl > + return counter ; < nl > + } < nl > + < nl > + public void setCounter ( int counter ) { < nl > + this . counter = counter ; < nl > + } < nl > + } < nl > + } < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / viewmodel / DialogGroup . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / viewmodel / DialogGroup . java < nl > new file mode 100644 < nl > index 0000000 . . ae47f02 < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / viewmodel / DialogGroup . java < nl > @ @ - 0 , 0 + 1 , 30 @ @ < nl > + package im . actor . core . viewmodel ; < nl > + < nl > + import java . util . ArrayList ; < nl > + < nl > + import im . actor . core . entity . DialogDesc ; < nl > + < nl > + public class DialogGroup { < nl > + < nl > + private String title ; < nl > + private String key ; < nl > + private ArrayList < DialogDesc > dialogs ; < nl > + < nl > + public DialogGroup ( String title , String key , ArrayList < DialogDesc > dialogs ) { < nl > + this . title = title ; < nl > + this . key = key ; < nl > + this . dialogs = dialogs ; < nl > + } < nl > + < nl > + public String getTitle ( ) { < nl > + return title ; < nl > + } < nl > + < nl > + public String getKey ( ) { < nl > + return key ; < nl > + } < nl > + < nl > + public ArrayList < DialogDesc > getDialogs ( ) { < nl > + return dialogs ; < nl > + } < nl > + } < nl > diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / viewmodel / DialogGroupsVM . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / viewmodel / DialogGroupsVM . java < nl > new file mode 100644 < nl > index 0000000 . . 0a374ba < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / viewmodel / DialogGroupsVM . java < nl > @ @ - 0 , 0 + 1 , 18 @ @ < nl > + package im . actor . core . viewmodel ; < nl > + < nl > + import java . util . ArrayList ; < nl > + < nl > + import im . actor . runtime . mvvm . ValueModel ; < nl > + < nl > + public class DialogGroupsVM { < nl > + < nl > + private ValueModel < ArrayList < DialogGroup > > groupsValueModel ; < nl > + < nl > + public DialogGroupsVM ( ) { < nl > + groupsValueModel = new ValueModel < ArrayList < DialogGroup > > ( " groups . model " , null ) ; < nl > + } < nl > + < nl > + public ValueModel < ArrayList < DialogGroup > > getGroupsValueModel ( ) { < nl > + return groupsValueModel ; < nl > + } < nl > + } < nl > diff - - git a / actor - sdk / sdk - core / runtime / android / src / main / java / im / actor / runtime / android / storage / SQLiteKeyValue . java b / actor - sdk / sdk - core / runtime / android / src / main / java / im / actor / runtime / android / storage / SQLiteKeyValue . java < nl > index 530cb4b . . 31e2f0e 100644 < nl > - - - a / actor - sdk / sdk - core / runtime / android / src / main / java / im / actor / runtime / android / storage / SQLiteKeyValue . java < nl > + + + b / actor - sdk / sdk - core / runtime / android / src / main / java / im / actor / runtime / android / storage / SQLiteKeyValue . java < nl > @ @ - 119 , 21 + 119 , 9 @ @ public class SQLiteKeyValue implements KeyValueStorage { < nl > } < nl > < nl > @ Override < nl > - public void clear ( ) { < nl > - checkSqlite ( ) ; < nl > - db . beginTransaction ( ) ; < nl > - try { < nl > - db . execSQL ( " DELETE FROM \ " " + name + " \ " " ) ; < nl > - db . setTransactionSuccessful ( ) ; < nl > - } finally { < nl > - db . endTransaction ( ) ; < nl > - } < nl > - } < nl > - < nl > - @ Override < nl > - public byte [ ] getValue ( long id ) { < nl > + public byte [ ] loadItem ( long key ) { < nl > checkSqlite ( ) ; < nl > - Cursor cursor = db . query ( " \ " " + name + " \ " " , new String [ ] { " \ " BYTES \ " " } , " \ " ID \ " = ? " , new String [ ] { " " + id } , null , null , null ) ; < nl > + Cursor cursor = db . query ( " \ " " + name + " \ " " , new String [ ] { " \ " BYTES \ " " } , " \ " ID \ " = ? " , new String [ ] { " " + key } , null , null , null ) ; < nl > if ( cursor = = null ) { < nl > return null ; < nl > } < nl > @ @ - 146 , 4 + 134 , 26 @ @ public class SQLiteKeyValue implements KeyValueStorage { < nl > } < nl > return null ; < nl > } < nl > + < nl > + @ Override < nl > + public List < KeyValueRecord > loadItems ( long [ ] keys ) { < nl > + return null ; < nl > + } < nl > + < nl > + @ Override < nl > + public List < KeyValueRecord > loadAllItems ( ) { < nl > + return null ; < nl > + } < nl > + < nl > + @ Override < nl > + public void clear ( ) { < nl > + checkSqlite ( ) ; < nl > + db . beginTransaction ( ) ; < nl > + try { < nl > + db . execSQL ( " DELETE FROM \ " " + name + " \ " " ) ; < nl > + db . setTransactionSuccessful ( ) ; < nl > + } finally { < nl > + db . endTransaction ( ) ; < nl > + } < nl > + } < nl > } < nl > diff - - git a / actor - sdk / sdk - core / runtime / android / src / main / java / im / actor / runtime / android / storage / SQLiteList . java b / actor - sdk / sdk - core / runtime / android / src / main / java / im / actor / runtime / android / storage / SQLiteList . java < nl > index b153387 . . 25b59e1 100644 < nl > - - - a / actor - sdk / sdk - core / runtime / android / src / main / java / im / actor / runtime / android / storage / SQLiteList . java < nl > + + + b / actor - sdk / sdk - core / runtime / android / src / main / java / im / actor / runtime / android / storage / SQLiteList . java < nl > @ @ - 124 , 6 + 124 , 11 @ @ public class SQLiteList implements ListStorageDisplayEx { < nl > return null ; < nl > } < nl > < nl > + @ Override < nl > + public List < ListEngineRecord > loadAllItems ( ) { < nl > + return null ; < nl > + } < nl > + < nl > < nl > public ListEngineRecord loadItemBySortKey ( long key ) { < nl > checkTable ( ) ; < nl > diff - - git a / actor - sdk / sdk - core / runtime / shared / src / main / java / im / actor / runtime / storage / KeyValueEngine . java b / actor - sdk / sdk - core / runtime / shared / src / main / java / im / actor / runtime / storage / KeyValueEngine . java < nl > index 60239e4 . . c7dd481 100644 < nl > - - - a / actor - sdk / sdk - core / runtime / shared / src / main / java / im / actor / runtime / storage / KeyValueEngine . java < nl > + + + b / actor - sdk / sdk - core / runtime / shared / src / main / java / im / actor / runtime / storage / KeyValueEngine . java < nl > @ @ - 9 , 6 + 9 , 7 @ @ import com . google . j2objc . annotations . ObjectiveCName ; < nl > import java . util . List ; < nl > < nl > public interface KeyValueEngine < V extends KeyValueItem > { < nl > + < nl > @ ObjectiveCName ( " addOrUpdateItem : " ) < nl > void addOrUpdateItem ( V item ) ; < nl > < nl > diff - - git a / actor - sdk / sdk - ios / ActorSDK / Sources / ActorCore / Providers / Storage / FMDBKeyValue . swift b / actor - sdk / sdk - ios / ActorSDK / Sources / ActorCore / Providers / Storage / FMDBKeyValue . swift < nl > index fb65f46 . . c22c65a 100644 < nl > - - - a / actor - sdk / sdk - ios / ActorSDK / Sources / ActorCore / Providers / Storage / FMDBKeyValue . swift < nl > + + + b / actor - sdk / sdk - ios / ActorSDK / Sources / ActorCore / Providers / Storage / FMDBKeyValue . swift < nl > @ @ - 5 , 18 + 5 , 21 @ @ < nl > import Foundation < nl > < nl > @ objc class FMDBKeyValue : NSObject , ARKeyValueStorage { < nl > - var db : FMDatabase ? ; < nl > + < nl > + var db : FMDatabase ! < nl > < nl > - let databasePath : String ; < nl > - let tableName : String ; < nl > + let databasePath : String < nl > + let tableName : String < nl > < nl > - let queryCreate : String ; < nl > - let queryItem : String ; < nl > - let queryAdd : String ; < nl > - let queryDelete : String ; < nl > - let queryDeleteAll : String ; < nl > + let queryCreate : String < nl > + let queryItem : String < nl > + let queryItems : String < nl > + let queryAll : String < nl > + let queryAdd : String < nl > + let queryDelete : String < nl > + let queryDeleteAll : String < nl > < nl > - var isTableChecked : Bool = false ; < nl > + var isTableChecked : Bool = false < nl > < nl > init ( databasePath : String , tableName : String ) { < nl > self . databasePath = databasePath < nl > @ @ - 26 , 11 + 29 , 13 @ @ import Foundation < nl > self . queryCreate = " CREATE TABLE IF NOT EXISTS " + tableName + " ( " + < nl > " \ " ID \ " INTEGER NOT NULL , " + < nl > " \ " BYTES \ " BLOB NOT NULL , " + < nl > - " PRIMARY KEY ( \ " ID \ " ) ) ; " ; < nl > - self . queryItem = " SELECT \ " BYTES \ " FROM " + tableName + " WHERE \ " ID \ " = ? ; " ; < nl > - self . queryAdd = " REPLACE INTO " + tableName + " ( \ " ID \ " , \ " BYTES \ " ) VALUES ( ? , ? ) ; " ; < nl > - self . queryDelete = " DELETE FROM " + tableName + " WHERE \ " ID \ " = ? ; " ; < nl > - self . queryDeleteAll = " DELETE FROM " + tableName + " ; " ; < nl > + " PRIMARY KEY ( \ " ID \ " ) ) ; " < nl > + self . queryItem = " SELECT \ " BYTES \ " FROM " + tableName + " WHERE \ " ID \ " = ? ; " < nl > + self . queryItems = " SELECT ( \ " ID \ " , \ " BYTES \ " ) FROM " + tableName + " WHERE \ " ID \ " in ? ; " < nl > + self . queryAll = " SELECT ( \ " ID \ " , \ " BYTES \ " ) FROM " + tableName + " ; " < nl > + self . queryAdd = " REPLACE INTO " + tableName + " ( \ " ID \ " , \ " BYTES \ " ) VALUES ( ? , ? ) ; " < nl > + self . queryDelete = " DELETE FROM " + tableName + " WHERE \ " ID \ " = ? ; " < nl > + self . queryDeleteAll = " DELETE FROM " + tableName + " ; " < nl > < nl > super . init ( ) < nl > } < nl > @ @ - 39 , 68 + 44 , 103 @ @ import Foundation < nl > if ( isTableChecked ) { < nl > return < nl > } < nl > - isTableChecked = true ; < nl > + isTableChecked = true < nl > < nl > self . db = FMDatabase ( path : databasePath ) < nl > - self . db ! . open ( ) < nl > - if ( ! db ! . tableExists ( tableName ) ) { < nl > - db ! . executeUpdate ( queryCreate ) < nl > + self . db . open ( ) < nl > + if ( ! db . tableExists ( tableName ) ) { < nl > + db . executeUpdate ( queryCreate ) < nl > } < nl > } < nl > < nl > func addOrUpdateItems ( values : JavaUtilList ! ) { < nl > - checkTable ( ) ; < nl > + checkTable ( ) < nl > < nl > - db ! . beginTransaction ( ) < nl > + db . beginTransaction ( ) < nl > for i in 0 . . < values . size ( ) { < nl > - let record = values . getWithInt ( i ) as ! ARKeyValueRecord ; < nl > - db ! . executeUpdate ( queryAdd , record . getId ( ) . toNSNumber ( ) , record . getData ( ) ! . toNSData ( ) ) < nl > + let record = values . getWithInt ( i ) as ! ARKeyValueRecord < nl > + db . executeUpdate ( queryAdd , record . getId ( ) . toNSNumber ( ) , record . getData ( ) ! . toNSData ( ) ) < nl > } < nl > - db ! . commit ( ) < nl > + db . commit ( ) < nl > } < nl > < nl > func addOrUpdateItemWithKey ( key : jlong , withData data : IOSByteArray ! ) { < nl > - checkTable ( ) ; < nl > + checkTable ( ) < nl > < nl > - db ! . beginTransaction ( ) < nl > - db ! . executeUpdate ( queryAdd , key . toNSNumber ( ) , data ! . toNSData ( ) ) < nl > - db ! . commit ( ) < nl > + db . beginTransaction ( ) < nl > + db . executeUpdate ( queryAdd , key . toNSNumber ( ) , data ! . toNSData ( ) ) < nl > + db . commit ( ) < nl > } < nl > < nl > func removeItemsWithKeys ( keys : IOSLongArray ! ) { < nl > - checkTable ( ) ; < nl > + checkTable ( ) < nl > < nl > - db ! . beginTransaction ( ) < nl > + db . beginTransaction ( ) < nl > for i in 0 . . < keys . length ( ) { < nl > let key = keys . longAtIndex ( UInt ( i ) ) ; < nl > - db ! . executeUpdate ( queryDelete , key . toNSNumber ( ) ) < nl > + db . executeUpdate ( queryDelete , key . toNSNumber ( ) ) < nl > } < nl > - db ! . commit ( ) < nl > + db . commit ( ) < nl > } < nl > < nl > func removeItemWithKey ( key : jlong ) { < nl > - checkTable ( ) ; < nl > + checkTable ( ) < nl > < nl > - db ! . beginTransaction ( ) < nl > - db ! . executeUpdate ( queryDelete , key . toNSNumber ( ) ) < nl > - db ! . commit ( ) < nl > + db . beginTransaction ( ) < nl > + db . executeUpdate ( queryDelete , key . toNSNumber ( ) ) < nl > + db . commit ( ) < nl > } < nl > < nl > - func getValueWithKey ( key : jlong ) - > IOSByteArray ! { < nl > - checkTable ( ) ; < nl > + func loadItemWithKey ( key : jlong ) - > IOSByteArray ! { < nl > + checkTable ( ) < nl > < nl > - let result = db ! . dataForQuery ( queryItem , key . toNSNumber ( ) ) ; < nl > + let result = db . dataForQuery ( queryItem , key . toNSNumber ( ) ) < nl > if ( result = = nil ) { < nl > - return nil ; < nl > + return nil < nl > + } < nl > + return result . toJavaBytes ( ) < nl > + } < nl > + < nl > + func loadAllItems ( ) - > JavaUtilList ! { < nl > + checkTable ( ) < nl > + < nl > + let res = JavaUtilArrayList ( ) < nl > + < nl > + if let result = db . executeQuery ( queryAll ) { < nl > + while ( result . next ( ) ) { < nl > + res . addWithId ( ARKeyValueRecord ( key : jlong ( result . longLongIntForColumn ( " ID " ) ) , withData : result . dataForColumn ( " BYTES " ) . toJavaBytes ( ) ) ) < nl > + } < nl > + } < nl > + < nl > + return res < nl > + } < nl > + < nl > + func loadItems ( keys : IOSLongArray ! ) - > JavaUtilList ! { < nl > + checkTable ( ) < nl > + < nl > + / / Converting to NSNumbers < nl > + var ids = [ NSNumber ] ( ) < nl > + for i in 0 . . < keys . length ( ) { < nl > + ids . append ( keys . longAtIndex ( UInt ( i ) ) . toNSNumber ( ) ) < nl > } < nl > - return result . toJavaBytes ( ) ; < nl > + < nl > + let res = JavaUtilArrayList ( ) < nl > + < nl > + if let result = db . executeQuery ( queryItems , ids ) { < nl > + while ( result . next ( ) ) { < nl > + / / TODO : Optimize lookup < nl > + res . addWithId ( ARKeyValueRecord ( key : jlong ( result . longLongIntForColumn ( " ID " ) ) , withData : result . dataForColumn ( " BYTES " ) . toJavaBytes ( ) ) ) < nl > + } < nl > + } < nl > + < nl > + return res < nl > } < nl > < nl > func clear ( ) { < nl > - checkTable ( ) ; < nl > + checkTable ( ) < nl > < nl > - db ! . beginTransaction ( ) < nl > - db ! . executeUpdate ( queryDeleteAll ) ; < nl > - db ! . commit ( ) < nl > + db . beginTransaction ( ) < nl > + db . executeUpdate ( queryDeleteAll ) < nl > + db . commit ( ) < nl > } < nl > } < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - ios / ActorSDK / Sources / ActorCore / Providers / Storage / FMDBList . swift b / actor - sdk / sdk - ios / ActorSDK / Sources / ActorCore / Providers / Storage / FMDBList . swift < nl > index 27ac7e7 . . 209a6e3 100644 < nl > - - - a / actor - sdk / sdk - ios / ActorSDK / Sources / ActorCore / Providers / Storage / FMDBList . swift < nl > + + + b / actor - sdk / sdk - ios / ActorSDK / Sources / ActorCore / Providers / Storage / FMDBList . swift < nl > @ @ - 199 , 6 + 199 , 12 @ @ class FMDBList : NSObject , ARListStorageDisplayEx { < nl > } < nl > } < nl > < nl > + func loadAllItems ( ) - > JavaUtilList ! { < nl > + let res = JavaUtilArrayList ( ) < nl > + / / TODO : Implement < nl > + return res < nl > + } < nl > + < nl > func loadForwardWithSortKey ( sortingKey : JavaLangLong ! , withLimit limit : jint ) - > JavaUtilList ! { < nl > checkTable ( ) ; < nl > var result : FMResultSet ? = nil ;

TEST DIFF:
diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / contacts / BookImportActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / contacts / BookImportActor . java 
 index d06466a . . 4c2123f 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / contacts / BookImportActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / contacts / BookImportActor . java 
 @ @ - 21 , 6 + 21 , 7 @ @ import im . actor . core . entity . PhoneBookContact ; 
 import im . actor . core . entity . PhoneBookEmail ; 
 import im . actor . core . entity . PhoneBookPhone ; 
 import im . actor . core . modules . ModuleContext ; 
 + import im . actor . core . modules . internal . contacts . entity . BookImportStorage ; 
 import im . actor . core . modules . utils . ModuleActor ; 
 import im . actor . core . network . RpcCallback ; 
 import im . actor . core . network . RpcException ; 
 @ @ - 38 , 6 + 39 , 7 @ @ public class BookImportActor extends ModuleActor { 
 private HashSet < String > importingEmails = new HashSet < String > ( ) ; 
 
 private boolean isSyncInProgress = false ; 
 + private BookImportStorage storage = new BookImportStorage ( ) ; 
 
 public BookImportActor ( ModuleContext context ) { 
 super ( context ) ; 
 @ @ - 47 , 6 + 49 , 7 @ @ public class BookImportActor extends ModuleActor { 
 @ Override 
 public void preStart ( ) { 
 super . preStart ( ) ; 
 + 
 self ( ) . send ( new PerformSync ( ) ) ; 
 } 
 
 @ @ - 210 , 21 + 213 , 21 @ @ public class BookImportActor extends ModuleActor { 
 } ) ; 
 } 
 
 - private boolean isImported ( long phone ) { 
 - return preferences ( ) . getBool ( " book _ phone _ " + phone , false ) ; 
 - } 
 - 
 - private boolean isImported ( String email ) { 
 - return preferences ( ) . getBool ( " book _ email _ " + email . toLowerCase ( ) , false ) ; 
 - } 
 - 
 - private void markImported ( long phone ) { 
 - preferences ( ) . putBool ( " book _ phone _ " + phone , true ) ; 
 - } 
 - 
 - private void markImported ( String email ) { 
 - preferences ( ) . putBool ( " book _ email _ " + email . toLowerCase ( ) , true ) ; 
 - } 
 + / / private boolean isImported ( long phone ) { 
 + / / return preferences ( ) . getBool ( " book _ phone _ " + phone , false ) ; 
 + / / } 
 + / / 
 + / / private boolean isImported ( String email ) { 
 + / / return preferences ( ) . getBool ( " book _ email _ " + email . toLowerCase ( ) , false ) ; 
 + / / } 
 + / / 
 + / / private void markImported ( long phone ) { 
 + / / preferences ( ) . putBool ( " book _ phone _ " + phone , true ) ; 
 + / / } 
 + / / 
 + / / private void markImported ( String email ) { 
 + / / preferences ( ) . putBool ( " book _ email _ " + email . toLowerCase ( ) , true ) ; 
 + / / } 
 
 private void markImported ( ) { 
 context ( ) . getAppStateModule ( ) . onBookImported ( ) ; 
 @ @ - 256 , 4 + 259 , 45 @ @ public class BookImportActor extends ModuleActor { 
 return phoneBook ; 
 } 
 } 
 + 
 + private static abstract class ImportQueueItem { 
 + 
 + } 
 + 
 + private static class ImportPhoneQueueItem extends ImportQueueItem { 
 + 
 + private long phoneNumber ; 
 + private String name ; 
 + 
 + public ImportPhoneQueueItem ( long phoneNumber , String name ) { 
 + this . phoneNumber = phoneNumber ; 
 + this . name = name ; 
 + } 
 + 
 + public long getPhoneNumber ( ) { 
 + return phoneNumber ; 
 + } 
 + 
 + public String getName ( ) { 
 + return name ; 
 + } 
 + } 
 + 
 + private static class ImportEmailQueueItem extends ImportQueueItem { 
 + private String email ; 
 + private String name ; 
 + 
 + public ImportEmailQueueItem ( String email , String name ) { 
 + this . email = email ; 
 + this . name = name ; 
 + } 
 + 
 + public String getEmail ( ) { 
 + return email ; 
 + } 
 + 
 + public String getName ( ) { 
 + return name ; 
 + } 
 + } 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / contacts / entity / BookImportStorage . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / contacts / entity / BookImportStorage . java 
 new file mode 100644 
 index 0000000 . . 093eb8f 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / contacts / entity / BookImportStorage . java 
 @ @ - 0 , 0 + 1 , 68 @ @ 
 + package im . actor . core . modules . internal . contacts . entity ; 
 + 
 + import java . io . IOException ; 
 + import java . util . HashSet ; 
 + 
 + import im . actor . runtime . bser . BserObject ; 
 + import im . actor . runtime . bser . BserValues ; 
 + import im . actor . runtime . bser . BserWriter ; 
 + 
 + public class BookImportStorage extends BserObject { 
 + 
 + private HashSet < String > importedEmails = new HashSet < String > ( ) ; 
 + private HashSet < Long > importedPhones = new HashSet < Long > ( ) ; 
 + 
 + public BookImportStorage ( ) { 
 + } 
 + 
 + public BookImportStorage ( byte [ ] data ) { 
 + super ( ) ; 
 + try { 
 + super . load ( data ) ; 
 + } catch ( IOException e ) { 
 + e . printStackTrace ( ) ; 
 + importedEmails = new HashSet < String > ( ) ; 
 + importedPhones = new HashSet < Long > ( ) ; 
 + } 
 + } 
 + 
 + public void markAsImported ( String email ) { 
 + importedEmails . add ( email ) ; 
 + } 
 + 
 + public void markAsImported ( long phone ) { 
 + importedPhones . add ( ( Long ) phone ) ; 
 + } 
 + 
 + public boolean isImported ( String email ) { 
 + return importedEmails . contains ( email ) ; 
 + } 
 + 
 + public boolean isImported ( long phone ) { 
 + return importedPhones . contains ( phone ) ; 
 + } 
 + 
 + @ Override 
 + public void parse ( BserValues values ) throws IOException { 
 + importedEmails = new HashSet < String > ( ) ; 
 + importedPhones = new HashSet < Long > ( ) ; 
 + 
 + for ( String s : values . getRepeatedString ( 1 ) ) { 
 + importedEmails . add ( s ) ; 
 + } 
 + 
 + for ( Long p : values . getRepeatedLong ( 2 ) ) { 
 + importedPhones . add ( p ) ; 
 + } 
 + } 
 + 
 + @ Override 
 + public void serialize ( BserWriter writer ) throws IOException { 
 + for ( String s : importedEmails ) { 
 + writer . writeString ( 1 , s ) ; 
 + } 
 + for ( Long p : importedPhones ) { 
 + writer . writeLong ( 2 , p ) ; 
 + } 
 + } 
 + }

NEAREST DIFF:
diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / entity / DialogDesc . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / entity / DialogDesc . java 
 new file mode 100644 
 index 0000000 . . bb8078b 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / entity / DialogDesc . java 
 @ @ - 0 , 0 + 1 , 80 @ @ 
 + package im . actor . core . entity ; 
 + 
 + import com . google . j2objc . annotations . Property ; 
 + 
 + import java . io . IOException ; 
 + 
 + import im . actor . runtime . bser . BserObject ; 
 + import im . actor . runtime . bser . BserValues ; 
 + import im . actor . runtime . bser . BserWriter ; 
 + import im . actor . runtime . storage . KeyValueItem ; 
 + 
 + public class DialogDesc extends BserObject implements KeyValueItem { 
 + 
 + @ Property ( " readonly , nonatomic " ) 
 + private Peer peer ; 
 + @ Property ( " readonly , nonatomic " ) 
 + private String title ; 
 + @ Property ( " readonly , nonatomic " ) 
 + private Avatar avatar ; 
 + @ Property ( " readonly , nonatomic " ) 
 + private boolean isUnread ; 
 + @ Property ( " readonly , nonatomic " ) 
 + private int counter ; 
 + 
 + public DialogDesc ( Peer peer , String title , Avatar avatar , boolean isUnread , int counter ) { 
 + this . peer = peer ; 
 + this . title = title ; 
 + this . avatar = avatar ; 
 + this . isUnread = isUnread ; 
 + this . counter = counter ; 
 + } 
 + 
 + public Peer getPeer ( ) { 
 + return peer ; 
 + } 
 + 
 + public String getTitle ( ) { 
 + return title ; 
 + } 
 + 
 + public Avatar getAvatar ( ) { 
 + return avatar ; 
 + } 
 + 
 + public int getCounter ( ) { 
 + return counter ; 
 + } 
 + 
 + public boolean isUnread ( ) { 
 + return isUnread ; 
 + } 
 + 
 + @ Override 
 + public void parse ( BserValues values ) throws IOException { 
 + peer = Peer . fromBytes ( values . getBytes ( 1 ) ) ; 
 + title = values . getString ( 2 ) ; 
 + byte [ ] av = values . getBytes ( 3 ) ; 
 + if ( av ! = null ) { 
 + avatar = new Avatar ( av ) ; 
 + } 
 + counter = values . getInt ( 4 ) ; 
 + isUnread = values . getBool ( 5 ) ; 
 + } 
 + 
 + @ Override 
 + public void serialize ( BserWriter writer ) throws IOException { 
 + writer . writeObject ( 1 , peer ) ; 
 + writer . writeString ( 2 , title ) ; 
 + if ( avatar ! = null ) { 
 + writer . writeObject ( 3 , avatar ) ; 
 + } 
 + writer . writeInt ( 4 , counter ) ; 
 + writer . writeBool ( 5 , isUnread ) ; 
 + } 
 + 
 + @ Override 
 + public long getEngineId ( ) { 
 + return peer . getUnuqueId ( ) ; 
 + } 
 + } 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java 
 index 85714e6 . . 30e0d85 100644 
 - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java 
 + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java 
 @ @ - 35 , 6 + 35 , 7 @ @ import im . actor . core . modules . internal . messages . CursorReaderActor ; 
 import im . actor . core . modules . internal . messages . CursorReceiverActor ; 
 import im . actor . core . modules . internal . messages . DialogsActor ; 
 import im . actor . core . modules . internal . messages . DialogsHistoryActor ; 
 + import im . actor . core . modules . internal . messages . GroupedDialogsActor ; 
 import im . actor . core . modules . internal . messages . MessageDeleteActor ; 
 import im . actor . core . modules . internal . messages . MessageShownActor ; 
 import im . actor . core . modules . internal . messages . MessageShownFilter ; 
 @ @ - 46 , 6 + 47 , 7 @ @ import im . actor . core . network . RpcException ; 
 import im . actor . core . network . RpcInternalException ; 
 import im . actor . core . viewmodel . Command ; 
 import im . actor . core . viewmodel . CommandCallback ; 
 + import im . actor . core . viewmodel . DialogGroupsVM ; 
 import im . actor . runtime . Storage ; 
 import im . actor . runtime . actors . ActorCreator ; 
 import im . actor . runtime . actors . ActorRef ; 
 @ @ - 62 , 8 + 64 , 10 @ @ import static im . actor . runtime . actors . ActorSystem . system ; 
 public class MessagesModule extends AbsModule implements BusSubscriber { 
 
 private ListEngine < Dialog > dialogs ; 
 + 
 private ActorRef dialogsActor ; 
 private ActorRef dialogsHistoryActor ; 
 + private ActorRef dialogsGroupedActor ; 
 private ActorRef ownReadActor ; 
 private ActorRef plainReadActor ; 
 private ActorRef plainReceiverActor ; 
 @ @ - 79 , 6 + 83 , 8 @ @ public class MessagesModule extends AbsModule implements BusSubscriber { 
 
 private final SyncKeyValue cursorStorage ; 
 
 + private final DialogGroupsVM dialogGroups = new DialogGroupsVM ( ) ; 
 + 
 public MessagesModule ( final ModuleContext context ) { 
 super ( context ) ; 
 
 @ @ - 99 , 6 + 105 , 14 @ @ public class MessagesModule extends AbsModule implements BusSubscriber { 
 return new DialogsHistoryActor ( context ( ) ) ; 
 } 
 } ) , " actor / dialogs / history " ) ; 
 + 
 + this . dialogsGroupedActor = system ( ) . actorOf ( Props . create ( GroupedDialogsActor . class , new ActorCreator < GroupedDialogsActor > ( ) { 
 + @ Override 
 + public GroupedDialogsActor create ( ) { 
 + return new GroupedDialogsActor ( context ( ) ) ; 
 + } 
 + } ) , " actor / dialogs / grouped " ) ; 
 + 
 this . ownReadActor = system ( ) . actorOf ( Props . create ( OwnReadActor . class , new ActorCreator < OwnReadActor > ( ) { 
 @ Override 
 public OwnReadActor create ( ) { 
 @ @ - 139 , 6 + 153 , 10 @ @ public class MessagesModule extends AbsModule implements BusSubscriber { 
 context ( ) . getEvents ( ) . subscribe ( this , PeerChatOpened . EVENT ) ; 
 } 
 
 + public DialogGroupsVM getDialogGroupsVM ( ) { 
 + return dialogGroups ; 
 + } 
 + 
 public ActorRef getSendMessageActor ( ) { 
 return sendMessageActor ; 
 } 
 @ @ - 221 , 6 + 239 , 10 @ @ public class MessagesModule extends AbsModule implements BusSubscriber { 
 return dialogsHistoryActor ; 
 } 
 
 + public ActorRef getDialogsGroupedActor ( ) { 
 + return dialogsGroupedActor ; 
 + } 
 + 
 public ListEngine < Dialog > getDialogsEngine ( ) { 
 return dialogs ; 
 } 
 diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java 
 index 6641ed9 . . 8bf76dc 100644 
 - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java 
 + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java 
 @ @ - 44 , 6 + 44 , 7 @ @ public class ConversationActor extends ModuleActor { 
 private IndexStorage outPendingIndex ; 
 private IndexStorage inPendingIndex ; 
 private ActorRef dialogsActor ; 
 + private ActorRef dialogsGroupedActor ; 
 private long inReadState ; 
 private long outReadState ; 
 private long outReceiveState ; 
 @ @ - 62 , 6 + 63 , 7 @ @ public class ConversationActor extends ModuleActor { 
 docs = context ( ) . getMessagesModule ( ) . getConversationDocsEngine ( peer ) ; 
 
 dialogsActor = context ( ) . getMessagesModule ( ) . getDialogsActor ( ) ; 
 + dialogsGroupedActor = context ( ) . getMessagesModule ( ) . getDialogsGroupedActor ( ) ; 
 outPendingIndex = Storage . createIndex ( " out _ pending _ " + peer . getPeerType ( ) + " _ " + peer . getPeerId ( ) ) ; 
 inPendingIndex = Storage . createIndex ( " in _ pending _ " + peer . getPeerType ( ) + " _ " + peer . getPeerId ( ) ) ; 
 
 @ @ - 135 , 6 + 137 , 8 @ @ public class ConversationActor extends ModuleActor { 
 / / Update dialogs 
 if ( topMessage ! = null ) { 
 if ( ! isHiddenPeer ) { 
 + dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , 
 + topMessage . getSortDate ( ) ) ) ; 
 dialogsActor . send ( new DialogsActor . InMessage ( peer , topMessage , inPendingIndex . getCount ( ) ) ) ; 
 } 
 } 
 @ @ - 185 , 6 + 189 , 8 @ @ public class ConversationActor extends ModuleActor { 
 
 if ( ! isHiddenPeer ) { 
 dialogsActor . send ( new DialogsActor . InMessage ( peer , message , inPendingIndex . getCount ( ) ) ) ; 
 + dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , 
 + message . getSortDate ( ) ) ) ; 
 } 
 } 
 } 
 @ @ - 239 , 6 + 245 , 8 @ @ public class ConversationActor extends ModuleActor { 
 if ( ! isHiddenPeer ) { 
 / / Updating dialog 
 dialogsActor . send ( new DialogsActor . InMessage ( peer , updatedMsg , inPendingIndex . getCount ( ) ) ) ; 
 + dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , 
 + updatedMsg . getSortDate ( ) ) ) ; 
 } 
 
 / / Updating pending index 
 @ @ - 361 , 6 + 369 , 7 @ @ public class ConversationActor extends ModuleActor { 
 
 if ( ! isHiddenPeer ) { 
 dialogsActor . send ( new DialogsActor . CounterChanged ( peer , inPendingIndex . getCount ( ) ) ) ; 
 + / / TODO : Implement for grouped 
 } 
 } 
 
 @ @ - 402 , 6 + 411 , 7 @ @ public class ConversationActor extends ModuleActor { 
 inPendingIndex . clear ( ) ; 
 outPendingIndex . clear ( ) ; 
 dialogsActor . send ( new DialogsActor . ChatDelete ( peer ) ) ; 
 + / / TODO : Implement for grouped 
 } 
 
 / / History 
 diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / DialogsActor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / DialogsActor . java 
 index 311de19 . . b77ac37 100644 
 - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / DialogsActor . java 
 + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / DialogsActor . java 
 @ @ - 50 , 7 + 50 , 7 @ @ public class DialogsActor extends ModuleActor { 
 long start = im . actor . runtime . Runtime . getCurrentTime ( ) ; 
 PeerDesc peerDesc = buildPeerDesc ( peer ) ; 
 if ( peerDesc = = null ) { 
 - Log . d ( " DialogsActor " , " unknown peer desk " ) ; 
 + Log . d ( " DialogsActor " , " unknown peer desc " ) ; 
 return ; 
 } 
 
 @ @ - 75 , 8 + 75 , 11 @ @ public class DialogsActor extends ModuleActor { 
 . setText ( contentDescription . getText ( ) ) 
 . setRelatedUid ( contentDescription . getRelatedUser ( ) ) 
 . setStatus ( message . getMessageState ( ) ) 
 - . setSenderId ( message . getSenderId ( ) ) 
 - . setUnreadCount ( counter ) ; 
 + . setSenderId ( message . getSenderId ( ) ) ; 
 + 
 + if ( counter > = 0 ) { 
 + builder . setUnreadCount ( counter ) ; 
 + } 
 
 boolean forceUpdate = false ; 
 
 diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java 
 new file mode 100644 
 index 0000000 . . f0fdf00 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java 
 @ @ - 0 , 0 + 1 , 184 @ @ 
 + package im . actor . core . modules . internal . messages ; 
 + 
 + import java . util . ArrayList ; 
 + import java . util . HashMap ; 
 + 
 + import im . actor . core . entity . Avatar ; 
 + import im . actor . core . entity . DialogDesc ; 
 + import im . actor . core . entity . Peer ; 
 + import im . actor . core . entity . PeerType ; 
 + import im . actor . core . modules . ModuleContext ; 
 + import im . actor . core . modules . utils . ModuleActor ; 
 + import im . actor . core . viewmodel . DialogGroup ; 
 + 
 + public class GroupedDialogsActor extends ModuleActor { 
 + 
 + private PeerGroup groups = new PeerGroup ( " groups " , " Groups " ) ; 
 + private PeerGroup privates = new PeerGroup ( " private " , " Private " ) ; 
 + 
 + public GroupedDialogsActor ( ModuleContext context ) { 
 + super ( context ) ; 
 + } 
 + 
 + @ Override 
 + public void preStart ( ) { 
 + super . preStart ( ) ; 
 + } 
 + 
 + private void onPeerInfoChanged ( Peer peer , String title , Avatar avatar ) { 
 + 
 + } 
 + 
 + private void onNewMessage ( Peer peer , long sortDate , int counter ) { 
 + 
 + PeerGroup peerGroup ; 
 + if ( peer . getPeerType ( ) = = PeerType . GROUP ) { 
 + peerGroup = groups ; 
 + } else if ( peer . getPeerType ( ) = = PeerType . PRIVATE ) { 
 + peerGroup = privates ; 
 + } else { 
 + return ; 
 + } 
 + 
 + boolean found = false ; 
 + for ( PeerDesc d : peerGroup . getPeers ( ) ) { 
 + if ( d . getPeer ( ) . equals ( peer ) ) { 
 + d . setCounter ( counter ) ; 
 + found = true ; 
 + } 
 + } 
 + 
 + if ( ! found ) { 
 + peerGroup . getPeers ( ) . add ( new PeerDesc ( peer , counter ) ) ; 
 + } 
 + 
 + ArrayList < DialogGroup > groups = new ArrayList < DialogGroup > ( ) ; 
 + ArrayList < DialogDesc > groupDescs = new ArrayList < DialogDesc > ( ) ; 
 + for ( PeerDesc d : peerGroup . getPeers ( ) ) { 
 + groupDescs . add ( new DialogDesc ( d . getPeer ( ) , " GRPOUP # " + d . getPeer ( ) . getPeerId ( ) , 
 + null , false , d . counter ) ) ; 
 + } 
 + groups . add ( new DialogGroup ( " Groups " , " group " , groupDescs ) ) ; 
 + 
 + context ( ) . getMessagesModule ( ) . getDialogGroupsVM ( ) . getGroupsValueModel ( ) . change ( groups ) ; 
 + } 
 + 
 + @ Override 
 + public void onReceive ( Object message ) { 
 + if ( message instanceof PeerInformationChanged ) { 
 + PeerInformationChanged informationChanged = ( PeerInformationChanged ) message ; 
 + onPeerInfoChanged ( informationChanged . getPeer ( ) , 
 + informationChanged . getTitle ( ) , 
 + informationChanged . getAvatar ( ) ) ; 
 + } else if ( message instanceof NewMessage ) { 
 + NewMessage newMessage = ( NewMessage ) message ; 
 + onNewMessage ( newMessage . peer , newMessage . sortDate , newMessage . counter ) ; 
 + } else { 
 + super . onReceive ( message ) ; 
 + } 
 + } 
 + 
 + public static class PeerInformationChanged { 
 + 
 + private Peer peer ; 
 + private String title ; 
 + private Avatar avatar ; 
 + 
 + public PeerInformationChanged ( Peer peer , String title , Avatar avatar ) { 
 + this . peer = peer ; 
 + this . title = title ; 
 + this . avatar = avatar ; 
 + } 
 + 
 + public Peer getPeer ( ) { 
 + return peer ; 
 + } 
 + 
 + public String getTitle ( ) { 
 + return title ; 
 + } 
 + 
 + public Avatar getAvatar ( ) { 
 + return avatar ; 
 + } 
 + } 
 + 
 + public static class CounterChanged { 
 + private Peer peer ; 
 + private int counter ; 
 + 
 + public CounterChanged ( Peer peer , int counter ) { 
 + this . peer = peer ; 
 + this . counter = counter ; 
 + } 
 + 
 + public Peer getPeer ( ) { 
 + return peer ; 
 + } 
 + 
 + public int getCounter ( ) { 
 + return counter ; 
 + } 
 + } 
 + 
 + public static class NewMessage { 
 + 
 + private Peer peer ; 
 + private int counter ; 
 + private long sortDate ; 
 + 
 + public NewMessage ( Peer peer , int counter , long sortDate ) { 
 + this . peer = peer ; 
 + this . counter = counter ; 
 + this . sortDate = sortDate ; 
 + } 
 + } 
 + 
 + private class PeerGroup { 
 + 
 + private String key ; 
 + private String title ; 
 + private ArrayList < PeerDesc > peers ; 
 + 
 + public PeerGroup ( String key , String title ) { 
 + this . key = key ; 
 + this . title = title ; 
 + this . peers = new ArrayList < PeerDesc > ( ) ; 
 + } 
 + 
 + public String getKey ( ) { 
 + return key ; 
 + } 
 + 
 + public String getTitle ( ) { 
 + return title ; 
 + } 
 + 
 + public ArrayList < PeerDesc > getPeers ( ) { 
 + return peers ; 
 + } 
 + } 
 + 
 + private class PeerDesc { 
 + 
 + private Peer peer ; 
 + private int counter ; 
 + 
 + public PeerDesc ( Peer peer , int counter ) { 
 + this . peer = peer ; 
 + this . counter = counter ; 
 + } 
 + 
 + public Peer getPeer ( ) { 
 + return peer ; 
 + } 
 + 
 + public int getCounter ( ) { 
 + return counter ; 
 + } 
 + 
 + public void setCounter ( int counter ) { 
 + this . counter = counter ; 
 + } 
 + } 
 + } 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / viewmodel / DialogGroup . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / viewmodel / DialogGroup . java 
 new file mode 100644 
 index 0000000 . . ae47f02 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / viewmodel / DialogGroup . java 
 @ @ - 0 , 0 + 1 , 30 @ @ 
 + package im . actor . core . viewmodel ; 
 + 
 + import java . util . ArrayList ; 
 + 
 + import im . actor . core . entity . DialogDesc ; 
 + 
 + public class DialogGroup { 
 + 
 + private String title ; 
 + private String key ; 
 + private ArrayList < DialogDesc > dialogs ; 
 + 
 + public DialogGroup ( String title , String key , ArrayList < DialogDesc > dialogs ) { 
 + this . title = title ; 
 + this . key = key ; 
 + this . dialogs = dialogs ; 
 + } 
 + 
 + public String getTitle ( ) { 
 + return title ; 
 + } 
 + 
 + public String getKey ( ) { 
 + return key ; 
 + } 
 + 
 + public ArrayList < DialogDesc > getDialogs ( ) { 
 + return dialogs ; 
 + } 
 + } 
 diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / viewmodel / DialogGroupsVM . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / viewmodel / DialogGroupsVM . java 
 new file mode 100644 
 index 0000000 . . 0a374ba 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / viewmodel / DialogGroupsVM . java 
 @ @ - 0 , 0 + 1 , 18 @ @ 
 + package im . actor . core . viewmodel ; 
 + 
 + import java . util . ArrayList ; 
 + 
 + import im . actor . runtime . mvvm . ValueModel ; 
 + 
 + public class DialogGroupsVM { 
 + 
 + private ValueModel < ArrayList < DialogGroup > > groupsValueModel ; 
 + 
 + public DialogGroupsVM ( ) { 
 + groupsValueModel = new ValueModel < ArrayList < DialogGroup > > ( " groups . model " , null ) ; 
 + } 
 + 
 + public ValueModel < ArrayList < DialogGroup > > getGroupsValueModel ( ) { 
 + return groupsValueModel ; 
 + } 
 + } 
 diff - - git a / actor - sdk / sdk - core / runtime / android / src / main / java / im / actor / runtime / android / storage / SQLiteKeyValue . java b / actor - sdk / sdk - core / runtime / android / src / main / java / im / actor / runtime / android / storage / SQLiteKeyValue . java 
 index 530cb4b . . 31e2f0e 100644 
 - - - a / actor - sdk / sdk - core / runtime / android / src / main / java / im / actor / runtime / android / storage / SQLiteKeyValue . java 
 + + + b / actor - sdk / sdk - core / runtime / android / src / main / java / im / actor / runtime / android / storage / SQLiteKeyValue . java 
 @ @ - 119 , 21 + 119 , 9 @ @ public class SQLiteKeyValue implements KeyValueStorage { 
 } 
 
 @ Override 
 - public void clear ( ) { 
 - checkSqlite ( ) ; 
 - db . beginTransaction ( ) ; 
 - try { 
 - db . execSQL ( " DELETE FROM \ " " + name + " \ " " ) ; 
 - db . setTransactionSuccessful ( ) ; 
 - } finally { 
 - db . endTransaction ( ) ; 
 - } 
 - } 
 - 
 - @ Override 
 - public byte [ ] getValue ( long id ) { 
 + public byte [ ] loadItem ( long key ) { 
 checkSqlite ( ) ; 
 - Cursor cursor = db . query ( " \ " " + name + " \ " " , new String [ ] { " \ " BYTES \ " " } , " \ " ID \ " = ? " , new String [ ] { " " + id } , null , null , null ) ; 
 + Cursor cursor = db . query ( " \ " " + name + " \ " " , new String [ ] { " \ " BYTES \ " " } , " \ " ID \ " = ? " , new String [ ] { " " + key } , null , null , null ) ; 
 if ( cursor = = null ) { 
 return null ; 
 } 
 @ @ - 146 , 4 + 134 , 26 @ @ public class SQLiteKeyValue implements KeyValueStorage { 
 } 
 return null ; 
 } 
 + 
 + @ Override 
 + public List < KeyValueRecord > loadItems ( long [ ] keys ) { 
 + return null ; 
 + } 
 + 
 + @ Override 
 + public List < KeyValueRecord > loadAllItems ( ) { 
 + return null ; 
 + } 
 + 
 + @ Override 
 + public void clear ( ) { 
 + checkSqlite ( ) ; 
 + db . beginTransaction ( ) ; 
 + try { 
 + db . execSQL ( " DELETE FROM \ " " + name + " \ " " ) ; 
 + db . setTransactionSuccessful ( ) ; 
 + } finally { 
 + db . endTransaction ( ) ; 
 + } 
 + } 
 } 
 diff - - git a / actor - sdk / sdk - core / runtime / android / src / main / java / im / actor / runtime / android / storage / SQLiteList . java b / actor - sdk / sdk - core / runtime / android / src / main / java / im / actor / runtime / android / storage / SQLiteList . java 
 index b153387 . . 25b59e1 100644 
 - - - a / actor - sdk / sdk - core / runtime / android / src / main / java / im / actor / runtime / android / storage / SQLiteList . java 
 + + + b / actor - sdk / sdk - core / runtime / android / src / main / java / im / actor / runtime / android / storage / SQLiteList . java 
 @ @ - 124 , 6 + 124 , 11 @ @ public class SQLiteList implements ListStorageDisplayEx { 
 return null ; 
 } 
 
 + @ Override 
 + public List < ListEngineRecord > loadAllItems ( ) { 
 + return null ; 
 + } 
 + 
 
 public ListEngineRecord loadItemBySortKey ( long key ) { 
 checkTable ( ) ; 
 diff - - git a / actor - sdk / sdk - core / runtime / shared / src / main / java / im / actor / runtime / storage / KeyValueEngine . java b / actor - sdk / sdk - core / runtime / shared / src / main / java / im / actor / runtime / storage / KeyValueEngine . java 
 index 60239e4 . . c7dd481 100644 
 - - - a / actor - sdk / sdk - core / runtime / shared / src / main / java / im / actor / runtime / storage / KeyValueEngine . java 
 + + + b / actor - sdk / sdk - core / runtime / shared / src / main / java / im / actor / runtime / storage / KeyValueEngine . java 
 @ @ - 9 , 6 + 9 , 7 @ @ import com . google . j2objc . annotations . ObjectiveCName ; 
 import java . util . List ; 
 
 public interface KeyValueEngine < V extends KeyValueItem > { 
 + 
 @ ObjectiveCName ( " addOrUpdateItem : " ) 
 void addOrUpdateItem ( V item ) ; 
 
 diff - - git a / actor - sdk / sdk - ios / ActorSDK / Sources / ActorCore / Providers / Storage / FMDBKeyValue . swift b / actor - sdk / sdk - ios / ActorSDK / Sources / ActorCore / Providers / Storage / FMDBKeyValue . swift 
 index fb65f46 . . c22c65a 100644 
 - - - a / actor - sdk / sdk - ios / ActorSDK / Sources / ActorCore / Providers / Storage / FMDBKeyValue . swift 
 + + + b / actor - sdk / sdk - ios / ActorSDK / Sources / ActorCore / Providers / Storage / FMDBKeyValue . swift 
 @ @ - 5 , 18 + 5 , 21 @ @ 
 import Foundation 
 
 @ objc class FMDBKeyValue : NSObject , ARKeyValueStorage { 
 - var db : FMDatabase ? ; 
 + 
 + var db : FMDatabase ! 
 
 - let databasePath : String ; 
 - let tableName : String ; 
 + let databasePath : String 
 + let tableName : String 
 
 - let queryCreate : String ; 
 - let queryItem : String ; 
 - let queryAdd : String ; 
 - let queryDelete : String ; 
 - let queryDeleteAll : String ; 
 + let queryCreate : String 
 + let queryItem : String 
 + let queryItems : String 
 + let queryAll : String 
 + let queryAdd : String 
 + let queryDelete : String 
 + let queryDeleteAll : String 
 
 - var isTableChecked : Bool = false ; 
 + var isTableChecked : Bool = false 
 
 init ( databasePath : String , tableName : String ) { 
 self . databasePath = databasePath 
 @ @ - 26 , 11 + 29 , 13 @ @ import Foundation 
 self . queryCreate = " CREATE TABLE IF NOT EXISTS " + tableName + " ( " + 
 " \ " ID \ " INTEGER NOT NULL , " + 
 " \ " BYTES \ " BLOB NOT NULL , " + 
 - " PRIMARY KEY ( \ " ID \ " ) ) ; " ; 
 - self . queryItem = " SELECT \ " BYTES \ " FROM " + tableName + " WHERE \ " ID \ " = ? ; " ; 
 - self . queryAdd = " REPLACE INTO " + tableName + " ( \ " ID \ " , \ " BYTES \ " ) VALUES ( ? , ? ) ; " ; 
 - self . queryDelete = " DELETE FROM " + tableName + " WHERE \ " ID \ " = ? ; " ; 
 - self . queryDeleteAll = " DELETE FROM " + tableName + " ; " ; 
 + " PRIMARY KEY ( \ " ID \ " ) ) ; " 
 + self . queryItem = " SELECT \ " BYTES \ " FROM " + tableName + " WHERE \ " ID \ " = ? ; " 
 + self . queryItems = " SELECT ( \ " ID \ " , \ " BYTES \ " ) FROM " + tableName + " WHERE \ " ID \ " in ? ; " 
 + self . queryAll = " SELECT ( \ " ID \ " , \ " BYTES \ " ) FROM " + tableName + " ; " 
 + self . queryAdd = " REPLACE INTO " + tableName + " ( \ " ID \ " , \ " BYTES \ " ) VALUES ( ? , ? ) ; " 
 + self . queryDelete = " DELETE FROM " + tableName + " WHERE \ " ID \ " = ? ; " 
 + self . queryDeleteAll = " DELETE FROM " + tableName + " ; " 
 
 super . init ( ) 
 } 
 @ @ - 39 , 68 + 44 , 103 @ @ import Foundation 
 if ( isTableChecked ) { 
 return 
 } 
 - isTableChecked = true ; 
 + isTableChecked = true 
 
 self . db = FMDatabase ( path : databasePath ) 
 - self . db ! . open ( ) 
 - if ( ! db ! . tableExists ( tableName ) ) { 
 - db ! . executeUpdate ( queryCreate ) 
 + self . db . open ( ) 
 + if ( ! db . tableExists ( tableName ) ) { 
 + db . executeUpdate ( queryCreate ) 
 } 
 } 
 
 func addOrUpdateItems ( values : JavaUtilList ! ) { 
 - checkTable ( ) ; 
 + checkTable ( ) 
 
 - db ! . beginTransaction ( ) 
 + db . beginTransaction ( ) 
 for i in 0 . . < values . size ( ) { 
 - let record = values . getWithInt ( i ) as ! ARKeyValueRecord ; 
 - db ! . executeUpdate ( queryAdd , record . getId ( ) . toNSNumber ( ) , record . getData ( ) ! . toNSData ( ) ) 
 + let record = values . getWithInt ( i ) as ! ARKeyValueRecord 
 + db . executeUpdate ( queryAdd , record . getId ( ) . toNSNumber ( ) , record . getData ( ) ! . toNSData ( ) ) 
 } 
 - db ! . commit ( ) 
 + db . commit ( ) 
 } 
 
 func addOrUpdateItemWithKey ( key : jlong , withData data : IOSByteArray ! ) { 
 - checkTable ( ) ; 
 + checkTable ( ) 
 
 - db ! . beginTransaction ( ) 
 - db ! . executeUpdate ( queryAdd , key . toNSNumber ( ) , data ! . toNSData ( ) ) 
 - db ! . commit ( ) 
 + db . beginTransaction ( ) 
 + db . executeUpdate ( queryAdd , key . toNSNumber ( ) , data ! . toNSData ( ) ) 
 + db . commit ( ) 
 } 
 
 func removeItemsWithKeys ( keys : IOSLongArray ! ) { 
 - checkTable ( ) ; 
 + checkTable ( ) 
 
 - db ! . beginTransaction ( ) 
 + db . beginTransaction ( ) 
 for i in 0 . . < keys . length ( ) { 
 let key = keys . longAtIndex ( UInt ( i ) ) ; 
 - db ! . executeUpdate ( queryDelete , key . toNSNumber ( ) ) 
 + db . executeUpdate ( queryDelete , key . toNSNumber ( ) ) 
 } 
 - db ! . commit ( ) 
 + db . commit ( ) 
 } 
 
 func removeItemWithKey ( key : jlong ) { 
 - checkTable ( ) ; 
 + checkTable ( ) 
 
 - db ! . beginTransaction ( ) 
 - db ! . executeUpdate ( queryDelete , key . toNSNumber ( ) ) 
 - db ! . commit ( ) 
 + db . beginTransaction ( ) 
 + db . executeUpdate ( queryDelete , key . toNSNumber ( ) ) 
 + db . commit ( ) 
 } 
 
 - func getValueWithKey ( key : jlong ) - > IOSByteArray ! { 
 - checkTable ( ) ; 
 + func loadItemWithKey ( key : jlong ) - > IOSByteArray ! { 
 + checkTable ( ) 
 
 - let result = db ! . dataForQuery ( queryItem , key . toNSNumber ( ) ) ; 
 + let result = db . dataForQuery ( queryItem , key . toNSNumber ( ) ) 
 if ( result = = nil ) { 
 - return nil ; 
 + return nil 
 + } 
 + return result . toJavaBytes ( ) 
 + } 
 + 
 + func loadAllItems ( ) - > JavaUtilList ! { 
 + checkTable ( ) 
 + 
 + let res = JavaUtilArrayList ( ) 
 + 
 + if let result = db . executeQuery ( queryAll ) { 
 + while ( result . next ( ) ) { 
 + res . addWithId ( ARKeyValueRecord ( key : jlong ( result . longLongIntForColumn ( " ID " ) ) , withData : result . dataForColumn ( " BYTES " ) . toJavaBytes ( ) ) ) 
 + } 
 + } 
 + 
 + return res 
 + } 
 + 
 + func loadItems ( keys : IOSLongArray ! ) - > JavaUtilList ! { 
 + checkTable ( ) 
 + 
 + / / Converting to NSNumbers 
 + var ids = [ NSNumber ] ( ) 
 + for i in 0 . . < keys . length ( ) { 
 + ids . append ( keys . longAtIndex ( UInt ( i ) ) . toNSNumber ( ) ) 
 } 
 - return result . toJavaBytes ( ) ; 
 + 
 + let res = JavaUtilArrayList ( ) 
 + 
 + if let result = db . executeQuery ( queryItems , ids ) { 
 + while ( result . next ( ) ) { 
 + / / TODO : Optimize lookup 
 + res . addWithId ( ARKeyValueRecord ( key : jlong ( result . longLongIntForColumn ( " ID " ) ) , withData : result . dataForColumn ( " BYTES " ) . toJavaBytes ( ) ) ) 
 + } 
 + } 
 + 
 + return res 
 } 
 
 func clear ( ) { 
 - checkTable ( ) ; 
 + checkTable ( ) 
 
 - db ! . beginTransaction ( ) 
 - db ! . executeUpdate ( queryDeleteAll ) ; 
 - db ! . commit ( ) 
 + db . beginTransaction ( ) 
 + db . executeUpdate ( queryDeleteAll ) 
 + db . commit ( ) 
 } 
 } 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - ios / ActorSDK / Sources / ActorCore / Providers / Storage / FMDBList . swift b / actor - sdk / sdk - ios / ActorSDK / Sources / ActorCore / Providers / Storage / FMDBList . swift 
 index 27ac7e7 . . 209a6e3 100644 
 - - - a / actor - sdk / sdk - ios / ActorSDK / Sources / ActorCore / Providers / Storage / FMDBList . swift 
 + + + b / actor - sdk / sdk - ios / ActorSDK / Sources / ActorCore / Providers / Storage / FMDBList . swift 
 @ @ - 199 , 6 + 199 , 12 @ @ class FMDBList : NSObject , ARListStorageDisplayEx { 
 } 
 } 
 
 + func loadAllItems ( ) - > JavaUtilList ! { 
 + let res = JavaUtilArrayList ( ) 
 + / / TODO : Implement 
 + return res 
 + } 
 + 
 func loadForwardWithSortKey ( sortingKey : JavaLangLong ! , withLimit limit : jint ) - > JavaUtilList ! { 
 checkTable ( ) ; 
 var result : FMResultSet ? = nil ;
