BLEU SCORE: 0.07270717733704592

TEST MSG: feat ( core ) : Implemented ReadByMe counter handling
GENERATED MSG: wip ( sdk ) : Grouped dialogs counter updated , peer information changes

TEST DIFF (one line): diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / UpdateProcessor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / UpdateProcessor . java < nl > index 78ca7f2 . . d1e9d92 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / UpdateProcessor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / UpdateProcessor . java < nl > @ @ - 185 , 8 + 185 , 8 @ @ public class UpdateProcessor extends AbsModule { < nl > } < nl > < nl > for ( Peer peer : combinedDifference . getReadByMe ( ) . keySet ( ) ) { < nl > - long time = combinedDifference . getReadByMe ( ) . get ( peer ) ; < nl > - messagesProcessor . onMessageReadByMe ( buildApiPeer ( peer ) , time , 0 ) ; < nl > + CombinedDifference . ReadByMeValue time = combinedDifference . getReadByMe ( ) . get ( peer ) ; < nl > + messagesProcessor . onMessageReadByMe ( buildApiPeer ( peer ) , time . getDate ( ) , time . getCounter ( ) ) ; < nl > } < nl > < nl > for ( Peer peer : combinedDifference . getMessages ( ) . keySet ( ) ) { < nl > @ @ - 255 , 7 + 255 , 11 @ @ public class UpdateProcessor extends AbsModule { < nl > messagesProcessor . onMessageRead ( messageRead . getPeer ( ) , messageRead . getStartDate ( ) ) ; < nl > } else if ( update instanceof UpdateMessageReadByMe ) { < nl > UpdateMessageReadByMe messageReadByMe = ( UpdateMessageReadByMe ) update ; < nl > - messagesProcessor . onMessageReadByMe ( messageReadByMe . getPeer ( ) , messageReadByMe . getStartDate ( ) , 0 ) ; < nl > + if ( messageReadByMe . getUnreadCounter ( ) ! = null ) { < nl > + messagesProcessor . onMessageReadByMe ( messageReadByMe . getPeer ( ) , messageReadByMe . getStartDate ( ) , messageReadByMe . getUnreadCounter ( ) ) ; < nl > + } else { < nl > + messagesProcessor . onMessageReadByMe ( messageReadByMe . getPeer ( ) , messageReadByMe . getStartDate ( ) , 0 ) ; < nl > + } < nl > } else if ( update instanceof UpdateMessageReceived ) { < nl > UpdateMessageReceived received = ( UpdateMessageReceived ) update ; < nl > messagesProcessor . onMessageReceived ( received . getPeer ( ) , received . getStartDate ( ) ) ; < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / internal / CombinedDifference . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / internal / CombinedDifference . java < nl > index 074ce7d . . 6a5306c 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / internal / CombinedDifference . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / internal / CombinedDifference . java < nl > @ @ - 12 , 22 + 12 , 13 @ @ import im . actor . core . network . parser . Update ; < nl > < nl > public class CombinedDifference { < nl > < nl > - private HashMap < Peer , Long > readByMe = new HashMap < Peer , Long > ( ) ; < nl > - private HashMap < Peer , Long > read = new HashMap < Peer , Long > ( ) ; < nl > - private HashMap < Peer , Long > received = new HashMap < Peer , Long > ( ) ; < nl > - private HashMap < Peer , List < UpdateMessage > > messages = new HashMap < Peer , List < UpdateMessage > > ( ) ; < nl > - private List < Update > otherUpdates = new ArrayList < Update > ( ) ; < nl > - private ApiAppCounters counters ; < nl > - < nl > - public ApiAppCounters getCounters ( ) { < nl > - return counters ; < nl > - } < nl > - < nl > - public void setCounters ( ApiAppCounters counters ) { < nl > - this . counters = counters ; < nl > - } < nl > + private HashMap < Peer , ReadByMeValue > readByMe = new HashMap < > ( ) ; < nl > + private HashMap < Peer , Long > read = new HashMap < > ( ) ; < nl > + private HashMap < Peer , Long > received = new HashMap < > ( ) ; < nl > + private HashMap < Peer , List < UpdateMessage > > messages = new HashMap < > ( ) ; < nl > + private List < Update > otherUpdates = new ArrayList < > ( ) ; < nl > < nl > - public HashMap < Peer , Long > getReadByMe ( ) { < nl > + public HashMap < Peer , ReadByMeValue > getReadByMe ( ) { < nl > return readByMe ; < nl > } < nl > < nl > @ @ - 52 , 14 + 43 , 20 @ @ public class CombinedDifference { < nl > if ( messages . containsKey ( peer ) ) { < nl > messages . get ( peer ) . add ( message ) ; < nl > } else { < nl > - ArrayList < UpdateMessage > msgs = new ArrayList < UpdateMessage > ( ) ; < nl > + ArrayList < UpdateMessage > msgs = new ArrayList < > ( ) ; < nl > msgs . add ( message ) ; < nl > messages . put ( peer , msgs ) ; < nl > } < nl > } < nl > < nl > - public void putReadByMe ( Peer peer , long date ) { < nl > - put ( readByMe , peer , date ) ; < nl > + public void putReadByMe ( Peer peer , long date , int counter ) { < nl > + if ( readByMe . containsKey ( peer ) ) { < nl > + if ( readByMe . get ( peer ) . date < = date ) { < nl > + readByMe . put ( peer , new ReadByMeValue ( date , counter ) ) ; < nl > + } < nl > + } else { < nl > + readByMe . put ( peer , new ReadByMeValue ( date , counter ) ) ; < nl > + } < nl > } < nl > < nl > public void putRead ( Peer peer , long date ) { < nl > @ @ - 91 , 4 + 88 , 23 @ @ public class CombinedDifference { < nl > map . put ( peer , date ) ; < nl > } < nl > } < nl > + < nl > + public static class ReadByMeValue { < nl > + < nl > + private long date ; < nl > + private int counter ; < nl > + < nl > + public ReadByMeValue ( long date , int counter ) { < nl > + this . date = date ; < nl > + this . counter = counter ; < nl > + } < nl > + < nl > + public long getDate ( ) { < nl > + return date ; < nl > + } < nl > + < nl > + public int getCounter ( ) { < nl > + return counter ; < nl > + } < nl > + } < nl > } < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / internal / GetDiffCombiner . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / internal / GetDiffCombiner . java < nl > index bbd8044 . . 7b702da 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / internal / GetDiffCombiner . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / internal / GetDiffCombiner . java < nl > @ @ - 30 , 9 + 30 , 13 @ @ public class GetDiffCombiner { < nl > res . putReceived ( convert ( received . getPeer ( ) ) , received . getStartDate ( ) ) ; < nl > } else if ( u instanceof UpdateMessageReadByMe ) { < nl > UpdateMessageReadByMe readByMe = ( UpdateMessageReadByMe ) u ; < nl > - res . putReadByMe ( convert ( readByMe . getPeer ( ) ) , readByMe . getStartDate ( ) ) ; < nl > + int counter = 0 ; < nl > + if ( readByMe . getUnreadCounter ( ) ! = null ) { < nl > + counter = readByMe . getUnreadCounter ( ) ; < nl > + } < nl > + res . putReadByMe ( convert ( readByMe . getPeer ( ) ) , readByMe . getStartDate ( ) , counter ) ; < nl > } else if ( u instanceof UpdateCountersChanged ) { < nl > - res . setCounters ( ( ( UpdateCountersChanged ) u ) . getCounters ( ) ) ; < nl > + / / Ignore < nl > } else if ( u instanceof UpdateUserNameChanged ) { < nl > / / Ignore < nl > } else if ( u instanceof UpdateUserLocalNameChanged ) {
NEAREST DIFF (one line): diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java < nl > index 8bf76dc . . 5f112bd 100644 < nl > - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java < nl > + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java < nl > @ @ - 137 , 10 + 137 , 10 @ @ public class ConversationActor extends ModuleActor { < nl > / / Update dialogs < nl > if ( topMessage ! = null ) { < nl > if ( ! isHiddenPeer ) { < nl > - dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , < nl > - topMessage . getSortDate ( ) ) ) ; < nl > dialogsActor . send ( new DialogsActor . InMessage ( peer , topMessage , inPendingIndex . getCount ( ) ) ) ; < nl > } < nl > + dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , < nl > + topMessage . getSortDate ( ) ) ) ; < nl > } < nl > } < nl > < nl > @ @ - 189 , 9 + 189 , 9 @ @ public class ConversationActor extends ModuleActor { < nl > < nl > if ( ! isHiddenPeer ) { < nl > dialogsActor . send ( new DialogsActor . InMessage ( peer , message , inPendingIndex . getCount ( ) ) ) ; < nl > - dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , < nl > - message . getSortDate ( ) ) ) ; < nl > } < nl > + dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , < nl > + message . getSortDate ( ) ) ) ; < nl > } < nl > } < nl > < nl > @ @ - 276 , 6 + 276 , 7 @ @ public class ConversationActor extends ModuleActor { < nl > dialogsActor . send ( new DialogsActor . MessageStateChanged ( peer , rid , < nl > MessageState . ERROR ) ) ; < nl > } < nl > + dialogsGroupedActor . send ( new GroupedDialogsActor . CounterChanged ( peer , inPendingIndex . getCount ( ) ) ) ; < nl > } < nl > } < nl > < nl > @ @ - 369 , 8 + 370 , 8 @ @ public class ConversationActor extends ModuleActor { < nl > < nl > if ( ! isHiddenPeer ) { < nl > dialogsActor . send ( new DialogsActor . CounterChanged ( peer , inPendingIndex . getCount ( ) ) ) ; < nl > - / / TODO : Implement for grouped < nl > } < nl > + dialogsGroupedActor . send ( new GroupedDialogsActor . CounterChanged ( peer , inPendingIndex . getCount ( ) ) ) ; < nl > } < nl > < nl > / / Deletions < nl > @ @ - 402 , 6 + 403 , 7 @ @ public class ConversationActor extends ModuleActor { < nl > inPendingIndex . clear ( ) ; < nl > outPendingIndex . clear ( ) ; < nl > dialogsActor . send ( new DialogsActor . ChatClear ( peer ) ) ; < nl > + / / TODO : Implement for grouped < nl > } < nl > < nl > @ Verified < nl > diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java < nl > index dc1143a . . b6d002a 100644 < nl > - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java < nl > + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java < nl > @ @ - 52 , 6 + 52 , 13 @ @ public class GroupedDialogsActor extends ModuleActor { < nl > DialogSpec spec = new DialogSpec ( peer , false , counter ) ; < nl > specs . getEngine ( ) . addOrUpdateItem ( spec ) ; < nl > < nl > + / / Doesn ' t create dialogs for hidden groups < nl > + if ( peer . getPeerType ( ) = = PeerType . GROUP ) { < nl > + if ( getGroup ( peer . getPeerId ( ) ) . isHidden ( ) ) { < nl > + return ; < nl > + } < nl > + } < nl > + < nl > boolean found = false ; < nl > for ( Peer p : storage . getPrivatePeers ( ) ) { < nl > if ( p . equals ( peer ) ) { < nl > @ @ - 120 , 8 + 127 , 55 @ @ public class GroupedDialogsActor extends ModuleActor { < nl > context ( ) . getMessagesModule ( ) . getDialogGroupsVM ( ) . getGroupsValueModel ( ) . change ( groups ) ; < nl > } < nl > < nl > + private void onCounterChanged ( Peer peer , int counter ) { < nl > + < nl > + DialogSpec spec = new DialogSpec ( peer , false , counter ) ; < nl > + specs . getEngine ( ) . addOrUpdateItem ( spec ) ; < nl > + < nl > + / / Hidden groups doesn ' t present in storage < nl > + / / and there are no need to explicit checking < nl > + < nl > + boolean found = false ; < nl > + for ( Peer p : storage . getPrivatePeers ( ) ) { < nl > + if ( p . equals ( peer ) ) { < nl > + found = true ; < nl > + break ; < nl > + } < nl > + } < nl > + for ( Peer p : storage . getGroupPeers ( ) ) { < nl > + if ( p . equals ( peer ) ) { < nl > + found = true ; < nl > + break ; < nl > + } < nl > + } < nl > + < nl > + if ( found ) { < nl > + notifyVM ( ) ; < nl > + } < nl > + } < nl > + < nl > private void onPeerInfoChanged ( Peer peer , String title , Avatar avatar ) { < nl > - / / TODO : Implement < nl > + < nl > + / / Hidden groups doesn ' t present in storage < nl > + / / and there are no need to explicit checking < nl > + < nl > + boolean found = false ; < nl > + for ( Peer p : storage . getPrivatePeers ( ) ) { < nl > + if ( p . equals ( peer ) ) { < nl > + found = true ; < nl > + break ; < nl > + } < nl > + } < nl > + for ( Peer p : storage . getGroupPeers ( ) ) { < nl > + if ( p . equals ( peer ) ) { < nl > + found = true ; < nl > + break ; < nl > + } < nl > + } < nl > + < nl > + if ( found ) { < nl > + notifyVM ( ) ; < nl > + } < nl > } < nl > < nl > < nl > @ @ - 139 , 6 + 193 , 9 @ @ public class GroupedDialogsActor extends ModuleActor { < nl > } else if ( message instanceof NewMessage ) { < nl > NewMessage newMessage = ( NewMessage ) message ; < nl > onNewMessage ( newMessage . peer , newMessage . sortDate , newMessage . counter ) ; < nl > + } else if ( message instanceof CounterChanged ) { < nl > + CounterChanged counterChanged = ( CounterChanged ) message ; < nl > + onCounterChanged ( counterChanged . getPeer ( ) , counterChanged . getCounter ( ) ) ; < nl > } else { < nl > super . onReceive ( message ) ; < nl > } < nl > @ @ - 188 , 7 + 245 , 6 @ @ public class GroupedDialogsActor extends ModuleActor { < nl > } < nl > < nl > public static class NewMessage { < nl > - < nl > private Peer peer ; < nl > private int counter ; < nl > private long sortDate ; < nl > @ @ - 199 , 52 + 255 , 4 @ @ public class GroupedDialogsActor extends ModuleActor { < nl > this . sortDate = sortDate ; < nl > } < nl > } < nl > - < nl > - private class PeerGroup { < nl > - < nl > - private String key ; < nl > - private String title ; < nl > - private ArrayList < PeerDesc > peers ; < nl > - < nl > - public PeerGroup ( String key , String title ) { < nl > - this . key = key ; < nl > - this . title = title ; < nl > - this . peers = new ArrayList < PeerDesc > ( ) ; < nl > - } < nl > - < nl > - public String getKey ( ) { < nl > - return key ; < nl > - } < nl > - < nl > - public String getTitle ( ) { < nl > - return title ; < nl > - } < nl > - < nl > - public ArrayList < PeerDesc > getPeers ( ) { < nl > - return peers ; < nl > - } < nl > - } < nl > - < nl > - private class PeerDesc { < nl > - < nl > - private Peer peer ; < nl > - private int counter ; < nl > - < nl > - public PeerDesc ( Peer peer , int counter ) { < nl > - this . peer = peer ; < nl > - this . counter = counter ; < nl > - } < nl > - < nl > - public Peer getPeer ( ) { < nl > - return peer ; < nl > - } < nl > - < nl > - public int getCounter ( ) { < nl > - return counter ; < nl > - } < nl > - < nl > - public void setCounter ( int counter ) { < nl > - this . counter = counter ; < nl > - } < nl > - } < nl > } < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / users / UsersProcessor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / users / UsersProcessor . java < nl > index 74487be . . dfbc311 100644 < nl > - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / users / UsersProcessor . java < nl > + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / users / UsersProcessor . java < nl > @ @ - 10 , 12 + 10 , 14 @ @ import im . actor . core . api . updates . UpdateUserAvatarChanged ; < nl > import im . actor . core . api . updates . UpdateUserLocalNameChanged ; < nl > import im . actor . core . api . updates . UpdateUserNameChanged ; < nl > import im . actor . core . api . updates . UpdateUserNickChanged ; < nl > + import im . actor . core . entity . Peer ; < nl > import im . actor . core . entity . User ; < nl > import im . actor . core . modules . AbsModule ; < nl > import im . actor . core . modules . ModuleContext ; < nl > import im . actor . core . modules . Processor ; < nl > import im . actor . core . modules . internal . contacts . ContactsSyncActor ; < nl > import im . actor . core . modules . internal . messages . DialogsActor ; < nl > + import im . actor . core . modules . internal . messages . GroupedDialogsActor ; < nl > import im . actor . runtime . annotations . Verified ; < nl > < nl > import static im . actor . core . util . JavaUtil . equalsE ; < nl > @ @ - 193 , 6 + 195 , 9 @ @ public class UsersProcessor extends AbsModule implements Processor { < nl > private void onUserDescChanged ( User u ) { < nl > context ( ) . getMessagesModule ( ) . getDialogsActor ( ) . send ( < nl > new DialogsActor . UserChanged ( u ) ) ; < nl > + context ( ) . getMessagesModule ( ) . getDialogsGroupedActor ( ) . send ( < nl > + new GroupedDialogsActor . PeerInformationChanged ( Peer . user ( u . getUid ( ) ) , < nl > + u . getName ( ) , u . getAvatar ( ) ) ) ; < nl > context ( ) . getContactsModule ( ) . getContactSyncActor ( ) < nl > . send ( new ContactsSyncActor . UserChanged ( u ) ) ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / updates / GroupsProcessor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / updates / GroupsProcessor . java < nl > index 0c0a457 . . e430293 100644 < nl > - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / updates / GroupsProcessor . java < nl > + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / updates / GroupsProcessor . java < nl > @ @ - 16 , 6 + 16 , 7 @ @ import im . actor . core . api . ApiMember ; < nl > import im . actor . core . entity . Group ; < nl > import im . actor . core . entity . Message ; < nl > import im . actor . core . entity . MessageState ; < nl > + import im . actor . core . entity . Peer ; < nl > import im . actor . core . entity . content . ServiceGroupAvatarChanged ; < nl > import im . actor . core . entity . content . ServiceGroupCreated ; < nl > import im . actor . core . entity . content . ServiceGroupTitleChanged ; < nl > @ @ - 25 , 6 + 26 , 7 @ @ import im . actor . core . entity . content . ServiceGroupUserLeave ; < nl > import im . actor . core . modules . AbsModule ; < nl > import im . actor . core . modules . ModuleContext ; < nl > import im . actor . core . modules . internal . messages . DialogsActor ; < nl > + import im . actor . core . modules . internal . messages . GroupedDialogsActor ; < nl > import im . actor . core . modules . internal . messages . entity . EntityConverter ; < nl > import im . actor . runtime . annotations . Verified ; < nl > < nl > @ @ - 298 , 5 + 300 , 8 @ @ public class GroupsProcessor extends AbsModule { < nl > private void onGroupDescChanged ( Group group ) { < nl > context ( ) . getMessagesModule ( ) . getDialogsActor ( ) < nl > . send ( new DialogsActor . GroupChanged ( group ) ) ; < nl > + context ( ) . getMessagesModule ( ) . getDialogsGroupedActor ( ) . send ( < nl > + new GroupedDialogsActor . PeerInformationChanged ( Peer . group ( group . getGroupId ( ) ) , < nl > + group . getTitle ( ) , group . getAvatar ( ) ) ) ; < nl > } < nl > } < nl > \ No newline at end of file

TEST DIFF:
diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / UpdateProcessor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / UpdateProcessor . java 
 index 78ca7f2 . . d1e9d92 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / UpdateProcessor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / UpdateProcessor . java 
 @ @ - 185 , 8 + 185 , 8 @ @ public class UpdateProcessor extends AbsModule { 
 } 
 
 for ( Peer peer : combinedDifference . getReadByMe ( ) . keySet ( ) ) { 
 - long time = combinedDifference . getReadByMe ( ) . get ( peer ) ; 
 - messagesProcessor . onMessageReadByMe ( buildApiPeer ( peer ) , time , 0 ) ; 
 + CombinedDifference . ReadByMeValue time = combinedDifference . getReadByMe ( ) . get ( peer ) ; 
 + messagesProcessor . onMessageReadByMe ( buildApiPeer ( peer ) , time . getDate ( ) , time . getCounter ( ) ) ; 
 } 
 
 for ( Peer peer : combinedDifference . getMessages ( ) . keySet ( ) ) { 
 @ @ - 255 , 7 + 255 , 11 @ @ public class UpdateProcessor extends AbsModule { 
 messagesProcessor . onMessageRead ( messageRead . getPeer ( ) , messageRead . getStartDate ( ) ) ; 
 } else if ( update instanceof UpdateMessageReadByMe ) { 
 UpdateMessageReadByMe messageReadByMe = ( UpdateMessageReadByMe ) update ; 
 - messagesProcessor . onMessageReadByMe ( messageReadByMe . getPeer ( ) , messageReadByMe . getStartDate ( ) , 0 ) ; 
 + if ( messageReadByMe . getUnreadCounter ( ) ! = null ) { 
 + messagesProcessor . onMessageReadByMe ( messageReadByMe . getPeer ( ) , messageReadByMe . getStartDate ( ) , messageReadByMe . getUnreadCounter ( ) ) ; 
 + } else { 
 + messagesProcessor . onMessageReadByMe ( messageReadByMe . getPeer ( ) , messageReadByMe . getStartDate ( ) , 0 ) ; 
 + } 
 } else if ( update instanceof UpdateMessageReceived ) { 
 UpdateMessageReceived received = ( UpdateMessageReceived ) update ; 
 messagesProcessor . onMessageReceived ( received . getPeer ( ) , received . getStartDate ( ) ) ; 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / internal / CombinedDifference . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / internal / CombinedDifference . java 
 index 074ce7d . . 6a5306c 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / internal / CombinedDifference . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / internal / CombinedDifference . java 
 @ @ - 12 , 22 + 12 , 13 @ @ import im . actor . core . network . parser . Update ; 
 
 public class CombinedDifference { 
 
 - private HashMap < Peer , Long > readByMe = new HashMap < Peer , Long > ( ) ; 
 - private HashMap < Peer , Long > read = new HashMap < Peer , Long > ( ) ; 
 - private HashMap < Peer , Long > received = new HashMap < Peer , Long > ( ) ; 
 - private HashMap < Peer , List < UpdateMessage > > messages = new HashMap < Peer , List < UpdateMessage > > ( ) ; 
 - private List < Update > otherUpdates = new ArrayList < Update > ( ) ; 
 - private ApiAppCounters counters ; 
 - 
 - public ApiAppCounters getCounters ( ) { 
 - return counters ; 
 - } 
 - 
 - public void setCounters ( ApiAppCounters counters ) { 
 - this . counters = counters ; 
 - } 
 + private HashMap < Peer , ReadByMeValue > readByMe = new HashMap < > ( ) ; 
 + private HashMap < Peer , Long > read = new HashMap < > ( ) ; 
 + private HashMap < Peer , Long > received = new HashMap < > ( ) ; 
 + private HashMap < Peer , List < UpdateMessage > > messages = new HashMap < > ( ) ; 
 + private List < Update > otherUpdates = new ArrayList < > ( ) ; 
 
 - public HashMap < Peer , Long > getReadByMe ( ) { 
 + public HashMap < Peer , ReadByMeValue > getReadByMe ( ) { 
 return readByMe ; 
 } 
 
 @ @ - 52 , 14 + 43 , 20 @ @ public class CombinedDifference { 
 if ( messages . containsKey ( peer ) ) { 
 messages . get ( peer ) . add ( message ) ; 
 } else { 
 - ArrayList < UpdateMessage > msgs = new ArrayList < UpdateMessage > ( ) ; 
 + ArrayList < UpdateMessage > msgs = new ArrayList < > ( ) ; 
 msgs . add ( message ) ; 
 messages . put ( peer , msgs ) ; 
 } 
 } 
 
 - public void putReadByMe ( Peer peer , long date ) { 
 - put ( readByMe , peer , date ) ; 
 + public void putReadByMe ( Peer peer , long date , int counter ) { 
 + if ( readByMe . containsKey ( peer ) ) { 
 + if ( readByMe . get ( peer ) . date < = date ) { 
 + readByMe . put ( peer , new ReadByMeValue ( date , counter ) ) ; 
 + } 
 + } else { 
 + readByMe . put ( peer , new ReadByMeValue ( date , counter ) ) ; 
 + } 
 } 
 
 public void putRead ( Peer peer , long date ) { 
 @ @ - 91 , 4 + 88 , 23 @ @ public class CombinedDifference { 
 map . put ( peer , date ) ; 
 } 
 } 
 + 
 + public static class ReadByMeValue { 
 + 
 + private long date ; 
 + private int counter ; 
 + 
 + public ReadByMeValue ( long date , int counter ) { 
 + this . date = date ; 
 + this . counter = counter ; 
 + } 
 + 
 + public long getDate ( ) { 
 + return date ; 
 + } 
 + 
 + public int getCounter ( ) { 
 + return counter ; 
 + } 
 + } 
 } 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / internal / GetDiffCombiner . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / internal / GetDiffCombiner . java 
 index bbd8044 . . 7b702da 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / internal / GetDiffCombiner . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / sequence / internal / GetDiffCombiner . java 
 @ @ - 30 , 9 + 30 , 13 @ @ public class GetDiffCombiner { 
 res . putReceived ( convert ( received . getPeer ( ) ) , received . getStartDate ( ) ) ; 
 } else if ( u instanceof UpdateMessageReadByMe ) { 
 UpdateMessageReadByMe readByMe = ( UpdateMessageReadByMe ) u ; 
 - res . putReadByMe ( convert ( readByMe . getPeer ( ) ) , readByMe . getStartDate ( ) ) ; 
 + int counter = 0 ; 
 + if ( readByMe . getUnreadCounter ( ) ! = null ) { 
 + counter = readByMe . getUnreadCounter ( ) ; 
 + } 
 + res . putReadByMe ( convert ( readByMe . getPeer ( ) ) , readByMe . getStartDate ( ) , counter ) ; 
 } else if ( u instanceof UpdateCountersChanged ) { 
 - res . setCounters ( ( ( UpdateCountersChanged ) u ) . getCounters ( ) ) ; 
 + / / Ignore 
 } else if ( u instanceof UpdateUserNameChanged ) { 
 / / Ignore 
 } else if ( u instanceof UpdateUserLocalNameChanged ) {

NEAREST DIFF:
diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java 
 index 8bf76dc . . 5f112bd 100644 
 - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java 
 + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java 
 @ @ - 137 , 10 + 137 , 10 @ @ public class ConversationActor extends ModuleActor { 
 / / Update dialogs 
 if ( topMessage ! = null ) { 
 if ( ! isHiddenPeer ) { 
 - dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , 
 - topMessage . getSortDate ( ) ) ) ; 
 dialogsActor . send ( new DialogsActor . InMessage ( peer , topMessage , inPendingIndex . getCount ( ) ) ) ; 
 } 
 + dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , 
 + topMessage . getSortDate ( ) ) ) ; 
 } 
 } 
 
 @ @ - 189 , 9 + 189 , 9 @ @ public class ConversationActor extends ModuleActor { 
 
 if ( ! isHiddenPeer ) { 
 dialogsActor . send ( new DialogsActor . InMessage ( peer , message , inPendingIndex . getCount ( ) ) ) ; 
 - dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , 
 - message . getSortDate ( ) ) ) ; 
 } 
 + dialogsGroupedActor . send ( new GroupedDialogsActor . NewMessage ( peer , inPendingIndex . getCount ( ) , 
 + message . getSortDate ( ) ) ) ; 
 } 
 } 
 
 @ @ - 276 , 6 + 276 , 7 @ @ public class ConversationActor extends ModuleActor { 
 dialogsActor . send ( new DialogsActor . MessageStateChanged ( peer , rid , 
 MessageState . ERROR ) ) ; 
 } 
 + dialogsGroupedActor . send ( new GroupedDialogsActor . CounterChanged ( peer , inPendingIndex . getCount ( ) ) ) ; 
 } 
 } 
 
 @ @ - 369 , 8 + 370 , 8 @ @ public class ConversationActor extends ModuleActor { 
 
 if ( ! isHiddenPeer ) { 
 dialogsActor . send ( new DialogsActor . CounterChanged ( peer , inPendingIndex . getCount ( ) ) ) ; 
 - / / TODO : Implement for grouped 
 } 
 + dialogsGroupedActor . send ( new GroupedDialogsActor . CounterChanged ( peer , inPendingIndex . getCount ( ) ) ) ; 
 } 
 
 / / Deletions 
 @ @ - 402 , 6 + 403 , 7 @ @ public class ConversationActor extends ModuleActor { 
 inPendingIndex . clear ( ) ; 
 outPendingIndex . clear ( ) ; 
 dialogsActor . send ( new DialogsActor . ChatClear ( peer ) ) ; 
 + / / TODO : Implement for grouped 
 } 
 
 @ Verified 
 diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java 
 index dc1143a . . b6d002a 100644 
 - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java 
 + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / messages / GroupedDialogsActor . java 
 @ @ - 52 , 6 + 52 , 13 @ @ public class GroupedDialogsActor extends ModuleActor { 
 DialogSpec spec = new DialogSpec ( peer , false , counter ) ; 
 specs . getEngine ( ) . addOrUpdateItem ( spec ) ; 
 
 + / / Doesn ' t create dialogs for hidden groups 
 + if ( peer . getPeerType ( ) = = PeerType . GROUP ) { 
 + if ( getGroup ( peer . getPeerId ( ) ) . isHidden ( ) ) { 
 + return ; 
 + } 
 + } 
 + 
 boolean found = false ; 
 for ( Peer p : storage . getPrivatePeers ( ) ) { 
 if ( p . equals ( peer ) ) { 
 @ @ - 120 , 8 + 127 , 55 @ @ public class GroupedDialogsActor extends ModuleActor { 
 context ( ) . getMessagesModule ( ) . getDialogGroupsVM ( ) . getGroupsValueModel ( ) . change ( groups ) ; 
 } 
 
 + private void onCounterChanged ( Peer peer , int counter ) { 
 + 
 + DialogSpec spec = new DialogSpec ( peer , false , counter ) ; 
 + specs . getEngine ( ) . addOrUpdateItem ( spec ) ; 
 + 
 + / / Hidden groups doesn ' t present in storage 
 + / / and there are no need to explicit checking 
 + 
 + boolean found = false ; 
 + for ( Peer p : storage . getPrivatePeers ( ) ) { 
 + if ( p . equals ( peer ) ) { 
 + found = true ; 
 + break ; 
 + } 
 + } 
 + for ( Peer p : storage . getGroupPeers ( ) ) { 
 + if ( p . equals ( peer ) ) { 
 + found = true ; 
 + break ; 
 + } 
 + } 
 + 
 + if ( found ) { 
 + notifyVM ( ) ; 
 + } 
 + } 
 + 
 private void onPeerInfoChanged ( Peer peer , String title , Avatar avatar ) { 
 - / / TODO : Implement 
 + 
 + / / Hidden groups doesn ' t present in storage 
 + / / and there are no need to explicit checking 
 + 
 + boolean found = false ; 
 + for ( Peer p : storage . getPrivatePeers ( ) ) { 
 + if ( p . equals ( peer ) ) { 
 + found = true ; 
 + break ; 
 + } 
 + } 
 + for ( Peer p : storage . getGroupPeers ( ) ) { 
 + if ( p . equals ( peer ) ) { 
 + found = true ; 
 + break ; 
 + } 
 + } 
 + 
 + if ( found ) { 
 + notifyVM ( ) ; 
 + } 
 } 
 
 
 @ @ - 139 , 6 + 193 , 9 @ @ public class GroupedDialogsActor extends ModuleActor { 
 } else if ( message instanceof NewMessage ) { 
 NewMessage newMessage = ( NewMessage ) message ; 
 onNewMessage ( newMessage . peer , newMessage . sortDate , newMessage . counter ) ; 
 + } else if ( message instanceof CounterChanged ) { 
 + CounterChanged counterChanged = ( CounterChanged ) message ; 
 + onCounterChanged ( counterChanged . getPeer ( ) , counterChanged . getCounter ( ) ) ; 
 } else { 
 super . onReceive ( message ) ; 
 } 
 @ @ - 188 , 7 + 245 , 6 @ @ public class GroupedDialogsActor extends ModuleActor { 
 } 
 
 public static class NewMessage { 
 - 
 private Peer peer ; 
 private int counter ; 
 private long sortDate ; 
 @ @ - 199 , 52 + 255 , 4 @ @ public class GroupedDialogsActor extends ModuleActor { 
 this . sortDate = sortDate ; 
 } 
 } 
 - 
 - private class PeerGroup { 
 - 
 - private String key ; 
 - private String title ; 
 - private ArrayList < PeerDesc > peers ; 
 - 
 - public PeerGroup ( String key , String title ) { 
 - this . key = key ; 
 - this . title = title ; 
 - this . peers = new ArrayList < PeerDesc > ( ) ; 
 - } 
 - 
 - public String getKey ( ) { 
 - return key ; 
 - } 
 - 
 - public String getTitle ( ) { 
 - return title ; 
 - } 
 - 
 - public ArrayList < PeerDesc > getPeers ( ) { 
 - return peers ; 
 - } 
 - } 
 - 
 - private class PeerDesc { 
 - 
 - private Peer peer ; 
 - private int counter ; 
 - 
 - public PeerDesc ( Peer peer , int counter ) { 
 - this . peer = peer ; 
 - this . counter = counter ; 
 - } 
 - 
 - public Peer getPeer ( ) { 
 - return peer ; 
 - } 
 - 
 - public int getCounter ( ) { 
 - return counter ; 
 - } 
 - 
 - public void setCounter ( int counter ) { 
 - this . counter = counter ; 
 - } 
 - } 
 } 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / users / UsersProcessor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / users / UsersProcessor . java 
 index 74487be . . dfbc311 100644 
 - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / users / UsersProcessor . java 
 + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / internal / users / UsersProcessor . java 
 @ @ - 10 , 12 + 10 , 14 @ @ import im . actor . core . api . updates . UpdateUserAvatarChanged ; 
 import im . actor . core . api . updates . UpdateUserLocalNameChanged ; 
 import im . actor . core . api . updates . UpdateUserNameChanged ; 
 import im . actor . core . api . updates . UpdateUserNickChanged ; 
 + import im . actor . core . entity . Peer ; 
 import im . actor . core . entity . User ; 
 import im . actor . core . modules . AbsModule ; 
 import im . actor . core . modules . ModuleContext ; 
 import im . actor . core . modules . Processor ; 
 import im . actor . core . modules . internal . contacts . ContactsSyncActor ; 
 import im . actor . core . modules . internal . messages . DialogsActor ; 
 + import im . actor . core . modules . internal . messages . GroupedDialogsActor ; 
 import im . actor . runtime . annotations . Verified ; 
 
 import static im . actor . core . util . JavaUtil . equalsE ; 
 @ @ - 193 , 6 + 195 , 9 @ @ public class UsersProcessor extends AbsModule implements Processor { 
 private void onUserDescChanged ( User u ) { 
 context ( ) . getMessagesModule ( ) . getDialogsActor ( ) . send ( 
 new DialogsActor . UserChanged ( u ) ) ; 
 + context ( ) . getMessagesModule ( ) . getDialogsGroupedActor ( ) . send ( 
 + new GroupedDialogsActor . PeerInformationChanged ( Peer . user ( u . getUid ( ) ) , 
 + u . getName ( ) , u . getAvatar ( ) ) ) ; 
 context ( ) . getContactsModule ( ) . getContactSyncActor ( ) 
 . send ( new ContactsSyncActor . UserChanged ( u ) ) ; 
 } 
 diff - - git a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / updates / GroupsProcessor . java b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / updates / GroupsProcessor . java 
 index 0c0a457 . . e430293 100644 
 - - - a / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / updates / GroupsProcessor . java 
 + + + b / actor - sdk / sdk - core / core / shared / src / main / java / im / actor / core / modules / updates / GroupsProcessor . java 
 @ @ - 16 , 6 + 16 , 7 @ @ import im . actor . core . api . ApiMember ; 
 import im . actor . core . entity . Group ; 
 import im . actor . core . entity . Message ; 
 import im . actor . core . entity . MessageState ; 
 + import im . actor . core . entity . Peer ; 
 import im . actor . core . entity . content . ServiceGroupAvatarChanged ; 
 import im . actor . core . entity . content . ServiceGroupCreated ; 
 import im . actor . core . entity . content . ServiceGroupTitleChanged ; 
 @ @ - 25 , 6 + 26 , 7 @ @ import im . actor . core . entity . content . ServiceGroupUserLeave ; 
 import im . actor . core . modules . AbsModule ; 
 import im . actor . core . modules . ModuleContext ; 
 import im . actor . core . modules . internal . messages . DialogsActor ; 
 + import im . actor . core . modules . internal . messages . GroupedDialogsActor ; 
 import im . actor . core . modules . internal . messages . entity . EntityConverter ; 
 import im . actor . runtime . annotations . Verified ; 
 
 @ @ - 298 , 5 + 300 , 8 @ @ public class GroupsProcessor extends AbsModule { 
 private void onGroupDescChanged ( Group group ) { 
 context ( ) . getMessagesModule ( ) . getDialogsActor ( ) 
 . send ( new DialogsActor . GroupChanged ( group ) ) ; 
 + context ( ) . getMessagesModule ( ) . getDialogsGroupedActor ( ) . send ( 
 + new GroupedDialogsActor . PeerInformationChanged ( Peer . group ( group . getGroupId ( ) ) , 
 + group . getTitle ( ) , group . getAvatar ( ) ) ) ; 
 } 
 } 
 \ No newline at end of file
