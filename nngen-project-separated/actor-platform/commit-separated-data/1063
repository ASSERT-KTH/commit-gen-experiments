BLEU SCORE: 0.2231618068926664

TEST MSG: feat ( core + runtime ) : Implemented ConversationVM
GENERATED MSG: feat ( core ) : New message read algorithm

TEST DIFF (one line): diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java < nl > index 93f26b3 . . fcc627b 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java < nl > @ @ - 69 , 6 + 69 , 7 @ @ import im . actor . core . network . RpcException ; < nl > import im . actor . core . network . RpcInternalException ; < nl > import im . actor . core . viewmodel . Command ; < nl > import im . actor . core . viewmodel . CommandCallback ; < nl > + import im . actor . core . viewmodel . ConversationVM ; < nl > import im . actor . core . viewmodel . DialogGroupsVM ; < nl > import im . actor . core . viewmodel . DialogSpecVM ; < nl > import im . actor . runtime . Storage ; < nl > @ @ - 105 , 6 + 106 , 7 @ @ public class MessagesModule extends AbsModule implements BusSubscriber { < nl > private final HashMap < Peer , ActorRef > conversationActors = new HashMap < Peer , ActorRef > ( ) ; < nl > private final HashMap < Peer , ActorRef > conversationHistoryActors = new HashMap < Peer , ActorRef > ( ) ; < nl > private final HashMap < Peer , ActorRef > messageShownFilter = new HashMap < Peer , ActorRef > ( ) ; < nl > + private final HashMap < Peer , ConversationVM > conversationVms = new HashMap < Peer , ConversationVM > ( ) ; < nl > < nl > private final SyncKeyValue cursorStorage ; < nl > < nl > @ @ - 950 , 6 + 952 , 19 @ @ public class MessagesModule extends AbsModule implements BusSubscriber { < nl > } ; < nl > } < nl > < nl > + public ConversationVM getConversationVM ( Peer peer ) { < nl > + return new ConversationVM ( peer , context ( ) ) ; < nl > + } < nl > + < nl > + public void markAsLoaded ( Peer peer ) { < nl > + preferences ( ) . putBool ( " chat . state _ " + peer , true ) ; < nl > + getConversationVM ( peer ) . getIsLoaded ( ) . change ( true ) ; < nl > + } < nl > + < nl > + public boolean isLoaded ( Peer peer ) { < nl > + return preferences ( ) . getBool ( " chat . state _ " + peer , false ) ; < nl > + } < nl > + < nl > public void resetModule ( ) { < nl > / / TODO : Implement < nl > } < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / ConversationHistoryActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / ConversationHistoryActor . java < nl > index d2c507e . . b58044b 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / ConversationHistoryActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / ConversationHistoryActor . java < nl > @ @ - 42 , 6 + 42 , 8 @ @ public class ConversationHistoryActor extends ModuleActor { < nl > historyLoaded = preferences ( ) . getBool ( KEY _ LOADED , false ) ; < nl > if ( ! preferences ( ) . getBool ( KEY _ LOADED _ INIT , false ) ) { < nl > self ( ) . sendOnce ( new LoadMore ( ) ) ; < nl > + } else { < nl > + context ( ) . getMessagesModule ( ) . markAsLoaded ( peer ) ; < nl > } < nl > } < nl > < nl > @ @ - 83 , 6 + 85 , 10 @ @ public class ConversationHistoryActor extends ModuleActor { < nl > preferences ( ) . putLong ( KEY _ LOADED _ DATE , maxLoadedDate ) ; < nl > preferences ( ) . putBool ( KEY _ LOADED , historyLoaded ) ; < nl > preferences ( ) . putBool ( KEY _ LOADED _ INIT , true ) ; < nl > + < nl > + if ( historyLoaded ) { < nl > + context ( ) . getMessagesModule ( ) . markAsLoaded ( peer ) ; < nl > + } < nl > } < nl > < nl > @ Override < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / ConversationVM . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / ConversationVM . java < nl > new file mode 100644 < nl > index 0000000 . . d0e507b < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / ConversationVM . java < nl > @ @ - 0 , 0 + 1 , 18 @ @ < nl > + package im . actor . core . viewmodel ; < nl > + < nl > + import im . actor . core . entity . Peer ; < nl > + import im . actor . core . modules . ModuleContext ; < nl > + import im . actor . core . viewmodel . generics . BooleanValueModel ; < nl > + < nl > + public class ConversationVM { < nl > + < nl > + private BooleanValueModel isLoaded ; < nl > + < nl > + public ConversationVM ( Peer peer , ModuleContext context ) { < nl > + isLoaded = new BooleanValueModel ( " chat . state . " + peer , context . getMessagesModule ( ) . isLoaded ( peer ) ) ; < nl > + } < nl > + < nl > + public BooleanValueModel getIsLoaded ( ) { < nl > + return isLoaded ; < nl > + } < nl > + } < nl > \ No newline at end of file < nl > diff - - git a / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / mvvm / JsDisplayListBind . java b / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / mvvm / JsDisplayListBind . java < nl > index 21844ef . . e9877ec 100644 < nl > - - - a / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / mvvm / JsDisplayListBind . java < nl > + + + b / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / mvvm / JsDisplayListBind . java < nl > @ @ - 64 , 6 + 64 , 14 @ @ public class JsDisplayListBind < T extends JavaScriptObject , V extends BserObject < nl > * If all messages loaded from bottom of the list < nl > * / < nl > private boolean isOpenBottom ; < nl > + / * * < nl > + * Current window top limit < nl > + * / < nl > + private long windowTop ; < nl > + / * * < nl > + * Current window bottom limit < nl > + * / < nl > + private long windowBottom ; < nl > < nl > / * * < nl > * If list is inited and ready to receive list updates < nl > @ @ - 130 , 8 + 138 , 81 @ @ public class JsDisplayListBind < T extends JavaScriptObject , V extends BserObject < nl > processDirtyOverlays ( ) ; < nl > < nl > isInited = true ; < nl > + windowTop = 0 ; < nl > + isOpenTop = true ; < nl > + windowBottom = 0 ; < nl > isOpenBottom = true ; < nl > + < nl > + notifySubscriber ( ) ; < nl > + } < nl > + < nl > + public void initTop ( int limit ) { < nl > + clearState ( ) ; < nl > + < nl > + long [ ] rids = listEngine . getOrderedIds ( ) ; < nl > + for ( int i = 0 ; i < rids . length & & i < limit ; i + + ) { < nl > + V item = listEngine . getValue ( rids [ i ] ) ; < nl > + if ( item = = null ) { < nl > + Log . w ( " JsDisplayList " , " Unable to find item # " + rids [ i ] ) ; < nl > + continue ; < nl > + } < nl > + values . add ( item ) ; < nl > + jsValues . push ( entityConverter . convert ( item ) ) ; < nl > + < nl > + if ( isOverlaysSupported ) { < nl > + jsOverlays . push ( null ) ; < nl > + isOverlayDirty . add ( true ) ; < nl > + } < nl > + } < nl > + < nl > + processDirtyOverlays ( ) ; < nl > + < nl > + isInited = true ; < nl > + windowTop = 0 ; < nl > isOpenTop = true ; < nl > + if ( rids . length > 0 ) { < nl > + windowBottom = rids [ rids . length - 1 ] ; < nl > + isOpenBottom = false ; < nl > + } else { < nl > + windowBottom = 0 ; < nl > + isOpenBottom = true ; < nl > + } < nl > + < nl > + notifySubscriber ( ) ; < nl > + } < nl > + < nl > + public void loadBottom ( int limit ) { < nl > + if ( ! isInited ) { < nl > + return ; < nl > + } < nl > + if ( isOpenBottom ) { < nl > + return ; < nl > + } < nl > + long [ ] rids = listEngine . getPrevIdsExclusive ( windowBottom ) ; < nl > + for ( int i = 0 ; i < rids . length & & i < limit ; i + + ) { < nl > + V item = listEngine . getValue ( rids [ i ] ) ; < nl > + if ( item = = null ) { < nl > + Log . w ( " JsDisplayList " , " Unable to find item # " + rids [ i ] ) ; < nl > + continue ; < nl > + } < nl > + values . add ( item ) ; < nl > + jsValues . push ( entityConverter . convert ( item ) ) ; < nl > + < nl > + if ( isOverlaysSupported ) { < nl > + jsOverlays . push ( null ) ; < nl > + isOverlayDirty . add ( true ) ; < nl > + } < nl > + } < nl > + < nl > + processDirtyOverlays ( ) ; < nl > + < nl > + if ( rids . length > 0 ) { < nl > + windowBottom = rids [ rids . length - 1 ] ; < nl > + isOpenBottom = false ; < nl > + } else { < nl > + windowBottom = 0 ; < nl > + isOpenBottom = true ; < nl > + } < nl > < nl > notifySubscriber ( ) ; < nl > } < nl > @ @ - 159 , 6 + 240 , 16 @ @ public class JsDisplayListBind < T extends JavaScriptObject , V extends BserObject < nl > private void addItemOrUpdateImpl ( V item ) { < nl > long id = item . getEngineId ( ) ; < nl > long sortKey = item . getEngineSort ( ) ; < nl > + < nl > + if ( ! isOpenTop & & windowTop > sortKey ) { < nl > + / / Doesn ' t fit in top window limit < nl > + return ; < nl > + } < nl > + if ( ! isOpenBottom & & windowBottom < sortKey ) { < nl > + / / Doesn ' t fit in bottom window limit < nl > + return ; < nl > + } < nl > + < nl > for ( int i = 0 ; i < values . size ( ) ; i + + ) { < nl > if ( values . get ( i ) . getEngineId ( ) = = id ) { < nl > values . remove ( i ) ; < nl > diff - - git a / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / storage / JsListEngine . java b / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / storage / JsListEngine . java < nl > index 878ff80 . . db7790e 100644 < nl > - - - a / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / storage / JsListEngine . java < nl > + + + b / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / storage / JsListEngine . java < nl > @ @ - 180 , 6 + 180 , 10 @ @ public class JsListEngine < T extends BserObject & ListEngineItem > implements List < nl > return storage . getOrderedIds ( ) ; < nl > } < nl > < nl > + public long [ ] getPrevIdsExclusive ( long sortKey ) { < nl > + return storage . getPrevIdsExclusive ( sortKey ) ; < nl > + } < nl > + < nl > public void addListener ( JsListEngineCallback < T > callback ) { < nl > if ( ! callbacks . contains ( callback ) ) { < nl > callbacks . add ( callback ) ;
NEAREST DIFF (one line): diff - - git a / actor - sdk / sdk - core / core / core - js / src / main / java / im / actor / core / js / modules / JsIdleModule . java b / actor - sdk / sdk - core / core / core - js / src / main / java / im / actor / core / js / modules / JsIdleModule . java < nl > index 0aeaf46 . . 5997ca8 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - js / src / main / java / im / actor / core / js / modules / JsIdleModule . java < nl > + + + b / actor - sdk / sdk - core / core / core - js / src / main / java / im / actor / core / js / modules / JsIdleModule . java < nl > @ @ - 38 , 7 + 38 , 7 @ @ public class JsIdleModule extends AbsModule { < nl > } < nl > < nl > public void onVisible ( ) { < nl > - idleActor . send ( new IdleActor . OnHidden ( ) ) ; < nl > + idleActor . send ( new IdleActor . OnVisible ( ) ) ; < nl > } < nl > < nl > private static class IdleActor extends ModuleActor implements JsIdleCallback { < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java < nl > index 96b0a87 . . 93f26b3 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java < nl > @ @ - 375 , 27 + 375 , 27 @ @ public class MessagesModule extends AbsModule implements BusSubscriber { < nl > } < nl > < nl > public void onMessageShown ( final Peer peer , final int sender , final long sortDate ) { < nl > - if ( ! context ( ) . getAppStateModule ( ) . getAppStateVM ( ) . getIsAppVisible ( ) . get ( ) ) { < nl > - return ; < nl > - } < nl > - im . actor . runtime . Runtime . dispatch ( new Runnable ( ) { < nl > - @ Override < nl > - public void run ( ) { < nl > - if ( sender ! = myUid ( ) ) { < nl > - if ( ! messageShownFilter . containsKey ( peer ) ) { < nl > - messageShownFilter . put ( peer , system ( ) . actorOf ( Props . create ( MessageShownFilter . class , new ActorCreator < MessageShownFilter > ( ) { < nl > - @ Override < nl > - public MessageShownFilter create ( ) { < nl > - return new MessageShownFilter ( ) ; < nl > - } < nl > - } ) , " actor / shown _ filter _ " + peer . getPeerType ( ) + " _ " + peer . getPeerId ( ) ) ) ; < nl > - } < nl > - < nl > - messageShownFilter . get ( peer ) . send ( new BounceFilterActor . Message ( new MessageShownEvent ( peer , sortDate ) , < nl > - messageShownActor ) ) ; < nl > - } < nl > - } < nl > - } ) ; < nl > + / / if ( ! context ( ) . getAppStateModule ( ) . getAppStateVM ( ) . getIsAppVisible ( ) . get ( ) ) { < nl > + / / return ; < nl > + / / } < nl > + / / im . actor . runtime . Runtime . dispatch ( new Runnable ( ) { < nl > + / / @ Override < nl > + / / public void run ( ) { < nl > + / / if ( sender ! = myUid ( ) ) { < nl > + / / if ( ! messageShownFilter . containsKey ( peer ) ) { < nl > + / / messageShownFilter . put ( peer , system ( ) . actorOf ( Props . create ( MessageShownFilter . class , new ActorCreator < MessageShownFilter > ( ) { < nl > + / / @ Override < nl > + / / public MessageShownFilter create ( ) { < nl > + / / return new MessageShownFilter ( ) ; < nl > + / / } < nl > + / / } ) , " actor / shown _ filter _ " + peer . getPeerType ( ) + " _ " + peer . getPeerId ( ) ) ) ; < nl > + / / } < nl > + / / < nl > + / / messageShownFilter . get ( peer ) . send ( new BounceFilterActor . Message ( new MessageShownEvent ( peer , sortDate ) , < nl > + / / messageShownActor ) ) ; < nl > + / / } < nl > + / / } < nl > + / / } ) ; < nl > } < nl > < nl > public void saveReadState ( Peer peer , long lastReadDate ) { < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java < nl > index 460bd6f . . 79cb7d0 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java < nl > @ @ - 17 , 10 + 17 , 12 @ @ import im . actor . core . entity . content . DocumentContent ; < nl > import im . actor . core . modules . ModuleContext ; < nl > import im . actor . core . modules . events . AppVisibleChanged ; < nl > import im . actor . core . modules . utils . ModuleActor ; < nl > + import im . actor . runtime . Log ; < nl > import im . actor . runtime . Storage ; < nl > import im . actor . runtime . actors . ActorRef ; < nl > import im . actor . runtime . annotations . Verified ; < nl > import im . actor . runtime . eventbus . Event ; < nl > + import im . actor . runtime . storage . IndexEngine ; < nl > import im . actor . runtime . storage . IndexStorage ; < nl > import im . actor . runtime . storage . ListEngine ; < nl > < nl > @ @ - 36 , 6 + 38 , 7 @ @ import im . actor . runtime . storage . ListEngine ; < nl > public class ConversationActor extends ModuleActor { < nl > < nl > private final String IN _ READ _ STATE _ PREF ; < nl > + private final String IN _ READ _ STATE _ NEW _ PREF ; < nl > private final String OUT _ READ _ STATE _ PREF ; < nl > private final String OUT _ RECEIVE _ STATE _ PREF ; < nl > < nl > @ @ - 48 , 9 + 51 , 12 @ @ public class ConversationActor extends ModuleActor { < nl > private IndexStorage inPendingIndex ; < nl > private ActorRef dialogsActor ; < nl > private ActorRef dialogsGroupedActor ; < nl > + private ActorRef readerActor ; < nl > + private long inReadStateNew ; < nl > private long inReadState ; < nl > private long outReadState ; < nl > private long outReceiveState ; < nl > + < nl > private boolean isConversationVisible = false ; < nl > private boolean isAppVisible = false ; < nl > < nl > @ @ - 58 , 6 + 64 , 7 @ @ public class ConversationActor extends ModuleActor { < nl > super ( context ) ; < nl > this . peer = peer ; < nl > this . IN _ READ _ STATE _ PREF = " chat _ state . " + peer + " . in _ read " ; < nl > + this . IN _ READ _ STATE _ NEW _ PREF = " chat _ state . " + peer + " . in _ read _ new " ; < nl > this . OUT _ READ _ STATE _ PREF = " chat _ state . " + peer + " . out _ read " ; < nl > this . OUT _ RECEIVE _ STATE _ PREF = " chat _ state . " + peer + " . out _ receive " ; < nl > } < nl > @ @ - 66 , 13 + 73 , 15 @ @ public class ConversationActor extends ModuleActor { < nl > public void preStart ( ) { < nl > messages = context ( ) . getMessagesModule ( ) . getConversationEngine ( peer ) ; < nl > docs = context ( ) . getMessagesModule ( ) . getConversationDocsEngine ( peer ) ; < nl > + readerActor = context ( ) . getMessagesModule ( ) . getOwnReadActor ( ) ; < nl > < nl > dialogsActor = context ( ) . getMessagesModule ( ) . getDialogsActor ( ) ; < nl > dialogsGroupedActor = context ( ) . getMessagesModule ( ) . getDialogsGroupedActor ( ) ; < nl > - outPendingIndex = Storage . createIndex ( " out _ pending _ " + peer . getPeerType ( ) + " _ " + peer . getPeerId ( ) ) ; < nl > - inPendingIndex = Storage . createIndex ( " in _ pending _ " + peer . getPeerType ( ) + " _ " + peer . getPeerId ( ) ) ; < nl > + outPendingIndex = new IndexEngine ( Storage . createIndex ( " out _ pending _ " + peer . getPeerType ( ) + " _ " + peer . getPeerId ( ) ) ) ; < nl > + inPendingIndex = new IndexEngine ( Storage . createIndex ( " in _ pending _ " + peer . getPeerType ( ) + " _ " + peer . getPeerId ( ) ) ) ; < nl > < nl > inReadState = context ( ) . getPreferences ( ) . getLong ( IN _ READ _ STATE _ PREF , 0 ) ; < nl > + inReadStateNew = context ( ) . getPreferences ( ) . getLong ( IN _ READ _ STATE _ NEW _ PREF , 0 ) ; < nl > outReadState = context ( ) . getPreferences ( ) . getLong ( OUT _ READ _ STATE _ PREF , 0 ) ; < nl > outReceiveState = context ( ) . getPreferences ( ) . getLong ( OUT _ RECEIVE _ STATE _ PREF , 0 ) ; < nl > < nl > @ @ - 86 , 26 + 95 , 30 @ @ public class ConversationActor extends ModuleActor { < nl > / / Visibility state < nl > < nl > private void onConversationVisible ( ) { < nl > + / / Log . d ( " ConversationActor " , " onConversationVisible " ) ; < nl > isConversationVisible = true ; < nl > < nl > if ( isConversationAutoRead ( ) ) { < nl > - checkReadState ( ) ; < nl > + checkReadState ( true ) ; < nl > } < nl > } < nl > < nl > private void onConversationHidden ( ) { < nl > + / / Log . d ( " ConversationActor " , " onConversationHidden " ) ; < nl > isConversationVisible = false ; < nl > } < nl > < nl > private void onAppVisible ( ) { < nl > + / / Log . d ( " ConversationActor " , " onAppVisible " ) ; < nl > isAppVisible = true ; < nl > < nl > if ( isConversationAutoRead ( ) ) { < nl > - checkReadState ( ) ; < nl > + checkReadState ( true ) ; < nl > } < nl > } < nl > < nl > private void onAppHidden ( ) { < nl > + / / Log . d ( " ConversationActor " , " onAppHidden " ) ; < nl > isAppVisible = false ; < nl > } < nl > < nl > @ @ - 113 , 9 + 126 , 6 @ @ public class ConversationActor extends ModuleActor { < nl > return isAppVisible & & isConversationVisible ; < nl > } < nl > < nl > - private void checkReadState ( ) { < nl > - < nl > - } < nl > < nl > / / Messages receive / update < nl > < nl > @ @ - 167 , 6 + 177 , 11 @ @ public class ConversationActor extends ModuleActor { < nl > outPendingIndex . put ( m . getRid ( ) , m . getDate ( ) ) ; < nl > } < nl > } else { < nl > + if ( m . getSortDate ( ) > inReadStateNew ) { < nl > + inReadStateNew = m . getSortDate ( ) ; < nl > + preferences ( ) . putLong ( IN _ READ _ STATE _ NEW _ PREF , inReadStateNew ) ; < nl > + } < nl > + < nl > / / Detecting if message already read < nl > if ( m . getSortDate ( ) > inReadState ) { < nl > / / Writing to income unread storage < nl > @ @ - 175 , 8 + 190 , 14 @ @ public class ConversationActor extends ModuleActor { < nl > } < nl > } < nl > < nl > + / / Reading messages < nl > + if ( isConversationAutoRead ( ) ) { < nl > + checkReadState ( false ) ; < nl > + } < nl > + < nl > / / Update dialogs < nl > if ( topMessage ! = null ) { < nl > + < nl > if ( ! isHiddenPeer ) { < nl > dialogsActor . send ( new DialogsActor . InMessage ( peer , topMessage , inPendingIndex . getCount ( ) ) ) ; < nl > } < nl > @ @ - 214 , 12 + 235 , 18 @ @ public class ConversationActor extends ModuleActor { < nl > < nl > / / Updating dialog if on server < nl > if ( message . isOnServer ( ) ) { < nl > + < nl > if ( message . getSenderId ( ) = = myUid ( ) ) { < nl > / / Adding to unread index if message is unread < nl > if ( message . isOnServer ( ) & & message . getMessageState ( ) ! = MessageState . READ ) { < nl > outPendingIndex . put ( message . getRid ( ) , message . getDate ( ) ) ; < nl > } < nl > } else { < nl > + if ( message . getSortDate ( ) > inReadStateNew ) { < nl > + inReadStateNew = message . getSortDate ( ) ; < nl > + preferences ( ) . putLong ( IN _ READ _ STATE _ NEW _ PREF , inReadStateNew ) ; < nl > + } < nl > + < nl > / / Detecting if message already read < nl > if ( message . getSortDate ( ) > inReadState ) { < nl > / / Writing to income unread storage < nl > @ @ - 227 , 6 + 254 , 10 @ @ public class ConversationActor extends ModuleActor { < nl > } < nl > } < nl > < nl > + if ( isConversationAutoRead ( ) ) { < nl > + checkReadState ( false ) ; < nl > + } < nl > + < nl > if ( ! isHiddenPeer ) { < nl > dialogsActor . send ( new DialogsActor . InMessage ( peer , message , inPendingIndex . getCount ( ) ) ) ; < nl > } < nl > @ @ - 421 , 7 + 452 , 9 @ @ public class ConversationActor extends ModuleActor { < nl > return ; < nl > } < nl > inReadState = date ; < nl > + inReadStateNew = Math . max ( date , inReadStateNew ) ; < nl > preferences ( ) . putLong ( IN _ READ _ STATE _ PREF , date ) ; < nl > + preferences ( ) . putLong ( IN _ READ _ STATE _ NEW _ PREF , inReadStateNew ) ; < nl > < nl > inPendingIndex . removeBeforeValue ( date ) ; < nl > < nl > @ @ - 431 , 6 + 464 , 24 @ @ public class ConversationActor extends ModuleActor { < nl > dialogsGroupedActor . send ( new GroupedDialogsActor . CounterChanged ( peer , inPendingIndex . getCount ( ) ) ) ; < nl > } < nl > < nl > + private void checkReadState ( boolean updateDialogs ) { < nl > + / / Log . d ( " ConversationActor " , " checkReadState " ) ; < nl > + if ( inReadStateNew > inReadState ) { < nl > + / / Log . d ( " ConversationActor " , " reading " ) ; < nl > + inReadState = inReadStateNew ; < nl > + preferences ( ) . putLong ( IN _ READ _ STATE _ PREF , inReadState ) ; < nl > + boolean wasNotNull = inPendingIndex . getCount ( ) ! = 0 ; < nl > + inPendingIndex . clear ( ) ; < nl > + readerActor . send ( new OwnReadActor . MessageRead ( peer , inReadState ) ) ; < nl > + if ( wasNotNull & & updateDialogs ) { < nl > + if ( ! isHiddenPeer ) { < nl > + dialogsActor . send ( new DialogsActor . CounterChanged ( peer , 0 ) ) ; < nl > + } < nl > + dialogsGroupedActor . send ( new GroupedDialogsActor . CounterChanged ( peer , 0 ) ) ; < nl > + } < nl > + } < nl > + } < nl > + < nl > / / Deletions < nl > < nl > @ Verified < nl > @ @ - 460 , 7 + 511 , 10 @ @ public class ConversationActor extends ModuleActor { < nl > inPendingIndex . clear ( ) ; < nl > outPendingIndex . clear ( ) ; < nl > dialogsActor . send ( new DialogsActor . ChatClear ( peer ) ) ; < nl > - / / TODO : Implement for grouped < nl > + inReadStateNew = 0 ; < nl > + inReadState = 0 ; < nl > + preferences ( ) . putLong ( IN _ READ _ STATE _ PREF , inReadState ) ; < nl > + preferences ( ) . putLong ( IN _ READ _ STATE _ NEW _ PREF , inReadStateNew ) ; < nl > } < nl > < nl > @ Verified < nl > @ @ - 470 , 7 + 524 , 10 @ @ public class ConversationActor extends ModuleActor { < nl > inPendingIndex . clear ( ) ; < nl > outPendingIndex . clear ( ) ; < nl > dialogsActor . send ( new DialogsActor . ChatDelete ( peer ) ) ; < nl > - / / TODO : Implement for grouped < nl > + inReadStateNew = 0 ; < nl > + inReadState = 0 ; < nl > + preferences ( ) . putLong ( IN _ READ _ STATE _ PREF , inReadState ) ; < nl > + preferences ( ) . putLong ( IN _ READ _ STATE _ NEW _ PREF , inReadStateNew ) ; < nl > } < nl > < nl > / / History < nl > diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / presence / OwnPresenceActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / presence / OwnPresenceActor . java < nl > index 352a7b4 . . 87bade1 100644 < nl > - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / presence / OwnPresenceActor . java < nl > + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / presence / OwnPresenceActor . java < nl > @ @ - 36 , 7 + 36 , 7 @ @ public class OwnPresenceActor extends ModuleActor implements BusSubscriber { < nl > public void preStart ( ) { < nl > / / isAlwaysOnline = config ( ) . getDeviceCategory ( ) = = DeviceCategory . DESKTOP ; < nl > isAlwaysOnline = false ; < nl > - < nl > + < nl > if ( isAlwaysOnline ) { < nl > self ( ) . sendOnce ( new PerformOnline ( ) ) ; < nl > } else { < nl > diff - - git a / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / websocket / WebSocketConnection . java b / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / websocket / WebSocketConnection . java < nl > index 70d55c4 . . 37c8a37 100644 < nl > - - - a / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / websocket / WebSocketConnection . java < nl > + + + b / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / websocket / WebSocketConnection . java < nl > @ @ - 29 , 7 + 29 , 7 @ @ public class WebSocketConnection extends AsyncConnection { < nl > < nl > @ Override < nl > public void doConnect ( ) { < nl > - Log . d ( TAG , " doConnect " ) ; < nl > + / / Log . d ( TAG , " doConnect " ) ; < nl > < nl > isClosed = true ; < nl > < nl > @ @ - 46 , 7 + 46 , 7 @ @ public class WebSocketConnection extends AsyncConnection { < nl > < nl > @ Override < nl > public void doSend ( byte [ ] data ) { < nl > - Log . d ( TAG , " doSend " ) ; < nl > + / / Log . d ( TAG , " doSend " ) ; < nl > if ( isClosed ) { < nl > return ; < nl > } < nl > @ @ - 59 , 13 + 59 , 13 @ @ public class WebSocketConnection extends AsyncConnection { < nl > < nl > @ Override < nl > public void doClose ( ) { < nl > - Log . d ( TAG , " doClose " ) ; < nl > + / / Log . d ( TAG , " doClose " ) ; < nl > isClosed = true ; < nl > close ( ) ; < nl > } < nl > < nl > private void onRawMessage ( ArrayBuffer message ) { < nl > - Log . d ( TAG , " onRawMessage " ) ; < nl > + / / Log . d ( TAG , " onRawMessage " ) ; < nl > if ( isClosed ) { < nl > return ; < nl > } < nl > @ @ - 73 , 13 + 73 , 13 @ @ public class WebSocketConnection extends AsyncConnection { < nl > } < nl > < nl > private void onRawConnected ( ) { < nl > - Log . d ( TAG , " onRawConnected " ) ; < nl > + / / Log . d ( TAG , " onRawConnected " ) ; < nl > isClosed = false ; < nl > onConnected ( ) ; < nl > } < nl > < nl > private void onRawClosed ( ) { < nl > - Log . d ( TAG , " onRawClosed " ) ; < nl > + / / Log . d ( TAG , " onRawClosed " ) ; < nl > isClosed = true ; < nl > onClosed ( ) ; < nl > } < nl > diff - - git a / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / storage / IndexEngine . java b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / storage / IndexEngine . java < nl > new file mode 100644 < nl > index 0000000 . . 33f7c0e < nl > - - - / dev / null < nl > + + + b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / storage / IndexEngine . java < nl > @ @ - 0 , 0 + 1 , 62 @ @ < nl > + package im . actor . runtime . storage ; < nl > + < nl > + import java . util . List ; < nl > + < nl > + public class IndexEngine implements IndexStorage { < nl > + < nl > + private IndexStorage storage ; < nl > + < nl > + public IndexEngine ( IndexStorage storage ) { < nl > + this . storage = storage ; < nl > + } < nl > + < nl > + @ Override < nl > + public void put ( long key , long value ) { < nl > + storage . put ( key , value ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public Long get ( long key ) { < nl > + return storage . get ( key ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public List < Long > findBeforeValue ( long value ) { < nl > + return storage . findBeforeValue ( value ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public List < Long > removeBeforeValue ( long value ) { < nl > + return storage . removeBeforeValue ( value ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public Long loadTop ( ) { < nl > + return storage . loadTop ( ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public Long loadBottom ( ) { < nl > + return storage . loadBottom ( ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public void remove ( long key ) { < nl > + storage . remove ( key ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public void remove ( List < Long > keys ) { < nl > + storage . remove ( keys ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public int getCount ( ) { < nl > + return storage . getCount ( ) ; < nl > + } < nl > + < nl > + @ Override < nl > + public void clear ( ) { < nl > + storage . clear ( ) ; < nl > + } < nl > + }

TEST DIFF:
diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java 
 index 93f26b3 . . fcc627b 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java 
 @ @ - 69 , 6 + 69 , 7 @ @ import im . actor . core . network . RpcException ; 
 import im . actor . core . network . RpcInternalException ; 
 import im . actor . core . viewmodel . Command ; 
 import im . actor . core . viewmodel . CommandCallback ; 
 + import im . actor . core . viewmodel . ConversationVM ; 
 import im . actor . core . viewmodel . DialogGroupsVM ; 
 import im . actor . core . viewmodel . DialogSpecVM ; 
 import im . actor . runtime . Storage ; 
 @ @ - 105 , 6 + 106 , 7 @ @ public class MessagesModule extends AbsModule implements BusSubscriber { 
 private final HashMap < Peer , ActorRef > conversationActors = new HashMap < Peer , ActorRef > ( ) ; 
 private final HashMap < Peer , ActorRef > conversationHistoryActors = new HashMap < Peer , ActorRef > ( ) ; 
 private final HashMap < Peer , ActorRef > messageShownFilter = new HashMap < Peer , ActorRef > ( ) ; 
 + private final HashMap < Peer , ConversationVM > conversationVms = new HashMap < Peer , ConversationVM > ( ) ; 
 
 private final SyncKeyValue cursorStorage ; 
 
 @ @ - 950 , 6 + 952 , 19 @ @ public class MessagesModule extends AbsModule implements BusSubscriber { 
 } ; 
 } 
 
 + public ConversationVM getConversationVM ( Peer peer ) { 
 + return new ConversationVM ( peer , context ( ) ) ; 
 + } 
 + 
 + public void markAsLoaded ( Peer peer ) { 
 + preferences ( ) . putBool ( " chat . state _ " + peer , true ) ; 
 + getConversationVM ( peer ) . getIsLoaded ( ) . change ( true ) ; 
 + } 
 + 
 + public boolean isLoaded ( Peer peer ) { 
 + return preferences ( ) . getBool ( " chat . state _ " + peer , false ) ; 
 + } 
 + 
 public void resetModule ( ) { 
 / / TODO : Implement 
 } 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / ConversationHistoryActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / ConversationHistoryActor . java 
 index d2c507e . . b58044b 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / ConversationHistoryActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / ConversationHistoryActor . java 
 @ @ - 42 , 6 + 42 , 8 @ @ public class ConversationHistoryActor extends ModuleActor { 
 historyLoaded = preferences ( ) . getBool ( KEY _ LOADED , false ) ; 
 if ( ! preferences ( ) . getBool ( KEY _ LOADED _ INIT , false ) ) { 
 self ( ) . sendOnce ( new LoadMore ( ) ) ; 
 + } else { 
 + context ( ) . getMessagesModule ( ) . markAsLoaded ( peer ) ; 
 } 
 } 
 
 @ @ - 83 , 6 + 85 , 10 @ @ public class ConversationHistoryActor extends ModuleActor { 
 preferences ( ) . putLong ( KEY _ LOADED _ DATE , maxLoadedDate ) ; 
 preferences ( ) . putBool ( KEY _ LOADED , historyLoaded ) ; 
 preferences ( ) . putBool ( KEY _ LOADED _ INIT , true ) ; 
 + 
 + if ( historyLoaded ) { 
 + context ( ) . getMessagesModule ( ) . markAsLoaded ( peer ) ; 
 + } 
 } 
 
 @ Override 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / ConversationVM . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / ConversationVM . java 
 new file mode 100644 
 index 0000000 . . d0e507b 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / viewmodel / ConversationVM . java 
 @ @ - 0 , 0 + 1 , 18 @ @ 
 + package im . actor . core . viewmodel ; 
 + 
 + import im . actor . core . entity . Peer ; 
 + import im . actor . core . modules . ModuleContext ; 
 + import im . actor . core . viewmodel . generics . BooleanValueModel ; 
 + 
 + public class ConversationVM { 
 + 
 + private BooleanValueModel isLoaded ; 
 + 
 + public ConversationVM ( Peer peer , ModuleContext context ) { 
 + isLoaded = new BooleanValueModel ( " chat . state . " + peer , context . getMessagesModule ( ) . isLoaded ( peer ) ) ; 
 + } 
 + 
 + public BooleanValueModel getIsLoaded ( ) { 
 + return isLoaded ; 
 + } 
 + } 
 \ No newline at end of file 
 diff - - git a / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / mvvm / JsDisplayListBind . java b / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / mvvm / JsDisplayListBind . java 
 index 21844ef . . e9877ec 100644 
 - - - a / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / mvvm / JsDisplayListBind . java 
 + + + b / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / mvvm / JsDisplayListBind . java 
 @ @ - 64 , 6 + 64 , 14 @ @ public class JsDisplayListBind < T extends JavaScriptObject , V extends BserObject 
 * If all messages loaded from bottom of the list 
 * / 
 private boolean isOpenBottom ; 
 + / * * 
 + * Current window top limit 
 + * / 
 + private long windowTop ; 
 + / * * 
 + * Current window bottom limit 
 + * / 
 + private long windowBottom ; 
 
 / * * 
 * If list is inited and ready to receive list updates 
 @ @ - 130 , 8 + 138 , 81 @ @ public class JsDisplayListBind < T extends JavaScriptObject , V extends BserObject 
 processDirtyOverlays ( ) ; 
 
 isInited = true ; 
 + windowTop = 0 ; 
 + isOpenTop = true ; 
 + windowBottom = 0 ; 
 isOpenBottom = true ; 
 + 
 + notifySubscriber ( ) ; 
 + } 
 + 
 + public void initTop ( int limit ) { 
 + clearState ( ) ; 
 + 
 + long [ ] rids = listEngine . getOrderedIds ( ) ; 
 + for ( int i = 0 ; i < rids . length & & i < limit ; i + + ) { 
 + V item = listEngine . getValue ( rids [ i ] ) ; 
 + if ( item = = null ) { 
 + Log . w ( " JsDisplayList " , " Unable to find item # " + rids [ i ] ) ; 
 + continue ; 
 + } 
 + values . add ( item ) ; 
 + jsValues . push ( entityConverter . convert ( item ) ) ; 
 + 
 + if ( isOverlaysSupported ) { 
 + jsOverlays . push ( null ) ; 
 + isOverlayDirty . add ( true ) ; 
 + } 
 + } 
 + 
 + processDirtyOverlays ( ) ; 
 + 
 + isInited = true ; 
 + windowTop = 0 ; 
 isOpenTop = true ; 
 + if ( rids . length > 0 ) { 
 + windowBottom = rids [ rids . length - 1 ] ; 
 + isOpenBottom = false ; 
 + } else { 
 + windowBottom = 0 ; 
 + isOpenBottom = true ; 
 + } 
 + 
 + notifySubscriber ( ) ; 
 + } 
 + 
 + public void loadBottom ( int limit ) { 
 + if ( ! isInited ) { 
 + return ; 
 + } 
 + if ( isOpenBottom ) { 
 + return ; 
 + } 
 + long [ ] rids = listEngine . getPrevIdsExclusive ( windowBottom ) ; 
 + for ( int i = 0 ; i < rids . length & & i < limit ; i + + ) { 
 + V item = listEngine . getValue ( rids [ i ] ) ; 
 + if ( item = = null ) { 
 + Log . w ( " JsDisplayList " , " Unable to find item # " + rids [ i ] ) ; 
 + continue ; 
 + } 
 + values . add ( item ) ; 
 + jsValues . push ( entityConverter . convert ( item ) ) ; 
 + 
 + if ( isOverlaysSupported ) { 
 + jsOverlays . push ( null ) ; 
 + isOverlayDirty . add ( true ) ; 
 + } 
 + } 
 + 
 + processDirtyOverlays ( ) ; 
 + 
 + if ( rids . length > 0 ) { 
 + windowBottom = rids [ rids . length - 1 ] ; 
 + isOpenBottom = false ; 
 + } else { 
 + windowBottom = 0 ; 
 + isOpenBottom = true ; 
 + } 
 
 notifySubscriber ( ) ; 
 } 
 @ @ - 159 , 6 + 240 , 16 @ @ public class JsDisplayListBind < T extends JavaScriptObject , V extends BserObject 
 private void addItemOrUpdateImpl ( V item ) { 
 long id = item . getEngineId ( ) ; 
 long sortKey = item . getEngineSort ( ) ; 
 + 
 + if ( ! isOpenTop & & windowTop > sortKey ) { 
 + / / Doesn ' t fit in top window limit 
 + return ; 
 + } 
 + if ( ! isOpenBottom & & windowBottom < sortKey ) { 
 + / / Doesn ' t fit in bottom window limit 
 + return ; 
 + } 
 + 
 for ( int i = 0 ; i < values . size ( ) ; i + + ) { 
 if ( values . get ( i ) . getEngineId ( ) = = id ) { 
 values . remove ( i ) ; 
 diff - - git a / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / storage / JsListEngine . java b / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / storage / JsListEngine . java 
 index 878ff80 . . db7790e 100644 
 - - - a / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / storage / JsListEngine . java 
 + + + b / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / storage / JsListEngine . java 
 @ @ - 180 , 6 + 180 , 10 @ @ public class JsListEngine < T extends BserObject & ListEngineItem > implements List 
 return storage . getOrderedIds ( ) ; 
 } 
 
 + public long [ ] getPrevIdsExclusive ( long sortKey ) { 
 + return storage . getPrevIdsExclusive ( sortKey ) ; 
 + } 
 + 
 public void addListener ( JsListEngineCallback < T > callback ) { 
 if ( ! callbacks . contains ( callback ) ) { 
 callbacks . add ( callback ) ;

NEAREST DIFF:
diff - - git a / actor - sdk / sdk - core / core / core - js / src / main / java / im / actor / core / js / modules / JsIdleModule . java b / actor - sdk / sdk - core / core / core - js / src / main / java / im / actor / core / js / modules / JsIdleModule . java 
 index 0aeaf46 . . 5997ca8 100644 
 - - - a / actor - sdk / sdk - core / core / core - js / src / main / java / im / actor / core / js / modules / JsIdleModule . java 
 + + + b / actor - sdk / sdk - core / core / core - js / src / main / java / im / actor / core / js / modules / JsIdleModule . java 
 @ @ - 38 , 7 + 38 , 7 @ @ public class JsIdleModule extends AbsModule { 
 } 
 
 public void onVisible ( ) { 
 - idleActor . send ( new IdleActor . OnHidden ( ) ) ; 
 + idleActor . send ( new IdleActor . OnVisible ( ) ) ; 
 } 
 
 private static class IdleActor extends ModuleActor implements JsIdleCallback { 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java 
 index 96b0a87 . . 93f26b3 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / MessagesModule . java 
 @ @ - 375 , 27 + 375 , 27 @ @ public class MessagesModule extends AbsModule implements BusSubscriber { 
 } 
 
 public void onMessageShown ( final Peer peer , final int sender , final long sortDate ) { 
 - if ( ! context ( ) . getAppStateModule ( ) . getAppStateVM ( ) . getIsAppVisible ( ) . get ( ) ) { 
 - return ; 
 - } 
 - im . actor . runtime . Runtime . dispatch ( new Runnable ( ) { 
 - @ Override 
 - public void run ( ) { 
 - if ( sender ! = myUid ( ) ) { 
 - if ( ! messageShownFilter . containsKey ( peer ) ) { 
 - messageShownFilter . put ( peer , system ( ) . actorOf ( Props . create ( MessageShownFilter . class , new ActorCreator < MessageShownFilter > ( ) { 
 - @ Override 
 - public MessageShownFilter create ( ) { 
 - return new MessageShownFilter ( ) ; 
 - } 
 - } ) , " actor / shown _ filter _ " + peer . getPeerType ( ) + " _ " + peer . getPeerId ( ) ) ) ; 
 - } 
 - 
 - messageShownFilter . get ( peer ) . send ( new BounceFilterActor . Message ( new MessageShownEvent ( peer , sortDate ) , 
 - messageShownActor ) ) ; 
 - } 
 - } 
 - } ) ; 
 + / / if ( ! context ( ) . getAppStateModule ( ) . getAppStateVM ( ) . getIsAppVisible ( ) . get ( ) ) { 
 + / / return ; 
 + / / } 
 + / / im . actor . runtime . Runtime . dispatch ( new Runnable ( ) { 
 + / / @ Override 
 + / / public void run ( ) { 
 + / / if ( sender ! = myUid ( ) ) { 
 + / / if ( ! messageShownFilter . containsKey ( peer ) ) { 
 + / / messageShownFilter . put ( peer , system ( ) . actorOf ( Props . create ( MessageShownFilter . class , new ActorCreator < MessageShownFilter > ( ) { 
 + / / @ Override 
 + / / public MessageShownFilter create ( ) { 
 + / / return new MessageShownFilter ( ) ; 
 + / / } 
 + / / } ) , " actor / shown _ filter _ " + peer . getPeerType ( ) + " _ " + peer . getPeerId ( ) ) ) ; 
 + / / } 
 + / / 
 + / / messageShownFilter . get ( peer ) . send ( new BounceFilterActor . Message ( new MessageShownEvent ( peer , sortDate ) , 
 + / / messageShownActor ) ) ; 
 + / / } 
 + / / } 
 + / / } ) ; 
 } 
 
 public void saveReadState ( Peer peer , long lastReadDate ) { 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java 
 index 460bd6f . . 79cb7d0 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / messages / ConversationActor . java 
 @ @ - 17 , 10 + 17 , 12 @ @ import im . actor . core . entity . content . DocumentContent ; 
 import im . actor . core . modules . ModuleContext ; 
 import im . actor . core . modules . events . AppVisibleChanged ; 
 import im . actor . core . modules . utils . ModuleActor ; 
 + import im . actor . runtime . Log ; 
 import im . actor . runtime . Storage ; 
 import im . actor . runtime . actors . ActorRef ; 
 import im . actor . runtime . annotations . Verified ; 
 import im . actor . runtime . eventbus . Event ; 
 + import im . actor . runtime . storage . IndexEngine ; 
 import im . actor . runtime . storage . IndexStorage ; 
 import im . actor . runtime . storage . ListEngine ; 
 
 @ @ - 36 , 6 + 38 , 7 @ @ import im . actor . runtime . storage . ListEngine ; 
 public class ConversationActor extends ModuleActor { 
 
 private final String IN _ READ _ STATE _ PREF ; 
 + private final String IN _ READ _ STATE _ NEW _ PREF ; 
 private final String OUT _ READ _ STATE _ PREF ; 
 private final String OUT _ RECEIVE _ STATE _ PREF ; 
 
 @ @ - 48 , 9 + 51 , 12 @ @ public class ConversationActor extends ModuleActor { 
 private IndexStorage inPendingIndex ; 
 private ActorRef dialogsActor ; 
 private ActorRef dialogsGroupedActor ; 
 + private ActorRef readerActor ; 
 + private long inReadStateNew ; 
 private long inReadState ; 
 private long outReadState ; 
 private long outReceiveState ; 
 + 
 private boolean isConversationVisible = false ; 
 private boolean isAppVisible = false ; 
 
 @ @ - 58 , 6 + 64 , 7 @ @ public class ConversationActor extends ModuleActor { 
 super ( context ) ; 
 this . peer = peer ; 
 this . IN _ READ _ STATE _ PREF = " chat _ state . " + peer + " . in _ read " ; 
 + this . IN _ READ _ STATE _ NEW _ PREF = " chat _ state . " + peer + " . in _ read _ new " ; 
 this . OUT _ READ _ STATE _ PREF = " chat _ state . " + peer + " . out _ read " ; 
 this . OUT _ RECEIVE _ STATE _ PREF = " chat _ state . " + peer + " . out _ receive " ; 
 } 
 @ @ - 66 , 13 + 73 , 15 @ @ public class ConversationActor extends ModuleActor { 
 public void preStart ( ) { 
 messages = context ( ) . getMessagesModule ( ) . getConversationEngine ( peer ) ; 
 docs = context ( ) . getMessagesModule ( ) . getConversationDocsEngine ( peer ) ; 
 + readerActor = context ( ) . getMessagesModule ( ) . getOwnReadActor ( ) ; 
 
 dialogsActor = context ( ) . getMessagesModule ( ) . getDialogsActor ( ) ; 
 dialogsGroupedActor = context ( ) . getMessagesModule ( ) . getDialogsGroupedActor ( ) ; 
 - outPendingIndex = Storage . createIndex ( " out _ pending _ " + peer . getPeerType ( ) + " _ " + peer . getPeerId ( ) ) ; 
 - inPendingIndex = Storage . createIndex ( " in _ pending _ " + peer . getPeerType ( ) + " _ " + peer . getPeerId ( ) ) ; 
 + outPendingIndex = new IndexEngine ( Storage . createIndex ( " out _ pending _ " + peer . getPeerType ( ) + " _ " + peer . getPeerId ( ) ) ) ; 
 + inPendingIndex = new IndexEngine ( Storage . createIndex ( " in _ pending _ " + peer . getPeerType ( ) + " _ " + peer . getPeerId ( ) ) ) ; 
 
 inReadState = context ( ) . getPreferences ( ) . getLong ( IN _ READ _ STATE _ PREF , 0 ) ; 
 + inReadStateNew = context ( ) . getPreferences ( ) . getLong ( IN _ READ _ STATE _ NEW _ PREF , 0 ) ; 
 outReadState = context ( ) . getPreferences ( ) . getLong ( OUT _ READ _ STATE _ PREF , 0 ) ; 
 outReceiveState = context ( ) . getPreferences ( ) . getLong ( OUT _ RECEIVE _ STATE _ PREF , 0 ) ; 
 
 @ @ - 86 , 26 + 95 , 30 @ @ public class ConversationActor extends ModuleActor { 
 / / Visibility state 
 
 private void onConversationVisible ( ) { 
 + / / Log . d ( " ConversationActor " , " onConversationVisible " ) ; 
 isConversationVisible = true ; 
 
 if ( isConversationAutoRead ( ) ) { 
 - checkReadState ( ) ; 
 + checkReadState ( true ) ; 
 } 
 } 
 
 private void onConversationHidden ( ) { 
 + / / Log . d ( " ConversationActor " , " onConversationHidden " ) ; 
 isConversationVisible = false ; 
 } 
 
 private void onAppVisible ( ) { 
 + / / Log . d ( " ConversationActor " , " onAppVisible " ) ; 
 isAppVisible = true ; 
 
 if ( isConversationAutoRead ( ) ) { 
 - checkReadState ( ) ; 
 + checkReadState ( true ) ; 
 } 
 } 
 
 private void onAppHidden ( ) { 
 + / / Log . d ( " ConversationActor " , " onAppHidden " ) ; 
 isAppVisible = false ; 
 } 
 
 @ @ - 113 , 9 + 126 , 6 @ @ public class ConversationActor extends ModuleActor { 
 return isAppVisible & & isConversationVisible ; 
 } 
 
 - private void checkReadState ( ) { 
 - 
 - } 
 
 / / Messages receive / update 
 
 @ @ - 167 , 6 + 177 , 11 @ @ public class ConversationActor extends ModuleActor { 
 outPendingIndex . put ( m . getRid ( ) , m . getDate ( ) ) ; 
 } 
 } else { 
 + if ( m . getSortDate ( ) > inReadStateNew ) { 
 + inReadStateNew = m . getSortDate ( ) ; 
 + preferences ( ) . putLong ( IN _ READ _ STATE _ NEW _ PREF , inReadStateNew ) ; 
 + } 
 + 
 / / Detecting if message already read 
 if ( m . getSortDate ( ) > inReadState ) { 
 / / Writing to income unread storage 
 @ @ - 175 , 8 + 190 , 14 @ @ public class ConversationActor extends ModuleActor { 
 } 
 } 
 
 + / / Reading messages 
 + if ( isConversationAutoRead ( ) ) { 
 + checkReadState ( false ) ; 
 + } 
 + 
 / / Update dialogs 
 if ( topMessage ! = null ) { 
 + 
 if ( ! isHiddenPeer ) { 
 dialogsActor . send ( new DialogsActor . InMessage ( peer , topMessage , inPendingIndex . getCount ( ) ) ) ; 
 } 
 @ @ - 214 , 12 + 235 , 18 @ @ public class ConversationActor extends ModuleActor { 
 
 / / Updating dialog if on server 
 if ( message . isOnServer ( ) ) { 
 + 
 if ( message . getSenderId ( ) = = myUid ( ) ) { 
 / / Adding to unread index if message is unread 
 if ( message . isOnServer ( ) & & message . getMessageState ( ) ! = MessageState . READ ) { 
 outPendingIndex . put ( message . getRid ( ) , message . getDate ( ) ) ; 
 } 
 } else { 
 + if ( message . getSortDate ( ) > inReadStateNew ) { 
 + inReadStateNew = message . getSortDate ( ) ; 
 + preferences ( ) . putLong ( IN _ READ _ STATE _ NEW _ PREF , inReadStateNew ) ; 
 + } 
 + 
 / / Detecting if message already read 
 if ( message . getSortDate ( ) > inReadState ) { 
 / / Writing to income unread storage 
 @ @ - 227 , 6 + 254 , 10 @ @ public class ConversationActor extends ModuleActor { 
 } 
 } 
 
 + if ( isConversationAutoRead ( ) ) { 
 + checkReadState ( false ) ; 
 + } 
 + 
 if ( ! isHiddenPeer ) { 
 dialogsActor . send ( new DialogsActor . InMessage ( peer , message , inPendingIndex . getCount ( ) ) ) ; 
 } 
 @ @ - 421 , 7 + 452 , 9 @ @ public class ConversationActor extends ModuleActor { 
 return ; 
 } 
 inReadState = date ; 
 + inReadStateNew = Math . max ( date , inReadStateNew ) ; 
 preferences ( ) . putLong ( IN _ READ _ STATE _ PREF , date ) ; 
 + preferences ( ) . putLong ( IN _ READ _ STATE _ NEW _ PREF , inReadStateNew ) ; 
 
 inPendingIndex . removeBeforeValue ( date ) ; 
 
 @ @ - 431 , 6 + 464 , 24 @ @ public class ConversationActor extends ModuleActor { 
 dialogsGroupedActor . send ( new GroupedDialogsActor . CounterChanged ( peer , inPendingIndex . getCount ( ) ) ) ; 
 } 
 
 + private void checkReadState ( boolean updateDialogs ) { 
 + / / Log . d ( " ConversationActor " , " checkReadState " ) ; 
 + if ( inReadStateNew > inReadState ) { 
 + / / Log . d ( " ConversationActor " , " reading " ) ; 
 + inReadState = inReadStateNew ; 
 + preferences ( ) . putLong ( IN _ READ _ STATE _ PREF , inReadState ) ; 
 + boolean wasNotNull = inPendingIndex . getCount ( ) ! = 0 ; 
 + inPendingIndex . clear ( ) ; 
 + readerActor . send ( new OwnReadActor . MessageRead ( peer , inReadState ) ) ; 
 + if ( wasNotNull & & updateDialogs ) { 
 + if ( ! isHiddenPeer ) { 
 + dialogsActor . send ( new DialogsActor . CounterChanged ( peer , 0 ) ) ; 
 + } 
 + dialogsGroupedActor . send ( new GroupedDialogsActor . CounterChanged ( peer , 0 ) ) ; 
 + } 
 + } 
 + } 
 + 
 / / Deletions 
 
 @ Verified 
 @ @ - 460 , 7 + 511 , 10 @ @ public class ConversationActor extends ModuleActor { 
 inPendingIndex . clear ( ) ; 
 outPendingIndex . clear ( ) ; 
 dialogsActor . send ( new DialogsActor . ChatClear ( peer ) ) ; 
 - / / TODO : Implement for grouped 
 + inReadStateNew = 0 ; 
 + inReadState = 0 ; 
 + preferences ( ) . putLong ( IN _ READ _ STATE _ PREF , inReadState ) ; 
 + preferences ( ) . putLong ( IN _ READ _ STATE _ NEW _ PREF , inReadStateNew ) ; 
 } 
 
 @ Verified 
 @ @ - 470 , 7 + 524 , 10 @ @ public class ConversationActor extends ModuleActor { 
 inPendingIndex . clear ( ) ; 
 outPendingIndex . clear ( ) ; 
 dialogsActor . send ( new DialogsActor . ChatDelete ( peer ) ) ; 
 - / / TODO : Implement for grouped 
 + inReadStateNew = 0 ; 
 + inReadState = 0 ; 
 + preferences ( ) . putLong ( IN _ READ _ STATE _ PREF , inReadState ) ; 
 + preferences ( ) . putLong ( IN _ READ _ STATE _ NEW _ PREF , inReadStateNew ) ; 
 } 
 
 / / History 
 diff - - git a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / presence / OwnPresenceActor . java b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / presence / OwnPresenceActor . java 
 index 352a7b4 . . 87bade1 100644 
 - - - a / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / presence / OwnPresenceActor . java 
 + + + b / actor - sdk / sdk - core / core / core - shared / src / main / java / im / actor / core / modules / internal / presence / OwnPresenceActor . java 
 @ @ - 36 , 7 + 36 , 7 @ @ public class OwnPresenceActor extends ModuleActor implements BusSubscriber { 
 public void preStart ( ) { 
 / / isAlwaysOnline = config ( ) . getDeviceCategory ( ) = = DeviceCategory . DESKTOP ; 
 isAlwaysOnline = false ; 
 - 
 + 
 if ( isAlwaysOnline ) { 
 self ( ) . sendOnce ( new PerformOnline ( ) ) ; 
 } else { 
 diff - - git a / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / websocket / WebSocketConnection . java b / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / websocket / WebSocketConnection . java 
 index 70d55c4 . . 37c8a37 100644 
 - - - a / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / websocket / WebSocketConnection . java 
 + + + b / actor - sdk / sdk - core / runtime / runtime - js / src / main / java / im / actor / runtime / js / websocket / WebSocketConnection . java 
 @ @ - 29 , 7 + 29 , 7 @ @ public class WebSocketConnection extends AsyncConnection { 
 
 @ Override 
 public void doConnect ( ) { 
 - Log . d ( TAG , " doConnect " ) ; 
 + / / Log . d ( TAG , " doConnect " ) ; 
 
 isClosed = true ; 
 
 @ @ - 46 , 7 + 46 , 7 @ @ public class WebSocketConnection extends AsyncConnection { 
 
 @ Override 
 public void doSend ( byte [ ] data ) { 
 - Log . d ( TAG , " doSend " ) ; 
 + / / Log . d ( TAG , " doSend " ) ; 
 if ( isClosed ) { 
 return ; 
 } 
 @ @ - 59 , 13 + 59 , 13 @ @ public class WebSocketConnection extends AsyncConnection { 
 
 @ Override 
 public void doClose ( ) { 
 - Log . d ( TAG , " doClose " ) ; 
 + / / Log . d ( TAG , " doClose " ) ; 
 isClosed = true ; 
 close ( ) ; 
 } 
 
 private void onRawMessage ( ArrayBuffer message ) { 
 - Log . d ( TAG , " onRawMessage " ) ; 
 + / / Log . d ( TAG , " onRawMessage " ) ; 
 if ( isClosed ) { 
 return ; 
 } 
 @ @ - 73 , 13 + 73 , 13 @ @ public class WebSocketConnection extends AsyncConnection { 
 } 
 
 private void onRawConnected ( ) { 
 - Log . d ( TAG , " onRawConnected " ) ; 
 + / / Log . d ( TAG , " onRawConnected " ) ; 
 isClosed = false ; 
 onConnected ( ) ; 
 } 
 
 private void onRawClosed ( ) { 
 - Log . d ( TAG , " onRawClosed " ) ; 
 + / / Log . d ( TAG , " onRawClosed " ) ; 
 isClosed = true ; 
 onClosed ( ) ; 
 } 
 diff - - git a / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / storage / IndexEngine . java b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / storage / IndexEngine . java 
 new file mode 100644 
 index 0000000 . . 33f7c0e 
 - - - / dev / null 
 + + + b / actor - sdk / sdk - core / runtime / runtime - shared / src / main / java / im / actor / runtime / storage / IndexEngine . java 
 @ @ - 0 , 0 + 1 , 62 @ @ 
 + package im . actor . runtime . storage ; 
 + 
 + import java . util . List ; 
 + 
 + public class IndexEngine implements IndexStorage { 
 + 
 + private IndexStorage storage ; 
 + 
 + public IndexEngine ( IndexStorage storage ) { 
 + this . storage = storage ; 
 + } 
 + 
 + @ Override 
 + public void put ( long key , long value ) { 
 + storage . put ( key , value ) ; 
 + } 
 + 
 + @ Override 
 + public Long get ( long key ) { 
 + return storage . get ( key ) ; 
 + } 
 + 
 + @ Override 
 + public List < Long > findBeforeValue ( long value ) { 
 + return storage . findBeforeValue ( value ) ; 
 + } 
 + 
 + @ Override 
 + public List < Long > removeBeforeValue ( long value ) { 
 + return storage . removeBeforeValue ( value ) ; 
 + } 
 + 
 + @ Override 
 + public Long loadTop ( ) { 
 + return storage . loadTop ( ) ; 
 + } 
 + 
 + @ Override 
 + public Long loadBottom ( ) { 
 + return storage . loadBottom ( ) ; 
 + } 
 + 
 + @ Override 
 + public void remove ( long key ) { 
 + storage . remove ( key ) ; 
 + } 
 + 
 + @ Override 
 + public void remove ( List < Long > keys ) { 
 + storage . remove ( keys ) ; 
 + } 
 + 
 + @ Override 
 + public int getCount ( ) { 
 + return storage . getCount ( ) ; 
 + } 
 + 
 + @ Override 
 + public void clear ( ) { 
 + storage . clear ( ) ; 
 + } 
 + }
