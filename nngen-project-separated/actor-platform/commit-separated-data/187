BLEU SCORE: 0.3448444257953326

TEST MSG: fix ( android ) : PictureActivity savePhoto check storage permission before saving
GENERATED MSG: fix ( android ) : check camera permission

TEST DIFF (one line): diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / preview / PictureActivity . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / preview / PictureActivity . java < nl > index f2297b5 . . b94cd6a 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / preview / PictureActivity . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / preview / PictureActivity . java < nl > @ @ - 1 , 15 + 1 , 20 @ @ < nl > package im . actor . sdk . controllers . fragment . preview ; < nl > < nl > + import android . Manifest ; < nl > import android . animation . Animator ; < nl > import android . animation . AnimatorListenerAdapter ; < nl > import android . app . Activity ; < nl > import android . content . Intent ; < nl > + import android . content . pm . PackageManager ; < nl > import android . graphics . Bitmap ; < nl > import android . media . MediaScannerConnection ; < nl > import android . os . Build ; < nl > import android . os . Bundle ; < nl > import android . os . Environment ; < nl > + import android . support . annotation . NonNull ; < nl > + import android . support . v13 . app . ActivityCompat ; < nl > import android . support . v4 . app . Fragment ; < nl > + import android . support . v4 . content . ContextCompat ; < nl > import android . support . v7 . app . ActionBar ; < nl > import android . support . v7 . widget . Toolbar ; < nl > import android . view . LayoutInflater ; < nl > @ @ - 30 , 6 + 35 , 7 @ @ import java . io . IOException ; < nl > < nl > import im . actor . core . entity . FileReference ; < nl > import im . actor . core . viewmodel . UserVM ; < nl > + import im . actor . runtime . Log ; < nl > import im . actor . sdk . ActorSDK ; < nl > import im . actor . sdk . R ; < nl > import im . actor . sdk . controllers . Intents ; < nl > @ @ - 48 , 6 + 54 , 7 @ @ import static im . actor . sdk . util . ActorSDKMessenger . users ; < nl > < nl > public class PictureActivity extends BaseActivity { < nl > < nl > + private static final int PERMISSION _ REQ _ MEDIA = 0 ; < nl > < nl > private static final String ARG _ FILE _ SIZE = " ARG _ FILE _ SIZE " ; < nl > private static final String ARG _ FILE _ ACCESS _ HASH = " ARG _ FILE _ ACCESS " ; < nl > @ @ - 248 , 6 + 255 , 7 @ @ public class PictureActivity extends BaseActivity { < nl > private String fileName ; < nl > private CircularView circularView ; < nl > private View backgroundView ; < nl > + private MenuItem saveMenuItem ; < nl > < nl > public PictureFragment ( ) { < nl > } < nl > @ @ - 461 , 6 + 469 , 7 @ @ public class PictureActivity extends BaseActivity { < nl > @ Override < nl > public void onCreateOptionsMenu ( Menu menu , MenuInflater inflater ) { < nl > inflater . inflate ( R . menu . media _ picture , menu ) ; < nl > + saveMenuItem = menu . findItem ( R . id . save ) ; < nl > } < nl > < nl > @ Override < nl > @ @ - 472 , 30 + 481 , 50 @ @ public class PictureActivity extends BaseActivity { < nl > . putExtra ( Intent . EXTRA _ STREAM , Uri . parse ( path ) ) ) ; * / < nl > return true ; < nl > } else if ( item . getItemId ( ) = = R . id . save ) { < nl > - File externalFile = Environment . getExternalStorageDirectory ( ) ; < nl > - if ( externalFile = = null ) { < nl > - Toast . makeText ( getActivity ( ) , R . string . toast _ no _ sdcard , Toast . LENGTH _ LONG ) . show ( ) ; < nl > - } else { < nl > - boolean isGif = path . endsWith ( " . gif " ) ; < nl > - String externalPath = externalFile . getAbsolutePath ( ) ; < nl > - String exportPathBase = externalPath + " / " + ActorSDK . sharedActor ( ) . getAppName ( ) + " / " + ActorSDK . sharedActor ( ) . getAppName ( ) + " images " + " / " ; < nl > - new File ( exportPathBase ) . mkdirs ( ) ; < nl > - try { < nl > - String exportPath = exportPathBase + ( fileName ! = null ? fileName : " exported " ) + " _ " + Randoms . randomId ( ) + ( isGif ? " . gif " : " . jpg " ) ; < nl > - Files . copy ( new File ( this . path ) , new File ( exportPath ) ) ; < nl > - MediaScannerConnection . scanFile ( getActivity ( ) , new String [ ] { exportPath } , new String [ ] { " image / " + ( isGif ? " gif " : " jpeg " ) } , null ) ; < nl > - Toast . makeText ( getActivity ( ) , getString ( R . string . file _ saved ) + " " + exportPath , Toast . LENGTH _ LONG ) . show ( ) ; < nl > - item . setEnabled ( false ) ; < nl > - item . setTitle ( R . string . menu _ saved ) ; < nl > - } catch ( IOException e ) { < nl > - e . printStackTrace ( ) ; < nl > - } < nl > + savePicture ( ) ; < nl > + return true ; < nl > + } < nl > + return super . onOptionsItemSelected ( item ) ; < nl > + } < nl > + < nl > + private void savePicture ( ) { < nl > + if ( Build . VERSION . SDK _ INT > = Build . VERSION _ CODES . M ) { < nl > + if ( ContextCompat . checkSelfPermission ( getActivity ( ) , Manifest . permission . WRITE _ EXTERNAL _ STORAGE ) ! = PackageManager . PERMISSION _ GRANTED ) { < nl > + ActivityCompat . requestPermissions ( getActivity ( ) , new String [ ] { Manifest . permission . WRITE _ EXTERNAL _ STORAGE } , PERMISSION _ REQ _ MEDIA ) ; < nl > + Log . d ( " Permissions " , " savePhoto - no permission : c " ) ; < nl > + return ; < nl > } < nl > + } < nl > < nl > + File externalFile = Environment . getExternalStorageDirectory ( ) ; < nl > + if ( externalFile = = null ) { < nl > + Toast . makeText ( getActivity ( ) , R . string . toast _ no _ sdcard , Toast . LENGTH _ LONG ) . show ( ) ; < nl > + } else { < nl > + boolean isGif = path . endsWith ( " . gif " ) ; < nl > + String externalPath = externalFile . getAbsolutePath ( ) ; < nl > + String exportPathBase = externalPath + " / " + ActorSDK . sharedActor ( ) . getAppName ( ) + " / " + ActorSDK . sharedActor ( ) . getAppName ( ) + " images " + " / " ; < nl > + new File ( exportPathBase ) . mkdirs ( ) ; < nl > + try { < nl > + String exportPath = exportPathBase + ( fileName ! = null ? fileName : " exported " ) + " _ " + Randoms . randomId ( ) + ( isGif ? " . gif " : " . jpg " ) ; < nl > + Files . copy ( new File ( this . path ) , new File ( exportPath ) ) ; < nl > + MediaScannerConnection . scanFile ( getActivity ( ) , new String [ ] { exportPath } , new String [ ] { " image / " + ( isGif ? " gif " : " jpeg " ) } , null ) ; < nl > + Toast . makeText ( getActivity ( ) , getString ( R . string . file _ saved ) + " " + exportPath , Toast . LENGTH _ LONG ) . show ( ) ; < nl > + saveMenuItem . setEnabled ( false ) ; < nl > + saveMenuItem . setTitle ( R . string . menu _ saved ) ; < nl > + } catch ( IOException e ) { < nl > + e . printStackTrace ( ) ; < nl > + } < nl > + } < nl > + } < nl > < nl > - return true ; < nl > + @ Override < nl > + public void onRequestPermissionsResult ( int requestCode , @ NonNull String [ ] permissions , @ NonNull int [ ] grantResults ) { < nl > + if ( requestCode = = PERMISSION _ REQ _ MEDIA ) { < nl > + if ( grantResults . length > 0 < nl > + & & grantResults [ 0 ] = = PackageManager . PERMISSION _ GRANTED ) { < nl > + savePicture ( ) ; < nl > + } < nl > } < nl > - return super . onOptionsItemSelected ( item ) ; < nl > } < nl > < nl > private void showSystemUi ( ) {
NEAREST DIFF (one line): diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java < nl > index 5c2d9e8 . . 24a0792 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java < nl > @ @ - 1 , 5 + 1 , 6 @ @ < nl > package im . actor . sdk . controllers . conversation ; < nl > < nl > + import android . Manifest ; < nl > import android . animation . ObjectAnimator ; < nl > import android . app . ActivityOptions ; < nl > import android . app . AlertDialog ; < nl > @ @ - 15 , 7 + 16 , 9 @ @ import android . net . Uri ; < nl > import android . os . Bundle ; < nl > import android . provider . ContactsContract ; < nl > import android . provider . MediaStore ; < nl > + import android . support . v4 . app . ActivityCompat ; < nl > import android . support . v4 . app . Fragment ; < nl > + import android . support . v4 . content . ContextCompat ; < nl > import android . support . v7 . app . ActionBar ; < nl > import android . support . v7 . view . ActionMode ; < nl > import android . text . Editable ; < nl > @ @ - 102 , 6 + 105 , 7 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > private static final int REQUEST _ DOC = 3 ; < nl > private static final int REQUEST _ LOCATION = 4 ; < nl > private static final int REQUEST _ CONTACT = 5 ; < nl > + private static final int PERMISSIONS _ REQUEST _ CAMERA = 6 ; < nl > / / Peer of current chat < nl > private Peer peer ; < nl > < nl > @ @ - 329 , 10 + 333 , 15 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > new File ( externalPath + " / actor / " ) . mkdirs ( ) ; < nl > < nl > pending _ fileName = externalPath + " / actor / capture _ " + Randoms . randomId ( ) + " . jpg " ; < nl > - startActivityForResult ( < nl > - new Intent ( MediaStore . ACTION _ IMAGE _ CAPTURE ) < nl > - . putExtra ( MediaStore . EXTRA _ OUTPUT , Uri . fromFile ( new File ( pending _ fileName ) ) ) , < nl > - REQUEST _ PHOTO ) ; < nl > + if ( ContextCompat . checkSelfPermission ( ChatActivity . this , Manifest . permission . CAMERA ) ! = PackageManager . PERMISSION _ GRANTED ) { < nl > + Log . d ( " Permissions " , " camera - no permission : c " ) ; < nl > + ActivityCompat . requestPermissions ( ChatActivity . this , < nl > + new String [ ] { Manifest . permission . CAMERA } , < nl > + PERMISSIONS _ REQUEST _ CAMERA ) ; < nl > + < nl > + } else { < nl > + startCamera ( ) ; < nl > + } < nl > } else if ( item . getId ( ) = = R . id . share _ video ) { < nl > < nl > File externalFile = getExternalFilesDir ( null ) ; < nl > @ @ - 375 , 6 + 384 , 13 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > < nl > } < nl > < nl > + private void startCamera ( ) { < nl > + startActivityForResult ( < nl > + new Intent ( MediaStore . ACTION _ IMAGE _ CAPTURE ) < nl > + . putExtra ( MediaStore . EXTRA _ OUTPUT , Uri . fromFile ( new File ( pending _ fileName ) ) ) , < nl > + REQUEST _ PHOTO ) ; < nl > + } < nl > + < nl > private void handleIntent ( ) { < nl > / / Sharing < nl > sendUri = intent . getStringExtra ( " send _ uri " ) ; < nl > @ @ - 1208 , 4 + 1224 , 14 @ @ public class ChatActivity extends ActorEditTextActivity { < nl > public Peer getPeer ( ) { < nl > return peer ; < nl > } < nl > + < nl > + @ Override < nl > + public void onRequestPermissionsResult ( int requestCode , String [ ] permissions , int [ ] grantResults ) { < nl > + if ( requestCode = = PERMISSIONS _ REQUEST _ CAMERA ) { < nl > + if ( grantResults . length > 0 < nl > + & & grantResults [ 0 ] = = PackageManager . PERMISSION _ GRANTED ) { < nl > + startCamera ( ) ; < nl > + } < nl > + } < nl > + } < nl > } < nl > diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / preview / ViewAvatarActivity . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / preview / ViewAvatarActivity . java < nl > index 48354df . . 5bfac3b 100644 < nl > - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / preview / ViewAvatarActivity . java < nl > + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / preview / ViewAvatarActivity . java < nl > @ @ - 1 , 14 + 1 , 20 @ @ < nl > package im . actor . sdk . controllers . fragment . preview ; < nl > < nl > + import android . Manifest ; < nl > import android . app . Activity ; < nl > import android . content . Context ; < nl > import android . content . DialogInterface ; < nl > import android . content . Intent ; < nl > + import android . content . pm . PackageManager ; < nl > import android . graphics . Bitmap ; < nl > import android . net . Uri ; < nl > + import android . os . Build ; < nl > import android . os . Bundle ; < nl > import android . os . PersistableBundle ; < nl > import android . provider . MediaStore ; < nl > + import android . provider . Settings ; < nl > + import android . support . v4 . app . ActivityCompat ; < nl > + import android . support . v4 . content . ContextCompat ; < nl > import android . support . v7 . app . AlertDialog ; < nl > import android . view . Menu ; < nl > import android . view . MenuItem ; < nl > @ @ - 26 , 6 + 32 , 7 @ @ import im . actor . core . entity . PeerType ; < nl > import im . actor . core . viewmodel . AvatarUploadState ; < nl > import im . actor . core . viewmodel . FileVM ; < nl > import im . actor . core . viewmodel . FileVMCallback ; < nl > + import im . actor . runtime . Log ; < nl > import im . actor . sdk . ActorSDK ; < nl > import im . actor . sdk . R ; < nl > import im . actor . sdk . controllers . Intents ; < nl > @ @ - 50 , 6 + 57 , 7 @ @ public class ViewAvatarActivity extends BaseActivity { < nl > < nl > private static final int REQUEST _ GALLERY = 1 ; < nl > private static final int REQUEST _ PHOTO = 2 ; < nl > + private static final int PERMISSIONS _ REQUEST _ CAMERA = 3 ; < nl > private String externalFile ; < nl > private String avatarPath ; < nl > private Peer peer ; < nl > @ @ - 278 , 11 + 286 , 15 @ @ public class ViewAvatarActivity extends BaseActivity { < nl > Toast . makeText ( ViewAvatarActivity . this , R . string . toast _ no _ sdcard , Toast . LENGTH _ LONG ) . show ( ) ; < nl > return ; < nl > } < nl > - < nl > - startActivityForResult ( < nl > - new Intent ( MediaStore . ACTION _ IMAGE _ CAPTURE ) < nl > - . putExtra ( MediaStore . EXTRA _ OUTPUT , Uri . fromFile ( new File ( externalFile ) ) ) , < nl > - REQUEST _ PHOTO ) ; < nl > + if ( ContextCompat . checkSelfPermission ( ViewAvatarActivity . this , Manifest . permission . CAMERA ) ! = PackageManager . PERMISSION _ GRANTED ) { < nl > + Log . d ( " Permissions " , " camera - no permission : c " ) ; < nl > + ActivityCompat . requestPermissions ( ViewAvatarActivity . this , < nl > + new String [ ] { Manifest . permission . CAMERA } , < nl > + PERMISSIONS _ REQUEST _ CAMERA ) ; < nl > + < nl > + } else { < nl > + startCamera ( ) ; < nl > + } < nl > } else if ( which = = 1 ) { < nl > Intent i = new Intent ( Intent . ACTION _ PICK , MediaStore . Images . Media . EXTERNAL _ CONTENT _ URI ) ; < nl > i . setType ( " image / * " ) ; < nl > @ @ - 308 , 6 + 320 , 13 @ @ public class ViewAvatarActivity extends BaseActivity { < nl > return super . onOptionsItemSelected ( item ) ; < nl > } < nl > < nl > + private void startCamera ( ) { < nl > + startActivityForResult ( < nl > + new Intent ( MediaStore . ACTION _ IMAGE _ CAPTURE ) < nl > + . putExtra ( MediaStore . EXTRA _ OUTPUT , Uri . fromFile ( new File ( externalFile ) ) ) , < nl > + REQUEST _ PHOTO ) ; < nl > + } < nl > + < nl > @ Override < nl > protected void onActivityResult ( int requestCode , int resultCode , Intent data ) { < nl > if ( requestCode = = REQUEST _ GALLERY & & resultCode = = Activity . RESULT _ OK ) { < nl > @ @ - 354 , 4 + 373 , 14 @ @ public class ViewAvatarActivity extends BaseActivity { < nl > super . onPause ( ) ; < nl > unbind ( ) ; < nl > } < nl > + < nl > + @ Override < nl > + public void onRequestPermissionsResult ( int requestCode , String [ ] permissions , int [ ] grantResults ) { < nl > + if ( requestCode = = PERMISSIONS _ REQUEST _ CAMERA ) { < nl > + if ( grantResults . length > 0 < nl > + & & grantResults [ 0 ] = = PackageManager . PERMISSION _ GRANTED ) { < nl > + startCamera ( ) ; < nl > + } < nl > + } < nl > + } < nl > }

TEST DIFF:
diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / preview / PictureActivity . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / preview / PictureActivity . java 
 index f2297b5 . . b94cd6a 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / preview / PictureActivity . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / preview / PictureActivity . java 
 @ @ - 1 , 15 + 1 , 20 @ @ 
 package im . actor . sdk . controllers . fragment . preview ; 
 
 + import android . Manifest ; 
 import android . animation . Animator ; 
 import android . animation . AnimatorListenerAdapter ; 
 import android . app . Activity ; 
 import android . content . Intent ; 
 + import android . content . pm . PackageManager ; 
 import android . graphics . Bitmap ; 
 import android . media . MediaScannerConnection ; 
 import android . os . Build ; 
 import android . os . Bundle ; 
 import android . os . Environment ; 
 + import android . support . annotation . NonNull ; 
 + import android . support . v13 . app . ActivityCompat ; 
 import android . support . v4 . app . Fragment ; 
 + import android . support . v4 . content . ContextCompat ; 
 import android . support . v7 . app . ActionBar ; 
 import android . support . v7 . widget . Toolbar ; 
 import android . view . LayoutInflater ; 
 @ @ - 30 , 6 + 35 , 7 @ @ import java . io . IOException ; 
 
 import im . actor . core . entity . FileReference ; 
 import im . actor . core . viewmodel . UserVM ; 
 + import im . actor . runtime . Log ; 
 import im . actor . sdk . ActorSDK ; 
 import im . actor . sdk . R ; 
 import im . actor . sdk . controllers . Intents ; 
 @ @ - 48 , 6 + 54 , 7 @ @ import static im . actor . sdk . util . ActorSDKMessenger . users ; 
 
 public class PictureActivity extends BaseActivity { 
 
 + private static final int PERMISSION _ REQ _ MEDIA = 0 ; 
 
 private static final String ARG _ FILE _ SIZE = " ARG _ FILE _ SIZE " ; 
 private static final String ARG _ FILE _ ACCESS _ HASH = " ARG _ FILE _ ACCESS " ; 
 @ @ - 248 , 6 + 255 , 7 @ @ public class PictureActivity extends BaseActivity { 
 private String fileName ; 
 private CircularView circularView ; 
 private View backgroundView ; 
 + private MenuItem saveMenuItem ; 
 
 public PictureFragment ( ) { 
 } 
 @ @ - 461 , 6 + 469 , 7 @ @ public class PictureActivity extends BaseActivity { 
 @ Override 
 public void onCreateOptionsMenu ( Menu menu , MenuInflater inflater ) { 
 inflater . inflate ( R . menu . media _ picture , menu ) ; 
 + saveMenuItem = menu . findItem ( R . id . save ) ; 
 } 
 
 @ Override 
 @ @ - 472 , 30 + 481 , 50 @ @ public class PictureActivity extends BaseActivity { 
 . putExtra ( Intent . EXTRA _ STREAM , Uri . parse ( path ) ) ) ; * / 
 return true ; 
 } else if ( item . getItemId ( ) = = R . id . save ) { 
 - File externalFile = Environment . getExternalStorageDirectory ( ) ; 
 - if ( externalFile = = null ) { 
 - Toast . makeText ( getActivity ( ) , R . string . toast _ no _ sdcard , Toast . LENGTH _ LONG ) . show ( ) ; 
 - } else { 
 - boolean isGif = path . endsWith ( " . gif " ) ; 
 - String externalPath = externalFile . getAbsolutePath ( ) ; 
 - String exportPathBase = externalPath + " / " + ActorSDK . sharedActor ( ) . getAppName ( ) + " / " + ActorSDK . sharedActor ( ) . getAppName ( ) + " images " + " / " ; 
 - new File ( exportPathBase ) . mkdirs ( ) ; 
 - try { 
 - String exportPath = exportPathBase + ( fileName ! = null ? fileName : " exported " ) + " _ " + Randoms . randomId ( ) + ( isGif ? " . gif " : " . jpg " ) ; 
 - Files . copy ( new File ( this . path ) , new File ( exportPath ) ) ; 
 - MediaScannerConnection . scanFile ( getActivity ( ) , new String [ ] { exportPath } , new String [ ] { " image / " + ( isGif ? " gif " : " jpeg " ) } , null ) ; 
 - Toast . makeText ( getActivity ( ) , getString ( R . string . file _ saved ) + " " + exportPath , Toast . LENGTH _ LONG ) . show ( ) ; 
 - item . setEnabled ( false ) ; 
 - item . setTitle ( R . string . menu _ saved ) ; 
 - } catch ( IOException e ) { 
 - e . printStackTrace ( ) ; 
 - } 
 + savePicture ( ) ; 
 + return true ; 
 + } 
 + return super . onOptionsItemSelected ( item ) ; 
 + } 
 + 
 + private void savePicture ( ) { 
 + if ( Build . VERSION . SDK _ INT > = Build . VERSION _ CODES . M ) { 
 + if ( ContextCompat . checkSelfPermission ( getActivity ( ) , Manifest . permission . WRITE _ EXTERNAL _ STORAGE ) ! = PackageManager . PERMISSION _ GRANTED ) { 
 + ActivityCompat . requestPermissions ( getActivity ( ) , new String [ ] { Manifest . permission . WRITE _ EXTERNAL _ STORAGE } , PERMISSION _ REQ _ MEDIA ) ; 
 + Log . d ( " Permissions " , " savePhoto - no permission : c " ) ; 
 + return ; 
 } 
 + } 
 
 + File externalFile = Environment . getExternalStorageDirectory ( ) ; 
 + if ( externalFile = = null ) { 
 + Toast . makeText ( getActivity ( ) , R . string . toast _ no _ sdcard , Toast . LENGTH _ LONG ) . show ( ) ; 
 + } else { 
 + boolean isGif = path . endsWith ( " . gif " ) ; 
 + String externalPath = externalFile . getAbsolutePath ( ) ; 
 + String exportPathBase = externalPath + " / " + ActorSDK . sharedActor ( ) . getAppName ( ) + " / " + ActorSDK . sharedActor ( ) . getAppName ( ) + " images " + " / " ; 
 + new File ( exportPathBase ) . mkdirs ( ) ; 
 + try { 
 + String exportPath = exportPathBase + ( fileName ! = null ? fileName : " exported " ) + " _ " + Randoms . randomId ( ) + ( isGif ? " . gif " : " . jpg " ) ; 
 + Files . copy ( new File ( this . path ) , new File ( exportPath ) ) ; 
 + MediaScannerConnection . scanFile ( getActivity ( ) , new String [ ] { exportPath } , new String [ ] { " image / " + ( isGif ? " gif " : " jpeg " ) } , null ) ; 
 + Toast . makeText ( getActivity ( ) , getString ( R . string . file _ saved ) + " " + exportPath , Toast . LENGTH _ LONG ) . show ( ) ; 
 + saveMenuItem . setEnabled ( false ) ; 
 + saveMenuItem . setTitle ( R . string . menu _ saved ) ; 
 + } catch ( IOException e ) { 
 + e . printStackTrace ( ) ; 
 + } 
 + } 
 + } 
 
 - return true ; 
 + @ Override 
 + public void onRequestPermissionsResult ( int requestCode , @ NonNull String [ ] permissions , @ NonNull int [ ] grantResults ) { 
 + if ( requestCode = = PERMISSION _ REQ _ MEDIA ) { 
 + if ( grantResults . length > 0 
 + & & grantResults [ 0 ] = = PackageManager . PERMISSION _ GRANTED ) { 
 + savePicture ( ) ; 
 + } 
 } 
 - return super . onOptionsItemSelected ( item ) ; 
 } 
 
 private void showSystemUi ( ) {

NEAREST DIFF:
diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java 
 index 5c2d9e8 . . 24a0792 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / conversation / ChatActivity . java 
 @ @ - 1 , 5 + 1 , 6 @ @ 
 package im . actor . sdk . controllers . conversation ; 
 
 + import android . Manifest ; 
 import android . animation . ObjectAnimator ; 
 import android . app . ActivityOptions ; 
 import android . app . AlertDialog ; 
 @ @ - 15 , 7 + 16 , 9 @ @ import android . net . Uri ; 
 import android . os . Bundle ; 
 import android . provider . ContactsContract ; 
 import android . provider . MediaStore ; 
 + import android . support . v4 . app . ActivityCompat ; 
 import android . support . v4 . app . Fragment ; 
 + import android . support . v4 . content . ContextCompat ; 
 import android . support . v7 . app . ActionBar ; 
 import android . support . v7 . view . ActionMode ; 
 import android . text . Editable ; 
 @ @ - 102 , 6 + 105 , 7 @ @ public class ChatActivity extends ActorEditTextActivity { 
 private static final int REQUEST _ DOC = 3 ; 
 private static final int REQUEST _ LOCATION = 4 ; 
 private static final int REQUEST _ CONTACT = 5 ; 
 + private static final int PERMISSIONS _ REQUEST _ CAMERA = 6 ; 
 / / Peer of current chat 
 private Peer peer ; 
 
 @ @ - 329 , 10 + 333 , 15 @ @ public class ChatActivity extends ActorEditTextActivity { 
 new File ( externalPath + " / actor / " ) . mkdirs ( ) ; 
 
 pending _ fileName = externalPath + " / actor / capture _ " + Randoms . randomId ( ) + " . jpg " ; 
 - startActivityForResult ( 
 - new Intent ( MediaStore . ACTION _ IMAGE _ CAPTURE ) 
 - . putExtra ( MediaStore . EXTRA _ OUTPUT , Uri . fromFile ( new File ( pending _ fileName ) ) ) , 
 - REQUEST _ PHOTO ) ; 
 + if ( ContextCompat . checkSelfPermission ( ChatActivity . this , Manifest . permission . CAMERA ) ! = PackageManager . PERMISSION _ GRANTED ) { 
 + Log . d ( " Permissions " , " camera - no permission : c " ) ; 
 + ActivityCompat . requestPermissions ( ChatActivity . this , 
 + new String [ ] { Manifest . permission . CAMERA } , 
 + PERMISSIONS _ REQUEST _ CAMERA ) ; 
 + 
 + } else { 
 + startCamera ( ) ; 
 + } 
 } else if ( item . getId ( ) = = R . id . share _ video ) { 
 
 File externalFile = getExternalFilesDir ( null ) ; 
 @ @ - 375 , 6 + 384 , 13 @ @ public class ChatActivity extends ActorEditTextActivity { 
 
 } 
 
 + private void startCamera ( ) { 
 + startActivityForResult ( 
 + new Intent ( MediaStore . ACTION _ IMAGE _ CAPTURE ) 
 + . putExtra ( MediaStore . EXTRA _ OUTPUT , Uri . fromFile ( new File ( pending _ fileName ) ) ) , 
 + REQUEST _ PHOTO ) ; 
 + } 
 + 
 private void handleIntent ( ) { 
 / / Sharing 
 sendUri = intent . getStringExtra ( " send _ uri " ) ; 
 @ @ - 1208 , 4 + 1224 , 14 @ @ public class ChatActivity extends ActorEditTextActivity { 
 public Peer getPeer ( ) { 
 return peer ; 
 } 
 + 
 + @ Override 
 + public void onRequestPermissionsResult ( int requestCode , String [ ] permissions , int [ ] grantResults ) { 
 + if ( requestCode = = PERMISSIONS _ REQUEST _ CAMERA ) { 
 + if ( grantResults . length > 0 
 + & & grantResults [ 0 ] = = PackageManager . PERMISSION _ GRANTED ) { 
 + startCamera ( ) ; 
 + } 
 + } 
 + } 
 } 
 diff - - git a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / preview / ViewAvatarActivity . java b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / preview / ViewAvatarActivity . java 
 index 48354df . . 5bfac3b 100644 
 - - - a / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / preview / ViewAvatarActivity . java 
 + + + b / actor - sdk / sdk - core - android / android - sdk / src / main / java / im / actor / sdk / controllers / fragment / preview / ViewAvatarActivity . java 
 @ @ - 1 , 14 + 1 , 20 @ @ 
 package im . actor . sdk . controllers . fragment . preview ; 
 
 + import android . Manifest ; 
 import android . app . Activity ; 
 import android . content . Context ; 
 import android . content . DialogInterface ; 
 import android . content . Intent ; 
 + import android . content . pm . PackageManager ; 
 import android . graphics . Bitmap ; 
 import android . net . Uri ; 
 + import android . os . Build ; 
 import android . os . Bundle ; 
 import android . os . PersistableBundle ; 
 import android . provider . MediaStore ; 
 + import android . provider . Settings ; 
 + import android . support . v4 . app . ActivityCompat ; 
 + import android . support . v4 . content . ContextCompat ; 
 import android . support . v7 . app . AlertDialog ; 
 import android . view . Menu ; 
 import android . view . MenuItem ; 
 @ @ - 26 , 6 + 32 , 7 @ @ import im . actor . core . entity . PeerType ; 
 import im . actor . core . viewmodel . AvatarUploadState ; 
 import im . actor . core . viewmodel . FileVM ; 
 import im . actor . core . viewmodel . FileVMCallback ; 
 + import im . actor . runtime . Log ; 
 import im . actor . sdk . ActorSDK ; 
 import im . actor . sdk . R ; 
 import im . actor . sdk . controllers . Intents ; 
 @ @ - 50 , 6 + 57 , 7 @ @ public class ViewAvatarActivity extends BaseActivity { 
 
 private static final int REQUEST _ GALLERY = 1 ; 
 private static final int REQUEST _ PHOTO = 2 ; 
 + private static final int PERMISSIONS _ REQUEST _ CAMERA = 3 ; 
 private String externalFile ; 
 private String avatarPath ; 
 private Peer peer ; 
 @ @ - 278 , 11 + 286 , 15 @ @ public class ViewAvatarActivity extends BaseActivity { 
 Toast . makeText ( ViewAvatarActivity . this , R . string . toast _ no _ sdcard , Toast . LENGTH _ LONG ) . show ( ) ; 
 return ; 
 } 
 - 
 - startActivityForResult ( 
 - new Intent ( MediaStore . ACTION _ IMAGE _ CAPTURE ) 
 - . putExtra ( MediaStore . EXTRA _ OUTPUT , Uri . fromFile ( new File ( externalFile ) ) ) , 
 - REQUEST _ PHOTO ) ; 
 + if ( ContextCompat . checkSelfPermission ( ViewAvatarActivity . this , Manifest . permission . CAMERA ) ! = PackageManager . PERMISSION _ GRANTED ) { 
 + Log . d ( " Permissions " , " camera - no permission : c " ) ; 
 + ActivityCompat . requestPermissions ( ViewAvatarActivity . this , 
 + new String [ ] { Manifest . permission . CAMERA } , 
 + PERMISSIONS _ REQUEST _ CAMERA ) ; 
 + 
 + } else { 
 + startCamera ( ) ; 
 + } 
 } else if ( which = = 1 ) { 
 Intent i = new Intent ( Intent . ACTION _ PICK , MediaStore . Images . Media . EXTERNAL _ CONTENT _ URI ) ; 
 i . setType ( " image / * " ) ; 
 @ @ - 308 , 6 + 320 , 13 @ @ public class ViewAvatarActivity extends BaseActivity { 
 return super . onOptionsItemSelected ( item ) ; 
 } 
 
 + private void startCamera ( ) { 
 + startActivityForResult ( 
 + new Intent ( MediaStore . ACTION _ IMAGE _ CAPTURE ) 
 + . putExtra ( MediaStore . EXTRA _ OUTPUT , Uri . fromFile ( new File ( externalFile ) ) ) , 
 + REQUEST _ PHOTO ) ; 
 + } 
 + 
 @ Override 
 protected void onActivityResult ( int requestCode , int resultCode , Intent data ) { 
 if ( requestCode = = REQUEST _ GALLERY & & resultCode = = Activity . RESULT _ OK ) { 
 @ @ - 354 , 4 + 373 , 14 @ @ public class ViewAvatarActivity extends BaseActivity { 
 super . onPause ( ) ; 
 unbind ( ) ; 
 } 
 + 
 + @ Override 
 + public void onRequestPermissionsResult ( int requestCode , String [ ] permissions , int [ ] grantResults ) { 
 + if ( requestCode = = PERMISSIONS _ REQUEST _ CAMERA ) { 
 + if ( grantResults . length > 0 
 + & & grantResults [ 0 ] = = PackageManager . PERMISSION _ GRANTED ) { 
 + startCamera ( ) ; 
 + } 
 + } 
 + } 
 }
