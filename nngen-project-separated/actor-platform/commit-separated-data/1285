BLEU SCORE: 0.5169731539571706

TEST MSG: fix ( server ) : increased migration timeout
GENERATED MSG: fix ( server ) : fixed cluster issues

TEST DIFF (one line): diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / migrations / Migration . scala b / actor - server / actor - core / src / main / scala / im / actor / server / migrations / Migration . scala < nl > index acf33b9 . . c6ffc4c 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / migrations / Migration . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / migrations / Migration . scala < nl > @ @ - 5 , 6 + 5 , 7 @ @ import java . time . Instant < nl > import akka . actor . { Actor , ActorLogging , ActorSystem } < nl > import akka . persistence . PersistentActor < nl > import akka . util . Timeout < nl > + import im . actor . config . ActorConfig < nl > import im . actor . server . KeyValueMappings < nl > import shardakka . { InstantCodec , ShardakkaExtension } < nl > import slick . driver . PostgresDriver . api . _ < nl > @ @ - 21 , 7 + 22 , 7 @ @ trait Migration { < nl > protected def startMigration ( ) ( implicit system : ActorSystem , db : Database , ec : ExecutionContext ) : Future [ Unit ] < nl > < nl > def migrate ( ) ( implicit system : ActorSystem , db : Database , ec : ExecutionContext ) : Unit = { < nl > - implicit val kvTimeout = Timeout ( 5 . seconds ) < nl > + implicit val kvTimeout = Timeout ( ActorConfig . defaultTimeout ) < nl > val migrations = ShardakkaExtension ( system ) . simpleKeyValue [ Instant ] ( KeyValueMappings . Migrations , InstantCodec ) < nl > Await . result ( migrations . get ( migrationName ) flatMap { < nl > case Some ( date ) ⇒
NEAREST DIFF (one line): diff - - git a / actor - server / actor - commons - api / src / main / scala / im / actor / server / api / TypeMappers . scala b / actor - server / actor - commons - api / src / main / scala / im / actor / server / api / TypeMappers . scala < nl > index 25b1496 . . 4f514b0 100644 < nl > - - - a / actor - server / actor - commons - api / src / main / scala / im / actor / server / api / TypeMappers . scala < nl > + + + b / actor - server / actor - commons - api / src / main / scala / im / actor / server / api / TypeMappers . scala < nl > @ @ - 55 , 8 + 55 , 13 @ @ private [ api ] trait MessageMapper { < nl > ByteString . copyFrom ( group . toByteArray ) < nl > } < nl > < nl > - private def applyPeer ( buf : ByteString ) : Peer = < nl > - Peer . parseFrom ( CodedInputStream . newInstance ( buf . asReadOnlyByteBuffer ( ) ) ) . right . get < nl > + private def applyPeer ( bytes : ByteString ) : Peer = { < nl > + if ( bytes . size ( ) > 0 ) { < nl > + Peer . parseFrom ( CodedInputStream . newInstance ( bytes . asReadOnlyByteBuffer ( ) ) ) . right . get < nl > + } else { < nl > + null < nl > + } < nl > + } < nl > < nl > private def unapplyPeer ( peer : Peer ) : ByteString = < nl > ByteString . copyFrom ( peer . toByteArray ) < nl > diff - - git a / actor - server / actor - commons - base / src / main / scala / im / actor / server / commons / ActorConfig . scala b / actor - server / actor - commons - base / src / main / scala / im / actor / server / commons / ActorConfig . scala < nl > index 780e6a7 . . 5ebe48c 100644 < nl > - - - a / actor - server / actor - commons - base / src / main / scala / im / actor / server / commons / ActorConfig . scala < nl > + + + b / actor - server / actor - commons - base / src / main / scala / im / actor / server / commons / ActorConfig . scala < nl > @ @ - 1 , 31 + 1 , 15 @ @ < nl > package im . actor . server . commons < nl > < nl > - import com . typesafe . config . { ConfigFactory , Config } < nl > + import com . typesafe . config . { Config , ConfigFactory } < nl > < nl > object ActorConfig { < nl > def load ( ) : Config = { < nl > ConfigFactory . parseString ( < nl > - s " " " < nl > + " " " < nl > | akka { < nl > | actor { < nl > | provider : " akka . cluster . ClusterActorRefProvider " < nl > | } < nl > - | < nl > - | remote { < nl > - | netty . tcp { < nl > - | hostname : " 127 . 0 . 0 . 1 " < nl > - | port : 2553 < nl > - | } < nl > - | } < nl > - | < nl > - | cluster { < nl > - | seed - nodes : [ " akka . tcp : / / actor - server @ 127 . 0 . 0 . 1 : 2553 " ] < nl > - | } < nl > - | < nl > - | persistence { < nl > - | journal . plugin : " jdbc - journal " < nl > - | snapshot - store . plugin : " jdbc - snapshot - store " < nl > - | } < nl > | } < nl > | < nl > | jdbc - connection { < nl > @ @ - 35 , 6 + 19 , 16 @ @ object ActorConfig { < nl > " " " . stripMargin < nl > ) < nl > . withFallback ( ConfigFactory . load ( ) ) < nl > + . withFallback ( ConfigFactory . parseString ( < nl > + " " " < nl > + | akka { < nl > + | persistence { < nl > + | journal . plugin : " jdbc - journal " < nl > + | snapshot - store . plugin : " jdbc - snapshot - store " < nl > + | } < nl > + | } < nl > + " " " . stripMargin < nl > + ) ) < nl > . resolve ( ) < nl > } < nl > } < nl > diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / dialog / group / GroupDialogExtension . scala b / actor - server / actor - core / src / main / scala / im / actor / server / dialog / group / GroupDialogExtension . scala < nl > index 900f96e . . 9807973 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / dialog / group / GroupDialogExtension . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / dialog / group / GroupDialogExtension . scala < nl > @ @ - 5 , 6 + 5 , 8 @ @ import akka . actor . _ < nl > sealed trait GroupDialogExtension extends Extension < nl > < nl > final class GroupDialogExtensionImpl ( system : ActorSystem ) extends GroupDialogExtension { < nl > + GroupDialog . register ( ) < nl > + < nl > lazy val region : GroupDialogRegion = GroupDialogRegion . start ( ) ( system ) < nl > } < nl > < nl > diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / dialog / privat / PrivateDialogExtension . scala b / actor - server / actor - core / src / main / scala / im / actor / server / dialog / privat / PrivateDialogExtension . scala < nl > index 79bf6f5 . . d5d79d6 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / dialog / privat / PrivateDialogExtension . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / dialog / privat / PrivateDialogExtension . scala < nl > @ @ - 5 , 6 + 5 , 8 @ @ import akka . actor . _ < nl > sealed trait PrivateDialogExtension extends Extension < nl > < nl > final class PrivateDialogExtensionImpl ( system : ActorSystem ) extends PrivateDialogExtension { < nl > + PrivateDialog . register ( ) < nl > + < nl > lazy val region : PrivateDialogRegion = PrivateDialogRegion . start ( ) ( system ) < nl > } < nl > < nl > diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupExtension . scala b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupExtension . scala < nl > index 4b344bc . . 6dd3eb7 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupExtension . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupExtension . scala < nl > @ @ - 5 , 6 + 5 , 8 @ @ import akka . actor . _ < nl > sealed trait GroupExtension extends Extension < nl > < nl > final class GroupExtensionImpl ( system : ActorSystem ) extends GroupExtension { < nl > + GroupProcessor . register ( ) < nl > + < nl > lazy val processorRegion : GroupProcessorRegion = GroupProcessorRegion . start ( ) ( system ) < nl > lazy val viewRegion : GroupViewRegion = GroupViewRegion ( processorRegion . ref ) < nl > } < nl > diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupProcessor . scala b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupProcessor . scala < nl > index ce3eec3 . . 458a489 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupProcessor . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupProcessor . scala < nl > @ @ - 7 , 11 + 7 , 10 @ @ import akka . persistence . { RecoveryCompleted , RecoveryFailure } < nl > import akka . util . Timeout < nl > import im . actor . server . commons . serialization . ActorSerializer < nl > import im . actor . server . db . DbExtension < nl > + import im . actor . server . dialog . group . { GroupDialogExtension , GroupDialogRegion } < nl > import im . actor . server . event . TSEvent < nl > import im . actor . server . file . Avatar < nl > import im . actor . server . office . { PeerProcessor , ProcessorState , StopOffice } < nl > - import im . actor . server . dialog . group . GroupDialogExtension < nl > - import im . actor . server . dialog . group . GroupDialogRegion < nl > import im . actor . server . push . SeqUpdatesExtension < nl > import im . actor . server . user . { UserExtension , UserProcessorRegion , UserViewRegion } < nl > import im . actor . server . util . { FileStorageAdapter , S3StorageExtension } < nl > @ @ - 84 , 6 + 83 , 8 @ @ object GroupProcessor { < nl > ActorSerializer . register ( 21004 , classOf [ GroupQueries . CheckAccessHashResponse ] ) < nl > ActorSerializer . register ( 21005 , classOf [ GroupQueries . GetMembers ] ) < nl > ActorSerializer . register ( 21006 , classOf [ GroupQueries . GetMembersResponse ] ) < nl > + ActorSerializer . register ( 21007 , classOf [ GroupQueries . GetApiStruct ] ) < nl > + ActorSerializer . register ( 21008 , classOf [ GroupQueries . GetApiStructResponse ] ) < nl > < nl > ActorSerializer . register ( 22003 , classOf [ GroupEvents . UserInvited ] ) < nl > ActorSerializer . register ( 22004 , classOf [ GroupEvents . UserJoined ] ) < nl > diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesExtension . scala b / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesExtension . scala < nl > index f58914d . . 1fc3f06 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesExtension . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesExtension . scala < nl > @ @ - 43 , 6 + 43 , 8 @ @ final class SeqUpdatesExtensionImpl ( < nl > private implicit val system : ActorSystem = _ system < nl > private implicit lazy val db : Database = DbExtension ( system ) . db < nl > < nl > + SeqUpdatesManager . register ( ) < nl > + < nl > lazy val region : SeqUpdatesManagerRegion = SeqUpdatesManagerRegion . start ( ) ( system , gpm , apm ) < nl > < nl > def getFatData ( < nl > diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesManager . scala b / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesManager . scala < nl > index b8c35f6 . . 4c42aa0 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesManager . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesManager . scala < nl > @ @ - 2 , 7 + 2 , 7 @ @ package im . actor . server . push < nl > < nl > import java . nio . ByteBuffer < nl > < nl > - import im . actor . server . util . AnyRefLogSource < nl > + import im . actor . server . commons . serialization . ActorSerializer < nl > < nl > import scala . annotation . tailrec < nl > import scala . concurrent . _ < nl > @ @ - 18 , 7 + 18 , 7 @ @ import im . actor . api . rpc . peers . { PeerType , Peer } < nl > import im . actor . api . { rpc ⇒ api } < nl > import im . actor . server . db . DbExtension < nl > import im . actor . server . models . sequence < nl > - import im . actor . server . sequence . SeqState < nl > + import im . actor . server . sequence . { SeqStateDate , SeqState } < nl > import im . actor . server . user . { UserOffice , UserViewRegion } < nl > import im . actor . server . { models , persist ⇒ p } < nl > < nl > @ @ - 34 , 6 + 34 , 11 @ @ object SeqUpdatesManager { < nl > / / TODO : configurable < nl > private implicit val OperationTimeout = Timeout ( 30 . seconds ) < nl > < nl > + def register ( ) : Unit = { < nl > + ActorSerializer . register ( 60001 , classOf [ SeqState ] ) < nl > + ActorSerializer . register ( 60002 , classOf [ SeqStateDate ] ) < nl > + } < nl > + < nl > def getSeqState ( authId : Long ) ( implicit ext : SeqUpdatesExtension , ec : ExecutionContext ) : Future [ SeqState ] = < nl > ext . region . ref . ask ( Envelope ( authId , GetSequenceState ) ) ( OperationTimeout ) . mapTo [ SeqState ] < nl > < nl > diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / user / UserExtension . scala b / actor - server / actor - core / src / main / scala / im / actor / server / user / UserExtension . scala < nl > index 1f6e847 . . b3ed7b2 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / user / UserExtension . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / user / UserExtension . scala < nl > @ @ - 5 , 6 + 5 , 8 @ @ import akka . actor . _ < nl > sealed trait UserExtension extends Extension < nl > < nl > final class UserExtensionImpl ( system : ActorSystem ) extends UserExtension { < nl > + UserProcessor . register ( ) < nl > + < nl > lazy val processorRegion : UserProcessorRegion = UserProcessorRegion . start ( ) ( system ) < nl > lazy val viewRegion : UserViewRegion = UserViewRegion ( processorRegion . ref ) < nl > } < nl > diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / user / UserProcessor . scala b / actor - server / actor - core / src / main / scala / im / actor / server / user / UserProcessor . scala < nl > index d506745 . . ac89e49 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / user / UserProcessor . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / user / UserProcessor . scala < nl > @ @ - 102 , 6 + 102 , 8 @ @ object UserProcessor { < nl > ActorSerializer . register ( 11004 , classOf [ UserQueries . GetContactRecordsResponse ] ) < nl > ActorSerializer . register ( 11005 , classOf [ UserQueries . CheckAccessHash ] ) < nl > ActorSerializer . register ( 11006 , classOf [ UserQueries . CheckAccessHashResponse ] ) < nl > + ActorSerializer . register ( 11007 , classOf [ UserQueries . GetApiStruct ] ) < nl > + ActorSerializer . register ( 11008 , classOf [ UserQueries . GetApiStructResponse ] ) < nl > < nl > ActorSerializer . register ( 12001 , classOf [ UserEvents . AuthAdded ] ) < nl > ActorSerializer . register ( 12002 , classOf [ UserEvents . AuthRemoved ] ) < nl > diff - - git a / actor - server / actor - runner / src / main / scala / im / actor / server / Main . scala b / actor - server / actor - runner / src / main / scala / im / actor / server / Main . scala < nl > index ccdd66e . . 3ae4734 100644 < nl > - - - a / actor - server / actor - runner / src / main / scala / im / actor / server / Main . scala < nl > + + + b / actor - server / actor - runner / src / main / scala / im / actor / server / Main . scala < nl > @ @ - 93 , 12 + 93 , 10 @ @ object Main extends App { < nl > case _ ⇒ throw new Exception ( " " " Invalid activation . default - service value provided : valid options : " internal " , actor - activation " " " ) < nl > } < nl > < nl > - Session . startRegion ( < nl > + implicit val sessionRegion = Session . startRegion ( < nl > Some ( Session . props ( mediator ) ) < nl > ) < nl > < nl > - implicit val sessionRegion = Session . startRegionProxy ( ) < nl > - < nl > RichMessageWorker . startWorker ( richMessageConfig , mediator ) < nl > < nl > implicit val oauth2Service = new GoogleProvider ( oauth2GoogleConfig ) < nl > diff - - git a / actor - server / actor - utils / src / main / scala / im / actor / server / util / S3StorageAdapter . scala b / actor - server / actor - utils / src / main / scala / im / actor / server / util / S3StorageAdapter . scala < nl > index 2e3a937 . . 2dd469e 100644 < nl > - - - a / actor - server / actor - utils / src / main / scala / im / actor / server / util / S3StorageAdapter . scala < nl > + + + b / actor - server / actor - utils / src / main / scala / im / actor / server / util / S3StorageAdapter . scala < nl > @ @ - 2 , 11 + 2 , 6 @ @ package im . actor . server . util < nl > < nl > import java . io . File < nl > < nl > - import scala . concurrent . duration . _ < nl > - import scala . concurrent . forkjoin . ThreadLocalRandom < nl > - import scala . concurrent . { ExecutionContext , Future } < nl > - import scala . util . Try < nl > - < nl > import akka . actor . _ < nl > import com . amazonaws . HttpMethod < nl > import com . amazonaws . auth . BasicAWSCredentials < nl > @ @ - 16 , 13 + 11 , 25 @ @ import com . amazonaws . services . s3 . transfer . model . UploadResult < nl > import com . github . dwhjames . awswrap . s3 . { AmazonS3ScalaClient , FutureTransfer } < nl > import com . github . kxbmap . configs . _ < nl > import com . typesafe . config . { Config , ConfigFactory } < nl > - import slick . driver . PostgresDriver . api . _ < nl > - < nl > - import im . actor . api . rpc . files . FileLocation < nl > + import im . actor . api . rpc . files . { FileLocation ⇒ ApiFileLocation } < nl > + import im . actor . server . commons . serialization . ActorSerializer < nl > import im . actor . server . db . DbExtension < nl > + import im . actor . server . file . { Avatar , AvatarImage , FileLocation } < nl > import im . actor . server . { models , persist } < nl > + import slick . driver . PostgresDriver . api . _ < nl > < nl > - class S3StorageExtensionImpl ( val s3StorageAdapter : S3StorageAdapter ) extends Extension < nl > + import scala . concurrent . duration . _ < nl > + import scala . concurrent . forkjoin . ThreadLocalRandom < nl > + import scala . concurrent . { ExecutionContext , Future } < nl > + import scala . util . Try < nl > + < nl > + class S3StorageExtensionImpl ( val s3StorageAdapter : S3StorageAdapter ) extends Extension { < nl > + / / TODO : move to a proper place < nl > + < nl > + ActorSerializer . register ( 80001 , classOf [ FileLocation ] ) < nl > + ActorSerializer . register ( 80002 , classOf [ AvatarImage ] ) < nl > + ActorSerializer . register ( 80003 , classOf [ Avatar ] ) < nl > + } < nl > < nl > object S3StorageExtension extends ExtensionId [ S3StorageExtensionImpl ] with ExtensionIdProvider { < nl > override def lookup = S3StorageExtension < nl > @ @ - 62 , 10 + 69 , 10 @ @ class S3StorageAdapter ( config : S3StorageAdapterConfig , _ system : ActorSystem ) ext < nl > val s3Client = new AmazonS3ScalaClient ( awsCredentials ) < nl > val transferManager = new TransferManager ( awsCredentials ) < nl > < nl > - override def uploadFile ( name : String , file : File ) : DBIO [ FileLocation ] = < nl > + override def uploadFile ( name : String , file : File ) : DBIO [ ApiFileLocation ] = < nl > uploadFile ( bucketName , name , file ) < nl > < nl > - override def uploadFileF ( name : String , file : File ) : Future [ FileLocation ] = < nl > + override def uploadFileF ( name : String , file : File ) : Future [ ApiFileLocation ] = < nl > db . run ( uploadFile ( name , file ) ) < nl > < nl > override def downloadFile ( id : Long ) : DBIO [ Option [ File ] ] = { < nl > @ @ - 102 , 7 + 109 , 7 @ @ class S3StorageAdapter ( config : S3StorageAdapterConfig , _ system : ActorSystem ) ext < nl > } yield file < nl > } < nl > < nl > - private def uploadFile ( bucketName : String , name : String , file : File ) : DBIO [ FileLocation ] = { < nl > + private def uploadFile ( bucketName : String , name : String , file : File ) : DBIO [ ApiFileLocation ] = { < nl > val rnd = ThreadLocalRandom . current ( ) < nl > val id = rnd . nextLong ( ) < nl > val accessSalt = ACLUtils . nextAccessSalt ( rnd ) < nl > @ @ - 112 , 7 + 119 , 7 @ @ class S3StorageAdapter ( config : S3StorageAdapterConfig , _ system : ActorSystem ) ext < nl > _ ← persist . File . create ( id , accessSalt , FileUtils . s3Key ( id , name ) ) < nl > _ ← DBIO . from ( s3Upload ( bucketName , id , name , file ) ) < nl > _ ← DBIO . from ( sizeF ) flatMap ( s ⇒ persist . File . setUploaded ( id , s , name ) ) < nl > - } yield FileLocation ( id , ACLUtils . fileAccessHash ( id , accessSalt ) ) < nl > + } yield ApiFileLocation ( id , ACLUtils . fileAccessHash ( id , accessSalt ) ) < nl > } < nl > < nl > private def s3Upload ( bucketName : String , id : Long , name : String , file : File ) : Future [ UploadResult ] = {

TEST DIFF:
diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / migrations / Migration . scala b / actor - server / actor - core / src / main / scala / im / actor / server / migrations / Migration . scala 
 index acf33b9 . . c6ffc4c 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / migrations / Migration . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / migrations / Migration . scala 
 @ @ - 5 , 6 + 5 , 7 @ @ import java . time . Instant 
 import akka . actor . { Actor , ActorLogging , ActorSystem } 
 import akka . persistence . PersistentActor 
 import akka . util . Timeout 
 + import im . actor . config . ActorConfig 
 import im . actor . server . KeyValueMappings 
 import shardakka . { InstantCodec , ShardakkaExtension } 
 import slick . driver . PostgresDriver . api . _ 
 @ @ - 21 , 7 + 22 , 7 @ @ trait Migration { 
 protected def startMigration ( ) ( implicit system : ActorSystem , db : Database , ec : ExecutionContext ) : Future [ Unit ] 
 
 def migrate ( ) ( implicit system : ActorSystem , db : Database , ec : ExecutionContext ) : Unit = { 
 - implicit val kvTimeout = Timeout ( 5 . seconds ) 
 + implicit val kvTimeout = Timeout ( ActorConfig . defaultTimeout ) 
 val migrations = ShardakkaExtension ( system ) . simpleKeyValue [ Instant ] ( KeyValueMappings . Migrations , InstantCodec ) 
 Await . result ( migrations . get ( migrationName ) flatMap { 
 case Some ( date ) ⇒

NEAREST DIFF:
diff - - git a / actor - server / actor - commons - api / src / main / scala / im / actor / server / api / TypeMappers . scala b / actor - server / actor - commons - api / src / main / scala / im / actor / server / api / TypeMappers . scala 
 index 25b1496 . . 4f514b0 100644 
 - - - a / actor - server / actor - commons - api / src / main / scala / im / actor / server / api / TypeMappers . scala 
 + + + b / actor - server / actor - commons - api / src / main / scala / im / actor / server / api / TypeMappers . scala 
 @ @ - 55 , 8 + 55 , 13 @ @ private [ api ] trait MessageMapper { 
 ByteString . copyFrom ( group . toByteArray ) 
 } 
 
 - private def applyPeer ( buf : ByteString ) : Peer = 
 - Peer . parseFrom ( CodedInputStream . newInstance ( buf . asReadOnlyByteBuffer ( ) ) ) . right . get 
 + private def applyPeer ( bytes : ByteString ) : Peer = { 
 + if ( bytes . size ( ) > 0 ) { 
 + Peer . parseFrom ( CodedInputStream . newInstance ( bytes . asReadOnlyByteBuffer ( ) ) ) . right . get 
 + } else { 
 + null 
 + } 
 + } 
 
 private def unapplyPeer ( peer : Peer ) : ByteString = 
 ByteString . copyFrom ( peer . toByteArray ) 
 diff - - git a / actor - server / actor - commons - base / src / main / scala / im / actor / server / commons / ActorConfig . scala b / actor - server / actor - commons - base / src / main / scala / im / actor / server / commons / ActorConfig . scala 
 index 780e6a7 . . 5ebe48c 100644 
 - - - a / actor - server / actor - commons - base / src / main / scala / im / actor / server / commons / ActorConfig . scala 
 + + + b / actor - server / actor - commons - base / src / main / scala / im / actor / server / commons / ActorConfig . scala 
 @ @ - 1 , 31 + 1 , 15 @ @ 
 package im . actor . server . commons 
 
 - import com . typesafe . config . { ConfigFactory , Config } 
 + import com . typesafe . config . { Config , ConfigFactory } 
 
 object ActorConfig { 
 def load ( ) : Config = { 
 ConfigFactory . parseString ( 
 - s " " " 
 + " " " 
 | akka { 
 | actor { 
 | provider : " akka . cluster . ClusterActorRefProvider " 
 | } 
 - | 
 - | remote { 
 - | netty . tcp { 
 - | hostname : " 127 . 0 . 0 . 1 " 
 - | port : 2553 
 - | } 
 - | } 
 - | 
 - | cluster { 
 - | seed - nodes : [ " akka . tcp : / / actor - server @ 127 . 0 . 0 . 1 : 2553 " ] 
 - | } 
 - | 
 - | persistence { 
 - | journal . plugin : " jdbc - journal " 
 - | snapshot - store . plugin : " jdbc - snapshot - store " 
 - | } 
 | } 
 | 
 | jdbc - connection { 
 @ @ - 35 , 6 + 19 , 16 @ @ object ActorConfig { 
 " " " . stripMargin 
 ) 
 . withFallback ( ConfigFactory . load ( ) ) 
 + . withFallback ( ConfigFactory . parseString ( 
 + " " " 
 + | akka { 
 + | persistence { 
 + | journal . plugin : " jdbc - journal " 
 + | snapshot - store . plugin : " jdbc - snapshot - store " 
 + | } 
 + | } 
 + " " " . stripMargin 
 + ) ) 
 . resolve ( ) 
 } 
 } 
 diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / dialog / group / GroupDialogExtension . scala b / actor - server / actor - core / src / main / scala / im / actor / server / dialog / group / GroupDialogExtension . scala 
 index 900f96e . . 9807973 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / dialog / group / GroupDialogExtension . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / dialog / group / GroupDialogExtension . scala 
 @ @ - 5 , 6 + 5 , 8 @ @ import akka . actor . _ 
 sealed trait GroupDialogExtension extends Extension 
 
 final class GroupDialogExtensionImpl ( system : ActorSystem ) extends GroupDialogExtension { 
 + GroupDialog . register ( ) 
 + 
 lazy val region : GroupDialogRegion = GroupDialogRegion . start ( ) ( system ) 
 } 
 
 diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / dialog / privat / PrivateDialogExtension . scala b / actor - server / actor - core / src / main / scala / im / actor / server / dialog / privat / PrivateDialogExtension . scala 
 index 79bf6f5 . . d5d79d6 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / dialog / privat / PrivateDialogExtension . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / dialog / privat / PrivateDialogExtension . scala 
 @ @ - 5 , 6 + 5 , 8 @ @ import akka . actor . _ 
 sealed trait PrivateDialogExtension extends Extension 
 
 final class PrivateDialogExtensionImpl ( system : ActorSystem ) extends PrivateDialogExtension { 
 + PrivateDialog . register ( ) 
 + 
 lazy val region : PrivateDialogRegion = PrivateDialogRegion . start ( ) ( system ) 
 } 
 
 diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupExtension . scala b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupExtension . scala 
 index 4b344bc . . 6dd3eb7 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupExtension . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupExtension . scala 
 @ @ - 5 , 6 + 5 , 8 @ @ import akka . actor . _ 
 sealed trait GroupExtension extends Extension 
 
 final class GroupExtensionImpl ( system : ActorSystem ) extends GroupExtension { 
 + GroupProcessor . register ( ) 
 + 
 lazy val processorRegion : GroupProcessorRegion = GroupProcessorRegion . start ( ) ( system ) 
 lazy val viewRegion : GroupViewRegion = GroupViewRegion ( processorRegion . ref ) 
 } 
 diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupProcessor . scala b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupProcessor . scala 
 index ce3eec3 . . 458a489 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupProcessor . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / group / GroupProcessor . scala 
 @ @ - 7 , 11 + 7 , 10 @ @ import akka . persistence . { RecoveryCompleted , RecoveryFailure } 
 import akka . util . Timeout 
 import im . actor . server . commons . serialization . ActorSerializer 
 import im . actor . server . db . DbExtension 
 + import im . actor . server . dialog . group . { GroupDialogExtension , GroupDialogRegion } 
 import im . actor . server . event . TSEvent 
 import im . actor . server . file . Avatar 
 import im . actor . server . office . { PeerProcessor , ProcessorState , StopOffice } 
 - import im . actor . server . dialog . group . GroupDialogExtension 
 - import im . actor . server . dialog . group . GroupDialogRegion 
 import im . actor . server . push . SeqUpdatesExtension 
 import im . actor . server . user . { UserExtension , UserProcessorRegion , UserViewRegion } 
 import im . actor . server . util . { FileStorageAdapter , S3StorageExtension } 
 @ @ - 84 , 6 + 83 , 8 @ @ object GroupProcessor { 
 ActorSerializer . register ( 21004 , classOf [ GroupQueries . CheckAccessHashResponse ] ) 
 ActorSerializer . register ( 21005 , classOf [ GroupQueries . GetMembers ] ) 
 ActorSerializer . register ( 21006 , classOf [ GroupQueries . GetMembersResponse ] ) 
 + ActorSerializer . register ( 21007 , classOf [ GroupQueries . GetApiStruct ] ) 
 + ActorSerializer . register ( 21008 , classOf [ GroupQueries . GetApiStructResponse ] ) 
 
 ActorSerializer . register ( 22003 , classOf [ GroupEvents . UserInvited ] ) 
 ActorSerializer . register ( 22004 , classOf [ GroupEvents . UserJoined ] ) 
 diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesExtension . scala b / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesExtension . scala 
 index f58914d . . 1fc3f06 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesExtension . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesExtension . scala 
 @ @ - 43 , 6 + 43 , 8 @ @ final class SeqUpdatesExtensionImpl ( 
 private implicit val system : ActorSystem = _ system 
 private implicit lazy val db : Database = DbExtension ( system ) . db 
 
 + SeqUpdatesManager . register ( ) 
 + 
 lazy val region : SeqUpdatesManagerRegion = SeqUpdatesManagerRegion . start ( ) ( system , gpm , apm ) 
 
 def getFatData ( 
 diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesManager . scala b / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesManager . scala 
 index b8c35f6 . . 4c42aa0 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesManager . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / push / SeqUpdatesManager . scala 
 @ @ - 2 , 7 + 2 , 7 @ @ package im . actor . server . push 
 
 import java . nio . ByteBuffer 
 
 - import im . actor . server . util . AnyRefLogSource 
 + import im . actor . server . commons . serialization . ActorSerializer 
 
 import scala . annotation . tailrec 
 import scala . concurrent . _ 
 @ @ - 18 , 7 + 18 , 7 @ @ import im . actor . api . rpc . peers . { PeerType , Peer } 
 import im . actor . api . { rpc ⇒ api } 
 import im . actor . server . db . DbExtension 
 import im . actor . server . models . sequence 
 - import im . actor . server . sequence . SeqState 
 + import im . actor . server . sequence . { SeqStateDate , SeqState } 
 import im . actor . server . user . { UserOffice , UserViewRegion } 
 import im . actor . server . { models , persist ⇒ p } 
 
 @ @ - 34 , 6 + 34 , 11 @ @ object SeqUpdatesManager { 
 / / TODO : configurable 
 private implicit val OperationTimeout = Timeout ( 30 . seconds ) 
 
 + def register ( ) : Unit = { 
 + ActorSerializer . register ( 60001 , classOf [ SeqState ] ) 
 + ActorSerializer . register ( 60002 , classOf [ SeqStateDate ] ) 
 + } 
 + 
 def getSeqState ( authId : Long ) ( implicit ext : SeqUpdatesExtension , ec : ExecutionContext ) : Future [ SeqState ] = 
 ext . region . ref . ask ( Envelope ( authId , GetSequenceState ) ) ( OperationTimeout ) . mapTo [ SeqState ] 
 
 diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / user / UserExtension . scala b / actor - server / actor - core / src / main / scala / im / actor / server / user / UserExtension . scala 
 index 1f6e847 . . b3ed7b2 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / user / UserExtension . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / user / UserExtension . scala 
 @ @ - 5 , 6 + 5 , 8 @ @ import akka . actor . _ 
 sealed trait UserExtension extends Extension 
 
 final class UserExtensionImpl ( system : ActorSystem ) extends UserExtension { 
 + UserProcessor . register ( ) 
 + 
 lazy val processorRegion : UserProcessorRegion = UserProcessorRegion . start ( ) ( system ) 
 lazy val viewRegion : UserViewRegion = UserViewRegion ( processorRegion . ref ) 
 } 
 diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / user / UserProcessor . scala b / actor - server / actor - core / src / main / scala / im / actor / server / user / UserProcessor . scala 
 index d506745 . . ac89e49 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / user / UserProcessor . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / user / UserProcessor . scala 
 @ @ - 102 , 6 + 102 , 8 @ @ object UserProcessor { 
 ActorSerializer . register ( 11004 , classOf [ UserQueries . GetContactRecordsResponse ] ) 
 ActorSerializer . register ( 11005 , classOf [ UserQueries . CheckAccessHash ] ) 
 ActorSerializer . register ( 11006 , classOf [ UserQueries . CheckAccessHashResponse ] ) 
 + ActorSerializer . register ( 11007 , classOf [ UserQueries . GetApiStruct ] ) 
 + ActorSerializer . register ( 11008 , classOf [ UserQueries . GetApiStructResponse ] ) 
 
 ActorSerializer . register ( 12001 , classOf [ UserEvents . AuthAdded ] ) 
 ActorSerializer . register ( 12002 , classOf [ UserEvents . AuthRemoved ] ) 
 diff - - git a / actor - server / actor - runner / src / main / scala / im / actor / server / Main . scala b / actor - server / actor - runner / src / main / scala / im / actor / server / Main . scala 
 index ccdd66e . . 3ae4734 100644 
 - - - a / actor - server / actor - runner / src / main / scala / im / actor / server / Main . scala 
 + + + b / actor - server / actor - runner / src / main / scala / im / actor / server / Main . scala 
 @ @ - 93 , 12 + 93 , 10 @ @ object Main extends App { 
 case _ ⇒ throw new Exception ( " " " Invalid activation . default - service value provided : valid options : " internal " , actor - activation " " " ) 
 } 
 
 - Session . startRegion ( 
 + implicit val sessionRegion = Session . startRegion ( 
 Some ( Session . props ( mediator ) ) 
 ) 
 
 - implicit val sessionRegion = Session . startRegionProxy ( ) 
 - 
 RichMessageWorker . startWorker ( richMessageConfig , mediator ) 
 
 implicit val oauth2Service = new GoogleProvider ( oauth2GoogleConfig ) 
 diff - - git a / actor - server / actor - utils / src / main / scala / im / actor / server / util / S3StorageAdapter . scala b / actor - server / actor - utils / src / main / scala / im / actor / server / util / S3StorageAdapter . scala 
 index 2e3a937 . . 2dd469e 100644 
 - - - a / actor - server / actor - utils / src / main / scala / im / actor / server / util / S3StorageAdapter . scala 
 + + + b / actor - server / actor - utils / src / main / scala / im / actor / server / util / S3StorageAdapter . scala 
 @ @ - 2 , 11 + 2 , 6 @ @ package im . actor . server . util 
 
 import java . io . File 
 
 - import scala . concurrent . duration . _ 
 - import scala . concurrent . forkjoin . ThreadLocalRandom 
 - import scala . concurrent . { ExecutionContext , Future } 
 - import scala . util . Try 
 - 
 import akka . actor . _ 
 import com . amazonaws . HttpMethod 
 import com . amazonaws . auth . BasicAWSCredentials 
 @ @ - 16 , 13 + 11 , 25 @ @ import com . amazonaws . services . s3 . transfer . model . UploadResult 
 import com . github . dwhjames . awswrap . s3 . { AmazonS3ScalaClient , FutureTransfer } 
 import com . github . kxbmap . configs . _ 
 import com . typesafe . config . { Config , ConfigFactory } 
 - import slick . driver . PostgresDriver . api . _ 
 - 
 - import im . actor . api . rpc . files . FileLocation 
 + import im . actor . api . rpc . files . { FileLocation ⇒ ApiFileLocation } 
 + import im . actor . server . commons . serialization . ActorSerializer 
 import im . actor . server . db . DbExtension 
 + import im . actor . server . file . { Avatar , AvatarImage , FileLocation } 
 import im . actor . server . { models , persist } 
 + import slick . driver . PostgresDriver . api . _ 
 
 - class S3StorageExtensionImpl ( val s3StorageAdapter : S3StorageAdapter ) extends Extension 
 + import scala . concurrent . duration . _ 
 + import scala . concurrent . forkjoin . ThreadLocalRandom 
 + import scala . concurrent . { ExecutionContext , Future } 
 + import scala . util . Try 
 + 
 + class S3StorageExtensionImpl ( val s3StorageAdapter : S3StorageAdapter ) extends Extension { 
 + / / TODO : move to a proper place 
 + 
 + ActorSerializer . register ( 80001 , classOf [ FileLocation ] ) 
 + ActorSerializer . register ( 80002 , classOf [ AvatarImage ] ) 
 + ActorSerializer . register ( 80003 , classOf [ Avatar ] ) 
 + } 
 
 object S3StorageExtension extends ExtensionId [ S3StorageExtensionImpl ] with ExtensionIdProvider { 
 override def lookup = S3StorageExtension 
 @ @ - 62 , 10 + 69 , 10 @ @ class S3StorageAdapter ( config : S3StorageAdapterConfig , _ system : ActorSystem ) ext 
 val s3Client = new AmazonS3ScalaClient ( awsCredentials ) 
 val transferManager = new TransferManager ( awsCredentials ) 
 
 - override def uploadFile ( name : String , file : File ) : DBIO [ FileLocation ] = 
 + override def uploadFile ( name : String , file : File ) : DBIO [ ApiFileLocation ] = 
 uploadFile ( bucketName , name , file ) 
 
 - override def uploadFileF ( name : String , file : File ) : Future [ FileLocation ] = 
 + override def uploadFileF ( name : String , file : File ) : Future [ ApiFileLocation ] = 
 db . run ( uploadFile ( name , file ) ) 
 
 override def downloadFile ( id : Long ) : DBIO [ Option [ File ] ] = { 
 @ @ - 102 , 7 + 109 , 7 @ @ class S3StorageAdapter ( config : S3StorageAdapterConfig , _ system : ActorSystem ) ext 
 } yield file 
 } 
 
 - private def uploadFile ( bucketName : String , name : String , file : File ) : DBIO [ FileLocation ] = { 
 + private def uploadFile ( bucketName : String , name : String , file : File ) : DBIO [ ApiFileLocation ] = { 
 val rnd = ThreadLocalRandom . current ( ) 
 val id = rnd . nextLong ( ) 
 val accessSalt = ACLUtils . nextAccessSalt ( rnd ) 
 @ @ - 112 , 7 + 119 , 7 @ @ class S3StorageAdapter ( config : S3StorageAdapterConfig , _ system : ActorSystem ) ext 
 _ ← persist . File . create ( id , accessSalt , FileUtils . s3Key ( id , name ) ) 
 _ ← DBIO . from ( s3Upload ( bucketName , id , name , file ) ) 
 _ ← DBIO . from ( sizeF ) flatMap ( s ⇒ persist . File . setUploaded ( id , s , name ) ) 
 - } yield FileLocation ( id , ACLUtils . fileAccessHash ( id , accessSalt ) ) 
 + } yield ApiFileLocation ( id , ACLUtils . fileAccessHash ( id , accessSalt ) ) 
 } 
 
 private def s3Upload ( bucketName : String , id : Long , name : String , file : File ) : Future [ UploadResult ] = {
