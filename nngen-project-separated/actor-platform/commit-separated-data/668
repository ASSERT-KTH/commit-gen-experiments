BLEU SCORE: 0.06917184228205475

TEST MSG: fix ( server : acl ) : deprecate md5 digest ; use sha - 256 instead
GENERATED MSG: perf ( server ) : much faster user accessHash checking

TEST DIFF (one line): diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / acl / ACLUtils . scala b / actor - server / actor - core / src / main / scala / im / actor / server / acl / ACLUtils . scala < nl > index 475d44b . . 4e26eca 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / acl / ACLUtils . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / acl / ACLUtils . scala < nl > @ @ - 15 , 7 + 15 , 6 @ @ import im . actor . server . persist . UserPasswordRepo < nl > import im . actor . server . user . UserExtension < nl > import im . actor . util . ThreadLocalSecureRandom < nl > import org . apache . commons . codec . digest . DigestUtils < nl > - import scodec . bits . BitVector < nl > import slick . dbio . DBIO < nl > < nl > import scala . concurrent . { ExecutionContext , Future } < nl > @ @ - 27 , 26 + 26 , 26 @ @ object ACLUtils extends ACLBase with ACLFiles { < nl > type Hash = Array [ Byte ] < nl > type Salt = Array [ Byte ] < nl > < nl > - def userAccessHash ( authId : Long , userId : Int , accessSalt : String , md : MessageDigest = getMDInstance ( ) ) ( implicit s : ActorSystem ) : Long = < nl > - hash ( s " $ authId : $ userId : $ accessSalt : $ { secretKey ( ) } " , md ) < nl > + def userAccessHash ( authId : Long , userId : Int , accessSalt : String ) ( implicit s : ActorSystem ) : Long = < nl > + hashObsolete ( s " $ authId : $ userId : $ accessSalt : $ { secretKey ( ) } " ) < nl > < nl > def userAccessHash ( authId : Long , u : User ) ( implicit s : ActorSystem ) : Long = < nl > userAccessHash ( authId , u . id , u . accessSalt ) < nl > < nl > def phoneAccessHash ( authId : Long , userId : Int , phoneId : Int , accessSalt : String ) ( implicit s : ActorSystem ) : Long = < nl > - hash ( s " $ authId : $ userId : $ phoneId : $ accessSalt : $ { secretKey ( ) } " ) < nl > + hashObsolete ( s " $ authId : $ userId : $ phoneId : $ accessSalt : $ { secretKey ( ) } " ) < nl > < nl > def phoneAccessHash ( authId : Long , p : UserPhone ) ( implicit s : ActorSystem ) : Long = < nl > phoneAccessHash ( authId , p . userId , p . id , p . accessSalt ) < nl > < nl > def emailAccessHash ( authId : Long , userId : Int , emailId : Int , accessSalt : String ) ( implicit s : ActorSystem ) : Long = < nl > - hash ( s " $ authId : $ userId : $ emailId : $ accessSalt : $ { secretKey ( ) } " ) < nl > + hashObsolete ( s " $ authId : $ userId : $ emailId : $ accessSalt : $ { secretKey ( ) } " ) < nl > < nl > def emailAccessHash ( authId : Long , e : UserEmail ) ( implicit s : ActorSystem ) : Long = < nl > emailAccessHash ( authId , e . userId , e . id , e . accessSalt ) < nl > < nl > def stickerPackAccessHash ( id : Int , ownerUserId : Int , accessSalt : String ) ( implicit s : ActorSystem ) : Long = < nl > - hash ( s " $ id : $ ownerUserId : $ accessSalt : $ { secretKey ( ) } " ) < nl > + hashObsolete ( s " $ id : $ ownerUserId : $ accessSalt : $ { secretKey ( ) } " ) < nl > < nl > def stickerPackAccessHash ( pack : StickerPack ) ( implicit s : ActorSystem ) : Long = < nl > stickerPackAccessHash ( pack . id , pack . ownerUserId , pack . accessSalt ) < nl > diff - - git a / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLBase . scala b / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLBase . scala < nl > index b53ef1f . . 1d8e01c 100644 < nl > - - - a / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLBase . scala < nl > + + + b / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLBase . scala < nl > @ @ - 4 , 17 + 4 , 22 @ @ import java . nio . ByteBuffer < nl > import java . security . MessageDigest < nl > < nl > import akka . actor . ActorSystem < nl > - import im . actor . concurrent . ThreadLocalMD5 < nl > + import im . actor . concurrent . { ThreadLocalMD5 , ThreadLocalSHA256 } < nl > import im . actor . util . ThreadLocalSecureRandom < nl > < nl > trait ACLBase { < nl > < nl > - def getMDInstance ( ) = ThreadLocalMD5 . current ( ) < nl > + private def getMDInstance = ThreadLocalMD5 . current ( ) < nl > + < nl > + private def getSHA256Instance = ThreadLocalSHA256 . current ( ) < nl > < nl > def secretKey ( ) ( implicit s : ActorSystem ) : String = < nl > s . settings . config . getString ( " secret " ) < nl > < nl > - def hash ( s : String , md : MessageDigest = getMDInstance ( ) ) : Long = < nl > + / / deprecated : use hash with sha256 digest instead < nl > + def hashObsolete ( s : String ) : Long = hash ( s , getMDInstance ) < nl > + < nl > + def hash ( s : String , md : MessageDigest = getSHA256Instance ) : Long = < nl > ByteBuffer . wrap ( md . digest ( s . getBytes ) ) . getLong < nl > < nl > def randomLong ( ) : Long = randomLong ( ThreadLocalSecureRandom . current ( ) ) < nl > diff - - git a / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLFiles . scala b / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLFiles . scala < nl > index e401799 . . 844b086 100644 < nl > - - - a / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLFiles . scala < nl > + + + b / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLFiles . scala < nl > @ @ - 6 , 7 + 6 , 7 @ @ object ACLFiles extends ACLFiles < nl > < nl > trait ACLFiles extends ACLBase { < nl > def fileAccessHash ( fileId : Long , accessSalt : String ) ( implicit s : ActorSystem ) : Long = < nl > - hash ( s " $ fileId : $ accessSalt : $ { secretKey ( ) } " ) < nl > + hashObsolete ( s " $ fileId : $ accessSalt : $ { secretKey ( ) } " ) < nl > < nl > def fileUrlBuilderSecret ( seed : String , expire : Long ) ( implicit s : ActorSystem ) : Long = < nl > hash ( s " $ seed : $ expire : $ { secretKey ( ) } " ) < nl > diff - - git a / actor - server / actor - runtime / src / main / scala / im / actor / concurrent / ThreadLocalSHA256 . scala b / actor - server / actor - runtime / src / main / scala / im / actor / concurrent / ThreadLocalSHA256 . scala < nl > new file mode 100644 < nl > index 0000000 . . fca0ab6 < nl > - - - / dev / null < nl > + + + b / actor - server / actor - runtime / src / main / scala / im / actor / concurrent / ThreadLocalSHA256 . scala < nl > @ @ - 0 , 0 + 1 , 12 @ @ < nl > + package im . actor . concurrent < nl > + < nl > + import java . security . MessageDigest < nl > + < nl > + object ThreadLocalSHA256 { < nl > + private val local : ThreadLocal [ MessageDigest ] = new ThreadLocal [ MessageDigest ] ( ) { < nl > + override protected def initialValue ( ) : MessageDigest = < nl > + MessageDigest . getInstance ( " SHA - 256 " ) < nl > + } < nl > + < nl > + def current ( ) : MessageDigest = local . get ( ) < nl > + } < nl > \ No newline at end of file
NEAREST DIFF (one line): diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / acl / ACLUtils . scala b / actor - server / actor - core / src / main / scala / im / actor / server / acl / ACLUtils . scala < nl > index 521c208 . . 7bcad1e 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / acl / ACLUtils . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / acl / ACLUtils . scala < nl > @ @ - 1 , 6 + 1 , 6 @ @ < nl > package im . actor . server . acl < nl > < nl > - import java . security . SecureRandom < nl > + import java . security . { MessageDigest , SecureRandom } < nl > import javax . crypto . SecretKeyFactory < nl > import javax . crypto . spec . PBEKeySpec < nl > < nl > @ @ - 27 , 8 + 27 , 8 @ @ object ACLUtils extends ACLBase with ACLFiles { < nl > type Hash = Array [ Byte ] < nl > type Salt = Array [ Byte ] < nl > < nl > - def userAccessHash ( authId : Long , userId : Int , accessSalt : String ) ( implicit s : ActorSystem ) : Long = < nl > - hash ( s " $ authId : $ userId : $ accessSalt : $ { secretKey ( ) } " ) < nl > + def userAccessHash ( authId : Long , userId : Int , accessSalt : String , md : MessageDigest = getMDInstance ( ) ) ( implicit s : ActorSystem ) : Long = < nl > + hash ( s " $ authId : $ userId : $ accessSalt : $ { secretKey ( ) } " , md ) < nl > < nl > def userAccessHash ( authId : Long , u : model . User ) ( implicit s : ActorSystem ) : Long = < nl > userAccessHash ( authId , u . id , u . accessSalt ) < nl > diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / user / UserProcessor . scala b / actor - server / actor - core / src / main / scala / im / actor / server / user / UserProcessor . scala < nl > index 5f5b126 . . 5662128 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / user / UserProcessor . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / user / UserProcessor . scala < nl > @ @ - 6 , 6 + 6 , 7 @ @ import akka . persistence . RecoveryCompleted < nl > import akka . util . Timeout < nl > import im . actor . api . rpc . misc . ApiExtension < nl > import im . actor . serialization . ActorSerializer < nl > + import im . actor . server . acl . ACLUtils < nl > import im . actor . server . db . DbExtension < nl > import im . actor . server . dialog . { DialogCommand , DialogExtension } < nl > import im . actor . server . event . TSEvent < nl > @ @ - 147 , 6 + 148 , 9 @ @ private [ user ] final class UserProcessor < nl > protected implicit val seqUpdatesExt : SeqUpdatesExtension = SeqUpdatesExtension ( system ) < nl > protected implicit val socialRegion : SocialManagerRegion = SocialExtension ( system ) . region < nl > < nl > + / / For GetApiStruct < nl > + protected val aclMD = ACLUtils . getMDInstance ( ) < nl > + < nl > protected implicit val timeout : Timeout = Timeout ( 10 . seconds ) < nl > < nl > protected val userId = self . path . name . toInt < nl > diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / user / UserQueriesHandlers . scala b / actor - server / actor - core / src / main / scala / im / actor / server / user / UserQueriesHandlers . scala < nl > index ee22c4e . . 20b6df3 100644 < nl > - - - a / actor - server / actor - core / src / main / scala / im / actor / server / user / UserQueriesHandlers . scala < nl > + + + b / actor - server / actor - core / src / main / scala / im / actor / server / user / UserQueriesHandlers . scala < nl > @ @ - 24 , 7 + 24 , 7 @ @ private [ user ] trait UserQueriesHandlers { < nl > userExt . getLocalName ( clientUserId , state . id ) < nl > } yield GetApiStructResponse ( ApiUser ( < nl > id = userId , < nl > - accessHash = ACLUtils . userAccessHash ( clientAuthId , userId , state . accessSalt ) , < nl > + accessHash = ACLUtils . userAccessHash ( clientAuthId , userId , state . accessSalt , aclMD ) , < nl > name = state . name , < nl > localName = UserUtils . normalizeLocalName ( localName ) , < nl > sex = Some ( state . sex ) , < nl > diff - - git a / actor - server / actor - rpc - api / src / main / scala / im / actor / api / rpc / PeerHelpers . scala b / actor - server / actor - rpc - api / src / main / scala / im / actor / api / rpc / PeerHelpers . scala < nl > index 6ffd726 . . bf8a60a 100644 < nl > - - - a / actor - server / actor - rpc - api / src / main / scala / im / actor / api / rpc / PeerHelpers . scala < nl > + + + b / actor - server / actor - rpc - api / src / main / scala / im / actor / api / rpc / PeerHelpers . scala < nl > @ @ - 2 , 6 + 2 , 7 @ @ package im . actor . api . rpc < nl > < nl > import im . actor . server . acl . ACLUtils < nl > import im . actor . server . db . DbExtension < nl > + import im . actor . server . user . UserExtension < nl > < nl > import scala . collection . immutable < nl > import scala . concurrent . { Future , ExecutionContext } < nl > @ @ - 30 , 13 + 31 , 9 @ @ object PeerHelpers { < nl > ) ( implicit client : AuthorizedClientData , actorSystem : ActorSystem , ec : ExecutionContext ) : DBIO [ RpcError \ / R ] = { < nl > outPeer . ` type ` match { < nl > case ApiPeerType . Private ⇒ < nl > - ( for { < nl > - optUser ← persist . UserRepo . find ( outPeer . id ) < nl > - usererrOrUser ← validUser ( optUser ) < nl > - hasherrOrUser ← DBIO . successful ( usererrOrUser . map ( validUserAccessHash ( outPeer . accessHash , _ ) ) ) < nl > - } yield hasherrOrUser ) . flatMap { < nl > - case Error ( err ) ⇒ DBIO . successful ( Error ( err ) ) < nl > - case _ ⇒ f < nl > + DBIO . from ( ACLUtils . checkOutPeer ( outPeer , client . authId ) ) flatMap { < nl > + case false ⇒ DBIO . successful ( Error ( CommonErrors . InvalidAccessHash ) ) < nl > + case true ⇒ f < nl > } < nl > case ApiPeerType . Group ⇒ < nl > ( for { < nl > @ @ - 198 , 14 + 195 , 6 @ @ object PeerHelpers { < nl > } < nl > } < nl > < nl > - private def validUser ( optUser : Option [ model . User ] ) = { < nl > - optUser match { < nl > - case Some ( user ) ⇒ < nl > - DBIO . successful ( \ / - ( user ) ) < nl > - case None ⇒ DBIO . successful ( Error ( CommonErrors . UserNotFound ) ) < nl > - } < nl > - } < nl > - < nl > def validateGroupAccess ( optGroup : Option [ model . Group ] , userId : Int ) ( implicit ec : ExecutionContext ) = optGroup match { < nl > case Some ( group ) ⇒ < nl > ( for ( user ← persist . GroupUserRepo . find ( group . id , userId ) ) yield user ) . flatMap { < nl > diff - - git a / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLBase . scala b / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLBase . scala < nl > index 51924b1 . . d23b981 100644 < nl > - - - a / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLBase . scala < nl > + + + b / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLBase . scala < nl > @ @ - 9 , 11 + 9 , 13 @ @ import scala . concurrent . forkjoin . ThreadLocalRandom < nl > < nl > trait ACLBase { < nl > < nl > + def getMDInstance ( ) = MessageDigest . getInstance ( " MD5 " ) < nl > + < nl > def secretKey ( ) ( implicit s : ActorSystem ) = < nl > s . settings . config . getString ( " secret " ) < nl > < nl > - def hash ( s : String ) : Long = < nl > - ByteBuffer . wrap ( MessageDigest . getInstance ( " MD5 " ) . digest ( s . getBytes ) ) . getLong < nl > + def hash ( s : String , md : MessageDigest = getMDInstance ( ) ) : Long = < nl > + ByteBuffer . wrap ( md . digest ( s . getBytes ) ) . getLong < nl > < nl > def randomLong ( ) : Long = randomLong ( ThreadLocalRandom . current ( ) )

TEST DIFF:
diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / acl / ACLUtils . scala b / actor - server / actor - core / src / main / scala / im / actor / server / acl / ACLUtils . scala 
 index 475d44b . . 4e26eca 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / acl / ACLUtils . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / acl / ACLUtils . scala 
 @ @ - 15 , 7 + 15 , 6 @ @ import im . actor . server . persist . UserPasswordRepo 
 import im . actor . server . user . UserExtension 
 import im . actor . util . ThreadLocalSecureRandom 
 import org . apache . commons . codec . digest . DigestUtils 
 - import scodec . bits . BitVector 
 import slick . dbio . DBIO 
 
 import scala . concurrent . { ExecutionContext , Future } 
 @ @ - 27 , 26 + 26 , 26 @ @ object ACLUtils extends ACLBase with ACLFiles { 
 type Hash = Array [ Byte ] 
 type Salt = Array [ Byte ] 
 
 - def userAccessHash ( authId : Long , userId : Int , accessSalt : String , md : MessageDigest = getMDInstance ( ) ) ( implicit s : ActorSystem ) : Long = 
 - hash ( s " $ authId : $ userId : $ accessSalt : $ { secretKey ( ) } " , md ) 
 + def userAccessHash ( authId : Long , userId : Int , accessSalt : String ) ( implicit s : ActorSystem ) : Long = 
 + hashObsolete ( s " $ authId : $ userId : $ accessSalt : $ { secretKey ( ) } " ) 
 
 def userAccessHash ( authId : Long , u : User ) ( implicit s : ActorSystem ) : Long = 
 userAccessHash ( authId , u . id , u . accessSalt ) 
 
 def phoneAccessHash ( authId : Long , userId : Int , phoneId : Int , accessSalt : String ) ( implicit s : ActorSystem ) : Long = 
 - hash ( s " $ authId : $ userId : $ phoneId : $ accessSalt : $ { secretKey ( ) } " ) 
 + hashObsolete ( s " $ authId : $ userId : $ phoneId : $ accessSalt : $ { secretKey ( ) } " ) 
 
 def phoneAccessHash ( authId : Long , p : UserPhone ) ( implicit s : ActorSystem ) : Long = 
 phoneAccessHash ( authId , p . userId , p . id , p . accessSalt ) 
 
 def emailAccessHash ( authId : Long , userId : Int , emailId : Int , accessSalt : String ) ( implicit s : ActorSystem ) : Long = 
 - hash ( s " $ authId : $ userId : $ emailId : $ accessSalt : $ { secretKey ( ) } " ) 
 + hashObsolete ( s " $ authId : $ userId : $ emailId : $ accessSalt : $ { secretKey ( ) } " ) 
 
 def emailAccessHash ( authId : Long , e : UserEmail ) ( implicit s : ActorSystem ) : Long = 
 emailAccessHash ( authId , e . userId , e . id , e . accessSalt ) 
 
 def stickerPackAccessHash ( id : Int , ownerUserId : Int , accessSalt : String ) ( implicit s : ActorSystem ) : Long = 
 - hash ( s " $ id : $ ownerUserId : $ accessSalt : $ { secretKey ( ) } " ) 
 + hashObsolete ( s " $ id : $ ownerUserId : $ accessSalt : $ { secretKey ( ) } " ) 
 
 def stickerPackAccessHash ( pack : StickerPack ) ( implicit s : ActorSystem ) : Long = 
 stickerPackAccessHash ( pack . id , pack . ownerUserId , pack . accessSalt ) 
 diff - - git a / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLBase . scala b / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLBase . scala 
 index b53ef1f . . 1d8e01c 100644 
 - - - a / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLBase . scala 
 + + + b / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLBase . scala 
 @ @ - 4 , 17 + 4 , 22 @ @ import java . nio . ByteBuffer 
 import java . security . MessageDigest 
 
 import akka . actor . ActorSystem 
 - import im . actor . concurrent . ThreadLocalMD5 
 + import im . actor . concurrent . { ThreadLocalMD5 , ThreadLocalSHA256 } 
 import im . actor . util . ThreadLocalSecureRandom 
 
 trait ACLBase { 
 
 - def getMDInstance ( ) = ThreadLocalMD5 . current ( ) 
 + private def getMDInstance = ThreadLocalMD5 . current ( ) 
 + 
 + private def getSHA256Instance = ThreadLocalSHA256 . current ( ) 
 
 def secretKey ( ) ( implicit s : ActorSystem ) : String = 
 s . settings . config . getString ( " secret " ) 
 
 - def hash ( s : String , md : MessageDigest = getMDInstance ( ) ) : Long = 
 + / / deprecated : use hash with sha256 digest instead 
 + def hashObsolete ( s : String ) : Long = hash ( s , getMDInstance ) 
 + 
 + def hash ( s : String , md : MessageDigest = getSHA256Instance ) : Long = 
 ByteBuffer . wrap ( md . digest ( s . getBytes ) ) . getLong 
 
 def randomLong ( ) : Long = randomLong ( ThreadLocalSecureRandom . current ( ) ) 
 diff - - git a / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLFiles . scala b / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLFiles . scala 
 index e401799 . . 844b086 100644 
 - - - a / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLFiles . scala 
 + + + b / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLFiles . scala 
 @ @ - 6 , 7 + 6 , 7 @ @ object ACLFiles extends ACLFiles 
 
 trait ACLFiles extends ACLBase { 
 def fileAccessHash ( fileId : Long , accessSalt : String ) ( implicit s : ActorSystem ) : Long = 
 - hash ( s " $ fileId : $ accessSalt : $ { secretKey ( ) } " ) 
 + hashObsolete ( s " $ fileId : $ accessSalt : $ { secretKey ( ) } " ) 
 
 def fileUrlBuilderSecret ( seed : String , expire : Long ) ( implicit s : ActorSystem ) : Long = 
 hash ( s " $ seed : $ expire : $ { secretKey ( ) } " ) 
 diff - - git a / actor - server / actor - runtime / src / main / scala / im / actor / concurrent / ThreadLocalSHA256 . scala b / actor - server / actor - runtime / src / main / scala / im / actor / concurrent / ThreadLocalSHA256 . scala 
 new file mode 100644 
 index 0000000 . . fca0ab6 
 - - - / dev / null 
 + + + b / actor - server / actor - runtime / src / main / scala / im / actor / concurrent / ThreadLocalSHA256 . scala 
 @ @ - 0 , 0 + 1 , 12 @ @ 
 + package im . actor . concurrent 
 + 
 + import java . security . MessageDigest 
 + 
 + object ThreadLocalSHA256 { 
 + private val local : ThreadLocal [ MessageDigest ] = new ThreadLocal [ MessageDigest ] ( ) { 
 + override protected def initialValue ( ) : MessageDigest = 
 + MessageDigest . getInstance ( " SHA - 256 " ) 
 + } 
 + 
 + def current ( ) : MessageDigest = local . get ( ) 
 + } 
 \ No newline at end of file

NEAREST DIFF:
diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / acl / ACLUtils . scala b / actor - server / actor - core / src / main / scala / im / actor / server / acl / ACLUtils . scala 
 index 521c208 . . 7bcad1e 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / acl / ACLUtils . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / acl / ACLUtils . scala 
 @ @ - 1 , 6 + 1 , 6 @ @ 
 package im . actor . server . acl 
 
 - import java . security . SecureRandom 
 + import java . security . { MessageDigest , SecureRandom } 
 import javax . crypto . SecretKeyFactory 
 import javax . crypto . spec . PBEKeySpec 
 
 @ @ - 27 , 8 + 27 , 8 @ @ object ACLUtils extends ACLBase with ACLFiles { 
 type Hash = Array [ Byte ] 
 type Salt = Array [ Byte ] 
 
 - def userAccessHash ( authId : Long , userId : Int , accessSalt : String ) ( implicit s : ActorSystem ) : Long = 
 - hash ( s " $ authId : $ userId : $ accessSalt : $ { secretKey ( ) } " ) 
 + def userAccessHash ( authId : Long , userId : Int , accessSalt : String , md : MessageDigest = getMDInstance ( ) ) ( implicit s : ActorSystem ) : Long = 
 + hash ( s " $ authId : $ userId : $ accessSalt : $ { secretKey ( ) } " , md ) 
 
 def userAccessHash ( authId : Long , u : model . User ) ( implicit s : ActorSystem ) : Long = 
 userAccessHash ( authId , u . id , u . accessSalt ) 
 diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / user / UserProcessor . scala b / actor - server / actor - core / src / main / scala / im / actor / server / user / UserProcessor . scala 
 index 5f5b126 . . 5662128 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / user / UserProcessor . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / user / UserProcessor . scala 
 @ @ - 6 , 6 + 6 , 7 @ @ import akka . persistence . RecoveryCompleted 
 import akka . util . Timeout 
 import im . actor . api . rpc . misc . ApiExtension 
 import im . actor . serialization . ActorSerializer 
 + import im . actor . server . acl . ACLUtils 
 import im . actor . server . db . DbExtension 
 import im . actor . server . dialog . { DialogCommand , DialogExtension } 
 import im . actor . server . event . TSEvent 
 @ @ - 147 , 6 + 148 , 9 @ @ private [ user ] final class UserProcessor 
 protected implicit val seqUpdatesExt : SeqUpdatesExtension = SeqUpdatesExtension ( system ) 
 protected implicit val socialRegion : SocialManagerRegion = SocialExtension ( system ) . region 
 
 + / / For GetApiStruct 
 + protected val aclMD = ACLUtils . getMDInstance ( ) 
 + 
 protected implicit val timeout : Timeout = Timeout ( 10 . seconds ) 
 
 protected val userId = self . path . name . toInt 
 diff - - git a / actor - server / actor - core / src / main / scala / im / actor / server / user / UserQueriesHandlers . scala b / actor - server / actor - core / src / main / scala / im / actor / server / user / UserQueriesHandlers . scala 
 index ee22c4e . . 20b6df3 100644 
 - - - a / actor - server / actor - core / src / main / scala / im / actor / server / user / UserQueriesHandlers . scala 
 + + + b / actor - server / actor - core / src / main / scala / im / actor / server / user / UserQueriesHandlers . scala 
 @ @ - 24 , 7 + 24 , 7 @ @ private [ user ] trait UserQueriesHandlers { 
 userExt . getLocalName ( clientUserId , state . id ) 
 } yield GetApiStructResponse ( ApiUser ( 
 id = userId , 
 - accessHash = ACLUtils . userAccessHash ( clientAuthId , userId , state . accessSalt ) , 
 + accessHash = ACLUtils . userAccessHash ( clientAuthId , userId , state . accessSalt , aclMD ) , 
 name = state . name , 
 localName = UserUtils . normalizeLocalName ( localName ) , 
 sex = Some ( state . sex ) , 
 diff - - git a / actor - server / actor - rpc - api / src / main / scala / im / actor / api / rpc / PeerHelpers . scala b / actor - server / actor - rpc - api / src / main / scala / im / actor / api / rpc / PeerHelpers . scala 
 index 6ffd726 . . bf8a60a 100644 
 - - - a / actor - server / actor - rpc - api / src / main / scala / im / actor / api / rpc / PeerHelpers . scala 
 + + + b / actor - server / actor - rpc - api / src / main / scala / im / actor / api / rpc / PeerHelpers . scala 
 @ @ - 2 , 6 + 2 , 7 @ @ package im . actor . api . rpc 
 
 import im . actor . server . acl . ACLUtils 
 import im . actor . server . db . DbExtension 
 + import im . actor . server . user . UserExtension 
 
 import scala . collection . immutable 
 import scala . concurrent . { Future , ExecutionContext } 
 @ @ - 30 , 13 + 31 , 9 @ @ object PeerHelpers { 
 ) ( implicit client : AuthorizedClientData , actorSystem : ActorSystem , ec : ExecutionContext ) : DBIO [ RpcError \ / R ] = { 
 outPeer . ` type ` match { 
 case ApiPeerType . Private ⇒ 
 - ( for { 
 - optUser ← persist . UserRepo . find ( outPeer . id ) 
 - usererrOrUser ← validUser ( optUser ) 
 - hasherrOrUser ← DBIO . successful ( usererrOrUser . map ( validUserAccessHash ( outPeer . accessHash , _ ) ) ) 
 - } yield hasherrOrUser ) . flatMap { 
 - case Error ( err ) ⇒ DBIO . successful ( Error ( err ) ) 
 - case _ ⇒ f 
 + DBIO . from ( ACLUtils . checkOutPeer ( outPeer , client . authId ) ) flatMap { 
 + case false ⇒ DBIO . successful ( Error ( CommonErrors . InvalidAccessHash ) ) 
 + case true ⇒ f 
 } 
 case ApiPeerType . Group ⇒ 
 ( for { 
 @ @ - 198 , 14 + 195 , 6 @ @ object PeerHelpers { 
 } 
 } 
 
 - private def validUser ( optUser : Option [ model . User ] ) = { 
 - optUser match { 
 - case Some ( user ) ⇒ 
 - DBIO . successful ( \ / - ( user ) ) 
 - case None ⇒ DBIO . successful ( Error ( CommonErrors . UserNotFound ) ) 
 - } 
 - } 
 - 
 def validateGroupAccess ( optGroup : Option [ model . Group ] , userId : Int ) ( implicit ec : ExecutionContext ) = optGroup match { 
 case Some ( group ) ⇒ 
 ( for ( user ← persist . GroupUserRepo . find ( group . id , userId ) ) yield user ) . flatMap { 
 diff - - git a / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLBase . scala b / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLBase . scala 
 index 51924b1 . . d23b981 100644 
 - - - a / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLBase . scala 
 + + + b / actor - server / actor - runtime / src / main / scala / im / actor / acl / ACLBase . scala 
 @ @ - 9 , 11 + 9 , 13 @ @ import scala . concurrent . forkjoin . ThreadLocalRandom 
 
 trait ACLBase { 
 
 + def getMDInstance ( ) = MessageDigest . getInstance ( " MD5 " ) 
 + 
 def secretKey ( ) ( implicit s : ActorSystem ) = 
 s . settings . config . getString ( " secret " ) 
 
 - def hash ( s : String ) : Long = 
 - ByteBuffer . wrap ( MessageDigest . getInstance ( " MD5 " ) . digest ( s . getBytes ) ) . getLong 
 + def hash ( s : String , md : MessageDigest = getMDInstance ( ) ) : Long = 
 + ByteBuffer . wrap ( md . digest ( s . getBytes ) ) . getLong 
 
 def randomLong ( ) : Long = randomLong ( ThreadLocalRandom . current ( ) )
