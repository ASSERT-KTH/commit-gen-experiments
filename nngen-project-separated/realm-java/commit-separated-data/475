BLEU SCORE: 0.02383853510228548

TEST MSG: Don ' t hold ref to query in Collection
GENERATED MSG: Results . sort ( )

TEST DIFF (one line): diff - - git a / realm / realm - library / src / androidTest / java / io / realm / internal / CollectionTests . java b / realm / realm - library / src / androidTest / java / io / realm / internal / CollectionTests . java <nl> index 6be3080 . . 316019c 100644 <nl> - - - a / realm / realm - library / src / androidTest / java / io / realm / internal / CollectionTests . java <nl> + + + b / realm / realm - library / src / androidTest / java / io / realm / internal / CollectionTests . java <nl> @ @ - 170 , 18 + 170 , 18 @ @ public class CollectionTests { <nl> <nl> @ Test <nl> public void sort ( ) { <nl> - Collection collection = new Collection ( sharedRealm , table . where ( ) ) ; <nl> + Collection collection = new Collection ( sharedRealm , table . where ( ) . greaterThan ( new long [ ] { 2 } , 1 ) ) ; <nl> SortDescriptor sortDescriptor = new SortDescriptor ( table , new long [ ] { 2 } ) ; <nl> <nl> Collection collection2 = collection . sort ( sortDescriptor ) ; <nl> <nl> / / A new native Results should be created . <nl> assertTrue ( collection . getNativePtr ( ) ! = collection2 . getNativePtr ( ) ) ; <nl> - assertEquals ( 4 , collection . size ( ) ) ; <nl> - assertEquals ( 4 , collection2 . size ( ) ) ; <nl> + assertEquals ( 2 , collection . size ( ) ) ; <nl> + assertEquals ( 2 , collection2 . size ( ) ) ; <nl> <nl> - assertEquals ( collection2 . getUncheckedRow ( 0 ) . getLong ( 2 ) , 1 ) ; <nl> - assertEquals ( collection2 . getUncheckedRow ( 3 ) . getLong ( 2 ) , 4 ) ; <nl> + assertEquals ( collection2 . getUncheckedRow ( 0 ) . getLong ( 2 ) , 3 ) ; <nl> + assertEquals ( collection2 . getUncheckedRow ( 1 ) . getLong ( 2 ) , 4 ) ; <nl> } <nl> <nl> @ Test <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / internal / Collection . java b / realm / realm - library / src / main / java / io / realm / internal / Collection . java <nl> index c91eff3 . . dc253da 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / internal / Collection . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / internal / Collection . java <nl> @ @ - 41 , 7 + 41 , 7 @ @ public final class Collection implements NativeObject { <nl> private static final long nativeFinalizerPtr = nativeGetFinalizerPtr ( ) ; <nl> private final SharedRealm sharedRealm ; <nl> private final Context context ; <nl> - private final TableQuery query ; <nl> + private final Table table ; <nl> private final ObserverPairList < CollectionObserverPair > observerPairs = <nl> new ObserverPairList < CollectionObserverPair > ( ) ; <nl> private static final ObserverPairList . Callback < CollectionObserverPair > onChangeCallback = <nl> @ @ - 90 , 7 + 90 , 7 @ @ public final class Collection implements NativeObject { <nl> <nl> this . sharedRealm = sharedRealm ; <nl> this . context = sharedRealm . context ; <nl> - this . query = query ; <nl> + this . table = query . getTable ( ) ; <nl> this . context . addReference ( this ) ; <nl> sharedRealm . addCollection ( this ) ; <nl> } <nl> @ @ - 103 , 11 + 103 , 10 @ @ public final class Collection implements NativeObject { <nl> this ( sharedRealm , query , null , null ) ; <nl> } <nl> <nl> - private Collection ( SharedRealm sharedRealm , TableQuery query , long nativePtr ) { <nl> - query . validateQuery ( ) ; <nl> + private Collection ( SharedRealm sharedRealm , Table table , long nativePtr ) { <nl> this . sharedRealm = sharedRealm ; <nl> this . context = sharedRealm . context ; <nl> - this . query = query ; <nl> + this . table = table ; <nl> this . nativePtr = nativePtr ; <nl> <nl> this . context . addReference ( this ) ; <nl> @ @ - 125 , 24 + 124 , 24 @ @ public final class Collection implements NativeObject { <nl> } <nl> <nl> public UncheckedRow getUncheckedRow ( int index ) { <nl> - return UncheckedRow . getByRowPointer ( query . table , nativeGetRow ( nativePtr , index ) ) ; <nl> + return UncheckedRow . getByRowPointer ( table , nativeGetRow ( nativePtr , index ) ) ; <nl> } <nl> <nl> public UncheckedRow firstUncheckedRow ( ) { <nl> - return UncheckedRow . getByRowPointer ( query . table , nativeFirstRow ( nativePtr ) ) ; <nl> + return UncheckedRow . getByRowPointer ( table , nativeFirstRow ( nativePtr ) ) ; <nl> } <nl> <nl> public UncheckedRow lastUncheckedRow ( ) { <nl> - return UncheckedRow . getByRowPointer ( query . table , nativeLastRow ( nativePtr ) ) ; <nl> + return UncheckedRow . getByRowPointer ( table , nativeLastRow ( nativePtr ) ) ; <nl> } <nl> <nl> public Table getTable ( ) { <nl> - return query . getTable ( ) ; <nl> + return table ; <nl> } <nl> <nl> public TableQuery where ( ) { <nl> long nativeQueryPtr = nativeWhere ( nativePtr ) ; <nl> - return new TableQuery ( this . context , this . getTable ( ) , nativeQueryPtr ) ; <nl> + return new TableQuery ( this . context , this . table , nativeQueryPtr ) ; <nl> } <nl> <nl> public Number aggregateNumber ( Aggregate aggregateMethod , long columnIndex ) { <nl> @ @ - 162 , 7 + 161 , 7 @ @ public final class Collection implements NativeObject { <nl> } <nl> <nl> public Collection sort ( SortDescriptor sortDescriptor ) { <nl> - return new Collection ( sharedRealm , query , nativeSort ( nativePtr , sortDescriptor ) ) ; <nl> + return new Collection ( sharedRealm , table , nativeSort ( nativePtr , sortDescriptor ) ) ; <nl> } <nl> <nl> public boolean contains ( UncheckedRow row ) {
NEAREST DIFF (one line): diff - - git a / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp b / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp <nl> index 99bfcfe . . fb08422 100644 <nl> - - - a / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp <nl> + + + b / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp <nl> @ @ - 52 , 9 + 52 , 9 @ @ Java _ io _ realm _ internal _ Collection _ nativeCreateResults ( JNIEnv * env , jclass , jlong <nl> try { <nl> auto shared _ realm = * ( reinterpret _ cast < SharedRealm * > ( shared _ realm _ ptr ) ) ; <nl> auto query = reinterpret _ cast < Query * > ( query _ ptr ) ; <nl> - Results * results = sort _ desc _ native _ ptr ? <nl> - new Results ( shared _ realm , * query , * reinterpret _ cast < SortDescriptor * > ( sort _ desc _ native _ ptr ) ) : <nl> - new Results ( shared _ realm , * query , { } ) ; <nl> + auto results = sort _ desc _ native _ ptr ? <nl> + new Results ( shared _ realm , * query , * reinterpret _ cast < SortDescriptor * > ( sort _ desc _ native _ ptr ) ) : <nl> + new Results ( shared _ realm , * query , { } ) ; <nl> <nl> return reinterpret _ cast < jlong > ( results ) ; <nl> } CATCH _ STD ( ) <nl> @ @ - 167 , 28 + 167 , 12 @ @ Java _ io _ realm _ internal _ Collection _ nativeAggregate ( JNIEnv * env , jclass , jlong nat <nl> } <nl> <nl> JNIEXPORT jlong JNICALL <nl> - Java _ io _ realm _ internal _ Collection _ nativeSort ( JNIEnv * env , jclass , jlong native _ ptr , jlongArray colunm _ indices , <nl> - jbooleanArray jsort _ orders ) <nl> + Java _ io _ realm _ internal _ Collection _ nativeSort ( JNIEnv * env , jclass , jlong native _ ptr , jlong sort _ desc _ native _ ptr ) <nl> { <nl> TR _ ENTER _ PTR ( native _ ptr ) <nl> try { <nl> auto results = reinterpret _ cast < Results * > ( native _ ptr ) ; <nl> - <nl> - JniBooleanArray order ( env , jsort _ orders ) ; <nl> - JniLongArray indices ( env , colunm _ indices ) ; <nl> - <nl> - if ( order . len ( ) ! = indices . len ( ) ) { <nl> - throw std : : invalid _ argument ( " Number of columns and sorting orders do not match . " ) ; <nl> - } <nl> - <nl> - std : : vector < bool > sort _ orders ; <nl> - std : : vector < std : : vector < size _ t > > sort _ indices ; <nl> - for ( jsize i = 0 ; i < order . len ( ) ; + + i ) { <nl> - sort _ orders . push _ back ( to _ bool ( order [ i ] ) ) ; <nl> - sort _ indices . push _ back ( std : : vector < size _ t > { S ( indices [ i ] ) } ) ; <nl> - } <nl> - <nl> - SortDescriptor sort _ descriptor ( * ( results - > get _ query ( ) . get _ table ( ) . get ( ) ) , sort _ indices , sort _ orders ) ; <nl> + auto sort _ descriptor = * reinterpret _ cast < SortDescriptor * > ( sort _ desc _ native _ ptr ) ; <nl> auto sorted _ result = results - > sort ( std : : move ( sort _ descriptor ) ) ; <nl> return reinterpret _ cast < jlong > ( new Results ( std : : move ( sorted _ result ) ) ) ; <nl> } CATCH _ STD ( ) <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / RealmResults . java b / realm / realm - library / src / main / java / io / realm / RealmResults . java <nl> index 5acdb45 . . 766e7a7 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / RealmResults . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / RealmResults . java <nl> @ @ - 31 , 6 + 31 , 7 @ @ import java . util . NoSuchElementException ; <nl> import java . util . concurrent . CopyOnWriteArrayList ; <nl> import java . util . concurrent . Future ; <nl> <nl> + import io . realm . internal . SortDescriptor ; <nl> import io . realm . internal . Table ; <nl> import io . realm . internal . TableOrView ; <nl> import io . realm . internal . TableQuery ; <nl> @ @ - 429 , 15 + 430 , 18 @ @ public final class RealmResults < E extends RealmModel > extends AbstractList < E > im <nl> * / <nl> @ Override <nl> public RealmResults < E > sort ( String fieldName ) { <nl> - / * <nl> - if ( nativePtr = = 0 ) { <nl> - return this . sort ( fieldName , Sort . ASCENDING ) ; <nl> - } else { <nl> - long ptr = nativeSort ( nativePtr , new long [ ] { getColumnIndexForSort ( fieldName ) } , new boolean [ ] { Sort . ASCENDING . getValue ( ) } ) ; <nl> - return new RealmResults < E > ( realm , className , ptr ) ; <nl> + SortDescriptor sortDescriptor = <nl> + SortDescriptor . getInstanceForSort ( collection . getTable ( ) , fieldName , Sort . ASCENDING ) ; <nl> + try { <nl> + Collection sortedCollection = collection . sort ( sortDescriptor ) ; <nl> + if ( className ! = null ) { <nl> + return new RealmResults < E > ( realm , sortedCollection , className ) ; <nl> + } else { <nl> + return new RealmResults < E > ( realm , sortedCollection , classSpec ) ; <nl> + } <nl> + } finally { <nl> + sortDescriptor . close ( ) ; <nl> } <nl> - * / <nl> - return null ; <nl> } <nl> <nl> / * * <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / internal / Collection . java b / realm / realm - library / src / main / java / io / realm / internal / Collection . java <nl> index 7b4e838 . . d0cdd46 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / internal / Collection . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / internal / Collection . java <nl> @ @ - 75 , 6 + 75 , 7 @ @ public class Collection implements NativeObject { <nl> <nl> private final long nativePtr ; <nl> private static final long nativeFinalizerPtr = nativeGetFinalizerPtr ( ) ; <nl> + private final SharedRealm sharedRealm ; <nl> private final Context context ; <nl> private final TableQuery query ; <nl> private final List < Listener > listeners = new CopyOnWriteArrayList < Listener > ( ) ; <nl> @ @ - 104 , 6 + 105 , 7 @ @ public class Collection implements NativeObject { <nl> } <nl> <nl> public Collection ( SharedRealm sharedRealm , TableQuery query , SortDescriptor sortDescriptor ) { <nl> + this . sharedRealm = sharedRealm ; <nl> this . context = sharedRealm . context ; <nl> this . query = query ; <nl> <nl> @ @ - 116 , 6 + 118 , 15 @ @ public class Collection implements NativeObject { <nl> this . context . addReference ( this ) ; <nl> } <nl> <nl> + public Collection ( SharedRealm sharedRealm , TableQuery query , long nativePtr ) { <nl> + this . sharedRealm = sharedRealm ; <nl> + this . context = sharedRealm . context ; <nl> + this . query = query ; <nl> + this . nativePtr = nativePtr ; <nl> + <nl> + this . context . addReference ( this ) ; <nl> + } <nl> + <nl> @ Override <nl> public long getNativePtr ( ) { <nl> return nativePtr ; <nl> @ @ - 130 , 6 + 141 , 10 @ @ public class Collection implements NativeObject { <nl> return UncheckedRow . getByRowPointer ( query . table , nativeGetRow ( nativePtr , index ) ) ; <nl> } <nl> <nl> + public Table getTable ( ) { <nl> + return query . getTable ( ) ; <nl> + } <nl> + <nl> public Object aggregate ( Aggregate aggregateMethod , long columnIndex ) { <nl> return nativeAggregate ( nativePtr , columnIndex , aggregateMethod . getValue ( ) ) ; <nl> } <nl> @ @ - 143 , 6 + 158 , 10 @ @ public class Collection implements NativeObject { <nl> nativeClear ( nativePtr ) ; <nl> } <nl> <nl> + public Collection sort ( SortDescriptor sortDescriptor ) { <nl> + return new Collection ( sharedRealm , query , nativeSort ( nativePtr , sortDescriptor . getNativePtr ( ) ) ) ; <nl> + } <nl> + <nl> public void addListener ( Listener listener ) { <nl> if ( ! listeners . contains ( listener ) ) { <nl> listeners . add ( listener ) ; <nl> @ @ - 193 , 7 + 212 , 7 @ @ public class Collection implements NativeObject { <nl> private static native void nativeClear ( long nativePtr ) ; <nl> private static native long nativeSize ( long nativePtr ) ; <nl> private static native Object nativeAggregate ( long nativePtr , long columnIndex , byte aggregateFunc ) ; <nl> - private static native long nativeSort ( long nativePtr , long [ ] columnIndices , boolean [ ] orders ) ; <nl> + private static native long nativeSort ( long nativePtr , long sortDescNativePtr ) ; <nl> private native long nativeAddListener ( long nativePtr ) ; <nl> private static native long nativeNotificationTokenGetFinalizerPtr ( ) ; <nl> private static native long nativeNotificationTokenClose ( long nativePtr ) ;

TEST DIFF:
diff - - git a / realm / realm - library / src / androidTest / java / io / realm / internal / CollectionTests . java b / realm / realm - library / src / androidTest / java / io / realm / internal / CollectionTests . java 
 index 6be3080 . . 316019c 100644 
 - - - a / realm / realm - library / src / androidTest / java / io / realm / internal / CollectionTests . java 
 + + + b / realm / realm - library / src / androidTest / java / io / realm / internal / CollectionTests . java 
 @ @ - 170 , 18 + 170 , 18 @ @ public class CollectionTests { 
 
 @ Test 
 public void sort ( ) { 
 - Collection collection = new Collection ( sharedRealm , table . where ( ) ) ; 
 + Collection collection = new Collection ( sharedRealm , table . where ( ) . greaterThan ( new long [ ] { 2 } , 1 ) ) ; 
 SortDescriptor sortDescriptor = new SortDescriptor ( table , new long [ ] { 2 } ) ; 
 
 Collection collection2 = collection . sort ( sortDescriptor ) ; 
 
 / / A new native Results should be created . 
 assertTrue ( collection . getNativePtr ( ) ! = collection2 . getNativePtr ( ) ) ; 
 - assertEquals ( 4 , collection . size ( ) ) ; 
 - assertEquals ( 4 , collection2 . size ( ) ) ; 
 + assertEquals ( 2 , collection . size ( ) ) ; 
 + assertEquals ( 2 , collection2 . size ( ) ) ; 
 
 - assertEquals ( collection2 . getUncheckedRow ( 0 ) . getLong ( 2 ) , 1 ) ; 
 - assertEquals ( collection2 . getUncheckedRow ( 3 ) . getLong ( 2 ) , 4 ) ; 
 + assertEquals ( collection2 . getUncheckedRow ( 0 ) . getLong ( 2 ) , 3 ) ; 
 + assertEquals ( collection2 . getUncheckedRow ( 1 ) . getLong ( 2 ) , 4 ) ; 
 } 
 
 @ Test 
 diff - - git a / realm / realm - library / src / main / java / io / realm / internal / Collection . java b / realm / realm - library / src / main / java / io / realm / internal / Collection . java 
 index c91eff3 . . dc253da 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / internal / Collection . java 
 + + + b / realm / realm - library / src / main / java / io / realm / internal / Collection . java 
 @ @ - 41 , 7 + 41 , 7 @ @ public final class Collection implements NativeObject { 
 private static final long nativeFinalizerPtr = nativeGetFinalizerPtr ( ) ; 
 private final SharedRealm sharedRealm ; 
 private final Context context ; 
 - private final TableQuery query ; 
 + private final Table table ; 
 private final ObserverPairList < CollectionObserverPair > observerPairs = 
 new ObserverPairList < CollectionObserverPair > ( ) ; 
 private static final ObserverPairList . Callback < CollectionObserverPair > onChangeCallback = 
 @ @ - 90 , 7 + 90 , 7 @ @ public final class Collection implements NativeObject { 
 
 this . sharedRealm = sharedRealm ; 
 this . context = sharedRealm . context ; 
 - this . query = query ; 
 + this . table = query . getTable ( ) ; 
 this . context . addReference ( this ) ; 
 sharedRealm . addCollection ( this ) ; 
 } 
 @ @ - 103 , 11 + 103 , 10 @ @ public final class Collection implements NativeObject { 
 this ( sharedRealm , query , null , null ) ; 
 } 
 
 - private Collection ( SharedRealm sharedRealm , TableQuery query , long nativePtr ) { 
 - query . validateQuery ( ) ; 
 + private Collection ( SharedRealm sharedRealm , Table table , long nativePtr ) { 
 this . sharedRealm = sharedRealm ; 
 this . context = sharedRealm . context ; 
 - this . query = query ; 
 + this . table = table ; 
 this . nativePtr = nativePtr ; 
 
 this . context . addReference ( this ) ; 
 @ @ - 125 , 24 + 124 , 24 @ @ public final class Collection implements NativeObject { 
 } 
 
 public UncheckedRow getUncheckedRow ( int index ) { 
 - return UncheckedRow . getByRowPointer ( query . table , nativeGetRow ( nativePtr , index ) ) ; 
 + return UncheckedRow . getByRowPointer ( table , nativeGetRow ( nativePtr , index ) ) ; 
 } 
 
 public UncheckedRow firstUncheckedRow ( ) { 
 - return UncheckedRow . getByRowPointer ( query . table , nativeFirstRow ( nativePtr ) ) ; 
 + return UncheckedRow . getByRowPointer ( table , nativeFirstRow ( nativePtr ) ) ; 
 } 
 
 public UncheckedRow lastUncheckedRow ( ) { 
 - return UncheckedRow . getByRowPointer ( query . table , nativeLastRow ( nativePtr ) ) ; 
 + return UncheckedRow . getByRowPointer ( table , nativeLastRow ( nativePtr ) ) ; 
 } 
 
 public Table getTable ( ) { 
 - return query . getTable ( ) ; 
 + return table ; 
 } 
 
 public TableQuery where ( ) { 
 long nativeQueryPtr = nativeWhere ( nativePtr ) ; 
 - return new TableQuery ( this . context , this . getTable ( ) , nativeQueryPtr ) ; 
 + return new TableQuery ( this . context , this . table , nativeQueryPtr ) ; 
 } 
 
 public Number aggregateNumber ( Aggregate aggregateMethod , long columnIndex ) { 
 @ @ - 162 , 7 + 161 , 7 @ @ public final class Collection implements NativeObject { 
 } 
 
 public Collection sort ( SortDescriptor sortDescriptor ) { 
 - return new Collection ( sharedRealm , query , nativeSort ( nativePtr , sortDescriptor ) ) ; 
 + return new Collection ( sharedRealm , table , nativeSort ( nativePtr , sortDescriptor ) ) ; 
 } 
 
 public boolean contains ( UncheckedRow row ) {

NEAREST DIFF:
diff - - git a / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp b / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp 
 index 99bfcfe . . fb08422 100644 
 - - - a / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp 
 + + + b / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp 
 @ @ - 52 , 9 + 52 , 9 @ @ Java _ io _ realm _ internal _ Collection _ nativeCreateResults ( JNIEnv * env , jclass , jlong 
 try { 
 auto shared _ realm = * ( reinterpret _ cast < SharedRealm * > ( shared _ realm _ ptr ) ) ; 
 auto query = reinterpret _ cast < Query * > ( query _ ptr ) ; 
 - Results * results = sort _ desc _ native _ ptr ? 
 - new Results ( shared _ realm , * query , * reinterpret _ cast < SortDescriptor * > ( sort _ desc _ native _ ptr ) ) : 
 - new Results ( shared _ realm , * query , { } ) ; 
 + auto results = sort _ desc _ native _ ptr ? 
 + new Results ( shared _ realm , * query , * reinterpret _ cast < SortDescriptor * > ( sort _ desc _ native _ ptr ) ) : 
 + new Results ( shared _ realm , * query , { } ) ; 
 
 return reinterpret _ cast < jlong > ( results ) ; 
 } CATCH _ STD ( ) 
 @ @ - 167 , 28 + 167 , 12 @ @ Java _ io _ realm _ internal _ Collection _ nativeAggregate ( JNIEnv * env , jclass , jlong nat 
 } 
 
 JNIEXPORT jlong JNICALL 
 - Java _ io _ realm _ internal _ Collection _ nativeSort ( JNIEnv * env , jclass , jlong native _ ptr , jlongArray colunm _ indices , 
 - jbooleanArray jsort _ orders ) 
 + Java _ io _ realm _ internal _ Collection _ nativeSort ( JNIEnv * env , jclass , jlong native _ ptr , jlong sort _ desc _ native _ ptr ) 
 { 
 TR _ ENTER _ PTR ( native _ ptr ) 
 try { 
 auto results = reinterpret _ cast < Results * > ( native _ ptr ) ; 
 - 
 - JniBooleanArray order ( env , jsort _ orders ) ; 
 - JniLongArray indices ( env , colunm _ indices ) ; 
 - 
 - if ( order . len ( ) ! = indices . len ( ) ) { 
 - throw std : : invalid _ argument ( " Number of columns and sorting orders do not match . " ) ; 
 - } 
 - 
 - std : : vector < bool > sort _ orders ; 
 - std : : vector < std : : vector < size _ t > > sort _ indices ; 
 - for ( jsize i = 0 ; i < order . len ( ) ; + + i ) { 
 - sort _ orders . push _ back ( to _ bool ( order [ i ] ) ) ; 
 - sort _ indices . push _ back ( std : : vector < size _ t > { S ( indices [ i ] ) } ) ; 
 - } 
 - 
 - SortDescriptor sort _ descriptor ( * ( results - > get _ query ( ) . get _ table ( ) . get ( ) ) , sort _ indices , sort _ orders ) ; 
 + auto sort _ descriptor = * reinterpret _ cast < SortDescriptor * > ( sort _ desc _ native _ ptr ) ; 
 auto sorted _ result = results - > sort ( std : : move ( sort _ descriptor ) ) ; 
 return reinterpret _ cast < jlong > ( new Results ( std : : move ( sorted _ result ) ) ) ; 
 } CATCH _ STD ( ) 
 diff - - git a / realm / realm - library / src / main / java / io / realm / RealmResults . java b / realm / realm - library / src / main / java / io / realm / RealmResults . java 
 index 5acdb45 . . 766e7a7 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / RealmResults . java 
 + + + b / realm / realm - library / src / main / java / io / realm / RealmResults . java 
 @ @ - 31 , 6 + 31 , 7 @ @ import java . util . NoSuchElementException ; 
 import java . util . concurrent . CopyOnWriteArrayList ; 
 import java . util . concurrent . Future ; 
 
 + import io . realm . internal . SortDescriptor ; 
 import io . realm . internal . Table ; 
 import io . realm . internal . TableOrView ; 
 import io . realm . internal . TableQuery ; 
 @ @ - 429 , 15 + 430 , 18 @ @ public final class RealmResults < E extends RealmModel > extends AbstractList < E > im 
 * / 
 @ Override 
 public RealmResults < E > sort ( String fieldName ) { 
 - / * 
 - if ( nativePtr = = 0 ) { 
 - return this . sort ( fieldName , Sort . ASCENDING ) ; 
 - } else { 
 - long ptr = nativeSort ( nativePtr , new long [ ] { getColumnIndexForSort ( fieldName ) } , new boolean [ ] { Sort . ASCENDING . getValue ( ) } ) ; 
 - return new RealmResults < E > ( realm , className , ptr ) ; 
 + SortDescriptor sortDescriptor = 
 + SortDescriptor . getInstanceForSort ( collection . getTable ( ) , fieldName , Sort . ASCENDING ) ; 
 + try { 
 + Collection sortedCollection = collection . sort ( sortDescriptor ) ; 
 + if ( className ! = null ) { 
 + return new RealmResults < E > ( realm , sortedCollection , className ) ; 
 + } else { 
 + return new RealmResults < E > ( realm , sortedCollection , classSpec ) ; 
 + } 
 + } finally { 
 + sortDescriptor . close ( ) ; 
 } 
 - * / 
 - return null ; 
 } 
 
 / * * 
 diff - - git a / realm / realm - library / src / main / java / io / realm / internal / Collection . java b / realm / realm - library / src / main / java / io / realm / internal / Collection . java 
 index 7b4e838 . . d0cdd46 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / internal / Collection . java 
 + + + b / realm / realm - library / src / main / java / io / realm / internal / Collection . java 
 @ @ - 75 , 6 + 75 , 7 @ @ public class Collection implements NativeObject { 
 
 private final long nativePtr ; 
 private static final long nativeFinalizerPtr = nativeGetFinalizerPtr ( ) ; 
 + private final SharedRealm sharedRealm ; 
 private final Context context ; 
 private final TableQuery query ; 
 private final List < Listener > listeners = new CopyOnWriteArrayList < Listener > ( ) ; 
 @ @ - 104 , 6 + 105 , 7 @ @ public class Collection implements NativeObject { 
 } 
 
 public Collection ( SharedRealm sharedRealm , TableQuery query , SortDescriptor sortDescriptor ) { 
 + this . sharedRealm = sharedRealm ; 
 this . context = sharedRealm . context ; 
 this . query = query ; 
 
 @ @ - 116 , 6 + 118 , 15 @ @ public class Collection implements NativeObject { 
 this . context . addReference ( this ) ; 
 } 
 
 + public Collection ( SharedRealm sharedRealm , TableQuery query , long nativePtr ) { 
 + this . sharedRealm = sharedRealm ; 
 + this . context = sharedRealm . context ; 
 + this . query = query ; 
 + this . nativePtr = nativePtr ; 
 + 
 + this . context . addReference ( this ) ; 
 + } 
 + 
 @ Override 
 public long getNativePtr ( ) { 
 return nativePtr ; 
 @ @ - 130 , 6 + 141 , 10 @ @ public class Collection implements NativeObject { 
 return UncheckedRow . getByRowPointer ( query . table , nativeGetRow ( nativePtr , index ) ) ; 
 } 
 
 + public Table getTable ( ) { 
 + return query . getTable ( ) ; 
 + } 
 + 
 public Object aggregate ( Aggregate aggregateMethod , long columnIndex ) { 
 return nativeAggregate ( nativePtr , columnIndex , aggregateMethod . getValue ( ) ) ; 
 } 
 @ @ - 143 , 6 + 158 , 10 @ @ public class Collection implements NativeObject { 
 nativeClear ( nativePtr ) ; 
 } 
 
 + public Collection sort ( SortDescriptor sortDescriptor ) { 
 + return new Collection ( sharedRealm , query , nativeSort ( nativePtr , sortDescriptor . getNativePtr ( ) ) ) ; 
 + } 
 + 
 public void addListener ( Listener listener ) { 
 if ( ! listeners . contains ( listener ) ) { 
 listeners . add ( listener ) ; 
 @ @ - 193 , 7 + 212 , 7 @ @ public class Collection implements NativeObject { 
 private static native void nativeClear ( long nativePtr ) ; 
 private static native long nativeSize ( long nativePtr ) ; 
 private static native Object nativeAggregate ( long nativePtr , long columnIndex , byte aggregateFunc ) ; 
 - private static native long nativeSort ( long nativePtr , long [ ] columnIndices , boolean [ ] orders ) ; 
 + private static native long nativeSort ( long nativePtr , long sortDescNativePtr ) ; 
 private native long nativeAddListener ( long nativePtr ) ; 
 private static native long nativeNotificationTokenGetFinalizerPtr ( ) ; 
 private static native long nativeNotificationTokenClose ( long nativePtr ) ;
