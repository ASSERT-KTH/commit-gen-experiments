BLEU SCORE: 0.0526833929880447

TEST MSG: Call OS set _ auto _ refresh ( ) & auto _ refresh ( )
GENERATED MSG: use ObjectStore : : set _ schema _ version ( ) to change the schema version instead of Java local logic

TEST DIFF (one line): diff - - git a / realm / realm - library / src / androidTest / java / io / realm / NotificationsTest . java b / realm / realm - library / src / androidTest / java / io / realm / NotificationsTest . java <nl> index 0a89796 . . 653a011 100644 <nl> - - - a / realm / realm - library / src / androidTest / java / io / realm / NotificationsTest . java <nl> + + + b / realm / realm - library / src / androidTest / java / io / realm / NotificationsTest . java <nl> @ @ - 88 , 7 + 88 , 7 @ @ public class NotificationsTest { <nl> } <nl> <nl> @ Test <nl> - public void failingSetAutoRefreshOnNonLooperThread ( ) throws ExecutionException , InterruptedException { <nl> + public void setAutoRefresh _ failsOnNonLooperThread ( ) throws ExecutionException , InterruptedException { <nl> ExecutorService executorService = Executors . newSingleThreadExecutor ( ) ; <nl> Future < Boolean > future = executorService . submit ( new Callable < Boolean > ( ) { <nl> @ Override <nl> diff - - git a / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp b / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp <nl> index 497a52c . . c6cb20b 100644 <nl> - - - a / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp <nl> + + + b / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp <nl> @ @ - 436 , 11 + 436 , 11 @ @ Java _ io _ realm _ internal _ SharedRealm _ nativeCompact ( JNIEnv * env , jclass , jlong shar <nl> } <nl> <nl> JNIEXPORT jlong JNICALL <nl> - Java _ io _ realm _ internal _ SharedRealm _ nativeGetSnapshotVersion ( JNIEnv * env , jclass , jlong sharedRealmPtr ) <nl> + Java _ io _ realm _ internal _ SharedRealm _ nativeGetSnapshotVersion ( JNIEnv * env , jclass , jlong shared _ realm _ ptr ) <nl> { <nl> - TR _ ENTER _ PTR ( sharedRealmPtr ) <nl> + TR _ ENTER _ PTR ( shared _ realm _ ptr ) <nl> <nl> - auto shared _ realm = * ( reinterpret _ cast < SharedRealm * > ( sharedRealmPtr ) ) ; <nl> + auto shared _ realm = * ( reinterpret _ cast < SharedRealm * > ( shared _ realm _ ptr ) ) ; <nl> try { <nl> using rf = realm : : _ impl : : RealmFriend ; <nl> auto & shared _ group = rf : : get _ shared _ group ( * shared _ realm ) ; <nl> @ @ - 450 , 15 + 450 , 34 @ @ Java _ io _ realm _ internal _ SharedRealm _ nativeGetSnapshotVersion ( JNIEnv * env , jclass , <nl> } <nl> <nl> JNIEXPORT void JNICALL <nl> - Java _ io _ realm _ internal _ SharedRealm _ nativeUpdateSchema ( JNIEnv * env , jclass , jlong nativePtr , <nl> - jlong nativeSchemaPtr , jlong version ) { <nl> - TR _ ENTER ( ) <nl> + Java _ io _ realm _ internal _ SharedRealm _ nativeUpdateSchema ( JNIEnv * env , jclass , jlong shared _ realm _ ptr , <nl> + jlong schema _ ptr , jlong version ) { <nl> + TR _ ENTER _ PTR ( shared _ realm _ ptr ) <nl> try { <nl> - auto shared _ realm = * ( reinterpret _ cast < SharedRealm * > ( nativePtr ) ) ; <nl> - auto * schema = reinterpret _ cast < Schema * > ( nativeSchemaPtr ) ; <nl> + auto shared _ realm = * ( reinterpret _ cast < SharedRealm * > ( shared _ realm _ ptr ) ) ; <nl> + auto * schema = reinterpret _ cast < Schema * > ( schema _ ptr ) ; <nl> shared _ realm - > update _ schema ( * schema , static _ cast < uint64 _ t > ( version ) ) ; <nl> - } <nl> - CATCH _ STD ( ) <nl> + } CATCH _ STD ( ) <nl> } <nl> <nl> <nl> + JNIEXPORT void JNICALL <nl> + Java _ io _ realm _ internal _ SharedRealm _ nativeSetAutoRefresh ( JNIEnv * env , jclass , jlong shared _ realm _ ptr , jboolean enabled ) <nl> + { <nl> + TR _ ENTER _ PTR ( shared _ realm _ ptr ) <nl> + try { <nl> + auto shared _ realm = * ( reinterpret _ cast < SharedRealm * > ( shared _ realm _ ptr ) ) ; <nl> + shared _ realm - > set _ auto _ refresh ( enabled ) ; <nl> + } CATCH _ STD ( ) <nl> + } <nl> + <nl> + JNIEXPORT jboolean JNICALL <nl> + Java _ io _ realm _ internal _ SharedRealm _ nativeIsAutoRefresh ( JNIEnv * env , jclass , jlong shared _ realm _ ptr ) <nl> + { <nl> + TR _ ENTER _ PTR ( shared _ realm _ ptr ) <nl> + try { <nl> + auto shared _ realm = * ( reinterpret _ cast < SharedRealm * > ( shared _ realm _ ptr ) ) ; <nl> + return static _ cast < jboolean > ( shared _ realm - > auto _ refresh ( ) ) ; <nl> + } CATCH _ STD ( ) <nl> + return JNI _ FALSE ; <nl> + } <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / BaseRealm . java b / realm / realm - library / src / main / java / io / realm / BaseRealm . java <nl> index 89604e5 . . 420dc91 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / BaseRealm . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / BaseRealm . java <nl> @ @ - 17 , 7 + 17 , 6 @ @ <nl> package io . realm ; <nl> <nl> import android . content . Context ; <nl> - import android . os . Handler ; <nl> import android . os . Looper ; <nl> <nl> import java . io . Closeable ; <nl> @ @ - 89 , 10 + 88 , 6 @ @ abstract class BaseRealm implements Closeable { <nl> } <nl> } ) ; <nl> this . schema = new RealmSchema ( this ) ; <nl> - <nl> - if ( handlerController . isAutoRefreshAvailable ( ) ) { <nl> - setAutoRefresh ( true ) ; <nl> - } <nl> } <nl> <nl> / * * <nl> @ @ - 108 , 8 + 103 , 7 @ @ abstract class BaseRealm implements Closeable { <nl> * / <nl> public void setAutoRefresh ( boolean autoRefresh ) { <nl> checkIfValid ( ) ; <nl> - handlerController . checkCanBeAutoRefreshed ( ) ; <nl> - handlerController . setAutoRefresh ( autoRefresh ) ; <nl> + sharedRealm . setAutoRefresh ( autoRefresh ) ; <nl> } <nl> <nl> / * * <nl> @ @ - 118 , 7 + 112 , 7 @ @ abstract class BaseRealm implements Closeable { <nl> * @ return the auto - refresh status . <nl> * / <nl> public boolean isAutoRefresh ( ) { <nl> - return handlerController . isAutoRefreshEnabled ( ) ; <nl> + return sharedRealm . isAutoRefresh ( ) ; <nl> } <nl> <nl> / * * <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / internal / Capabilities . java b / realm / realm - library / src / main / java / io / realm / internal / Capabilities . java <nl> index 230c17c . . 608538c 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / internal / Capabilities . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / internal / Capabilities . java <nl> @ @ - 18 , 4 + 18 , 5 @ @ package io . realm . internal ; <nl> <nl> public interface Capabilities { <nl> boolean canDeliverNotification ( ) ; <nl> + void checkCanDeliverNotification ( ) ; <nl> } <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java b / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java <nl> index 74110fb . . 5ab76d1 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java <nl> @ @ - 21 , 6 + 21 , 7 @ @ import java . io . File ; <nl> <nl> import io . realm . RealmConfiguration ; <nl> import io . realm . RealmSchema ; <nl> + import io . realm . internal . android . AndroidCapabilities ; <nl> import io . realm . internal . async . BadVersionException ; <nl> <nl> public final class SharedRealm implements Closeable { <nl> @ @ - 33 , 6 + 34 , 8 @ @ public final class SharedRealm implements Closeable { <nl> public static final byte FILE _ EXCEPTION _ KIND _ INCOMPATIBLE _ LOCK _ FILE = 4 ; <nl> public static final byte FILE _ EXCEPTION _ KIND _ FORMAT _ UPGRADE _ REQUIRED = 5 ; <nl> <nl> + public static final Capabilities capabilities = new AndroidCapabilities ( ) ; <nl> + <nl> public static void initialize ( File tempDirectory ) { <nl> if ( SharedRealm . temporaryDirectory ! = null ) { <nl> / / already initialized <nl> @ @ - 178 , 6 + 181 , 7 @ @ public final class SharedRealm implements Closeable { <nl> context = new Context ( ) ; <nl> this . lastSchemaVersion = schemaVersionListener = = null ? - 1L : getSchemaVersion ( ) ; <nl> objectServerFacade = null ; <nl> + nativeSetAutoRefresh ( nativePtr , capabilities . canDeliverNotification ( ) ) ; <nl> } <nl> <nl> public static SharedRealm getInstance ( RealmConfiguration config ) { <nl> @ @ - 332 , 6 + 336 , 15 @ @ public final class SharedRealm implements Closeable { <nl> nativeUpdateSchema ( nativePtr , schema . getNativePtr ( ) , version ) ; <nl> } <nl> <nl> + public void setAutoRefresh ( boolean enabled ) { <nl> + capabilities . checkCanDeliverNotification ( ) ; <nl> + nativeSetAutoRefresh ( nativePtr , enabled ) ; <nl> + } <nl> + <nl> + public boolean isAutoRefresh ( ) { <nl> + return nativeIsAutoRefresh ( nativePtr ) ; <nl> + } <nl> + <nl> @ Override <nl> public void close ( ) { <nl> if ( realmNotifier ! = null ) { <nl> @ @ - 405 , 4 + 418 , 6 @ @ public final class SharedRealm implements Closeable { <nl> private static native void nativeStopWaitForChange ( long nativeSharedRealmPtr ) ; <nl> private static native boolean nativeCompact ( long nativeSharedRealmPtr ) ; <nl> private static native void nativeUpdateSchema ( long nativePtr , long nativeSchemaPtr , long version ) ; <nl> + private static native void nativeSetAutoRefresh ( long nativePtr , boolean enabled ) ; <nl> + private static native boolean nativeIsAutoRefresh ( long nativePtr ) ; <nl> } <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / internal / android / AndroidCapabilities . java b / realm / realm - library / src / main / java / io / realm / internal / android / AndroidCapabilities . java <nl> index d043867 . . 4aeb51a 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / internal / android / AndroidCapabilities . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / internal / android / AndroidCapabilities . java <nl> @ @ - 26 , 6 + 26 , 16 @ @ public class AndroidCapabilities implements Capabilities { <nl> return ( Looper . myLooper ( ) ! = null & & ! isIntentServiceThread ( ) ) ; <nl> } <nl> <nl> + @ Override <nl> + public void checkCanDeliverNotification ( ) { <nl> + if ( Looper . myLooper ( ) = = null ) { <nl> + throw new IllegalStateException ( " Cannot set auto - refresh in a Thread without a Looper " ) ; <nl> + } <nl> + if ( isIntentServiceThread ( ) ) { <nl> + throw new IllegalStateException ( " Cannot set auto - refresh in an IntentService thread . " ) ; <nl> + } <nl> + } <nl> + <nl> private static boolean isIntentServiceThread ( ) { <nl> / / Tries to determine if a thread is an IntentService thread . No public API can detect this , <nl> / / so use the thread name as a heuristic :
NEAREST DIFF (one line): diff - - git a / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp b / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp <nl> index 6a75375 . . 90d9b6b 100644 <nl> - - - a / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp <nl> + + + b / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp <nl> @ @ - 148 , 6 + 148 , 24 @ @ Java _ io _ realm _ internal _ SharedRealm _ nativeGetVersion ( JNIEnv * env , jclass , jlong s <nl> return - 1 ; <nl> } <nl> <nl> + JNIEXPORT void JNICALL <nl> + Java _ io _ realm _ internal _ SharedRealm _ nativeSetVersion ( JNIEnv * env , jclass , jlong shared _ realm _ ptr , jlong version ) <nl> + { <nl> + TR _ ENTER _ PTR ( env , shared _ realm _ ptr ) <nl> + <nl> + auto shared _ realm = * ( reinterpret _ cast < SharedRealm * > ( shared _ realm _ ptr ) ) ; <nl> + try { <nl> + if ( ! shared _ realm - > is _ in _ transaction ( ) ) { <nl> + std : : ostringstream ss ; <nl> + ss < < " Cannot set schema version when the realm is not in transaction . " ; <nl> + ThrowException ( env , IllegalState , ss . str ( ) ) ; <nl> + return ; <nl> + } <nl> + <nl> + ObjectStore : : set _ schema _ version ( shared _ realm - > read _ group ( ) , static _ cast < uint64 _ t > ( version ) ) ; <nl> + } CATCH _ STD ( ) <nl> + } <nl> + <nl> JNIEXPORT jboolean JNICALL <nl> Java _ io _ realm _ internal _ SharedRealm _ nativeIsEmpty ( JNIEnv * env , jclass , jlong shared _ realm _ ptr ) <nl> { <nl> diff - - git a / realm / realm - library / src / main / cpp / object - store b / realm / realm - library / src / main / cpp / object - store <nl> index 9ea6895 . . 4100b8f 160000 <nl> - - - a / realm / realm - library / src / main / cpp / object - store <nl> + + + b / realm / realm - library / src / main / cpp / object - store <nl> @ @ - 1 + 1 @ @ <nl> - Subproject commit 9ea6895190ea38951d4498f4e124e806efca62b0 <nl> + Subproject commit 4100b8fc407176cdf09e6f394bd111595a6412aa <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / RealmSchema . java b / realm / realm - library / src / main / java / io / realm / RealmSchema . java <nl> index 5033abc . . 0780595 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / RealmSchema . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / RealmSchema . java <nl> @ @ - 87 , 7 + 87 , 7 @ @ public final class RealmSchema { <nl> Set < RealmObjectSchema > schemas = new LinkedHashSet < > ( tableCount ) ; <nl> for ( int i = 0 ; i < tableCount ; i + + ) { <nl> String tableName = realm . sharedRealm . getTableName ( i ) ; <nl> - if ( Table . isMetaTable ( tableName ) ) { <nl> + if ( ! Table . isModelTable ( tableName ) ) { <nl> continue ; <nl> } <nl> Table table = realm . sharedRealm . getTable ( tableName ) ; <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java b / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java <nl> index 728bcc5 . . 8fa0cf6 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java <nl> @ @ - 192 , 13 + 192 , 7 @ @ public final class SharedRealm implements Closeable { <nl> } <nl> <nl> public void setSchemaVersion ( long schemaVersion ) { <nl> - / / FIXME migrate to ObjectStore <nl> - Table metadataTable = getTable ( Table . METADATA _ TABLE _ NAME ) ; <nl> - if ( metadataTable . getColumnCount ( ) = = 0 ) { <nl> - metadataTable . addColumn ( RealmFieldType . INTEGER , " version " ) ; <nl> - metadataTable . addEmptyRow ( ) ; <nl> - } <nl> - metadataTable . setLong ( 0 , 0 , schemaVersion ) ; <nl> + nativeSetVersion ( nativePtr , schemaVersion ) ; <nl> } <nl> <nl> public long getSchemaVersion ( ) { <nl> @ @ - 336 , 6 + 330 , 7 @ @ public final class SharedRealm implements Closeable { <nl> private static native void nativeCancelTransaction ( long nativeSharedRealmPtr ) ; <nl> private static native boolean nativeIsInTransaction ( long nativeSharedRealmPtr ) ; <nl> private static native long nativeGetVersion ( long nativeSharedRealmPtr ) ; <nl> + private static native void nativeSetVersion ( long nativeSharedRealmPtr , long version ) ; <nl> private static native long nativeReadGroup ( long nativeSharedRealmPtr ) ; <nl> private static native boolean nativeIsEmpty ( long nativeSharedRealmPtr ) ; <nl> private static native void nativeRefresh ( long nativeSharedRealmPtr ) ; <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / internal / Table . java b / realm / realm - library / src / main / java / io / realm / internal / Table . java <nl> index b831ef5 . . db2ba7d 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / internal / Table . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / internal / Table . java <nl> @ @ - 37 , 7 + 37 , 6 @ @ public class Table implements TableOrView , TableSchema { <nl> public static final String STRING _ DEFAULT _ VALUE = " " ; <nl> @ SuppressWarnings ( " WeakerAccess " ) <nl> public static final long INTEGER _ DEFAULT _ VALUE = 0 ; <nl> - public static final String METADATA _ TABLE _ NAME = " metadata " ; <nl> public static final boolean NULLABLE = true ; <nl> public static final boolean NOT _ NULLABLE = false ; <nl> <nl> @ @ - 1277 , 10 + 1276 , 10 @ @ public class Table implements TableOrView , TableSchema { <nl> } <nl> <nl> / * * <nl> - * Checks if a given table name is a meta - table , i . e . a table used by Realm to track its internal state . <nl> + * Checks if a given table name is a name for a model table . <nl> * / <nl> - public static boolean isMetaTable ( String tableName ) { <nl> - return ( tableName . equals ( METADATA _ TABLE _ NAME ) | | tableName . equals ( PRIMARY _ KEY _ TABLE _ NAME ) ) ; <nl> + public static boolean isModelTable ( String tableName ) { <nl> + return tableName . startsWith ( TABLE _ PREFIX ) ; <nl> } <nl> <nl> / * *

TEST DIFF:
diff - - git a / realm / realm - library / src / androidTest / java / io / realm / NotificationsTest . java b / realm / realm - library / src / androidTest / java / io / realm / NotificationsTest . java 
 index 0a89796 . . 653a011 100644 
 - - - a / realm / realm - library / src / androidTest / java / io / realm / NotificationsTest . java 
 + + + b / realm / realm - library / src / androidTest / java / io / realm / NotificationsTest . java 
 @ @ - 88 , 7 + 88 , 7 @ @ public class NotificationsTest { 
 } 
 
 @ Test 
 - public void failingSetAutoRefreshOnNonLooperThread ( ) throws ExecutionException , InterruptedException { 
 + public void setAutoRefresh _ failsOnNonLooperThread ( ) throws ExecutionException , InterruptedException { 
 ExecutorService executorService = Executors . newSingleThreadExecutor ( ) ; 
 Future < Boolean > future = executorService . submit ( new Callable < Boolean > ( ) { 
 @ Override 
 diff - - git a / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp b / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp 
 index 497a52c . . c6cb20b 100644 
 - - - a / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp 
 + + + b / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp 
 @ @ - 436 , 11 + 436 , 11 @ @ Java _ io _ realm _ internal _ SharedRealm _ nativeCompact ( JNIEnv * env , jclass , jlong shar 
 } 
 
 JNIEXPORT jlong JNICALL 
 - Java _ io _ realm _ internal _ SharedRealm _ nativeGetSnapshotVersion ( JNIEnv * env , jclass , jlong sharedRealmPtr ) 
 + Java _ io _ realm _ internal _ SharedRealm _ nativeGetSnapshotVersion ( JNIEnv * env , jclass , jlong shared _ realm _ ptr ) 
 { 
 - TR _ ENTER _ PTR ( sharedRealmPtr ) 
 + TR _ ENTER _ PTR ( shared _ realm _ ptr ) 
 
 - auto shared _ realm = * ( reinterpret _ cast < SharedRealm * > ( sharedRealmPtr ) ) ; 
 + auto shared _ realm = * ( reinterpret _ cast < SharedRealm * > ( shared _ realm _ ptr ) ) ; 
 try { 
 using rf = realm : : _ impl : : RealmFriend ; 
 auto & shared _ group = rf : : get _ shared _ group ( * shared _ realm ) ; 
 @ @ - 450 , 15 + 450 , 34 @ @ Java _ io _ realm _ internal _ SharedRealm _ nativeGetSnapshotVersion ( JNIEnv * env , jclass , 
 } 
 
 JNIEXPORT void JNICALL 
 - Java _ io _ realm _ internal _ SharedRealm _ nativeUpdateSchema ( JNIEnv * env , jclass , jlong nativePtr , 
 - jlong nativeSchemaPtr , jlong version ) { 
 - TR _ ENTER ( ) 
 + Java _ io _ realm _ internal _ SharedRealm _ nativeUpdateSchema ( JNIEnv * env , jclass , jlong shared _ realm _ ptr , 
 + jlong schema _ ptr , jlong version ) { 
 + TR _ ENTER _ PTR ( shared _ realm _ ptr ) 
 try { 
 - auto shared _ realm = * ( reinterpret _ cast < SharedRealm * > ( nativePtr ) ) ; 
 - auto * schema = reinterpret _ cast < Schema * > ( nativeSchemaPtr ) ; 
 + auto shared _ realm = * ( reinterpret _ cast < SharedRealm * > ( shared _ realm _ ptr ) ) ; 
 + auto * schema = reinterpret _ cast < Schema * > ( schema _ ptr ) ; 
 shared _ realm - > update _ schema ( * schema , static _ cast < uint64 _ t > ( version ) ) ; 
 - } 
 - CATCH _ STD ( ) 
 + } CATCH _ STD ( ) 
 } 
 
 
 + JNIEXPORT void JNICALL 
 + Java _ io _ realm _ internal _ SharedRealm _ nativeSetAutoRefresh ( JNIEnv * env , jclass , jlong shared _ realm _ ptr , jboolean enabled ) 
 + { 
 + TR _ ENTER _ PTR ( shared _ realm _ ptr ) 
 + try { 
 + auto shared _ realm = * ( reinterpret _ cast < SharedRealm * > ( shared _ realm _ ptr ) ) ; 
 + shared _ realm - > set _ auto _ refresh ( enabled ) ; 
 + } CATCH _ STD ( ) 
 + } 
 + 
 + JNIEXPORT jboolean JNICALL 
 + Java _ io _ realm _ internal _ SharedRealm _ nativeIsAutoRefresh ( JNIEnv * env , jclass , jlong shared _ realm _ ptr ) 
 + { 
 + TR _ ENTER _ PTR ( shared _ realm _ ptr ) 
 + try { 
 + auto shared _ realm = * ( reinterpret _ cast < SharedRealm * > ( shared _ realm _ ptr ) ) ; 
 + return static _ cast < jboolean > ( shared _ realm - > auto _ refresh ( ) ) ; 
 + } CATCH _ STD ( ) 
 + return JNI _ FALSE ; 
 + } 
 diff - - git a / realm / realm - library / src / main / java / io / realm / BaseRealm . java b / realm / realm - library / src / main / java / io / realm / BaseRealm . java 
 index 89604e5 . . 420dc91 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / BaseRealm . java 
 + + + b / realm / realm - library / src / main / java / io / realm / BaseRealm . java 
 @ @ - 17 , 7 + 17 , 6 @ @ 
 package io . realm ; 
 
 import android . content . Context ; 
 - import android . os . Handler ; 
 import android . os . Looper ; 
 
 import java . io . Closeable ; 
 @ @ - 89 , 10 + 88 , 6 @ @ abstract class BaseRealm implements Closeable { 
 } 
 } ) ; 
 this . schema = new RealmSchema ( this ) ; 
 - 
 - if ( handlerController . isAutoRefreshAvailable ( ) ) { 
 - setAutoRefresh ( true ) ; 
 - } 
 } 
 
 / * * 
 @ @ - 108 , 8 + 103 , 7 @ @ abstract class BaseRealm implements Closeable { 
 * / 
 public void setAutoRefresh ( boolean autoRefresh ) { 
 checkIfValid ( ) ; 
 - handlerController . checkCanBeAutoRefreshed ( ) ; 
 - handlerController . setAutoRefresh ( autoRefresh ) ; 
 + sharedRealm . setAutoRefresh ( autoRefresh ) ; 
 } 
 
 / * * 
 @ @ - 118 , 7 + 112 , 7 @ @ abstract class BaseRealm implements Closeable { 
 * @ return the auto - refresh status . 
 * / 
 public boolean isAutoRefresh ( ) { 
 - return handlerController . isAutoRefreshEnabled ( ) ; 
 + return sharedRealm . isAutoRefresh ( ) ; 
 } 
 
 / * * 
 diff - - git a / realm / realm - library / src / main / java / io / realm / internal / Capabilities . java b / realm / realm - library / src / main / java / io / realm / internal / Capabilities . java 
 index 230c17c . . 608538c 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / internal / Capabilities . java 
 + + + b / realm / realm - library / src / main / java / io / realm / internal / Capabilities . java 
 @ @ - 18 , 4 + 18 , 5 @ @ package io . realm . internal ; 
 
 public interface Capabilities { 
 boolean canDeliverNotification ( ) ; 
 + void checkCanDeliverNotification ( ) ; 
 } 
 diff - - git a / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java b / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java 
 index 74110fb . . 5ab76d1 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java 
 + + + b / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java 
 @ @ - 21 , 6 + 21 , 7 @ @ import java . io . File ; 
 
 import io . realm . RealmConfiguration ; 
 import io . realm . RealmSchema ; 
 + import io . realm . internal . android . AndroidCapabilities ; 
 import io . realm . internal . async . BadVersionException ; 
 
 public final class SharedRealm implements Closeable { 
 @ @ - 33 , 6 + 34 , 8 @ @ public final class SharedRealm implements Closeable { 
 public static final byte FILE _ EXCEPTION _ KIND _ INCOMPATIBLE _ LOCK _ FILE = 4 ; 
 public static final byte FILE _ EXCEPTION _ KIND _ FORMAT _ UPGRADE _ REQUIRED = 5 ; 
 
 + public static final Capabilities capabilities = new AndroidCapabilities ( ) ; 
 + 
 public static void initialize ( File tempDirectory ) { 
 if ( SharedRealm . temporaryDirectory ! = null ) { 
 / / already initialized 
 @ @ - 178 , 6 + 181 , 7 @ @ public final class SharedRealm implements Closeable { 
 context = new Context ( ) ; 
 this . lastSchemaVersion = schemaVersionListener = = null ? - 1L : getSchemaVersion ( ) ; 
 objectServerFacade = null ; 
 + nativeSetAutoRefresh ( nativePtr , capabilities . canDeliverNotification ( ) ) ; 
 } 
 
 public static SharedRealm getInstance ( RealmConfiguration config ) { 
 @ @ - 332 , 6 + 336 , 15 @ @ public final class SharedRealm implements Closeable { 
 nativeUpdateSchema ( nativePtr , schema . getNativePtr ( ) , version ) ; 
 } 
 
 + public void setAutoRefresh ( boolean enabled ) { 
 + capabilities . checkCanDeliverNotification ( ) ; 
 + nativeSetAutoRefresh ( nativePtr , enabled ) ; 
 + } 
 + 
 + public boolean isAutoRefresh ( ) { 
 + return nativeIsAutoRefresh ( nativePtr ) ; 
 + } 
 + 
 @ Override 
 public void close ( ) { 
 if ( realmNotifier ! = null ) { 
 @ @ - 405 , 4 + 418 , 6 @ @ public final class SharedRealm implements Closeable { 
 private static native void nativeStopWaitForChange ( long nativeSharedRealmPtr ) ; 
 private static native boolean nativeCompact ( long nativeSharedRealmPtr ) ; 
 private static native void nativeUpdateSchema ( long nativePtr , long nativeSchemaPtr , long version ) ; 
 + private static native void nativeSetAutoRefresh ( long nativePtr , boolean enabled ) ; 
 + private static native boolean nativeIsAutoRefresh ( long nativePtr ) ; 
 } 
 diff - - git a / realm / realm - library / src / main / java / io / realm / internal / android / AndroidCapabilities . java b / realm / realm - library / src / main / java / io / realm / internal / android / AndroidCapabilities . java 
 index d043867 . . 4aeb51a 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / internal / android / AndroidCapabilities . java 
 + + + b / realm / realm - library / src / main / java / io / realm / internal / android / AndroidCapabilities . java 
 @ @ - 26 , 6 + 26 , 16 @ @ public class AndroidCapabilities implements Capabilities { 
 return ( Looper . myLooper ( ) ! = null & & ! isIntentServiceThread ( ) ) ; 
 } 
 
 + @ Override 
 + public void checkCanDeliverNotification ( ) { 
 + if ( Looper . myLooper ( ) = = null ) { 
 + throw new IllegalStateException ( " Cannot set auto - refresh in a Thread without a Looper " ) ; 
 + } 
 + if ( isIntentServiceThread ( ) ) { 
 + throw new IllegalStateException ( " Cannot set auto - refresh in an IntentService thread . " ) ; 
 + } 
 + } 
 + 
 private static boolean isIntentServiceThread ( ) { 
 / / Tries to determine if a thread is an IntentService thread . No public API can detect this , 
 / / so use the thread name as a heuristic :

NEAREST DIFF:
diff - - git a / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp b / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp 
 index 6a75375 . . 90d9b6b 100644 
 - - - a / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp 
 + + + b / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp 
 @ @ - 148 , 6 + 148 , 24 @ @ Java _ io _ realm _ internal _ SharedRealm _ nativeGetVersion ( JNIEnv * env , jclass , jlong s 
 return - 1 ; 
 } 
 
 + JNIEXPORT void JNICALL 
 + Java _ io _ realm _ internal _ SharedRealm _ nativeSetVersion ( JNIEnv * env , jclass , jlong shared _ realm _ ptr , jlong version ) 
 + { 
 + TR _ ENTER _ PTR ( env , shared _ realm _ ptr ) 
 + 
 + auto shared _ realm = * ( reinterpret _ cast < SharedRealm * > ( shared _ realm _ ptr ) ) ; 
 + try { 
 + if ( ! shared _ realm - > is _ in _ transaction ( ) ) { 
 + std : : ostringstream ss ; 
 + ss < < " Cannot set schema version when the realm is not in transaction . " ; 
 + ThrowException ( env , IllegalState , ss . str ( ) ) ; 
 + return ; 
 + } 
 + 
 + ObjectStore : : set _ schema _ version ( shared _ realm - > read _ group ( ) , static _ cast < uint64 _ t > ( version ) ) ; 
 + } CATCH _ STD ( ) 
 + } 
 + 
 JNIEXPORT jboolean JNICALL 
 Java _ io _ realm _ internal _ SharedRealm _ nativeIsEmpty ( JNIEnv * env , jclass , jlong shared _ realm _ ptr ) 
 { 
 diff - - git a / realm / realm - library / src / main / cpp / object - store b / realm / realm - library / src / main / cpp / object - store 
 index 9ea6895 . . 4100b8f 160000 
 - - - a / realm / realm - library / src / main / cpp / object - store 
 + + + b / realm / realm - library / src / main / cpp / object - store 
 @ @ - 1 + 1 @ @ 
 - Subproject commit 9ea6895190ea38951d4498f4e124e806efca62b0 
 + Subproject commit 4100b8fc407176cdf09e6f394bd111595a6412aa 
 diff - - git a / realm / realm - library / src / main / java / io / realm / RealmSchema . java b / realm / realm - library / src / main / java / io / realm / RealmSchema . java 
 index 5033abc . . 0780595 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / RealmSchema . java 
 + + + b / realm / realm - library / src / main / java / io / realm / RealmSchema . java 
 @ @ - 87 , 7 + 87 , 7 @ @ public final class RealmSchema { 
 Set < RealmObjectSchema > schemas = new LinkedHashSet < > ( tableCount ) ; 
 for ( int i = 0 ; i < tableCount ; i + + ) { 
 String tableName = realm . sharedRealm . getTableName ( i ) ; 
 - if ( Table . isMetaTable ( tableName ) ) { 
 + if ( ! Table . isModelTable ( tableName ) ) { 
 continue ; 
 } 
 Table table = realm . sharedRealm . getTable ( tableName ) ; 
 diff - - git a / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java b / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java 
 index 728bcc5 . . 8fa0cf6 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java 
 + + + b / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java 
 @ @ - 192 , 13 + 192 , 7 @ @ public final class SharedRealm implements Closeable { 
 } 
 
 public void setSchemaVersion ( long schemaVersion ) { 
 - / / FIXME migrate to ObjectStore 
 - Table metadataTable = getTable ( Table . METADATA _ TABLE _ NAME ) ; 
 - if ( metadataTable . getColumnCount ( ) = = 0 ) { 
 - metadataTable . addColumn ( RealmFieldType . INTEGER , " version " ) ; 
 - metadataTable . addEmptyRow ( ) ; 
 - } 
 - metadataTable . setLong ( 0 , 0 , schemaVersion ) ; 
 + nativeSetVersion ( nativePtr , schemaVersion ) ; 
 } 
 
 public long getSchemaVersion ( ) { 
 @ @ - 336 , 6 + 330 , 7 @ @ public final class SharedRealm implements Closeable { 
 private static native void nativeCancelTransaction ( long nativeSharedRealmPtr ) ; 
 private static native boolean nativeIsInTransaction ( long nativeSharedRealmPtr ) ; 
 private static native long nativeGetVersion ( long nativeSharedRealmPtr ) ; 
 + private static native void nativeSetVersion ( long nativeSharedRealmPtr , long version ) ; 
 private static native long nativeReadGroup ( long nativeSharedRealmPtr ) ; 
 private static native boolean nativeIsEmpty ( long nativeSharedRealmPtr ) ; 
 private static native void nativeRefresh ( long nativeSharedRealmPtr ) ; 
 diff - - git a / realm / realm - library / src / main / java / io / realm / internal / Table . java b / realm / realm - library / src / main / java / io / realm / internal / Table . java 
 index b831ef5 . . db2ba7d 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / internal / Table . java 
 + + + b / realm / realm - library / src / main / java / io / realm / internal / Table . java 
 @ @ - 37 , 7 + 37 , 6 @ @ public class Table implements TableOrView , TableSchema { 
 public static final String STRING _ DEFAULT _ VALUE = " " ; 
 @ SuppressWarnings ( " WeakerAccess " ) 
 public static final long INTEGER _ DEFAULT _ VALUE = 0 ; 
 - public static final String METADATA _ TABLE _ NAME = " metadata " ; 
 public static final boolean NULLABLE = true ; 
 public static final boolean NOT _ NULLABLE = false ; 
 
 @ @ - 1277 , 10 + 1276 , 10 @ @ public class Table implements TableOrView , TableSchema { 
 } 
 
 / * * 
 - * Checks if a given table name is a meta - table , i . e . a table used by Realm to track its internal state . 
 + * Checks if a given table name is a name for a model table . 
 * / 
 - public static boolean isMetaTable ( String tableName ) { 
 - return ( tableName . equals ( METADATA _ TABLE _ NAME ) | | tableName . equals ( PRIMARY _ KEY _ TABLE _ NAME ) ) ; 
 + public static boolean isModelTable ( String tableName ) { 
 + return tableName . startsWith ( TABLE _ PREFIX ) ; 
 } 
 
 / * *
