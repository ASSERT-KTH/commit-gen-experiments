BLEU SCORE: 0.056697911109760024

TEST MSG: Wait for async tasks finish to solve flaky test
GENERATED MSG: add test for closed Realm . removed dead code

TEST DIFF (one line): diff - - git a / realm / realm - library / src / androidTest / java / io / realm / RealmAsyncQueryTests . java b / realm / realm - library / src / androidTest / java / io / realm / RealmAsyncQueryTests . java <nl> index 6bd6945 . . 4caa6d9 100644 <nl> - - - a / realm / realm - library / src / androidTest / java / io / realm / RealmAsyncQueryTests . java <nl> + + + b / realm / realm - library / src / androidTest / java / io / realm / RealmAsyncQueryTests . java <nl> @ @ - 37 , 6 + 37 , 7 @ @ import io . realm . entities . AnnotationIndexTypes ; <nl> import io . realm . entities . Dog ; <nl> import io . realm . entities . NonLatinFieldNames ; <nl> import io . realm . entities . Owner ; <nl> + import io . realm . internal . async . RealmThreadPoolExecutor ; <nl> import io . realm . log . LogLevel ; <nl> import io . realm . log . RealmLog ; <nl> import io . realm . rule . RunInLooperThread ; <nl> @ @ - 411 , 10 + 412 , 14 @ @ public class RealmAsyncQueryTests { <nl> / / callbacks , the callback should be cleared . <nl> @ Test <nl> @ RunTestInLooperThread <nl> - public void executeTransactionAsync _ callbacksShouldBeClearedBeforeCalling ( ) { <nl> + public void executeTransactionAsync _ callbacksShouldBeClearedBeforeCalling ( ) <nl> + throws NoSuchFieldException , IllegalAccessException { <nl> final AtomicInteger callbackCounter = new AtomicInteger ( 0 ) ; <nl> final Realm foregroundRealm = looperThread . getRealm ( ) ; <nl> <nl> + / / Use single thread executor <nl> + TestHelper . replaceRealmThreadExecutor ( RealmThreadPoolExecutor . newSingleThreadExecutor ( ) ) ; <nl> + <nl> / / To reproduce the issue , the posted callback needs to arrived before the Object Store did _ change called . <nl> / / We just disable the auto refresh here then the did _ change won ' t be called . <nl> foregroundRealm . setAutoRefresh ( false ) ; <nl> @ @ - 440 , 15 + 445 , 6 @ @ public class RealmAsyncQueryTests { <nl> @ Override <nl> public void execute ( Realm realm ) { <nl> realm . createObject ( AllTypes . class ) ; <nl> - / / Delay to post this to ensure the async transaction posted callback will arrive first . <nl> - looperThread . postRunnableDelayed ( new Runnable ( ) { <nl> - @ Override <nl> - public void run ( ) { <nl> - / / Manually call refresh , so the did _ change will be triggered . <nl> - foregroundRealm . sharedRealm . refresh ( ) ; <nl> - foregroundRealm . setAutoRefresh ( true ) ; <nl> - } <nl> - } , 50 ) ; <nl> } <nl> } , new Realm . Transaction . OnSuccess ( ) { <nl> @ Override <nl> @ @ - 458 , 6 + 454 , 17 @ @ public class RealmAsyncQueryTests { <nl> looperThread . testComplete ( ) ; <nl> } <nl> } ) ; <nl> + <nl> + / / Wait for all async tasks finish to ensure the async transaction posted callback will arrive first . <nl> + TestHelper . resetRealmThreadExecutor ( ) ; <nl> + looperThread . postRunnable ( new Runnable ( ) { <nl> + @ Override <nl> + public void run ( ) { <nl> + / / Manually call refresh , so the did _ change will be triggered . <nl> + foregroundRealm . sharedRealm . refresh ( ) ; <nl> + foregroundRealm . setAutoRefresh ( true ) ; <nl> + } <nl> + } ) ; <nl> } <nl> <nl> / / * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *
NEAREST DIFF (one line): diff - - git a / realm / src / androidTest / java / io / realm / RealmAsyncQueryTests . java b / realm / src / androidTest / java / io / realm / RealmAsyncQueryTests . java <nl> index e2469fc . . 4e7ea04 100644 <nl> - - - a / realm / src / androidTest / java / io / realm / RealmAsyncQueryTests . java <nl> + + + b / realm / src / androidTest / java / io / realm / RealmAsyncQueryTests . java <nl> @ @ - 135 , 6 + 135 , 67 @ @ public class RealmAsyncQueryTests extends InstrumentationTestCase { <nl> } <nl> } <nl> <nl> + / / async query on closed Realm <nl> + public void testFindAllOnClosedRealm ( ) throws Throwable { <nl> + setDebugModeForAsyncRealmQuery ( ADVANCE _ ONE _ READ , RetryPolicy . MODE _ INDEFINITELY , RETRY _ NUMBER _ NOT _ APPLICABLE ) ; <nl> + final CountDownLatch signalCallbackFinished = new CountDownLatch ( 1 ) ; <nl> + final Looper [ ] looper = new Looper [ 1 ] ; <nl> + final Throwable [ ] threadAssertionError = new Throwable [ 1 ] ; <nl> + ExecutorService executorService = Executors . newSingleThreadExecutor ( ) ; <nl> + executorService . submit ( new Runnable ( ) { <nl> + @ Override <nl> + public void run ( ) { <nl> + Looper . prepare ( ) ; <nl> + looper [ 0 ] = Looper . myLooper ( ) ; <nl> + Realm realm = null ; <nl> + try { <nl> + realm = openRealmInstance ( " test _ find _ all _ closed _ realm " ) ; <nl> + populateTestRealm ( realm , 10 ) ; <nl> + <nl> + / / async query ( will run on different thread ) <nl> + realm . where ( AllTypes . class ) <nl> + . between ( " columnLong " , 0 , 9 ) <nl> + . findAll ( new Realm . DebugRealmResultsQueryCallback < AllTypes > ( ) { <nl> + @ Override <nl> + public void onSuccess ( RealmResults < AllTypes > results ) { <nl> + signalCallbackFinished . countDown ( ) ; <nl> + } <nl> + <nl> + @ Override <nl> + public void onError ( Exception t ) { <nl> + t . printStackTrace ( ) ; <nl> + threadAssertionError [ 0 ] = t ; <nl> + signalCallbackFinished . countDown ( ) ; <nl> + } <nl> + <nl> + @ Override <nl> + public void onBackgroundQueryCompleted ( Realm realm ) { <nl> + realm . close ( ) ; <nl> + } <nl> + } ) ; <nl> + <nl> + Looper . loop ( ) ; / / ready to receive callback <nl> + <nl> + } finally { <nl> + if ( signalCallbackFinished . getCount ( ) > 0 ) { <nl> + signalCallbackFinished . countDown ( ) ; <nl> + } <nl> + if ( realm ! = null ) { <nl> + realm . close ( ) ; <nl> + } <nl> + } <nl> + } <nl> + } ) ; <nl> + <nl> + / / wait until the callback of our async query proceed <nl> + signalCallbackFinished . await ( ) ; <nl> + looper [ 0 ] . quit ( ) ; <nl> + executorService . shutdownNow ( ) ; <nl> + if ( null = = threadAssertionError [ 0 ] | | ! ( threadAssertionError [ 0 ] instanceof RuntimeException ) ) { <nl> + fail ( " Expecting RuntimeException : Unspecified exception . Detached accessor in io _ realm _ internal _ TableQuery . cpp " ) ; <nl> + } <nl> + } <nl> + <nl> / / async query that should fail , because the caller thread has advanced <nl> / / the version of the Realm , which is different from the one used by <nl> / / the background thread . Since no retry policy was defined , we should fail . <nl> @ @ - 168 , 11 + 229 , 7 @ @ public class RealmAsyncQueryTests extends InstrumentationTestCase { <nl> <nl> @ Override <nl> public void onError ( Exception t ) { <nl> - try { <nl> - threadAssertionError [ 0 ] = t ; <nl> - } finally { <nl> - signalCallbackFinished . countDown ( ) ; <nl> - } <nl> + threadAssertionError [ 0 ] = t ; <nl> } <nl> <nl> @ Override <nl> diff - - git a / realm / src / main / java / io / realm / Realm . java b / realm / src / main / java / io / realm / Realm . java <nl> index 12ac423 . . 63c510e 100644 <nl> - - - a / realm / src / main / java / io / realm / Realm . java <nl> + + + b / realm / src / main / java / io / realm / Realm . java <nl> @ @ - 1917 , 13 + 1917 , 4 @ @ public final class Realm implements Closeable { <nl> public long getSharedGroupPointer ( ) { <nl> return sharedGroup . getNativePointer ( ) ; <nl> } <nl> - <nl> - / / FIXME this method should be available only within RealmImpl ( see above comment ) <nl> - public long [ ] getSharedGroupVersion ( ) { <nl> - return sharedGroup . getVersionID ( ) ; <nl> - } <nl> - <nl> - public void setSharedGroupAtVersion ( long [ ] callerSharedGroupVersion ) { <nl> - sharedGroup . beginReadAtVersionID ( callerSharedGroupVersion ) ; <nl> - } <nl> } <nl> diff - - git a / realm / src / main / java / io / realm / RealmQuery . java b / realm / src / main / java / io / realm / RealmQuery . java <nl> index fdb10f7 . . 0066c39 100644 <nl> - - - a / realm / src / main / java / io / realm / RealmQuery . java <nl> + + + b / realm / src / main / java / io / realm / RealmQuery . java <nl> @ @ - 1846 , 7 + 1846 , 7 @ @ public class RealmQuery < E extends RealmObject > { <nl> <nl> @ Override <nl> public void handleMessage ( Message msg ) { <nl> - if ( ! asyncRequest . isCancelled ( ) ) { <nl> + if ( ! asyncRequest . isCancelled ( ) ) { / / FIXME check if realm is still open / valid <nl> try { <nl> switch ( msg . what ) { <nl> case MSG _ SUCCESS :

TEST DIFF:
diff - - git a / realm / realm - library / src / androidTest / java / io / realm / RealmAsyncQueryTests . java b / realm / realm - library / src / androidTest / java / io / realm / RealmAsyncQueryTests . java 
 index 6bd6945 . . 4caa6d9 100644 
 - - - a / realm / realm - library / src / androidTest / java / io / realm / RealmAsyncQueryTests . java 
 + + + b / realm / realm - library / src / androidTest / java / io / realm / RealmAsyncQueryTests . java 
 @ @ - 37 , 6 + 37 , 7 @ @ import io . realm . entities . AnnotationIndexTypes ; 
 import io . realm . entities . Dog ; 
 import io . realm . entities . NonLatinFieldNames ; 
 import io . realm . entities . Owner ; 
 + import io . realm . internal . async . RealmThreadPoolExecutor ; 
 import io . realm . log . LogLevel ; 
 import io . realm . log . RealmLog ; 
 import io . realm . rule . RunInLooperThread ; 
 @ @ - 411 , 10 + 412 , 14 @ @ public class RealmAsyncQueryTests { 
 / / callbacks , the callback should be cleared . 
 @ Test 
 @ RunTestInLooperThread 
 - public void executeTransactionAsync _ callbacksShouldBeClearedBeforeCalling ( ) { 
 + public void executeTransactionAsync _ callbacksShouldBeClearedBeforeCalling ( ) 
 + throws NoSuchFieldException , IllegalAccessException { 
 final AtomicInteger callbackCounter = new AtomicInteger ( 0 ) ; 
 final Realm foregroundRealm = looperThread . getRealm ( ) ; 
 
 + / / Use single thread executor 
 + TestHelper . replaceRealmThreadExecutor ( RealmThreadPoolExecutor . newSingleThreadExecutor ( ) ) ; 
 + 
 / / To reproduce the issue , the posted callback needs to arrived before the Object Store did _ change called . 
 / / We just disable the auto refresh here then the did _ change won ' t be called . 
 foregroundRealm . setAutoRefresh ( false ) ; 
 @ @ - 440 , 15 + 445 , 6 @ @ public class RealmAsyncQueryTests { 
 @ Override 
 public void execute ( Realm realm ) { 
 realm . createObject ( AllTypes . class ) ; 
 - / / Delay to post this to ensure the async transaction posted callback will arrive first . 
 - looperThread . postRunnableDelayed ( new Runnable ( ) { 
 - @ Override 
 - public void run ( ) { 
 - / / Manually call refresh , so the did _ change will be triggered . 
 - foregroundRealm . sharedRealm . refresh ( ) ; 
 - foregroundRealm . setAutoRefresh ( true ) ; 
 - } 
 - } , 50 ) ; 
 } 
 } , new Realm . Transaction . OnSuccess ( ) { 
 @ Override 
 @ @ - 458 , 6 + 454 , 17 @ @ public class RealmAsyncQueryTests { 
 looperThread . testComplete ( ) ; 
 } 
 } ) ; 
 + 
 + / / Wait for all async tasks finish to ensure the async transaction posted callback will arrive first . 
 + TestHelper . resetRealmThreadExecutor ( ) ; 
 + looperThread . postRunnable ( new Runnable ( ) { 
 + @ Override 
 + public void run ( ) { 
 + / / Manually call refresh , so the did _ change will be triggered . 
 + foregroundRealm . sharedRealm . refresh ( ) ; 
 + foregroundRealm . setAutoRefresh ( true ) ; 
 + } 
 + } ) ; 
 } 
 
 / / * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * * *

NEAREST DIFF:
diff - - git a / realm / src / androidTest / java / io / realm / RealmAsyncQueryTests . java b / realm / src / androidTest / java / io / realm / RealmAsyncQueryTests . java 
 index e2469fc . . 4e7ea04 100644 
 - - - a / realm / src / androidTest / java / io / realm / RealmAsyncQueryTests . java 
 + + + b / realm / src / androidTest / java / io / realm / RealmAsyncQueryTests . java 
 @ @ - 135 , 6 + 135 , 67 @ @ public class RealmAsyncQueryTests extends InstrumentationTestCase { 
 } 
 } 
 
 + / / async query on closed Realm 
 + public void testFindAllOnClosedRealm ( ) throws Throwable { 
 + setDebugModeForAsyncRealmQuery ( ADVANCE _ ONE _ READ , RetryPolicy . MODE _ INDEFINITELY , RETRY _ NUMBER _ NOT _ APPLICABLE ) ; 
 + final CountDownLatch signalCallbackFinished = new CountDownLatch ( 1 ) ; 
 + final Looper [ ] looper = new Looper [ 1 ] ; 
 + final Throwable [ ] threadAssertionError = new Throwable [ 1 ] ; 
 + ExecutorService executorService = Executors . newSingleThreadExecutor ( ) ; 
 + executorService . submit ( new Runnable ( ) { 
 + @ Override 
 + public void run ( ) { 
 + Looper . prepare ( ) ; 
 + looper [ 0 ] = Looper . myLooper ( ) ; 
 + Realm realm = null ; 
 + try { 
 + realm = openRealmInstance ( " test _ find _ all _ closed _ realm " ) ; 
 + populateTestRealm ( realm , 10 ) ; 
 + 
 + / / async query ( will run on different thread ) 
 + realm . where ( AllTypes . class ) 
 + . between ( " columnLong " , 0 , 9 ) 
 + . findAll ( new Realm . DebugRealmResultsQueryCallback < AllTypes > ( ) { 
 + @ Override 
 + public void onSuccess ( RealmResults < AllTypes > results ) { 
 + signalCallbackFinished . countDown ( ) ; 
 + } 
 + 
 + @ Override 
 + public void onError ( Exception t ) { 
 + t . printStackTrace ( ) ; 
 + threadAssertionError [ 0 ] = t ; 
 + signalCallbackFinished . countDown ( ) ; 
 + } 
 + 
 + @ Override 
 + public void onBackgroundQueryCompleted ( Realm realm ) { 
 + realm . close ( ) ; 
 + } 
 + } ) ; 
 + 
 + Looper . loop ( ) ; / / ready to receive callback 
 + 
 + } finally { 
 + if ( signalCallbackFinished . getCount ( ) > 0 ) { 
 + signalCallbackFinished . countDown ( ) ; 
 + } 
 + if ( realm ! = null ) { 
 + realm . close ( ) ; 
 + } 
 + } 
 + } 
 + } ) ; 
 + 
 + / / wait until the callback of our async query proceed 
 + signalCallbackFinished . await ( ) ; 
 + looper [ 0 ] . quit ( ) ; 
 + executorService . shutdownNow ( ) ; 
 + if ( null = = threadAssertionError [ 0 ] | | ! ( threadAssertionError [ 0 ] instanceof RuntimeException ) ) { 
 + fail ( " Expecting RuntimeException : Unspecified exception . Detached accessor in io _ realm _ internal _ TableQuery . cpp " ) ; 
 + } 
 + } 
 + 
 / / async query that should fail , because the caller thread has advanced 
 / / the version of the Realm , which is different from the one used by 
 / / the background thread . Since no retry policy was defined , we should fail . 
 @ @ - 168 , 11 + 229 , 7 @ @ public class RealmAsyncQueryTests extends InstrumentationTestCase { 
 
 @ Override 
 public void onError ( Exception t ) { 
 - try { 
 - threadAssertionError [ 0 ] = t ; 
 - } finally { 
 - signalCallbackFinished . countDown ( ) ; 
 - } 
 + threadAssertionError [ 0 ] = t ; 
 } 
 
 @ Override 
 diff - - git a / realm / src / main / java / io / realm / Realm . java b / realm / src / main / java / io / realm / Realm . java 
 index 12ac423 . . 63c510e 100644 
 - - - a / realm / src / main / java / io / realm / Realm . java 
 + + + b / realm / src / main / java / io / realm / Realm . java 
 @ @ - 1917 , 13 + 1917 , 4 @ @ public final class Realm implements Closeable { 
 public long getSharedGroupPointer ( ) { 
 return sharedGroup . getNativePointer ( ) ; 
 } 
 - 
 - / / FIXME this method should be available only within RealmImpl ( see above comment ) 
 - public long [ ] getSharedGroupVersion ( ) { 
 - return sharedGroup . getVersionID ( ) ; 
 - } 
 - 
 - public void setSharedGroupAtVersion ( long [ ] callerSharedGroupVersion ) { 
 - sharedGroup . beginReadAtVersionID ( callerSharedGroupVersion ) ; 
 - } 
 } 
 diff - - git a / realm / src / main / java / io / realm / RealmQuery . java b / realm / src / main / java / io / realm / RealmQuery . java 
 index fdb10f7 . . 0066c39 100644 
 - - - a / realm / src / main / java / io / realm / RealmQuery . java 
 + + + b / realm / src / main / java / io / realm / RealmQuery . java 
 @ @ - 1846 , 7 + 1846 , 7 @ @ public class RealmQuery < E extends RealmObject > { 
 
 @ Override 
 public void handleMessage ( Message msg ) { 
 - if ( ! asyncRequest . isCancelled ( ) ) { 
 + if ( ! asyncRequest . isCancelled ( ) ) { / / FIXME check if realm is still open / valid 
 try { 
 switch ( msg . what ) { 
 case MSG _ SUCCESS :
