BLEU SCORE: 0.006662591348749398

TEST MSG: Post to disable snapshot only once
GENERATED MSG: use ObjectStore : : set _ schema _ version ( ) to change the schema version instead of Java local logic

TEST DIFF (one line): diff - - git a / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java b / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java <nl> index c3edef2 . . 3fb19ae 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java <nl> @ @ - 110 , 6 + 110 , 8 @ @ public final class SharedRealm implements Closeable { <nl> public final RowNotifier rowNotifier ; <nl> public final ObjectServerFacade objectServerFacade ; <nl> public final List < WeakReference < Collection > > collections = new CopyOnWriteArrayList < WeakReference < Collection > > ( ) ; <nl> + / / To prevent overflow the message queue . <nl> + public boolean disableSnapshotPosted = false ; <nl> <nl> public static class VersionID implements Comparable < VersionID > { <nl> public final long version ; <nl> @ @ - 240 , 10 + 242 , 12 @ @ public final class SharedRealm implements Closeable { <nl> <nl> public void commitTransaction ( ) { <nl> nativeCommitTransaction ( nativePtr ) ; <nl> - if ( realmNotifier ! = null & & ! collections . isEmpty ( ) ) { <nl> + if ( realmNotifier ! = null & & ! collections . isEmpty ( ) & & ! disableSnapshotPosted ) { <nl> + disableSnapshotPosted = true ; <nl> realmNotifier . postAtFrontOfQueue ( new Runnable ( ) { <nl> @ Override <nl> public void run ( ) { <nl> + disableSnapshotPosted = false ; <nl> disableCollectionSnapshot ( ) ; <nl> } <nl> } ) ;
NEAREST DIFF (one line): diff - - git a / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp b / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp <nl> index 6a75375 . . 90d9b6b 100644 <nl> - - - a / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp <nl> + + + b / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp <nl> @ @ - 148 , 6 + 148 , 24 @ @ Java _ io _ realm _ internal _ SharedRealm _ nativeGetVersion ( JNIEnv * env , jclass , jlong s <nl> return - 1 ; <nl> } <nl> <nl> + JNIEXPORT void JNICALL <nl> + Java _ io _ realm _ internal _ SharedRealm _ nativeSetVersion ( JNIEnv * env , jclass , jlong shared _ realm _ ptr , jlong version ) <nl> + { <nl> + TR _ ENTER _ PTR ( env , shared _ realm _ ptr ) <nl> + <nl> + auto shared _ realm = * ( reinterpret _ cast < SharedRealm * > ( shared _ realm _ ptr ) ) ; <nl> + try { <nl> + if ( ! shared _ realm - > is _ in _ transaction ( ) ) { <nl> + std : : ostringstream ss ; <nl> + ss < < " Cannot set schema version when the realm is not in transaction . " ; <nl> + ThrowException ( env , IllegalState , ss . str ( ) ) ; <nl> + return ; <nl> + } <nl> + <nl> + ObjectStore : : set _ schema _ version ( shared _ realm - > read _ group ( ) , static _ cast < uint64 _ t > ( version ) ) ; <nl> + } CATCH _ STD ( ) <nl> + } <nl> + <nl> JNIEXPORT jboolean JNICALL <nl> Java _ io _ realm _ internal _ SharedRealm _ nativeIsEmpty ( JNIEnv * env , jclass , jlong shared _ realm _ ptr ) <nl> { <nl> diff - - git a / realm / realm - library / src / main / cpp / object - store b / realm / realm - library / src / main / cpp / object - store <nl> index 9ea6895 . . 4100b8f 160000 <nl> - - - a / realm / realm - library / src / main / cpp / object - store <nl> + + + b / realm / realm - library / src / main / cpp / object - store <nl> @ @ - 1 + 1 @ @ <nl> - Subproject commit 9ea6895190ea38951d4498f4e124e806efca62b0 <nl> + Subproject commit 4100b8fc407176cdf09e6f394bd111595a6412aa <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / RealmSchema . java b / realm / realm - library / src / main / java / io / realm / RealmSchema . java <nl> index 5033abc . . 0780595 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / RealmSchema . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / RealmSchema . java <nl> @ @ - 87 , 7 + 87 , 7 @ @ public final class RealmSchema { <nl> Set < RealmObjectSchema > schemas = new LinkedHashSet < > ( tableCount ) ; <nl> for ( int i = 0 ; i < tableCount ; i + + ) { <nl> String tableName = realm . sharedRealm . getTableName ( i ) ; <nl> - if ( Table . isMetaTable ( tableName ) ) { <nl> + if ( ! Table . isModelTable ( tableName ) ) { <nl> continue ; <nl> } <nl> Table table = realm . sharedRealm . getTable ( tableName ) ; <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java b / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java <nl> index 728bcc5 . . 8fa0cf6 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java <nl> @ @ - 192 , 13 + 192 , 7 @ @ public final class SharedRealm implements Closeable { <nl> } <nl> <nl> public void setSchemaVersion ( long schemaVersion ) { <nl> - / / FIXME migrate to ObjectStore <nl> - Table metadataTable = getTable ( Table . METADATA _ TABLE _ NAME ) ; <nl> - if ( metadataTable . getColumnCount ( ) = = 0 ) { <nl> - metadataTable . addColumn ( RealmFieldType . INTEGER , " version " ) ; <nl> - metadataTable . addEmptyRow ( ) ; <nl> - } <nl> - metadataTable . setLong ( 0 , 0 , schemaVersion ) ; <nl> + nativeSetVersion ( nativePtr , schemaVersion ) ; <nl> } <nl> <nl> public long getSchemaVersion ( ) { <nl> @ @ - 336 , 6 + 330 , 7 @ @ public final class SharedRealm implements Closeable { <nl> private static native void nativeCancelTransaction ( long nativeSharedRealmPtr ) ; <nl> private static native boolean nativeIsInTransaction ( long nativeSharedRealmPtr ) ; <nl> private static native long nativeGetVersion ( long nativeSharedRealmPtr ) ; <nl> + private static native void nativeSetVersion ( long nativeSharedRealmPtr , long version ) ; <nl> private static native long nativeReadGroup ( long nativeSharedRealmPtr ) ; <nl> private static native boolean nativeIsEmpty ( long nativeSharedRealmPtr ) ; <nl> private static native void nativeRefresh ( long nativeSharedRealmPtr ) ; <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / internal / Table . java b / realm / realm - library / src / main / java / io / realm / internal / Table . java <nl> index b831ef5 . . db2ba7d 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / internal / Table . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / internal / Table . java <nl> @ @ - 37 , 7 + 37 , 6 @ @ public class Table implements TableOrView , TableSchema { <nl> public static final String STRING _ DEFAULT _ VALUE = " " ; <nl> @ SuppressWarnings ( " WeakerAccess " ) <nl> public static final long INTEGER _ DEFAULT _ VALUE = 0 ; <nl> - public static final String METADATA _ TABLE _ NAME = " metadata " ; <nl> public static final boolean NULLABLE = true ; <nl> public static final boolean NOT _ NULLABLE = false ; <nl> <nl> @ @ - 1277 , 10 + 1276 , 10 @ @ public class Table implements TableOrView , TableSchema { <nl> } <nl> <nl> / * * <nl> - * Checks if a given table name is a meta - table , i . e . a table used by Realm to track its internal state . <nl> + * Checks if a given table name is a name for a model table . <nl> * / <nl> - public static boolean isMetaTable ( String tableName ) { <nl> - return ( tableName . equals ( METADATA _ TABLE _ NAME ) | | tableName . equals ( PRIMARY _ KEY _ TABLE _ NAME ) ) ; <nl> + public static boolean isModelTable ( String tableName ) { <nl> + return tableName . startsWith ( TABLE _ PREFIX ) ; <nl> } <nl> <nl> / * *

TEST DIFF:
diff - - git a / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java b / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java 
 index c3edef2 . . 3fb19ae 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java 
 + + + b / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java 
 @ @ - 110 , 6 + 110 , 8 @ @ public final class SharedRealm implements Closeable { 
 public final RowNotifier rowNotifier ; 
 public final ObjectServerFacade objectServerFacade ; 
 public final List < WeakReference < Collection > > collections = new CopyOnWriteArrayList < WeakReference < Collection > > ( ) ; 
 + / / To prevent overflow the message queue . 
 + public boolean disableSnapshotPosted = false ; 
 
 public static class VersionID implements Comparable < VersionID > { 
 public final long version ; 
 @ @ - 240 , 10 + 242 , 12 @ @ public final class SharedRealm implements Closeable { 
 
 public void commitTransaction ( ) { 
 nativeCommitTransaction ( nativePtr ) ; 
 - if ( realmNotifier ! = null & & ! collections . isEmpty ( ) ) { 
 + if ( realmNotifier ! = null & & ! collections . isEmpty ( ) & & ! disableSnapshotPosted ) { 
 + disableSnapshotPosted = true ; 
 realmNotifier . postAtFrontOfQueue ( new Runnable ( ) { 
 @ Override 
 public void run ( ) { 
 + disableSnapshotPosted = false ; 
 disableCollectionSnapshot ( ) ; 
 } 
 } ) ;

NEAREST DIFF:
diff - - git a / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp b / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp 
 index 6a75375 . . 90d9b6b 100644 
 - - - a / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp 
 + + + b / realm / realm - library / src / main / cpp / io _ realm _ internal _ SharedRealm . cpp 
 @ @ - 148 , 6 + 148 , 24 @ @ Java _ io _ realm _ internal _ SharedRealm _ nativeGetVersion ( JNIEnv * env , jclass , jlong s 
 return - 1 ; 
 } 
 
 + JNIEXPORT void JNICALL 
 + Java _ io _ realm _ internal _ SharedRealm _ nativeSetVersion ( JNIEnv * env , jclass , jlong shared _ realm _ ptr , jlong version ) 
 + { 
 + TR _ ENTER _ PTR ( env , shared _ realm _ ptr ) 
 + 
 + auto shared _ realm = * ( reinterpret _ cast < SharedRealm * > ( shared _ realm _ ptr ) ) ; 
 + try { 
 + if ( ! shared _ realm - > is _ in _ transaction ( ) ) { 
 + std : : ostringstream ss ; 
 + ss < < " Cannot set schema version when the realm is not in transaction . " ; 
 + ThrowException ( env , IllegalState , ss . str ( ) ) ; 
 + return ; 
 + } 
 + 
 + ObjectStore : : set _ schema _ version ( shared _ realm - > read _ group ( ) , static _ cast < uint64 _ t > ( version ) ) ; 
 + } CATCH _ STD ( ) 
 + } 
 + 
 JNIEXPORT jboolean JNICALL 
 Java _ io _ realm _ internal _ SharedRealm _ nativeIsEmpty ( JNIEnv * env , jclass , jlong shared _ realm _ ptr ) 
 { 
 diff - - git a / realm / realm - library / src / main / cpp / object - store b / realm / realm - library / src / main / cpp / object - store 
 index 9ea6895 . . 4100b8f 160000 
 - - - a / realm / realm - library / src / main / cpp / object - store 
 + + + b / realm / realm - library / src / main / cpp / object - store 
 @ @ - 1 + 1 @ @ 
 - Subproject commit 9ea6895190ea38951d4498f4e124e806efca62b0 
 + Subproject commit 4100b8fc407176cdf09e6f394bd111595a6412aa 
 diff - - git a / realm / realm - library / src / main / java / io / realm / RealmSchema . java b / realm / realm - library / src / main / java / io / realm / RealmSchema . java 
 index 5033abc . . 0780595 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / RealmSchema . java 
 + + + b / realm / realm - library / src / main / java / io / realm / RealmSchema . java 
 @ @ - 87 , 7 + 87 , 7 @ @ public final class RealmSchema { 
 Set < RealmObjectSchema > schemas = new LinkedHashSet < > ( tableCount ) ; 
 for ( int i = 0 ; i < tableCount ; i + + ) { 
 String tableName = realm . sharedRealm . getTableName ( i ) ; 
 - if ( Table . isMetaTable ( tableName ) ) { 
 + if ( ! Table . isModelTable ( tableName ) ) { 
 continue ; 
 } 
 Table table = realm . sharedRealm . getTable ( tableName ) ; 
 diff - - git a / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java b / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java 
 index 728bcc5 . . 8fa0cf6 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java 
 + + + b / realm / realm - library / src / main / java / io / realm / internal / SharedRealm . java 
 @ @ - 192 , 13 + 192 , 7 @ @ public final class SharedRealm implements Closeable { 
 } 
 
 public void setSchemaVersion ( long schemaVersion ) { 
 - / / FIXME migrate to ObjectStore 
 - Table metadataTable = getTable ( Table . METADATA _ TABLE _ NAME ) ; 
 - if ( metadataTable . getColumnCount ( ) = = 0 ) { 
 - metadataTable . addColumn ( RealmFieldType . INTEGER , " version " ) ; 
 - metadataTable . addEmptyRow ( ) ; 
 - } 
 - metadataTable . setLong ( 0 , 0 , schemaVersion ) ; 
 + nativeSetVersion ( nativePtr , schemaVersion ) ; 
 } 
 
 public long getSchemaVersion ( ) { 
 @ @ - 336 , 6 + 330 , 7 @ @ public final class SharedRealm implements Closeable { 
 private static native void nativeCancelTransaction ( long nativeSharedRealmPtr ) ; 
 private static native boolean nativeIsInTransaction ( long nativeSharedRealmPtr ) ; 
 private static native long nativeGetVersion ( long nativeSharedRealmPtr ) ; 
 + private static native void nativeSetVersion ( long nativeSharedRealmPtr , long version ) ; 
 private static native long nativeReadGroup ( long nativeSharedRealmPtr ) ; 
 private static native boolean nativeIsEmpty ( long nativeSharedRealmPtr ) ; 
 private static native void nativeRefresh ( long nativeSharedRealmPtr ) ; 
 diff - - git a / realm / realm - library / src / main / java / io / realm / internal / Table . java b / realm / realm - library / src / main / java / io / realm / internal / Table . java 
 index b831ef5 . . db2ba7d 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / internal / Table . java 
 + + + b / realm / realm - library / src / main / java / io / realm / internal / Table . java 
 @ @ - 37 , 7 + 37 , 6 @ @ public class Table implements TableOrView , TableSchema { 
 public static final String STRING _ DEFAULT _ VALUE = " " ; 
 @ SuppressWarnings ( " WeakerAccess " ) 
 public static final long INTEGER _ DEFAULT _ VALUE = 0 ; 
 - public static final String METADATA _ TABLE _ NAME = " metadata " ; 
 public static final boolean NULLABLE = true ; 
 public static final boolean NOT _ NULLABLE = false ; 
 
 @ @ - 1277 , 10 + 1276 , 10 @ @ public class Table implements TableOrView , TableSchema { 
 } 
 
 / * * 
 - * Checks if a given table name is a meta - table , i . e . a table used by Realm to track its internal state . 
 + * Checks if a given table name is a name for a model table . 
 * / 
 - public static boolean isMetaTable ( String tableName ) { 
 - return ( tableName . equals ( METADATA _ TABLE _ NAME ) | | tableName . equals ( PRIMARY _ KEY _ TABLE _ NAME ) ) ; 
 + public static boolean isModelTable ( String tableName ) { 
 + return tableName . startsWith ( TABLE _ PREFIX ) ; 
 } 
 
 / * *
