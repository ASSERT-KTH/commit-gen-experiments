BLEU SCORE: 0.03527502360630138

TEST MSG: 4 . 0 API breaking changes
GENERATED MSG: Add support for SyncCredentials . accessToken . Updated integration tests .

TEST DIFF (one line): diff - - git a / CHANGELOG . md b / CHANGELOG . md <nl> index e3fee3b . . 0a65e65 100644 <nl> - - - a / CHANGELOG . md <nl> + + + b / CHANGELOG . md <nl> @ @ - 7 , 6 + 7 , 8 @ @ <nl> * Removed deprecated APIs ` RealmSchema . close ( ) ` and ` RealmObjectSchema . close ( ) ` . Those don ' t have to be called anymore . <nl> * Removed deprecated API ` RealmResults . removeChangeListeners ( ) ` . Use ` RealmResults . removeAllChangeListeners ( ) ` instead . <nl> * Removed deprecated API ` RealmObject . removeChangeListeners ( ) ` . Use ` RealmObject . removeAllChangeListeners ( ) ` instead . <nl> + * ` SyncUser . Callback ` to becomes generic . <nl> + * Removed ` SyncUser . getAccessToken ` method from public API , and rename it to ` getRefreshToken ` . <nl> <nl> # # Deprecated <nl> <nl> diff - - git a / examples / objectServerExample / src / main / java / io / realm / examples / objectserver / LoginActivity . java b / examples / objectServerExample / src / main / java / io / realm / examples / objectserver / LoginActivity . java <nl> index 73793b1 . . 9bf5479 100644 <nl> - - - a / examples / objectServerExample / src / main / java / io / realm / examples / objectserver / LoginActivity . java <nl> + + + b / examples / objectServerExample / src / main / java / io / realm / examples / objectserver / LoginActivity . java <nl> @ @ - 78 , 7 + 78 , 7 @ @ public class LoginActivity extends AppCompatActivity { <nl> String password = this . password . getText ( ) . toString ( ) ; <nl> <nl> SyncCredentials creds = SyncCredentials . usernamePassword ( username , password , createUser ) ; <nl> - SyncUser . Callback callback = new SyncUser . Callback ( ) { <nl> + SyncUser . Callback < SyncUser > callback = new SyncUser . Callback < SyncUser > ( ) { <nl> @ Override <nl> public void onSuccess ( @ Nonnull SyncUser user ) { <nl> progressDialog . dismiss ( ) ; <nl> diff - - git a / realm / realm - library / src / androidTestObjectServer / java / io / realm / AuthenticateRequestTests . java b / realm / realm - library / src / androidTestObjectServer / java / io / realm / AuthenticateRequestTests . java <nl> index bdadf62 . . a7fff7a 100644 <nl> - - - a / realm / realm - library / src / androidTestObjectServer / java / io / realm / AuthenticateRequestTests . java <nl> + + + b / realm / realm - library / src / androidTestObjectServer / java / io / realm / AuthenticateRequestTests . java <nl> @ @ - 39 , 7 + 39 , 7 @ @ public class AuthenticateRequestTests { <nl> <nl> @ Test <nl> public void realmLogin ( ) throws URISyntaxException , JSONException { <nl> - Token t = SyncTestUtils . createTestUser ( ) . getAccessToken ( ) ; <nl> + Token t = SyncTestUtils . createTestUser ( ) . getRefreshToken ( ) ; <nl> AuthenticateRequest request = AuthenticateRequest . realmLogin ( t , new URI ( " realm : / / objectserver / " + t . identity ( ) + " / default " ) ) ; <nl> <nl> JSONObject obj = new JSONObject ( request . toJson ( ) ) ; <nl> @ @ - 60 , 7 + 60 , 7 @ @ public class AuthenticateRequestTests { <nl> <nl> @ Test <nl> public void userRefresh ( ) throws URISyntaxException , JSONException { <nl> - Token t = SyncTestUtils . createTestUser ( ) . getAccessToken ( ) ; <nl> + Token t = SyncTestUtils . createTestUser ( ) . getRefreshToken ( ) ; <nl> AuthenticateRequest request = AuthenticateRequest . userRefresh ( t , new URI ( " realm : / / objectserver / " + t . identity ( ) + " / default " ) ) ; <nl> <nl> JSONObject obj = new JSONObject ( request . toJson ( ) ) ; <nl> diff - - git a / realm / realm - library / src / androidTestObjectServer / java / io / realm / SyncUserTests . java b / realm / realm - library / src / androidTestObjectServer / java / io / realm / SyncUserTests . java <nl> index 1c90667 . . 5d67f68 100644 <nl> - - - a / realm / realm - library / src / androidTestObjectServer / java / io / realm / SyncUserTests . java <nl> + + + b / realm / realm - library / src / androidTestObjectServer / java / io / realm / SyncUserTests . java <nl> @ @ - 50 , 8 + 50 , 8 @ @ import io . realm . internal . network . AuthenticateResponse ; <nl> import io . realm . internal . network . AuthenticationServer ; <nl> import io . realm . internal . objectserver . Token ; <nl> import io . realm . log . RealmLog ; <nl> - import io . realm . objectserver . utils . UserFactory ; <nl> import io . realm . objectserver . utils . StringOnlyModule ; <nl> + import io . realm . objectserver . utils . UserFactory ; <nl> import io . realm . rule . RunInLooperThread ; <nl> import io . realm . rule . RunTestInLooperThread ; <nl> import io . realm . util . SyncTestUtils ; <nl> @ @ - 382 , 7 + 382 , 7 @ @ public class SyncUserTests { <nl> SyncUser user = createTestUser ( ) ; <nl> <nl> thrown . expect ( IllegalStateException . class ) ; <nl> - user . changePasswordAsync ( " password " , new SyncUser . Callback ( ) { <nl> + user . changePasswordAsync ( " password " , new SyncUser . Callback < SyncUser > ( ) { <nl> @ Override <nl> public void onSuccess ( SyncUser user ) { <nl> fail ( ) ; <nl> @ @ - 400 , 7 + 400 , 7 @ @ public class SyncUserTests { <nl> SyncUser user = createTestUser ( ) ; <nl> <nl> thrown . expect ( IllegalStateException . class ) ; <nl> - user . changePasswordAsync ( " user - id " , " new " , new SyncUser . Callback ( ) { <nl> + user . changePasswordAsync ( " user - id " , " new " , new SyncUser . Callback < SyncUser > ( ) { <nl> @ Override <nl> public void onSuccess ( SyncUser user ) { <nl> fail ( ) ; <nl> @ @ - 543 , 11 + 543 , 11 @ @ public class SyncUserTests { <nl> / / since the user is not persisted in the UserStore <nl> / / isValid ( ) requires SyncManager . getUserStore ( ) . isActive ( identity ) <nl> / / to return true as well . <nl> - Token accessToken = syncUser . getAccessToken ( ) ; <nl> - assertNotNull ( accessToken ) ; <nl> + Token refreshToken = syncUser . getRefreshToken ( ) ; <nl> + assertNotNull ( refreshToken ) ; <nl> / / refresh token should expire in 10 years ( July 23 , 2027 ) <nl> Calendar calendar = Calendar . getInstance ( ) ; <nl> - calendar . setTimeInMillis ( accessToken . expiresMs ( ) ) ; <nl> + calendar . setTimeInMillis ( refreshToken . expiresMs ( ) ) ; <nl> int day = calendar . get ( Calendar . DAY _ OF _ MONTH ) ; <nl> int month = calendar . get ( Calendar . MONTH ) ; <nl> int year = calendar . get ( Calendar . YEAR ) ; <nl> diff - - git a / realm / realm - library / src / androidTestObjectServer / java / io / realm / util / SyncTestUtils . java b / realm / realm - library / src / androidTestObjectServer / java / io / realm / util / SyncTestUtils . java <nl> index 167bb3b . . 97caaa1 100644 <nl> - - - a / realm / realm - library / src / androidTestObjectServer / java / io / realm / util / SyncTestUtils . java <nl> + + + b / realm / realm - library / src / androidTestObjectServer / java / io / realm / util / SyncTestUtils . java <nl> @ @ - 37 , 10 + 37 , 13 @ @ public class SyncTestUtils { <nl> public static final String DEFAULT _ AUTH _ URL = " http : / / objectserver . realm . io / auth " ; <nl> <nl> private final static Method SYNC _ MANAGER _ GET _ USER _ STORE _ METHOD ; <nl> + private final static Method SYNC _ USER _ GET _ ACCESS _ TOKEN _ METHOD ; <nl> static { <nl> try { <nl> SYNC _ MANAGER _ GET _ USER _ STORE _ METHOD = SyncManager . class . getDeclaredMethod ( " getUserStore " ) ; <nl> + SYNC _ USER _ GET _ ACCESS _ TOKEN _ METHOD = SyncUser . class . getDeclaredMethod ( " getRefreshToken " ) ; <nl> SYNC _ MANAGER _ GET _ USER _ STORE _ METHOD . setAccessible ( true ) ; <nl> + SYNC _ USER _ GET _ ACCESS _ TOKEN _ METHOD . setAccessible ( true ) ; <nl> } catch ( NoSuchMethodException e ) { <nl> throw new AssertionError ( e ) ; <nl> } <nl> @ @ - 106 , 13 + 109 , 19 @ @ public class SyncTestUtils { <nl> return AuthenticateResponse . from ( new ObjectServerError ( code , " dummy " ) ) ; <nl> } <nl> <nl> + public static Token getRefreshToken ( SyncUser user ) { <nl> + try { <nl> + return ( Token ) SYNC _ USER _ GET _ ACCESS _ TOKEN _ METHOD . invoke ( user ) ; <nl> + } catch ( IllegalAccessException | InvocationTargetException e ) { <nl> + throw new AssertionError ( e ) ; <nl> + } <nl> + } <nl> + <nl> private static void addToUserStore ( SyncUser user ) { <nl> try { <nl> UserStore userStore = ( UserStore ) SYNC _ MANAGER _ GET _ USER _ STORE _ METHOD . invoke ( null ) ; <nl> userStore . put ( user ) ; <nl> - } catch ( InvocationTargetException e ) { <nl> - throw new AssertionError ( e ) ; <nl> - } catch ( IllegalAccessException e ) { <nl> + } catch ( InvocationTargetException | IllegalAccessException e ) { <nl> throw new AssertionError ( e ) ; <nl> } <nl> } <nl> diff - - git a / realm / realm - library / src / objectServer / java / io / realm / SyncSession . java b / realm / realm - library / src / objectServer / java / io / realm / SyncSession . java <nl> index 4387d8e . . 102eaba 100644 <nl> - - - a / realm / realm - library / src / objectServer / java / io / realm / SyncSession . java <nl> + + + b / realm / realm - library / src / objectServer / java / io / realm / SyncSession . java <nl> @ @ - 504 , 7 + 504 , 7 @ @ public class SyncSession { <nl> try { <nl> JSONObject refreshTokenJSON = new JSONObject ( refreshToken ) ; <nl> Token newRefreshToken = Token . from ( refreshTokenJSON . getJSONObject ( " userToken " ) ) ; <nl> - if ( newRefreshToken . hashCode ( ) ! = getUser ( ) . getAccessToken ( ) . hashCode ( ) ) { <nl> + if ( newRefreshToken . hashCode ( ) ! = getUser ( ) . getRefreshToken ( ) . hashCode ( ) ) { <nl> RealmLog . debug ( " Session [ % s ] : Access token updated " , configuration . getPath ( ) ) ; <nl> getUser ( ) . setRefreshToken ( newRefreshToken ) ; <nl> } <nl> @ @ - 551 , 7 + 551 , 7 @ @ public class SyncSession { <nl> protected AuthenticateResponse execute ( ) { <nl> if ( ! isClosed & & ! Thread . currentThread ( ) . isInterrupted ( ) ) { <nl> return authServer . loginToRealm ( <nl> - getUser ( ) . getAccessToken ( ) , / / refresh token in fact <nl> + getUser ( ) . getRefreshToken ( ) , / / refresh token in fact <nl> configuration . getServerUrl ( ) , <nl> getUser ( ) . getAuthenticationUrl ( ) <nl> ) ; <nl> @ @ - 629 , 7 + 629 , 7 @ @ public class SyncSession { <nl> @ Override <nl> protected AuthenticateResponse execute ( ) { <nl> if ( ! isClosed & & ! Thread . currentThread ( ) . isInterrupted ( ) ) { <nl> - return authServer . refreshUser ( getUser ( ) . getAccessToken ( ) , configuration . getServerUrl ( ) , getUser ( ) . getAuthenticationUrl ( ) ) ; <nl> + return authServer . refreshUser ( getUser ( ) . getRefreshToken ( ) , configuration . getServerUrl ( ) , getUser ( ) . getAuthenticationUrl ( ) ) ; <nl> } <nl> return null ; <nl> } <nl> diff - - git a / realm / realm - library / src / objectServer / java / io / realm / SyncUser . java b / realm / realm - library / src / objectServer / java / io / realm / SyncUser . java <nl> index 2b24ec2 . . 0a69915 100644 <nl> - - - a / realm / realm - library / src / objectServer / java / io / realm / SyncUser . java <nl> + + + b / realm / realm - library / src / objectServer / java / io / realm / SyncUser . java <nl> @ @ - 47 , 7 + 47 , 6 @ @ import io . realm . internal . network . LogoutResponse ; <nl> import io . realm . internal . network . LookupUserIdResponse ; <nl> import io . realm . internal . objectserver . Token ; <nl> import io . realm . internal . permissions . ManagementModule ; <nl> - import io . realm . internal . permissions . PermissionModule ; <nl> import io . realm . log . RealmLog ; <nl> <nl> / * * <nl> @ @ - 221 , 9 + 220 , 9 @ @ public class SyncUser { <nl> * @ return representation of the async task that can be used to cancel it if needed . <nl> * @ throws IllegalArgumentException if not on a Looper thread . <nl> * / <nl> - public static RealmAsyncTask loginAsync ( final SyncCredentials credentials , final String authenticationUrl , final Callback callback ) { <nl> + public static RealmAsyncTask loginAsync ( final SyncCredentials credentials , final String authenticationUrl , final Callback < SyncUser > callback ) { <nl> checkLooperThread ( " Asynchronous login is only possible from looper threads . " ) ; <nl> - return new Request ( SyncManager . NETWORK _ POOL _ EXECUTOR , callback ) { <nl> + return new Request < SyncUser > ( SyncManager . NETWORK _ POOL _ EXECUTOR , callback ) { <nl> @ Override <nl> public SyncUser run ( ) throws ObjectServerError { <nl> return login ( credentials , authenticationUrl ) ; <nl> @ @ - 375 , 13 + 374 , 13 @ @ public class SyncUser { <nl> * @ return representation of the async task that can be used to cancel it if needed . <nl> * @ throws IllegalArgumentException if not on a Looper thread . <nl> * / <nl> - public RealmAsyncTask changePasswordAsync ( final String newPassword , final Callback callback ) { <nl> + public RealmAsyncTask changePasswordAsync ( final String newPassword , final Callback < SyncUser > callback ) { <nl> checkLooperThread ( " Asynchronous changing password is only possible from looper threads . " ) ; <nl> / / noinspection ConstantConditions <nl> if ( callback = = null ) { <nl> throw new IllegalArgumentException ( " Non - null ' callback ' required . " ) ; <nl> } <nl> - return new Request ( SyncManager . NETWORK _ POOL _ EXECUTOR , callback ) { <nl> + return new Request < SyncUser > ( SyncManager . NETWORK _ POOL _ EXECUTOR , callback ) { <nl> @ Override <nl> public SyncUser run ( ) { <nl> changePassword ( newPassword ) ; <nl> @ @ - 405 , 14 + 404 , 14 @ @ public class SyncUser { <nl> * @ return representation of the async task that can be used to cancel it if needed . <nl> * @ throws IllegalArgumentException if not on a Looper thread . <nl> * / <nl> - public RealmAsyncTask changePasswordAsync ( final String userId , final String newPassword , final Callback callback ) { <nl> + public RealmAsyncTask changePasswordAsync ( final String userId , final String newPassword , final Callback < SyncUser > callback ) { <nl> checkLooperThread ( " Asynchronous changing password is only possible from looper threads . " ) ; <nl> / / noinspection ConstantConditions <nl> if ( callback = = null ) { <nl> throw new IllegalArgumentException ( " Non - null ' callback ' required . " ) ; <nl> } <nl> <nl> - return new Request ( SyncManager . NETWORK _ POOL _ EXECUTOR , callback ) { <nl> + return new Request < SyncUser > ( SyncManager . NETWORK _ POOL _ EXECUTOR , callback ) { <nl> @ Override <nl> public SyncUser run ( ) { <nl> changePassword ( userId , newPassword ) ; <nl> @ @ - 470 , 7 + 469 , 7 @ @ public class SyncUser { <nl> * as this method is called on . <nl> * @ return representation of the async task that can be used to cancel it if needed . <nl> * / <nl> - public RealmAsyncTask retrieveInfoForUserAsync ( final String providerUserIdentity , final String provider , final RequestCallback < SyncUserInfo > callback ) { <nl> + public RealmAsyncTask retrieveInfoForUserAsync ( final String providerUserIdentity , final String provider , final Callback < SyncUserInfo > callback ) { <nl> checkLooperThread ( " Asynchronously retrieving user is only possible from looper threads . " ) ; <nl> / / noinspection ConstantConditions <nl> if ( callback = = null ) { <nl> @ @ - 478 , 12 + 477 , 8 @ @ public class SyncUser { <nl> } <nl> <nl> return new Request < SyncUserInfo > ( SyncManager . NETWORK _ POOL _ EXECUTOR , callback ) { <nl> - / / TODO remove this override on next major release when we remove the deprecated Callback <nl> @ Override <nl> - public SyncUser run ( ) { return null ; } <nl> - <nl> - @ Override <nl> - public SyncUserInfo execute ( ) throws ObjectServerError { <nl> + public SyncUserInfo run ( ) throws ObjectServerError { <nl> return retrieveInfoForUser ( providerUserIdentity , provider ) ; <nl> } <nl> } . start ( ) ; <nl> @ @ - 553 , 12 + 548 , 12 @ @ public class SyncUser { <nl> } <nl> <nl> / * * <nl> - * Returns this user ' s access token . This is the users credential for accessing the Realm Object Server and should <nl> + * Returns this user ' s refresh token . This is the users credential for accessing the Realm Object Server and should <nl> * be treated as sensitive data . <nl> * <nl> - * @ return the user ' s access token . If this user has logged out or the login has expired { @ code null } is returned . <nl> + * @ return the user ' s refresh token . If this user has logged out or the login has expired { @ code null } is returned . <nl> * / <nl> - public Token getAccessToken ( ) { <nl> + Token getRefreshToken ( ) { <nl> return refreshToken ; <nl> } <nl> <nl> @ @ - 685 , 32 + 680 , 19 @ @ public class SyncUser { <nl> / / Class wrapping requests made against the auth server . Is also responsible for calling with success / error on the <nl> / / correct thread . <nl> private static abstract class Request < T > { <nl> - <nl> @ Nullable <nl> - private final Callback callback ; <nl> - @ Nullable <nl> - private final RequestCallback < T > genericCallback ; <nl> + private final Callback < T > callback ; <nl> private final RealmNotifier handler ; <nl> private final ThreadPoolExecutor networkPoolExecutor ; <nl> <nl> - Request ( ThreadPoolExecutor networkPoolExecutor , @ Nullable Callback callback ) { <nl> + Request ( ThreadPoolExecutor networkPoolExecutor , @ Nullable Callback < T > callback ) { <nl> this . callback = callback ; <nl> - this . genericCallback = null ; <nl> - this . handler = new AndroidRealmNotifier ( null , new AndroidCapabilities ( ) ) ; <nl> - this . networkPoolExecutor = networkPoolExecutor ; <nl> - } <nl> - <nl> - Request ( ThreadPoolExecutor networkPoolExecutor , @ Nullable RequestCallback < T > callback ) { <nl> - this . callback = null ; <nl> - this . genericCallback = callback ; <nl> this . handler = new AndroidRealmNotifier ( null , new AndroidCapabilities ( ) ) ; <nl> this . networkPoolExecutor = networkPoolExecutor ; <nl> } <nl> <nl> / / Implements the request . Return the current sync user if the request succeeded . Otherwise throw an error . <nl> - public abstract SyncUser run ( ) throws ObjectServerError ; <nl> - / / TODO next major release , remove run , rename execute to run and make it abstract <nl> - public T execute ( ) throws ObjectServerError { return null ; } <nl> + public abstract T run ( ) throws ObjectServerError ; <nl> <nl> / / Start the request <nl> public RealmAsyncTask start ( ) { <nl> @ @ - 718 , 13 + 700 , 7 @ @ public class SyncUser { <nl> @ Override <nl> public void run ( ) { <nl> try { <nl> - / / co - exist the old and new callback <nl> - if ( genericCallback ! = null ) { <nl> - postSuccess ( Request . this . execute ( ) ) ; <nl> - } else { <nl> - postSuccess ( Request . this . run ( ) ) ; <nl> - } <nl> - <nl> + postSuccess ( Request . this . run ( ) ) ; <nl> } catch ( ObjectServerError e ) { <nl> postError ( e ) ; <nl> } catch ( Throwable e ) { <nl> @ @ - 752 , 45 + 728 , 19 @ @ public class SyncUser { <nl> } <nl> } <nl> <nl> - private void postSuccess ( final SyncUser user ) { <nl> - if ( callback ! = null ) { <nl> - handler . post ( new Runnable ( ) { <nl> - @ Override <nl> - public void run ( ) { <nl> - callback . onSuccess ( user ) ; <nl> - } <nl> - } ) ; <nl> - } <nl> - } <nl> - <nl> private void postSuccess ( final T result ) { <nl> - if ( genericCallback ! = null ) { <nl> + if ( callback ! = null ) { <nl> handler . post ( new Runnable ( ) { <nl> @ Override <nl> public void run ( ) { <nl> - genericCallback . onSuccess ( result ) ; <nl> + callback . onSuccess ( result ) ; <nl> } <nl> } ) ; <nl> } <nl> } <nl> } <nl> <nl> - / / TODO remove and replace uses by RequestCallback on next major release <nl> - public interface Callback { <nl> - / * * <nl> - * @ deprecated as per 3 . 6 . 0 release , replaced by { @ link RequestCallback # onSuccess ( Object ) } <nl> - * / <nl> - @ Deprecated <nl> - void onSuccess ( SyncUser user ) ; <nl> - <nl> - / * * <nl> - * @ deprecated as per 3 . 6 . 0 release , replaced by { @ link RequestCallback # onError ( ObjectServerError ) } <nl> - * / <nl> - @ Deprecated <nl> - void onError ( ObjectServerError error ) ; <nl> - } <nl> - <nl> - public interface RequestCallback < T > { <nl> + public interface Callback < T > { <nl> void onSuccess ( T result ) ; <nl> <nl> void onError ( ObjectServerError error ) ; <nl> diff - - git a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / AuthTests . java b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / AuthTests . java <nl> index 256df2f . . fddc2c5 100644 <nl> - - - a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / AuthTests . java <nl> + + + b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / AuthTests . java <nl> @ @ - 40 , 6 + 40 , 7 @ @ import io . realm . objectserver . utils . Constants ; <nl> import io . realm . objectserver . utils . StringOnlyModule ; <nl> import io . realm . objectserver . utils . UserFactory ; <nl> import io . realm . rule . RunTestInLooperThread ; <nl> + import io . realm . util . SyncTestUtils ; <nl> <nl> import static junit . framework . Assert . assertEquals ; <nl> import static junit . framework . Assert . assertNotNull ; <nl> @ @ - 74 , 7 + 75 , 7 @ @ public class AuthTests extends StandardIntegrationTest { <nl> @ RunTestInLooperThread <nl> public void loginAsync _ userNotExist ( ) { <nl> SyncCredentials credentials = SyncCredentials . usernamePassword ( " IWantToHackYou " , " GeneralPassword " , false ) ; <nl> - SyncUser . loginAsync ( credentials , Constants . AUTH _ URL , new SyncUser . Callback ( ) { <nl> + SyncUser . loginAsync ( credentials , Constants . AUTH _ URL , new SyncUser . Callback < SyncUser > ( ) { <nl> @ Override <nl> public void onSuccess ( SyncUser user ) { <nl> fail ( ) ; <nl> @ @ - 93 , 7 + 94 , 7 @ @ public class AuthTests extends StandardIntegrationTest { <nl> public void login _ newUser ( ) { <nl> String userId = UUID . randomUUID ( ) . toString ( ) ; <nl> SyncCredentials credentials = SyncCredentials . usernamePassword ( userId , " password " , true ) ; <nl> - SyncUser . loginAsync ( credentials , Constants . AUTH _ URL , new SyncUser . Callback ( ) { <nl> + SyncUser . loginAsync ( credentials , Constants . AUTH _ URL , new SyncUser . Callback < SyncUser > ( ) { <nl> @ Override <nl> public void onSuccess ( SyncUser user ) { <nl> assertFalse ( user . isAdmin ( ) ) ; <nl> @ @ - 116 , 8 + 117 , 8 @ @ public class AuthTests extends StandardIntegrationTest { <nl> @ RunTestInLooperThread <nl> public void login _ withAccessToken ( ) { <nl> SyncUser adminUser = UserFactory . createAdminUser ( Constants . AUTH _ URL ) ; <nl> - SyncCredentials credentials = SyncCredentials . accessToken ( adminUser . getAccessToken ( ) . value ( ) , " custom - admin - user " , adminUser . isAdmin ( ) ) ; <nl> - SyncUser . loginAsync ( credentials , Constants . AUTH _ URL , new SyncUser . Callback ( ) { <nl> + SyncCredentials credentials = SyncCredentials . accessToken ( SyncTestUtils . getRefreshToken ( adminUser ) . value ( ) , " custom - admin - user " , adminUser . isAdmin ( ) ) ; <nl> + SyncUser . loginAsync ( credentials , Constants . AUTH _ URL , new SyncUser . Callback < SyncUser > ( ) { <nl> @ Override <nl> public void onSuccess ( SyncUser user ) { <nl> assertTrue ( user . isAdmin ( ) ) ; <nl> @ @ - 159 , 7 + 160 , 7 @ @ public class AuthTests extends StandardIntegrationTest { <nl> @ Override <nl> public void run ( ) { <nl> SyncCredentials credentials = SyncCredentials . usernamePassword ( " IWantToHackYou " , " GeneralPassword " , false ) ; <nl> - SyncUser . loginAsync ( credentials , Constants . AUTH _ URL , new SyncUser . Callback ( ) { <nl> + SyncUser . loginAsync ( credentials , Constants . AUTH _ URL , new SyncUser . Callback < SyncUser > ( ) { <nl> @ Override <nl> public void onSuccess ( SyncUser user ) { <nl> fail ( ) ; <nl> @ @ - 248 , 7 + 249 , 7 @ @ public class AuthTests extends StandardIntegrationTest { <nl> <nl> / / Change password using admin user <nl> final String newPassword = " new - password " ; <nl> - adminUser . changePasswordAsync ( userOld . getIdentity ( ) , newPassword , new SyncUser . Callback ( ) { <nl> + adminUser . changePasswordAsync ( userOld . getIdentity ( ) , newPassword , new SyncUser . Callback < SyncUser > ( ) { <nl> @ Override <nl> public void onSuccess ( SyncUser administratorUser ) { <nl> assertEquals ( adminUser , administratorUser ) ; <nl> @ @ - 497 , 7 + 498 , 7 @ @ public class AuthTests extends StandardIntegrationTest { <nl> <nl> final SyncCredentials credentials = SyncCredentials . usernamePassword ( uniqueName , " password " , true ) ; <nl> SyncUser user = SyncUser . login ( credentials , Constants . AUTH _ URL ) ; <nl> - final Token revokedRefreshToken = user . getAccessToken ( ) ; <nl> + final Token revokedRefreshToken = SyncTestUtils . getRefreshToken ( user ) ; <nl> <nl> SyncManager . addAuthenticationListener ( new AuthenticationListener ( ) { <nl> @ Override <nl> @ @ - 511 , 11 + 512 , 12 @ @ public class AuthTests extends StandardIntegrationTest { <nl> SyncCredentials credentials = SyncCredentials . usernamePassword ( uniqueName , " password " , false ) ; <nl> SyncUser loggedInUser = SyncUser . login ( credentials , Constants . AUTH _ URL ) ; <nl> <nl> + Token token = SyncTestUtils . getRefreshToken ( loggedInUser ) ; <nl> / / still comparing the same user <nl> - assertEquals ( revokedRefreshToken . identity ( ) , loggedInUser . getAccessToken ( ) . identity ( ) ) ; <nl> + assertEquals ( revokedRefreshToken . identity ( ) , token . identity ( ) ) ; <nl> <nl> / / different tokens <nl> - assertNotEquals ( revokedRefreshToken . value ( ) , loggedInUser . getAccessToken ( ) . value ( ) ) ; <nl> + assertNotEquals ( revokedRefreshToken . value ( ) , token . value ( ) ) ; <nl> SyncManager . removeAuthenticationListener ( this ) ; <nl> userLoggedInAgain . countDown ( ) ; <nl> } <nl> @ @ - 591 , 7 + 593 , 7 @ @ public class AuthTests extends StandardIntegrationTest { <nl> assertNotEquals ( accessToken , newAccessToken ) ; <nl> <nl> / / refresh _ token identity is the same <nl> - assertEquals ( user . getAccessToken ( ) . identity ( ) , newAccessToken . identity ( ) ) ; <nl> + assertEquals ( SyncTestUtils . getRefreshToken ( user ) . identity ( ) , newAccessToken . identity ( ) ) ; <nl> assertEquals ( accessToken . identity ( ) , newAccessToken . identity ( ) ) ; <nl> <nl> realm . close ( ) ; <nl> @ @ - 728 , 7 + 730 , 7 @ @ public class AuthTests extends StandardIntegrationTest { <nl> assertTrue ( adminUser . isAdmin ( ) ) ; <nl> <nl> final String identity = user . getIdentity ( ) ; <nl> - adminUser . retrieveInfoForUserAsync ( username , SyncCredentials . IdentityProvider . USERNAME _ PASSWORD , new SyncUser . RequestCallback < SyncUserInfo > ( ) { <nl> + adminUser . retrieveInfoForUserAsync ( username , SyncCredentials . IdentityProvider . USERNAME _ PASSWORD , new SyncUser . Callback < SyncUserInfo > ( ) { <nl> @ Override <nl> public void onSuccess ( SyncUserInfo userInfo ) { <nl> assertNotNull ( userInfo ) ; <nl> diff - - git a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / EncryptedSynchronizedRealmTests . java b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / EncryptedSynchronizedRealmTests . java <nl> index 7806b41 . . d51f352 100644 <nl> - - - a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / EncryptedSynchronizedRealmTests . java <nl> + + + b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / EncryptedSynchronizedRealmTests . java <nl> @ @ - 24 , 6 + 24 , 7 @ @ import io . realm . exceptions . RealmFileException ; <nl> import io . realm . objectserver . utils . Constants ; <nl> import io . realm . objectserver . utils . StringOnlyModule ; <nl> import io . realm . objectserver . utils . UserFactory ; <nl> + import io . realm . util . SyncTestUtils ; <nl> <nl> import static org . junit . Assert . assertEquals ; <nl> import static org . junit . Assert . assertTrue ; <nl> @ @ - 187 , 7 + 188 , 7 @ @ public class EncryptedSynchronizedRealmTests extends StandardIntegrationTest { <nl> <nl> / / STEP 3 : prepare a synced Realm for client B ( admin user ) <nl> SyncUser admin = UserFactory . createAdminUser ( Constants . AUTH _ URL ) ; <nl> - SyncCredentials credentials = SyncCredentials . accessToken ( admin . getAccessToken ( ) . value ( ) , " custom - admin - user " ) ; <nl> + SyncCredentials credentials = SyncCredentials . accessToken ( SyncTestUtils . getRefreshToken ( admin ) . value ( ) , " custom - admin - user " ) ; <nl> SyncUser adminUser = SyncUser . login ( credentials , Constants . AUTH _ URL ) ; <nl> <nl> final byte [ ] adminRandomKey = TestHelper . getRandomKey ( ) ; <nl> diff - - git a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / SyncSessionTests . java b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / SyncSessionTests . java <nl> index a51e9b9 . . 79dc4e6 100644 <nl> - - - a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / SyncSessionTests . java <nl> + + + b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / SyncSessionTests . java <nl> @ @ - 12 , 16 + 12 , 14 @ @ import org . junit . Rule ; <nl> import org . junit . Test ; <nl> import org . junit . runner . RunWith ; <nl> <nl> - import java . util . concurrent . CountDownLatch ; <nl> import java . util . Arrays ; <nl> import java . util . UUID ; <nl> import java . util . concurrent . CountDownLatch ; <nl> <nl> - import io . realm . BaseIntegrationTest ; <nl> import io . realm . Realm ; <nl> - import io . realm . StandardIntegrationTest ; <nl> import io . realm . RealmChangeListener ; <nl> import io . realm . RealmResults ; <nl> + import io . realm . StandardIntegrationTest ; <nl> import io . realm . SyncConfiguration ; <nl> import io . realm . SyncCredentials ; <nl> import io . realm . SyncManager ; <nl> @ @ - 34 , 10 + 32 , 10 @ @ import io . realm . objectserver . utils . Constants ; <nl> import io . realm . objectserver . utils . StringOnlyModule ; <nl> import io . realm . objectserver . utils . UserFactory ; <nl> import io . realm . rule . TestSyncConfigurationFactory ; <nl> + import io . realm . util . SyncTestUtils ; <nl> <nl> import static org . junit . Assert . assertEquals ; <nl> import static org . junit . Assert . assertFalse ; <nl> - import static org . junit . Assert . assertTrue ; <nl> import static org . junit . Assert . assertNotEquals ; <nl> import static org . junit . Assert . fail ; <nl> <nl> @ @ - 275 , 7 + 273 , 7 @ @ public class SyncSessionTests extends StandardIntegrationTest { <nl> / / access the Realm from an different path on the device ( using admin user ) , then monitor <nl> / / when the offline commits get synchronized <nl> SyncUser admin = UserFactory . createAdminUser ( Constants . AUTH _ URL ) ; <nl> - SyncCredentials credentialsAdmin = SyncCredentials . accessToken ( admin . getAccessToken ( ) . value ( ) , " custom - admin - user " ) ; <nl> + SyncCredentials credentialsAdmin = SyncCredentials . accessToken ( SyncTestUtils . getRefreshToken ( admin ) . value ( ) , " custom - admin - user " ) ; <nl> SyncUser adminUser = SyncUser . login ( credentialsAdmin , Constants . AUTH _ URL ) ; <nl> <nl> SyncConfiguration adminConfig = configurationFactory . createSyncConfigurationBuilder ( adminUser , syncConfiguration . getServerUrl ( ) . toString ( ) ) <nl> @ @ - 349 , 7 + 347 , 7 @ @ public class SyncSessionTests extends StandardIntegrationTest { <nl> public void run ( ) { <nl> / / using an admin user to open the Realm on different path on the device to monitor when all the uploads are done <nl> SyncUser admin = UserFactory . createAdminUser ( Constants . AUTH _ URL ) ; <nl> - SyncCredentials credentialsAdmin = SyncCredentials . accessToken ( admin . getAccessToken ( ) . value ( ) , " custom - admin - user " ) ; <nl> + SyncCredentials credentialsAdmin = SyncCredentials . accessToken ( SyncTestUtils . getRefreshToken ( admin ) . value ( ) , " custom - admin - user " ) ; <nl> SyncUser adminUser = SyncUser . login ( credentialsAdmin , Constants . AUTH _ URL ) ; <nl> <nl> SyncConfiguration adminConfig = configurationFactory . createSyncConfigurationBuilder ( adminUser , syncConfiguration . getServerUrl ( ) . toString ( ) ) <nl> @ @ - 420 , 7 + 418 , 7 @ @ public class SyncSessionTests extends StandardIntegrationTest { <nl> public void run ( ) { <nl> / / using an admin user to open the Realm on different path on the device then some commits <nl> SyncUser admin = UserFactory . createAdminUser ( Constants . AUTH _ URL ) ; <nl> - SyncCredentials credentialsAdmin = SyncCredentials . accessToken ( admin . getAccessToken ( ) . value ( ) , " custom - admin - user " ) ; <nl> + SyncCredentials credentialsAdmin = SyncCredentials . accessToken ( SyncTestUtils . getRefreshToken ( admin ) . value ( ) , " custom - admin - user " ) ; <nl> SyncUser adminUser = SyncUser . login ( credentialsAdmin , Constants . AUTH _ URL ) ; <nl> <nl> SyncConfiguration adminConfig = configurationFactory . createSyncConfigurationBuilder ( adminUser , syncConfiguration . getServerUrl ( ) . toString ( ) )
NEAREST DIFF (one line): diff - - git a / README . md b / README . md <nl> index ee52154 . . 268af42 100644 <nl> - - - a / README . md <nl> + + + b / README . md <nl> @ @ - 220 , 6 + 220 , 9 @ @ To run a testing server locally : <nl> 	 . / gradlew connectedObjectServerDebugAndroidTest <nl> 	 ` ` ` <nl> <nl> + Note that if using VirtualBox ( Genymotion ) , the network needs to be bridged for the tests to work . <nl> + This is done in ` VirtualBox > Network ` . Set " Adapter 2 " to " Bridged Adapter " . <nl> + <nl> These tests may take as much as half an hour to complete . <nl> <nl> # # Contributing <nl> diff - - git a / realm / realm - library / src / androidTest / AndroidManifest . xml b / realm / realm - library / src / androidTest / AndroidManifest . xml <nl> index c7741a6 . . d9e252d 100644 <nl> - - - a / realm / realm - library / src / androidTest / AndroidManifest . xml <nl> + + + b / realm / realm - library / src / androidTest / AndroidManifest . xml <nl> @ @ - 21 , 6 + 21 , 23 @ @ <nl> android : exported = " true " <nl> android : process = " : remote " > <nl> < / service > <nl> + <nl> + < ! - - <nl> + FIXME : Manifest merger doesn ' t seem to work correctly with test flavours . <nl> + Figure out why . For now place services here <nl> + - - > <nl> + < service <nl> + android : name = " io . realm . objectserver . service . SendOneCommit " <nl> + android : enabled = " true " <nl> + android : exported = " true " <nl> + android : process = " : remote " > <nl> + < / service > <nl> + < service <nl> + android : name = " io . realm . objectserver . service . SendsALot " <nl> + android : enabled = " true " <nl> + android : exported = " true " <nl> + android : process = " : remote " > <nl> + < / service > <nl> < / application > <nl> <nl> < / manifest > <nl> diff - - git a / realm / realm - library / src / androidTestObjectServer / java / io / realm / SyncUserTests . java b / realm / realm - library / src / androidTestObjectServer / java / io / realm / SyncUserTests . java <nl> index a587ca1 . . c31ea68 100644 <nl> - - - a / realm / realm - library / src / androidTestObjectServer / java / io / realm / SyncUserTests . java <nl> + + + b / realm / realm - library / src / androidTestObjectServer / java / io / realm / SyncUserTests . java <nl> @ @ - 23 , 6 + 23 , 7 @ @ import org . junit . Before ; <nl> import org . junit . Rule ; <nl> import org . junit . Test ; <nl> import org . junit . runner . RunWith ; <nl> + import org . mockito . Mockito ; <nl> <nl> import java . net . MalformedURLException ; <nl> import java . net . URI ; <nl> @ @ - 31 , 6 + 32 , 7 @ @ import java . net . URL ; <nl> import java . util . Collection ; <nl> <nl> import io . realm . android . SharedPrefsUserStore ; <nl> + import io . realm . internal . network . AuthenticationServer ; <nl> import io . realm . rule . RunInLooperThread ; <nl> import io . realm . util . SyncTestUtils ; <nl> <nl> @ @ - 39 , 6 + 41 , 8 @ @ import static junit . framework . Assert . assertEquals ; <nl> import static org . junit . Assert . assertNotNull ; <nl> import static org . junit . Assert . assertNull ; <nl> import static org . junit . Assert . assertTrue ; <nl> + import static org . mockito . Matchers . any ; <nl> + import static org . mockito . Mockito . when ; <nl> <nl> @ RunWith ( AndroidJUnit4 . class ) <nl> public class SyncUserTests { <nl> @ @ - 151 , 4 + 155 , 19 @ @ public class SyncUserTests { <nl> assertTrue ( str ! = null & & ! str . isEmpty ( ) ) ; <nl> } <nl> <nl> + / / Test that a login an access token logs the user in directly without touching the network <nl> + @ Test <nl> + public void login _ withAccessToken ( ) { <nl> + AuthenticationServer authServer = Mockito . mock ( AuthenticationServer . class ) ; <nl> + when ( authServer . loginUser ( any ( SyncCredentials . class ) , any ( URL . class ) ) ) . thenThrow ( new AssertionError ( " Server contacted . " ) ) ; <nl> + AuthenticationServer originalServer = SyncManager . getAuthServer ( ) ; <nl> + SyncManager . setAuthServerImpl ( authServer ) ; <nl> + try { <nl> + SyncCredentials credentials = SyncCredentials . accessToken ( " foo " , " bar " ) ; <nl> + SyncUser user = SyncUser . login ( credentials , " http : / / ros . realm . io / auth " ) ; <nl> + assertTrue ( user . isValid ( ) ) ; <nl> + } finally { <nl> + SyncManager . setAuthServerImpl ( originalServer ) ; <nl> + } <nl> + } <nl> } <nl> diff - - git a / realm / realm - library / src / objectServer / java / io / realm / SyncCredentials . java b / realm / realm - library / src / objectServer / java / io / realm / SyncCredentials . java <nl> index 827f126 . . b9dcbc4 100644 <nl> - - - a / realm / realm - library / src / objectServer / java / io / realm / SyncCredentials . java <nl> + + + b / realm / realm - library / src / objectServer / java / io / realm / SyncCredentials . java <nl> @ @ - 151 , 6 + 151 , 23 @ @ public class SyncCredentials { <nl> return new SyncCredentials ( identityProvider , userIdentifier , userInfo ) ; <nl> } <nl> <nl> + / * * <nl> + * Creates credentials from an existing access token . Since an access token is the proof that a user already <nl> + * has logged in . Credentials created this way are automatically assumed to have successfully logged in . <nl> + * This means that providing this credential to { @ link SyncUser # login ( SyncCredentials , String ) } will always <nl> + * succeed , but accessing any Realm after might fail if the token is no longer valid . <nl> + * <nl> + * @ param accessToken Users access token . <nl> + * @ param identifier User identifier . <nl> + * @ return a set of credentials that can be used to log into the Object Server using <nl> + * { @ link SyncUser # loginAsync ( SyncCredentials , String , SyncUser . Callback ) } <nl> + * / <nl> + public static SyncCredentials accessToken ( String accessToken , String identifier ) { <nl> + HashMap < String , Object > userInfo = new HashMap < String , Object > ( ) ; <nl> + userInfo . put ( " _ token " , accessToken ) ; <nl> + return new SyncCredentials ( IdentityProvider . ACCESS _ TOKEN , identifier , userInfo ) ; <nl> + } <nl> + <nl> private SyncCredentials ( String identityProvider , String token , Map < String , Object > userInfo ) { <nl> this . identityProvider = identityProvider ; <nl> this . userIdentifier = token ; <nl> @ @ - 191 , 6 + 208 , 14 @ @ public class SyncCredentials { <nl> * verifying that a given credential is valid . <nl> * / <nl> public static final class IdentityProvider { <nl> + <nl> + / * * <nl> + * The provided identify is an already registered user ( represented by the access token ) . Logging in with this <nl> + * type of identity will happen purely on the device without contacting the Realm Object Server . Acquiring <nl> + * access to individual Realms will still require talking to the Object Server . <nl> + * / <nl> + public static final String ACCESS _ TOKEN = " _ access _ token " ; <nl> + <nl> / * * <nl> * Any credentials verified by the debug identity provider will always be considered valid . <nl> * It is only available if configured on the Object Server , and it is disabled by default . <nl> diff - - git a / realm / realm - library / src / objectServer / java / io / realm / SyncUser . java b / realm / realm - library / src / objectServer / java / io / realm / SyncUser . java <nl> index 65130e7 . . 379c3dd 100644 <nl> - - - a / realm / realm - library / src / objectServer / java / io / realm / SyncUser . java <nl> + + + b / realm / realm - library / src / objectServer / java / io / realm / SyncUser . java <nl> @ @ - 31 , 6 + 31 , 7 @ @ import java . net . URL ; <nl> import java . util . ArrayList ; <nl> import java . util . Collection ; <nl> import java . util . List ; <nl> + import java . util . Objects ; <nl> import java . util . concurrent . Future ; <nl> import java . util . concurrent . ThreadPoolExecutor ; <nl> <nl> @ @ - 150 , 10 + 151 , 20 @ @ public class SyncUser { <nl> throw new IllegalArgumentException ( " Invalid URL " + authenticationUrl + " . " , e ) ; <nl> } <nl> <nl> - final AuthenticationServer server = SyncManager . getAuthServer ( ) ; <nl> ObjectServerError error ; <nl> try { <nl> - AuthenticateResponse result = server . loginUser ( credentials , authUrl ) ; <nl> + AuthenticateResponse result ; <nl> + if ( credentials . getIdentityProvider ( ) . equals ( SyncCredentials . IdentityProvider . ACCESS _ TOKEN ) ) { <nl> + / / Credentials using ACCESS _ TOKEN as IdentityProvider are optimistically assumed to be valid already <nl> + / / So log them in directly without contacting the authentication server . This is done by mirroring <nl> + / / the JSON response expected from the server . <nl> + String userIdentifier = credentials . getUserIdentifier ( ) ; <nl> + String token = ( String ) credentials . getUserInfo ( ) . get ( " _ token " ) ; <nl> + result = AuthenticateResponse . createValidResponseWithUser ( userIdentifier , token ) ; <nl> + } else { <nl> + final AuthenticationServer server = SyncManager . getAuthServer ( ) ; <nl> + result = server . loginUser ( credentials , authUrl ) ; <nl> + } <nl> if ( result . isValid ( ) ) { <nl> ObjectServerUser syncUser = new ObjectServerUser ( result . getRefreshToken ( ) , authUrl ) ; <nl> SyncUser user = new SyncUser ( syncUser ) ; <nl> diff - - git a / realm / realm - library / src / objectServer / java / io / realm / internal / network / AuthenticateResponse . java b / realm / realm - library / src / objectServer / java / io / realm / internal / network / AuthenticateResponse . java <nl> index 75e31a0 . . 9408a55 100644 <nl> - - - a / realm / realm - library / src / objectServer / java / io / realm / internal / network / AuthenticateResponse . java <nl> + + + b / realm / realm - library / src / objectServer / java / io / realm / internal / network / AuthenticateResponse . java <nl> @ @ - 75 , 6 + 75 , 24 @ @ public class AuthenticateResponse extends AuthServerResponse { <nl> } <nl> <nl> / * * <nl> + * Helper method for creating a valid user login response . The user returned will be assumed to have all permissions <nl> + * as doesn ' t expire . <nl> + * <nl> + * @ param identifier User identifier . <nl> + * @ param token Users refresh token . <nl> + * @ return Response <nl> + * / <nl> + public static AuthenticateResponse createValidResponseWithUser ( String identifier , String token ) { <nl> + try { <nl> + JSONObject response = new JSONObject ( ) ; <nl> + response . put ( JSON _ FIELD _ REFRESH _ TOKEN , new Token ( token , identifier , null , Long . MAX _ VALUE , Token . Permission . ALL ) . toJson ( ) ) ; <nl> + return new AuthenticateResponse ( response . toString ( ) ) ; <nl> + } catch ( JSONException e ) { <nl> + throw new RuntimeException ( e ) ; <nl> + } <nl> + } <nl> + <nl> + / * * <nl> * Creates an unsuccessful authentication response . This should only happen in case of network or I / O related <nl> * issues . <nl> * <nl> diff - - git a / realm / realm - library / src / objectServer / java / io / realm / internal / objectserver / Token . java b / realm / realm - library / src / objectServer / java / io / realm / internal / objectserver / Token . java <nl> index 78f0acf . . 3ae10a2 100644 <nl> - - - a / realm / realm - library / src / objectServer / java / io / realm / internal / objectserver / Token . java <nl> + + + b / realm / realm - library / src / objectServer / java / io / realm / internal / objectserver / Token . java <nl> @ @ - 151 , 5 + 151 , 7 @ @ public class Token { <nl> DOWNLOAD , <nl> REFRESH , <nl> MANAGE ; <nl> + <nl> + public static final Permission [ ] ALL = { UPLOAD , DOWNLOAD , REFRESH , MANAGE } ; <nl> } <nl> } <nl> diff - - git a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / AuthTests . java b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / AuthTests . java <nl> index ccf997a . . a38b774 100644 <nl> - - - a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / AuthTests . java <nl> + + + b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / AuthTests . java <nl> @ @ - 9 , 6 + 9 , 8 @ @ import org . junit . Rule ; <nl> import org . junit . Test ; <nl> import org . junit . runner . RunWith ; <nl> <nl> + import io . realm . RealmConfiguration ; <nl> + import io . realm . SyncConfiguration ; <nl> import io . realm . SyncCredentials ; <nl> import io . realm . ErrorCode ; <nl> import io . realm . ObjectServerError ; <nl> @ @ - 66 , 4 + 68 , 21 @ @ public class AuthTests { <nl> } <nl> } ) ; <nl> } <nl> + <nl> + @ Test <nl> + @ RunTestInLooperThread <nl> + public void login _ withAccessToken ( ) { <nl> + SyncCredentials credentials = SyncCredentials . accessToken ( Constants . USER _ TOKEN , " access - token - user " ) ; <nl> + SyncUser . loginAsync ( credentials , Constants . AUTH _ URL , new SyncUser . Callback ( ) { <nl> + @ Override <nl> + public void onSuccess ( SyncUser user ) { <nl> + SyncConfiguration config = new SyncConfiguration . Builder ( user , Constants . SYNC _ SERVER _ URL ) . build ( ) ; <nl> + } <nl> + <nl> + @ Override <nl> + public void onError ( ObjectServerError error ) { <nl> + fail ( " Error thrown : " + error ) ; <nl> + } <nl> + } ) ; <nl> + } <nl> } <nl> diff - - git a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / ProcessCommitTests . java b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / ProcessCommitTests . java <nl> index 6e465f5 . . 73df932 100644 <nl> - - - a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / ProcessCommitTests . java <nl> + + + b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / ProcessCommitTests . java <nl> @ @ - 24 , 6 + 24 , 7 @ @ import android . support . test . runner . AndroidJUnit4 ; <nl> <nl> import org . junit . AfterClass ; <nl> import org . junit . BeforeClass ; <nl> + import org . junit . Ignore ; <nl> import org . junit . Test ; <nl> import org . junit . runner . RunWith ; <nl> <nl> @ @ - 32 , 16 + 33 , 20 @ @ import java . util . concurrent . ExecutorService ; <nl> import java . util . concurrent . Executors ; <nl> import java . util . concurrent . TimeUnit ; <nl> <nl> + import io . realm . ObjectServerError ; <nl> import io . realm . Realm ; <nl> import io . realm . RealmChangeListener ; <nl> import io . realm . RealmResults ; <nl> import io . realm . SyncConfiguration ; <nl> + import io . realm . SyncSession ; <nl> + import io . realm . SyncUser ; <nl> import io . realm . objectserver . model . ProcessInfo ; <nl> import io . realm . objectserver . model . TestObject ; <nl> import io . realm . objectserver . service . SendOneCommit ; <nl> import io . realm . objectserver . service . SendsALot ; <nl> import io . realm . objectserver . utils . Constants ; <nl> import io . realm . objectserver . utils . HttpUtils ; <nl> + import io . realm . objectserver . utils . UserFactory ; <nl> <nl> import static org . junit . Assert . assertEquals ; <nl> import static org . junit . Assert . fail ; <nl> @ @ - 50 , 6 + 55 , 7 @ @ import static org . junit . Assert . fail ; <nl> public class ProcessCommitTests { <nl> @ BeforeClass <nl> public static void setUp ( ) throws Exception { <nl> + Realm . init ( InstrumentationRegistry . getContext ( ) ) ; <nl> HttpUtils . startSyncServer ( ) ; <nl> } <nl> <nl> @ @ - 58 , 15 + 64 , 10 @ @ public class ProcessCommitTests { <nl> HttpUtils . stopSyncServer ( ) ; <nl> } <nl> <nl> - / / FIXME : At least need one method in the test class <nl> - @ Test <nl> - public void dummy ( ) { <nl> - <nl> - } <nl> - <nl> - / / FIXME : Disable for now . <nl> - / * <nl> + / / FIXME : Ignore for now . They do still not work . It might be caused by two processes each creating <nl> + / / a Sync Client , but it needs to be investigated . <nl> @ Test <nl> + @ Ignore <nl> public void expectServerCommit ( ) throws Throwable { <nl> final Throwable [ ] exception = new Throwable [ 1 ] ; <nl> final CountDownLatch testFinished = new CountDownLatch ( 1 ) ; <nl> @ @ - 76 , 18 + 77 , 23 @ @ public class ProcessCommitTests { <nl> public void run ( ) { <nl> try { <nl> Looper . prepare ( ) ; <nl> - Context targetContext = InstrumentationRegistry . getInstrumentation ( ) . getTargetContext ( ) ; <nl> + Context targetContext = InstrumentationRegistry . getTargetContext ( ) ; <nl> <nl> - final SyncConfiguration syncConfig = new SyncConfiguration . Builder ( ) <nl> + SyncUser user = UserFactory . createDefaultUser ( Constants . AUTH _ URL , Constants . USER _ TOKEN ) ; <nl> + String realmUrl = Constants . SYNC _ SERVER _ URL ; <nl> + final SyncConfiguration syncConfig = new SyncConfiguration . Builder ( user , realmUrl ) <nl> . name ( SendOneCommit . class . getSimpleName ( ) ) <nl> - . serverUrl ( Constants . SYNC _ SERVER _ URL ) <nl> - . user ( UserFactory . createDefaultUser ( Constants . SYNC _ SERVER _ URL , Constants . USER _ TOKEN ) ) <nl> + . errorHandler ( new SyncSession . ErrorHandler ( ) { <nl> + @ Override <nl> + public void onError ( SyncSession session , ObjectServerError error ) { <nl> + fail ( " Sync failure : " + error ) ; <nl> + } <nl> + } ) <nl> . build ( ) ; <nl> Realm . deleteRealm ( syncConfig ) ; / / TODO do this in Rule as async tests <nl> final Realm realm = Realm . getInstance ( syncConfig ) ; <nl> Intent intent = new Intent ( targetContext , SendOneCommit . class ) ; <nl> targetContext . startService ( intent ) ; <nl> - <nl> final RealmResults < ProcessInfo > all = realm . where ( ProcessInfo . class ) . findAll ( ) ; <nl> all . addChangeListener ( new RealmChangeListener < RealmResults < ProcessInfo > > ( ) { <nl> @ Override <nl> @ @ - 113 , 14 + 119 , 15 @ @ public class ProcessCommitTests { <nl> fail ( " Test timed out " ) ; <nl> } <nl> } <nl> - * / <nl> <nl> + / / FIXME : Ignore for now . They do still not work . It might be caused by two processes each creating <nl> + / / a Sync Client , but it needs to be investigated . <nl> / / TODO send string from service and match <nl> / / replicate integration tests from Cocoa <nl> / / add gradle task to start the sh script automatically ( create pid file , = = > run or kill existing process <nl> / / check the requirement for the issue again <nl> - / * <nl> @ Test <nl> + @ Ignore <nl> public void expectALot ( ) throws Throwable { <nl> final Throwable [ ] exception = new Throwable [ 1 ] ; <nl> final CountDownLatch testFinished = new CountDownLatch ( 1 ) ; <nl> @ @ - 132 , 10 + 139 , 16 @ @ public class ProcessCommitTests { <nl> Looper . prepare ( ) ; <nl> Context targetContext = InstrumentationRegistry . getInstrumentation ( ) . getTargetContext ( ) ; <nl> <nl> - final SyncConfiguration syncConfig = new SyncConfiguration . Builder ( targetContext ) <nl> + SyncUser user = UserFactory . createDefaultUser ( Constants . AUTH _ URL , Constants . USER _ TOKEN ) ; <nl> + String realmUrl = Constants . SYNC _ SERVER _ URL _ 2 ; <nl> + final SyncConfiguration syncConfig = new SyncConfiguration . Builder ( user , realmUrl ) <nl> . name ( SendsALot . class . getSimpleName ( ) ) <nl> - . serverUrl ( Constants . SYNC _ SERVER _ URL _ 2 ) <nl> - . user ( UserFactory . createDefaultUser ( Constants . SYNC _ SERVER _ URL _ 2 , Constants . USER _ TOKEN ) ) <nl> + . errorHandler ( new SyncSession . ErrorHandler ( ) { <nl> + @ Override <nl> + public void onError ( SyncSession session , ObjectServerError error ) { <nl> + fail ( " Sync failure : " + error ) ; <nl> + } <nl> + } ) <nl> . build ( ) ; <nl> Realm . deleteRealm ( syncConfig ) ; / / TODO do this in Rule as async tests <nl> final Realm realm = Realm . getInstance ( syncConfig ) ; <nl> @ @ - 171 , 5 + 184 , 4 @ @ public class ProcessCommitTests { <nl> fail ( " Test timed out " ) ; <nl> } <nl> } <nl> - * / <nl> } <nl> diff - - git a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / service / SendOneCommit . java b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / service / SendOneCommit . java <nl> index 26c4f89 . . 2620be8 100644 <nl> - - - a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / service / SendOneCommit . java <nl> + + + b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / service / SendOneCommit . java <nl> @ @ - 20 , 6 + 20 , 13 @ @ import android . app . Service ; <nl> import android . content . Intent ; <nl> import android . os . IBinder ; <nl> <nl> + import io . realm . Realm ; <nl> + import io . realm . SyncConfiguration ; <nl> + import io . realm . SyncUser ; <nl> + import io . realm . objectserver . model . ProcessInfo ; <nl> + import io . realm . objectserver . utils . Constants ; <nl> + import io . realm . objectserver . utils . UserFactory ; <nl> + <nl> / * * <nl> * Open a sync Realm on a different process , then send one commit . <nl> * / <nl> @ @ - 28 , 12 + 35 , 11 @ @ public class SendOneCommit extends Service { <nl> @ Override <nl> public void onCreate ( ) { <nl> super . onCreate ( ) ; <nl> - / / FIXME : Disable for now <nl> - / * <nl> - final SyncConfiguration syncConfig = new SyncConfiguration . Builder ( this ) <nl> + Realm . init ( getApplicationContext ( ) ) ; <nl> + SyncUser user = UserFactory . createDefaultUser ( Constants . AUTH _ URL , Constants . USER _ TOKEN ) ; <nl> + String realmUrl = Constants . SYNC _ SERVER _ URL ; <nl> + final SyncConfiguration syncConfig = new SyncConfiguration . Builder ( user , realmUrl ) <nl> . name ( SendOneCommit . class . getSimpleName ( ) ) <nl> - . serverUrl ( Constants . SYNC _ SERVER _ URL ) <nl> - . user ( UserFactory . createDefaultUser ( Constants . SYNC _ SERVER _ URL , Constants . USER _ TOKEN ) ) <nl> . build ( ) ; <nl> Realm . deleteRealm ( syncConfig ) ; <nl> Realm realm = Realm . getInstance ( syncConfig ) ; <nl> @ @ - 46 , 10 + 52 , 8 @ @ public class SendOneCommit extends Service { <nl> realm . commitTransaction ( ) ; <nl> <nl> realm . close ( ) ; / / FIXME the close may not give a chance to the sync client to process / upload the changeset <nl> - * / <nl> } <nl> <nl> - <nl> @ Override <nl> public IBinder onBind ( Intent intent ) { <nl> return null ; <nl> diff - - git a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / service / SendsALot . java b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / service / SendsALot . java <nl> index 2bcdd9d . . 27df640 100644 <nl> - - - a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / service / SendsALot . java <nl> + + + b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / service / SendsALot . java <nl> @ @ - 20 , 6 + 20 , 13 @ @ import android . app . Service ; <nl> import android . content . Intent ; <nl> import android . os . IBinder ; <nl> <nl> + import io . realm . Realm ; <nl> + import io . realm . SyncConfiguration ; <nl> + import io . realm . SyncUser ; <nl> + import io . realm . objectserver . model . TestObject ; <nl> + import io . realm . objectserver . utils . Constants ; <nl> + import io . realm . objectserver . utils . UserFactory ; <nl> + <nl> / * * <nl> * Open a sync Realm on a different process , then send one commit . <nl> * / <nl> @ @ - 28 , 13 + 35 , 11 @ @ public class SendsALot extends Service { <nl> @ Override <nl> public void onCreate ( ) { <nl> super . onCreate ( ) ; <nl> - / / FIXME : Disable for now . <nl> - / * <nl> - User user = UserFactory . createDefaultUser ( Constants . SYNC _ SERVER _ URL _ 2 , Constants . USER _ TOKEN ) ; <nl> - final SyncConfiguration syncConfig = new SyncConfiguration . Builder ( user ) <nl> + Realm . init ( getApplicationContext ( ) ) ; <nl> + SyncUser user = UserFactory . createDefaultUser ( Constants . AUTH _ URL , Constants . USER _ TOKEN ) ; <nl> + String realmUrl = Constants . SYNC _ SERVER _ URL _ 2 ; <nl> + final SyncConfiguration syncConfig = new SyncConfiguration . Builder ( user , realmUrl ) <nl> . name ( SendsALot . class . getSimpleName ( ) ) <nl> - . serverUrl ( Constants . SYNC _ SERVER _ URL _ 2 ) <nl> - . user ( ) <nl> . build ( ) ; <nl> Realm . deleteRealm ( syncConfig ) ; <nl> Realm realm = Realm . getInstance ( syncConfig ) ; <nl> @ @ - 49 , 7 + 54 , 6 @ @ public class SendsALot extends Service { <nl> realm . commitTransaction ( ) ; <nl> <nl> realm . close ( ) ; / / FIXME the close may not give a chance to the sync client to process / upload the changeset <nl> - * / <nl> } <nl> <nl> <nl> diff - - git a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / utils / HttpUtils . java b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / utils / HttpUtils . java <nl> index 9b15ae1 . . 1fa4fb9 100644 <nl> - - - a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / utils / HttpUtils . java <nl> + + + b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / utils / HttpUtils . java <nl> @ @ - 16 , 12 + 16 , 17 @ @ <nl> <nl> package io . realm . objectserver . utils ; <nl> <nl> + import android . support . test . InstrumentationRegistry ; <nl> + <nl> import java . io . IOException ; <nl> <nl> + import io . realm . Realm ; <nl> import io . realm . log . RealmLog ; <nl> import okhttp3 . Headers ; <nl> + import okhttp3 . MediaType ; <nl> import okhttp3 . OkHttpClient ; <nl> import okhttp3 . Request ; <nl> + import okhttp3 . RequestBody ; <nl> import okhttp3 . Response ; <nl> <nl> / * * <nl> @ @ - 29 , 7 + 34 , 10 @ @ import okhttp3 . Response ; <nl> * temp directory & start a sync server on it for each unit test . <nl> * / <nl> public class HttpUtils { <nl> - private final static OkHttpClient client = new OkHttpClient ( ) ; <nl> + private final static OkHttpClient client = new OkHttpClient . Builder ( ) <nl> + . retryOnConnectionFailure ( true ) <nl> + . build ( ) ; <nl> + <nl> / / adb reverse tcp : 8888 tcp : 8888 <nl> / / will forward this query to the host , running the integration test server on 8888 <nl> private final static String START _ SERVER = " http : / / 127 . 0 . 0 . 1 : 8888 / start " ; <nl> @ @ - 60 , 20 + 68 , 29 @ @ public class HttpUtils { <nl> / / Checking the server <nl> private static boolean waitAuthServerReady ( ) throws InterruptedException { <nl> int retryTimes = 50 ; <nl> + <nl> + / / Dummy invalid request , which will trigger a 400 ( BAD REQUEST ) , but indicate the auth <nl> + / / server is responsive <nl> Request request = new Request . Builder ( ) <nl> - . url ( Constants . AUTH _ SERVER _ URL ) <nl> + . post ( RequestBody . create ( MediaType . parse ( " application / json ; charset = utf - 8 " ) , " " ) ) <nl> + . url ( Constants . AUTH _ URL ) <nl> . build ( ) ; <nl> <nl> while ( retryTimes ! = 0 ) { <nl> + Response response = null ; <nl> try { <nl> - Response response = client . newCall ( request ) . execute ( ) ; <nl> - if ( response . isSuccessful ( ) ) { <nl> + response = client . newCall ( request ) . execute ( ) ; <nl> + if ( response . code ( ) = = 400 ) { <nl> return true ; <nl> } <nl> RealmLog . error ( " Error response from auth server : % s " , response . toString ( ) ) ; <nl> } catch ( IOException e ) { <nl> RealmLog . error ( e ) ; <nl> Thread . sleep ( 100 ) ; <nl> + } finally { <nl> + if ( response ! = null ) { <nl> + response . close ( ) ; <nl> + } <nl> } <nl> retryTimes - - ; <nl> } <nl> diff - - git a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / utils / UserFactory . java b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / utils / UserFactory . java <nl> index 1ebb2d6 . . 9e6c43d 100644 <nl> - - - a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / utils / UserFactory . java <nl> + + + b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / utils / UserFactory . java <nl> @ @ - 16 , 25 + 16 , 13 @ @ <nl> <nl> package io . realm . objectserver . utils ; <nl> <nl> - import java . net . URI ; <nl> - import java . net . URISyntaxException ; <nl> - <nl> + import io . realm . SyncCredentials ; <nl> import io . realm . SyncUser ; <nl> - import io . realm . objectserver . utils . Constants ; <nl> <nl> / / Must be in ` io . realm . objectserver ` to work around package protected methods . <nl> public class UserFactory { <nl> - / / FIXME : Not working right now . <nl> - / * <nl> - public static User createDefaultUser ( String SERVER _ URL , String USER _ TOKEN ) { <nl> - try { <nl> - User user = User . createLocal ( ) ; <nl> - <nl> - user . addAccessToken ( new URI ( SERVER _ URL ) , USER _ TOKEN ) ; <nl> - return user ; <nl> - } catch ( URISyntaxException e ) { <nl> - throw new RuntimeException ( e ) ; <nl> - } <nl> + public static SyncUser createDefaultUser ( String authUrl , String accessToken ) { <nl> + SyncCredentials credentials = SyncCredentials . accessToken ( accessToken , " sync - integration - user " ) ; <nl> + return SyncUser . login ( credentials , authUrl ) ; <nl> } <nl> - * / <nl> } <nl> diff - - git a / tools / sync _ test _ server / ros - testing - server . js b / tools / sync _ test _ server / ros - testing - server . js <nl> index c182652 . . 6ddef03 100755 <nl> - - - a / tools / sync _ test _ server / ros - testing - server . js <nl> + + + b / tools / sync _ test _ server / ros - testing - server . js <nl> @ @ - 1 , 6 + 1 , 6 @ @ <nl> # ! / usr / bin / env nodejs <nl> <nl> - var winston = require ( ' winston ' ) ; / / logging <nl> + var winston = require ( ' winston ' ) ; / / logging <nl> const temp = require ( ' temp ' ) ; <nl> const spawn = require ( ' child _ process ' ) . spawn ; <nl> var http = require ( ' http ' ) ; <nl> @ @ - 23 , 7 + 23 , 7 @ @ function handleRequest ( request , response ) { <nl> try { <nl> / / log the request on console <nl> winston . log ( request . url ) ; <nl> - / / Disptach <nl> + / / Dispatch <nl> dispatcher . dispatch ( request , response ) ; <nl> } catch ( err ) { <nl> console . log ( err ) ; <nl> diff - - git a / tools / sync _ test _ server / start _ server . sh b / tools / sync _ test _ server / start _ server . sh <nl> index 00930f5 . . 277bb4b 100755 <nl> - - - a / tools / sync _ test _ server / start _ server . sh <nl> + + + b / tools / sync _ test _ server / start _ server . sh <nl> @ @ - 9 , 9 + 9 , 10 @ @ TMP _ DIR = $ ( mktemp - d / tmp / sync - test . XXXX ) | | { echo " Failed to mktemp $ TEST _ TEMP _ <nl> <nl> adb reverse tcp : 7800 tcp : 7800 & & \ <nl> adb reverse tcp : 8080 tcp : 8080 & & \ <nl> + adb reverse tcp : 9080 tcp : 9080 & & \ <nl> adb reverse tcp : 8888 tcp : 8888 | | { echo " Failed to reverse adb port . " ; exit 1 ; } <nl> <nl> docker build $ DOCKERFILE _ DIR - - build - arg ROS _ DE _ VERSION = $ ROS _ DE _ VERSION - t sync - test - server | | { echo " Failed to build Docker image . " ; exit 1 ; } <nl> <nl> echo " See log files in $ TMP _ DIR " <nl> - docker run - p 8080 : 8080 - p 7800 : 7800 - p 8888 : 8888 - v $ TMP _ DIR : / tmp - - name sync - test - server sync - test - server <nl> + docker run - p 9080 : 9080 - p 8080 : 8080 - p 7800 : 7800 - p 8888 : 8888 - v $ TMP _ DIR : / tmp - - name sync - test - server sync - test - server

TEST DIFF:
diff - - git a / CHANGELOG . md b / CHANGELOG . md 
 index e3fee3b . . 0a65e65 100644 
 - - - a / CHANGELOG . md 
 + + + b / CHANGELOG . md 
 @ @ - 7 , 6 + 7 , 8 @ @ 
 * Removed deprecated APIs ` RealmSchema . close ( ) ` and ` RealmObjectSchema . close ( ) ` . Those don ' t have to be called anymore . 
 * Removed deprecated API ` RealmResults . removeChangeListeners ( ) ` . Use ` RealmResults . removeAllChangeListeners ( ) ` instead . 
 * Removed deprecated API ` RealmObject . removeChangeListeners ( ) ` . Use ` RealmObject . removeAllChangeListeners ( ) ` instead . 
 + * ` SyncUser . Callback ` to becomes generic . 
 + * Removed ` SyncUser . getAccessToken ` method from public API , and rename it to ` getRefreshToken ` . 
 
 # # Deprecated 
 
 diff - - git a / examples / objectServerExample / src / main / java / io / realm / examples / objectserver / LoginActivity . java b / examples / objectServerExample / src / main / java / io / realm / examples / objectserver / LoginActivity . java 
 index 73793b1 . . 9bf5479 100644 
 - - - a / examples / objectServerExample / src / main / java / io / realm / examples / objectserver / LoginActivity . java 
 + + + b / examples / objectServerExample / src / main / java / io / realm / examples / objectserver / LoginActivity . java 
 @ @ - 78 , 7 + 78 , 7 @ @ public class LoginActivity extends AppCompatActivity { 
 String password = this . password . getText ( ) . toString ( ) ; 
 
 SyncCredentials creds = SyncCredentials . usernamePassword ( username , password , createUser ) ; 
 - SyncUser . Callback callback = new SyncUser . Callback ( ) { 
 + SyncUser . Callback < SyncUser > callback = new SyncUser . Callback < SyncUser > ( ) { 
 @ Override 
 public void onSuccess ( @ Nonnull SyncUser user ) { 
 progressDialog . dismiss ( ) ; 
 diff - - git a / realm / realm - library / src / androidTestObjectServer / java / io / realm / AuthenticateRequestTests . java b / realm / realm - library / src / androidTestObjectServer / java / io / realm / AuthenticateRequestTests . java 
 index bdadf62 . . a7fff7a 100644 
 - - - a / realm / realm - library / src / androidTestObjectServer / java / io / realm / AuthenticateRequestTests . java 
 + + + b / realm / realm - library / src / androidTestObjectServer / java / io / realm / AuthenticateRequestTests . java 
 @ @ - 39 , 7 + 39 , 7 @ @ public class AuthenticateRequestTests { 
 
 @ Test 
 public void realmLogin ( ) throws URISyntaxException , JSONException { 
 - Token t = SyncTestUtils . createTestUser ( ) . getAccessToken ( ) ; 
 + Token t = SyncTestUtils . createTestUser ( ) . getRefreshToken ( ) ; 
 AuthenticateRequest request = AuthenticateRequest . realmLogin ( t , new URI ( " realm : / / objectserver / " + t . identity ( ) + " / default " ) ) ; 
 
 JSONObject obj = new JSONObject ( request . toJson ( ) ) ; 
 @ @ - 60 , 7 + 60 , 7 @ @ public class AuthenticateRequestTests { 
 
 @ Test 
 public void userRefresh ( ) throws URISyntaxException , JSONException { 
 - Token t = SyncTestUtils . createTestUser ( ) . getAccessToken ( ) ; 
 + Token t = SyncTestUtils . createTestUser ( ) . getRefreshToken ( ) ; 
 AuthenticateRequest request = AuthenticateRequest . userRefresh ( t , new URI ( " realm : / / objectserver / " + t . identity ( ) + " / default " ) ) ; 
 
 JSONObject obj = new JSONObject ( request . toJson ( ) ) ; 
 diff - - git a / realm / realm - library / src / androidTestObjectServer / java / io / realm / SyncUserTests . java b / realm / realm - library / src / androidTestObjectServer / java / io / realm / SyncUserTests . java 
 index 1c90667 . . 5d67f68 100644 
 - - - a / realm / realm - library / src / androidTestObjectServer / java / io / realm / SyncUserTests . java 
 + + + b / realm / realm - library / src / androidTestObjectServer / java / io / realm / SyncUserTests . java 
 @ @ - 50 , 8 + 50 , 8 @ @ import io . realm . internal . network . AuthenticateResponse ; 
 import io . realm . internal . network . AuthenticationServer ; 
 import io . realm . internal . objectserver . Token ; 
 import io . realm . log . RealmLog ; 
 - import io . realm . objectserver . utils . UserFactory ; 
 import io . realm . objectserver . utils . StringOnlyModule ; 
 + import io . realm . objectserver . utils . UserFactory ; 
 import io . realm . rule . RunInLooperThread ; 
 import io . realm . rule . RunTestInLooperThread ; 
 import io . realm . util . SyncTestUtils ; 
 @ @ - 382 , 7 + 382 , 7 @ @ public class SyncUserTests { 
 SyncUser user = createTestUser ( ) ; 
 
 thrown . expect ( IllegalStateException . class ) ; 
 - user . changePasswordAsync ( " password " , new SyncUser . Callback ( ) { 
 + user . changePasswordAsync ( " password " , new SyncUser . Callback < SyncUser > ( ) { 
 @ Override 
 public void onSuccess ( SyncUser user ) { 
 fail ( ) ; 
 @ @ - 400 , 7 + 400 , 7 @ @ public class SyncUserTests { 
 SyncUser user = createTestUser ( ) ; 
 
 thrown . expect ( IllegalStateException . class ) ; 
 - user . changePasswordAsync ( " user - id " , " new " , new SyncUser . Callback ( ) { 
 + user . changePasswordAsync ( " user - id " , " new " , new SyncUser . Callback < SyncUser > ( ) { 
 @ Override 
 public void onSuccess ( SyncUser user ) { 
 fail ( ) ; 
 @ @ - 543 , 11 + 543 , 11 @ @ public class SyncUserTests { 
 / / since the user is not persisted in the UserStore 
 / / isValid ( ) requires SyncManager . getUserStore ( ) . isActive ( identity ) 
 / / to return true as well . 
 - Token accessToken = syncUser . getAccessToken ( ) ; 
 - assertNotNull ( accessToken ) ; 
 + Token refreshToken = syncUser . getRefreshToken ( ) ; 
 + assertNotNull ( refreshToken ) ; 
 / / refresh token should expire in 10 years ( July 23 , 2027 ) 
 Calendar calendar = Calendar . getInstance ( ) ; 
 - calendar . setTimeInMillis ( accessToken . expiresMs ( ) ) ; 
 + calendar . setTimeInMillis ( refreshToken . expiresMs ( ) ) ; 
 int day = calendar . get ( Calendar . DAY _ OF _ MONTH ) ; 
 int month = calendar . get ( Calendar . MONTH ) ; 
 int year = calendar . get ( Calendar . YEAR ) ; 
 diff - - git a / realm / realm - library / src / androidTestObjectServer / java / io / realm / util / SyncTestUtils . java b / realm / realm - library / src / androidTestObjectServer / java / io / realm / util / SyncTestUtils . java 
 index 167bb3b . . 97caaa1 100644 
 - - - a / realm / realm - library / src / androidTestObjectServer / java / io / realm / util / SyncTestUtils . java 
 + + + b / realm / realm - library / src / androidTestObjectServer / java / io / realm / util / SyncTestUtils . java 
 @ @ - 37 , 10 + 37 , 13 @ @ public class SyncTestUtils { 
 public static final String DEFAULT _ AUTH _ URL = " http : / / objectserver . realm . io / auth " ; 
 
 private final static Method SYNC _ MANAGER _ GET _ USER _ STORE _ METHOD ; 
 + private final static Method SYNC _ USER _ GET _ ACCESS _ TOKEN _ METHOD ; 
 static { 
 try { 
 SYNC _ MANAGER _ GET _ USER _ STORE _ METHOD = SyncManager . class . getDeclaredMethod ( " getUserStore " ) ; 
 + SYNC _ USER _ GET _ ACCESS _ TOKEN _ METHOD = SyncUser . class . getDeclaredMethod ( " getRefreshToken " ) ; 
 SYNC _ MANAGER _ GET _ USER _ STORE _ METHOD . setAccessible ( true ) ; 
 + SYNC _ USER _ GET _ ACCESS _ TOKEN _ METHOD . setAccessible ( true ) ; 
 } catch ( NoSuchMethodException e ) { 
 throw new AssertionError ( e ) ; 
 } 
 @ @ - 106 , 13 + 109 , 19 @ @ public class SyncTestUtils { 
 return AuthenticateResponse . from ( new ObjectServerError ( code , " dummy " ) ) ; 
 } 
 
 + public static Token getRefreshToken ( SyncUser user ) { 
 + try { 
 + return ( Token ) SYNC _ USER _ GET _ ACCESS _ TOKEN _ METHOD . invoke ( user ) ; 
 + } catch ( IllegalAccessException | InvocationTargetException e ) { 
 + throw new AssertionError ( e ) ; 
 + } 
 + } 
 + 
 private static void addToUserStore ( SyncUser user ) { 
 try { 
 UserStore userStore = ( UserStore ) SYNC _ MANAGER _ GET _ USER _ STORE _ METHOD . invoke ( null ) ; 
 userStore . put ( user ) ; 
 - } catch ( InvocationTargetException e ) { 
 - throw new AssertionError ( e ) ; 
 - } catch ( IllegalAccessException e ) { 
 + } catch ( InvocationTargetException | IllegalAccessException e ) { 
 throw new AssertionError ( e ) ; 
 } 
 } 
 diff - - git a / realm / realm - library / src / objectServer / java / io / realm / SyncSession . java b / realm / realm - library / src / objectServer / java / io / realm / SyncSession . java 
 index 4387d8e . . 102eaba 100644 
 - - - a / realm / realm - library / src / objectServer / java / io / realm / SyncSession . java 
 + + + b / realm / realm - library / src / objectServer / java / io / realm / SyncSession . java 
 @ @ - 504 , 7 + 504 , 7 @ @ public class SyncSession { 
 try { 
 JSONObject refreshTokenJSON = new JSONObject ( refreshToken ) ; 
 Token newRefreshToken = Token . from ( refreshTokenJSON . getJSONObject ( " userToken " ) ) ; 
 - if ( newRefreshToken . hashCode ( ) ! = getUser ( ) . getAccessToken ( ) . hashCode ( ) ) { 
 + if ( newRefreshToken . hashCode ( ) ! = getUser ( ) . getRefreshToken ( ) . hashCode ( ) ) { 
 RealmLog . debug ( " Session [ % s ] : Access token updated " , configuration . getPath ( ) ) ; 
 getUser ( ) . setRefreshToken ( newRefreshToken ) ; 
 } 
 @ @ - 551 , 7 + 551 , 7 @ @ public class SyncSession { 
 protected AuthenticateResponse execute ( ) { 
 if ( ! isClosed & & ! Thread . currentThread ( ) . isInterrupted ( ) ) { 
 return authServer . loginToRealm ( 
 - getUser ( ) . getAccessToken ( ) , / / refresh token in fact 
 + getUser ( ) . getRefreshToken ( ) , / / refresh token in fact 
 configuration . getServerUrl ( ) , 
 getUser ( ) . getAuthenticationUrl ( ) 
 ) ; 
 @ @ - 629 , 7 + 629 , 7 @ @ public class SyncSession { 
 @ Override 
 protected AuthenticateResponse execute ( ) { 
 if ( ! isClosed & & ! Thread . currentThread ( ) . isInterrupted ( ) ) { 
 - return authServer . refreshUser ( getUser ( ) . getAccessToken ( ) , configuration . getServerUrl ( ) , getUser ( ) . getAuthenticationUrl ( ) ) ; 
 + return authServer . refreshUser ( getUser ( ) . getRefreshToken ( ) , configuration . getServerUrl ( ) , getUser ( ) . getAuthenticationUrl ( ) ) ; 
 } 
 return null ; 
 } 
 diff - - git a / realm / realm - library / src / objectServer / java / io / realm / SyncUser . java b / realm / realm - library / src / objectServer / java / io / realm / SyncUser . java 
 index 2b24ec2 . . 0a69915 100644 
 - - - a / realm / realm - library / src / objectServer / java / io / realm / SyncUser . java 
 + + + b / realm / realm - library / src / objectServer / java / io / realm / SyncUser . java 
 @ @ - 47 , 7 + 47 , 6 @ @ import io . realm . internal . network . LogoutResponse ; 
 import io . realm . internal . network . LookupUserIdResponse ; 
 import io . realm . internal . objectserver . Token ; 
 import io . realm . internal . permissions . ManagementModule ; 
 - import io . realm . internal . permissions . PermissionModule ; 
 import io . realm . log . RealmLog ; 
 
 / * * 
 @ @ - 221 , 9 + 220 , 9 @ @ public class SyncUser { 
 * @ return representation of the async task that can be used to cancel it if needed . 
 * @ throws IllegalArgumentException if not on a Looper thread . 
 * / 
 - public static RealmAsyncTask loginAsync ( final SyncCredentials credentials , final String authenticationUrl , final Callback callback ) { 
 + public static RealmAsyncTask loginAsync ( final SyncCredentials credentials , final String authenticationUrl , final Callback < SyncUser > callback ) { 
 checkLooperThread ( " Asynchronous login is only possible from looper threads . " ) ; 
 - return new Request ( SyncManager . NETWORK _ POOL _ EXECUTOR , callback ) { 
 + return new Request < SyncUser > ( SyncManager . NETWORK _ POOL _ EXECUTOR , callback ) { 
 @ Override 
 public SyncUser run ( ) throws ObjectServerError { 
 return login ( credentials , authenticationUrl ) ; 
 @ @ - 375 , 13 + 374 , 13 @ @ public class SyncUser { 
 * @ return representation of the async task that can be used to cancel it if needed . 
 * @ throws IllegalArgumentException if not on a Looper thread . 
 * / 
 - public RealmAsyncTask changePasswordAsync ( final String newPassword , final Callback callback ) { 
 + public RealmAsyncTask changePasswordAsync ( final String newPassword , final Callback < SyncUser > callback ) { 
 checkLooperThread ( " Asynchronous changing password is only possible from looper threads . " ) ; 
 / / noinspection ConstantConditions 
 if ( callback = = null ) { 
 throw new IllegalArgumentException ( " Non - null ' callback ' required . " ) ; 
 } 
 - return new Request ( SyncManager . NETWORK _ POOL _ EXECUTOR , callback ) { 
 + return new Request < SyncUser > ( SyncManager . NETWORK _ POOL _ EXECUTOR , callback ) { 
 @ Override 
 public SyncUser run ( ) { 
 changePassword ( newPassword ) ; 
 @ @ - 405 , 14 + 404 , 14 @ @ public class SyncUser { 
 * @ return representation of the async task that can be used to cancel it if needed . 
 * @ throws IllegalArgumentException if not on a Looper thread . 
 * / 
 - public RealmAsyncTask changePasswordAsync ( final String userId , final String newPassword , final Callback callback ) { 
 + public RealmAsyncTask changePasswordAsync ( final String userId , final String newPassword , final Callback < SyncUser > callback ) { 
 checkLooperThread ( " Asynchronous changing password is only possible from looper threads . " ) ; 
 / / noinspection ConstantConditions 
 if ( callback = = null ) { 
 throw new IllegalArgumentException ( " Non - null ' callback ' required . " ) ; 
 } 
 
 - return new Request ( SyncManager . NETWORK _ POOL _ EXECUTOR , callback ) { 
 + return new Request < SyncUser > ( SyncManager . NETWORK _ POOL _ EXECUTOR , callback ) { 
 @ Override 
 public SyncUser run ( ) { 
 changePassword ( userId , newPassword ) ; 
 @ @ - 470 , 7 + 469 , 7 @ @ public class SyncUser { 
 * as this method is called on . 
 * @ return representation of the async task that can be used to cancel it if needed . 
 * / 
 - public RealmAsyncTask retrieveInfoForUserAsync ( final String providerUserIdentity , final String provider , final RequestCallback < SyncUserInfo > callback ) { 
 + public RealmAsyncTask retrieveInfoForUserAsync ( final String providerUserIdentity , final String provider , final Callback < SyncUserInfo > callback ) { 
 checkLooperThread ( " Asynchronously retrieving user is only possible from looper threads . " ) ; 
 / / noinspection ConstantConditions 
 if ( callback = = null ) { 
 @ @ - 478 , 12 + 477 , 8 @ @ public class SyncUser { 
 } 
 
 return new Request < SyncUserInfo > ( SyncManager . NETWORK _ POOL _ EXECUTOR , callback ) { 
 - / / TODO remove this override on next major release when we remove the deprecated Callback 
 @ Override 
 - public SyncUser run ( ) { return null ; } 
 - 
 - @ Override 
 - public SyncUserInfo execute ( ) throws ObjectServerError { 
 + public SyncUserInfo run ( ) throws ObjectServerError { 
 return retrieveInfoForUser ( providerUserIdentity , provider ) ; 
 } 
 } . start ( ) ; 
 @ @ - 553 , 12 + 548 , 12 @ @ public class SyncUser { 
 } 
 
 / * * 
 - * Returns this user ' s access token . This is the users credential for accessing the Realm Object Server and should 
 + * Returns this user ' s refresh token . This is the users credential for accessing the Realm Object Server and should 
 * be treated as sensitive data . 
 * 
 - * @ return the user ' s access token . If this user has logged out or the login has expired { @ code null } is returned . 
 + * @ return the user ' s refresh token . If this user has logged out or the login has expired { @ code null } is returned . 
 * / 
 - public Token getAccessToken ( ) { 
 + Token getRefreshToken ( ) { 
 return refreshToken ; 
 } 
 
 @ @ - 685 , 32 + 680 , 19 @ @ public class SyncUser { 
 / / Class wrapping requests made against the auth server . Is also responsible for calling with success / error on the 
 / / correct thread . 
 private static abstract class Request < T > { 
 - 
 @ Nullable 
 - private final Callback callback ; 
 - @ Nullable 
 - private final RequestCallback < T > genericCallback ; 
 + private final Callback < T > callback ; 
 private final RealmNotifier handler ; 
 private final ThreadPoolExecutor networkPoolExecutor ; 
 
 - Request ( ThreadPoolExecutor networkPoolExecutor , @ Nullable Callback callback ) { 
 + Request ( ThreadPoolExecutor networkPoolExecutor , @ Nullable Callback < T > callback ) { 
 this . callback = callback ; 
 - this . genericCallback = null ; 
 - this . handler = new AndroidRealmNotifier ( null , new AndroidCapabilities ( ) ) ; 
 - this . networkPoolExecutor = networkPoolExecutor ; 
 - } 
 - 
 - Request ( ThreadPoolExecutor networkPoolExecutor , @ Nullable RequestCallback < T > callback ) { 
 - this . callback = null ; 
 - this . genericCallback = callback ; 
 this . handler = new AndroidRealmNotifier ( null , new AndroidCapabilities ( ) ) ; 
 this . networkPoolExecutor = networkPoolExecutor ; 
 } 
 
 / / Implements the request . Return the current sync user if the request succeeded . Otherwise throw an error . 
 - public abstract SyncUser run ( ) throws ObjectServerError ; 
 - / / TODO next major release , remove run , rename execute to run and make it abstract 
 - public T execute ( ) throws ObjectServerError { return null ; } 
 + public abstract T run ( ) throws ObjectServerError ; 
 
 / / Start the request 
 public RealmAsyncTask start ( ) { 
 @ @ - 718 , 13 + 700 , 7 @ @ public class SyncUser { 
 @ Override 
 public void run ( ) { 
 try { 
 - / / co - exist the old and new callback 
 - if ( genericCallback ! = null ) { 
 - postSuccess ( Request . this . execute ( ) ) ; 
 - } else { 
 - postSuccess ( Request . this . run ( ) ) ; 
 - } 
 - 
 + postSuccess ( Request . this . run ( ) ) ; 
 } catch ( ObjectServerError e ) { 
 postError ( e ) ; 
 } catch ( Throwable e ) { 
 @ @ - 752 , 45 + 728 , 19 @ @ public class SyncUser { 
 } 
 } 
 
 - private void postSuccess ( final SyncUser user ) { 
 - if ( callback ! = null ) { 
 - handler . post ( new Runnable ( ) { 
 - @ Override 
 - public void run ( ) { 
 - callback . onSuccess ( user ) ; 
 - } 
 - } ) ; 
 - } 
 - } 
 - 
 private void postSuccess ( final T result ) { 
 - if ( genericCallback ! = null ) { 
 + if ( callback ! = null ) { 
 handler . post ( new Runnable ( ) { 
 @ Override 
 public void run ( ) { 
 - genericCallback . onSuccess ( result ) ; 
 + callback . onSuccess ( result ) ; 
 } 
 } ) ; 
 } 
 } 
 } 
 
 - / / TODO remove and replace uses by RequestCallback on next major release 
 - public interface Callback { 
 - / * * 
 - * @ deprecated as per 3 . 6 . 0 release , replaced by { @ link RequestCallback # onSuccess ( Object ) } 
 - * / 
 - @ Deprecated 
 - void onSuccess ( SyncUser user ) ; 
 - 
 - / * * 
 - * @ deprecated as per 3 . 6 . 0 release , replaced by { @ link RequestCallback # onError ( ObjectServerError ) } 
 - * / 
 - @ Deprecated 
 - void onError ( ObjectServerError error ) ; 
 - } 
 - 
 - public interface RequestCallback < T > { 
 + public interface Callback < T > { 
 void onSuccess ( T result ) ; 
 
 void onError ( ObjectServerError error ) ; 
 diff - - git a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / AuthTests . java b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / AuthTests . java 
 index 256df2f . . fddc2c5 100644 
 - - - a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / AuthTests . java 
 + + + b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / AuthTests . java 
 @ @ - 40 , 6 + 40 , 7 @ @ import io . realm . objectserver . utils . Constants ; 
 import io . realm . objectserver . utils . StringOnlyModule ; 
 import io . realm . objectserver . utils . UserFactory ; 
 import io . realm . rule . RunTestInLooperThread ; 
 + import io . realm . util . SyncTestUtils ; 
 
 import static junit . framework . Assert . assertEquals ; 
 import static junit . framework . Assert . assertNotNull ; 
 @ @ - 74 , 7 + 75 , 7 @ @ public class AuthTests extends StandardIntegrationTest { 
 @ RunTestInLooperThread 
 public void loginAsync _ userNotExist ( ) { 
 SyncCredentials credentials = SyncCredentials . usernamePassword ( " IWantToHackYou " , " GeneralPassword " , false ) ; 
 - SyncUser . loginAsync ( credentials , Constants . AUTH _ URL , new SyncUser . Callback ( ) { 
 + SyncUser . loginAsync ( credentials , Constants . AUTH _ URL , new SyncUser . Callback < SyncUser > ( ) { 
 @ Override 
 public void onSuccess ( SyncUser user ) { 
 fail ( ) ; 
 @ @ - 93 , 7 + 94 , 7 @ @ public class AuthTests extends StandardIntegrationTest { 
 public void login _ newUser ( ) { 
 String userId = UUID . randomUUID ( ) . toString ( ) ; 
 SyncCredentials credentials = SyncCredentials . usernamePassword ( userId , " password " , true ) ; 
 - SyncUser . loginAsync ( credentials , Constants . AUTH _ URL , new SyncUser . Callback ( ) { 
 + SyncUser . loginAsync ( credentials , Constants . AUTH _ URL , new SyncUser . Callback < SyncUser > ( ) { 
 @ Override 
 public void onSuccess ( SyncUser user ) { 
 assertFalse ( user . isAdmin ( ) ) ; 
 @ @ - 116 , 8 + 117 , 8 @ @ public class AuthTests extends StandardIntegrationTest { 
 @ RunTestInLooperThread 
 public void login _ withAccessToken ( ) { 
 SyncUser adminUser = UserFactory . createAdminUser ( Constants . AUTH _ URL ) ; 
 - SyncCredentials credentials = SyncCredentials . accessToken ( adminUser . getAccessToken ( ) . value ( ) , " custom - admin - user " , adminUser . isAdmin ( ) ) ; 
 - SyncUser . loginAsync ( credentials , Constants . AUTH _ URL , new SyncUser . Callback ( ) { 
 + SyncCredentials credentials = SyncCredentials . accessToken ( SyncTestUtils . getRefreshToken ( adminUser ) . value ( ) , " custom - admin - user " , adminUser . isAdmin ( ) ) ; 
 + SyncUser . loginAsync ( credentials , Constants . AUTH _ URL , new SyncUser . Callback < SyncUser > ( ) { 
 @ Override 
 public void onSuccess ( SyncUser user ) { 
 assertTrue ( user . isAdmin ( ) ) ; 
 @ @ - 159 , 7 + 160 , 7 @ @ public class AuthTests extends StandardIntegrationTest { 
 @ Override 
 public void run ( ) { 
 SyncCredentials credentials = SyncCredentials . usernamePassword ( " IWantToHackYou " , " GeneralPassword " , false ) ; 
 - SyncUser . loginAsync ( credentials , Constants . AUTH _ URL , new SyncUser . Callback ( ) { 
 + SyncUser . loginAsync ( credentials , Constants . AUTH _ URL , new SyncUser . Callback < SyncUser > ( ) { 
 @ Override 
 public void onSuccess ( SyncUser user ) { 
 fail ( ) ; 
 @ @ - 248 , 7 + 249 , 7 @ @ public class AuthTests extends StandardIntegrationTest { 
 
 / / Change password using admin user 
 final String newPassword = " new - password " ; 
 - adminUser . changePasswordAsync ( userOld . getIdentity ( ) , newPassword , new SyncUser . Callback ( ) { 
 + adminUser . changePasswordAsync ( userOld . getIdentity ( ) , newPassword , new SyncUser . Callback < SyncUser > ( ) { 
 @ Override 
 public void onSuccess ( SyncUser administratorUser ) { 
 assertEquals ( adminUser , administratorUser ) ; 
 @ @ - 497 , 7 + 498 , 7 @ @ public class AuthTests extends StandardIntegrationTest { 
 
 final SyncCredentials credentials = SyncCredentials . usernamePassword ( uniqueName , " password " , true ) ; 
 SyncUser user = SyncUser . login ( credentials , Constants . AUTH _ URL ) ; 
 - final Token revokedRefreshToken = user . getAccessToken ( ) ; 
 + final Token revokedRefreshToken = SyncTestUtils . getRefreshToken ( user ) ; 
 
 SyncManager . addAuthenticationListener ( new AuthenticationListener ( ) { 
 @ Override 
 @ @ - 511 , 11 + 512 , 12 @ @ public class AuthTests extends StandardIntegrationTest { 
 SyncCredentials credentials = SyncCredentials . usernamePassword ( uniqueName , " password " , false ) ; 
 SyncUser loggedInUser = SyncUser . login ( credentials , Constants . AUTH _ URL ) ; 
 
 + Token token = SyncTestUtils . getRefreshToken ( loggedInUser ) ; 
 / / still comparing the same user 
 - assertEquals ( revokedRefreshToken . identity ( ) , loggedInUser . getAccessToken ( ) . identity ( ) ) ; 
 + assertEquals ( revokedRefreshToken . identity ( ) , token . identity ( ) ) ; 
 
 / / different tokens 
 - assertNotEquals ( revokedRefreshToken . value ( ) , loggedInUser . getAccessToken ( ) . value ( ) ) ; 
 + assertNotEquals ( revokedRefreshToken . value ( ) , token . value ( ) ) ; 
 SyncManager . removeAuthenticationListener ( this ) ; 
 userLoggedInAgain . countDown ( ) ; 
 } 
 @ @ - 591 , 7 + 593 , 7 @ @ public class AuthTests extends StandardIntegrationTest { 
 assertNotEquals ( accessToken , newAccessToken ) ; 
 
 / / refresh _ token identity is the same 
 - assertEquals ( user . getAccessToken ( ) . identity ( ) , newAccessToken . identity ( ) ) ; 
 + assertEquals ( SyncTestUtils . getRefreshToken ( user ) . identity ( ) , newAccessToken . identity ( ) ) ; 
 assertEquals ( accessToken . identity ( ) , newAccessToken . identity ( ) ) ; 
 
 realm . close ( ) ; 
 @ @ - 728 , 7 + 730 , 7 @ @ public class AuthTests extends StandardIntegrationTest { 
 assertTrue ( adminUser . isAdmin ( ) ) ; 
 
 final String identity = user . getIdentity ( ) ; 
 - adminUser . retrieveInfoForUserAsync ( username , SyncCredentials . IdentityProvider . USERNAME _ PASSWORD , new SyncUser . RequestCallback < SyncUserInfo > ( ) { 
 + adminUser . retrieveInfoForUserAsync ( username , SyncCredentials . IdentityProvider . USERNAME _ PASSWORD , new SyncUser . Callback < SyncUserInfo > ( ) { 
 @ Override 
 public void onSuccess ( SyncUserInfo userInfo ) { 
 assertNotNull ( userInfo ) ; 
 diff - - git a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / EncryptedSynchronizedRealmTests . java b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / EncryptedSynchronizedRealmTests . java 
 index 7806b41 . . d51f352 100644 
 - - - a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / EncryptedSynchronizedRealmTests . java 
 + + + b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / EncryptedSynchronizedRealmTests . java 
 @ @ - 24 , 6 + 24 , 7 @ @ import io . realm . exceptions . RealmFileException ; 
 import io . realm . objectserver . utils . Constants ; 
 import io . realm . objectserver . utils . StringOnlyModule ; 
 import io . realm . objectserver . utils . UserFactory ; 
 + import io . realm . util . SyncTestUtils ; 
 
 import static org . junit . Assert . assertEquals ; 
 import static org . junit . Assert . assertTrue ; 
 @ @ - 187 , 7 + 188 , 7 @ @ public class EncryptedSynchronizedRealmTests extends StandardIntegrationTest { 
 
 / / STEP 3 : prepare a synced Realm for client B ( admin user ) 
 SyncUser admin = UserFactory . createAdminUser ( Constants . AUTH _ URL ) ; 
 - SyncCredentials credentials = SyncCredentials . accessToken ( admin . getAccessToken ( ) . value ( ) , " custom - admin - user " ) ; 
 + SyncCredentials credentials = SyncCredentials . accessToken ( SyncTestUtils . getRefreshToken ( admin ) . value ( ) , " custom - admin - user " ) ; 
 SyncUser adminUser = SyncUser . login ( credentials , Constants . AUTH _ URL ) ; 
 
 final byte [ ] adminRandomKey = TestHelper . getRandomKey ( ) ; 
 diff - - git a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / SyncSessionTests . java b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / SyncSessionTests . java 
 index a51e9b9 . . 79dc4e6 100644 
 - - - a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / SyncSessionTests . java 
 + + + b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / SyncSessionTests . java 
 @ @ - 12 , 16 + 12 , 14 @ @ import org . junit . Rule ; 
 import org . junit . Test ; 
 import org . junit . runner . RunWith ; 
 
 - import java . util . concurrent . CountDownLatch ; 
 import java . util . Arrays ; 
 import java . util . UUID ; 
 import java . util . concurrent . CountDownLatch ; 
 
 - import io . realm . BaseIntegrationTest ; 
 import io . realm . Realm ; 
 - import io . realm . StandardIntegrationTest ; 
 import io . realm . RealmChangeListener ; 
 import io . realm . RealmResults ; 
 + import io . realm . StandardIntegrationTest ; 
 import io . realm . SyncConfiguration ; 
 import io . realm . SyncCredentials ; 
 import io . realm . SyncManager ; 
 @ @ - 34 , 10 + 32 , 10 @ @ import io . realm . objectserver . utils . Constants ; 
 import io . realm . objectserver . utils . StringOnlyModule ; 
 import io . realm . objectserver . utils . UserFactory ; 
 import io . realm . rule . TestSyncConfigurationFactory ; 
 + import io . realm . util . SyncTestUtils ; 
 
 import static org . junit . Assert . assertEquals ; 
 import static org . junit . Assert . assertFalse ; 
 - import static org . junit . Assert . assertTrue ; 
 import static org . junit . Assert . assertNotEquals ; 
 import static org . junit . Assert . fail ; 
 
 @ @ - 275 , 7 + 273 , 7 @ @ public class SyncSessionTests extends StandardIntegrationTest { 
 / / access the Realm from an different path on the device ( using admin user ) , then monitor 
 / / when the offline commits get synchronized 
 SyncUser admin = UserFactory . createAdminUser ( Constants . AUTH _ URL ) ; 
 - SyncCredentials credentialsAdmin = SyncCredentials . accessToken ( admin . getAccessToken ( ) . value ( ) , " custom - admin - user " ) ; 
 + SyncCredentials credentialsAdmin = SyncCredentials . accessToken ( SyncTestUtils . getRefreshToken ( admin ) . value ( ) , " custom - admin - user " ) ; 
 SyncUser adminUser = SyncUser . login ( credentialsAdmin , Constants . AUTH _ URL ) ; 
 
 SyncConfiguration adminConfig = configurationFactory . createSyncConfigurationBuilder ( adminUser , syncConfiguration . getServerUrl ( ) . toString ( ) ) 
 @ @ - 349 , 7 + 347 , 7 @ @ public class SyncSessionTests extends StandardIntegrationTest { 
 public void run ( ) { 
 / / using an admin user to open the Realm on different path on the device to monitor when all the uploads are done 
 SyncUser admin = UserFactory . createAdminUser ( Constants . AUTH _ URL ) ; 
 - SyncCredentials credentialsAdmin = SyncCredentials . accessToken ( admin . getAccessToken ( ) . value ( ) , " custom - admin - user " ) ; 
 + SyncCredentials credentialsAdmin = SyncCredentials . accessToken ( SyncTestUtils . getRefreshToken ( admin ) . value ( ) , " custom - admin - user " ) ; 
 SyncUser adminUser = SyncUser . login ( credentialsAdmin , Constants . AUTH _ URL ) ; 
 
 SyncConfiguration adminConfig = configurationFactory . createSyncConfigurationBuilder ( adminUser , syncConfiguration . getServerUrl ( ) . toString ( ) ) 
 @ @ - 420 , 7 + 418 , 7 @ @ public class SyncSessionTests extends StandardIntegrationTest { 
 public void run ( ) { 
 / / using an admin user to open the Realm on different path on the device then some commits 
 SyncUser admin = UserFactory . createAdminUser ( Constants . AUTH _ URL ) ; 
 - SyncCredentials credentialsAdmin = SyncCredentials . accessToken ( admin . getAccessToken ( ) . value ( ) , " custom - admin - user " ) ; 
 + SyncCredentials credentialsAdmin = SyncCredentials . accessToken ( SyncTestUtils . getRefreshToken ( admin ) . value ( ) , " custom - admin - user " ) ; 
 SyncUser adminUser = SyncUser . login ( credentialsAdmin , Constants . AUTH _ URL ) ; 
 
 SyncConfiguration adminConfig = configurationFactory . createSyncConfigurationBuilder ( adminUser , syncConfiguration . getServerUrl ( ) . toString ( ) )

NEAREST DIFF:
diff - - git a / README . md b / README . md 
 index ee52154 . . 268af42 100644 
 - - - a / README . md 
 + + + b / README . md 
 @ @ - 220 , 6 + 220 , 9 @ @ To run a testing server locally : 
 	 . / gradlew connectedObjectServerDebugAndroidTest 
 	 ` ` ` 
 
 + Note that if using VirtualBox ( Genymotion ) , the network needs to be bridged for the tests to work . 
 + This is done in ` VirtualBox > Network ` . Set " Adapter 2 " to " Bridged Adapter " . 
 + 
 These tests may take as much as half an hour to complete . 
 
 # # Contributing 
 diff - - git a / realm / realm - library / src / androidTest / AndroidManifest . xml b / realm / realm - library / src / androidTest / AndroidManifest . xml 
 index c7741a6 . . d9e252d 100644 
 - - - a / realm / realm - library / src / androidTest / AndroidManifest . xml 
 + + + b / realm / realm - library / src / androidTest / AndroidManifest . xml 
 @ @ - 21 , 6 + 21 , 23 @ @ 
 android : exported = " true " 
 android : process = " : remote " > 
 < / service > 
 + 
 + < ! - - 
 + FIXME : Manifest merger doesn ' t seem to work correctly with test flavours . 
 + Figure out why . For now place services here 
 + - - > 
 + < service 
 + android : name = " io . realm . objectserver . service . SendOneCommit " 
 + android : enabled = " true " 
 + android : exported = " true " 
 + android : process = " : remote " > 
 + < / service > 
 + < service 
 + android : name = " io . realm . objectserver . service . SendsALot " 
 + android : enabled = " true " 
 + android : exported = " true " 
 + android : process = " : remote " > 
 + < / service > 
 < / application > 
 
 < / manifest > 
 diff - - git a / realm / realm - library / src / androidTestObjectServer / java / io / realm / SyncUserTests . java b / realm / realm - library / src / androidTestObjectServer / java / io / realm / SyncUserTests . java 
 index a587ca1 . . c31ea68 100644 
 - - - a / realm / realm - library / src / androidTestObjectServer / java / io / realm / SyncUserTests . java 
 + + + b / realm / realm - library / src / androidTestObjectServer / java / io / realm / SyncUserTests . java 
 @ @ - 23 , 6 + 23 , 7 @ @ import org . junit . Before ; 
 import org . junit . Rule ; 
 import org . junit . Test ; 
 import org . junit . runner . RunWith ; 
 + import org . mockito . Mockito ; 
 
 import java . net . MalformedURLException ; 
 import java . net . URI ; 
 @ @ - 31 , 6 + 32 , 7 @ @ import java . net . URL ; 
 import java . util . Collection ; 
 
 import io . realm . android . SharedPrefsUserStore ; 
 + import io . realm . internal . network . AuthenticationServer ; 
 import io . realm . rule . RunInLooperThread ; 
 import io . realm . util . SyncTestUtils ; 
 
 @ @ - 39 , 6 + 41 , 8 @ @ import static junit . framework . Assert . assertEquals ; 
 import static org . junit . Assert . assertNotNull ; 
 import static org . junit . Assert . assertNull ; 
 import static org . junit . Assert . assertTrue ; 
 + import static org . mockito . Matchers . any ; 
 + import static org . mockito . Mockito . when ; 
 
 @ RunWith ( AndroidJUnit4 . class ) 
 public class SyncUserTests { 
 @ @ - 151 , 4 + 155 , 19 @ @ public class SyncUserTests { 
 assertTrue ( str ! = null & & ! str . isEmpty ( ) ) ; 
 } 
 
 + / / Test that a login an access token logs the user in directly without touching the network 
 + @ Test 
 + public void login _ withAccessToken ( ) { 
 + AuthenticationServer authServer = Mockito . mock ( AuthenticationServer . class ) ; 
 + when ( authServer . loginUser ( any ( SyncCredentials . class ) , any ( URL . class ) ) ) . thenThrow ( new AssertionError ( " Server contacted . " ) ) ; 
 + AuthenticationServer originalServer = SyncManager . getAuthServer ( ) ; 
 + SyncManager . setAuthServerImpl ( authServer ) ; 
 + try { 
 + SyncCredentials credentials = SyncCredentials . accessToken ( " foo " , " bar " ) ; 
 + SyncUser user = SyncUser . login ( credentials , " http : / / ros . realm . io / auth " ) ; 
 + assertTrue ( user . isValid ( ) ) ; 
 + } finally { 
 + SyncManager . setAuthServerImpl ( originalServer ) ; 
 + } 
 + } 
 } 
 diff - - git a / realm / realm - library / src / objectServer / java / io / realm / SyncCredentials . java b / realm / realm - library / src / objectServer / java / io / realm / SyncCredentials . java 
 index 827f126 . . b9dcbc4 100644 
 - - - a / realm / realm - library / src / objectServer / java / io / realm / SyncCredentials . java 
 + + + b / realm / realm - library / src / objectServer / java / io / realm / SyncCredentials . java 
 @ @ - 151 , 6 + 151 , 23 @ @ public class SyncCredentials { 
 return new SyncCredentials ( identityProvider , userIdentifier , userInfo ) ; 
 } 
 
 + / * * 
 + * Creates credentials from an existing access token . Since an access token is the proof that a user already 
 + * has logged in . Credentials created this way are automatically assumed to have successfully logged in . 
 + * This means that providing this credential to { @ link SyncUser # login ( SyncCredentials , String ) } will always 
 + * succeed , but accessing any Realm after might fail if the token is no longer valid . 
 + * 
 + * @ param accessToken Users access token . 
 + * @ param identifier User identifier . 
 + * @ return a set of credentials that can be used to log into the Object Server using 
 + * { @ link SyncUser # loginAsync ( SyncCredentials , String , SyncUser . Callback ) } 
 + * / 
 + public static SyncCredentials accessToken ( String accessToken , String identifier ) { 
 + HashMap < String , Object > userInfo = new HashMap < String , Object > ( ) ; 
 + userInfo . put ( " _ token " , accessToken ) ; 
 + return new SyncCredentials ( IdentityProvider . ACCESS _ TOKEN , identifier , userInfo ) ; 
 + } 
 + 
 private SyncCredentials ( String identityProvider , String token , Map < String , Object > userInfo ) { 
 this . identityProvider = identityProvider ; 
 this . userIdentifier = token ; 
 @ @ - 191 , 6 + 208 , 14 @ @ public class SyncCredentials { 
 * verifying that a given credential is valid . 
 * / 
 public static final class IdentityProvider { 
 + 
 + / * * 
 + * The provided identify is an already registered user ( represented by the access token ) . Logging in with this 
 + * type of identity will happen purely on the device without contacting the Realm Object Server . Acquiring 
 + * access to individual Realms will still require talking to the Object Server . 
 + * / 
 + public static final String ACCESS _ TOKEN = " _ access _ token " ; 
 + 
 / * * 
 * Any credentials verified by the debug identity provider will always be considered valid . 
 * It is only available if configured on the Object Server , and it is disabled by default . 
 diff - - git a / realm / realm - library / src / objectServer / java / io / realm / SyncUser . java b / realm / realm - library / src / objectServer / java / io / realm / SyncUser . java 
 index 65130e7 . . 379c3dd 100644 
 - - - a / realm / realm - library / src / objectServer / java / io / realm / SyncUser . java 
 + + + b / realm / realm - library / src / objectServer / java / io / realm / SyncUser . java 
 @ @ - 31 , 6 + 31 , 7 @ @ import java . net . URL ; 
 import java . util . ArrayList ; 
 import java . util . Collection ; 
 import java . util . List ; 
 + import java . util . Objects ; 
 import java . util . concurrent . Future ; 
 import java . util . concurrent . ThreadPoolExecutor ; 
 
 @ @ - 150 , 10 + 151 , 20 @ @ public class SyncUser { 
 throw new IllegalArgumentException ( " Invalid URL " + authenticationUrl + " . " , e ) ; 
 } 
 
 - final AuthenticationServer server = SyncManager . getAuthServer ( ) ; 
 ObjectServerError error ; 
 try { 
 - AuthenticateResponse result = server . loginUser ( credentials , authUrl ) ; 
 + AuthenticateResponse result ; 
 + if ( credentials . getIdentityProvider ( ) . equals ( SyncCredentials . IdentityProvider . ACCESS _ TOKEN ) ) { 
 + / / Credentials using ACCESS _ TOKEN as IdentityProvider are optimistically assumed to be valid already 
 + / / So log them in directly without contacting the authentication server . This is done by mirroring 
 + / / the JSON response expected from the server . 
 + String userIdentifier = credentials . getUserIdentifier ( ) ; 
 + String token = ( String ) credentials . getUserInfo ( ) . get ( " _ token " ) ; 
 + result = AuthenticateResponse . createValidResponseWithUser ( userIdentifier , token ) ; 
 + } else { 
 + final AuthenticationServer server = SyncManager . getAuthServer ( ) ; 
 + result = server . loginUser ( credentials , authUrl ) ; 
 + } 
 if ( result . isValid ( ) ) { 
 ObjectServerUser syncUser = new ObjectServerUser ( result . getRefreshToken ( ) , authUrl ) ; 
 SyncUser user = new SyncUser ( syncUser ) ; 
 diff - - git a / realm / realm - library / src / objectServer / java / io / realm / internal / network / AuthenticateResponse . java b / realm / realm - library / src / objectServer / java / io / realm / internal / network / AuthenticateResponse . java 
 index 75e31a0 . . 9408a55 100644 
 - - - a / realm / realm - library / src / objectServer / java / io / realm / internal / network / AuthenticateResponse . java 
 + + + b / realm / realm - library / src / objectServer / java / io / realm / internal / network / AuthenticateResponse . java 
 @ @ - 75 , 6 + 75 , 24 @ @ public class AuthenticateResponse extends AuthServerResponse { 
 } 
 
 / * * 
 + * Helper method for creating a valid user login response . The user returned will be assumed to have all permissions 
 + * as doesn ' t expire . 
 + * 
 + * @ param identifier User identifier . 
 + * @ param token Users refresh token . 
 + * @ return Response 
 + * / 
 + public static AuthenticateResponse createValidResponseWithUser ( String identifier , String token ) { 
 + try { 
 + JSONObject response = new JSONObject ( ) ; 
 + response . put ( JSON _ FIELD _ REFRESH _ TOKEN , new Token ( token , identifier , null , Long . MAX _ VALUE , Token . Permission . ALL ) . toJson ( ) ) ; 
 + return new AuthenticateResponse ( response . toString ( ) ) ; 
 + } catch ( JSONException e ) { 
 + throw new RuntimeException ( e ) ; 
 + } 
 + } 
 + 
 + / * * 
 * Creates an unsuccessful authentication response . This should only happen in case of network or I / O related 
 * issues . 
 * 
 diff - - git a / realm / realm - library / src / objectServer / java / io / realm / internal / objectserver / Token . java b / realm / realm - library / src / objectServer / java / io / realm / internal / objectserver / Token . java 
 index 78f0acf . . 3ae10a2 100644 
 - - - a / realm / realm - library / src / objectServer / java / io / realm / internal / objectserver / Token . java 
 + + + b / realm / realm - library / src / objectServer / java / io / realm / internal / objectserver / Token . java 
 @ @ - 151 , 5 + 151 , 7 @ @ public class Token { 
 DOWNLOAD , 
 REFRESH , 
 MANAGE ; 
 + 
 + public static final Permission [ ] ALL = { UPLOAD , DOWNLOAD , REFRESH , MANAGE } ; 
 } 
 } 
 diff - - git a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / AuthTests . java b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / AuthTests . java 
 index ccf997a . . a38b774 100644 
 - - - a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / AuthTests . java 
 + + + b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / AuthTests . java 
 @ @ - 9 , 6 + 9 , 8 @ @ import org . junit . Rule ; 
 import org . junit . Test ; 
 import org . junit . runner . RunWith ; 
 
 + import io . realm . RealmConfiguration ; 
 + import io . realm . SyncConfiguration ; 
 import io . realm . SyncCredentials ; 
 import io . realm . ErrorCode ; 
 import io . realm . ObjectServerError ; 
 @ @ - 66 , 4 + 68 , 21 @ @ public class AuthTests { 
 } 
 } ) ; 
 } 
 + 
 + @ Test 
 + @ RunTestInLooperThread 
 + public void login _ withAccessToken ( ) { 
 + SyncCredentials credentials = SyncCredentials . accessToken ( Constants . USER _ TOKEN , " access - token - user " ) ; 
 + SyncUser . loginAsync ( credentials , Constants . AUTH _ URL , new SyncUser . Callback ( ) { 
 + @ Override 
 + public void onSuccess ( SyncUser user ) { 
 + SyncConfiguration config = new SyncConfiguration . Builder ( user , Constants . SYNC _ SERVER _ URL ) . build ( ) ; 
 + } 
 + 
 + @ Override 
 + public void onError ( ObjectServerError error ) { 
 + fail ( " Error thrown : " + error ) ; 
 + } 
 + } ) ; 
 + } 
 } 
 diff - - git a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / ProcessCommitTests . java b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / ProcessCommitTests . java 
 index 6e465f5 . . 73df932 100644 
 - - - a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / ProcessCommitTests . java 
 + + + b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / ProcessCommitTests . java 
 @ @ - 24 , 6 + 24 , 7 @ @ import android . support . test . runner . AndroidJUnit4 ; 
 
 import org . junit . AfterClass ; 
 import org . junit . BeforeClass ; 
 + import org . junit . Ignore ; 
 import org . junit . Test ; 
 import org . junit . runner . RunWith ; 
 
 @ @ - 32 , 16 + 33 , 20 @ @ import java . util . concurrent . ExecutorService ; 
 import java . util . concurrent . Executors ; 
 import java . util . concurrent . TimeUnit ; 
 
 + import io . realm . ObjectServerError ; 
 import io . realm . Realm ; 
 import io . realm . RealmChangeListener ; 
 import io . realm . RealmResults ; 
 import io . realm . SyncConfiguration ; 
 + import io . realm . SyncSession ; 
 + import io . realm . SyncUser ; 
 import io . realm . objectserver . model . ProcessInfo ; 
 import io . realm . objectserver . model . TestObject ; 
 import io . realm . objectserver . service . SendOneCommit ; 
 import io . realm . objectserver . service . SendsALot ; 
 import io . realm . objectserver . utils . Constants ; 
 import io . realm . objectserver . utils . HttpUtils ; 
 + import io . realm . objectserver . utils . UserFactory ; 
 
 import static org . junit . Assert . assertEquals ; 
 import static org . junit . Assert . fail ; 
 @ @ - 50 , 6 + 55 , 7 @ @ import static org . junit . Assert . fail ; 
 public class ProcessCommitTests { 
 @ BeforeClass 
 public static void setUp ( ) throws Exception { 
 + Realm . init ( InstrumentationRegistry . getContext ( ) ) ; 
 HttpUtils . startSyncServer ( ) ; 
 } 
 
 @ @ - 58 , 15 + 64 , 10 @ @ public class ProcessCommitTests { 
 HttpUtils . stopSyncServer ( ) ; 
 } 
 
 - / / FIXME : At least need one method in the test class 
 - @ Test 
 - public void dummy ( ) { 
 - 
 - } 
 - 
 - / / FIXME : Disable for now . 
 - / * 
 + / / FIXME : Ignore for now . They do still not work . It might be caused by two processes each creating 
 + / / a Sync Client , but it needs to be investigated . 
 @ Test 
 + @ Ignore 
 public void expectServerCommit ( ) throws Throwable { 
 final Throwable [ ] exception = new Throwable [ 1 ] ; 
 final CountDownLatch testFinished = new CountDownLatch ( 1 ) ; 
 @ @ - 76 , 18 + 77 , 23 @ @ public class ProcessCommitTests { 
 public void run ( ) { 
 try { 
 Looper . prepare ( ) ; 
 - Context targetContext = InstrumentationRegistry . getInstrumentation ( ) . getTargetContext ( ) ; 
 + Context targetContext = InstrumentationRegistry . getTargetContext ( ) ; 
 
 - final SyncConfiguration syncConfig = new SyncConfiguration . Builder ( ) 
 + SyncUser user = UserFactory . createDefaultUser ( Constants . AUTH _ URL , Constants . USER _ TOKEN ) ; 
 + String realmUrl = Constants . SYNC _ SERVER _ URL ; 
 + final SyncConfiguration syncConfig = new SyncConfiguration . Builder ( user , realmUrl ) 
 . name ( SendOneCommit . class . getSimpleName ( ) ) 
 - . serverUrl ( Constants . SYNC _ SERVER _ URL ) 
 - . user ( UserFactory . createDefaultUser ( Constants . SYNC _ SERVER _ URL , Constants . USER _ TOKEN ) ) 
 + . errorHandler ( new SyncSession . ErrorHandler ( ) { 
 + @ Override 
 + public void onError ( SyncSession session , ObjectServerError error ) { 
 + fail ( " Sync failure : " + error ) ; 
 + } 
 + } ) 
 . build ( ) ; 
 Realm . deleteRealm ( syncConfig ) ; / / TODO do this in Rule as async tests 
 final Realm realm = Realm . getInstance ( syncConfig ) ; 
 Intent intent = new Intent ( targetContext , SendOneCommit . class ) ; 
 targetContext . startService ( intent ) ; 
 - 
 final RealmResults < ProcessInfo > all = realm . where ( ProcessInfo . class ) . findAll ( ) ; 
 all . addChangeListener ( new RealmChangeListener < RealmResults < ProcessInfo > > ( ) { 
 @ Override 
 @ @ - 113 , 14 + 119 , 15 @ @ public class ProcessCommitTests { 
 fail ( " Test timed out " ) ; 
 } 
 } 
 - * / 
 
 + / / FIXME : Ignore for now . They do still not work . It might be caused by two processes each creating 
 + / / a Sync Client , but it needs to be investigated . 
 / / TODO send string from service and match 
 / / replicate integration tests from Cocoa 
 / / add gradle task to start the sh script automatically ( create pid file , = = > run or kill existing process 
 / / check the requirement for the issue again 
 - / * 
 @ Test 
 + @ Ignore 
 public void expectALot ( ) throws Throwable { 
 final Throwable [ ] exception = new Throwable [ 1 ] ; 
 final CountDownLatch testFinished = new CountDownLatch ( 1 ) ; 
 @ @ - 132 , 10 + 139 , 16 @ @ public class ProcessCommitTests { 
 Looper . prepare ( ) ; 
 Context targetContext = InstrumentationRegistry . getInstrumentation ( ) . getTargetContext ( ) ; 
 
 - final SyncConfiguration syncConfig = new SyncConfiguration . Builder ( targetContext ) 
 + SyncUser user = UserFactory . createDefaultUser ( Constants . AUTH _ URL , Constants . USER _ TOKEN ) ; 
 + String realmUrl = Constants . SYNC _ SERVER _ URL _ 2 ; 
 + final SyncConfiguration syncConfig = new SyncConfiguration . Builder ( user , realmUrl ) 
 . name ( SendsALot . class . getSimpleName ( ) ) 
 - . serverUrl ( Constants . SYNC _ SERVER _ URL _ 2 ) 
 - . user ( UserFactory . createDefaultUser ( Constants . SYNC _ SERVER _ URL _ 2 , Constants . USER _ TOKEN ) ) 
 + . errorHandler ( new SyncSession . ErrorHandler ( ) { 
 + @ Override 
 + public void onError ( SyncSession session , ObjectServerError error ) { 
 + fail ( " Sync failure : " + error ) ; 
 + } 
 + } ) 
 . build ( ) ; 
 Realm . deleteRealm ( syncConfig ) ; / / TODO do this in Rule as async tests 
 final Realm realm = Realm . getInstance ( syncConfig ) ; 
 @ @ - 171 , 5 + 184 , 4 @ @ public class ProcessCommitTests { 
 fail ( " Test timed out " ) ; 
 } 
 } 
 - * / 
 } 
 diff - - git a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / service / SendOneCommit . java b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / service / SendOneCommit . java 
 index 26c4f89 . . 2620be8 100644 
 - - - a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / service / SendOneCommit . java 
 + + + b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / service / SendOneCommit . java 
 @ @ - 20 , 6 + 20 , 13 @ @ import android . app . Service ; 
 import android . content . Intent ; 
 import android . os . IBinder ; 
 
 + import io . realm . Realm ; 
 + import io . realm . SyncConfiguration ; 
 + import io . realm . SyncUser ; 
 + import io . realm . objectserver . model . ProcessInfo ; 
 + import io . realm . objectserver . utils . Constants ; 
 + import io . realm . objectserver . utils . UserFactory ; 
 + 
 / * * 
 * Open a sync Realm on a different process , then send one commit . 
 * / 
 @ @ - 28 , 12 + 35 , 11 @ @ public class SendOneCommit extends Service { 
 @ Override 
 public void onCreate ( ) { 
 super . onCreate ( ) ; 
 - / / FIXME : Disable for now 
 - / * 
 - final SyncConfiguration syncConfig = new SyncConfiguration . Builder ( this ) 
 + Realm . init ( getApplicationContext ( ) ) ; 
 + SyncUser user = UserFactory . createDefaultUser ( Constants . AUTH _ URL , Constants . USER _ TOKEN ) ; 
 + String realmUrl = Constants . SYNC _ SERVER _ URL ; 
 + final SyncConfiguration syncConfig = new SyncConfiguration . Builder ( user , realmUrl ) 
 . name ( SendOneCommit . class . getSimpleName ( ) ) 
 - . serverUrl ( Constants . SYNC _ SERVER _ URL ) 
 - . user ( UserFactory . createDefaultUser ( Constants . SYNC _ SERVER _ URL , Constants . USER _ TOKEN ) ) 
 . build ( ) ; 
 Realm . deleteRealm ( syncConfig ) ; 
 Realm realm = Realm . getInstance ( syncConfig ) ; 
 @ @ - 46 , 10 + 52 , 8 @ @ public class SendOneCommit extends Service { 
 realm . commitTransaction ( ) ; 
 
 realm . close ( ) ; / / FIXME the close may not give a chance to the sync client to process / upload the changeset 
 - * / 
 } 
 
 - 
 @ Override 
 public IBinder onBind ( Intent intent ) { 
 return null ; 
 diff - - git a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / service / SendsALot . java b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / service / SendsALot . java 
 index 2bcdd9d . . 27df640 100644 
 - - - a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / service / SendsALot . java 
 + + + b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / service / SendsALot . java 
 @ @ - 20 , 6 + 20 , 13 @ @ import android . app . Service ; 
 import android . content . Intent ; 
 import android . os . IBinder ; 
 
 + import io . realm . Realm ; 
 + import io . realm . SyncConfiguration ; 
 + import io . realm . SyncUser ; 
 + import io . realm . objectserver . model . TestObject ; 
 + import io . realm . objectserver . utils . Constants ; 
 + import io . realm . objectserver . utils . UserFactory ; 
 + 
 / * * 
 * Open a sync Realm on a different process , then send one commit . 
 * / 
 @ @ - 28 , 13 + 35 , 11 @ @ public class SendsALot extends Service { 
 @ Override 
 public void onCreate ( ) { 
 super . onCreate ( ) ; 
 - / / FIXME : Disable for now . 
 - / * 
 - User user = UserFactory . createDefaultUser ( Constants . SYNC _ SERVER _ URL _ 2 , Constants . USER _ TOKEN ) ; 
 - final SyncConfiguration syncConfig = new SyncConfiguration . Builder ( user ) 
 + Realm . init ( getApplicationContext ( ) ) ; 
 + SyncUser user = UserFactory . createDefaultUser ( Constants . AUTH _ URL , Constants . USER _ TOKEN ) ; 
 + String realmUrl = Constants . SYNC _ SERVER _ URL _ 2 ; 
 + final SyncConfiguration syncConfig = new SyncConfiguration . Builder ( user , realmUrl ) 
 . name ( SendsALot . class . getSimpleName ( ) ) 
 - . serverUrl ( Constants . SYNC _ SERVER _ URL _ 2 ) 
 - . user ( ) 
 . build ( ) ; 
 Realm . deleteRealm ( syncConfig ) ; 
 Realm realm = Realm . getInstance ( syncConfig ) ; 
 @ @ - 49 , 7 + 54 , 6 @ @ public class SendsALot extends Service { 
 realm . commitTransaction ( ) ; 
 
 realm . close ( ) ; / / FIXME the close may not give a chance to the sync client to process / upload the changeset 
 - * / 
 } 
 
 
 diff - - git a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / utils / HttpUtils . java b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / utils / HttpUtils . java 
 index 9b15ae1 . . 1fa4fb9 100644 
 - - - a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / utils / HttpUtils . java 
 + + + b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / utils / HttpUtils . java 
 @ @ - 16 , 12 + 16 , 17 @ @ 
 
 package io . realm . objectserver . utils ; 
 
 + import android . support . test . InstrumentationRegistry ; 
 + 
 import java . io . IOException ; 
 
 + import io . realm . Realm ; 
 import io . realm . log . RealmLog ; 
 import okhttp3 . Headers ; 
 + import okhttp3 . MediaType ; 
 import okhttp3 . OkHttpClient ; 
 import okhttp3 . Request ; 
 + import okhttp3 . RequestBody ; 
 import okhttp3 . Response ; 
 
 / * * 
 @ @ - 29 , 7 + 34 , 10 @ @ import okhttp3 . Response ; 
 * temp directory & start a sync server on it for each unit test . 
 * / 
 public class HttpUtils { 
 - private final static OkHttpClient client = new OkHttpClient ( ) ; 
 + private final static OkHttpClient client = new OkHttpClient . Builder ( ) 
 + . retryOnConnectionFailure ( true ) 
 + . build ( ) ; 
 + 
 / / adb reverse tcp : 8888 tcp : 8888 
 / / will forward this query to the host , running the integration test server on 8888 
 private final static String START _ SERVER = " http : / / 127 . 0 . 0 . 1 : 8888 / start " ; 
 @ @ - 60 , 20 + 68 , 29 @ @ public class HttpUtils { 
 / / Checking the server 
 private static boolean waitAuthServerReady ( ) throws InterruptedException { 
 int retryTimes = 50 ; 
 + 
 + / / Dummy invalid request , which will trigger a 400 ( BAD REQUEST ) , but indicate the auth 
 + / / server is responsive 
 Request request = new Request . Builder ( ) 
 - . url ( Constants . AUTH _ SERVER _ URL ) 
 + . post ( RequestBody . create ( MediaType . parse ( " application / json ; charset = utf - 8 " ) , " " ) ) 
 + . url ( Constants . AUTH _ URL ) 
 . build ( ) ; 
 
 while ( retryTimes ! = 0 ) { 
 + Response response = null ; 
 try { 
 - Response response = client . newCall ( request ) . execute ( ) ; 
 - if ( response . isSuccessful ( ) ) { 
 + response = client . newCall ( request ) . execute ( ) ; 
 + if ( response . code ( ) = = 400 ) { 
 return true ; 
 } 
 RealmLog . error ( " Error response from auth server : % s " , response . toString ( ) ) ; 
 } catch ( IOException e ) { 
 RealmLog . error ( e ) ; 
 Thread . sleep ( 100 ) ; 
 + } finally { 
 + if ( response ! = null ) { 
 + response . close ( ) ; 
 + } 
 } 
 retryTimes - - ; 
 } 
 diff - - git a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / utils / UserFactory . java b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / utils / UserFactory . java 
 index 1ebb2d6 . . 9e6c43d 100644 
 - - - a / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / utils / UserFactory . java 
 + + + b / realm / realm - library / src / syncIntegrationTest / java / io / realm / objectserver / utils / UserFactory . java 
 @ @ - 16 , 25 + 16 , 13 @ @ 
 
 package io . realm . objectserver . utils ; 
 
 - import java . net . URI ; 
 - import java . net . URISyntaxException ; 
 - 
 + import io . realm . SyncCredentials ; 
 import io . realm . SyncUser ; 
 - import io . realm . objectserver . utils . Constants ; 
 
 / / Must be in ` io . realm . objectserver ` to work around package protected methods . 
 public class UserFactory { 
 - / / FIXME : Not working right now . 
 - / * 
 - public static User createDefaultUser ( String SERVER _ URL , String USER _ TOKEN ) { 
 - try { 
 - User user = User . createLocal ( ) ; 
 - 
 - user . addAccessToken ( new URI ( SERVER _ URL ) , USER _ TOKEN ) ; 
 - return user ; 
 - } catch ( URISyntaxException e ) { 
 - throw new RuntimeException ( e ) ; 
 - } 
 + public static SyncUser createDefaultUser ( String authUrl , String accessToken ) { 
 + SyncCredentials credentials = SyncCredentials . accessToken ( accessToken , " sync - integration - user " ) ; 
 + return SyncUser . login ( credentials , authUrl ) ; 
 } 
 - * / 
 } 
 diff - - git a / tools / sync _ test _ server / ros - testing - server . js b / tools / sync _ test _ server / ros - testing - server . js 
 index c182652 . . 6ddef03 100755 
 - - - a / tools / sync _ test _ server / ros - testing - server . js 
 + + + b / tools / sync _ test _ server / ros - testing - server . js 
 @ @ - 1 , 6 + 1 , 6 @ @ 
 # ! / usr / bin / env nodejs 
 
 - var winston = require ( ' winston ' ) ; / / logging 
 + var winston = require ( ' winston ' ) ; / / logging 
 const temp = require ( ' temp ' ) ; 
 const spawn = require ( ' child _ process ' ) . spawn ; 
 var http = require ( ' http ' ) ; 
 @ @ - 23 , 7 + 23 , 7 @ @ function handleRequest ( request , response ) { 
 try { 
 / / log the request on console 
 winston . log ( request . url ) ; 
 - / / Disptach 
 + / / Dispatch 
 dispatcher . dispatch ( request , response ) ; 
 } catch ( err ) { 
 console . log ( err ) ; 
 diff - - git a / tools / sync _ test _ server / start _ server . sh b / tools / sync _ test _ server / start _ server . sh 
 index 00930f5 . . 277bb4b 100755 
 - - - a / tools / sync _ test _ server / start _ server . sh 
 + + + b / tools / sync _ test _ server / start _ server . sh 
 @ @ - 9 , 9 + 9 , 10 @ @ TMP _ DIR = $ ( mktemp - d / tmp / sync - test . XXXX ) | | { echo " Failed to mktemp $ TEST _ TEMP _ 
 
 adb reverse tcp : 7800 tcp : 7800 & & \ 
 adb reverse tcp : 8080 tcp : 8080 & & \ 
 + adb reverse tcp : 9080 tcp : 9080 & & \ 
 adb reverse tcp : 8888 tcp : 8888 | | { echo " Failed to reverse adb port . " ; exit 1 ; } 
 
 docker build $ DOCKERFILE _ DIR - - build - arg ROS _ DE _ VERSION = $ ROS _ DE _ VERSION - t sync - test - server | | { echo " Failed to build Docker image . " ; exit 1 ; } 
 
 echo " See log files in $ TMP _ DIR " 
 - docker run - p 8080 : 8080 - p 7800 : 7800 - p 8888 : 8888 - v $ TMP _ DIR : / tmp - - name sync - test - server sync - test - server 
 + docker run - p 9080 : 9080 - p 8080 : 8080 - p 7800 : 7800 - p 8888 : 8888 - v $ TMP _ DIR : / tmp - - name sync - test - server sync - test - server
