BLEU SCORE: 0.07986788803078405

TEST MSG: Add Collection . deleteXxx
GENERATED MSG: Wrap NotificationToken

TEST DIFF (one line): diff - - git a / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp b / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp <nl> index daf17d3 . . 71312a4 100644 <nl> - - - a / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp <nl> + + + b / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp <nl> @ @ - 24 , 7 + 24 , 6 @ @ <nl> <nl> # include " util . hpp " <nl> # include " jni _ util / method . hpp " <nl> - # include " jni _ util / log . hpp " <nl> <nl> using namespace realm ; <nl> using namespace realm : : jni _ util ; <nl> @ @ - 61 , 10 + 60 , 8 @ @ struct ResultsWrapper { <nl> inline Results & get _ results ( ) <nl> { <nl> if ( m _ snapshot . get _ mode ( ) = = Results : : Mode : : Empty ) { <nl> - Log : : e ( " Using origin . " ) ; <nl> return m _ results ; <nl> } else { <nl> - Log : : e ( " Using snapshot . " ) ; <nl> return m _ snapshot ; <nl> } <nl> } <nl> @ @ - 374 , 3 + 371 , 56 @ @ Java _ io _ realm _ internal _ Collection _ nativeDisableSnapshot ( JNIEnv * env , jclass , jlo <nl> wrapper - > switch _ to _ origin ( ) ; <nl> } CATCH _ STD ( ) <nl> } <nl> + <nl> + JNIEXPORT jboolean JNICALL <nl> + Java _ io _ realm _ internal _ Collection _ nativeDeleteLast ( JNIEnv * env , jclass , jlong native _ ptr ) <nl> + { <nl> + TR _ ENTER _ PTR ( native _ ptr ) <nl> + try { <nl> + auto wrapper = reinterpret _ cast < ResultsWrapper * > ( native _ ptr ) ; <nl> + if ( wrapper - > get _ results ( ) . size ( ) > 0 ) { <nl> + wrapper - > get _ results ( ) . get _ tableview ( ) . remove _ last ( ) ; <nl> + / / Refresh snapshot <nl> + wrapper - > switch _ to _ snapshot ( ) ; <nl> + return JNI _ TRUE ; <nl> + } <nl> + } CATCH _ STD ( ) <nl> + <nl> + return JNI _ FALSE ; <nl> + } <nl> + <nl> + JNIEXPORT jboolean JNICALL <nl> + Java _ io _ realm _ internal _ Collection _ nativeDeleteFirst ( JNIEnv * env , jclass , jlong native _ ptr ) <nl> + { <nl> + TR _ ENTER _ PTR ( native _ ptr ) <nl> + <nl> + try { <nl> + auto wrapper = reinterpret _ cast < ResultsWrapper * > ( native _ ptr ) ; <nl> + if ( wrapper - > get _ results ( ) . size ( ) > 0 ) { <nl> + wrapper - > get _ results ( ) . get _ tableview ( ) . remove ( 0 ) ; <nl> + / / Refresh snapshot <nl> + wrapper - > switch _ to _ snapshot ( ) ; <nl> + return JNI _ TRUE ; <nl> + } <nl> + } CATCH _ STD ( ) <nl> + <nl> + return JNI _ FALSE ; <nl> + } <nl> + <nl> + JNIEXPORT void JNICALL <nl> + Java _ io _ realm _ internal _ Collection _ nativeDelete ( JNIEnv * env , jclass , jlong native _ ptr , jlong index ) <nl> + { <nl> + TR _ ENTER _ PTR ( native _ ptr ) <nl> + <nl> + try { <nl> + auto wrapper = reinterpret _ cast < ResultsWrapper * > ( native _ ptr ) ; <nl> + auto view = wrapper - > get _ results ( ) . get _ tableview ( ) ; <nl> + size _ t size = view . size ( ) ; <nl> + if ( index < 0 | | index > = size ) { <nl> + throw Results : : OutOfBoundsIndexException { static _ cast < size _ t > ( index ) , size } ; <nl> + } <nl> + view . remove ( static _ cast < size _ t > ( index ) ) ; <nl> + / / Refresh snapshot <nl> + wrapper - > switch _ to _ snapshot ( ) ; <nl> + } CATCH _ STD ( ) <nl> + } <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / RealmResults . java b / realm / realm - library / src / main / java / io / realm / RealmResults . java <nl> index 77eae57 . . 83a92bc 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / RealmResults . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / RealmResults . java <nl> @ @ - 219 , 9 + 219 , 9 @ @ public final class RealmResults < E extends RealmModel > extends AbstractList < E > im <nl> * / <nl> @ Override <nl> public void deleteFromRealm ( int location ) { <nl> - realm . checkIfValid ( ) ; <nl> - / / FIXME : Implement this ! <nl> - throw new RuntimeException ( " FIXME : Implement this ! " ) ; <nl> + / / TODO : Implement the deleteLast in OS level and do check there ! <nl> + realm . checkIfValidAndInTransaction ( ) ; <nl> + collection . delete ( location ) ; <nl> } <nl> <nl> / * * <nl> @ @ - 540 , 14 + 540 , 9 @ @ public final class RealmResults < E extends RealmModel > extends AbstractList < E > im <nl> * / <nl> @ Override <nl> public boolean deleteLastFromRealm ( ) { <nl> - realm . checkIfValid ( ) ; <nl> - if ( size ( ) > 0 ) { <nl> - / / FIXME : Implement this ! <nl> - throw new RuntimeException ( " FIXME : Implement this ! " ) ; <nl> - / / return true ; <nl> - } else { <nl> - return false ; <nl> - } <nl> + / / TODO : Implement the deleteLast in OS level and do check there ! <nl> + realm . checkIfValidAndInTransaction ( ) ; <nl> + return collection . deleteLast ( ) ; <nl> } <nl> <nl> / * * <nl> @ @ - 557 , 13 + 552 , 9 @ @ public final class RealmResults < E extends RealmModel > extends AbstractList < E > im <nl> * / <nl> @ Override <nl> public boolean deleteFirstFromRealm ( ) { <nl> - if ( size ( ) > 0 ) { <nl> - / / FIXME : Implement this ! <nl> - throw new RuntimeException ( " FIXME : Implement this ! " ) ; <nl> - / / return true ; <nl> - } else { <nl> - return false ; <nl> - } <nl> + / / TODO : Implement the deleteLast in OS level and do check there ! <nl> + realm . checkIfValidAndInTransaction ( ) ; <nl> + return collection . deleteFirst ( ) ; <nl> } <nl> <nl> / * * <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / internal / Collection . java b / realm / realm - library / src / main / java / io / realm / internal / Collection . java <nl> index b1eb397 . . 1443bf7 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / internal / Collection . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / internal / Collection . java <nl> @ @ - 171 , 6 + 171 , 18 @ @ public final class Collection implements NativeObject { <nl> return ( index > Integer . MAX _ VALUE ) ? Integer . MAX _ VALUE : ( int ) index ; <nl> } <nl> <nl> + public void delete ( long index ) { <nl> + nativeDelete ( nativePtr , index ) ; <nl> + } <nl> + <nl> + public boolean deleteFirst ( ) { <nl> + return nativeDeleteFirst ( nativePtr ) ; <nl> + } <nl> + <nl> + public boolean deleteLast ( ) { <nl> + return nativeDeleteLast ( nativePtr ) ; <nl> + } <nl> + <nl> public < T > void addListener ( T observer , RealmChangeListener < T > listener ) { <nl> if ( observerPairs . isEmpty ( ) ) { <nl> nativeStartListening ( nativePtr ) ; <nl> @ @ - 234 , 6 + 246 , 9 @ @ public final class Collection implements NativeObject { <nl> private static native long nativeSize ( long nativePtr ) ; <nl> private static native Object nativeAggregate ( long nativePtr , long columnIndex , byte aggregateFunc ) ; <nl> private static native long nativeSort ( long nativePtr , long sortDescNativePtr ) ; <nl> + private static native boolean nativeDeleteFirst ( long nativePtr ) ; <nl> + private static native boolean nativeDeleteLast ( long nativePtr ) ; <nl> + private static native void nativeDelete ( long nativePtr , long index ) ; <nl> / / Non - static , we need this Collection object in JNI . <nl> private native void nativeStartListening ( long nativePtr ) ; <nl> private native void nativeStopListening ( long nativePtr ) ;
NEAREST DIFF (one line): diff - - git a / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp b / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp <nl> index c4e8d6c . . dcd63e8 100644 <nl> - - - a / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp <nl> + + + b / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp <nl> @ @ - 26 , 6 + 26 , 24 @ @ <nl> <nl> using namespace realm ; <nl> <nl> + static void finalize _ results ( jlong ptr ) ; <nl> + static void finalize _ notification _ token ( jlong ptr ) ; <nl> + <nl> + static void finalize _ results ( jlong ptr ) <nl> + { <nl> + TR _ ENTER _ PTR ( ptr ) ; <nl> + delete reinterpret _ cast < Results * > ( ptr ) ; <nl> + } <nl> + <nl> + static void finalize _ notification _ token ( jlong ptr ) <nl> + { <nl> + TR _ ENTER _ PTR ( ptr ) ; <nl> + / / NotificationToken can be closed by NotificationToken . close ( ) . Then ptr will be reset in that case . <nl> + if ( ptr ) { <nl> + delete reinterpret _ cast < NotificationToken * > ( ptr ) ; <nl> + } <nl> + } <nl> + <nl> JNIEXPORT jlong JNICALL <nl> Java _ io _ realm _ internal _ Collection _ nativeCreateResults ( JNIEnv * env , jclass , jlong shared _ realm _ ptr , jlong query _ ptr , <nl> jlongArray colunm _ indices , jbooleanArray jsort _ orders ) <nl> @ @ - 205 , 10 + 223 , 29 @ @ Java _ io _ realm _ internal _ Collection _ nativeAddListener ( JNIEnv * env , jobject instanc <nl> } ; <nl> <nl> NotificationToken token = results - > add _ notification _ callback ( cb ) ; <nl> - / / FIXME : Let ' s leak them ALL for now ! ! <nl> - return reinterpret _ cast < jlong > ( <nl> - new std : : unique _ ptr < NotificationToken > ( new NotificationToken ( std : : move ( token ) ) ) ) ; <nl> + return reinterpret _ cast < jlong > ( new NotificationToken ( std : : move ( token ) ) ) ; <nl> } CATCH _ STD ( ) <nl> <nl> return reinterpret _ cast < jlong > ( nullptr ) ; <nl> } <nl> + <nl> + JNIEXPORT jlong JNICALL <nl> + Java _ io _ realm _ internal _ Collection _ nativeGetFinalizerPtr ( JNIEnv * , jclass ) <nl> + { <nl> + TR _ ENTER ( ) <nl> + return reinterpret _ cast < jlong > ( & finalize _ results ) ; <nl> + } <nl> + <nl> + JNIEXPORT jlong JNICALL <nl> + Java _ io _ realm _ internal _ Collection _ nativeNotificationTokenGetFinalizerPtr ( JNIEnv * , jclass ) <nl> + { <nl> + TR _ ENTER ( ) <nl> + return reinterpret _ cast < jlong > ( & finalize _ notification _ token ) ; <nl> + } <nl> + <nl> + JNIEXPORT jlong JNICALL <nl> + Java _ io _ realm _ internal _ Collection _ nativeNotificationTokenClose ( JNIEnv * , jclass , jlong native _ ptr ) <nl> + { <nl> + TR _ ENTER _ PTR ( native _ ptr ) <nl> + delete reinterpret _ cast < NotificationToken * > ( native _ ptr ) ; <nl> + } <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / RealmResults . java b / realm / realm - library / src / main / java / io / realm / RealmResults . java <nl> index 2c4e578 . . 4a68b92 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / RealmResults . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / RealmResults . java <nl> @ @ - 97 , 7 + 97 , 8 @ @ public final class RealmResults < E extends RealmModel > extends AbstractList < E > im <nl> <nl> static < E extends RealmModel > RealmResults < E > createFromQuery ( BaseRealm realm , TableQuery query , Class < E > clazz , <nl> String fieldNames [ ] , Sort [ ] sortOrder ) { <nl> - return new RealmResults < E > ( realm , query , clazz , fieldNames , sortOrder ) ; <nl> + Collection collection = new Collection ( realm . sharedRealm , query , null , null ) ; <nl> + return new RealmResults < E > ( realm , collection , clazz ) ; <nl> } <nl> <nl> static < E extends RealmModel > RealmResults < E > createFromTableQuery ( BaseRealm realm , TableQuery query , Class < E > clazz ) { <nl> @ @ - 1009 , 12 + 1010 , 7 @ @ public final class RealmResults < E extends RealmModel > extends AbstractList < E > im <nl> throw new IllegalArgumentException ( " Listener should not be null " ) ; <nl> } <nl> realm . checkIfValid ( ) ; <nl> - if ( listeners . isEmpty ( ) ) { <nl> - / / nativeAddListener ( nativePtr ) ; <nl> - } <nl> - if ( ! listeners . contains ( listener ) ) { <nl> - listeners . add ( listener ) ; <nl> - } <nl> + collection . addListener ( new Collection . Listener ( listener , this ) ) ; <nl> } <nl> <nl> / * * <nl> @ @ - 1029 , 7 + 1025 , 7 @ @ public final class RealmResults < E extends RealmModel > extends AbstractList < E > im <nl> throw new IllegalArgumentException ( " Listener should not be null " ) ; <nl> } <nl> realm . checkIfValid ( ) ; <nl> - listeners . remove ( listener ) ; <nl> + collection . removeListener ( new Collection . Listener ( listener , this ) ) ; <nl> } <nl> <nl> / * * <nl> @ @ - 1037 , 7 + 1033 , 7 @ @ public final class RealmResults < E extends RealmModel > extends AbstractList < E > im <nl> * / <nl> public void removeChangeListeners ( ) { <nl> realm . checkIfValid ( ) ; <nl> - listeners . clear ( ) ; <nl> + collection . removeAllListeners ( ) ; <nl> } <nl> <nl> / * * <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / internal / Collection . java b / realm / realm - library / src / main / java / io / realm / internal / Collection . java <nl> index be3c35d . . 05872dd 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / internal / Collection . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / internal / Collection . java <nl> @ @ - 16 , 18 + 16 , 69 @ @ <nl> <nl> package io . realm . internal ; <nl> <nl> + import java . lang . ref . WeakReference ; <nl> + import java . util . List ; <nl> + import java . util . concurrent . CopyOnWriteArrayList ; <nl> + <nl> import io . realm . RealmChangeListener ; <nl> <nl> public class Collection implements NativeObject { <nl> <nl> - public interface Listener { <nl> - void onChange ( ) ; <nl> + public static class Listener { <nl> + private final RealmChangeListener realmChangeListener ; <nl> + private final WeakReference < Object > objectRef ; <nl> + <nl> + public Listener ( RealmChangeListener realmChangeListener , Object objectRef ) { <nl> + this . realmChangeListener = realmChangeListener ; <nl> + this . objectRef = new WeakReference < Object > ( objectRef ) ; <nl> + } <nl> + <nl> + @ Override <nl> + public boolean equals ( Object obj ) { <nl> + if ( this = = obj ) { <nl> + return true ; <nl> + } <nl> + <nl> + if ( obj instanceof Listener ) { <nl> + Listener anotherListener = ( Listener ) obj ; <nl> + return realmChangeListener . equals ( anotherListener . realmChangeListener ) & & <nl> + objectRef . equals ( anotherListener . objectRef ) ; <nl> + } <nl> + return false ; <nl> + } <nl> + } <nl> + <nl> + private static class NotificationToken implements NativeObject { <nl> + private long nativePtr ; <nl> + private static final long nativeFinalizerPtr = nativeNotificationTokenGetFinalizerPtr ( ) ; <nl> + <nl> + NotificationToken ( long nativePtr ) { <nl> + this . nativePtr = nativePtr ; <nl> + Context . sharedContext . addReference ( this ) ; <nl> + } <nl> + <nl> + @ Override <nl> + public long getNativePtr ( ) { <nl> + return nativePtr ; <nl> + } <nl> + <nl> + @ Override <nl> + public long getNativeFinalizerPtr ( ) { <nl> + return nativeFinalizerPtr ; <nl> + } <nl> + <nl> + public void close ( ) { <nl> + nativeNotificationTokenClose ( nativePtr ) ; <nl> + nativePtr = 0 ; <nl> + } <nl> } <nl> - <nl> + <nl> private final long nativePtr ; <nl> private static final long nativeFinalizerPtr = nativeGetFinalizerPtr ( ) ; <nl> private final Context context ; <nl> private final TableQuery query ; <nl> + private final List < Listener > listeners = new CopyOnWriteArrayList < Listener > ( ) ; <nl> + private NotificationToken notificationToken = null ; <nl> <nl> / / Public for static checking in JNI <nl> public static final byte AGGREGATE _ FUNCTION _ MINIMUM = 1 ; <nl> @ @ - 52 , 11 + 103 , 12 @ @ public class Collection implements NativeObject { <nl> } <nl> } <nl> <nl> - protected Collection ( SharedRealm sharedRealm , TableQuery query , long indices [ ] , boolean [ ] orders ) { <nl> + public Collection ( SharedRealm sharedRealm , TableQuery query , long indices [ ] , boolean [ ] orders ) { <nl> this . context = sharedRealm . context ; <nl> this . query = query ; <nl> <nl> this . nativePtr = nativeCreateResults ( sharedRealm . getNativePtr ( ) , query . getNativePtr ( ) , indices , orders ) ; <nl> + this . context . addReference ( this ) ; <nl> } <nl> <nl> @ Override <nl> @ @ - 86 , 6 + 138 , 47 @ @ public class Collection implements NativeObject { <nl> nativeClear ( nativePtr ) ; <nl> } <nl> <nl> + public void addListener ( Listener listener ) { <nl> + if ( ! listeners . contains ( listener ) ) { <nl> + listeners . add ( listener ) ; <nl> + } <nl> + if ( notificationToken = = null ) { <nl> + notificationToken = new NotificationToken ( nativeAddListener ( nativePtr ) ) ; <nl> + } <nl> + } <nl> + <nl> + public void removeListener ( Listener listener ) { <nl> + listeners . remove ( listener ) ; <nl> + if ( listeners . isEmpty ( ) & & notificationToken ! = null ) { <nl> + notificationToken . close ( ) ; <nl> + notificationToken = null ; <nl> + } <nl> + } <nl> + <nl> + public void removeAllListeners ( ) { <nl> + listeners . clear ( ) ; <nl> + if ( notificationToken ! = null ) { <nl> + notificationToken . close ( ) ; <nl> + notificationToken = null ; <nl> + } <nl> + } <nl> + <nl> + / / Called by JNI <nl> + @ SuppressWarnings ( " unused " ) <nl> + private void notifyChangeListeners ( ) { <nl> + if ( ! listeners . isEmpty ( ) ) { <nl> + for ( Listener listener : listeners ) { <nl> + Object obj = listener . objectRef . get ( ) ; <nl> + if ( obj = = null ) { <nl> + listeners . remove ( listener ) ; <nl> + continue ; <nl> + } <nl> + / / noinspection unchecked <nl> + listener . realmChangeListener . onChange ( obj ) ; <nl> + } <nl> + } <nl> + } <nl> + <nl> private static native long nativeGetFinalizerPtr ( ) ; <nl> private static native long nativeCreateResults ( long sharedRealmNativePtr , long queryNativePtr , long [ ] columnIndices , <nl> boolean [ ] orders ) ; <nl> @ @ - 97 , 4 + 190 , 6 @ @ public class Collection implements NativeObject { <nl> private static native Object nativeAggregate ( long nativePtr , long columnIndex , byte aggregateFunc ) ; <nl> private static native long nativeSort ( long nativePtr , long [ ] columnIndices , boolean [ ] orders ) ; <nl> private native long nativeAddListener ( long nativePtr ) ; <nl> + private static native long nativeNotificationTokenGetFinalizerPtr ( ) ; <nl> + private static native long nativeNotificationTokenClose ( long nativePtr ) ; <nl> } <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / internal / Context . java b / realm / realm - library / src / main / java / io / realm / internal / Context . java <nl> index 9dc084e . . d68bceb 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / internal / Context . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / internal / Context . java <nl> @ @ - 29 , 6 + 29 , 9 @ @ public class Context { <nl> private final static ReferenceQueue < NativeObject > referenceQueue = new ReferenceQueue < NativeObject > ( ) ; <nl> private final static Thread finalizingThread = new Thread ( new FinalizerRunnable ( referenceQueue ) ) ; <nl> <nl> + / / Context instance for native objects which are always thread - safe to be created and freed . <nl> + public final static Context sharedContext = new Context ( ) ; <nl> + <nl> static { <nl> finalizingThread . setName ( " RealmFinalizingDaemon " ) ; <nl> finalizingThread . start ( ) ;

TEST DIFF:
diff - - git a / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp b / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp 
 index daf17d3 . . 71312a4 100644 
 - - - a / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp 
 + + + b / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp 
 @ @ - 24 , 7 + 24 , 6 @ @ 
 
 # include " util . hpp " 
 # include " jni _ util / method . hpp " 
 - # include " jni _ util / log . hpp " 
 
 using namespace realm ; 
 using namespace realm : : jni _ util ; 
 @ @ - 61 , 10 + 60 , 8 @ @ struct ResultsWrapper { 
 inline Results & get _ results ( ) 
 { 
 if ( m _ snapshot . get _ mode ( ) = = Results : : Mode : : Empty ) { 
 - Log : : e ( " Using origin . " ) ; 
 return m _ results ; 
 } else { 
 - Log : : e ( " Using snapshot . " ) ; 
 return m _ snapshot ; 
 } 
 } 
 @ @ - 374 , 3 + 371 , 56 @ @ Java _ io _ realm _ internal _ Collection _ nativeDisableSnapshot ( JNIEnv * env , jclass , jlo 
 wrapper - > switch _ to _ origin ( ) ; 
 } CATCH _ STD ( ) 
 } 
 + 
 + JNIEXPORT jboolean JNICALL 
 + Java _ io _ realm _ internal _ Collection _ nativeDeleteLast ( JNIEnv * env , jclass , jlong native _ ptr ) 
 + { 
 + TR _ ENTER _ PTR ( native _ ptr ) 
 + try { 
 + auto wrapper = reinterpret _ cast < ResultsWrapper * > ( native _ ptr ) ; 
 + if ( wrapper - > get _ results ( ) . size ( ) > 0 ) { 
 + wrapper - > get _ results ( ) . get _ tableview ( ) . remove _ last ( ) ; 
 + / / Refresh snapshot 
 + wrapper - > switch _ to _ snapshot ( ) ; 
 + return JNI _ TRUE ; 
 + } 
 + } CATCH _ STD ( ) 
 + 
 + return JNI _ FALSE ; 
 + } 
 + 
 + JNIEXPORT jboolean JNICALL 
 + Java _ io _ realm _ internal _ Collection _ nativeDeleteFirst ( JNIEnv * env , jclass , jlong native _ ptr ) 
 + { 
 + TR _ ENTER _ PTR ( native _ ptr ) 
 + 
 + try { 
 + auto wrapper = reinterpret _ cast < ResultsWrapper * > ( native _ ptr ) ; 
 + if ( wrapper - > get _ results ( ) . size ( ) > 0 ) { 
 + wrapper - > get _ results ( ) . get _ tableview ( ) . remove ( 0 ) ; 
 + / / Refresh snapshot 
 + wrapper - > switch _ to _ snapshot ( ) ; 
 + return JNI _ TRUE ; 
 + } 
 + } CATCH _ STD ( ) 
 + 
 + return JNI _ FALSE ; 
 + } 
 + 
 + JNIEXPORT void JNICALL 
 + Java _ io _ realm _ internal _ Collection _ nativeDelete ( JNIEnv * env , jclass , jlong native _ ptr , jlong index ) 
 + { 
 + TR _ ENTER _ PTR ( native _ ptr ) 
 + 
 + try { 
 + auto wrapper = reinterpret _ cast < ResultsWrapper * > ( native _ ptr ) ; 
 + auto view = wrapper - > get _ results ( ) . get _ tableview ( ) ; 
 + size _ t size = view . size ( ) ; 
 + if ( index < 0 | | index > = size ) { 
 + throw Results : : OutOfBoundsIndexException { static _ cast < size _ t > ( index ) , size } ; 
 + } 
 + view . remove ( static _ cast < size _ t > ( index ) ) ; 
 + / / Refresh snapshot 
 + wrapper - > switch _ to _ snapshot ( ) ; 
 + } CATCH _ STD ( ) 
 + } 
 diff - - git a / realm / realm - library / src / main / java / io / realm / RealmResults . java b / realm / realm - library / src / main / java / io / realm / RealmResults . java 
 index 77eae57 . . 83a92bc 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / RealmResults . java 
 + + + b / realm / realm - library / src / main / java / io / realm / RealmResults . java 
 @ @ - 219 , 9 + 219 , 9 @ @ public final class RealmResults < E extends RealmModel > extends AbstractList < E > im 
 * / 
 @ Override 
 public void deleteFromRealm ( int location ) { 
 - realm . checkIfValid ( ) ; 
 - / / FIXME : Implement this ! 
 - throw new RuntimeException ( " FIXME : Implement this ! " ) ; 
 + / / TODO : Implement the deleteLast in OS level and do check there ! 
 + realm . checkIfValidAndInTransaction ( ) ; 
 + collection . delete ( location ) ; 
 } 
 
 / * * 
 @ @ - 540 , 14 + 540 , 9 @ @ public final class RealmResults < E extends RealmModel > extends AbstractList < E > im 
 * / 
 @ Override 
 public boolean deleteLastFromRealm ( ) { 
 - realm . checkIfValid ( ) ; 
 - if ( size ( ) > 0 ) { 
 - / / FIXME : Implement this ! 
 - throw new RuntimeException ( " FIXME : Implement this ! " ) ; 
 - / / return true ; 
 - } else { 
 - return false ; 
 - } 
 + / / TODO : Implement the deleteLast in OS level and do check there ! 
 + realm . checkIfValidAndInTransaction ( ) ; 
 + return collection . deleteLast ( ) ; 
 } 
 
 / * * 
 @ @ - 557 , 13 + 552 , 9 @ @ public final class RealmResults < E extends RealmModel > extends AbstractList < E > im 
 * / 
 @ Override 
 public boolean deleteFirstFromRealm ( ) { 
 - if ( size ( ) > 0 ) { 
 - / / FIXME : Implement this ! 
 - throw new RuntimeException ( " FIXME : Implement this ! " ) ; 
 - / / return true ; 
 - } else { 
 - return false ; 
 - } 
 + / / TODO : Implement the deleteLast in OS level and do check there ! 
 + realm . checkIfValidAndInTransaction ( ) ; 
 + return collection . deleteFirst ( ) ; 
 } 
 
 / * * 
 diff - - git a / realm / realm - library / src / main / java / io / realm / internal / Collection . java b / realm / realm - library / src / main / java / io / realm / internal / Collection . java 
 index b1eb397 . . 1443bf7 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / internal / Collection . java 
 + + + b / realm / realm - library / src / main / java / io / realm / internal / Collection . java 
 @ @ - 171 , 6 + 171 , 18 @ @ public final class Collection implements NativeObject { 
 return ( index > Integer . MAX _ VALUE ) ? Integer . MAX _ VALUE : ( int ) index ; 
 } 
 
 + public void delete ( long index ) { 
 + nativeDelete ( nativePtr , index ) ; 
 + } 
 + 
 + public boolean deleteFirst ( ) { 
 + return nativeDeleteFirst ( nativePtr ) ; 
 + } 
 + 
 + public boolean deleteLast ( ) { 
 + return nativeDeleteLast ( nativePtr ) ; 
 + } 
 + 
 public < T > void addListener ( T observer , RealmChangeListener < T > listener ) { 
 if ( observerPairs . isEmpty ( ) ) { 
 nativeStartListening ( nativePtr ) ; 
 @ @ - 234 , 6 + 246 , 9 @ @ public final class Collection implements NativeObject { 
 private static native long nativeSize ( long nativePtr ) ; 
 private static native Object nativeAggregate ( long nativePtr , long columnIndex , byte aggregateFunc ) ; 
 private static native long nativeSort ( long nativePtr , long sortDescNativePtr ) ; 
 + private static native boolean nativeDeleteFirst ( long nativePtr ) ; 
 + private static native boolean nativeDeleteLast ( long nativePtr ) ; 
 + private static native void nativeDelete ( long nativePtr , long index ) ; 
 / / Non - static , we need this Collection object in JNI . 
 private native void nativeStartListening ( long nativePtr ) ; 
 private native void nativeStopListening ( long nativePtr ) ;

NEAREST DIFF:
diff - - git a / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp b / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp 
 index c4e8d6c . . dcd63e8 100644 
 - - - a / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp 
 + + + b / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp 
 @ @ - 26 , 6 + 26 , 24 @ @ 
 
 using namespace realm ; 
 
 + static void finalize _ results ( jlong ptr ) ; 
 + static void finalize _ notification _ token ( jlong ptr ) ; 
 + 
 + static void finalize _ results ( jlong ptr ) 
 + { 
 + TR _ ENTER _ PTR ( ptr ) ; 
 + delete reinterpret _ cast < Results * > ( ptr ) ; 
 + } 
 + 
 + static void finalize _ notification _ token ( jlong ptr ) 
 + { 
 + TR _ ENTER _ PTR ( ptr ) ; 
 + / / NotificationToken can be closed by NotificationToken . close ( ) . Then ptr will be reset in that case . 
 + if ( ptr ) { 
 + delete reinterpret _ cast < NotificationToken * > ( ptr ) ; 
 + } 
 + } 
 + 
 JNIEXPORT jlong JNICALL 
 Java _ io _ realm _ internal _ Collection _ nativeCreateResults ( JNIEnv * env , jclass , jlong shared _ realm _ ptr , jlong query _ ptr , 
 jlongArray colunm _ indices , jbooleanArray jsort _ orders ) 
 @ @ - 205 , 10 + 223 , 29 @ @ Java _ io _ realm _ internal _ Collection _ nativeAddListener ( JNIEnv * env , jobject instanc 
 } ; 
 
 NotificationToken token = results - > add _ notification _ callback ( cb ) ; 
 - / / FIXME : Let ' s leak them ALL for now ! ! 
 - return reinterpret _ cast < jlong > ( 
 - new std : : unique _ ptr < NotificationToken > ( new NotificationToken ( std : : move ( token ) ) ) ) ; 
 + return reinterpret _ cast < jlong > ( new NotificationToken ( std : : move ( token ) ) ) ; 
 } CATCH _ STD ( ) 
 
 return reinterpret _ cast < jlong > ( nullptr ) ; 
 } 
 + 
 + JNIEXPORT jlong JNICALL 
 + Java _ io _ realm _ internal _ Collection _ nativeGetFinalizerPtr ( JNIEnv * , jclass ) 
 + { 
 + TR _ ENTER ( ) 
 + return reinterpret _ cast < jlong > ( & finalize _ results ) ; 
 + } 
 + 
 + JNIEXPORT jlong JNICALL 
 + Java _ io _ realm _ internal _ Collection _ nativeNotificationTokenGetFinalizerPtr ( JNIEnv * , jclass ) 
 + { 
 + TR _ ENTER ( ) 
 + return reinterpret _ cast < jlong > ( & finalize _ notification _ token ) ; 
 + } 
 + 
 + JNIEXPORT jlong JNICALL 
 + Java _ io _ realm _ internal _ Collection _ nativeNotificationTokenClose ( JNIEnv * , jclass , jlong native _ ptr ) 
 + { 
 + TR _ ENTER _ PTR ( native _ ptr ) 
 + delete reinterpret _ cast < NotificationToken * > ( native _ ptr ) ; 
 + } 
 diff - - git a / realm / realm - library / src / main / java / io / realm / RealmResults . java b / realm / realm - library / src / main / java / io / realm / RealmResults . java 
 index 2c4e578 . . 4a68b92 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / RealmResults . java 
 + + + b / realm / realm - library / src / main / java / io / realm / RealmResults . java 
 @ @ - 97 , 7 + 97 , 8 @ @ public final class RealmResults < E extends RealmModel > extends AbstractList < E > im 
 
 static < E extends RealmModel > RealmResults < E > createFromQuery ( BaseRealm realm , TableQuery query , Class < E > clazz , 
 String fieldNames [ ] , Sort [ ] sortOrder ) { 
 - return new RealmResults < E > ( realm , query , clazz , fieldNames , sortOrder ) ; 
 + Collection collection = new Collection ( realm . sharedRealm , query , null , null ) ; 
 + return new RealmResults < E > ( realm , collection , clazz ) ; 
 } 
 
 static < E extends RealmModel > RealmResults < E > createFromTableQuery ( BaseRealm realm , TableQuery query , Class < E > clazz ) { 
 @ @ - 1009 , 12 + 1010 , 7 @ @ public final class RealmResults < E extends RealmModel > extends AbstractList < E > im 
 throw new IllegalArgumentException ( " Listener should not be null " ) ; 
 } 
 realm . checkIfValid ( ) ; 
 - if ( listeners . isEmpty ( ) ) { 
 - / / nativeAddListener ( nativePtr ) ; 
 - } 
 - if ( ! listeners . contains ( listener ) ) { 
 - listeners . add ( listener ) ; 
 - } 
 + collection . addListener ( new Collection . Listener ( listener , this ) ) ; 
 } 
 
 / * * 
 @ @ - 1029 , 7 + 1025 , 7 @ @ public final class RealmResults < E extends RealmModel > extends AbstractList < E > im 
 throw new IllegalArgumentException ( " Listener should not be null " ) ; 
 } 
 realm . checkIfValid ( ) ; 
 - listeners . remove ( listener ) ; 
 + collection . removeListener ( new Collection . Listener ( listener , this ) ) ; 
 } 
 
 / * * 
 @ @ - 1037 , 7 + 1033 , 7 @ @ public final class RealmResults < E extends RealmModel > extends AbstractList < E > im 
 * / 
 public void removeChangeListeners ( ) { 
 realm . checkIfValid ( ) ; 
 - listeners . clear ( ) ; 
 + collection . removeAllListeners ( ) ; 
 } 
 
 / * * 
 diff - - git a / realm / realm - library / src / main / java / io / realm / internal / Collection . java b / realm / realm - library / src / main / java / io / realm / internal / Collection . java 
 index be3c35d . . 05872dd 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / internal / Collection . java 
 + + + b / realm / realm - library / src / main / java / io / realm / internal / Collection . java 
 @ @ - 16 , 18 + 16 , 69 @ @ 
 
 package io . realm . internal ; 
 
 + import java . lang . ref . WeakReference ; 
 + import java . util . List ; 
 + import java . util . concurrent . CopyOnWriteArrayList ; 
 + 
 import io . realm . RealmChangeListener ; 
 
 public class Collection implements NativeObject { 
 
 - public interface Listener { 
 - void onChange ( ) ; 
 + public static class Listener { 
 + private final RealmChangeListener realmChangeListener ; 
 + private final WeakReference < Object > objectRef ; 
 + 
 + public Listener ( RealmChangeListener realmChangeListener , Object objectRef ) { 
 + this . realmChangeListener = realmChangeListener ; 
 + this . objectRef = new WeakReference < Object > ( objectRef ) ; 
 + } 
 + 
 + @ Override 
 + public boolean equals ( Object obj ) { 
 + if ( this = = obj ) { 
 + return true ; 
 + } 
 + 
 + if ( obj instanceof Listener ) { 
 + Listener anotherListener = ( Listener ) obj ; 
 + return realmChangeListener . equals ( anotherListener . realmChangeListener ) & & 
 + objectRef . equals ( anotherListener . objectRef ) ; 
 + } 
 + return false ; 
 + } 
 + } 
 + 
 + private static class NotificationToken implements NativeObject { 
 + private long nativePtr ; 
 + private static final long nativeFinalizerPtr = nativeNotificationTokenGetFinalizerPtr ( ) ; 
 + 
 + NotificationToken ( long nativePtr ) { 
 + this . nativePtr = nativePtr ; 
 + Context . sharedContext . addReference ( this ) ; 
 + } 
 + 
 + @ Override 
 + public long getNativePtr ( ) { 
 + return nativePtr ; 
 + } 
 + 
 + @ Override 
 + public long getNativeFinalizerPtr ( ) { 
 + return nativeFinalizerPtr ; 
 + } 
 + 
 + public void close ( ) { 
 + nativeNotificationTokenClose ( nativePtr ) ; 
 + nativePtr = 0 ; 
 + } 
 } 
 - 
 + 
 private final long nativePtr ; 
 private static final long nativeFinalizerPtr = nativeGetFinalizerPtr ( ) ; 
 private final Context context ; 
 private final TableQuery query ; 
 + private final List < Listener > listeners = new CopyOnWriteArrayList < Listener > ( ) ; 
 + private NotificationToken notificationToken = null ; 
 
 / / Public for static checking in JNI 
 public static final byte AGGREGATE _ FUNCTION _ MINIMUM = 1 ; 
 @ @ - 52 , 11 + 103 , 12 @ @ public class Collection implements NativeObject { 
 } 
 } 
 
 - protected Collection ( SharedRealm sharedRealm , TableQuery query , long indices [ ] , boolean [ ] orders ) { 
 + public Collection ( SharedRealm sharedRealm , TableQuery query , long indices [ ] , boolean [ ] orders ) { 
 this . context = sharedRealm . context ; 
 this . query = query ; 
 
 this . nativePtr = nativeCreateResults ( sharedRealm . getNativePtr ( ) , query . getNativePtr ( ) , indices , orders ) ; 
 + this . context . addReference ( this ) ; 
 } 
 
 @ Override 
 @ @ - 86 , 6 + 138 , 47 @ @ public class Collection implements NativeObject { 
 nativeClear ( nativePtr ) ; 
 } 
 
 + public void addListener ( Listener listener ) { 
 + if ( ! listeners . contains ( listener ) ) { 
 + listeners . add ( listener ) ; 
 + } 
 + if ( notificationToken = = null ) { 
 + notificationToken = new NotificationToken ( nativeAddListener ( nativePtr ) ) ; 
 + } 
 + } 
 + 
 + public void removeListener ( Listener listener ) { 
 + listeners . remove ( listener ) ; 
 + if ( listeners . isEmpty ( ) & & notificationToken ! = null ) { 
 + notificationToken . close ( ) ; 
 + notificationToken = null ; 
 + } 
 + } 
 + 
 + public void removeAllListeners ( ) { 
 + listeners . clear ( ) ; 
 + if ( notificationToken ! = null ) { 
 + notificationToken . close ( ) ; 
 + notificationToken = null ; 
 + } 
 + } 
 + 
 + / / Called by JNI 
 + @ SuppressWarnings ( " unused " ) 
 + private void notifyChangeListeners ( ) { 
 + if ( ! listeners . isEmpty ( ) ) { 
 + for ( Listener listener : listeners ) { 
 + Object obj = listener . objectRef . get ( ) ; 
 + if ( obj = = null ) { 
 + listeners . remove ( listener ) ; 
 + continue ; 
 + } 
 + / / noinspection unchecked 
 + listener . realmChangeListener . onChange ( obj ) ; 
 + } 
 + } 
 + } 
 + 
 private static native long nativeGetFinalizerPtr ( ) ; 
 private static native long nativeCreateResults ( long sharedRealmNativePtr , long queryNativePtr , long [ ] columnIndices , 
 boolean [ ] orders ) ; 
 @ @ - 97 , 4 + 190 , 6 @ @ public class Collection implements NativeObject { 
 private static native Object nativeAggregate ( long nativePtr , long columnIndex , byte aggregateFunc ) ; 
 private static native long nativeSort ( long nativePtr , long [ ] columnIndices , boolean [ ] orders ) ; 
 private native long nativeAddListener ( long nativePtr ) ; 
 + private static native long nativeNotificationTokenGetFinalizerPtr ( ) ; 
 + private static native long nativeNotificationTokenClose ( long nativePtr ) ; 
 } 
 diff - - git a / realm / realm - library / src / main / java / io / realm / internal / Context . java b / realm / realm - library / src / main / java / io / realm / internal / Context . java 
 index 9dc084e . . d68bceb 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / internal / Context . java 
 + + + b / realm / realm - library / src / main / java / io / realm / internal / Context . java 
 @ @ - 29 , 6 + 29 , 9 @ @ public class Context { 
 private final static ReferenceQueue < NativeObject > referenceQueue = new ReferenceQueue < NativeObject > ( ) ; 
 private final static Thread finalizingThread = new Thread ( new FinalizerRunnable ( referenceQueue ) ) ; 
 
 + / / Context instance for native objects which are always thread - safe to be created and freed . 
 + public final static Context sharedContext = new Context ( ) ; 
 + 
 static { 
 finalizingThread . setName ( " RealmFinalizingDaemon " ) ; 
 finalizingThread . start ( ) ;
