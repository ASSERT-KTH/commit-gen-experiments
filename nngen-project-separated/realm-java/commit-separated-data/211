BLEU SCORE: 0.020980574531482755

TEST MSG: Fix bug where callback method wasn ' t available .
GENERATED MSG: Clean up Collection related code

TEST DIFF (one line): diff - - git a / realm / realm - library / src / main / cpp / io _ realm _ internal _ OsObject . cpp b / realm / realm - library / src / main / cpp / io _ realm _ internal _ OsObject . cpp <nl> index 78bc65f . . 8994340 100644 <nl> - - - a / realm / realm - library / src / main / cpp / io _ realm _ internal _ OsObject . cpp <nl> + + + b / realm / realm - library / src / main / cpp / io _ realm _ internal _ OsObject . cpp <nl> @ @ - 62 , 8 + 62 , 9 @ @ struct ObjectWrapper { <nl> } ; <nl> <nl> struct ChangeCallback { <nl> - ChangeCallback ( ObjectWrapper * wrapper ) <nl> - : m _ wrapper ( wrapper ) <nl> + ChangeCallback ( ObjectWrapper * wrapper , JavaMethod notify _ change _ listeners ) <nl> + : m _ wrapper ( wrapper ) , <nl> + m _ notify _ change _ listeners _ method ( notify _ change _ listeners ) <nl> { <nl> } <nl> <nl> @ @ - 126 , 12 + 127 , 8 @ @ struct ChangeCallback { <nl> } <nl> <nl> parse _ fields ( env , change _ set ) ; <nl> - <nl> m _ wrapper - > m _ row _ object _ weak _ ref . call _ with _ local _ ref ( env , [ & ] ( JNIEnv * , jobject row _ obj ) { <nl> - static JavaClass os _ object _ class ( env , " io / realm / internal / OsObject " ) ; <nl> - static JavaMethod notify _ change _ listeners ( env , os _ object _ class , " notifyChangeListeners " , <nl> - " ( [ Ljava / lang / String ; ) V " ) ; <nl> - env - > CallVoidMethod ( row _ obj , notify _ change _ listeners , m _ deleted ? nullptr : m _ field _ names _ array ) ; <nl> + env - > CallVoidMethod ( row _ obj , m _ notify _ change _ listeners _ method , m _ deleted ? nullptr : m _ field _ names _ array ) ; <nl> } ) ; <nl> m _ field _ names _ array = nullptr ; <nl> m _ deleted = false ; <nl> @ @ - 153 , 6 + 150 , 7 @ @ private : <nl> ObjectWrapper * m _ wrapper ; <nl> bool m _ deleted = false ; <nl> jobjectArray m _ field _ names _ array = nullptr ; <nl> + JavaMethod m _ notify _ change _ listeners _ method ; <nl> } ; <nl> <nl> static void finalize _ object ( jlong ptr ) <nl> @ @ - 270 , 10 + 268 , 13 @ @ JNIEXPORT void JNICALL Java _ io _ realm _ internal _ OsObject _ nativeStartListening ( JNIE <nl> wrapper - > m _ row _ object _ weak _ ref = JavaGlobalWeakRef ( env , instance ) ; <nl> } <nl> <nl> + static JavaClass os _ object _ class ( env , " io / realm / internal / OsObject " ) ; <nl> + static JavaMethod notify _ change _ listeners ( env , os _ object _ class , " notifyChangeListeners " , <nl> + " ( [ Ljava / lang / String ; ) V " ) ; <nl> / / The wrapper pointer will be used in the callback . But it should never become an invalid pointer when the <nl> / / notification block gets called . This should be guaranteed by the Object Store that after the notification <nl> / / token is destroyed , the block shouldn ' t be called . <nl> - wrapper - > m _ notification _ token = wrapper - > m _ object . add _ notification _ callback ( ChangeCallback ( wrapper ) ) ; <nl> + wrapper - > m _ notification _ token = wrapper - > m _ object . add _ notification _ callback ( ChangeCallback ( wrapper , notify _ change _ listeners ) ) ; <nl> } <nl> CATCH _ STD ( ) <nl> }
NEAREST DIFF (one line): diff - - git a / realm / realm - library / src / androidTest / java / io / realm / internal / CollectionTests . java b / realm / realm - library / src / androidTest / java / io / realm / internal / CollectionTests . java <nl> index 1a89734 . . 05ad2e5 100644 <nl> - - - a / realm / realm - library / src / androidTest / java / io / realm / internal / CollectionTests . java <nl> + + + b / realm / realm - library / src / androidTest / java / io / realm / internal / CollectionTests . java <nl> @ @ - 124 , 13 + 124 , 6 @ @ public class CollectionTests { <nl> sharedRealm . commitTransaction ( ) ; <nl> } <nl> <nl> - private void removeRow ( SharedRealm sharedRealm ) { <nl> - sharedRealm . beginTransaction ( ) ; <nl> - table = sharedRealm . getTable ( " test _ table " ) ; <nl> - table . remove ( 0 ) ; <nl> - sharedRealm . commitTransaction ( ) ; <nl> - } <nl> - <nl> @ Test <nl> public void constructor _ withDistinct ( ) { <nl> SortDescriptor distinctDescriptor = SortDescriptor . getInstanceForDistinct ( table , " firstName " ) ; <nl> diff - - git a / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp b / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp <nl> index 9c6ca14 . . 27f727b 100644 <nl> - - - a / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp <nl> + + + b / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp <nl> @ @ - 17 , 15 + 17 , 16 @ @ <nl> # include < jni . h > <nl> # include " io _ realm _ internal _ Collection . h " <nl> <nl> - # include < vector > <nl> + # include < realm / util / assert . hpp > <nl> <nl> # include < shared _ realm . hpp > <nl> # include < results . hpp > <nl> <nl> - # include " util . hpp " <nl> # include " java _ sort _ descriptor . hpp " <nl> - # include " jni _ util / java _ method . hpp " <nl> + # include " util . hpp " <nl> + <nl> # include " jni _ util / java _ global _ weak _ ref . hpp " <nl> + # include " jni _ util / java _ method . hpp " <nl> <nl> using namespace realm ; <nl> using namespace realm : : jni _ util ; <nl> @ @ - 126 , 18 + 127 , 6 @ @ Java _ io _ realm _ internal _ Collection _ nativeCreateResults ( JNIEnv * env , jclass , jlong <nl> return reinterpret _ cast < jlong > ( nullptr ) ; <nl> } <nl> <nl> - JNIEXPORT jlong JNICALL <nl> - Java _ io _ realm _ internal _ Collection _ nativeCreateSnapshot ( JNIEnv * env , jclass , jlong native _ ptr ) <nl> - { <nl> - TR _ ENTER _ PTR ( native _ ptr ) <nl> - try { <nl> - auto wrapper = reinterpret _ cast < ResultsWrapper * > ( native _ ptr ) ; <nl> - auto snapshot = wrapper - > get _ original _ results ( ) ; <nl> - return reinterpret _ cast < jlong > ( new Results ( snapshot ) ) ; <nl> - } CATCH _ STD ( ) <nl> - return reinterpret _ cast < jlong > ( nullptr ) ; <nl> - } <nl> - <nl> JNIEXPORT jboolean JNICALL <nl> Java _ io _ realm _ internal _ Collection _ nativeContains ( JNIEnv * env , jclass , jlong native _ ptr , jlong native _ row _ ptr ) <nl> { <nl> @ @ - 308 , 11 + 297 , 12 @ @ Java _ io _ realm _ internal _ Collection _ nativeStartListening ( JNIEnv * env , jobject inst <nl> / / OS will call all notifiers ' callback in one run , so check the Java exception first ! ! <nl> if ( env - > ExceptionCheck ( ) ) return ; <nl> <nl> - / / if ( ! wrapper - > is _ detached ( ) ) { <nl> + / / It should have been reattached before the callback . <nl> + REALM _ ASSERT _ DEBUG ( ! wrapper - > is _ detached ( ) ) ; <nl> + <nl> wrapper - > m _ collection _ weak _ ref . call _ with _ local _ ref ( env , [ & ] ( JNIEnv * local _ env , jobject collection _ obj ) { <nl> local _ env - > CallVoidMethod ( collection _ obj , notify _ change _ listeners , changes . empty ( ) ) ; <nl> } ) ; <nl> - / / } <nl> } ; <nl> <nl> wrapper - > m _ notification _ token = wrapper - > get _ original _ results ( ) . add _ notification _ callback ( cb ) ; <nl> @ @ - 419 , 7 + 409 , 6 @ @ Java _ io _ realm _ internal _ Collection _ nativeDeleteLast ( JNIEnv * env , jclass , jlong na <nl> return JNI _ TRUE ; <nl> } <nl> } CATCH _ STD ( ) <nl> - <nl> return JNI _ FALSE ; <nl> } <nl> <nl> @ @ - 437 , 7 + 426 , 6 @ @ Java _ io _ realm _ internal _ Collection _ nativeDeleteFirst ( JNIEnv * env , jclass , jlong n <nl> return JNI _ TRUE ; <nl> } <nl> } CATCH _ STD ( ) <nl> - <nl> return JNI _ FALSE ; <nl> } <nl> <nl> diff - - git a / realm / realm - library / src / main / java / io / realm / internal / Collection . java b / realm / realm - library / src / main / java / io / realm / internal / Collection . java <nl> index bf0e120 . . 6e54703 100644 <nl> - - - a / realm / realm - library / src / main / java / io / realm / internal / Collection . java <nl> + + + b / realm / realm - library / src / main / java / io / realm / internal / Collection . java <nl> @ @ - 26 , 9 + 26 , 9 @ @ import io . realm . RealmChangeListener ; <nl> <nl> / * * <nl> * Java wrapper of OS Results class . <nl> - * It is supposed to be the backend of binding ' s query results , link list and back links . <nl> + * It is the backend of binding ' s query results , link list and back links . <nl> * / <nl> - @ KeepMember <nl> + @ Keep <nl> public class Collection implements NativeObject { <nl> <nl> private class CollectionObserverPair < T > extends ObserverPairList . ObserverPair < T , RealmChangeListener < T > > { <nl> @ @ - 93 , 7 + 93 , 6 @ @ public class Collection implements NativeObject { <nl> public static final byte AGGREGATE _ FUNCTION _ AVERAGE = 3 ; <nl> @ SuppressWarnings ( " WeakerAccess " ) <nl> public static final byte AGGREGATE _ FUNCTION _ SUM = 4 ; <nl> - <nl> public enum Aggregate { <nl> MINIMUM ( AGGREGATE _ FUNCTION _ MINIMUM ) , <nl> MAXIMUM ( AGGREGATE _ FUNCTION _ MAXIMUM ) , <nl> @ @ - 121 , 7 + 120 , 6 @ @ public class Collection implements NativeObject { <nl> public static final byte MODE _ LINKVIEW = 3 ; <nl> @ SuppressWarnings ( " WeakerAccess " ) <nl> public static final byte MODE _ TABLEVIEW = 4 ; <nl> - <nl> public enum Mode { <nl> EMPTY , / / Backed by nothing ( for missing tables ) <nl> TABLE , / / Backed directly by a Table <nl> @ @ - 298 , 7 + 296 , 6 @ @ public class Collection implements NativeObject { <nl> } <nl> <nl> / / Called by JNI <nl> - @ KeepMember <nl> @ SuppressWarnings ( " unused " ) <nl> private void notifyChangeListeners ( boolean emptyChanges ) { <nl> if ( isDetached ( ) ) return ; <nl> @ @ - 309 , 8 + 306 , 7 @ @ public class Collection implements NativeObject { <nl> return Mode . getByValue ( nativeGetMode ( nativePtr ) ) ; <nl> } <nl> <nl> - / / Turns this collection to be backed by a snapshot results . <nl> - / / A snapshot results will never be auto - updated . <nl> + / / Turns this collection to be backed by a snapshot results . A snapshot results will never be auto - updated . <nl> void detach ( ) { <nl> nativeDetach ( nativePtr ) ; <nl> } <nl> @ @ - 330 , 8 + 326 , 6 @ @ public class Collection implements NativeObject { <nl> private static native long nativeGetFinalizerPtr ( ) ; <nl> private static native long nativeCreateResults ( long sharedRealmNativePtr , long queryNativePtr , <nl> SortDescriptor sortDesc , SortDescriptor distinctDesc ) ; <nl> - @ SuppressWarnings ( " unused " ) / / Not used for now <nl> - private static native long nativeCreateSnapshot ( long nativePtr ) ; <nl> private static native long nativeGetRow ( long nativePtr , int index ) ; <nl> private static native long nativeFirstRow ( long nativePtr ) ; <nl> private static native long nativeLastRow ( long nativePtr ) ;

TEST DIFF:
diff - - git a / realm / realm - library / src / main / cpp / io _ realm _ internal _ OsObject . cpp b / realm / realm - library / src / main / cpp / io _ realm _ internal _ OsObject . cpp 
 index 78bc65f . . 8994340 100644 
 - - - a / realm / realm - library / src / main / cpp / io _ realm _ internal _ OsObject . cpp 
 + + + b / realm / realm - library / src / main / cpp / io _ realm _ internal _ OsObject . cpp 
 @ @ - 62 , 8 + 62 , 9 @ @ struct ObjectWrapper { 
 } ; 
 
 struct ChangeCallback { 
 - ChangeCallback ( ObjectWrapper * wrapper ) 
 - : m _ wrapper ( wrapper ) 
 + ChangeCallback ( ObjectWrapper * wrapper , JavaMethod notify _ change _ listeners ) 
 + : m _ wrapper ( wrapper ) , 
 + m _ notify _ change _ listeners _ method ( notify _ change _ listeners ) 
 { 
 } 
 
 @ @ - 126 , 12 + 127 , 8 @ @ struct ChangeCallback { 
 } 
 
 parse _ fields ( env , change _ set ) ; 
 - 
 m _ wrapper - > m _ row _ object _ weak _ ref . call _ with _ local _ ref ( env , [ & ] ( JNIEnv * , jobject row _ obj ) { 
 - static JavaClass os _ object _ class ( env , " io / realm / internal / OsObject " ) ; 
 - static JavaMethod notify _ change _ listeners ( env , os _ object _ class , " notifyChangeListeners " , 
 - " ( [ Ljava / lang / String ; ) V " ) ; 
 - env - > CallVoidMethod ( row _ obj , notify _ change _ listeners , m _ deleted ? nullptr : m _ field _ names _ array ) ; 
 + env - > CallVoidMethod ( row _ obj , m _ notify _ change _ listeners _ method , m _ deleted ? nullptr : m _ field _ names _ array ) ; 
 } ) ; 
 m _ field _ names _ array = nullptr ; 
 m _ deleted = false ; 
 @ @ - 153 , 6 + 150 , 7 @ @ private : 
 ObjectWrapper * m _ wrapper ; 
 bool m _ deleted = false ; 
 jobjectArray m _ field _ names _ array = nullptr ; 
 + JavaMethod m _ notify _ change _ listeners _ method ; 
 } ; 
 
 static void finalize _ object ( jlong ptr ) 
 @ @ - 270 , 10 + 268 , 13 @ @ JNIEXPORT void JNICALL Java _ io _ realm _ internal _ OsObject _ nativeStartListening ( JNIE 
 wrapper - > m _ row _ object _ weak _ ref = JavaGlobalWeakRef ( env , instance ) ; 
 } 
 
 + static JavaClass os _ object _ class ( env , " io / realm / internal / OsObject " ) ; 
 + static JavaMethod notify _ change _ listeners ( env , os _ object _ class , " notifyChangeListeners " , 
 + " ( [ Ljava / lang / String ; ) V " ) ; 
 / / The wrapper pointer will be used in the callback . But it should never become an invalid pointer when the 
 / / notification block gets called . This should be guaranteed by the Object Store that after the notification 
 / / token is destroyed , the block shouldn ' t be called . 
 - wrapper - > m _ notification _ token = wrapper - > m _ object . add _ notification _ callback ( ChangeCallback ( wrapper ) ) ; 
 + wrapper - > m _ notification _ token = wrapper - > m _ object . add _ notification _ callback ( ChangeCallback ( wrapper , notify _ change _ listeners ) ) ; 
 } 
 CATCH _ STD ( ) 
 }

NEAREST DIFF:
diff - - git a / realm / realm - library / src / androidTest / java / io / realm / internal / CollectionTests . java b / realm / realm - library / src / androidTest / java / io / realm / internal / CollectionTests . java 
 index 1a89734 . . 05ad2e5 100644 
 - - - a / realm / realm - library / src / androidTest / java / io / realm / internal / CollectionTests . java 
 + + + b / realm / realm - library / src / androidTest / java / io / realm / internal / CollectionTests . java 
 @ @ - 124 , 13 + 124 , 6 @ @ public class CollectionTests { 
 sharedRealm . commitTransaction ( ) ; 
 } 
 
 - private void removeRow ( SharedRealm sharedRealm ) { 
 - sharedRealm . beginTransaction ( ) ; 
 - table = sharedRealm . getTable ( " test _ table " ) ; 
 - table . remove ( 0 ) ; 
 - sharedRealm . commitTransaction ( ) ; 
 - } 
 - 
 @ Test 
 public void constructor _ withDistinct ( ) { 
 SortDescriptor distinctDescriptor = SortDescriptor . getInstanceForDistinct ( table , " firstName " ) ; 
 diff - - git a / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp b / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp 
 index 9c6ca14 . . 27f727b 100644 
 - - - a / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp 
 + + + b / realm / realm - library / src / main / cpp / io _ realm _ internal _ Collection . cpp 
 @ @ - 17 , 15 + 17 , 16 @ @ 
 # include < jni . h > 
 # include " io _ realm _ internal _ Collection . h " 
 
 - # include < vector > 
 + # include < realm / util / assert . hpp > 
 
 # include < shared _ realm . hpp > 
 # include < results . hpp > 
 
 - # include " util . hpp " 
 # include " java _ sort _ descriptor . hpp " 
 - # include " jni _ util / java _ method . hpp " 
 + # include " util . hpp " 
 + 
 # include " jni _ util / java _ global _ weak _ ref . hpp " 
 + # include " jni _ util / java _ method . hpp " 
 
 using namespace realm ; 
 using namespace realm : : jni _ util ; 
 @ @ - 126 , 18 + 127 , 6 @ @ Java _ io _ realm _ internal _ Collection _ nativeCreateResults ( JNIEnv * env , jclass , jlong 
 return reinterpret _ cast < jlong > ( nullptr ) ; 
 } 
 
 - JNIEXPORT jlong JNICALL 
 - Java _ io _ realm _ internal _ Collection _ nativeCreateSnapshot ( JNIEnv * env , jclass , jlong native _ ptr ) 
 - { 
 - TR _ ENTER _ PTR ( native _ ptr ) 
 - try { 
 - auto wrapper = reinterpret _ cast < ResultsWrapper * > ( native _ ptr ) ; 
 - auto snapshot = wrapper - > get _ original _ results ( ) ; 
 - return reinterpret _ cast < jlong > ( new Results ( snapshot ) ) ; 
 - } CATCH _ STD ( ) 
 - return reinterpret _ cast < jlong > ( nullptr ) ; 
 - } 
 - 
 JNIEXPORT jboolean JNICALL 
 Java _ io _ realm _ internal _ Collection _ nativeContains ( JNIEnv * env , jclass , jlong native _ ptr , jlong native _ row _ ptr ) 
 { 
 @ @ - 308 , 11 + 297 , 12 @ @ Java _ io _ realm _ internal _ Collection _ nativeStartListening ( JNIEnv * env , jobject inst 
 / / OS will call all notifiers ' callback in one run , so check the Java exception first ! ! 
 if ( env - > ExceptionCheck ( ) ) return ; 
 
 - / / if ( ! wrapper - > is _ detached ( ) ) { 
 + / / It should have been reattached before the callback . 
 + REALM _ ASSERT _ DEBUG ( ! wrapper - > is _ detached ( ) ) ; 
 + 
 wrapper - > m _ collection _ weak _ ref . call _ with _ local _ ref ( env , [ & ] ( JNIEnv * local _ env , jobject collection _ obj ) { 
 local _ env - > CallVoidMethod ( collection _ obj , notify _ change _ listeners , changes . empty ( ) ) ; 
 } ) ; 
 - / / } 
 } ; 
 
 wrapper - > m _ notification _ token = wrapper - > get _ original _ results ( ) . add _ notification _ callback ( cb ) ; 
 @ @ - 419 , 7 + 409 , 6 @ @ Java _ io _ realm _ internal _ Collection _ nativeDeleteLast ( JNIEnv * env , jclass , jlong na 
 return JNI _ TRUE ; 
 } 
 } CATCH _ STD ( ) 
 - 
 return JNI _ FALSE ; 
 } 
 
 @ @ - 437 , 7 + 426 , 6 @ @ Java _ io _ realm _ internal _ Collection _ nativeDeleteFirst ( JNIEnv * env , jclass , jlong n 
 return JNI _ TRUE ; 
 } 
 } CATCH _ STD ( ) 
 - 
 return JNI _ FALSE ; 
 } 
 
 diff - - git a / realm / realm - library / src / main / java / io / realm / internal / Collection . java b / realm / realm - library / src / main / java / io / realm / internal / Collection . java 
 index bf0e120 . . 6e54703 100644 
 - - - a / realm / realm - library / src / main / java / io / realm / internal / Collection . java 
 + + + b / realm / realm - library / src / main / java / io / realm / internal / Collection . java 
 @ @ - 26 , 9 + 26 , 9 @ @ import io . realm . RealmChangeListener ; 
 
 / * * 
 * Java wrapper of OS Results class . 
 - * It is supposed to be the backend of binding ' s query results , link list and back links . 
 + * It is the backend of binding ' s query results , link list and back links . 
 * / 
 - @ KeepMember 
 + @ Keep 
 public class Collection implements NativeObject { 
 
 private class CollectionObserverPair < T > extends ObserverPairList . ObserverPair < T , RealmChangeListener < T > > { 
 @ @ - 93 , 7 + 93 , 6 @ @ public class Collection implements NativeObject { 
 public static final byte AGGREGATE _ FUNCTION _ AVERAGE = 3 ; 
 @ SuppressWarnings ( " WeakerAccess " ) 
 public static final byte AGGREGATE _ FUNCTION _ SUM = 4 ; 
 - 
 public enum Aggregate { 
 MINIMUM ( AGGREGATE _ FUNCTION _ MINIMUM ) , 
 MAXIMUM ( AGGREGATE _ FUNCTION _ MAXIMUM ) , 
 @ @ - 121 , 7 + 120 , 6 @ @ public class Collection implements NativeObject { 
 public static final byte MODE _ LINKVIEW = 3 ; 
 @ SuppressWarnings ( " WeakerAccess " ) 
 public static final byte MODE _ TABLEVIEW = 4 ; 
 - 
 public enum Mode { 
 EMPTY , / / Backed by nothing ( for missing tables ) 
 TABLE , / / Backed directly by a Table 
 @ @ - 298 , 7 + 296 , 6 @ @ public class Collection implements NativeObject { 
 } 
 
 / / Called by JNI 
 - @ KeepMember 
 @ SuppressWarnings ( " unused " ) 
 private void notifyChangeListeners ( boolean emptyChanges ) { 
 if ( isDetached ( ) ) return ; 
 @ @ - 309 , 8 + 306 , 7 @ @ public class Collection implements NativeObject { 
 return Mode . getByValue ( nativeGetMode ( nativePtr ) ) ; 
 } 
 
 - / / Turns this collection to be backed by a snapshot results . 
 - / / A snapshot results will never be auto - updated . 
 + / / Turns this collection to be backed by a snapshot results . A snapshot results will never be auto - updated . 
 void detach ( ) { 
 nativeDetach ( nativePtr ) ; 
 } 
 @ @ - 330 , 8 + 326 , 6 @ @ public class Collection implements NativeObject { 
 private static native long nativeGetFinalizerPtr ( ) ; 
 private static native long nativeCreateResults ( long sharedRealmNativePtr , long queryNativePtr , 
 SortDescriptor sortDesc , SortDescriptor distinctDesc ) ; 
 - @ SuppressWarnings ( " unused " ) / / Not used for now 
 - private static native long nativeCreateSnapshot ( long nativePtr ) ; 
 private static native long nativeGetRow ( long nativePtr , int index ) ; 
 private static native long nativeFirstRow ( long nativePtr ) ; 
 private static native long nativeLastRow ( long nativePtr ) ;
