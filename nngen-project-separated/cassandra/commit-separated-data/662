BLEU SCORE: 0.02028802809405136

TEST MSG: Fix legacy regex for temporary files from 2 . 2
GENERATED MSG: implement a legacy sstable test . Patch by Stu Hood , reviewed by Gary Dusbabek . CASSANDRA - 767

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 30931d3 . . 8fde74e 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 3 . 0 . 9 <nl> + * Fix legacy regex for temporary files from 2 . 2 ( CASSANDRA - 12565 ) <nl> * Add option to state current gc _ grace _ seconds to tools / bin / sstablemetadata ( CASSANDRA - 12208 ) <nl> * Fix file system race condition that may cause LogAwareFileLister to fail to classify files ( CASSANDRA - 11889 ) <nl> * Fix file handle leaks due to simultaneous compaction / repair and <nl> diff - - git a / src / java / org / apache / cassandra / io / sstable / Descriptor . java b / src / java / org / apache / cassandra / io / sstable / Descriptor . java <nl> index ff4abfc . . e979a7d 100644 <nl> - - - a / src / java / org / apache / cassandra / io / sstable / Descriptor . java <nl> + + + b / src / java / org / apache / cassandra / io / sstable / Descriptor . java <nl> @ @ - 186 , 7 + 186 , 7 @ @ public class Descriptor <nl> <nl> private final static String LEGACY _ COMP _ IN _ PROG _ REGEX _ STR = " ^ compactions _ in _ progress ( \ \ - [ \ \ d , a - f ] { 32 } ) ? $ " ; <nl> private final static Pattern LEGACY _ COMP _ IN _ PROG _ REGEX = Pattern . compile ( LEGACY _ COMP _ IN _ PROG _ REGEX _ STR ) ; <nl> - private final static String LEGACY _ TMP _ REGEX _ STR = " ^ ( ( . * ) \ \ - ( . * ) \ \ - ) ? tmp ( link ) ? \ \ - ( la | ka ) \ \ - ( \ \ d ) * \ \ - ( . * ) $ " ; <nl> + private final static String LEGACY _ TMP _ REGEX _ STR = " ^ ( ( . * ) \ \ - ( . * ) \ \ - ) ? tmp ( link ) ? \ \ - ( ( ? : l | k ) . ) \ \ - ( \ \ d ) * \ \ - ( . * ) $ " ; <nl> private final static Pattern LEGACY _ TMP _ REGEX = Pattern . compile ( LEGACY _ TMP _ REGEX _ STR ) ; <nl> <nl> public static boolean isLegacyFile ( File file ) <nl> diff - - git a / test / data / migration - sstables / 2 . 2 / keyspace1 / test - dfcc85801bc811e5aa694b06169f4ffa / tmp - lb - 3 - big - Data . db b / test / data / migration - sstables / 2 . 2 / keyspace1 / test - dfcc85801bc811e5aa694b06169f4ffa / tmp - lb - 3 - big - Data . db <nl> new file mode 100644 <nl> index 0000000 . . 2d5e60a <nl> Binary files / dev / null and b / test / data / migration - sstables / 2 . 2 / keyspace1 / test - dfcc85801bc811e5aa694b06169f4ffa / tmp - lb - 3 - big - Data . db differ <nl> diff - - git a / test / data / migration - sstables / 2 . 2 / keyspace1 / test - dfcc85801bc811e5aa694b06169f4ffa / tmp - lb - 3 - big - Index . db b / test / data / migration - sstables / 2 . 2 / keyspace1 / test - dfcc85801bc811e5aa694b06169f4ffa / tmp - lb - 3 - big - Index . db <nl> new file mode 100644 <nl> index 0000000 . . d3923ab <nl> Binary files / dev / null and b / test / data / migration - sstables / 2 . 2 / keyspace1 / test - dfcc85801bc811e5aa694b06169f4ffa / tmp - lb - 3 - big - Index . db differ <nl> diff - - git a / test / unit / org / apache / cassandra / db / SystemKeyspaceTest . java b / test / unit / org / apache / cassandra / db / SystemKeyspaceTest . java <nl> index d770610 . . 8e58373 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / SystemKeyspaceTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / SystemKeyspaceTest . java <nl> @ @ - 178 , 23 + 178 , 23 @ @ public class SystemKeyspaceTest <nl> @ Test <nl> public void testMigrateDataDirs _ 2 _ 1 ( ) throws IOException <nl> { <nl> - testMigrateDataDirs ( " 2 . 1 " ) ; <nl> + testMigrateDataDirs ( " 2 . 1 " , 5 ) ; / / see test data for num legacy files <nl> } <nl> <nl> @ Test <nl> public void testMigrateDataDirs _ 2 _ 2 ( ) throws IOException <nl> { <nl> - testMigrateDataDirs ( " 2 . 2 " ) ; <nl> + testMigrateDataDirs ( " 2 . 2 " , 7 ) ; / / see test data for num legacy files <nl> } <nl> <nl> - private void testMigrateDataDirs ( String version ) throws IOException <nl> + private void testMigrateDataDirs ( String version , int numLegacyFiles ) throws IOException <nl> { <nl> Path migrationSSTableRoot = Paths . get ( System . getProperty ( MIGRATION _ SSTABLES _ ROOT ) , version ) ; <nl> Path dataDir = Paths . get ( DatabaseDescriptor . getAllDataFileLocations ( ) [ 0 ] ) ; <nl> <nl> FileUtils . copyDirectory ( migrationSSTableRoot . toFile ( ) , dataDir . toFile ( ) ) ; <nl> <nl> - assertEquals ( 5 , numLegacyFiles ( ) ) ; / / see test data <nl> + assertEquals ( numLegacyFiles , numLegacyFiles ( ) ) ; <nl> <nl> SystemKeyspace . migrateDataDirs ( ) ; <nl>
NEAREST DIFF (one line): diff - - git a / build . xml b / build . xml <nl> index 1a09910 . . d2fc678 100644 <nl> - - - a / build . xml <nl> + + + b / build . xml <nl> @ @ - 39 , 6 + 39 , 7 @ @ <nl> < property name = " test . resources " value = " $ { test . dir } / resources " / > <nl> < property name = " test . classes " value = " $ { build . dir } / test / classes " / > <nl> < property name = " test . conf " value = " $ { test . dir } / conf " / > <nl> + < property name = " test . data " value = " $ { test . dir } / data " / > <nl> < property name = " test . name " value = " * Test " / > <nl> < property name = " test . unit . src " value = " $ { test . dir } / unit " / > <nl> < property name = " dist . dir " value = " $ { build . dir } / dist " / > <nl> @ @ - 369 , 6 + 370 , 7 @ @ <nl> < formatter type = " brief " usefile = " false " / > <nl> < jvmarg value = " - Dstorage - config = $ { test . conf } " / > <nl> < jvmarg value = " - Dlog4j . configuration = log4j - junit . properties " / > <nl> + < jvmarg value = " - Dlegacy - sstable - root = $ { test . data } / legacy - sstables " / > <nl> < jvmarg value = " - ea " / > <nl> < classpath > <nl> < path refid = " cassandra . classpath " / > <nl> diff - - git a / test / data / legacy - sstables / b / Keyspace1 / Standard1 - b - 0 - Data . db b / test / data / legacy - sstables / b / Keyspace1 / Standard1 - b - 0 - Data . db <nl> new file mode 100644 <nl> index 0000000 . . 962ed01 <nl> Binary files / dev / null and b / test / data / legacy - sstables / b / Keyspace1 / Standard1 - b - 0 - Data . db differ <nl> diff - - git a / test / data / legacy - sstables / b / Keyspace1 / Standard1 - b - 0 - Filter . db b / test / data / legacy - sstables / b / Keyspace1 / Standard1 - b - 0 - Filter . db <nl> new file mode 100644 <nl> index 0000000 . . 64d8c5d <nl> Binary files / dev / null and b / test / data / legacy - sstables / b / Keyspace1 / Standard1 - b - 0 - Filter . db differ <nl> diff - - git a / test / data / legacy - sstables / b / Keyspace1 / Standard1 - b - 0 - Index . db b / test / data / legacy - sstables / b / Keyspace1 / Standard1 - b - 0 - Index . db <nl> new file mode 100644 <nl> index 0000000 . . 8fb5706 <nl> Binary files / dev / null and b / test / data / legacy - sstables / b / Keyspace1 / Standard1 - b - 0 - Index . db differ <nl> diff - - git a / test / unit / org / apache / cassandra / io / sstable / LegacySSTableTest . java b / test / unit / org / apache / cassandra / io / sstable / LegacySSTableTest . java <nl> new file mode 100644 <nl> index 0000000 . . d37585c <nl> - - - / dev / null <nl> + + + b / test / unit / org / apache / cassandra / io / sstable / LegacySSTableTest . java <nl> @ @ - 0 , 0 + 1 , 113 @ @ <nl> + / * <nl> + * Licensed to the Apache Software Foundation ( ASF ) under one <nl> + * or more contributor license agreements . See the NOTICE file <nl> + * distributed with this work for additional information <nl> + * regarding copyright ownership . The ASF licenses this file <nl> + * to you under the Apache License , Version 2 . 0 ( the <nl> + * " License " ) ; you may not use this file except in compliance <nl> + * with the License . You may obtain a copy of the License at <nl> + * <nl> + * http : / / www . apache . org / licenses / LICENSE - 2 . 0 <nl> + * <nl> + * Unless required by applicable law or agreed to in writing , <nl> + * software distributed under the License is distributed on an <nl> + * " AS IS " BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY <nl> + * KIND , either express or implied . See the License for the <nl> + * specific language governing permissions and limitations <nl> + * under the License . <nl> + * / <nl> + <nl> + package org . apache . cassandra . io . sstable ; <nl> + <nl> + import java . io . File ; <nl> + import java . io . IOException ; <nl> + import java . util . * ; <nl> + <nl> + import org . junit . BeforeClass ; <nl> + import org . junit . Test ; <nl> + import static org . junit . Assert . * ; <nl> + <nl> + import org . apache . cassandra . CleanupHelper ; <nl> + import org . apache . cassandra . io . util . BufferedRandomAccessFile ; <nl> + import org . apache . cassandra . db . DecoratedKey ; <nl> + <nl> + import com . google . common . base . Predicate ; <nl> + import com . google . common . base . Predicates ; <nl> + <nl> + / * * <nl> + * Tests backwards compatibility for SSTables . Requires that older SSTables match up with the existing config file , <nl> + * and currently only tests specific cases for specific upgrades . <nl> + * / <nl> + public class LegacySSTableTest extends CleanupHelper <nl> + { <nl> + public static final String LEGACY _ SSTABLE _ PROP = " legacy - sstable - root " ; <nl> + public static final String KSNAME = " Keyspace1 " ; <nl> + public static final String CFNAME = " Standard1 " ; <nl> + <nl> + public static SortedMap < String , byte [ ] > TEST _ DATA ; <nl> + public static File LEGACY _ SSTABLE _ ROOT ; <nl> + <nl> + @ BeforeClass <nl> + public static void beforeClass ( ) <nl> + { <nl> + String scp = System . getProperty ( LEGACY _ SSTABLE _ PROP ) ; <nl> + assert scp ! = null ; <nl> + LEGACY _ SSTABLE _ ROOT = new File ( scp ) ; <nl> + assert LEGACY _ SSTABLE _ ROOT . isDirectory ( ) ; <nl> + <nl> + TEST _ DATA = new TreeMap < String , byte [ ] > ( ) ; <nl> + for ( int i = 100 ; i < 1000 ; + + i ) <nl> + { <nl> + TEST _ DATA . put ( Integer . toString ( i ) , ( " Avinash Lakshman is a good man : " + i ) . getBytes ( ) ) ; <nl> + } <nl> + } <nl> + <nl> + / * * <nl> + * Get a descriptor for the legacy sstable at the given version . <nl> + * / <nl> + protected SSTable . Descriptor getDescriptor ( String ver ) throws IOException <nl> + { <nl> + File directory = new File ( LEGACY _ SSTABLE _ ROOT + File . separator + ver + File . separator + KSNAME ) ; <nl> + return new SSTable . Descriptor ( ver , directory , KSNAME , CFNAME , 0 , false ) ; <nl> + } <nl> + <nl> + / * * <nl> + * Generates a test SSTable for use in this classes ' tests . Uncomment and run against an older build <nl> + * and the output will be copied to a version subdirectory in ' LEGACY _ SSTABLE _ ROOT ' <nl> + * <nl> + @ Test <nl> + public void buildTestSSTable ( ) throws IOException <nl> + { <nl> + / / write the output in a version specific directory <nl> + SSTable . Descriptor dest = getDescriptor ( SSTable . Descriptor . CURRENT _ VERSION ) ; <nl> + assert dest . directory . mkdirs ( ) : " Could not create " + dest . directory + " . Might it already exist ? " ; <nl> + <nl> + SSTableReader ssTable = SSTableUtils . writeRawSSTable ( new File ( dest . filenameFor ( SSTable . COMPONENT _ DATA ) ) , <nl> + KSNAME , <nl> + CFNAME , <nl> + TEST _ DATA ) ; <nl> + assert ssTable . desc . generation = = 0 : <nl> + " In order to create a generation 0 sstable , please run this test alone . " ; <nl> + System . out . println ( " > > > Wrote " + dest ) ; <nl> + } <nl> + * / <nl> + <nl> + / * * <nl> + * Between version b and c , on disk bloom filters became incompatible , and needed to be regenerated . <nl> + * / <nl> + @ Test <nl> + public void testVerB ( ) throws IOException <nl> + { <nl> + SSTableReader reader = SSTableReader . open ( getDescriptor ( " b " ) ) ; <nl> + <nl> + List < String > keys = new ArrayList < String > ( TEST _ DATA . keySet ( ) ) ; <nl> + Collections . shuffle ( keys ) ; <nl> + BufferedRandomAccessFile file = new BufferedRandomAccessFile ( reader . getFilename ( ) , " r " ) ; <nl> + for ( String key : keys ) <nl> + { <nl> + / / confirm that the bloom filter does not reject any keys <nl> + file . seek ( reader . getPosition ( reader . partitioner . decorateKey ( key ) ) . position ) ; <nl> + assert key . equals ( file . readUTF ( ) ) ; <nl> + } <nl> + } <nl> + } <nl> diff - - git a / test / unit / org / apache / cassandra / io / sstable / SSTableUtils . java b / test / unit / org / apache / cassandra / io / sstable / SSTableUtils . java <nl> index 4961c1f . . 8ed14e3 100644 <nl> - - - a / test / unit / org / apache / cassandra / io / sstable / SSTableUtils . java <nl> + + + b / test / unit / org / apache / cassandra / io / sstable / SSTableUtils . java <nl> @ @ - 38 , 13 + 38 , 8 @ @ import org . apache . cassandra . io . util . DataOutputBuffer ; <nl> public class SSTableUtils <nl> { <nl> / / first configured table and cf <nl> - public static String TABLENAME ; <nl> - public static String CFNAME ; <nl> - static <nl> - { <nl> - TABLENAME = DatabaseDescriptor . getTables ( ) . iterator ( ) . next ( ) ; <nl> - CFNAME = Table . open ( TABLENAME ) . getColumnFamilies ( ) . iterator ( ) . next ( ) ; <nl> - } <nl> + public static String TABLENAME = " Keyspace1 " ; <nl> + public static String CFNAME = " Standard1 " ; <nl> <nl> public static ColumnFamily createCF ( long mfda , int ldt , IColumn . . . cols ) <nl> { <nl> @ @ - 97 , 13 + 92 , 26 @ @ public class SSTableUtils <nl> <nl> public static SSTableReader writeRawSSTable ( String tablename , String cfname , SortedMap < String , byte [ ] > entries ) throws IOException <nl> { <nl> - File f = tempSSTableFile ( tablename , cfname ) ; <nl> - SSTableWriter writer = new SSTableWriter ( f . getAbsolutePath ( ) , entries . size ( ) , StorageService . getPartitioner ( ) ) ; <nl> + return writeRawSSTable ( null , tablename , cfname , entries ) ; <nl> + } <nl> + <nl> + public static SSTableReader writeRawSSTable ( File datafile , String tablename , String cfname , SortedMap < String , byte [ ] > entries ) throws IOException <nl> + { <nl> + boolean temporary = false ; <nl> + if ( datafile = = null ) <nl> + { <nl> + datafile = tempSSTableFile ( tablename , cfname ) ; <nl> + temporary = true ; <nl> + } <nl> + SSTableWriter writer = new SSTableWriter ( datafile . getAbsolutePath ( ) , entries . size ( ) , StorageService . getPartitioner ( ) ) ; <nl> for ( Map . Entry < String , byte [ ] > entry : entries . entrySet ( ) ) <nl> writer . append ( writer . partitioner . decorateKey ( entry . getKey ( ) ) , <nl> entry . getValue ( ) ) ; <nl> - new File ( writer . indexFilename ( ) ) . deleteOnExit ( ) ; <nl> - new File ( writer . filterFilename ( ) ) . deleteOnExit ( ) ; <nl> + if ( temporary ) <nl> + { <nl> + new File ( writer . indexFilename ( ) ) . deleteOnExit ( ) ; <nl> + new File ( writer . filterFilename ( ) ) . deleteOnExit ( ) ; <nl> + } <nl> return writer . closeAndOpenReader ( ) ; <nl> } <nl> }

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 30931d3 . . 8fde74e 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 3 . 0 . 9 
 + * Fix legacy regex for temporary files from 2 . 2 ( CASSANDRA - 12565 ) 
 * Add option to state current gc _ grace _ seconds to tools / bin / sstablemetadata ( CASSANDRA - 12208 ) 
 * Fix file system race condition that may cause LogAwareFileLister to fail to classify files ( CASSANDRA - 11889 ) 
 * Fix file handle leaks due to simultaneous compaction / repair and 
 diff - - git a / src / java / org / apache / cassandra / io / sstable / Descriptor . java b / src / java / org / apache / cassandra / io / sstable / Descriptor . java 
 index ff4abfc . . e979a7d 100644 
 - - - a / src / java / org / apache / cassandra / io / sstable / Descriptor . java 
 + + + b / src / java / org / apache / cassandra / io / sstable / Descriptor . java 
 @ @ - 186 , 7 + 186 , 7 @ @ public class Descriptor 
 
 private final static String LEGACY _ COMP _ IN _ PROG _ REGEX _ STR = " ^ compactions _ in _ progress ( \ \ - [ \ \ d , a - f ] { 32 } ) ? $ " ; 
 private final static Pattern LEGACY _ COMP _ IN _ PROG _ REGEX = Pattern . compile ( LEGACY _ COMP _ IN _ PROG _ REGEX _ STR ) ; 
 - private final static String LEGACY _ TMP _ REGEX _ STR = " ^ ( ( . * ) \ \ - ( . * ) \ \ - ) ? tmp ( link ) ? \ \ - ( la | ka ) \ \ - ( \ \ d ) * \ \ - ( . * ) $ " ; 
 + private final static String LEGACY _ TMP _ REGEX _ STR = " ^ ( ( . * ) \ \ - ( . * ) \ \ - ) ? tmp ( link ) ? \ \ - ( ( ? : l | k ) . ) \ \ - ( \ \ d ) * \ \ - ( . * ) $ " ; 
 private final static Pattern LEGACY _ TMP _ REGEX = Pattern . compile ( LEGACY _ TMP _ REGEX _ STR ) ; 
 
 public static boolean isLegacyFile ( File file ) 
 diff - - git a / test / data / migration - sstables / 2 . 2 / keyspace1 / test - dfcc85801bc811e5aa694b06169f4ffa / tmp - lb - 3 - big - Data . db b / test / data / migration - sstables / 2 . 2 / keyspace1 / test - dfcc85801bc811e5aa694b06169f4ffa / tmp - lb - 3 - big - Data . db 
 new file mode 100644 
 index 0000000 . . 2d5e60a 
 Binary files / dev / null and b / test / data / migration - sstables / 2 . 2 / keyspace1 / test - dfcc85801bc811e5aa694b06169f4ffa / tmp - lb - 3 - big - Data . db differ 
 diff - - git a / test / data / migration - sstables / 2 . 2 / keyspace1 / test - dfcc85801bc811e5aa694b06169f4ffa / tmp - lb - 3 - big - Index . db b / test / data / migration - sstables / 2 . 2 / keyspace1 / test - dfcc85801bc811e5aa694b06169f4ffa / tmp - lb - 3 - big - Index . db 
 new file mode 100644 
 index 0000000 . . d3923ab 
 Binary files / dev / null and b / test / data / migration - sstables / 2 . 2 / keyspace1 / test - dfcc85801bc811e5aa694b06169f4ffa / tmp - lb - 3 - big - Index . db differ 
 diff - - git a / test / unit / org / apache / cassandra / db / SystemKeyspaceTest . java b / test / unit / org / apache / cassandra / db / SystemKeyspaceTest . java 
 index d770610 . . 8e58373 100644 
 - - - a / test / unit / org / apache / cassandra / db / SystemKeyspaceTest . java 
 + + + b / test / unit / org / apache / cassandra / db / SystemKeyspaceTest . java 
 @ @ - 178 , 23 + 178 , 23 @ @ public class SystemKeyspaceTest 
 @ Test 
 public void testMigrateDataDirs _ 2 _ 1 ( ) throws IOException 
 { 
 - testMigrateDataDirs ( " 2 . 1 " ) ; 
 + testMigrateDataDirs ( " 2 . 1 " , 5 ) ; / / see test data for num legacy files 
 } 
 
 @ Test 
 public void testMigrateDataDirs _ 2 _ 2 ( ) throws IOException 
 { 
 - testMigrateDataDirs ( " 2 . 2 " ) ; 
 + testMigrateDataDirs ( " 2 . 2 " , 7 ) ; / / see test data for num legacy files 
 } 
 
 - private void testMigrateDataDirs ( String version ) throws IOException 
 + private void testMigrateDataDirs ( String version , int numLegacyFiles ) throws IOException 
 { 
 Path migrationSSTableRoot = Paths . get ( System . getProperty ( MIGRATION _ SSTABLES _ ROOT ) , version ) ; 
 Path dataDir = Paths . get ( DatabaseDescriptor . getAllDataFileLocations ( ) [ 0 ] ) ; 
 
 FileUtils . copyDirectory ( migrationSSTableRoot . toFile ( ) , dataDir . toFile ( ) ) ; 
 
 - assertEquals ( 5 , numLegacyFiles ( ) ) ; / / see test data 
 + assertEquals ( numLegacyFiles , numLegacyFiles ( ) ) ; 
 
 SystemKeyspace . migrateDataDirs ( ) ; 


NEAREST DIFF:
diff - - git a / build . xml b / build . xml 
 index 1a09910 . . d2fc678 100644 
 - - - a / build . xml 
 + + + b / build . xml 
 @ @ - 39 , 6 + 39 , 7 @ @ 
 < property name = " test . resources " value = " $ { test . dir } / resources " / > 
 < property name = " test . classes " value = " $ { build . dir } / test / classes " / > 
 < property name = " test . conf " value = " $ { test . dir } / conf " / > 
 + < property name = " test . data " value = " $ { test . dir } / data " / > 
 < property name = " test . name " value = " * Test " / > 
 < property name = " test . unit . src " value = " $ { test . dir } / unit " / > 
 < property name = " dist . dir " value = " $ { build . dir } / dist " / > 
 @ @ - 369 , 6 + 370 , 7 @ @ 
 < formatter type = " brief " usefile = " false " / > 
 < jvmarg value = " - Dstorage - config = $ { test . conf } " / > 
 < jvmarg value = " - Dlog4j . configuration = log4j - junit . properties " / > 
 + < jvmarg value = " - Dlegacy - sstable - root = $ { test . data } / legacy - sstables " / > 
 < jvmarg value = " - ea " / > 
 < classpath > 
 < path refid = " cassandra . classpath " / > 
 diff - - git a / test / data / legacy - sstables / b / Keyspace1 / Standard1 - b - 0 - Data . db b / test / data / legacy - sstables / b / Keyspace1 / Standard1 - b - 0 - Data . db 
 new file mode 100644 
 index 0000000 . . 962ed01 
 Binary files / dev / null and b / test / data / legacy - sstables / b / Keyspace1 / Standard1 - b - 0 - Data . db differ 
 diff - - git a / test / data / legacy - sstables / b / Keyspace1 / Standard1 - b - 0 - Filter . db b / test / data / legacy - sstables / b / Keyspace1 / Standard1 - b - 0 - Filter . db 
 new file mode 100644 
 index 0000000 . . 64d8c5d 
 Binary files / dev / null and b / test / data / legacy - sstables / b / Keyspace1 / Standard1 - b - 0 - Filter . db differ 
 diff - - git a / test / data / legacy - sstables / b / Keyspace1 / Standard1 - b - 0 - Index . db b / test / data / legacy - sstables / b / Keyspace1 / Standard1 - b - 0 - Index . db 
 new file mode 100644 
 index 0000000 . . 8fb5706 
 Binary files / dev / null and b / test / data / legacy - sstables / b / Keyspace1 / Standard1 - b - 0 - Index . db differ 
 diff - - git a / test / unit / org / apache / cassandra / io / sstable / LegacySSTableTest . java b / test / unit / org / apache / cassandra / io / sstable / LegacySSTableTest . java 
 new file mode 100644 
 index 0000000 . . d37585c 
 - - - / dev / null 
 + + + b / test / unit / org / apache / cassandra / io / sstable / LegacySSTableTest . java 
 @ @ - 0 , 0 + 1 , 113 @ @ 
 + / * 
 + * Licensed to the Apache Software Foundation ( ASF ) under one 
 + * or more contributor license agreements . See the NOTICE file 
 + * distributed with this work for additional information 
 + * regarding copyright ownership . The ASF licenses this file 
 + * to you under the Apache License , Version 2 . 0 ( the 
 + * " License " ) ; you may not use this file except in compliance 
 + * with the License . You may obtain a copy of the License at 
 + * 
 + * http : / / www . apache . org / licenses / LICENSE - 2 . 0 
 + * 
 + * Unless required by applicable law or agreed to in writing , 
 + * software distributed under the License is distributed on an 
 + * " AS IS " BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY 
 + * KIND , either express or implied . See the License for the 
 + * specific language governing permissions and limitations 
 + * under the License . 
 + * / 
 + 
 + package org . apache . cassandra . io . sstable ; 
 + 
 + import java . io . File ; 
 + import java . io . IOException ; 
 + import java . util . * ; 
 + 
 + import org . junit . BeforeClass ; 
 + import org . junit . Test ; 
 + import static org . junit . Assert . * ; 
 + 
 + import org . apache . cassandra . CleanupHelper ; 
 + import org . apache . cassandra . io . util . BufferedRandomAccessFile ; 
 + import org . apache . cassandra . db . DecoratedKey ; 
 + 
 + import com . google . common . base . Predicate ; 
 + import com . google . common . base . Predicates ; 
 + 
 + / * * 
 + * Tests backwards compatibility for SSTables . Requires that older SSTables match up with the existing config file , 
 + * and currently only tests specific cases for specific upgrades . 
 + * / 
 + public class LegacySSTableTest extends CleanupHelper 
 + { 
 + public static final String LEGACY _ SSTABLE _ PROP = " legacy - sstable - root " ; 
 + public static final String KSNAME = " Keyspace1 " ; 
 + public static final String CFNAME = " Standard1 " ; 
 + 
 + public static SortedMap < String , byte [ ] > TEST _ DATA ; 
 + public static File LEGACY _ SSTABLE _ ROOT ; 
 + 
 + @ BeforeClass 
 + public static void beforeClass ( ) 
 + { 
 + String scp = System . getProperty ( LEGACY _ SSTABLE _ PROP ) ; 
 + assert scp ! = null ; 
 + LEGACY _ SSTABLE _ ROOT = new File ( scp ) ; 
 + assert LEGACY _ SSTABLE _ ROOT . isDirectory ( ) ; 
 + 
 + TEST _ DATA = new TreeMap < String , byte [ ] > ( ) ; 
 + for ( int i = 100 ; i < 1000 ; + + i ) 
 + { 
 + TEST _ DATA . put ( Integer . toString ( i ) , ( " Avinash Lakshman is a good man : " + i ) . getBytes ( ) ) ; 
 + } 
 + } 
 + 
 + / * * 
 + * Get a descriptor for the legacy sstable at the given version . 
 + * / 
 + protected SSTable . Descriptor getDescriptor ( String ver ) throws IOException 
 + { 
 + File directory = new File ( LEGACY _ SSTABLE _ ROOT + File . separator + ver + File . separator + KSNAME ) ; 
 + return new SSTable . Descriptor ( ver , directory , KSNAME , CFNAME , 0 , false ) ; 
 + } 
 + 
 + / * * 
 + * Generates a test SSTable for use in this classes ' tests . Uncomment and run against an older build 
 + * and the output will be copied to a version subdirectory in ' LEGACY _ SSTABLE _ ROOT ' 
 + * 
 + @ Test 
 + public void buildTestSSTable ( ) throws IOException 
 + { 
 + / / write the output in a version specific directory 
 + SSTable . Descriptor dest = getDescriptor ( SSTable . Descriptor . CURRENT _ VERSION ) ; 
 + assert dest . directory . mkdirs ( ) : " Could not create " + dest . directory + " . Might it already exist ? " ; 
 + 
 + SSTableReader ssTable = SSTableUtils . writeRawSSTable ( new File ( dest . filenameFor ( SSTable . COMPONENT _ DATA ) ) , 
 + KSNAME , 
 + CFNAME , 
 + TEST _ DATA ) ; 
 + assert ssTable . desc . generation = = 0 : 
 + " In order to create a generation 0 sstable , please run this test alone . " ; 
 + System . out . println ( " > > > Wrote " + dest ) ; 
 + } 
 + * / 
 + 
 + / * * 
 + * Between version b and c , on disk bloom filters became incompatible , and needed to be regenerated . 
 + * / 
 + @ Test 
 + public void testVerB ( ) throws IOException 
 + { 
 + SSTableReader reader = SSTableReader . open ( getDescriptor ( " b " ) ) ; 
 + 
 + List < String > keys = new ArrayList < String > ( TEST _ DATA . keySet ( ) ) ; 
 + Collections . shuffle ( keys ) ; 
 + BufferedRandomAccessFile file = new BufferedRandomAccessFile ( reader . getFilename ( ) , " r " ) ; 
 + for ( String key : keys ) 
 + { 
 + / / confirm that the bloom filter does not reject any keys 
 + file . seek ( reader . getPosition ( reader . partitioner . decorateKey ( key ) ) . position ) ; 
 + assert key . equals ( file . readUTF ( ) ) ; 
 + } 
 + } 
 + } 
 diff - - git a / test / unit / org / apache / cassandra / io / sstable / SSTableUtils . java b / test / unit / org / apache / cassandra / io / sstable / SSTableUtils . java 
 index 4961c1f . . 8ed14e3 100644 
 - - - a / test / unit / org / apache / cassandra / io / sstable / SSTableUtils . java 
 + + + b / test / unit / org / apache / cassandra / io / sstable / SSTableUtils . java 
 @ @ - 38 , 13 + 38 , 8 @ @ import org . apache . cassandra . io . util . DataOutputBuffer ; 
 public class SSTableUtils 
 { 
 / / first configured table and cf 
 - public static String TABLENAME ; 
 - public static String CFNAME ; 
 - static 
 - { 
 - TABLENAME = DatabaseDescriptor . getTables ( ) . iterator ( ) . next ( ) ; 
 - CFNAME = Table . open ( TABLENAME ) . getColumnFamilies ( ) . iterator ( ) . next ( ) ; 
 - } 
 + public static String TABLENAME = " Keyspace1 " ; 
 + public static String CFNAME = " Standard1 " ; 
 
 public static ColumnFamily createCF ( long mfda , int ldt , IColumn . . . cols ) 
 { 
 @ @ - 97 , 13 + 92 , 26 @ @ public class SSTableUtils 
 
 public static SSTableReader writeRawSSTable ( String tablename , String cfname , SortedMap < String , byte [ ] > entries ) throws IOException 
 { 
 - File f = tempSSTableFile ( tablename , cfname ) ; 
 - SSTableWriter writer = new SSTableWriter ( f . getAbsolutePath ( ) , entries . size ( ) , StorageService . getPartitioner ( ) ) ; 
 + return writeRawSSTable ( null , tablename , cfname , entries ) ; 
 + } 
 + 
 + public static SSTableReader writeRawSSTable ( File datafile , String tablename , String cfname , SortedMap < String , byte [ ] > entries ) throws IOException 
 + { 
 + boolean temporary = false ; 
 + if ( datafile = = null ) 
 + { 
 + datafile = tempSSTableFile ( tablename , cfname ) ; 
 + temporary = true ; 
 + } 
 + SSTableWriter writer = new SSTableWriter ( datafile . getAbsolutePath ( ) , entries . size ( ) , StorageService . getPartitioner ( ) ) ; 
 for ( Map . Entry < String , byte [ ] > entry : entries . entrySet ( ) ) 
 writer . append ( writer . partitioner . decorateKey ( entry . getKey ( ) ) , 
 entry . getValue ( ) ) ; 
 - new File ( writer . indexFilename ( ) ) . deleteOnExit ( ) ; 
 - new File ( writer . filterFilename ( ) ) . deleteOnExit ( ) ; 
 + if ( temporary ) 
 + { 
 + new File ( writer . indexFilename ( ) ) . deleteOnExit ( ) ; 
 + new File ( writer . filterFilename ( ) ) . deleteOnExit ( ) ; 
 + } 
 return writer . closeAndOpenReader ( ) ; 
 } 
 }
