BLEU SCORE: 0.027611988917697356

TEST MSG: Improve IF NOT EXISTS check in CREATE INDEX
GENERATED MSG: Give more control over building to 2i impls

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index eda762b . . 7fc628e 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 3 . 0 . 5 <nl> + * Improve IF NOT EXISTS check in CREATE INDEX ( CASSANDRA - 11131 ) <nl> * Upgrade ohc to 0 . 4 . 3 <nl> * Enable SO _ REUSEADDR for JMX RMI server sockets ( CASSANDRA - 11093 ) <nl> * Allocate merkletrees with the correct size ( CASSANDRA - 11390 ) <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / CreateIndexStatement . java b / src / java / org / apache / cassandra / cql3 / statements / CreateIndexStatement . java <nl> index b2a6fd5 . . df1965a 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / CreateIndexStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / CreateIndexStatement . java <nl> @ @ - 229 , 9 + 229 , 14 @ @ public class CreateIndexStatement extends SchemaAlteringStatement <nl> / / check to disallow creation of an index which duplicates an existing one in all but name <nl> Optional < IndexMetadata > existingIndex = Iterables . tryFind ( cfm . getIndexes ( ) , existing - > existing . equalsWithoutName ( index ) ) ; <nl> if ( existingIndex . isPresent ( ) ) <nl> - throw new InvalidRequestException ( String . format ( " Index % s is a duplicate of existing index % s " , <nl> - index . name , <nl> - existingIndex . get ( ) . name ) ) ; <nl> + { <nl> + if ( ifNotExists ) <nl> + return null ; <nl> + else <nl> + throw new InvalidRequestException ( String . format ( " Index % s is a duplicate of existing index % s " , <nl> + index . name , <nl> + existingIndex . get ( ) . name ) ) ; <nl> + } <nl> <nl> logger . trace ( " Updating index definition for { } " , indexName ) ; <nl> cfm . indexes ( cfm . getIndexes ( ) . with ( index ) ) ; <nl> diff - - git a / test / unit / org / apache / cassandra / cql3 / validation / entities / SecondaryIndexTest . java b / test / unit / org / apache / cassandra / cql3 / validation / entities / SecondaryIndexTest . java <nl> index 6ad9cc8 . . f9802d7 100644 <nl> - - - a / test / unit / org / apache / cassandra / cql3 / validation / entities / SecondaryIndexTest . java <nl> + + + b / test / unit / org / apache / cassandra / cql3 / validation / entities / SecondaryIndexTest . java <nl> @ @ - 106 , 7 + 106 , 11 @ @ public class SecondaryIndexTest extends CQLTester <nl> removeQuotes ( indexName . toLowerCase ( Locale . US ) ) ) , <nl> " CREATE INDEX " + indexName + " ON % s ( b ) " ) ; <nl> <nl> + / / IF NOT EXISTS should apply in cases where the new index differs from an existing one in name only <nl> String otherIndexName = " index _ " + System . nanoTime ( ) ; <nl> + assertEquals ( 1 , getCurrentColumnFamilyStore ( ) . metadata . getIndexes ( ) . size ( ) ) ; <nl> + createIndex ( " CREATE INDEX IF NOT EXISTS " + otherIndexName + " ON % s ( b ) " ) ; <nl> + assertEquals ( 1 , getCurrentColumnFamilyStore ( ) . metadata . getIndexes ( ) . size ( ) ) ; <nl> assertInvalidMessage ( String . format ( " Index % s is a duplicate of existing index % s " , <nl> removeQuotes ( otherIndexName . toLowerCase ( Locale . US ) ) , <nl> removeQuotes ( indexName . toLowerCase ( Locale . US ) ) ) ,
NEAREST DIFF (one line): ELIMINATEDSENTENCE

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index eda762b . . 7fc628e 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 3 . 0 . 5 
 + * Improve IF NOT EXISTS check in CREATE INDEX ( CASSANDRA - 11131 ) 
 * Upgrade ohc to 0 . 4 . 3 
 * Enable SO _ REUSEADDR for JMX RMI server sockets ( CASSANDRA - 11093 ) 
 * Allocate merkletrees with the correct size ( CASSANDRA - 11390 ) 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / CreateIndexStatement . java b / src / java / org / apache / cassandra / cql3 / statements / CreateIndexStatement . java 
 index b2a6fd5 . . df1965a 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / CreateIndexStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / CreateIndexStatement . java 
 @ @ - 229 , 9 + 229 , 14 @ @ public class CreateIndexStatement extends SchemaAlteringStatement 
 / / check to disallow creation of an index which duplicates an existing one in all but name 
 Optional < IndexMetadata > existingIndex = Iterables . tryFind ( cfm . getIndexes ( ) , existing - > existing . equalsWithoutName ( index ) ) ; 
 if ( existingIndex . isPresent ( ) ) 
 - throw new InvalidRequestException ( String . format ( " Index % s is a duplicate of existing index % s " , 
 - index . name , 
 - existingIndex . get ( ) . name ) ) ; 
 + { 
 + if ( ifNotExists ) 
 + return null ; 
 + else 
 + throw new InvalidRequestException ( String . format ( " Index % s is a duplicate of existing index % s " , 
 + index . name , 
 + existingIndex . get ( ) . name ) ) ; 
 + } 
 
 logger . trace ( " Updating index definition for { } " , indexName ) ; 
 cfm . indexes ( cfm . getIndexes ( ) . with ( index ) ) ; 
 diff - - git a / test / unit / org / apache / cassandra / cql3 / validation / entities / SecondaryIndexTest . java b / test / unit / org / apache / cassandra / cql3 / validation / entities / SecondaryIndexTest . java 
 index 6ad9cc8 . . f9802d7 100644 
 - - - a / test / unit / org / apache / cassandra / cql3 / validation / entities / SecondaryIndexTest . java 
 + + + b / test / unit / org / apache / cassandra / cql3 / validation / entities / SecondaryIndexTest . java 
 @ @ - 106 , 7 + 106 , 11 @ @ public class SecondaryIndexTest extends CQLTester 
 removeQuotes ( indexName . toLowerCase ( Locale . US ) ) ) , 
 " CREATE INDEX " + indexName + " ON % s ( b ) " ) ; 
 
 + / / IF NOT EXISTS should apply in cases where the new index differs from an existing one in name only 
 String otherIndexName = " index _ " + System . nanoTime ( ) ; 
 + assertEquals ( 1 , getCurrentColumnFamilyStore ( ) . metadata . getIndexes ( ) . size ( ) ) ; 
 + createIndex ( " CREATE INDEX IF NOT EXISTS " + otherIndexName + " ON % s ( b ) " ) ; 
 + assertEquals ( 1 , getCurrentColumnFamilyStore ( ) . metadata . getIndexes ( ) . size ( ) ) ; 
 assertInvalidMessage ( String . format ( " Index % s is a duplicate of existing index % s " , 
 removeQuotes ( otherIndexName . toLowerCase ( Locale . US ) ) , 
 removeQuotes ( indexName . toLowerCase ( Locale . US ) ) ) ,

NEAREST DIFF:
ELIMINATEDSENTENCE
