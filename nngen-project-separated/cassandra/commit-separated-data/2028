BLEU SCORE: 0.04844232281716619

TEST MSG: Fix race in RecoveryManagerTest
GENERATED MSG: add JVM shutdownhook to sync commitlog

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 7afed1e . . 274d07a 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 2 . 1 . 2 <nl> + * Fix race in RecoveryManagerTest ( CASSANDRA - 8176 ) <nl> * Avoid IllegalArgumentException while sorting sstables in <nl> IndexSummaryManager ( CASSANDRA - 8182 ) <nl> * Shutdown JVM on file descriptor exhaustion ( CASSANDRA - 7579 ) <nl> diff - - git a / test / unit / org / apache / cassandra / db / RecoveryManagerTest . java b / test / unit / org / apache / cassandra / db / RecoveryManagerTest . java <nl> index 2d820f3 . . 460c267 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / RecoveryManagerTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / RecoveryManagerTest . java <nl> @ @ - 40 , 13 + 40 , 16 @ @ import static org . apache . cassandra . Util . cellname ; <nl> public class RecoveryManagerTest extends SchemaLoader <nl> { <nl> @ Test <nl> - public void testNothingToRecover ( ) throws IOException { <nl> + public void testNothingToRecover ( ) throws IOException <nl> + { <nl> + CommitLog . instance . resetUnsafe ( ) ; <nl> CommitLog . instance . recover ( ) ; <nl> } <nl> <nl> @ Test <nl> public void testOne ( ) throws IOException <nl> { <nl> + CommitLog . instance . resetUnsafe ( ) ; <nl> Keyspace keyspace1 = Keyspace . open ( " Keyspace1 " ) ; <nl> Keyspace keyspace2 = Keyspace . open ( " Keyspace2 " ) ; <nl> <nl> @ @ - 77 , 6 + 80 , 7 @ @ public class RecoveryManagerTest extends SchemaLoader <nl> @ Test <nl> public void testRecoverCounter ( ) throws IOException <nl> { <nl> + CommitLog . instance . resetUnsafe ( ) ; <nl> Keyspace keyspace1 = Keyspace . open ( " Keyspace1 " ) ; <nl> <nl> Mutation rm ; <nl> @ @ - 108 , 6 + 112 , 7 @ @ public class RecoveryManagerTest extends SchemaLoader <nl> @ Test <nl> public void testRecoverPIT ( ) throws Exception <nl> { <nl> + CommitLog . instance . resetUnsafe ( ) ; <nl> Date date = CommitLogArchiver . format . parse ( " 2112 : 12 : 12 12 : 12 : 12 " ) ; <nl> long timeMS = date . getTime ( ) - 5000 ; <nl> <nl> @ @ - 133 , 6 + 138 , 7 @ @ public class RecoveryManagerTest extends SchemaLoader <nl> @ Test <nl> public void testRecoverPITUnordered ( ) throws Exception <nl> { <nl> + CommitLog . instance . resetUnsafe ( ) ; <nl> Date date = CommitLogArchiver . format . parse ( " 2112 : 12 : 12 12 : 12 : 12 " ) ; <nl> long timeMS = date . getTime ( ) ; <nl>
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index f147b0f . . e03d2a9 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 9 , 6 + 9 , 7 @ @ <nl> <nl> 0 . 7 . 2 - dev <nl> * fix potential overflow in nodetool cfstats <nl> + * offline nodes ( CASSANDRA - 1951 ) <nl> <nl> <nl> 0 . 7 . 1 <nl> diff - - git a / contrib / javautils / src / test / java / org / apache / cassandra / contrib / utils / service / CassandraServiceTest . java b / contrib / javautils / src / test / java / org / apache / cassandra / contrib / utils / service / CassandraServiceTest . java <nl> index b6c0841 . . 36d66e5 100644 <nl> - - - a / contrib / javautils / src / test / java / org / apache / cassandra / contrib / utils / service / CassandraServiceTest . java <nl> + + + b / contrib / javautils / src / test / java / org / apache / cassandra / contrib / utils / service / CassandraServiceTest . java <nl> @ @ - 63 , 7 + 63 , 6 @ @ import org . junit . Test ; <nl> public class CassandraServiceTest { <nl> <nl> private static EmbeddedCassandraService cassandra ; <nl> - private static Thread cassandraRunner ; <nl> private static CassandraServiceDataCleaner cleaner ; <nl> <nl> / * * <nl> @ @ - 90 , 13 + 89 , 7 @ @ public class CassandraServiceTest { <nl> cleaner . prepare ( ) ; <nl> <nl> cassandra = new EmbeddedCassandraService ( ) ; <nl> - cassandra . init ( ) ; <nl> - <nl> - if ( cassandraRunner = = null ) { <nl> - cassandraRunner = new Thread ( cassandra ) ; <nl> - cassandraRunner . setDaemon ( true ) ; <nl> - cassandraRunner . start ( ) ; <nl> - } <nl> + cassandra . start ( ) ; <nl> } <nl> <nl> <nl> diff - - git a / src / java / org / apache / cassandra / service / AbstractCassandraDaemon . java b / src / java / org / apache / cassandra / service / AbstractCassandraDaemon . java <nl> index 0563a7a . . 6b60c9f 100644 <nl> - - - a / src / java / org / apache / cassandra / service / AbstractCassandraDaemon . java <nl> + + + b / src / java / org / apache / cassandra / service / AbstractCassandraDaemon . java <nl> @ @ - 56 , 6 + 56 , 10 @ @ import org . mortbay . thread . ThreadPool ; <nl> * / <nl> public abstract class AbstractCassandraDaemon implements CassandraDaemon <nl> { <nl> + public AbstractCassandraDaemon ( ) <nl> + { <nl> + StorageService . instance . registerDaemon ( this ) ; <nl> + } <nl> <nl> / / Initialize logging in such a way that it checks for config changes every 10 seconds . <nl> static <nl> @ @ - 82 , 6 + 86 , 7 @ @ public abstract class AbstractCassandraDaemon implements CassandraDaemon <nl> <nl> protected InetAddress listenAddr ; <nl> protected int listenPort ; <nl> + protected volatile boolean isRunning = false ; <nl> <nl> public static final int MIN _ WORKER _ THREADS = 64 ; <nl> <nl> @ @ - 211 , 15 + 216 , 82 @ @ public abstract class AbstractCassandraDaemon implements CassandraDaemon <nl> * Start the Cassandra Daemon , assuming that it has already been <nl> * initialized , via either { @ link # init ( String [ ] ) } or <nl> * { @ link # load ( String [ ] ) } . <nl> - * <nl> + * <nl> + * Hook for JSVC <nl> + * <nl> * @ throws IOException <nl> * / <nl> - public abstract void start ( ) throws IOException ; <nl> + public void start ( ) <nl> + { <nl> + if ( Boolean . parseBoolean ( System . getProperty ( " cassandra . start _ rpc " , " true " ) ) ) <nl> + { <nl> + startRPCServer ( ) ; <nl> + } <nl> + else <nl> + { <nl> + logger . info ( " Not starting RPC server as requested . Use JMX ( StorageService - > startRPCServer ( ) ) to start it " ) ; <nl> + } <nl> + } <nl> <nl> / * * <nl> * Stop the daemon , ideally in an idempotent manner . <nl> + * <nl> + * Hook for JSVC <nl> + * / <nl> + public void stop ( ) <nl> + { <nl> + / / this doesn ' t entirely shut down Cassandra , just the RPC server . <nl> + / / jsvc takes care of taking the rest down <nl> + logger . info ( " Cassandra shutting down . . . " ) ; <nl> + stopRPCServer ( ) ; <nl> + } <nl> + <nl> + / * * <nl> + * Start the underlying RPC server in idempotent manner . <nl> + * / <nl> + public void startRPCServer ( ) <nl> + { <nl> + if ( ! isRunning ) <nl> + { <nl> + startServer ( ) ; <nl> + isRunning = true ; <nl> + } <nl> + } <nl> + <nl> + / * * <nl> + * Stop the underlying RPC server in idempotent manner . <nl> + * / <nl> + public void stopRPCServer ( ) <nl> + { <nl> + if ( isRunning ) <nl> + { <nl> + stopServer ( ) ; <nl> + isRunning = false ; <nl> + } <nl> + } <nl> + <nl> + / * * <nl> + * Returns whether the underlying RPC server is running or not . <nl> + * / <nl> + public boolean isRPCServerRunning ( ) <nl> + { <nl> + return isRunning ; <nl> + } <nl> + <nl> + / * * <nl> + * Start the underlying RPC server . <nl> + * This method shoud be able to restart a server stopped through stopServer ( ) . <nl> + * Should throw a RuntimeException if the server cannot be started <nl> * / <nl> - public abstract void stop ( ) ; <nl> + protected abstract void startServer ( ) ; <nl> + <nl> + / * * <nl> + * Stop the underlying RPC server . <nl> + * This method should be able to stop server started through startServer ( ) . <nl> + * Should throw a RuntimeException if the server cannot be stopped <nl> + * / <nl> + protected abstract void stopServer ( ) ; <nl> + <nl> <nl> / * * <nl> * Clean up all resources obtained during the lifetime of the daemon . This <nl> diff - - git a / src / java / org / apache / cassandra / service / CassandraDaemon . java b / src / java / org / apache / cassandra / service / CassandraDaemon . java <nl> index c26e646 . . 3522cff 100644 <nl> - - - a / src / java / org / apache / cassandra / service / CassandraDaemon . java <nl> + + + b / src / java / org / apache / cassandra / service / CassandraDaemon . java <nl> @ @ - 60 , 6 + 60 , 10 @ @ public interface CassandraDaemon <nl> * to clarify , this is a hook for JSVC . <nl> * / <nl> public void destroy ( ) ; <nl> + <nl> + public void startRPCServer ( ) ; <nl> + public void stopRPCServer ( ) ; <nl> + public boolean isRPCServerRunning ( ) ; <nl> <nl> / * * <nl> * A convenience method to initialize and start the daemon in one shot . <nl> diff - - git a / src / java / org / apache / cassandra / service / EmbeddedCassandraService . java b / src / java / org / apache / cassandra / service / EmbeddedCassandraService . java <nl> index 25d31ae . . 6ccf3e4 100644 <nl> - - - a / src / java / org / apache / cassandra / service / EmbeddedCassandraService . java <nl> + + + b / src / java / org / apache / cassandra / service / EmbeddedCassandraService . java <nl> @ @ - 37 , 35 + 37 , 26 @ @ import org . apache . thrift . transport . TTransportException ; <nl> * This is the implementation of https : / / issues . apache . org / jira / browse / CASSANDRA - 740 <nl> * < p > <nl> * How to use : <nl> - * In the client code create a new thread and spawn it with its { @ link Thread # start ( ) } method . <nl> + * In the client code simply create a new EmbeddedCassandraService and start it . <nl> * Example : <nl> * < pre > <nl> <nl> cassandra = new EmbeddedCassandraService ( ) ; <nl> - cassandra . init ( ) ; <nl> - <nl> - / / spawn cassandra in a new thread <nl> - Thread t = new Thread ( cassandra ) ; <nl> - t . setDaemon ( true ) ; <nl> - t . start ( ) ; <nl> + cassandra . start ( ) ; <nl> <nl> * < / pre > <nl> * @ author Ran Tavory ( rantav @ gmail . com ) <nl> * <nl> * / <nl> - public class EmbeddedCassandraService implements Runnable <nl> + public class EmbeddedCassandraService <nl> { <nl> <nl> CassandraDaemon cassandraDaemon ; <nl> <nl> - public void init ( ) throws TTransportException , IOException <nl> + public void start ( ) throws IOException <nl> { <nl> cassandraDaemon = new CassandraDaemon ( ) ; <nl> cassandraDaemon . init ( null ) ; <nl> - } <nl> - <nl> - public void run ( ) <nl> - { <nl> cassandraDaemon . start ( ) ; <nl> } <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java <nl> index 8f7c182 . . 56ffbbf 100644 <nl> - - - a / src / java / org / apache / cassandra / service / StorageService . java <nl> + + + b / src / java / org / apache / cassandra / service / StorageService . java <nl> @ @ - 172 , 6 + 172 , 8 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe <nl> private TokenMetadata tokenMetadata _ = new TokenMetadata ( ) ; <nl> <nl> private Set < InetAddress > replicatingNodes = Collections . synchronizedSet ( new HashSet < InetAddress > ( ) ) ; <nl> + private CassandraDaemon daemon ; <nl> + <nl> private InetAddress removingNode ; <nl> <nl> / * Are we starting this node in bootstrap mode ? * / <nl> @ @ - 248 , 6 + 250 , 11 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe <nl> throw new RuntimeException ( " Streaming service is unavailable . " ) ; <nl> } <nl> <nl> + public void registerDaemon ( CassandraDaemon daemon ) <nl> + { <nl> + this . daemon = daemon ; <nl> + } <nl> + <nl> / / should only be called via JMX <nl> public void stopGossiping ( ) <nl> { <nl> @ @ - 270 , 6 + 277 , 35 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe <nl> } <nl> } <nl> <nl> + / / should only be called via JMX <nl> + public void startRPCServer ( ) <nl> + { <nl> + if ( daemon = = null ) <nl> + { <nl> + throw new IllegalStateException ( " No configured RPC daemon " ) ; <nl> + } <nl> + daemon . startRPCServer ( ) ; <nl> + } <nl> + <nl> + / / should only be called via JMX <nl> + public void stopRPCServer ( ) <nl> + { <nl> + if ( daemon = = null ) <nl> + { <nl> + throw new IllegalStateException ( " No configured RPC daemon " ) ; <nl> + } <nl> + daemon . stopRPCServer ( ) ; <nl> + } <nl> + <nl> + public boolean isRPCServerRunning ( ) <nl> + { <nl> + if ( daemon = = null ) <nl> + { <nl> + throw new IllegalStateException ( " No configured RPC daemon " ) ; <nl> + } <nl> + return daemon . isRPCServerRunning ( ) ; <nl> + } <nl> + <nl> public void stopClient ( ) <nl> { <nl> Gossiper . instance . unregister ( migrationManager ) ; <nl> diff - - git a / src / java / org / apache / cassandra / service / StorageServiceMBean . java b / src / java / org / apache / cassandra / service / StorageServiceMBean . java <nl> index 55293d0 . . 2a8c9b8 100644 <nl> - - - a / src / java / org / apache / cassandra / service / StorageServiceMBean . java <nl> + + + b / src / java / org / apache / cassandra / service / StorageServiceMBean . java <nl> @ @ - 281 , 6 + 281 , 15 @ @ public interface StorageServiceMBean <nl> / / to determine if gossip is disabled <nl> public boolean isInitialized ( ) ; <nl> <nl> + / / allows a user to disable thrift <nl> + public void stopRPCServer ( ) ; <nl> + <nl> + / / allows a user to reenable thrift <nl> + public void startRPCServer ( ) ; <nl> + <nl> + / / to determine if thrift is running <nl> + public boolean isRPCServerRunning ( ) ; <nl> + <nl> public void invalidateKeyCaches ( String ks , String . . . cfs ) throws IOException ; <nl> public void invalidateRowCaches ( String ks , String . . . cfs ) throws IOException ; <nl> <nl> diff - - git a / src / java / org / apache / cassandra / thrift / CassandraDaemon . java b / src / java / org / apache / cassandra / thrift / CassandraDaemon . java <nl> index 42ce6c6 . . fe607e2 100644 <nl> - - - a / src / java / org / apache / cassandra / thrift / CassandraDaemon . java <nl> + + + b / src / java / org / apache / cassandra / thrift / CassandraDaemon . java <nl> @ @ - 19 , 6 + 19 , 7 @ @ <nl> package org . apache . cassandra . thrift ; <nl> <nl> import java . io . IOException ; <nl> + import java . net . InetAddress ; <nl> import java . net . InetSocketAddress ; <nl> import java . util . concurrent . ExecutorService ; <nl> <nl> @ @ - 47 , 89 + 48 , 118 @ @ import org . apache . thrift . transport . TTransportFactory ; <nl> public class CassandraDaemon extends org . apache . cassandra . service . AbstractCassandraDaemon <nl> { <nl> private static Logger logger = LoggerFactory . getLogger ( CassandraDaemon . class ) ; <nl> - private TServer serverEngine ; <nl> + private ThriftServer server ; <nl> <nl> - protected void setup ( ) throws IOException <nl> + protected void startServer ( ) <nl> { <nl> - super . setup ( ) ; <nl> - <nl> - / / now we start listening for clients <nl> - final CassandraServer cassandraServer = new CassandraServer ( ) ; <nl> - Cassandra . Processor processor = new Cassandra . Processor ( cassandraServer ) ; <nl> - <nl> - / / Transport <nl> - TServerSocket tServerSocket = null ; <nl> - <nl> - try <nl> - { <nl> - tServerSocket = new TCustomServerSocket ( new InetSocketAddress ( listenAddr , listenPort ) , <nl> - DatabaseDescriptor . getRpcKeepAlive ( ) , <nl> - DatabaseDescriptor . getRpcSendBufferSize ( ) , <nl> - DatabaseDescriptor . getRpcRecvBufferSize ( ) ) ; <nl> - } <nl> - catch ( TTransportException e ) <nl> - { <nl> - throw new IOException ( String . format ( " Unable to create thrift socket to % s : % s " , <nl> - listenAddr , listenPort ) , e ) ; <nl> - } <nl> - <nl> - logger . info ( String . format ( " Binding thrift service to % s : % s " , listenAddr , listenPort ) ) ; <nl> - <nl> - / / Protocol factory <nl> - TProtocolFactory tProtocolFactory = new TBinaryProtocol . Factory ( true , <nl> - true , <nl> - DatabaseDescriptor . getThriftMaxMessageLength ( ) ) ; <nl> - <nl> - / / Transport factory <nl> - TTransportFactory inTransportFactory , outTransportFactory ; <nl> - if ( DatabaseDescriptor . isThriftFramed ( ) ) <nl> - { <nl> - int tFramedTransportSize = DatabaseDescriptor . getThriftFramedTransportSize ( ) ; <nl> - inTransportFactory = new TFastFramedTransport . Factory ( 64 * 1024 , tFramedTransportSize ) ; <nl> - outTransportFactory = new TFastFramedTransport . Factory ( 64 * 1024 , tFramedTransportSize ) ; <nl> - logger . info ( " Using TFastFramedTransport with a max frame size of { } bytes . " , tFramedTransportSize ) ; <nl> - } <nl> - else <nl> + if ( server = = null ) <nl> { <nl> - inTransportFactory = new TTransportFactory ( ) ; <nl> - outTransportFactory = new TTransportFactory ( ) ; <nl> + server = new ThriftServer ( listenAddr , listenPort ) ; <nl> + server . start ( ) ; <nl> } <nl> - <nl> - / / ThreadPool Server <nl> - CustomTThreadPoolServer . Options options = new CustomTThreadPoolServer . Options ( ) ; <nl> - options . minWorkerThreads = MIN _ WORKER _ THREADS ; <nl> - <nl> - ExecutorService executorService = new CleaningThreadPool ( cassandraServer . clientState , <nl> - options . minWorkerThreads , <nl> - options . maxWorkerThreads ) ; <nl> - serverEngine = new CustomTThreadPoolServer ( new TProcessorFactory ( processor ) , <nl> - tServerSocket , <nl> - inTransportFactory , <nl> - outTransportFactory , <nl> - tProtocolFactory , <nl> - tProtocolFactory , <nl> - options , <nl> - executorService ) ; <nl> } <nl> <nl> - / * * hook for JSVC * / <nl> - public void start ( ) <nl> + protected void stopServer ( ) <nl> { <nl> - logger . info ( " Listening for thrift clients . . . " ) ; <nl> - serverEngine . serve ( ) ; <nl> + if ( server ! = null ) <nl> + { <nl> + server . stopServer ( ) ; <nl> + try <nl> + { <nl> + server . join ( ) ; <nl> + } <nl> + catch ( InterruptedException e ) <nl> + { <nl> + logger . error ( " Interrupted while waiting thrift server to stop " , e ) ; <nl> + } <nl> + server = null ; <nl> + } <nl> } <nl> <nl> - / * * hook for JSVC * / <nl> - public void stop ( ) <nl> - { <nl> - / / this doesn ' t entirely shut down Cassandra , just the Thrift server . <nl> - / / jsvc takes care of taking the rest down <nl> - logger . info ( " Cassandra shutting down . . . " ) ; <nl> - serverEngine . stop ( ) ; <nl> - } <nl> - <nl> public static void main ( String [ ] args ) <nl> { <nl> new CassandraDaemon ( ) . activate ( ) ; <nl> } <nl> + <nl> + / * * <nl> + * Simple class to run the thrift connection accepting code in separate <nl> + * thread of control . <nl> + * / <nl> + private static class ThriftServer extends Thread <nl> + { <nl> + private TServer serverEngine ; <nl> + <nl> + public ThriftServer ( InetAddress listenAddr , int listenPort ) <nl> + { <nl> + / / now we start listening for clients <nl> + final CassandraServer cassandraServer = new CassandraServer ( ) ; <nl> + Cassandra . Processor processor = new Cassandra . Processor ( cassandraServer ) ; <nl> + <nl> + / / Transport <nl> + TServerSocket tServerSocket = null ; <nl> + <nl> + try <nl> + { <nl> + tServerSocket = new TCustomServerSocket ( new InetSocketAddress ( listenAddr , listenPort ) , <nl> + DatabaseDescriptor . getRpcKeepAlive ( ) , <nl> + DatabaseDescriptor . getRpcSendBufferSize ( ) , <nl> + DatabaseDescriptor . getRpcRecvBufferSize ( ) ) ; <nl> + } <nl> + catch ( TTransportException e ) <nl> + { <nl> + throw new RuntimeException ( String . format ( " Unable to create thrift socket to % s : % s " , <nl> + listenAddr , listenPort ) , e ) ; <nl> + } <nl> + <nl> + logger . info ( String . format ( " Binding thrift service to % s : % s " , listenAddr , listenPort ) ) ; <nl> + <nl> + / / Protocol factory <nl> + TProtocolFactory tProtocolFactory = new TBinaryProtocol . Factory ( true , <nl> + true , <nl> + DatabaseDescriptor . getThriftMaxMessageLength ( ) ) ; <nl> + <nl> + / / Transport factory <nl> + TTransportFactory inTransportFactory , outTransportFactory ; <nl> + if ( DatabaseDescriptor . isThriftFramed ( ) ) <nl> + { <nl> + int tFramedTransportSize = DatabaseDescriptor . getThriftFramedTransportSize ( ) ; <nl> + inTransportFactory = new TFastFramedTransport . Factory ( 64 * 1024 , tFramedTransportSize ) ; <nl> + outTransportFactory = new TFastFramedTransport . Factory ( 64 * 1024 , tFramedTransportSize ) ; <nl> + logger . info ( " Using TFastFramedTransport with a max frame size of { } bytes . " , tFramedTransportSize ) ; <nl> + } <nl> + else <nl> + { <nl> + inTransportFactory = new TTransportFactory ( ) ; <nl> + outTransportFactory = new TTransportFactory ( ) ; <nl> + } <nl> + <nl> + / / ThreadPool Server <nl> + CustomTThreadPoolServer . Options options = new CustomTThreadPoolServer . Options ( ) ; <nl> + options . minWorkerThreads = MIN _ WORKER _ THREADS ; <nl> + <nl> + ExecutorService executorService = new CleaningThreadPool ( cassandraServer . clientState , <nl> + options . minWorkerThreads , <nl> + options . maxWorkerThreads ) ; <nl> + serverEngine = new CustomTThreadPoolServer ( new TProcessorFactory ( processor ) , <nl> + tServerSocket , <nl> + inTransportFactory , <nl> + outTransportFactory , <nl> + tProtocolFactory , <nl> + tProtocolFactory , <nl> + options , <nl> + executorService ) ; <nl> + } <nl> + <nl> + public void run ( ) <nl> + { <nl> + logger . info ( " Listening for thrift clients . . . " ) ; <nl> + serverEngine . serve ( ) ; <nl> + } <nl> + <nl> + public void stopServer ( ) <nl> + { <nl> + logger . info ( " Stop listening to thrift clients " ) ; <nl> + serverEngine . stop ( ) ; <nl> + } <nl> + } <nl> } <nl> diff - - git a / test / unit / org / apache / cassandra / cli / CliTest . java b / test / unit / org / apache / cassandra / cli / CliTest . java <nl> index a34feac . . 580b127 100644 <nl> - - - a / test / unit / org / apache / cassandra / cli / CliTest . java <nl> + + + b / test / unit / org / apache / cassandra / cli / CliTest . java <nl> @ @ - 146 , 7 + 146 , 7 @ @ public class CliTest extends CleanupHelper <nl> @ Test <nl> public void testCli ( ) throws IOException , TTransportException , ConfigurationException <nl> { <nl> - setup ( ) ; <nl> + new EmbeddedCassandraService ( ) . start ( ) ; <nl> <nl> / / new error / output streams for CliSessionState <nl> ByteArrayOutputStream errStream = new ByteArrayOutputStream ( ) ; <nl> @ @ - 204 , 24 + 204 , 4 @ @ public class CliTest extends CleanupHelper <nl> errStream . reset ( ) ; / / no errors to the end user . <nl> } <nl> } <nl> - <nl> - / * * <nl> - * Setup embedded cassandra instance using test config . <nl> - * @ throws TTransportException - when trying to bind address <nl> - * @ throws IOException - when reading config file <nl> - * @ throws ConfigurationException - when can set up configuration <nl> - * / <nl> - private void setup ( ) throws TTransportException , IOException , ConfigurationException <nl> - { <nl> - EmbeddedCassandraService cassandra ; <nl> - <nl> - cassandra = new EmbeddedCassandraService ( ) ; <nl> - cassandra . init ( ) ; <nl> - <nl> - / / spawn cassandra in a new thread <nl> - Thread t = new Thread ( cassandra ) ; <nl> - t . setDaemon ( true ) ; <nl> - t . start ( ) ; <nl> - } <nl> - <nl> } <nl> diff - - git a / test / unit / org / apache / cassandra / service / EmbeddedCassandraServiceTest . java b / test / unit / org / apache / cassandra / service / EmbeddedCassandraServiceTest . java <nl> index e02432f . . efd2e11 100644 <nl> - - - a / test / unit / org / apache / cassandra / service / EmbeddedCassandraServiceTest . java <nl> + + + b / test / unit / org / apache / cassandra / service / EmbeddedCassandraServiceTest . java <nl> @ @ - 64 , 14 + 64 , 8 @ @ public class EmbeddedCassandraServiceTest extends CleanupHelper <nl> @ BeforeClass <nl> public static void setup ( ) throws TTransportException , IOException , InterruptedException , ConfigurationException <nl> { <nl> - <nl> cassandra = new EmbeddedCassandraService ( ) ; <nl> - cassandra . init ( ) ; <nl> - <nl> - / / spawn cassandra in a new thread <nl> - Thread t = new Thread ( cassandra ) ; <nl> - t . setDaemon ( true ) ; <nl> - t . start ( ) ; <nl> + cassandra . start ( ) ; <nl> } <nl> <nl> @ Test

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 7afed1e . . 274d07a 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 2 . 1 . 2 
 + * Fix race in RecoveryManagerTest ( CASSANDRA - 8176 ) 
 * Avoid IllegalArgumentException while sorting sstables in 
 IndexSummaryManager ( CASSANDRA - 8182 ) 
 * Shutdown JVM on file descriptor exhaustion ( CASSANDRA - 7579 ) 
 diff - - git a / test / unit / org / apache / cassandra / db / RecoveryManagerTest . java b / test / unit / org / apache / cassandra / db / RecoveryManagerTest . java 
 index 2d820f3 . . 460c267 100644 
 - - - a / test / unit / org / apache / cassandra / db / RecoveryManagerTest . java 
 + + + b / test / unit / org / apache / cassandra / db / RecoveryManagerTest . java 
 @ @ - 40 , 13 + 40 , 16 @ @ import static org . apache . cassandra . Util . cellname ; 
 public class RecoveryManagerTest extends SchemaLoader 
 { 
 @ Test 
 - public void testNothingToRecover ( ) throws IOException { 
 + public void testNothingToRecover ( ) throws IOException 
 + { 
 + CommitLog . instance . resetUnsafe ( ) ; 
 CommitLog . instance . recover ( ) ; 
 } 
 
 @ Test 
 public void testOne ( ) throws IOException 
 { 
 + CommitLog . instance . resetUnsafe ( ) ; 
 Keyspace keyspace1 = Keyspace . open ( " Keyspace1 " ) ; 
 Keyspace keyspace2 = Keyspace . open ( " Keyspace2 " ) ; 
 
 @ @ - 77 , 6 + 80 , 7 @ @ public class RecoveryManagerTest extends SchemaLoader 
 @ Test 
 public void testRecoverCounter ( ) throws IOException 
 { 
 + CommitLog . instance . resetUnsafe ( ) ; 
 Keyspace keyspace1 = Keyspace . open ( " Keyspace1 " ) ; 
 
 Mutation rm ; 
 @ @ - 108 , 6 + 112 , 7 @ @ public class RecoveryManagerTest extends SchemaLoader 
 @ Test 
 public void testRecoverPIT ( ) throws Exception 
 { 
 + CommitLog . instance . resetUnsafe ( ) ; 
 Date date = CommitLogArchiver . format . parse ( " 2112 : 12 : 12 12 : 12 : 12 " ) ; 
 long timeMS = date . getTime ( ) - 5000 ; 
 
 @ @ - 133 , 6 + 138 , 7 @ @ public class RecoveryManagerTest extends SchemaLoader 
 @ Test 
 public void testRecoverPITUnordered ( ) throws Exception 
 { 
 + CommitLog . instance . resetUnsafe ( ) ; 
 Date date = CommitLogArchiver . format . parse ( " 2112 : 12 : 12 12 : 12 : 12 " ) ; 
 long timeMS = date . getTime ( ) ; 


NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index f147b0f . . e03d2a9 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 9 , 6 + 9 , 7 @ @ 
 
 0 . 7 . 2 - dev 
 * fix potential overflow in nodetool cfstats 
 + * offline nodes ( CASSANDRA - 1951 ) 
 
 
 0 . 7 . 1 
 diff - - git a / contrib / javautils / src / test / java / org / apache / cassandra / contrib / utils / service / CassandraServiceTest . java b / contrib / javautils / src / test / java / org / apache / cassandra / contrib / utils / service / CassandraServiceTest . java 
 index b6c0841 . . 36d66e5 100644 
 - - - a / contrib / javautils / src / test / java / org / apache / cassandra / contrib / utils / service / CassandraServiceTest . java 
 + + + b / contrib / javautils / src / test / java / org / apache / cassandra / contrib / utils / service / CassandraServiceTest . java 
 @ @ - 63 , 7 + 63 , 6 @ @ import org . junit . Test ; 
 public class CassandraServiceTest { 
 
 private static EmbeddedCassandraService cassandra ; 
 - private static Thread cassandraRunner ; 
 private static CassandraServiceDataCleaner cleaner ; 
 
 / * * 
 @ @ - 90 , 13 + 89 , 7 @ @ public class CassandraServiceTest { 
 cleaner . prepare ( ) ; 
 
 cassandra = new EmbeddedCassandraService ( ) ; 
 - cassandra . init ( ) ; 
 - 
 - if ( cassandraRunner = = null ) { 
 - cassandraRunner = new Thread ( cassandra ) ; 
 - cassandraRunner . setDaemon ( true ) ; 
 - cassandraRunner . start ( ) ; 
 - } 
 + cassandra . start ( ) ; 
 } 
 
 
 diff - - git a / src / java / org / apache / cassandra / service / AbstractCassandraDaemon . java b / src / java / org / apache / cassandra / service / AbstractCassandraDaemon . java 
 index 0563a7a . . 6b60c9f 100644 
 - - - a / src / java / org / apache / cassandra / service / AbstractCassandraDaemon . java 
 + + + b / src / java / org / apache / cassandra / service / AbstractCassandraDaemon . java 
 @ @ - 56 , 6 + 56 , 10 @ @ import org . mortbay . thread . ThreadPool ; 
 * / 
 public abstract class AbstractCassandraDaemon implements CassandraDaemon 
 { 
 + public AbstractCassandraDaemon ( ) 
 + { 
 + StorageService . instance . registerDaemon ( this ) ; 
 + } 
 
 / / Initialize logging in such a way that it checks for config changes every 10 seconds . 
 static 
 @ @ - 82 , 6 + 86 , 7 @ @ public abstract class AbstractCassandraDaemon implements CassandraDaemon 
 
 protected InetAddress listenAddr ; 
 protected int listenPort ; 
 + protected volatile boolean isRunning = false ; 
 
 public static final int MIN _ WORKER _ THREADS = 64 ; 
 
 @ @ - 211 , 15 + 216 , 82 @ @ public abstract class AbstractCassandraDaemon implements CassandraDaemon 
 * Start the Cassandra Daemon , assuming that it has already been 
 * initialized , via either { @ link # init ( String [ ] ) } or 
 * { @ link # load ( String [ ] ) } . 
 - * 
 + * 
 + * Hook for JSVC 
 + * 
 * @ throws IOException 
 * / 
 - public abstract void start ( ) throws IOException ; 
 + public void start ( ) 
 + { 
 + if ( Boolean . parseBoolean ( System . getProperty ( " cassandra . start _ rpc " , " true " ) ) ) 
 + { 
 + startRPCServer ( ) ; 
 + } 
 + else 
 + { 
 + logger . info ( " Not starting RPC server as requested . Use JMX ( StorageService - > startRPCServer ( ) ) to start it " ) ; 
 + } 
 + } 
 
 / * * 
 * Stop the daemon , ideally in an idempotent manner . 
 + * 
 + * Hook for JSVC 
 + * / 
 + public void stop ( ) 
 + { 
 + / / this doesn ' t entirely shut down Cassandra , just the RPC server . 
 + / / jsvc takes care of taking the rest down 
 + logger . info ( " Cassandra shutting down . . . " ) ; 
 + stopRPCServer ( ) ; 
 + } 
 + 
 + / * * 
 + * Start the underlying RPC server in idempotent manner . 
 + * / 
 + public void startRPCServer ( ) 
 + { 
 + if ( ! isRunning ) 
 + { 
 + startServer ( ) ; 
 + isRunning = true ; 
 + } 
 + } 
 + 
 + / * * 
 + * Stop the underlying RPC server in idempotent manner . 
 + * / 
 + public void stopRPCServer ( ) 
 + { 
 + if ( isRunning ) 
 + { 
 + stopServer ( ) ; 
 + isRunning = false ; 
 + } 
 + } 
 + 
 + / * * 
 + * Returns whether the underlying RPC server is running or not . 
 + * / 
 + public boolean isRPCServerRunning ( ) 
 + { 
 + return isRunning ; 
 + } 
 + 
 + / * * 
 + * Start the underlying RPC server . 
 + * This method shoud be able to restart a server stopped through stopServer ( ) . 
 + * Should throw a RuntimeException if the server cannot be started 
 * / 
 - public abstract void stop ( ) ; 
 + protected abstract void startServer ( ) ; 
 + 
 + / * * 
 + * Stop the underlying RPC server . 
 + * This method should be able to stop server started through startServer ( ) . 
 + * Should throw a RuntimeException if the server cannot be stopped 
 + * / 
 + protected abstract void stopServer ( ) ; 
 + 
 
 / * * 
 * Clean up all resources obtained during the lifetime of the daemon . This 
 diff - - git a / src / java / org / apache / cassandra / service / CassandraDaemon . java b / src / java / org / apache / cassandra / service / CassandraDaemon . java 
 index c26e646 . . 3522cff 100644 
 - - - a / src / java / org / apache / cassandra / service / CassandraDaemon . java 
 + + + b / src / java / org / apache / cassandra / service / CassandraDaemon . java 
 @ @ - 60 , 6 + 60 , 10 @ @ public interface CassandraDaemon 
 * to clarify , this is a hook for JSVC . 
 * / 
 public void destroy ( ) ; 
 + 
 + public void startRPCServer ( ) ; 
 + public void stopRPCServer ( ) ; 
 + public boolean isRPCServerRunning ( ) ; 
 
 / * * 
 * A convenience method to initialize and start the daemon in one shot . 
 diff - - git a / src / java / org / apache / cassandra / service / EmbeddedCassandraService . java b / src / java / org / apache / cassandra / service / EmbeddedCassandraService . java 
 index 25d31ae . . 6ccf3e4 100644 
 - - - a / src / java / org / apache / cassandra / service / EmbeddedCassandraService . java 
 + + + b / src / java / org / apache / cassandra / service / EmbeddedCassandraService . java 
 @ @ - 37 , 35 + 37 , 26 @ @ import org . apache . thrift . transport . TTransportException ; 
 * This is the implementation of https : / / issues . apache . org / jira / browse / CASSANDRA - 740 
 * < p > 
 * How to use : 
 - * In the client code create a new thread and spawn it with its { @ link Thread # start ( ) } method . 
 + * In the client code simply create a new EmbeddedCassandraService and start it . 
 * Example : 
 * < pre > 
 
 cassandra = new EmbeddedCassandraService ( ) ; 
 - cassandra . init ( ) ; 
 - 
 - / / spawn cassandra in a new thread 
 - Thread t = new Thread ( cassandra ) ; 
 - t . setDaemon ( true ) ; 
 - t . start ( ) ; 
 + cassandra . start ( ) ; 
 
 * < / pre > 
 * @ author Ran Tavory ( rantav @ gmail . com ) 
 * 
 * / 
 - public class EmbeddedCassandraService implements Runnable 
 + public class EmbeddedCassandraService 
 { 
 
 CassandraDaemon cassandraDaemon ; 
 
 - public void init ( ) throws TTransportException , IOException 
 + public void start ( ) throws IOException 
 { 
 cassandraDaemon = new CassandraDaemon ( ) ; 
 cassandraDaemon . init ( null ) ; 
 - } 
 - 
 - public void run ( ) 
 - { 
 cassandraDaemon . start ( ) ; 
 } 
 } 
 diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java 
 index 8f7c182 . . 56ffbbf 100644 
 - - - a / src / java / org / apache / cassandra / service / StorageService . java 
 + + + b / src / java / org / apache / cassandra / service / StorageService . java 
 @ @ - 172 , 6 + 172 , 8 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe 
 private TokenMetadata tokenMetadata _ = new TokenMetadata ( ) ; 
 
 private Set < InetAddress > replicatingNodes = Collections . synchronizedSet ( new HashSet < InetAddress > ( ) ) ; 
 + private CassandraDaemon daemon ; 
 + 
 private InetAddress removingNode ; 
 
 / * Are we starting this node in bootstrap mode ? * / 
 @ @ - 248 , 6 + 250 , 11 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe 
 throw new RuntimeException ( " Streaming service is unavailable . " ) ; 
 } 
 
 + public void registerDaemon ( CassandraDaemon daemon ) 
 + { 
 + this . daemon = daemon ; 
 + } 
 + 
 / / should only be called via JMX 
 public void stopGossiping ( ) 
 { 
 @ @ - 270 , 6 + 277 , 35 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe 
 } 
 } 
 
 + / / should only be called via JMX 
 + public void startRPCServer ( ) 
 + { 
 + if ( daemon = = null ) 
 + { 
 + throw new IllegalStateException ( " No configured RPC daemon " ) ; 
 + } 
 + daemon . startRPCServer ( ) ; 
 + } 
 + 
 + / / should only be called via JMX 
 + public void stopRPCServer ( ) 
 + { 
 + if ( daemon = = null ) 
 + { 
 + throw new IllegalStateException ( " No configured RPC daemon " ) ; 
 + } 
 + daemon . stopRPCServer ( ) ; 
 + } 
 + 
 + public boolean isRPCServerRunning ( ) 
 + { 
 + if ( daemon = = null ) 
 + { 
 + throw new IllegalStateException ( " No configured RPC daemon " ) ; 
 + } 
 + return daemon . isRPCServerRunning ( ) ; 
 + } 
 + 
 public void stopClient ( ) 
 { 
 Gossiper . instance . unregister ( migrationManager ) ; 
 diff - - git a / src / java / org / apache / cassandra / service / StorageServiceMBean . java b / src / java / org / apache / cassandra / service / StorageServiceMBean . java 
 index 55293d0 . . 2a8c9b8 100644 
 - - - a / src / java / org / apache / cassandra / service / StorageServiceMBean . java 
 + + + b / src / java / org / apache / cassandra / service / StorageServiceMBean . java 
 @ @ - 281 , 6 + 281 , 15 @ @ public interface StorageServiceMBean 
 / / to determine if gossip is disabled 
 public boolean isInitialized ( ) ; 
 
 + / / allows a user to disable thrift 
 + public void stopRPCServer ( ) ; 
 + 
 + / / allows a user to reenable thrift 
 + public void startRPCServer ( ) ; 
 + 
 + / / to determine if thrift is running 
 + public boolean isRPCServerRunning ( ) ; 
 + 
 public void invalidateKeyCaches ( String ks , String . . . cfs ) throws IOException ; 
 public void invalidateRowCaches ( String ks , String . . . cfs ) throws IOException ; 
 
 diff - - git a / src / java / org / apache / cassandra / thrift / CassandraDaemon . java b / src / java / org / apache / cassandra / thrift / CassandraDaemon . java 
 index 42ce6c6 . . fe607e2 100644 
 - - - a / src / java / org / apache / cassandra / thrift / CassandraDaemon . java 
 + + + b / src / java / org / apache / cassandra / thrift / CassandraDaemon . java 
 @ @ - 19 , 6 + 19 , 7 @ @ 
 package org . apache . cassandra . thrift ; 
 
 import java . io . IOException ; 
 + import java . net . InetAddress ; 
 import java . net . InetSocketAddress ; 
 import java . util . concurrent . ExecutorService ; 
 
 @ @ - 47 , 89 + 48 , 118 @ @ import org . apache . thrift . transport . TTransportFactory ; 
 public class CassandraDaemon extends org . apache . cassandra . service . AbstractCassandraDaemon 
 { 
 private static Logger logger = LoggerFactory . getLogger ( CassandraDaemon . class ) ; 
 - private TServer serverEngine ; 
 + private ThriftServer server ; 
 
 - protected void setup ( ) throws IOException 
 + protected void startServer ( ) 
 { 
 - super . setup ( ) ; 
 - 
 - / / now we start listening for clients 
 - final CassandraServer cassandraServer = new CassandraServer ( ) ; 
 - Cassandra . Processor processor = new Cassandra . Processor ( cassandraServer ) ; 
 - 
 - / / Transport 
 - TServerSocket tServerSocket = null ; 
 - 
 - try 
 - { 
 - tServerSocket = new TCustomServerSocket ( new InetSocketAddress ( listenAddr , listenPort ) , 
 - DatabaseDescriptor . getRpcKeepAlive ( ) , 
 - DatabaseDescriptor . getRpcSendBufferSize ( ) , 
 - DatabaseDescriptor . getRpcRecvBufferSize ( ) ) ; 
 - } 
 - catch ( TTransportException e ) 
 - { 
 - throw new IOException ( String . format ( " Unable to create thrift socket to % s : % s " , 
 - listenAddr , listenPort ) , e ) ; 
 - } 
 - 
 - logger . info ( String . format ( " Binding thrift service to % s : % s " , listenAddr , listenPort ) ) ; 
 - 
 - / / Protocol factory 
 - TProtocolFactory tProtocolFactory = new TBinaryProtocol . Factory ( true , 
 - true , 
 - DatabaseDescriptor . getThriftMaxMessageLength ( ) ) ; 
 - 
 - / / Transport factory 
 - TTransportFactory inTransportFactory , outTransportFactory ; 
 - if ( DatabaseDescriptor . isThriftFramed ( ) ) 
 - { 
 - int tFramedTransportSize = DatabaseDescriptor . getThriftFramedTransportSize ( ) ; 
 - inTransportFactory = new TFastFramedTransport . Factory ( 64 * 1024 , tFramedTransportSize ) ; 
 - outTransportFactory = new TFastFramedTransport . Factory ( 64 * 1024 , tFramedTransportSize ) ; 
 - logger . info ( " Using TFastFramedTransport with a max frame size of { } bytes . " , tFramedTransportSize ) ; 
 - } 
 - else 
 + if ( server = = null ) 
 { 
 - inTransportFactory = new TTransportFactory ( ) ; 
 - outTransportFactory = new TTransportFactory ( ) ; 
 + server = new ThriftServer ( listenAddr , listenPort ) ; 
 + server . start ( ) ; 
 } 
 - 
 - / / ThreadPool Server 
 - CustomTThreadPoolServer . Options options = new CustomTThreadPoolServer . Options ( ) ; 
 - options . minWorkerThreads = MIN _ WORKER _ THREADS ; 
 - 
 - ExecutorService executorService = new CleaningThreadPool ( cassandraServer . clientState , 
 - options . minWorkerThreads , 
 - options . maxWorkerThreads ) ; 
 - serverEngine = new CustomTThreadPoolServer ( new TProcessorFactory ( processor ) , 
 - tServerSocket , 
 - inTransportFactory , 
 - outTransportFactory , 
 - tProtocolFactory , 
 - tProtocolFactory , 
 - options , 
 - executorService ) ; 
 } 
 
 - / * * hook for JSVC * / 
 - public void start ( ) 
 + protected void stopServer ( ) 
 { 
 - logger . info ( " Listening for thrift clients . . . " ) ; 
 - serverEngine . serve ( ) ; 
 + if ( server ! = null ) 
 + { 
 + server . stopServer ( ) ; 
 + try 
 + { 
 + server . join ( ) ; 
 + } 
 + catch ( InterruptedException e ) 
 + { 
 + logger . error ( " Interrupted while waiting thrift server to stop " , e ) ; 
 + } 
 + server = null ; 
 + } 
 } 
 
 - / * * hook for JSVC * / 
 - public void stop ( ) 
 - { 
 - / / this doesn ' t entirely shut down Cassandra , just the Thrift server . 
 - / / jsvc takes care of taking the rest down 
 - logger . info ( " Cassandra shutting down . . . " ) ; 
 - serverEngine . stop ( ) ; 
 - } 
 - 
 public static void main ( String [ ] args ) 
 { 
 new CassandraDaemon ( ) . activate ( ) ; 
 } 
 + 
 + / * * 
 + * Simple class to run the thrift connection accepting code in separate 
 + * thread of control . 
 + * / 
 + private static class ThriftServer extends Thread 
 + { 
 + private TServer serverEngine ; 
 + 
 + public ThriftServer ( InetAddress listenAddr , int listenPort ) 
 + { 
 + / / now we start listening for clients 
 + final CassandraServer cassandraServer = new CassandraServer ( ) ; 
 + Cassandra . Processor processor = new Cassandra . Processor ( cassandraServer ) ; 
 + 
 + / / Transport 
 + TServerSocket tServerSocket = null ; 
 + 
 + try 
 + { 
 + tServerSocket = new TCustomServerSocket ( new InetSocketAddress ( listenAddr , listenPort ) , 
 + DatabaseDescriptor . getRpcKeepAlive ( ) , 
 + DatabaseDescriptor . getRpcSendBufferSize ( ) , 
 + DatabaseDescriptor . getRpcRecvBufferSize ( ) ) ; 
 + } 
 + catch ( TTransportException e ) 
 + { 
 + throw new RuntimeException ( String . format ( " Unable to create thrift socket to % s : % s " , 
 + listenAddr , listenPort ) , e ) ; 
 + } 
 + 
 + logger . info ( String . format ( " Binding thrift service to % s : % s " , listenAddr , listenPort ) ) ; 
 + 
 + / / Protocol factory 
 + TProtocolFactory tProtocolFactory = new TBinaryProtocol . Factory ( true , 
 + true , 
 + DatabaseDescriptor . getThriftMaxMessageLength ( ) ) ; 
 + 
 + / / Transport factory 
 + TTransportFactory inTransportFactory , outTransportFactory ; 
 + if ( DatabaseDescriptor . isThriftFramed ( ) ) 
 + { 
 + int tFramedTransportSize = DatabaseDescriptor . getThriftFramedTransportSize ( ) ; 
 + inTransportFactory = new TFastFramedTransport . Factory ( 64 * 1024 , tFramedTransportSize ) ; 
 + outTransportFactory = new TFastFramedTransport . Factory ( 64 * 1024 , tFramedTransportSize ) ; 
 + logger . info ( " Using TFastFramedTransport with a max frame size of { } bytes . " , tFramedTransportSize ) ; 
 + } 
 + else 
 + { 
 + inTransportFactory = new TTransportFactory ( ) ; 
 + outTransportFactory = new TTransportFactory ( ) ; 
 + } 
 + 
 + / / ThreadPool Server 
 + CustomTThreadPoolServer . Options options = new CustomTThreadPoolServer . Options ( ) ; 
 + options . minWorkerThreads = MIN _ WORKER _ THREADS ; 
 + 
 + ExecutorService executorService = new CleaningThreadPool ( cassandraServer . clientState , 
 + options . minWorkerThreads , 
 + options . maxWorkerThreads ) ; 
 + serverEngine = new CustomTThreadPoolServer ( new TProcessorFactory ( processor ) , 
 + tServerSocket , 
 + inTransportFactory , 
 + outTransportFactory , 
 + tProtocolFactory , 
 + tProtocolFactory , 
 + options , 
 + executorService ) ; 
 + } 
 + 
 + public void run ( ) 
 + { 
 + logger . info ( " Listening for thrift clients . . . " ) ; 
 + serverEngine . serve ( ) ; 
 + } 
 + 
 + public void stopServer ( ) 
 + { 
 + logger . info ( " Stop listening to thrift clients " ) ; 
 + serverEngine . stop ( ) ; 
 + } 
 + } 
 } 
 diff - - git a / test / unit / org / apache / cassandra / cli / CliTest . java b / test / unit / org / apache / cassandra / cli / CliTest . java 
 index a34feac . . 580b127 100644 
 - - - a / test / unit / org / apache / cassandra / cli / CliTest . java 
 + + + b / test / unit / org / apache / cassandra / cli / CliTest . java 
 @ @ - 146 , 7 + 146 , 7 @ @ public class CliTest extends CleanupHelper 
 @ Test 
 public void testCli ( ) throws IOException , TTransportException , ConfigurationException 
 { 
 - setup ( ) ; 
 + new EmbeddedCassandraService ( ) . start ( ) ; 
 
 / / new error / output streams for CliSessionState 
 ByteArrayOutputStream errStream = new ByteArrayOutputStream ( ) ; 
 @ @ - 204 , 24 + 204 , 4 @ @ public class CliTest extends CleanupHelper 
 errStream . reset ( ) ; / / no errors to the end user . 
 } 
 } 
 - 
 - / * * 
 - * Setup embedded cassandra instance using test config . 
 - * @ throws TTransportException - when trying to bind address 
 - * @ throws IOException - when reading config file 
 - * @ throws ConfigurationException - when can set up configuration 
 - * / 
 - private void setup ( ) throws TTransportException , IOException , ConfigurationException 
 - { 
 - EmbeddedCassandraService cassandra ; 
 - 
 - cassandra = new EmbeddedCassandraService ( ) ; 
 - cassandra . init ( ) ; 
 - 
 - / / spawn cassandra in a new thread 
 - Thread t = new Thread ( cassandra ) ; 
 - t . setDaemon ( true ) ; 
 - t . start ( ) ; 
 - } 
 - 
 } 
 diff - - git a / test / unit / org / apache / cassandra / service / EmbeddedCassandraServiceTest . java b / test / unit / org / apache / cassandra / service / EmbeddedCassandraServiceTest . java 
 index e02432f . . efd2e11 100644 
 - - - a / test / unit / org / apache / cassandra / service / EmbeddedCassandraServiceTest . java 
 + + + b / test / unit / org / apache / cassandra / service / EmbeddedCassandraServiceTest . java 
 @ @ - 64 , 14 + 64 , 8 @ @ public class EmbeddedCassandraServiceTest extends CleanupHelper 
 @ BeforeClass 
 public static void setup ( ) throws TTransportException , IOException , InterruptedException , ConfigurationException 
 { 
 - 
 cassandra = new EmbeddedCassandraService ( ) ; 
 - cassandra . init ( ) ; 
 - 
 - / / spawn cassandra in a new thread 
 - Thread t = new Thread ( cassandra ) ; 
 - t . setDaemon ( true ) ; 
 - t . start ( ) ; 
 + cassandra . start ( ) ; 
 } 
 
 @ Test
