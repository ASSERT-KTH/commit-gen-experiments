BLEU SCORE: 0.014199193612838947

TEST MSG: Set default streaming _ socket _ timeout _ in _ ms to 24 hours
GENERATED MSG: Require enabling cross - node timeouts

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index d914420 . . 8dfa02a 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 2 . 1 . 15 <nl> + * Set default streaming _ socket _ timeout _ in _ ms to 24 hours ( CASSANDRA - 11840 ) <nl> * Do not consider local node a valid source during replace ( CASSANDRA - 11848 ) <nl> * Avoid holding SSTableReaders for duration of incremental repair ( CASSANDRA - 11739 ) <nl> * Add message dropped tasks to nodetool netstats ( CASSANDRA - 11855 ) <nl> diff - - git a / conf / cassandra . yaml b / conf / cassandra . yaml <nl> index 90c5be4 . . 7f2a6fa 100644 <nl> - - - a / conf / cassandra . yaml <nl> + + + b / conf / cassandra . yaml <nl> @ @ - 635 , 10 + 635 , 12 @ @ request _ timeout _ in _ ms : 10000 <nl> cross _ node _ timeout : false <nl> <nl> # Set socket timeout for streaming operation . <nl> - # The stream session is failed if no data is received by any of the <nl> - # participants within that period . <nl> - # Default value is 3600000 , which means streams timeout after an hour . <nl> - # streaming _ socket _ timeout _ in _ ms : 3600000 <nl> + # The stream session is failed if no data / ack is received by any of the participants <nl> + # within that period , which means this should also be sufficient to stream a large <nl> + # sstable or rebuild table indexes . <nl> + # Default value is 86400000ms , which means stale streams timeout after 24 hours . <nl> + # A value of zero means stream sockets should never time out . <nl> + # streaming _ socket _ timeout _ in _ ms : 86400000 <nl> <nl> # phi value that must be reached for a host to be marked down . <nl> # most users should never need to adjust this . <nl> diff - - git a / src / java / org / apache / cassandra / config / Config . java b / src / java / org / apache / cassandra / config / Config . java <nl> index 9ff7096 . . 2c5e36a 100644 <nl> - - - a / src / java / org / apache / cassandra / config / Config . java <nl> + + + b / src / java / org / apache / cassandra / config / Config . java <nl> @ @ - 85 , 7 + 85 , 7 @ @ public class Config <nl> <nl> public volatile Long truncate _ request _ timeout _ in _ ms = 60000L ; <nl> <nl> - public Integer streaming _ socket _ timeout _ in _ ms = 3600000 ; <nl> + public Integer streaming _ socket _ timeout _ in _ ms = 86400000 ; / / 24 hours <nl> <nl> public boolean cross _ node _ timeout = false ; <nl> <nl> diff - - git a / src / java / org / apache / cassandra / streaming / StreamSession . java b / src / java / org / apache / cassandra / streaming / StreamSession . java <nl> index 642e837 . . 4eb8557 100644 <nl> - - - a / src / java / org / apache / cassandra / streaming / StreamSession . java <nl> + + + b / src / java / org / apache / cassandra / streaming / StreamSession . java <nl> @ @ - 20 , 6 + 20 , 7 @ @ package org . apache . cassandra . streaming ; <nl> import java . io . IOException ; <nl> import java . net . InetAddress ; <nl> import java . net . Socket ; <nl> + import java . net . SocketTimeoutException ; <nl> import java . util . * ; <nl> import java . util . concurrent . * ; <nl> import java . util . concurrent . atomic . AtomicBoolean ; <nl> @ @ - 502 , 7 + 503 , 17 @ @ public class StreamSession implements IEndpointStateChangeSubscriber <nl> * / <nl> public void onError ( Throwable e ) <nl> { <nl> - logger . error ( " [ Stream # { } ] Streaming error occurred " , planId ( ) , e ) ; <nl> + if ( e instanceof SocketTimeoutException ) <nl> + { <nl> + logger . error ( " [ Stream # { } ] Streaming socket timed out . This means the session peer stopped responding or " + <nl> + " is still processing received data . If there is no sign of failure in the other end or a very " + <nl> + " dense table is being transferred you may want to increase streaming _ socket _ timeout _ in _ ms " + <nl> + " property . Current value is { } ms . " , planId ( ) , DatabaseDescriptor . getStreamingSocketTimeout ( ) , e ) ; <nl> + } <nl> + else <nl> + { <nl> + logger . error ( " [ Stream # { } ] Streaming error occurred " , planId ( ) , e ) ; <nl> + } <nl> / / send session failure message <nl> if ( handler . isOutgoingConnected ( ) ) <nl> handler . sendMessage ( new SessionFailedMessage ( ) ) ;
NEAREST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / hadoop / ColumnFamilyRecordReader . java b / src / java / org / apache / cassandra / hadoop / ColumnFamilyRecordReader . java <nl> index fc90e5c . . 73f9786 100644 <nl> - - - a / src / java / org / apache / cassandra / hadoop / ColumnFamilyRecordReader . java <nl> + + + b / src / java / org / apache / cassandra / hadoop / ColumnFamilyRecordReader . java <nl> @ @ - 106 , 7 + 106 , 9 @ @ public class ColumnFamilyRecordReader extends RecordReader < ByteBuffer , SortedMap <nl> <nl> public float getProgress ( ) <nl> { <nl> - / / TODO this is totally broken for wide rows <nl> + if ( ! iter . hasNext ( ) ) <nl> + return 1 . 0F ; <nl> + <nl> / / the progress is likely to be reported slightly off the actual but close enough <nl> float progress = ( ( float ) iter . rowsRead ( ) / totalRowCount ) ; <nl> return progress > 1 . 0F ? 1 . 0F : progress ; <nl> @ @ - 423 , 6 + 425 , 7 @ @ public class ColumnFamilyRecordReader extends RecordReader < ByteBuffer , SortedMap <nl> { <nl> private PeekingIterator < Pair < ByteBuffer , SortedMap < ByteBuffer , IColumn > > > wideColumns ; <nl> private ByteBuffer lastColumn = ByteBufferUtil . EMPTY _ BYTE _ BUFFER ; <nl> + private ByteBuffer lastCountedKey = ByteBufferUtil . EMPTY _ BYTE _ BUFFER ; <nl> <nl> private void maybeInit ( ) <nl> { <nl> @ @ - 476 , 12 + 479 , 28 @ @ public class ColumnFamilyRecordReader extends RecordReader < ByteBuffer , SortedMap <nl> if ( rows = = null ) <nl> return endOfData ( ) ; <nl> <nl> - totalRead + + ; <nl> Pair < ByteBuffer , SortedMap < ByteBuffer , IColumn > > next = wideColumns . next ( ) ; <nl> lastColumn = next . right . values ( ) . iterator ( ) . next ( ) . name ( ) ; <nl> + <nl> + maybeCountRow ( next ) ; <nl> return next ; <nl> } <nl> <nl> + <nl> + / * * <nl> + * Increases the row counter only if we really moved to the next row . <nl> + * @ param next just fetched row slice <nl> + * / <nl> + private void maybeCountRow ( Pair < ByteBuffer , SortedMap < ByteBuffer , IColumn > > next ) <nl> + { <nl> + ByteBuffer currentKey = next . left ; <nl> + if ( ! currentKey . equals ( lastCountedKey ) ) <nl> + { <nl> + totalRead + + ; <nl> + lastCountedKey = currentKey ; <nl> + } <nl> + } <nl> + <nl> private class WideColumnIterator extends AbstractIterator < Pair < ByteBuffer , SortedMap < ByteBuffer , IColumn > > > <nl> { <nl> private final Iterator < KeySlice > rows ;

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index d914420 . . 8dfa02a 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 2 . 1 . 15 
 + * Set default streaming _ socket _ timeout _ in _ ms to 24 hours ( CASSANDRA - 11840 ) 
 * Do not consider local node a valid source during replace ( CASSANDRA - 11848 ) 
 * Avoid holding SSTableReaders for duration of incremental repair ( CASSANDRA - 11739 ) 
 * Add message dropped tasks to nodetool netstats ( CASSANDRA - 11855 ) 
 diff - - git a / conf / cassandra . yaml b / conf / cassandra . yaml 
 index 90c5be4 . . 7f2a6fa 100644 
 - - - a / conf / cassandra . yaml 
 + + + b / conf / cassandra . yaml 
 @ @ - 635 , 10 + 635 , 12 @ @ request _ timeout _ in _ ms : 10000 
 cross _ node _ timeout : false 
 
 # Set socket timeout for streaming operation . 
 - # The stream session is failed if no data is received by any of the 
 - # participants within that period . 
 - # Default value is 3600000 , which means streams timeout after an hour . 
 - # streaming _ socket _ timeout _ in _ ms : 3600000 
 + # The stream session is failed if no data / ack is received by any of the participants 
 + # within that period , which means this should also be sufficient to stream a large 
 + # sstable or rebuild table indexes . 
 + # Default value is 86400000ms , which means stale streams timeout after 24 hours . 
 + # A value of zero means stream sockets should never time out . 
 + # streaming _ socket _ timeout _ in _ ms : 86400000 
 
 # phi value that must be reached for a host to be marked down . 
 # most users should never need to adjust this . 
 diff - - git a / src / java / org / apache / cassandra / config / Config . java b / src / java / org / apache / cassandra / config / Config . java 
 index 9ff7096 . . 2c5e36a 100644 
 - - - a / src / java / org / apache / cassandra / config / Config . java 
 + + + b / src / java / org / apache / cassandra / config / Config . java 
 @ @ - 85 , 7 + 85 , 7 @ @ public class Config 
 
 public volatile Long truncate _ request _ timeout _ in _ ms = 60000L ; 
 
 - public Integer streaming _ socket _ timeout _ in _ ms = 3600000 ; 
 + public Integer streaming _ socket _ timeout _ in _ ms = 86400000 ; / / 24 hours 
 
 public boolean cross _ node _ timeout = false ; 
 
 diff - - git a / src / java / org / apache / cassandra / streaming / StreamSession . java b / src / java / org / apache / cassandra / streaming / StreamSession . java 
 index 642e837 . . 4eb8557 100644 
 - - - a / src / java / org / apache / cassandra / streaming / StreamSession . java 
 + + + b / src / java / org / apache / cassandra / streaming / StreamSession . java 
 @ @ - 20 , 6 + 20 , 7 @ @ package org . apache . cassandra . streaming ; 
 import java . io . IOException ; 
 import java . net . InetAddress ; 
 import java . net . Socket ; 
 + import java . net . SocketTimeoutException ; 
 import java . util . * ; 
 import java . util . concurrent . * ; 
 import java . util . concurrent . atomic . AtomicBoolean ; 
 @ @ - 502 , 7 + 503 , 17 @ @ public class StreamSession implements IEndpointStateChangeSubscriber 
 * / 
 public void onError ( Throwable e ) 
 { 
 - logger . error ( " [ Stream # { } ] Streaming error occurred " , planId ( ) , e ) ; 
 + if ( e instanceof SocketTimeoutException ) 
 + { 
 + logger . error ( " [ Stream # { } ] Streaming socket timed out . This means the session peer stopped responding or " + 
 + " is still processing received data . If there is no sign of failure in the other end or a very " + 
 + " dense table is being transferred you may want to increase streaming _ socket _ timeout _ in _ ms " + 
 + " property . Current value is { } ms . " , planId ( ) , DatabaseDescriptor . getStreamingSocketTimeout ( ) , e ) ; 
 + } 
 + else 
 + { 
 + logger . error ( " [ Stream # { } ] Streaming error occurred " , planId ( ) , e ) ; 
 + } 
 / / send session failure message 
 if ( handler . isOutgoingConnected ( ) ) 
 handler . sendMessage ( new SessionFailedMessage ( ) ) ;

NEAREST DIFF:
diff - - git a / src / java / org / apache / cassandra / hadoop / ColumnFamilyRecordReader . java b / src / java / org / apache / cassandra / hadoop / ColumnFamilyRecordReader . java 
 index fc90e5c . . 73f9786 100644 
 - - - a / src / java / org / apache / cassandra / hadoop / ColumnFamilyRecordReader . java 
 + + + b / src / java / org / apache / cassandra / hadoop / ColumnFamilyRecordReader . java 
 @ @ - 106 , 7 + 106 , 9 @ @ public class ColumnFamilyRecordReader extends RecordReader < ByteBuffer , SortedMap 
 
 public float getProgress ( ) 
 { 
 - / / TODO this is totally broken for wide rows 
 + if ( ! iter . hasNext ( ) ) 
 + return 1 . 0F ; 
 + 
 / / the progress is likely to be reported slightly off the actual but close enough 
 float progress = ( ( float ) iter . rowsRead ( ) / totalRowCount ) ; 
 return progress > 1 . 0F ? 1 . 0F : progress ; 
 @ @ - 423 , 6 + 425 , 7 @ @ public class ColumnFamilyRecordReader extends RecordReader < ByteBuffer , SortedMap 
 { 
 private PeekingIterator < Pair < ByteBuffer , SortedMap < ByteBuffer , IColumn > > > wideColumns ; 
 private ByteBuffer lastColumn = ByteBufferUtil . EMPTY _ BYTE _ BUFFER ; 
 + private ByteBuffer lastCountedKey = ByteBufferUtil . EMPTY _ BYTE _ BUFFER ; 
 
 private void maybeInit ( ) 
 { 
 @ @ - 476 , 12 + 479 , 28 @ @ public class ColumnFamilyRecordReader extends RecordReader < ByteBuffer , SortedMap 
 if ( rows = = null ) 
 return endOfData ( ) ; 
 
 - totalRead + + ; 
 Pair < ByteBuffer , SortedMap < ByteBuffer , IColumn > > next = wideColumns . next ( ) ; 
 lastColumn = next . right . values ( ) . iterator ( ) . next ( ) . name ( ) ; 
 + 
 + maybeCountRow ( next ) ; 
 return next ; 
 } 
 
 + 
 + / * * 
 + * Increases the row counter only if we really moved to the next row . 
 + * @ param next just fetched row slice 
 + * / 
 + private void maybeCountRow ( Pair < ByteBuffer , SortedMap < ByteBuffer , IColumn > > next ) 
 + { 
 + ByteBuffer currentKey = next . left ; 
 + if ( ! currentKey . equals ( lastCountedKey ) ) 
 + { 
 + totalRead + + ; 
 + lastCountedKey = currentKey ; 
 + } 
 + } 
 + 
 private class WideColumnIterator extends AbstractIterator < Pair < ByteBuffer , SortedMap < ByteBuffer , IColumn > > > 
 { 
 private final Iterator < KeySlice > rows ;
