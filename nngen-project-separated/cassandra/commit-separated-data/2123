BLEU SCORE: 0.037477767366779206

TEST MSG: don ' t call getCompactions thru the proxy twice for compactionstats
GENERATED MSG: add time remaining estimate to nodetool compactionstats

TEST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / tools / NodeTool . java b / src / java / org / apache / cassandra / tools / NodeTool . java <nl> index 08a8055 . . fbdce0f 100644 <nl> - - - a / src / java / org / apache / cassandra / tools / NodeTool . java <nl> + + + b / src / java / org / apache / cassandra / tools / NodeTool . java <nl> @ @ - 1175 , 13 + 1175 , 14 @ @ public class NodeTool <nl> CompactionManagerMBean cm = probe . getCompactionManagerProxy ( ) ; <nl> System . out . println ( " pending tasks : " + probe . getCompactionMetric ( " PendingTasks " ) ) ; <nl> long remainingBytes = 0 ; <nl> - if ( cm . getCompactions ( ) . size ( ) > 0 ) <nl> + List < Map < String , String > > compactions = cm . getCompactions ( ) ; <nl> + if ( ! compactions . isEmpty ( ) ) <nl> { <nl> List < String [ ] > lines = new ArrayList < > ( ) ; <nl> int [ ] columnSizes = new int [ ] { 0 , 0 , 0 , 0 , 0 , 0 , 0 } ; <nl> <nl> addLine ( lines , columnSizes , " compaction type " , " keyspace " , " table " , " completed " , " total " , " unit " , " progress " ) ; <nl> - for ( Map < String , String > c : cm . getCompactions ( ) ) <nl> + for ( Map < String , String > c : compactions ) <nl> { <nl> long total = Long . parseLong ( c . get ( " total " ) ) ; <nl> long completed = Long . parseLong ( c . get ( " completed " ) ) ;
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 5c140ea . . 21cacb3 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 23 , 6 + 23 , 7 @ @ Merged from 1 . 0 : <nl> * avoid streaming empty files with bulk loader if sstablewriter errors out <nl> ( CASSANDRA - 3946 ) <nl> * fix stress build ( CASSANDRA - 4140 ) <nl> + * add time remaining estimate to nodetool compactionstats ( CASSANDRA - 4167 ) <nl> <nl> <nl> 1 . 1 - rc1 <nl> diff - - git a / src / java / org / apache / cassandra / tools / NodeCmd . java b / src / java / org / apache / cassandra / tools / NodeCmd . java <nl> index 346ee3b . . 14c2427 100644 <nl> - - - a / src / java / org / apache / cassandra / tools / NodeCmd . java <nl> + + + b / src / java / org / apache / cassandra / tools / NodeCmd . java <nl> @ @ - 38 , 6 + 38 , 7 @ @ import org . apache . cassandra . concurrent . JMXEnabledThreadPoolExecutorMBean ; <nl> import org . apache . cassandra . config . ConfigurationException ; <nl> import org . apache . cassandra . db . ColumnFamilyStoreMBean ; <nl> import org . apache . cassandra . db . compaction . CompactionManagerMBean ; <nl> + import org . apache . cassandra . db . compaction . OperationType ; <nl> import org . apache . cassandra . net . MessagingServiceMBean ; <nl> import org . apache . cassandra . thrift . InvalidRequestException ; <nl> import org . apache . cassandra . utils . EstimatedHistogram ; <nl> @ @ - 450 , 17 + 451 , 29 @ @ public class NodeCmd <nl> <nl> public void printCompactionStats ( PrintStream outs ) <nl> { <nl> + 	 int compactionThroughput = probe . getCompactionThroughput ( ) ; <nl> CompactionManagerMBean cm = probe . getCompactionManagerProxy ( ) ; <nl> outs . println ( " pending tasks : " + cm . getPendingTasks ( ) ) ; <nl> if ( cm . getCompactions ( ) . size ( ) > 0 ) <nl> outs . printf ( " % 25s % 16s % 16s % 16s % 16s % 10s % n " , " compaction type " , " keyspace " , " column family " , " bytes compacted " , " bytes total " , " progress " ) ; <nl> + long remainingBytes = 0 ; <nl> for ( Map < String , String > c : cm . getCompactions ( ) ) <nl> { <nl> String percentComplete = new Long ( c . get ( " totalBytes " ) ) = = 0 <nl> ? " n / a " <nl> : new DecimalFormat ( " 0 . 00 " ) . format ( ( double ) new Long ( c . get ( " bytesComplete " ) ) / new Long ( c . get ( " totalBytes " ) ) * 100 ) + " % " ; <nl> outs . printf ( " % 25s % 16s % 16s % 16s % 16s % 10s % n " , c . get ( " taskType " ) , c . get ( " keyspace " ) , c . get ( " columnfamily " ) , c . get ( " bytesComplete " ) , c . get ( " totalBytes " ) , percentComplete ) ; <nl> + if ( c . get ( " taskType " ) . equals ( OperationType . COMPACTION . toString ( ) ) ) <nl> + remainingBytes + = ( new Long ( c . get ( " totalBytes " ) ) - new Long ( c . get ( " bytesComplete " ) ) ) ; <nl> } <nl> + long remainingTimeInSecs = compactionThroughput = = 0 | | remainingBytes = = 0 <nl> + ? - 1 <nl> + : ( remainingBytes ) / ( long ) ( 1024L * 1024L * compactionThroughput ) ; <nl> + String remainingTime = remainingTimeInSecs < 0 <nl> + ? " n / a " <nl> + : String . format ( " % dh % 02dm % 02ds " , remainingTimeInSecs / 3600 , ( remainingTimeInSecs % 3600 ) / 60 , ( remainingTimeInSecs % 60 ) ) ; <nl> + <nl> + outs . printf ( " % 25s % 10s % n " , " Active compaction remaining time : " , remainingTime ) ; <nl> } <nl> <nl> public void printColumnFamilyStats ( PrintStream outs ) <nl> diff - - git a / src / java / org / apache / cassandra / tools / NodeProbe . java b / src / java / org / apache / cassandra / tools / NodeProbe . java <nl> index 077a8b4 . . 1d74a6b 100644 <nl> - - - a / src / java / org / apache / cassandra / tools / NodeProbe . java <nl> + + + b / src / java / org / apache / cassandra / tools / NodeProbe . java <nl> @ @ - 629 , 6 + 629 , 11 @ @ public class NodeProbe <nl> ssProxy . setCompactionThroughputMbPerSec ( value ) ; <nl> } <nl> <nl> + public int getCompactionThroughput ( ) <nl> + { <nl> + return ssProxy . getCompactionThroughputMbPerSec ( ) ; <nl> + } <nl> + <nl> public int getExceptionCount ( ) <nl> { <nl> return ssProxy . getExceptionCount ( ) ; <nl> diff - - git a / tools / bin / stress b / tools / bin / stress <nl> old mode 100644 <nl> new mode 100755 <nl> diff - - git a / tools / bin / stress . bat b / tools / bin / stress . bat <nl> old mode 100644 <nl> new mode 100755 <nl> diff - - git a / tools / bin / stressd b / tools / bin / stressd <nl> old mode 100644 <nl> new mode 100755

TEST DIFF:
diff - - git a / src / java / org / apache / cassandra / tools / NodeTool . java b / src / java / org / apache / cassandra / tools / NodeTool . java 
 index 08a8055 . . fbdce0f 100644 
 - - - a / src / java / org / apache / cassandra / tools / NodeTool . java 
 + + + b / src / java / org / apache / cassandra / tools / NodeTool . java 
 @ @ - 1175 , 13 + 1175 , 14 @ @ public class NodeTool 
 CompactionManagerMBean cm = probe . getCompactionManagerProxy ( ) ; 
 System . out . println ( " pending tasks : " + probe . getCompactionMetric ( " PendingTasks " ) ) ; 
 long remainingBytes = 0 ; 
 - if ( cm . getCompactions ( ) . size ( ) > 0 ) 
 + List < Map < String , String > > compactions = cm . getCompactions ( ) ; 
 + if ( ! compactions . isEmpty ( ) ) 
 { 
 List < String [ ] > lines = new ArrayList < > ( ) ; 
 int [ ] columnSizes = new int [ ] { 0 , 0 , 0 , 0 , 0 , 0 , 0 } ; 
 
 addLine ( lines , columnSizes , " compaction type " , " keyspace " , " table " , " completed " , " total " , " unit " , " progress " ) ; 
 - for ( Map < String , String > c : cm . getCompactions ( ) ) 
 + for ( Map < String , String > c : compactions ) 
 { 
 long total = Long . parseLong ( c . get ( " total " ) ) ; 
 long completed = Long . parseLong ( c . get ( " completed " ) ) ;

NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 5c140ea . . 21cacb3 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 23 , 6 + 23 , 7 @ @ Merged from 1 . 0 : 
 * avoid streaming empty files with bulk loader if sstablewriter errors out 
 ( CASSANDRA - 3946 ) 
 * fix stress build ( CASSANDRA - 4140 ) 
 + * add time remaining estimate to nodetool compactionstats ( CASSANDRA - 4167 ) 
 
 
 1 . 1 - rc1 
 diff - - git a / src / java / org / apache / cassandra / tools / NodeCmd . java b / src / java / org / apache / cassandra / tools / NodeCmd . java 
 index 346ee3b . . 14c2427 100644 
 - - - a / src / java / org / apache / cassandra / tools / NodeCmd . java 
 + + + b / src / java / org / apache / cassandra / tools / NodeCmd . java 
 @ @ - 38 , 6 + 38 , 7 @ @ import org . apache . cassandra . concurrent . JMXEnabledThreadPoolExecutorMBean ; 
 import org . apache . cassandra . config . ConfigurationException ; 
 import org . apache . cassandra . db . ColumnFamilyStoreMBean ; 
 import org . apache . cassandra . db . compaction . CompactionManagerMBean ; 
 + import org . apache . cassandra . db . compaction . OperationType ; 
 import org . apache . cassandra . net . MessagingServiceMBean ; 
 import org . apache . cassandra . thrift . InvalidRequestException ; 
 import org . apache . cassandra . utils . EstimatedHistogram ; 
 @ @ - 450 , 17 + 451 , 29 @ @ public class NodeCmd 
 
 public void printCompactionStats ( PrintStream outs ) 
 { 
 + 	 int compactionThroughput = probe . getCompactionThroughput ( ) ; 
 CompactionManagerMBean cm = probe . getCompactionManagerProxy ( ) ; 
 outs . println ( " pending tasks : " + cm . getPendingTasks ( ) ) ; 
 if ( cm . getCompactions ( ) . size ( ) > 0 ) 
 outs . printf ( " % 25s % 16s % 16s % 16s % 16s % 10s % n " , " compaction type " , " keyspace " , " column family " , " bytes compacted " , " bytes total " , " progress " ) ; 
 + long remainingBytes = 0 ; 
 for ( Map < String , String > c : cm . getCompactions ( ) ) 
 { 
 String percentComplete = new Long ( c . get ( " totalBytes " ) ) = = 0 
 ? " n / a " 
 : new DecimalFormat ( " 0 . 00 " ) . format ( ( double ) new Long ( c . get ( " bytesComplete " ) ) / new Long ( c . get ( " totalBytes " ) ) * 100 ) + " % " ; 
 outs . printf ( " % 25s % 16s % 16s % 16s % 16s % 10s % n " , c . get ( " taskType " ) , c . get ( " keyspace " ) , c . get ( " columnfamily " ) , c . get ( " bytesComplete " ) , c . get ( " totalBytes " ) , percentComplete ) ; 
 + if ( c . get ( " taskType " ) . equals ( OperationType . COMPACTION . toString ( ) ) ) 
 + remainingBytes + = ( new Long ( c . get ( " totalBytes " ) ) - new Long ( c . get ( " bytesComplete " ) ) ) ; 
 } 
 + long remainingTimeInSecs = compactionThroughput = = 0 | | remainingBytes = = 0 
 + ? - 1 
 + : ( remainingBytes ) / ( long ) ( 1024L * 1024L * compactionThroughput ) ; 
 + String remainingTime = remainingTimeInSecs < 0 
 + ? " n / a " 
 + : String . format ( " % dh % 02dm % 02ds " , remainingTimeInSecs / 3600 , ( remainingTimeInSecs % 3600 ) / 60 , ( remainingTimeInSecs % 60 ) ) ; 
 + 
 + outs . printf ( " % 25s % 10s % n " , " Active compaction remaining time : " , remainingTime ) ; 
 } 
 
 public void printColumnFamilyStats ( PrintStream outs ) 
 diff - - git a / src / java / org / apache / cassandra / tools / NodeProbe . java b / src / java / org / apache / cassandra / tools / NodeProbe . java 
 index 077a8b4 . . 1d74a6b 100644 
 - - - a / src / java / org / apache / cassandra / tools / NodeProbe . java 
 + + + b / src / java / org / apache / cassandra / tools / NodeProbe . java 
 @ @ - 629 , 6 + 629 , 11 @ @ public class NodeProbe 
 ssProxy . setCompactionThroughputMbPerSec ( value ) ; 
 } 
 
 + public int getCompactionThroughput ( ) 
 + { 
 + return ssProxy . getCompactionThroughputMbPerSec ( ) ; 
 + } 
 + 
 public int getExceptionCount ( ) 
 { 
 return ssProxy . getExceptionCount ( ) ; 
 diff - - git a / tools / bin / stress b / tools / bin / stress 
 old mode 100644 
 new mode 100755 
 diff - - git a / tools / bin / stress . bat b / tools / bin / stress . bat 
 old mode 100644 
 new mode 100755 
 diff - - git a / tools / bin / stressd b / tools / bin / stressd 
 old mode 100644 
 new mode 100755
