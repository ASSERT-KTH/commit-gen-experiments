BLEU SCORE: 0.040488925321331

TEST MSG: Counters fail to increment in 2 . 1 / 2 . 2 to 3 . X mixed version clusters
GENERATED MSG: Fix pre - 3 . 0 counter mutation serialization

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 025d4b0 . . 063e8fb 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 3 . 0 . 18 <nl> + * Counters fail to increment in 2 . 1 / 2 . 2 to 3 . X mixed version clusters ( CASSANDRA - 14958 ) <nl> * Streaming needs to synchronise access to LifecycleTransaction ( CASSANDRA - 14554 ) <nl> * Fix cassandra - stress write hang with default options ( CASSANDRA - 14616 ) <nl> * Differentiate between slices and RTs when decoding legacy bounds ( CASSANDRA - 14919 ) <nl> diff - - git a / src / java / org / apache / cassandra / db / LegacyLayout . java b / src / java / org / apache / cassandra / db / LegacyLayout . java <nl> index 9600355 . . 0044959 100644 <nl> - - - a / src / java / org / apache / cassandra / db / LegacyLayout . java <nl> + + + b / src / java / org / apache / cassandra / db / LegacyLayout . java <nl> @ @ - 514 , 7 + 514 , 7 @ @ public abstract class LegacyLayout <nl> else if ( cell . isCounterUpdate ( ) ) <nl> { <nl> out . writeLong ( cell . timestamp ) ; <nl> - long count = CounterContext . instance ( ) . getLocalCount ( cell . value ) ; <nl> + long count = CounterContext . instance ( ) . getUpdateCount ( cell . value ) ; <nl> ByteBufferUtil . writeWithLength ( ByteBufferUtil . bytes ( count ) , out ) ; <nl> continue ; <nl> } <nl> @ @ - 585 , 7 + 585 , 7 @ @ public abstract class LegacyLayout <nl> else if ( cell . isCounterUpdate ( ) ) <nl> { <nl> size + = TypeSizes . sizeof ( cell . timestamp ) ; <nl> - long count = CounterContext . instance ( ) . getLocalCount ( cell . value ) ; <nl> + long count = CounterContext . instance ( ) . getUpdateCount ( cell . value ) ; <nl> size + = ByteBufferUtil . serializedSizeWithLength ( ByteBufferUtil . bytes ( count ) ) ; <nl> continue ; <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / db / context / CounterContext . java b / src / java / org / apache / cassandra / db / context / CounterContext . java <nl> index b402464 . . d0952d0 100644 <nl> - - - a / src / java / org / apache / cassandra / db / context / CounterContext . java <nl> + + + b / src / java / org / apache / cassandra / db / context / CounterContext . java <nl> @ @ - 137 , 6 + 137 , 14 @ @ public class CounterContext <nl> } <nl> <nl> / * * <nl> + * Returns the count associated with the update counter id , or 0 if no such shard is present . <nl> + * / <nl> + public long getUpdateCount ( ByteBuffer context ) <nl> + { <nl> + return getClockAndCountOf ( context , UPDATE _ CLOCK _ ID ) . count ; <nl> + } <nl> + <nl> + / * * <nl> * Creates a counter context with a single global , 2 . 1 + shard ( a result of increment ) . <nl> * / <nl> public ByteBuffer createGlobal ( CounterId id , long clock , long count ) <nl> @ @ - 709 , 14 + 717 , 6 @ @ public class CounterContext <nl> } <nl> <nl> / * * <nl> - * Returns the count associated with the local counter id , or 0 if no such shard is present . <nl> - * / <nl> - public long getLocalCount ( ByteBuffer context ) <nl> - { <nl> - return getLocalClockAndCount ( context ) . count ; <nl> - } <nl> - <nl> - / * * <nl> * Returns the clock and the count associated with the given counter id , or ( 0 , 0 ) if no such shard is present . <nl> * / <nl> @ VisibleForTesting
NEAREST DIFF (one line): ELIMINATEDSENTENCE

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 025d4b0 . . 063e8fb 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 3 . 0 . 18 
 + * Counters fail to increment in 2 . 1 / 2 . 2 to 3 . X mixed version clusters ( CASSANDRA - 14958 ) 
 * Streaming needs to synchronise access to LifecycleTransaction ( CASSANDRA - 14554 ) 
 * Fix cassandra - stress write hang with default options ( CASSANDRA - 14616 ) 
 * Differentiate between slices and RTs when decoding legacy bounds ( CASSANDRA - 14919 ) 
 diff - - git a / src / java / org / apache / cassandra / db / LegacyLayout . java b / src / java / org / apache / cassandra / db / LegacyLayout . java 
 index 9600355 . . 0044959 100644 
 - - - a / src / java / org / apache / cassandra / db / LegacyLayout . java 
 + + + b / src / java / org / apache / cassandra / db / LegacyLayout . java 
 @ @ - 514 , 7 + 514 , 7 @ @ public abstract class LegacyLayout 
 else if ( cell . isCounterUpdate ( ) ) 
 { 
 out . writeLong ( cell . timestamp ) ; 
 - long count = CounterContext . instance ( ) . getLocalCount ( cell . value ) ; 
 + long count = CounterContext . instance ( ) . getUpdateCount ( cell . value ) ; 
 ByteBufferUtil . writeWithLength ( ByteBufferUtil . bytes ( count ) , out ) ; 
 continue ; 
 } 
 @ @ - 585 , 7 + 585 , 7 @ @ public abstract class LegacyLayout 
 else if ( cell . isCounterUpdate ( ) ) 
 { 
 size + = TypeSizes . sizeof ( cell . timestamp ) ; 
 - long count = CounterContext . instance ( ) . getLocalCount ( cell . value ) ; 
 + long count = CounterContext . instance ( ) . getUpdateCount ( cell . value ) ; 
 size + = ByteBufferUtil . serializedSizeWithLength ( ByteBufferUtil . bytes ( count ) ) ; 
 continue ; 
 } 
 diff - - git a / src / java / org / apache / cassandra / db / context / CounterContext . java b / src / java / org / apache / cassandra / db / context / CounterContext . java 
 index b402464 . . d0952d0 100644 
 - - - a / src / java / org / apache / cassandra / db / context / CounterContext . java 
 + + + b / src / java / org / apache / cassandra / db / context / CounterContext . java 
 @ @ - 137 , 6 + 137 , 14 @ @ public class CounterContext 
 } 
 
 / * * 
 + * Returns the count associated with the update counter id , or 0 if no such shard is present . 
 + * / 
 + public long getUpdateCount ( ByteBuffer context ) 
 + { 
 + return getClockAndCountOf ( context , UPDATE _ CLOCK _ ID ) . count ; 
 + } 
 + 
 + / * * 
 * Creates a counter context with a single global , 2 . 1 + shard ( a result of increment ) . 
 * / 
 public ByteBuffer createGlobal ( CounterId id , long clock , long count ) 
 @ @ - 709 , 14 + 717 , 6 @ @ public class CounterContext 
 } 
 
 / * * 
 - * Returns the count associated with the local counter id , or 0 if no such shard is present . 
 - * / 
 - public long getLocalCount ( ByteBuffer context ) 
 - { 
 - return getLocalClockAndCount ( context ) . count ; 
 - } 
 - 
 - / * * 
 * Returns the clock and the count associated with the given counter id , or ( 0 , 0 ) if no such shard is present . 
 * / 
 @ VisibleForTesting

NEAREST DIFF:
ELIMINATEDSENTENCE
