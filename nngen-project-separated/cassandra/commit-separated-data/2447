BLEU SCORE: 0.040583489434387374

TEST MSG: Invalidate key cache on table drop
GENERATED MSG: merge from 1 . 1

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index bd0031e . . 432d688 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 47 , 6 + 47 , 7 @ @ <nl> * Proper null handle for IF with map element access ( CASSANDRA - 7155 ) <nl> * Improve compaction visibility ( CASSANDRA - 7242 ) <nl> * Fix 2ndary index queries with DESC clustering order ( CASSANDRA - 6950 ) <nl> + * Invalid key cache entries on DROP ( CASSANDRA - 6525 ) <nl> Merged from 1 . 2 : <nl> * Add Cloudstack snitch ( CASSANDRA - 7147 ) <nl> * Update system . peers correctly when relocating tokens ( CASSANDRA - 7126 ) <nl> diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> index 3fac640 . . 709935a 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> @ @ - 37 , 6 + 37 , 7 @ @ import org . cliffc . high _ scale _ lib . NonBlockingHashMap ; <nl> import org . slf4j . Logger ; <nl> import org . slf4j . LoggerFactory ; <nl> <nl> + import org . apache . cassandra . cache . KeyCacheKey ; <nl> import org . apache . cassandra . cache . IRowCacheEntry ; <nl> import org . apache . cassandra . cache . RowCacheKey ; <nl> import org . apache . cassandra . cache . RowCacheSentinel ; <nl> @ @ - 339 , 6 + 340 , 11 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean <nl> for ( RowCacheKey key : CacheService . instance . rowCache . getKeySet ( ) ) <nl> if ( key . cfId = = metadata . cfId ) <nl> invalidateCachedRow ( key ) ; <nl> + <nl> + String ksname = keyspace . getName ( ) ; <nl> + for ( KeyCacheKey key : CacheService . instance . keyCache . getKeySet ( ) ) <nl> + if ( key . getPathInfo ( ) . left . equals ( ksname ) & & key . getPathInfo ( ) . right . equals ( name ) ) <nl> + CacheService . instance . keyCache . remove ( key ) ; <nl> } <nl> <nl> / * *
NEAREST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / db / HintedHandOffManager . java b / src / java / org / apache / cassandra / db / HintedHandOffManager . java <nl> index a83fbab . . e2dc046 100644 <nl> - - - a / src / java / org / apache / cassandra / db / HintedHandOffManager . java <nl> + + + b / src / java / org / apache / cassandra / db / HintedHandOffManager . java <nl> @ @ - 391 , 7 + 391 , 9 @ @ public class HintedHandOffManager implements HintedHandOffManagerMBean <nl> { <nl> Token < ? > token = StorageService . getPartitioner ( ) . getTokenFactory ( ) . fromByteArray ( row . key . key ) ; <nl> InetAddress target = StorageService . instance . getTokenMetadata ( ) . getEndpoint ( token ) ; <nl> - scheduleHintDelivery ( target ) ; <nl> + / / token may have since been removed ( in which case we have just read back a tombstone ) <nl> + if ( target ! = null ) <nl> + scheduleHintDelivery ( target ) ; <nl> } <nl> <nl> if ( logger _ . isDebugEnabled ( ) )

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index bd0031e . . 432d688 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 47 , 6 + 47 , 7 @ @ 
 * Proper null handle for IF with map element access ( CASSANDRA - 7155 ) 
 * Improve compaction visibility ( CASSANDRA - 7242 ) 
 * Fix 2ndary index queries with DESC clustering order ( CASSANDRA - 6950 ) 
 + * Invalid key cache entries on DROP ( CASSANDRA - 6525 ) 
 Merged from 1 . 2 : 
 * Add Cloudstack snitch ( CASSANDRA - 7147 ) 
 * Update system . peers correctly when relocating tokens ( CASSANDRA - 7126 ) 
 diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 index 3fac640 . . 709935a 100644 
 - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 @ @ - 37 , 6 + 37 , 7 @ @ import org . cliffc . high _ scale _ lib . NonBlockingHashMap ; 
 import org . slf4j . Logger ; 
 import org . slf4j . LoggerFactory ; 
 
 + import org . apache . cassandra . cache . KeyCacheKey ; 
 import org . apache . cassandra . cache . IRowCacheEntry ; 
 import org . apache . cassandra . cache . RowCacheKey ; 
 import org . apache . cassandra . cache . RowCacheSentinel ; 
 @ @ - 339 , 6 + 340 , 11 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean 
 for ( RowCacheKey key : CacheService . instance . rowCache . getKeySet ( ) ) 
 if ( key . cfId = = metadata . cfId ) 
 invalidateCachedRow ( key ) ; 
 + 
 + String ksname = keyspace . getName ( ) ; 
 + for ( KeyCacheKey key : CacheService . instance . keyCache . getKeySet ( ) ) 
 + if ( key . getPathInfo ( ) . left . equals ( ksname ) & & key . getPathInfo ( ) . right . equals ( name ) ) 
 + CacheService . instance . keyCache . remove ( key ) ; 
 } 
 
 / * *

NEAREST DIFF:
diff - - git a / src / java / org / apache / cassandra / db / HintedHandOffManager . java b / src / java / org / apache / cassandra / db / HintedHandOffManager . java 
 index a83fbab . . e2dc046 100644 
 - - - a / src / java / org / apache / cassandra / db / HintedHandOffManager . java 
 + + + b / src / java / org / apache / cassandra / db / HintedHandOffManager . java 
 @ @ - 391 , 7 + 391 , 9 @ @ public class HintedHandOffManager implements HintedHandOffManagerMBean 
 { 
 Token < ? > token = StorageService . getPartitioner ( ) . getTokenFactory ( ) . fromByteArray ( row . key . key ) ; 
 InetAddress target = StorageService . instance . getTokenMetadata ( ) . getEndpoint ( token ) ; 
 - scheduleHintDelivery ( target ) ; 
 + / / token may have since been removed ( in which case we have just read back a tombstone ) 
 + if ( target ! = null ) 
 + scheduleHintDelivery ( target ) ; 
 } 
 
 if ( logger _ . isDebugEnabled ( ) )
