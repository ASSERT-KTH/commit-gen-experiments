BLEU SCORE: 0.03217409328795944

TEST MSG: Fix deprecated repair JMX API
GENERATED MSG: Fix bug preventing the use of efficient cross - DC writes

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 3163351 . . 72da59f 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 6 + 1 , 7 @ @ <nl> 2 . 2 <nl> * Add functions to convert timeuuid to date or time , deprecate dateOf and unixTimestampOf ( CASSANDRA - 9229 ) <nl> * Make sure we cancel non - compacting sstables from LifecycleTransaction ( CASSANDRA - 9566 ) <nl> + * Fix deprecated repair JMX API ( CASSANDRA - 9570 ) <nl> <nl> <nl> 2 . 2 . 0 - rc1 <nl> diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java <nl> index e059348 . . 2dd56b5 100644 <nl> - - - a / src / java / org / apache / cassandra / service / StorageService . java <nl> + + + b / src / java / org / apache / cassandra / service / StorageService . java <nl> @ @ - 2807 , 6 + 2807 , 21 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE <nl> { <nl> options . getHosts ( ) . addAll ( hosts ) ; <nl> } <nl> + if ( primaryRange ) <nl> + { <nl> + / / when repairing only primary range , neither dataCenters nor hosts can be set <nl> + if ( options . getDataCenters ( ) . isEmpty ( ) & & options . getHosts ( ) . isEmpty ( ) ) <nl> + options . getRanges ( ) . addAll ( getPrimaryRanges ( keyspace ) ) ; <nl> + / / except dataCenters only contain local DC ( i . e . - local ) <nl> + else if ( options . getDataCenters ( ) . size ( ) = = 1 & & options . getDataCenters ( ) . contains ( DatabaseDescriptor . getLocalDataCenter ( ) ) ) <nl> + options . getRanges ( ) . addAll ( getPrimaryRangesWithinDC ( keyspace ) ) ; <nl> + else <nl> + throw new IllegalArgumentException ( " You need to run primary range repair on all nodes in the cluster . " ) ; <nl> + } <nl> + else <nl> + { <nl> + options . getRanges ( ) . addAll ( getLocalRanges ( keyspace ) ) ; <nl> + } <nl> if ( columnFamilies ! = null ) <nl> { <nl> for ( String columnFamily : columnFamilies )
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 9c38702 . . 90c1650 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 10 , 6 + 10 , 7 @ @ Merged from 0 . 8 : <nl> * fix displaying cfdef entries for super columnfamilies ( CASSANDRA - 3415 ) <nl> * Make counter shard merging thread safe ( CASSANDRA - 3178 ) <nl> * Revert CASSANDRA - 2855 <nl> + * Fix bug preventing the use of efficient cross - DC writes ( CASSANDRA - 3472 ) <nl> <nl> 1 . 0 . 2 <nl> * " defragment " rows for name - based queries under STCS ( CASSANDRA - 2503 ) <nl> diff - - git a / src / java / org / apache / cassandra / service / StorageProxy . java b / src / java / org / apache / cassandra / service / StorageProxy . java <nl> index 82eb3bd . . ce22cbf 100644 <nl> - - - a / src / java / org / apache / cassandra / service / StorageProxy . java <nl> + + + b / src / java / org / apache / cassandra / service / StorageProxy . java <nl> @ @ - 393 , 7 + 393 , 7 @ @ public class StorageProxy implements StorageProxyMBean <nl> / / from previous loop iterations <nl> message . removeHeader ( RowMutation . FORWARD _ HEADER ) ; <nl> <nl> - if ( dataCenter . equals ( localDataCenter ) | | StorageService . instance . useEfficientCrossDCWrites ( ) ) <nl> + if ( dataCenter . equals ( localDataCenter ) ) <nl> { <nl> / / direct writes to local DC or old Cassadra versions <nl> for ( InetAddress destination : messages . getValue ( ) ) <nl> diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java <nl> index d040723 . . 0da6824 100644 <nl> - - - a / src / java / org / apache / cassandra / service / StorageService . java <nl> + + + b / src / java / org / apache / cassandra / service / StorageService . java <nl> @ @ - 205 , 7 + 205 , 6 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe <nl> private static enum Mode { NORMAL , CLIENT , JOINING , LEAVING , DECOMMISSIONED , MOVING , DRAINING , DRAINED } <nl> private Mode operationMode ; <nl> <nl> - private volatile boolean efficientCrossDCWrites ; <nl> private MigrationManager migrationManager = new MigrationManager ( ) ; <nl> <nl> / * Used for tracking drain progress * / <nl> @ @ - 798 , 9 + 797 , 6 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe <nl> { <nl> switch ( state ) <nl> { <nl> - case RELEASE _ VERSION : <nl> - updateEfficientCrossDCWriteMode ( ) ; <nl> - break ; <nl> case STATUS : <nl> String apStateValue = value . value ; <nl> String [ ] pieces = apStateValue . split ( VersionedValue . DELIMITER _ STR , - 1 ) ; <nl> @ @ - 824 , 25 + 820 , 6 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe <nl> } <nl> <nl> / * * <nl> - * We can remove this in 0 . 8 , since mixing 0 . 7 . 0 with 0 . 8 is not supported ( 0 . 7 . 1 is required ) <nl> - * / <nl> - private void updateEfficientCrossDCWriteMode ( ) <nl> - { <nl> - for ( Map . Entry < InetAddress , EndpointState > entry : Gossiper . instance . getEndpointStates ( ) ) <nl> - { <nl> - VersionedValue version = entry . getValue ( ) . getApplicationState ( ApplicationState . RELEASE _ VERSION ) ; <nl> - <nl> - / / no version means it ' s old code that doesn ' t gossip version , < 0 . 7 . 1 . <nl> - if ( version = = null ) <nl> - { <nl> - efficientCrossDCWrites = false ; <nl> - return ; <nl> - } <nl> - } <nl> - efficientCrossDCWrites = true ; <nl> - } <nl> - <nl> - / * * <nl> * Handle node bootstrap <nl> * <nl> * @ param endpoint bootstrapping node <nl> @ @ - 2509 , 11 + 2486 , 6 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe <nl> ( ( DynamicEndpointSnitch ) oldSnitch ) . unregisterMBean ( ) ; <nl> } <nl> <nl> - public boolean useEfficientCrossDCWrites ( ) <nl> - { <nl> - return efficientCrossDCWrites ; <nl> - } <nl> - <nl> / * * <nl> * Flushes the two largest memtables by ops and by throughput <nl> * /

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 3163351 . . 72da59f 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 6 + 1 , 7 @ @ 
 2 . 2 
 * Add functions to convert timeuuid to date or time , deprecate dateOf and unixTimestampOf ( CASSANDRA - 9229 ) 
 * Make sure we cancel non - compacting sstables from LifecycleTransaction ( CASSANDRA - 9566 ) 
 + * Fix deprecated repair JMX API ( CASSANDRA - 9570 ) 
 
 
 2 . 2 . 0 - rc1 
 diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java 
 index e059348 . . 2dd56b5 100644 
 - - - a / src / java / org / apache / cassandra / service / StorageService . java 
 + + + b / src / java / org / apache / cassandra / service / StorageService . java 
 @ @ - 2807 , 6 + 2807 , 21 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE 
 { 
 options . getHosts ( ) . addAll ( hosts ) ; 
 } 
 + if ( primaryRange ) 
 + { 
 + / / when repairing only primary range , neither dataCenters nor hosts can be set 
 + if ( options . getDataCenters ( ) . isEmpty ( ) & & options . getHosts ( ) . isEmpty ( ) ) 
 + options . getRanges ( ) . addAll ( getPrimaryRanges ( keyspace ) ) ; 
 + / / except dataCenters only contain local DC ( i . e . - local ) 
 + else if ( options . getDataCenters ( ) . size ( ) = = 1 & & options . getDataCenters ( ) . contains ( DatabaseDescriptor . getLocalDataCenter ( ) ) ) 
 + options . getRanges ( ) . addAll ( getPrimaryRangesWithinDC ( keyspace ) ) ; 
 + else 
 + throw new IllegalArgumentException ( " You need to run primary range repair on all nodes in the cluster . " ) ; 
 + } 
 + else 
 + { 
 + options . getRanges ( ) . addAll ( getLocalRanges ( keyspace ) ) ; 
 + } 
 if ( columnFamilies ! = null ) 
 { 
 for ( String columnFamily : columnFamilies )

NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 9c38702 . . 90c1650 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 10 , 6 + 10 , 7 @ @ Merged from 0 . 8 : 
 * fix displaying cfdef entries for super columnfamilies ( CASSANDRA - 3415 ) 
 * Make counter shard merging thread safe ( CASSANDRA - 3178 ) 
 * Revert CASSANDRA - 2855 
 + * Fix bug preventing the use of efficient cross - DC writes ( CASSANDRA - 3472 ) 
 
 1 . 0 . 2 
 * " defragment " rows for name - based queries under STCS ( CASSANDRA - 2503 ) 
 diff - - git a / src / java / org / apache / cassandra / service / StorageProxy . java b / src / java / org / apache / cassandra / service / StorageProxy . java 
 index 82eb3bd . . ce22cbf 100644 
 - - - a / src / java / org / apache / cassandra / service / StorageProxy . java 
 + + + b / src / java / org / apache / cassandra / service / StorageProxy . java 
 @ @ - 393 , 7 + 393 , 7 @ @ public class StorageProxy implements StorageProxyMBean 
 / / from previous loop iterations 
 message . removeHeader ( RowMutation . FORWARD _ HEADER ) ; 
 
 - if ( dataCenter . equals ( localDataCenter ) | | StorageService . instance . useEfficientCrossDCWrites ( ) ) 
 + if ( dataCenter . equals ( localDataCenter ) ) 
 { 
 / / direct writes to local DC or old Cassadra versions 
 for ( InetAddress destination : messages . getValue ( ) ) 
 diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java 
 index d040723 . . 0da6824 100644 
 - - - a / src / java / org / apache / cassandra / service / StorageService . java 
 + + + b / src / java / org / apache / cassandra / service / StorageService . java 
 @ @ - 205 , 7 + 205 , 6 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe 
 private static enum Mode { NORMAL , CLIENT , JOINING , LEAVING , DECOMMISSIONED , MOVING , DRAINING , DRAINED } 
 private Mode operationMode ; 
 
 - private volatile boolean efficientCrossDCWrites ; 
 private MigrationManager migrationManager = new MigrationManager ( ) ; 
 
 / * Used for tracking drain progress * / 
 @ @ - 798 , 9 + 797 , 6 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe 
 { 
 switch ( state ) 
 { 
 - case RELEASE _ VERSION : 
 - updateEfficientCrossDCWriteMode ( ) ; 
 - break ; 
 case STATUS : 
 String apStateValue = value . value ; 
 String [ ] pieces = apStateValue . split ( VersionedValue . DELIMITER _ STR , - 1 ) ; 
 @ @ - 824 , 25 + 820 , 6 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe 
 } 
 
 / * * 
 - * We can remove this in 0 . 8 , since mixing 0 . 7 . 0 with 0 . 8 is not supported ( 0 . 7 . 1 is required ) 
 - * / 
 - private void updateEfficientCrossDCWriteMode ( ) 
 - { 
 - for ( Map . Entry < InetAddress , EndpointState > entry : Gossiper . instance . getEndpointStates ( ) ) 
 - { 
 - VersionedValue version = entry . getValue ( ) . getApplicationState ( ApplicationState . RELEASE _ VERSION ) ; 
 - 
 - / / no version means it ' s old code that doesn ' t gossip version , < 0 . 7 . 1 . 
 - if ( version = = null ) 
 - { 
 - efficientCrossDCWrites = false ; 
 - return ; 
 - } 
 - } 
 - efficientCrossDCWrites = true ; 
 - } 
 - 
 - / * * 
 * Handle node bootstrap 
 * 
 * @ param endpoint bootstrapping node 
 @ @ - 2509 , 11 + 2486 , 6 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe 
 ( ( DynamicEndpointSnitch ) oldSnitch ) . unregisterMBean ( ) ; 
 } 
 
 - public boolean useEfficientCrossDCWrites ( ) 
 - { 
 - return efficientCrossDCWrites ; 
 - } 
 - 
 / * * 
 * Flushes the two largest memtables by ops and by throughput 
 * /
