BLEU SCORE: 0.0114347838903095

TEST MSG: Fall back to 1 / 4 commitlog volume for commitlog _ total _ space on small disks
GENERATED MSG: Add standalone sstableupgrade utility .

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index c215a50 . . 7aec3bc 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 6 @ @ <nl> 2 . 2 . 1 <nl> + * Fall back to 1 / 4 commitlog volume for commitlog _ total _ space on small disks <nl> + ( CASSANDRA - 10199 ) <nl> * Fix race during construction of commit log ( CASSANDRA - 10049 ) <nl> * Fix LeveledCompactionStrategyTest ( CASSANDRA - 9757 ) <nl> * Fix broken UnbufferedDataOutputStreamPlus . writeUTF ( CASSANDRA - 10203 ) <nl> diff - - git a / NEWS . txt b / NEWS . txt <nl> index e8db40d . . fd952e2 100644 <nl> - - - a / NEWS . txt <nl> + + + b / NEWS . txt <nl> @ @ - 26 , 6 + 26 , 12 @ @ New features <nl> - - - - - - - - - - - - <nl> - COUNT ( * ) and COUNT ( 1 ) can be selected with other columns or functions <nl> <nl> + Changed Defaults <nl> + - - - - - - - - - - - - - - - - <nl> + - commitlog _ total _ space _ in _ mb will use the smaller of 8192 , and 1 / 4 <nl> + of the total space of the commitlog volume . ( Before : always used <nl> + 8192 ) <nl> + <nl> <nl> 2 . 2 <nl> = = = <nl> diff - - git a / conf / cassandra . yaml b / conf / cassandra . yaml <nl> index 174f7db . . 4ff7afb 100644 <nl> - - - a / conf / cassandra . yaml <nl> + + + b / conf / cassandra . yaml <nl> @ @ - 362 , 7 + 362 , 9 @ @ memtable _ allocation _ type : heap _ buffers <nl> # in the oldest segment and remove it . So a small total commitlog space <nl> # will tend to cause more flush activity on less - active columnfamilies . <nl> # <nl> - # The default value is 8192 . <nl> + # The default value is the smaller of 8192 , and 1 / 4 of the total space <nl> + # of the commitlog volume . <nl> + # <nl> # commitlog _ total _ space _ in _ mb : 8192 <nl> <nl> # This sets the amount of memtable flush writer threads . These will <nl> diff - - git a / src / java / org / apache / cassandra / config / DatabaseDescriptor . java b / src / java / org / apache / cassandra / config / DatabaseDescriptor . java <nl> index e7c76ff . . b7e3eaa 100644 <nl> - - - a / src / java / org / apache / cassandra / config / DatabaseDescriptor . java <nl> + + + b / src / java / org / apache / cassandra / config / DatabaseDescriptor . java <nl> @ @ - 20 , 10 + 20 , 16 @ @ package org . apache . cassandra . config ; <nl> import java . io . File ; <nl> import java . io . IOException ; <nl> import java . net . * ; <nl> + import java . nio . file . FileStore ; <nl> + import java . nio . file . Files ; <nl> + import java . nio . file . NoSuchFileException ; <nl> + import java . nio . file . Path ; <nl> + import java . nio . file . Paths ; <nl> import java . util . * ; <nl> <nl> import com . google . common . annotations . VisibleForTesting ; <nl> import com . google . common . collect . ImmutableSet ; <nl> + import com . google . common . primitives . Ints ; <nl> import com . google . common . primitives . Longs ; <nl> <nl> import org . slf4j . Logger ; <nl> @ @ - 288 , 9 + 294 , 6 @ @ public class DatabaseDescriptor <nl> logger . debug ( " Syncing log with a period of { } " , conf . commitlog _ sync _ period _ in _ ms ) ; <nl> } <nl> <nl> - if ( conf . commitlog _ total _ space _ in _ mb = = null ) <nl> - conf . commitlog _ total _ space _ in _ mb = 8192 ; <nl> - <nl> / * evaluate the DiskAccessMode Config directive , which also affects indexAccessMode selection * / <nl> if ( conf . disk _ access _ mode = = Config . DiskAccessMode . auto ) <nl> { <nl> @ @ - 483 , 6 + 486 , 34 @ @ public class DatabaseDescriptor <nl> throw new ConfigurationException ( " commitlog _ directory is missing and - Dcassandra . storagedir is not set " , false ) ; <nl> conf . commitlog _ directory + = File . separator + " commitlog " ; <nl> } <nl> + <nl> + if ( conf . commitlog _ total _ space _ in _ mb = = null ) <nl> + { <nl> + int preferredSize = 8192 ; <nl> + int minSize = 0 ; <nl> + try <nl> + { <nl> + / / use 1 / 4 of available space . See discussion on # 10013 and # 10199 <nl> + minSize = Ints . checkedCast ( ( guessFileStore ( conf . commitlog _ directory ) . getTotalSpace ( ) / 1048576 ) / 4 ) ; <nl> + } <nl> + catch ( IOException e ) <nl> + { <nl> + logger . debug ( " Error checking disk space " , e ) ; <nl> + throw new ConfigurationException ( String . format ( " Unable to check disk space available to % s . Perhaps the Cassandra user does not have the necessary permissions " , <nl> + conf . commitlog _ directory ) , e ) ; <nl> + } <nl> + if ( minSize < preferredSize ) <nl> + { <nl> + logger . warn ( " Small commitlog volume detected at { } ; setting commitlog _ total _ space _ in _ mb to { } . You can override this in cassandra . yaml " , <nl> + conf . commitlog _ directory , minSize ) ; <nl> + conf . commitlog _ total _ space _ in _ mb = minSize ; <nl> + } <nl> + else <nl> + { <nl> + conf . commitlog _ total _ space _ in _ mb = preferredSize ; <nl> + } <nl> + } <nl> + <nl> if ( conf . saved _ caches _ directory = = null ) <nl> { <nl> conf . saved _ caches _ directory = System . getProperty ( " cassandra . storagedir " , null ) ; <nl> @ @ - 498 , 6 + 529 , 7 @ @ public class DatabaseDescriptor <nl> conf . data _ file _ directories = new String [ ] { defaultDataDir + File . separator + " data " } ; <nl> } <nl> <nl> + long dataFreeBytes = 0 ; <nl> / * data file and commit log directories . they get created later , when they ' re needed . * / <nl> for ( String datadir : conf . data _ file _ directories ) <nl> { <nl> @ @ - 505 , 7 + 537 , 22 @ @ public class DatabaseDescriptor <nl> throw new ConfigurationException ( " commitlog _ directory must not be the same as any data _ file _ directories " , false ) ; <nl> if ( datadir . equals ( conf . saved _ caches _ directory ) ) <nl> throw new ConfigurationException ( " saved _ caches _ directory must not be the same as any data _ file _ directories " , false ) ; <nl> + <nl> + try <nl> + { <nl> + dataFreeBytes + = guessFileStore ( datadir ) . getUnallocatedSpace ( ) ; <nl> + } <nl> + catch ( IOException e ) <nl> + { <nl> + logger . debug ( " Error checking disk space " , e ) ; <nl> + throw new ConfigurationException ( String . format ( " Unable to check disk space available to % s . Perhaps the Cassandra user does not have the necessary permissions " , <nl> + datadir ) , e ) ; <nl> + } <nl> } <nl> + if ( dataFreeBytes < 64L * 1024 * 1048576 ) / / 64 GB <nl> + logger . warn ( " Only { } MB free across all data volumes . Consider adding more capacity to your cluster or removing obsolete snapshots " , <nl> + dataFreeBytes / 1048576 ) ; <nl> + <nl> <nl> if ( conf . commitlog _ directory . equals ( conf . saved _ caches _ directory ) ) <nl> throw new ConfigurationException ( " saved _ caches _ directory must not be the same as the commitlog _ directory " , false ) ; <nl> @ @ - 608 , 6 + 655 , 25 @ @ public class DatabaseDescriptor <nl> throw new ConfigurationException ( " The seed provider lists no seeds . " , false ) ; <nl> } <nl> <nl> + private static FileStore guessFileStore ( String dir ) throws IOException <nl> + { <nl> + Path path = Paths . get ( dir ) ; <nl> + while ( true ) <nl> + { <nl> + try <nl> + { <nl> + return Files . getFileStore ( path ) ; <nl> + } <nl> + catch ( IOException e ) <nl> + { <nl> + if ( e instanceof NoSuchFileException ) <nl> + path = path . getParent ( ) ; <nl> + else <nl> + throw e ; <nl> + } <nl> + } <nl> + } <nl> + <nl> private static IEndpointSnitch createEndpointSnitch ( String snitchClassName ) throws ConfigurationException <nl> { <nl> if ( ! snitchClassName . contains ( " . " ) )
NEAREST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / metrics / ReadRepairMetrics . java b / src / java / org / apache / cassandra / metrics / ReadRepairMetrics . java <nl> index 3f48fee . . 5b61e42 100644 <nl> - - - a / src / java / org / apache / cassandra / metrics / ReadRepairMetrics . java <nl> + + + b / src / java / org / apache / cassandra / metrics / ReadRepairMetrics . java <nl> @ @ - 1 , 4 + 1 , 25 @ @ <nl> package org . apache . cassandra . metrics ; <nl> + / * <nl> + * <nl> + * Licensed to the Apache Software Foundation ( ASF ) under one <nl> + * or more contributor license agreements . See the NOTICE file <nl> + * distributed with this work for additional information <nl> + * regarding copyright ownership . The ASF licenses this file <nl> + * to you under the Apache License , Version 2 . 0 ( the <nl> + * " License " ) ; you may not use this file except in compliance <nl> + * with the License . You may obtain a copy of the License at <nl> + * <nl> + * http : / / www . apache . org / licenses / LICENSE - 2 . 0 <nl> + * <nl> + * Unless required by applicable law or agreed to in writing , <nl> + * software distributed under the License is distributed on an <nl> + * " AS IS " BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY <nl> + * KIND , either express or implied . See the License for the <nl> + * specific language governing permissions and limitations <nl> + * under the License . <nl> + * <nl> + * / <nl> + <nl> <nl> import java . util . concurrent . TimeUnit ; <nl>

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index c215a50 . . 7aec3bc 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 6 @ @ 
 2 . 2 . 1 
 + * Fall back to 1 / 4 commitlog volume for commitlog _ total _ space on small disks 
 + ( CASSANDRA - 10199 ) 
 * Fix race during construction of commit log ( CASSANDRA - 10049 ) 
 * Fix LeveledCompactionStrategyTest ( CASSANDRA - 9757 ) 
 * Fix broken UnbufferedDataOutputStreamPlus . writeUTF ( CASSANDRA - 10203 ) 
 diff - - git a / NEWS . txt b / NEWS . txt 
 index e8db40d . . fd952e2 100644 
 - - - a / NEWS . txt 
 + + + b / NEWS . txt 
 @ @ - 26 , 6 + 26 , 12 @ @ New features 
 - - - - - - - - - - - - 
 - COUNT ( * ) and COUNT ( 1 ) can be selected with other columns or functions 
 
 + Changed Defaults 
 + - - - - - - - - - - - - - - - - 
 + - commitlog _ total _ space _ in _ mb will use the smaller of 8192 , and 1 / 4 
 + of the total space of the commitlog volume . ( Before : always used 
 + 8192 ) 
 + 
 
 2 . 2 
 = = = 
 diff - - git a / conf / cassandra . yaml b / conf / cassandra . yaml 
 index 174f7db . . 4ff7afb 100644 
 - - - a / conf / cassandra . yaml 
 + + + b / conf / cassandra . yaml 
 @ @ - 362 , 7 + 362 , 9 @ @ memtable _ allocation _ type : heap _ buffers 
 # in the oldest segment and remove it . So a small total commitlog space 
 # will tend to cause more flush activity on less - active columnfamilies . 
 # 
 - # The default value is 8192 . 
 + # The default value is the smaller of 8192 , and 1 / 4 of the total space 
 + # of the commitlog volume . 
 + # 
 # commitlog _ total _ space _ in _ mb : 8192 
 
 # This sets the amount of memtable flush writer threads . These will 
 diff - - git a / src / java / org / apache / cassandra / config / DatabaseDescriptor . java b / src / java / org / apache / cassandra / config / DatabaseDescriptor . java 
 index e7c76ff . . b7e3eaa 100644 
 - - - a / src / java / org / apache / cassandra / config / DatabaseDescriptor . java 
 + + + b / src / java / org / apache / cassandra / config / DatabaseDescriptor . java 
 @ @ - 20 , 10 + 20 , 16 @ @ package org . apache . cassandra . config ; 
 import java . io . File ; 
 import java . io . IOException ; 
 import java . net . * ; 
 + import java . nio . file . FileStore ; 
 + import java . nio . file . Files ; 
 + import java . nio . file . NoSuchFileException ; 
 + import java . nio . file . Path ; 
 + import java . nio . file . Paths ; 
 import java . util . * ; 
 
 import com . google . common . annotations . VisibleForTesting ; 
 import com . google . common . collect . ImmutableSet ; 
 + import com . google . common . primitives . Ints ; 
 import com . google . common . primitives . Longs ; 
 
 import org . slf4j . Logger ; 
 @ @ - 288 , 9 + 294 , 6 @ @ public class DatabaseDescriptor 
 logger . debug ( " Syncing log with a period of { } " , conf . commitlog _ sync _ period _ in _ ms ) ; 
 } 
 
 - if ( conf . commitlog _ total _ space _ in _ mb = = null ) 
 - conf . commitlog _ total _ space _ in _ mb = 8192 ; 
 - 
 / * evaluate the DiskAccessMode Config directive , which also affects indexAccessMode selection * / 
 if ( conf . disk _ access _ mode = = Config . DiskAccessMode . auto ) 
 { 
 @ @ - 483 , 6 + 486 , 34 @ @ public class DatabaseDescriptor 
 throw new ConfigurationException ( " commitlog _ directory is missing and - Dcassandra . storagedir is not set " , false ) ; 
 conf . commitlog _ directory + = File . separator + " commitlog " ; 
 } 
 + 
 + if ( conf . commitlog _ total _ space _ in _ mb = = null ) 
 + { 
 + int preferredSize = 8192 ; 
 + int minSize = 0 ; 
 + try 
 + { 
 + / / use 1 / 4 of available space . See discussion on # 10013 and # 10199 
 + minSize = Ints . checkedCast ( ( guessFileStore ( conf . commitlog _ directory ) . getTotalSpace ( ) / 1048576 ) / 4 ) ; 
 + } 
 + catch ( IOException e ) 
 + { 
 + logger . debug ( " Error checking disk space " , e ) ; 
 + throw new ConfigurationException ( String . format ( " Unable to check disk space available to % s . Perhaps the Cassandra user does not have the necessary permissions " , 
 + conf . commitlog _ directory ) , e ) ; 
 + } 
 + if ( minSize < preferredSize ) 
 + { 
 + logger . warn ( " Small commitlog volume detected at { } ; setting commitlog _ total _ space _ in _ mb to { } . You can override this in cassandra . yaml " , 
 + conf . commitlog _ directory , minSize ) ; 
 + conf . commitlog _ total _ space _ in _ mb = minSize ; 
 + } 
 + else 
 + { 
 + conf . commitlog _ total _ space _ in _ mb = preferredSize ; 
 + } 
 + } 
 + 
 if ( conf . saved _ caches _ directory = = null ) 
 { 
 conf . saved _ caches _ directory = System . getProperty ( " cassandra . storagedir " , null ) ; 
 @ @ - 498 , 6 + 529 , 7 @ @ public class DatabaseDescriptor 
 conf . data _ file _ directories = new String [ ] { defaultDataDir + File . separator + " data " } ; 
 } 
 
 + long dataFreeBytes = 0 ; 
 / * data file and commit log directories . they get created later , when they ' re needed . * / 
 for ( String datadir : conf . data _ file _ directories ) 
 { 
 @ @ - 505 , 7 + 537 , 22 @ @ public class DatabaseDescriptor 
 throw new ConfigurationException ( " commitlog _ directory must not be the same as any data _ file _ directories " , false ) ; 
 if ( datadir . equals ( conf . saved _ caches _ directory ) ) 
 throw new ConfigurationException ( " saved _ caches _ directory must not be the same as any data _ file _ directories " , false ) ; 
 + 
 + try 
 + { 
 + dataFreeBytes + = guessFileStore ( datadir ) . getUnallocatedSpace ( ) ; 
 + } 
 + catch ( IOException e ) 
 + { 
 + logger . debug ( " Error checking disk space " , e ) ; 
 + throw new ConfigurationException ( String . format ( " Unable to check disk space available to % s . Perhaps the Cassandra user does not have the necessary permissions " , 
 + datadir ) , e ) ; 
 + } 
 } 
 + if ( dataFreeBytes < 64L * 1024 * 1048576 ) / / 64 GB 
 + logger . warn ( " Only { } MB free across all data volumes . Consider adding more capacity to your cluster or removing obsolete snapshots " , 
 + dataFreeBytes / 1048576 ) ; 
 + 
 
 if ( conf . commitlog _ directory . equals ( conf . saved _ caches _ directory ) ) 
 throw new ConfigurationException ( " saved _ caches _ directory must not be the same as the commitlog _ directory " , false ) ; 
 @ @ - 608 , 6 + 655 , 25 @ @ public class DatabaseDescriptor 
 throw new ConfigurationException ( " The seed provider lists no seeds . " , false ) ; 
 } 
 
 + private static FileStore guessFileStore ( String dir ) throws IOException 
 + { 
 + Path path = Paths . get ( dir ) ; 
 + while ( true ) 
 + { 
 + try 
 + { 
 + return Files . getFileStore ( path ) ; 
 + } 
 + catch ( IOException e ) 
 + { 
 + if ( e instanceof NoSuchFileException ) 
 + path = path . getParent ( ) ; 
 + else 
 + throw e ; 
 + } 
 + } 
 + } 
 + 
 private static IEndpointSnitch createEndpointSnitch ( String snitchClassName ) throws ConfigurationException 
 { 
 if ( ! snitchClassName . contains ( " . " ) )

NEAREST DIFF:
diff - - git a / src / java / org / apache / cassandra / metrics / ReadRepairMetrics . java b / src / java / org / apache / cassandra / metrics / ReadRepairMetrics . java 
 index 3f48fee . . 5b61e42 100644 
 - - - a / src / java / org / apache / cassandra / metrics / ReadRepairMetrics . java 
 + + + b / src / java / org / apache / cassandra / metrics / ReadRepairMetrics . java 
 @ @ - 1 , 4 + 1 , 25 @ @ 
 package org . apache . cassandra . metrics ; 
 + / * 
 + * 
 + * Licensed to the Apache Software Foundation ( ASF ) under one 
 + * or more contributor license agreements . See the NOTICE file 
 + * distributed with this work for additional information 
 + * regarding copyright ownership . The ASF licenses this file 
 + * to you under the Apache License , Version 2 . 0 ( the 
 + * " License " ) ; you may not use this file except in compliance 
 + * with the License . You may obtain a copy of the License at 
 + * 
 + * http : / / www . apache . org / licenses / LICENSE - 2 . 0 
 + * 
 + * Unless required by applicable law or agreed to in writing , 
 + * software distributed under the License is distributed on an 
 + * " AS IS " BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY 
 + * KIND , either express or implied . See the License for the 
 + * specific language governing permissions and limitations 
 + * under the License . 
 + * 
 + * / 
 + 
 
 import java . util . concurrent . TimeUnit ; 

