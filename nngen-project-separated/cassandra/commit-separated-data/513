BLEU SCORE: 0.05522397783539471

TEST MSG: Use timestamp from ClientState by default in AlterTableStatement
GENERATED MSG: Change schema change response in native protocol v3

TEST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / cql3 / statements / AlterKeyspaceStatement . java b / src / java / org / apache / cassandra / cql3 / statements / AlterKeyspaceStatement . java <nl> index 5642b0d . . be85fef 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / AlterKeyspaceStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / AlterKeyspaceStatement . java <nl> @ @ - 25 , 6 + 25 , 7 @ @ import org . apache . cassandra . schema . KeyspaceMetadata ; <nl> import org . apache . cassandra . schema . KeyspaceParams ; <nl> import org . apache . cassandra . service . ClientState ; <nl> import org . apache . cassandra . service . MigrationManager ; <nl> + import org . apache . cassandra . service . QueryState ; <nl> import org . apache . cassandra . transport . Event ; <nl> <nl> public class AlterKeyspaceStatement extends SchemaAlteringStatement <nl> @ @ - 75 , 7 + 76 , 7 @ @ public class AlterKeyspaceStatement extends SchemaAlteringStatement <nl> } <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException <nl> { <nl> KeyspaceMetadata oldKsm = Schema . instance . getKSMetaData ( name ) ; <nl> / / In the ( very ) unlikely case the keyspace was dropped since validate ( ) <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / AlterTableStatement . java b / src / java / org / apache / cassandra / cql3 / statements / AlterTableStatement . java <nl> index d64e541 . . 6210d16 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / AlterTableStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / AlterTableStatement . java <nl> @ @ - 40 , 8 + 40 , 8 @ @ import org . apache . cassandra . schema . Indexes ; <nl> import org . apache . cassandra . schema . TableParams ; <nl> import org . apache . cassandra . service . ClientState ; <nl> import org . apache . cassandra . service . MigrationManager ; <nl> + import org . apache . cassandra . service . QueryState ; <nl> import org . apache . cassandra . transport . Event ; <nl> - import org . apache . cassandra . utils . FBUtilities ; <nl> <nl> import static org . apache . cassandra . thrift . ThriftValidation . validateColumnFamily ; <nl> <nl> @ @ - 58 , 7 + 58 , 7 @ @ public class AlterTableStatement extends SchemaAlteringStatement <nl> private final TableAttributes attrs ; <nl> private final Map < ColumnIdentifier . Raw , ColumnIdentifier . Raw > renames ; <nl> private final boolean isStatic ; / / Only for ALTER ADD <nl> - private final long deleteTimestamp ; <nl> + private final Long deleteTimestamp ; <nl> <nl> public AlterTableStatement ( CFName name , <nl> Type type , <nl> @ @ - 76 , 7 + 76 , 7 @ @ public class AlterTableStatement extends SchemaAlteringStatement <nl> this . attrs = attrs ; <nl> this . renames = renames ; <nl> this . isStatic = isStatic ; <nl> - this . deleteTimestamp = deleteTimestamp = = null ? FBUtilities . timestampMicros ( ) : deleteTimestamp ; <nl> + this . deleteTimestamp = deleteTimestamp ; <nl> } <nl> <nl> public void checkAccess ( ClientState state ) throws UnauthorizedException , InvalidRequestException <nl> @ @ - 89 , 7 + 89 , 7 @ @ public class AlterTableStatement extends SchemaAlteringStatement <nl> / / validated in announceMigration ( ) <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException <nl> { <nl> CFMetaData meta = validateColumnFamily ( keyspace ( ) , columnFamily ( ) ) ; <nl> if ( meta . isView ( ) ) <nl> @ @ - 242 , 7 + 242 , 7 @ @ public class AlterTableStatement extends SchemaAlteringStatement <nl> } <nl> assert toDelete ! = null ; <nl> cfm . removeColumnDefinition ( toDelete ) ; <nl> - cfm . recordColumnDrop ( toDelete , deleteTimestamp ) ; <nl> + cfm . recordColumnDrop ( toDelete , deleteTimestamp = = null ? queryState . getTimestamp ( ) : deleteTimestamp ) ; <nl> break ; <nl> } <nl> <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / AlterTypeStatement . java b / src / java / org / apache / cassandra / cql3 / statements / AlterTypeStatement . java <nl> index bd23971 . . 4cac3b3 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / AlterTypeStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / AlterTypeStatement . java <nl> @ @ - 28 , 6 + 28 , 7 @ @ import org . apache . cassandra . exceptions . * ; <nl> import org . apache . cassandra . schema . KeyspaceMetadata ; <nl> import org . apache . cassandra . service . ClientState ; <nl> import org . apache . cassandra . service . MigrationManager ; <nl> + import org . apache . cassandra . service . QueryState ; <nl> import org . apache . cassandra . transport . Event ; <nl> <nl> public abstract class AlterTypeStatement extends SchemaAlteringStatement <nl> @ @ - 83 , 7 + 84 , 7 @ @ public abstract class AlterTypeStatement extends SchemaAlteringStatement <nl> return name . getKeyspace ( ) ; <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException <nl> { <nl> KeyspaceMetadata ksm = Schema . instance . getKSMetaData ( name . getKeyspace ( ) ) ; <nl> if ( ksm = = null ) <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / AlterViewStatement . java b / src / java / org / apache / cassandra / cql3 / statements / AlterViewStatement . java <nl> index ba077c7 . . ea87cfd 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / AlterViewStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / AlterViewStatement . java <nl> @ @ - 29 , 6 + 29 , 7 @ @ import org . apache . cassandra . exceptions . UnauthorizedException ; <nl> import org . apache . cassandra . schema . TableParams ; <nl> import org . apache . cassandra . service . ClientState ; <nl> import org . apache . cassandra . service . MigrationManager ; <nl> + import org . apache . cassandra . service . QueryState ; <nl> import org . apache . cassandra . transport . Event ; <nl> <nl> import static org . apache . cassandra . thrift . ThriftValidation . validateColumnFamily ; <nl> @ @ - 55 , 7 + 56 , 7 @ @ public class AlterViewStatement extends SchemaAlteringStatement <nl> / / validated in announceMigration ( ) <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException <nl> { <nl> CFMetaData meta = validateColumnFamily ( keyspace ( ) , columnFamily ( ) ) ; <nl> if ( ! meta . isView ( ) ) <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / CreateAggregateStatement . java b / src / java / org / apache / cassandra / cql3 / statements / CreateAggregateStatement . java <nl> index 98e2433 . . ca0270f 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / CreateAggregateStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / CreateAggregateStatement . java <nl> @ @ - 208 , 7 + 208 , 7 @ @ public final class CreateAggregateStatement extends SchemaAlteringStatement <nl> throw new InvalidRequestException ( String . format ( " Cannot add aggregate ' % s ' to non existing keyspace ' % s ' . " , functionName . name , functionName . keyspace ) ) ; <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException <nl> { <nl> Function old = Schema . instance . findFunction ( functionName , argTypes ) . orElse ( null ) ; <nl> boolean replaced = old ! = null ; <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / CreateFunctionStatement . java b / src / java / org / apache / cassandra / cql3 / statements / CreateFunctionStatement . java <nl> index a54c49e . . c8d38f5 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / CreateFunctionStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / CreateFunctionStatement . java <nl> @ @ - 138 , 7 + 138 , 7 @ @ public final class CreateFunctionStatement extends SchemaAlteringStatement <nl> throw new InvalidRequestException ( String . format ( " Cannot add function ' % s ' to non existing keyspace ' % s ' . " , functionName . name , functionName . keyspace ) ) ; <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException <nl> { <nl> Function old = Schema . instance . findFunction ( functionName , argTypes ) . orElse ( null ) ; <nl> boolean replaced = old ! = null ; <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / CreateIndexStatement . java b / src / java / org / apache / cassandra / cql3 / statements / CreateIndexStatement . java <nl> index 2eebe0d . . c21441c 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / CreateIndexStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / CreateIndexStatement . java <nl> @ @ - 40 , 6 + 40 , 7 @ @ import org . apache . cassandra . schema . IndexMetadata ; <nl> import org . apache . cassandra . schema . Indexes ; <nl> import org . apache . cassandra . service . ClientState ; <nl> import org . apache . cassandra . service . MigrationManager ; <nl> + import org . apache . cassandra . service . QueryState ; <nl> import org . apache . cassandra . thrift . ThriftValidation ; <nl> import org . apache . cassandra . transport . Event ; <nl> <nl> @ @ - 188 , 7 + 189 , 7 @ @ public class CreateIndexStatement extends SchemaAlteringStatement <nl> throw new InvalidRequestException ( " Duplicate column " + target . column + " in index target list " ) ; <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException <nl> { <nl> CFMetaData cfm = Schema . instance . getCFMetaData ( keyspace ( ) , columnFamily ( ) ) . copy ( ) ; <nl> List < IndexTarget > targets = new ArrayList < > ( rawTargets . size ( ) ) ; <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / CreateKeyspaceStatement . java b / src / java / org / apache / cassandra / cql3 / statements / CreateKeyspaceStatement . java <nl> index 3eb0ac9 . . 787dc73 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / CreateKeyspaceStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / CreateKeyspaceStatement . java <nl> @ @ - 92 , 7 + 92 , 7 @ @ public class CreateKeyspaceStatement extends SchemaAlteringStatement <nl> throw new ConfigurationException ( " Unable to use given strategy class : LocalStrategy is reserved for internal use . " ) ; <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException <nl> { <nl> KeyspaceMetadata ksm = KeyspaceMetadata . create ( name , attrs . asNewKeyspaceParams ( ) ) ; <nl> try <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / CreateTableStatement . java b / src / java / org / apache / cassandra / cql3 / statements / CreateTableStatement . java <nl> index 04f76d3 . . ef950dc 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / CreateTableStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / CreateTableStatement . java <nl> @ @ - 80 , 7 + 80 , 7 @ @ public class CreateTableStatement extends SchemaAlteringStatement <nl> / / validated in announceMigration ( ) <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException <nl> { <nl> try <nl> { <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / CreateTriggerStatement . java b / src / java / org / apache / cassandra / cql3 / statements / CreateTriggerStatement . java <nl> index 94cfc15 . . 5d29996 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / CreateTriggerStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / CreateTriggerStatement . java <nl> @ @ - 31 , 6 + 31 , 7 @ @ import org . apache . cassandra . schema . TriggerMetadata ; <nl> import org . apache . cassandra . schema . Triggers ; <nl> import org . apache . cassandra . service . ClientState ; <nl> import org . apache . cassandra . service . MigrationManager ; <nl> + import org . apache . cassandra . service . QueryState ; <nl> import org . apache . cassandra . thrift . ThriftValidation ; <nl> import org . apache . cassandra . transport . Event ; <nl> import org . apache . cassandra . triggers . TriggerExecutor ; <nl> @ @ - 72 , 7 + 73 , 7 @ @ public class CreateTriggerStatement extends SchemaAlteringStatement <nl> } <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws ConfigurationException , InvalidRequestException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws ConfigurationException , InvalidRequestException <nl> { <nl> CFMetaData cfm = Schema . instance . getCFMetaData ( keyspace ( ) , columnFamily ( ) ) . copy ( ) ; <nl> Triggers triggers = cfm . getTriggers ( ) ; <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / CreateTypeStatement . java b / src / java / org / apache / cassandra / cql3 / statements / CreateTypeStatement . java <nl> index f62b9ea . . e7f8feb 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / CreateTypeStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / CreateTypeStatement . java <nl> @ @ - 30 , 6 + 30 , 7 @ @ import org . apache . cassandra . exceptions . * ; <nl> import org . apache . cassandra . schema . KeyspaceMetadata ; <nl> import org . apache . cassandra . service . ClientState ; <nl> import org . apache . cassandra . service . MigrationManager ; <nl> + import org . apache . cassandra . service . QueryState ; <nl> import org . apache . cassandra . transport . Event ; <nl> <nl> public class CreateTypeStatement extends SchemaAlteringStatement <nl> @ @ - 112 , 7 + 113 , 7 @ @ public class CreateTypeStatement extends SchemaAlteringStatement <nl> return new UserType ( name . getKeyspace ( ) , name . getUserTypeName ( ) , names , types ) ; <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException <nl> { <nl> KeyspaceMetadata ksm = Schema . instance . getKSMetaData ( name . getKeyspace ( ) ) ; <nl> assert ksm ! = null ; / / should haven ' t validate otherwise <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / CreateViewStatement . java b / src / java / org / apache / cassandra / cql3 / statements / CreateViewStatement . java <nl> index 30e55a0 . . 708d551 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / CreateViewStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / CreateViewStatement . java <nl> @ @ - 43 , 6 + 43 , 7 @ @ import org . apache . cassandra . schema . TableParams ; <nl> import org . apache . cassandra . service . ClientState ; <nl> import org . apache . cassandra . service . ClientWarn ; <nl> import org . apache . cassandra . service . MigrationManager ; <nl> + import org . apache . cassandra . service . QueryState ; <nl> import org . apache . cassandra . thrift . ThriftValidation ; <nl> import org . apache . cassandra . transport . Event ; <nl> <nl> @ @ - 111 , 7 + 112 , 7 @ @ public class CreateViewStatement extends SchemaAlteringStatement <nl> } <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException <nl> { <nl> / / We need to make sure that : <nl> / / - primary key includes all columns in base table ' s primary key <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / DropAggregateStatement . java b / src / java / org / apache / cassandra / cql3 / statements / DropAggregateStatement . java <nl> index 2b1432b . . ae8ad8c 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / DropAggregateStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / DropAggregateStatement . java <nl> @ @ - 31 , 6 + 31 , 7 @ @ import org . apache . cassandra . exceptions . RequestValidationException ; <nl> import org . apache . cassandra . exceptions . UnauthorizedException ; <nl> import org . apache . cassandra . service . ClientState ; <nl> import org . apache . cassandra . service . MigrationManager ; <nl> + import org . apache . cassandra . service . QueryState ; <nl> import org . apache . cassandra . thrift . ThriftValidation ; <nl> import org . apache . cassandra . transport . Event ; <nl> <nl> @ @ - 77 , 7 + 78 , 7 @ @ public final class DropAggregateStatement extends SchemaAlteringStatement <nl> { <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException <nl> { <nl> Collection < Function > olds = Schema . instance . getFunctions ( functionName ) ; <nl> <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / DropFunctionStatement . java b / src / java / org / apache / cassandra / cql3 / statements / DropFunctionStatement . java <nl> index 6f11f9c . . 138691e 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / DropFunctionStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / DropFunctionStatement . java <nl> @ @ - 35 , 6 + 35 , 7 @ @ import org . apache . cassandra . exceptions . UnauthorizedException ; <nl> import org . apache . cassandra . schema . KeyspaceMetadata ; <nl> import org . apache . cassandra . service . ClientState ; <nl> import org . apache . cassandra . service . MigrationManager ; <nl> + import org . apache . cassandra . service . QueryState ; <nl> import org . apache . cassandra . thrift . ThriftValidation ; <nl> import org . apache . cassandra . transport . Event ; <nl> <nl> @ @ - 127 , 7 + 128 , 7 @ @ public final class DropFunctionStatement extends SchemaAlteringStatement <nl> functionName , functionName , functionName ) ) ; <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException <nl> { <nl> Function old = findFunction ( ) ; <nl> if ( old = = null ) <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / DropIndexStatement . java b / src / java / org / apache / cassandra / cql3 / statements / DropIndexStatement . java <nl> index 85f5f0d . . 35aee3c 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / DropIndexStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / DropIndexStatement . java <nl> @ @ - 66 , 11 + 66 , 11 @ @ public class DropIndexStatement extends SchemaAlteringStatement <nl> @ Override <nl> public ResultMessage execute ( QueryState state , QueryOptions options ) throws RequestValidationException <nl> { <nl> - Event . SchemaChange ce = announceMigration ( false ) ; <nl> + Event . SchemaChange ce = announceMigration ( state , false ) ; <nl> return ce = = null ? null : new ResultMessage . SchemaChange ( ce ) ; <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException <nl> { <nl> CFMetaData cfm = lookupIndexedTable ( ) ; <nl> if ( cfm = = null ) <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / DropKeyspaceStatement . java b / src / java / org / apache / cassandra / cql3 / statements / DropKeyspaceStatement . java <nl> index 513ff1b . . 9ba68a6 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / DropKeyspaceStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / DropKeyspaceStatement . java <nl> @ @ - 24 , 6 + 24 , 7 @ @ import org . apache . cassandra . auth . Permission ; <nl> import org . apache . cassandra . exceptions . UnauthorizedException ; <nl> import org . apache . cassandra . service . ClientState ; <nl> import org . apache . cassandra . service . MigrationManager ; <nl> + import org . apache . cassandra . service . QueryState ; <nl> import org . apache . cassandra . thrift . ThriftValidation ; <nl> import org . apache . cassandra . transport . Event ; <nl> <nl> @ @ - 55 , 7 + 56 , 7 @ @ public class DropKeyspaceStatement extends SchemaAlteringStatement <nl> return keyspace ; <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws ConfigurationException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws ConfigurationException <nl> { <nl> try <nl> { <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / DropTableStatement . java b / src / java / org / apache / cassandra / cql3 / statements / DropTableStatement . java <nl> index 8e18cad . . 5641185 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / DropTableStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / DropTableStatement . java <nl> @ @ - 28 , 6 + 28 , 7 @ @ import org . apache . cassandra . exceptions . UnauthorizedException ; <nl> import org . apache . cassandra . schema . KeyspaceMetadata ; <nl> import org . apache . cassandra . service . ClientState ; <nl> import org . apache . cassandra . service . MigrationManager ; <nl> + import org . apache . cassandra . service . QueryState ; <nl> import org . apache . cassandra . transport . Event ; <nl> <nl> public class DropTableStatement extends SchemaAlteringStatement <nl> @ @ - 58 , 7 + 59 , 7 @ @ public class DropTableStatement extends SchemaAlteringStatement <nl> / / validated in announceMigration ( ) <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws ConfigurationException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws ConfigurationException <nl> { <nl> try <nl> { <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / DropTriggerStatement . java b / src / java / org / apache / cassandra / cql3 / statements / DropTriggerStatement . java <nl> index 3f61e01 . . 162c736 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / DropTriggerStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / DropTriggerStatement . java <nl> @ @ - 30 , 6 + 30 , 7 @ @ import org . apache . cassandra . exceptions . UnauthorizedException ; <nl> import org . apache . cassandra . schema . Triggers ; <nl> import org . apache . cassandra . service . ClientState ; <nl> import org . apache . cassandra . service . MigrationManager ; <nl> + import org . apache . cassandra . service . QueryState ; <nl> import org . apache . cassandra . thrift . ThriftValidation ; <nl> import org . apache . cassandra . transport . Event ; <nl> <nl> @ @ - 58 , 7 + 59 , 7 @ @ public class DropTriggerStatement extends SchemaAlteringStatement <nl> ThriftValidation . validateColumnFamily ( keyspace ( ) , columnFamily ( ) ) ; <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws ConfigurationException , InvalidRequestException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws ConfigurationException , InvalidRequestException <nl> { <nl> CFMetaData cfm = Schema . instance . getCFMetaData ( keyspace ( ) , columnFamily ( ) ) . copy ( ) ; <nl> Triggers triggers = cfm . getTriggers ( ) ; <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / DropTypeStatement . java b / src / java / org / apache / cassandra / cql3 / statements / DropTypeStatement . java <nl> index 00988af . . cd6daae 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / DropTypeStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / DropTypeStatement . java <nl> @ @ - 26 , 6 + 26 , 7 @ @ import org . apache . cassandra . exceptions . * ; <nl> import org . apache . cassandra . schema . KeyspaceMetadata ; <nl> import org . apache . cassandra . service . ClientState ; <nl> import org . apache . cassandra . service . MigrationManager ; <nl> + import org . apache . cassandra . service . QueryState ; <nl> import org . apache . cassandra . transport . Event ; <nl> <nl> public class DropTypeStatement extends SchemaAlteringStatement <nl> @ @ - 103 , 7 + 104 , 7 @ @ public class DropTypeStatement extends SchemaAlteringStatement <nl> return name . getKeyspace ( ) ; <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException <nl> { <nl> KeyspaceMetadata ksm = Schema . instance . getKSMetaData ( name . getKeyspace ( ) ) ; <nl> if ( ksm = = null ) <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / DropViewStatement . java b / src / java / org / apache / cassandra / cql3 / statements / DropViewStatement . java <nl> index 1f53ac4 . . b65c1b0 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / DropViewStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / DropViewStatement . java <nl> @ @ - 29 , 6 + 29 , 7 @ @ import org . apache . cassandra . exceptions . InvalidRequestException ; <nl> import org . apache . cassandra . exceptions . UnauthorizedException ; <nl> import org . apache . cassandra . service . ClientState ; <nl> import org . apache . cassandra . service . MigrationManager ; <nl> + import org . apache . cassandra . service . QueryState ; <nl> import org . apache . cassandra . transport . Event ; <nl> <nl> public class DropViewStatement extends SchemaAlteringStatement <nl> @ @ - 53 , 7 + 54 , 7 @ @ public class DropViewStatement extends SchemaAlteringStatement <nl> / / validated in findIndexedCf ( ) <nl> } <nl> <nl> - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException <nl> + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException <nl> { <nl> try <nl> { <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / SchemaAlteringStatement . java b / src / java / org / apache / cassandra / cql3 / statements / SchemaAlteringStatement . java <nl> index 10c004c . . 62ba0ae 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / SchemaAlteringStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / SchemaAlteringStatement . java <nl> @ @ - 84 , 13 + 84 , 13 @ @ public abstract class SchemaAlteringStatement extends CFStatement implements CQL <nl> * <nl> * @ throws RequestValidationException <nl> * / <nl> - public abstract Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException ; <nl> + protected abstract Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException ; <nl> <nl> public ResultMessage execute ( QueryState state , QueryOptions options ) throws RequestValidationException <nl> { <nl> / / If an IF [ NOT ] EXISTS clause was used , this may not result in an actual schema change . To avoid doing <nl> / / extra work in the drivers to handle schema changes , we return an empty message in this case . ( CASSANDRA - 7600 ) <nl> - Event . SchemaChange ce = announceMigration ( false ) ; <nl> + Event . SchemaChange ce = announceMigration ( state , false ) ; <nl> if ( ce = = null ) <nl> return new ResultMessage . Void ( ) ; <nl> <nl> @ @ - 117 , 7 + 117 , 7 @ @ public abstract class SchemaAlteringStatement extends CFStatement implements CQL <nl> <nl> public ResultMessage executeInternal ( QueryState state , QueryOptions options ) <nl> { <nl> - Event . SchemaChange ce = announceMigration ( true ) ; <nl> + Event . SchemaChange ce = announceMigration ( state , true ) ; <nl> return ce = = null ? new ResultMessage . Void ( ) : new ResultMessage . SchemaChange ( ce ) ; <nl> } <nl> }
NEAREST DIFF (one line): ELIMINATEDSENTENCE

TEST DIFF:
diff - - git a / src / java / org / apache / cassandra / cql3 / statements / AlterKeyspaceStatement . java b / src / java / org / apache / cassandra / cql3 / statements / AlterKeyspaceStatement . java 
 index 5642b0d . . be85fef 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / AlterKeyspaceStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / AlterKeyspaceStatement . java 
 @ @ - 25 , 6 + 25 , 7 @ @ import org . apache . cassandra . schema . KeyspaceMetadata ; 
 import org . apache . cassandra . schema . KeyspaceParams ; 
 import org . apache . cassandra . service . ClientState ; 
 import org . apache . cassandra . service . MigrationManager ; 
 + import org . apache . cassandra . service . QueryState ; 
 import org . apache . cassandra . transport . Event ; 
 
 public class AlterKeyspaceStatement extends SchemaAlteringStatement 
 @ @ - 75 , 7 + 76 , 7 @ @ public class AlterKeyspaceStatement extends SchemaAlteringStatement 
 } 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException 
 { 
 KeyspaceMetadata oldKsm = Schema . instance . getKSMetaData ( name ) ; 
 / / In the ( very ) unlikely case the keyspace was dropped since validate ( ) 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / AlterTableStatement . java b / src / java / org / apache / cassandra / cql3 / statements / AlterTableStatement . java 
 index d64e541 . . 6210d16 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / AlterTableStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / AlterTableStatement . java 
 @ @ - 40 , 8 + 40 , 8 @ @ import org . apache . cassandra . schema . Indexes ; 
 import org . apache . cassandra . schema . TableParams ; 
 import org . apache . cassandra . service . ClientState ; 
 import org . apache . cassandra . service . MigrationManager ; 
 + import org . apache . cassandra . service . QueryState ; 
 import org . apache . cassandra . transport . Event ; 
 - import org . apache . cassandra . utils . FBUtilities ; 
 
 import static org . apache . cassandra . thrift . ThriftValidation . validateColumnFamily ; 
 
 @ @ - 58 , 7 + 58 , 7 @ @ public class AlterTableStatement extends SchemaAlteringStatement 
 private final TableAttributes attrs ; 
 private final Map < ColumnIdentifier . Raw , ColumnIdentifier . Raw > renames ; 
 private final boolean isStatic ; / / Only for ALTER ADD 
 - private final long deleteTimestamp ; 
 + private final Long deleteTimestamp ; 
 
 public AlterTableStatement ( CFName name , 
 Type type , 
 @ @ - 76 , 7 + 76 , 7 @ @ public class AlterTableStatement extends SchemaAlteringStatement 
 this . attrs = attrs ; 
 this . renames = renames ; 
 this . isStatic = isStatic ; 
 - this . deleteTimestamp = deleteTimestamp = = null ? FBUtilities . timestampMicros ( ) : deleteTimestamp ; 
 + this . deleteTimestamp = deleteTimestamp ; 
 } 
 
 public void checkAccess ( ClientState state ) throws UnauthorizedException , InvalidRequestException 
 @ @ - 89 , 7 + 89 , 7 @ @ public class AlterTableStatement extends SchemaAlteringStatement 
 / / validated in announceMigration ( ) 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException 
 { 
 CFMetaData meta = validateColumnFamily ( keyspace ( ) , columnFamily ( ) ) ; 
 if ( meta . isView ( ) ) 
 @ @ - 242 , 7 + 242 , 7 @ @ public class AlterTableStatement extends SchemaAlteringStatement 
 } 
 assert toDelete ! = null ; 
 cfm . removeColumnDefinition ( toDelete ) ; 
 - cfm . recordColumnDrop ( toDelete , deleteTimestamp ) ; 
 + cfm . recordColumnDrop ( toDelete , deleteTimestamp = = null ? queryState . getTimestamp ( ) : deleteTimestamp ) ; 
 break ; 
 } 
 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / AlterTypeStatement . java b / src / java / org / apache / cassandra / cql3 / statements / AlterTypeStatement . java 
 index bd23971 . . 4cac3b3 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / AlterTypeStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / AlterTypeStatement . java 
 @ @ - 28 , 6 + 28 , 7 @ @ import org . apache . cassandra . exceptions . * ; 
 import org . apache . cassandra . schema . KeyspaceMetadata ; 
 import org . apache . cassandra . service . ClientState ; 
 import org . apache . cassandra . service . MigrationManager ; 
 + import org . apache . cassandra . service . QueryState ; 
 import org . apache . cassandra . transport . Event ; 
 
 public abstract class AlterTypeStatement extends SchemaAlteringStatement 
 @ @ - 83 , 7 + 84 , 7 @ @ public abstract class AlterTypeStatement extends SchemaAlteringStatement 
 return name . getKeyspace ( ) ; 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException 
 { 
 KeyspaceMetadata ksm = Schema . instance . getKSMetaData ( name . getKeyspace ( ) ) ; 
 if ( ksm = = null ) 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / AlterViewStatement . java b / src / java / org / apache / cassandra / cql3 / statements / AlterViewStatement . java 
 index ba077c7 . . ea87cfd 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / AlterViewStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / AlterViewStatement . java 
 @ @ - 29 , 6 + 29 , 7 @ @ import org . apache . cassandra . exceptions . UnauthorizedException ; 
 import org . apache . cassandra . schema . TableParams ; 
 import org . apache . cassandra . service . ClientState ; 
 import org . apache . cassandra . service . MigrationManager ; 
 + import org . apache . cassandra . service . QueryState ; 
 import org . apache . cassandra . transport . Event ; 
 
 import static org . apache . cassandra . thrift . ThriftValidation . validateColumnFamily ; 
 @ @ - 55 , 7 + 56 , 7 @ @ public class AlterViewStatement extends SchemaAlteringStatement 
 / / validated in announceMigration ( ) 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException 
 { 
 CFMetaData meta = validateColumnFamily ( keyspace ( ) , columnFamily ( ) ) ; 
 if ( ! meta . isView ( ) ) 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / CreateAggregateStatement . java b / src / java / org / apache / cassandra / cql3 / statements / CreateAggregateStatement . java 
 index 98e2433 . . ca0270f 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / CreateAggregateStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / CreateAggregateStatement . java 
 @ @ - 208 , 7 + 208 , 7 @ @ public final class CreateAggregateStatement extends SchemaAlteringStatement 
 throw new InvalidRequestException ( String . format ( " Cannot add aggregate ' % s ' to non existing keyspace ' % s ' . " , functionName . name , functionName . keyspace ) ) ; 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException 
 { 
 Function old = Schema . instance . findFunction ( functionName , argTypes ) . orElse ( null ) ; 
 boolean replaced = old ! = null ; 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / CreateFunctionStatement . java b / src / java / org / apache / cassandra / cql3 / statements / CreateFunctionStatement . java 
 index a54c49e . . c8d38f5 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / CreateFunctionStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / CreateFunctionStatement . java 
 @ @ - 138 , 7 + 138 , 7 @ @ public final class CreateFunctionStatement extends SchemaAlteringStatement 
 throw new InvalidRequestException ( String . format ( " Cannot add function ' % s ' to non existing keyspace ' % s ' . " , functionName . name , functionName . keyspace ) ) ; 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException 
 { 
 Function old = Schema . instance . findFunction ( functionName , argTypes ) . orElse ( null ) ; 
 boolean replaced = old ! = null ; 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / CreateIndexStatement . java b / src / java / org / apache / cassandra / cql3 / statements / CreateIndexStatement . java 
 index 2eebe0d . . c21441c 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / CreateIndexStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / CreateIndexStatement . java 
 @ @ - 40 , 6 + 40 , 7 @ @ import org . apache . cassandra . schema . IndexMetadata ; 
 import org . apache . cassandra . schema . Indexes ; 
 import org . apache . cassandra . service . ClientState ; 
 import org . apache . cassandra . service . MigrationManager ; 
 + import org . apache . cassandra . service . QueryState ; 
 import org . apache . cassandra . thrift . ThriftValidation ; 
 import org . apache . cassandra . transport . Event ; 
 
 @ @ - 188 , 7 + 189 , 7 @ @ public class CreateIndexStatement extends SchemaAlteringStatement 
 throw new InvalidRequestException ( " Duplicate column " + target . column + " in index target list " ) ; 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException 
 { 
 CFMetaData cfm = Schema . instance . getCFMetaData ( keyspace ( ) , columnFamily ( ) ) . copy ( ) ; 
 List < IndexTarget > targets = new ArrayList < > ( rawTargets . size ( ) ) ; 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / CreateKeyspaceStatement . java b / src / java / org / apache / cassandra / cql3 / statements / CreateKeyspaceStatement . java 
 index 3eb0ac9 . . 787dc73 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / CreateKeyspaceStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / CreateKeyspaceStatement . java 
 @ @ - 92 , 7 + 92 , 7 @ @ public class CreateKeyspaceStatement extends SchemaAlteringStatement 
 throw new ConfigurationException ( " Unable to use given strategy class : LocalStrategy is reserved for internal use . " ) ; 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException 
 { 
 KeyspaceMetadata ksm = KeyspaceMetadata . create ( name , attrs . asNewKeyspaceParams ( ) ) ; 
 try 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / CreateTableStatement . java b / src / java / org / apache / cassandra / cql3 / statements / CreateTableStatement . java 
 index 04f76d3 . . ef950dc 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / CreateTableStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / CreateTableStatement . java 
 @ @ - 80 , 7 + 80 , 7 @ @ public class CreateTableStatement extends SchemaAlteringStatement 
 / / validated in announceMigration ( ) 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException 
 { 
 try 
 { 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / CreateTriggerStatement . java b / src / java / org / apache / cassandra / cql3 / statements / CreateTriggerStatement . java 
 index 94cfc15 . . 5d29996 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / CreateTriggerStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / CreateTriggerStatement . java 
 @ @ - 31 , 6 + 31 , 7 @ @ import org . apache . cassandra . schema . TriggerMetadata ; 
 import org . apache . cassandra . schema . Triggers ; 
 import org . apache . cassandra . service . ClientState ; 
 import org . apache . cassandra . service . MigrationManager ; 
 + import org . apache . cassandra . service . QueryState ; 
 import org . apache . cassandra . thrift . ThriftValidation ; 
 import org . apache . cassandra . transport . Event ; 
 import org . apache . cassandra . triggers . TriggerExecutor ; 
 @ @ - 72 , 7 + 73 , 7 @ @ public class CreateTriggerStatement extends SchemaAlteringStatement 
 } 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws ConfigurationException , InvalidRequestException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws ConfigurationException , InvalidRequestException 
 { 
 CFMetaData cfm = Schema . instance . getCFMetaData ( keyspace ( ) , columnFamily ( ) ) . copy ( ) ; 
 Triggers triggers = cfm . getTriggers ( ) ; 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / CreateTypeStatement . java b / src / java / org / apache / cassandra / cql3 / statements / CreateTypeStatement . java 
 index f62b9ea . . e7f8feb 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / CreateTypeStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / CreateTypeStatement . java 
 @ @ - 30 , 6 + 30 , 7 @ @ import org . apache . cassandra . exceptions . * ; 
 import org . apache . cassandra . schema . KeyspaceMetadata ; 
 import org . apache . cassandra . service . ClientState ; 
 import org . apache . cassandra . service . MigrationManager ; 
 + import org . apache . cassandra . service . QueryState ; 
 import org . apache . cassandra . transport . Event ; 
 
 public class CreateTypeStatement extends SchemaAlteringStatement 
 @ @ - 112 , 7 + 113 , 7 @ @ public class CreateTypeStatement extends SchemaAlteringStatement 
 return new UserType ( name . getKeyspace ( ) , name . getUserTypeName ( ) , names , types ) ; 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException 
 { 
 KeyspaceMetadata ksm = Schema . instance . getKSMetaData ( name . getKeyspace ( ) ) ; 
 assert ksm ! = null ; / / should haven ' t validate otherwise 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / CreateViewStatement . java b / src / java / org / apache / cassandra / cql3 / statements / CreateViewStatement . java 
 index 30e55a0 . . 708d551 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / CreateViewStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / CreateViewStatement . java 
 @ @ - 43 , 6 + 43 , 7 @ @ import org . apache . cassandra . schema . TableParams ; 
 import org . apache . cassandra . service . ClientState ; 
 import org . apache . cassandra . service . ClientWarn ; 
 import org . apache . cassandra . service . MigrationManager ; 
 + import org . apache . cassandra . service . QueryState ; 
 import org . apache . cassandra . thrift . ThriftValidation ; 
 import org . apache . cassandra . transport . Event ; 
 
 @ @ - 111 , 7 + 112 , 7 @ @ public class CreateViewStatement extends SchemaAlteringStatement 
 } 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException 
 { 
 / / We need to make sure that : 
 / / - primary key includes all columns in base table ' s primary key 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / DropAggregateStatement . java b / src / java / org / apache / cassandra / cql3 / statements / DropAggregateStatement . java 
 index 2b1432b . . ae8ad8c 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / DropAggregateStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / DropAggregateStatement . java 
 @ @ - 31 , 6 + 31 , 7 @ @ import org . apache . cassandra . exceptions . RequestValidationException ; 
 import org . apache . cassandra . exceptions . UnauthorizedException ; 
 import org . apache . cassandra . service . ClientState ; 
 import org . apache . cassandra . service . MigrationManager ; 
 + import org . apache . cassandra . service . QueryState ; 
 import org . apache . cassandra . thrift . ThriftValidation ; 
 import org . apache . cassandra . transport . Event ; 
 
 @ @ - 77 , 7 + 78 , 7 @ @ public final class DropAggregateStatement extends SchemaAlteringStatement 
 { 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException 
 { 
 Collection < Function > olds = Schema . instance . getFunctions ( functionName ) ; 
 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / DropFunctionStatement . java b / src / java / org / apache / cassandra / cql3 / statements / DropFunctionStatement . java 
 index 6f11f9c . . 138691e 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / DropFunctionStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / DropFunctionStatement . java 
 @ @ - 35 , 6 + 35 , 7 @ @ import org . apache . cassandra . exceptions . UnauthorizedException ; 
 import org . apache . cassandra . schema . KeyspaceMetadata ; 
 import org . apache . cassandra . service . ClientState ; 
 import org . apache . cassandra . service . MigrationManager ; 
 + import org . apache . cassandra . service . QueryState ; 
 import org . apache . cassandra . thrift . ThriftValidation ; 
 import org . apache . cassandra . transport . Event ; 
 
 @ @ - 127 , 7 + 128 , 7 @ @ public final class DropFunctionStatement extends SchemaAlteringStatement 
 functionName , functionName , functionName ) ) ; 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException 
 { 
 Function old = findFunction ( ) ; 
 if ( old = = null ) 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / DropIndexStatement . java b / src / java / org / apache / cassandra / cql3 / statements / DropIndexStatement . java 
 index 85f5f0d . . 35aee3c 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / DropIndexStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / DropIndexStatement . java 
 @ @ - 66 , 11 + 66 , 11 @ @ public class DropIndexStatement extends SchemaAlteringStatement 
 @ Override 
 public ResultMessage execute ( QueryState state , QueryOptions options ) throws RequestValidationException 
 { 
 - Event . SchemaChange ce = announceMigration ( false ) ; 
 + Event . SchemaChange ce = announceMigration ( state , false ) ; 
 return ce = = null ? null : new ResultMessage . SchemaChange ( ce ) ; 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException 
 { 
 CFMetaData cfm = lookupIndexedTable ( ) ; 
 if ( cfm = = null ) 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / DropKeyspaceStatement . java b / src / java / org / apache / cassandra / cql3 / statements / DropKeyspaceStatement . java 
 index 513ff1b . . 9ba68a6 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / DropKeyspaceStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / DropKeyspaceStatement . java 
 @ @ - 24 , 6 + 24 , 7 @ @ import org . apache . cassandra . auth . Permission ; 
 import org . apache . cassandra . exceptions . UnauthorizedException ; 
 import org . apache . cassandra . service . ClientState ; 
 import org . apache . cassandra . service . MigrationManager ; 
 + import org . apache . cassandra . service . QueryState ; 
 import org . apache . cassandra . thrift . ThriftValidation ; 
 import org . apache . cassandra . transport . Event ; 
 
 @ @ - 55 , 7 + 56 , 7 @ @ public class DropKeyspaceStatement extends SchemaAlteringStatement 
 return keyspace ; 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws ConfigurationException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws ConfigurationException 
 { 
 try 
 { 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / DropTableStatement . java b / src / java / org / apache / cassandra / cql3 / statements / DropTableStatement . java 
 index 8e18cad . . 5641185 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / DropTableStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / DropTableStatement . java 
 @ @ - 28 , 6 + 28 , 7 @ @ import org . apache . cassandra . exceptions . UnauthorizedException ; 
 import org . apache . cassandra . schema . KeyspaceMetadata ; 
 import org . apache . cassandra . service . ClientState ; 
 import org . apache . cassandra . service . MigrationManager ; 
 + import org . apache . cassandra . service . QueryState ; 
 import org . apache . cassandra . transport . Event ; 
 
 public class DropTableStatement extends SchemaAlteringStatement 
 @ @ - 58 , 7 + 59 , 7 @ @ public class DropTableStatement extends SchemaAlteringStatement 
 / / validated in announceMigration ( ) 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws ConfigurationException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws ConfigurationException 
 { 
 try 
 { 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / DropTriggerStatement . java b / src / java / org / apache / cassandra / cql3 / statements / DropTriggerStatement . java 
 index 3f61e01 . . 162c736 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / DropTriggerStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / DropTriggerStatement . java 
 @ @ - 30 , 6 + 30 , 7 @ @ import org . apache . cassandra . exceptions . UnauthorizedException ; 
 import org . apache . cassandra . schema . Triggers ; 
 import org . apache . cassandra . service . ClientState ; 
 import org . apache . cassandra . service . MigrationManager ; 
 + import org . apache . cassandra . service . QueryState ; 
 import org . apache . cassandra . thrift . ThriftValidation ; 
 import org . apache . cassandra . transport . Event ; 
 
 @ @ - 58 , 7 + 59 , 7 @ @ public class DropTriggerStatement extends SchemaAlteringStatement 
 ThriftValidation . validateColumnFamily ( keyspace ( ) , columnFamily ( ) ) ; 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws ConfigurationException , InvalidRequestException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws ConfigurationException , InvalidRequestException 
 { 
 CFMetaData cfm = Schema . instance . getCFMetaData ( keyspace ( ) , columnFamily ( ) ) . copy ( ) ; 
 Triggers triggers = cfm . getTriggers ( ) ; 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / DropTypeStatement . java b / src / java / org / apache / cassandra / cql3 / statements / DropTypeStatement . java 
 index 00988af . . cd6daae 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / DropTypeStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / DropTypeStatement . java 
 @ @ - 26 , 6 + 26 , 7 @ @ import org . apache . cassandra . exceptions . * ; 
 import org . apache . cassandra . schema . KeyspaceMetadata ; 
 import org . apache . cassandra . service . ClientState ; 
 import org . apache . cassandra . service . MigrationManager ; 
 + import org . apache . cassandra . service . QueryState ; 
 import org . apache . cassandra . transport . Event ; 
 
 public class DropTypeStatement extends SchemaAlteringStatement 
 @ @ - 103 , 7 + 104 , 7 @ @ public class DropTypeStatement extends SchemaAlteringStatement 
 return name . getKeyspace ( ) ; 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException 
 { 
 KeyspaceMetadata ksm = Schema . instance . getKSMetaData ( name . getKeyspace ( ) ) ; 
 if ( ksm = = null ) 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / DropViewStatement . java b / src / java / org / apache / cassandra / cql3 / statements / DropViewStatement . java 
 index 1f53ac4 . . b65c1b0 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / DropViewStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / DropViewStatement . java 
 @ @ - 29 , 6 + 29 , 7 @ @ import org . apache . cassandra . exceptions . InvalidRequestException ; 
 import org . apache . cassandra . exceptions . UnauthorizedException ; 
 import org . apache . cassandra . service . ClientState ; 
 import org . apache . cassandra . service . MigrationManager ; 
 + import org . apache . cassandra . service . QueryState ; 
 import org . apache . cassandra . transport . Event ; 
 
 public class DropViewStatement extends SchemaAlteringStatement 
 @ @ - 53 , 7 + 54 , 7 @ @ public class DropViewStatement extends SchemaAlteringStatement 
 / / validated in findIndexedCf ( ) 
 } 
 
 - public Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException 
 + public Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws InvalidRequestException , ConfigurationException 
 { 
 try 
 { 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / SchemaAlteringStatement . java b / src / java / org / apache / cassandra / cql3 / statements / SchemaAlteringStatement . java 
 index 10c004c . . 62ba0ae 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / SchemaAlteringStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / SchemaAlteringStatement . java 
 @ @ - 84 , 13 + 84 , 13 @ @ public abstract class SchemaAlteringStatement extends CFStatement implements CQL 
 * 
 * @ throws RequestValidationException 
 * / 
 - public abstract Event . SchemaChange announceMigration ( boolean isLocalOnly ) throws RequestValidationException ; 
 + protected abstract Event . SchemaChange announceMigration ( QueryState queryState , boolean isLocalOnly ) throws RequestValidationException ; 
 
 public ResultMessage execute ( QueryState state , QueryOptions options ) throws RequestValidationException 
 { 
 / / If an IF [ NOT ] EXISTS clause was used , this may not result in an actual schema change . To avoid doing 
 / / extra work in the drivers to handle schema changes , we return an empty message in this case . ( CASSANDRA - 7600 ) 
 - Event . SchemaChange ce = announceMigration ( false ) ; 
 + Event . SchemaChange ce = announceMigration ( state , false ) ; 
 if ( ce = = null ) 
 return new ResultMessage . Void ( ) ; 
 
 @ @ - 117 , 7 + 117 , 7 @ @ public abstract class SchemaAlteringStatement extends CFStatement implements CQL 
 
 public ResultMessage executeInternal ( QueryState state , QueryOptions options ) 
 { 
 - Event . SchemaChange ce = announceMigration ( true ) ; 
 + Event . SchemaChange ce = announceMigration ( state , true ) ; 
 return ce = = null ? new ResultMessage . Void ( ) : new ResultMessage . SchemaChange ( ce ) ; 
 } 
 }

NEAREST DIFF:
ELIMINATEDSENTENCE
