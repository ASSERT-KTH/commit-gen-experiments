BLEU SCORE: 0.018543295278285157

TEST MSG: Make sure repair history actually gets persisted
GENERATED MSG: p / 4443 / 050 _ process _ queued _ xfers

TEST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / cql3 / QueryProcessor . java b / src / java / org / apache / cassandra / cql3 / QueryProcessor . java <nl> index 3170932 . . a071eb9 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / QueryProcessor . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / QueryProcessor . java <nl> @ @ - 263 , 7 + 263 , 12 @ @ public class QueryProcessor implements QueryHandler <nl> <nl> public static UntypedResultSet process ( String query , ConsistencyLevel cl ) throws RequestExecutionException <nl> { <nl> - ResultMessage result = instance . process ( query , QueryState . forInternalCalls ( ) , QueryOptions . forInternalCalls ( cl , Collections . < ByteBuffer > emptyList ( ) ) ) ; <nl> + return process ( query , cl , Collections . < ByteBuffer > emptyList ( ) ) ; <nl> + } <nl> + <nl> + public static UntypedResultSet process ( String query , ConsistencyLevel cl , List < ByteBuffer > values ) throws RequestExecutionException <nl> + { <nl> + ResultMessage result = instance . process ( query , QueryState . forInternalCalls ( ) , QueryOptions . forInternalCalls ( cl , values ) ) ; <nl> if ( result instanceof ResultMessage . Rows ) <nl> return UntypedResultSet . create ( ( ( ResultMessage . Rows ) result ) . result ) ; <nl> else <nl> diff - - git a / src / java / org / apache / cassandra / repair / SystemDistributedKeyspace . java b / src / java / org / apache / cassandra / repair / SystemDistributedKeyspace . java <nl> index 1969cc5 . . 0f4bde8 100644 <nl> - - - a / src / java / org / apache / cassandra / repair / SystemDistributedKeyspace . java <nl> + + + b / src / java / org / apache / cassandra / repair / SystemDistributedKeyspace . java <nl> @ @ - 20 , 6 + 20 , 8 @ @ package org . apache . cassandra . repair ; <nl> import java . io . PrintWriter ; <nl> import java . io . StringWriter ; <nl> import java . net . InetAddress ; <nl> + import java . nio . ByteBuffer ; <nl> + import java . util . ArrayList ; <nl> import java . util . Arrays ; <nl> import java . util . Collection ; <nl> import java . util . List ; <nl> @ @ - 36 , 9 + 38 , 11 @ @ import org . slf4j . LoggerFactory ; <nl> import org . apache . cassandra . config . CFMetaData ; <nl> import org . apache . cassandra . config . KSMetaData ; <nl> import org . apache . cassandra . cql3 . QueryProcessor ; <nl> + import org . apache . cassandra . db . ConsistencyLevel ; <nl> import org . apache . cassandra . dht . Range ; <nl> import org . apache . cassandra . dht . Token ; <nl> import org . apache . cassandra . locator . SimpleStrategy ; <nl> + import org . apache . cassandra . utils . ByteBufferUtil ; <nl> import org . apache . cassandra . utils . FBUtilities ; <nl> <nl> public final class SystemDistributedKeyspace <nl> @ @ - 102 , 8 + 106 , 8 @ @ public final class SystemDistributedKeyspace <nl> <nl> String query = " INSERT INTO % s . % s ( parent _ id , keyspace _ name , columnfamily _ names , requested _ ranges , started _ at ) " + <nl> " VALUES ( % s , ' % s ' , { ' % s ' } , { ' % s ' } , dateOf ( now ( ) ) ) " ; <nl> - String fmtQry = String . format ( query , NAME , PARENT _ REPAIR _ HISTORY , parent _ id . toString ( ) , keyspaceName , Joiner . on ( " ' , ' " ) . join ( ranges ) , Joiner . on ( " ' , ' " ) . join ( cfnames ) ) ; <nl> - executeInternalSilent ( fmtQry ) ; <nl> + String fmtQry = String . format ( query , NAME , PARENT _ REPAIR _ HISTORY , parent _ id . toString ( ) , keyspaceName , Joiner . on ( " ' , ' " ) . join ( cfnames ) , Joiner . on ( " ' , ' " ) . join ( ranges ) ) ; <nl> + processSilent ( fmtQry ) ; <nl> } <nl> <nl> public static void failParentRepair ( UUID parent _ id , Throwable t ) <nl> @ @ - 114 , 14 + 118 , 14 @ @ public final class SystemDistributedKeyspace <nl> PrintWriter pw = new PrintWriter ( sw ) ; <nl> t . printStackTrace ( pw ) ; <nl> String fmtQuery = String . format ( query , NAME , PARENT _ REPAIR _ HISTORY , parent _ id . toString ( ) ) ; <nl> - executeInternalSilent ( fmtQuery , t . getMessage ( ) , sw . toString ( ) ) ; <nl> + processSilent ( fmtQuery , t . getMessage ( ) , sw . toString ( ) ) ; <nl> } <nl> <nl> public static void successfulParentRepair ( UUID parent _ id , Collection < Range < Token > > successfulRanges ) <nl> { <nl> String query = " UPDATE % s . % s SET finished _ at = dateOf ( now ( ) ) , successful _ ranges = { ' % s ' } WHERE parent _ id = % s " ; <nl> String fmtQuery = String . format ( query , NAME , PARENT _ REPAIR _ HISTORY , Joiner . on ( " ' , ' " ) . join ( successfulRanges ) , parent _ id . toString ( ) ) ; <nl> - executeInternalSilent ( fmtQuery ) ; <nl> + processSilent ( fmtQuery ) ; <nl> } <nl> <nl> public static void startRepairs ( UUID id , UUID parent _ id , String keyspaceName , String [ ] cfnames , Range < Token > range , Iterable < InetAddress > endpoints ) <nl> @ @ - 148 , 7 + 152 , 7 @ @ public final class SystemDistributedKeyspace <nl> coordinator , <nl> Joiner . on ( " ' , ' " ) . join ( participants ) , <nl> RepairState . STARTED . toString ( ) ) ; <nl> - executeInternalSilent ( fmtQry ) ; <nl> + processSilent ( fmtQry ) ; <nl> } <nl> } <nl> <nl> @ @ - 166 , 7 + 170 , 7 @ @ public final class SystemDistributedKeyspace <nl> keyspaceName , <nl> cfname , <nl> id . toString ( ) ) ; <nl> - executeInternalSilent ( fmtQuery ) ; <nl> + processSilent ( fmtQuery ) ; <nl> } <nl> <nl> public static void failedRepairJob ( UUID id , String keyspaceName , String cfname , Throwable t ) <nl> @ @ - 180 , 14 + 184 , 19 @ @ public final class SystemDistributedKeyspace <nl> keyspaceName , <nl> cfname , <nl> id . toString ( ) ) ; <nl> - executeInternalSilent ( fmtQry , t . getMessage ( ) , sw . toString ( ) ) ; <nl> + processSilent ( fmtQry , t . getMessage ( ) , sw . toString ( ) ) ; <nl> } <nl> <nl> - private static void executeInternalSilent ( String fmtQry , Object . . . values ) <nl> + private static void processSilent ( String fmtQry , String . . . values ) <nl> { <nl> try <nl> { <nl> - QueryProcessor . executeInternal ( fmtQry , values ) ; <nl> + List < ByteBuffer > valueList = new ArrayList < > ( ) ; <nl> + for ( String v : values ) <nl> + { <nl> + valueList . add ( ByteBufferUtil . bytes ( v ) ) ; <nl> + } <nl> + QueryProcessor . process ( fmtQry , ConsistencyLevel . ONE , valueList ) ; <nl> } <nl> catch ( Throwable t ) <nl> {
NEAREST DIFF (one line): diff - - git a / bin / cqlsh b / bin / cqlsh <nl> index 3bef142 . . 5f99e45 100755 <nl> - - - a / bin / cqlsh <nl> + + + b / bin / cqlsh <nl> @ @ - 2690 , 7 + 2690 , 7 @ @ def setup _ cqlruleset ( cqlmodule ) : <nl> def main ( options , hostname , port ) : <nl> setup _ cqlruleset ( options . cqlmodule ) <nl> <nl> - if os . path . exists ( HISTORY ) and readline is not None : <nl> + if os . path . exists ( HISTORY ) and readline is not None and readline . get _ history _ length ( ) > 0 : <nl> readline . read _ history _ file ( HISTORY ) <nl> delims = readline . get _ completer _ delims ( ) <nl> delims . replace ( " ' " , " " )

TEST DIFF:
diff - - git a / src / java / org / apache / cassandra / cql3 / QueryProcessor . java b / src / java / org / apache / cassandra / cql3 / QueryProcessor . java 
 index 3170932 . . a071eb9 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / QueryProcessor . java 
 + + + b / src / java / org / apache / cassandra / cql3 / QueryProcessor . java 
 @ @ - 263 , 7 + 263 , 12 @ @ public class QueryProcessor implements QueryHandler 
 
 public static UntypedResultSet process ( String query , ConsistencyLevel cl ) throws RequestExecutionException 
 { 
 - ResultMessage result = instance . process ( query , QueryState . forInternalCalls ( ) , QueryOptions . forInternalCalls ( cl , Collections . < ByteBuffer > emptyList ( ) ) ) ; 
 + return process ( query , cl , Collections . < ByteBuffer > emptyList ( ) ) ; 
 + } 
 + 
 + public static UntypedResultSet process ( String query , ConsistencyLevel cl , List < ByteBuffer > values ) throws RequestExecutionException 
 + { 
 + ResultMessage result = instance . process ( query , QueryState . forInternalCalls ( ) , QueryOptions . forInternalCalls ( cl , values ) ) ; 
 if ( result instanceof ResultMessage . Rows ) 
 return UntypedResultSet . create ( ( ( ResultMessage . Rows ) result ) . result ) ; 
 else 
 diff - - git a / src / java / org / apache / cassandra / repair / SystemDistributedKeyspace . java b / src / java / org / apache / cassandra / repair / SystemDistributedKeyspace . java 
 index 1969cc5 . . 0f4bde8 100644 
 - - - a / src / java / org / apache / cassandra / repair / SystemDistributedKeyspace . java 
 + + + b / src / java / org / apache / cassandra / repair / SystemDistributedKeyspace . java 
 @ @ - 20 , 6 + 20 , 8 @ @ package org . apache . cassandra . repair ; 
 import java . io . PrintWriter ; 
 import java . io . StringWriter ; 
 import java . net . InetAddress ; 
 + import java . nio . ByteBuffer ; 
 + import java . util . ArrayList ; 
 import java . util . Arrays ; 
 import java . util . Collection ; 
 import java . util . List ; 
 @ @ - 36 , 9 + 38 , 11 @ @ import org . slf4j . LoggerFactory ; 
 import org . apache . cassandra . config . CFMetaData ; 
 import org . apache . cassandra . config . KSMetaData ; 
 import org . apache . cassandra . cql3 . QueryProcessor ; 
 + import org . apache . cassandra . db . ConsistencyLevel ; 
 import org . apache . cassandra . dht . Range ; 
 import org . apache . cassandra . dht . Token ; 
 import org . apache . cassandra . locator . SimpleStrategy ; 
 + import org . apache . cassandra . utils . ByteBufferUtil ; 
 import org . apache . cassandra . utils . FBUtilities ; 
 
 public final class SystemDistributedKeyspace 
 @ @ - 102 , 8 + 106 , 8 @ @ public final class SystemDistributedKeyspace 
 
 String query = " INSERT INTO % s . % s ( parent _ id , keyspace _ name , columnfamily _ names , requested _ ranges , started _ at ) " + 
 " VALUES ( % s , ' % s ' , { ' % s ' } , { ' % s ' } , dateOf ( now ( ) ) ) " ; 
 - String fmtQry = String . format ( query , NAME , PARENT _ REPAIR _ HISTORY , parent _ id . toString ( ) , keyspaceName , Joiner . on ( " ' , ' " ) . join ( ranges ) , Joiner . on ( " ' , ' " ) . join ( cfnames ) ) ; 
 - executeInternalSilent ( fmtQry ) ; 
 + String fmtQry = String . format ( query , NAME , PARENT _ REPAIR _ HISTORY , parent _ id . toString ( ) , keyspaceName , Joiner . on ( " ' , ' " ) . join ( cfnames ) , Joiner . on ( " ' , ' " ) . join ( ranges ) ) ; 
 + processSilent ( fmtQry ) ; 
 } 
 
 public static void failParentRepair ( UUID parent _ id , Throwable t ) 
 @ @ - 114 , 14 + 118 , 14 @ @ public final class SystemDistributedKeyspace 
 PrintWriter pw = new PrintWriter ( sw ) ; 
 t . printStackTrace ( pw ) ; 
 String fmtQuery = String . format ( query , NAME , PARENT _ REPAIR _ HISTORY , parent _ id . toString ( ) ) ; 
 - executeInternalSilent ( fmtQuery , t . getMessage ( ) , sw . toString ( ) ) ; 
 + processSilent ( fmtQuery , t . getMessage ( ) , sw . toString ( ) ) ; 
 } 
 
 public static void successfulParentRepair ( UUID parent _ id , Collection < Range < Token > > successfulRanges ) 
 { 
 String query = " UPDATE % s . % s SET finished _ at = dateOf ( now ( ) ) , successful _ ranges = { ' % s ' } WHERE parent _ id = % s " ; 
 String fmtQuery = String . format ( query , NAME , PARENT _ REPAIR _ HISTORY , Joiner . on ( " ' , ' " ) . join ( successfulRanges ) , parent _ id . toString ( ) ) ; 
 - executeInternalSilent ( fmtQuery ) ; 
 + processSilent ( fmtQuery ) ; 
 } 
 
 public static void startRepairs ( UUID id , UUID parent _ id , String keyspaceName , String [ ] cfnames , Range < Token > range , Iterable < InetAddress > endpoints ) 
 @ @ - 148 , 7 + 152 , 7 @ @ public final class SystemDistributedKeyspace 
 coordinator , 
 Joiner . on ( " ' , ' " ) . join ( participants ) , 
 RepairState . STARTED . toString ( ) ) ; 
 - executeInternalSilent ( fmtQry ) ; 
 + processSilent ( fmtQry ) ; 
 } 
 } 
 
 @ @ - 166 , 7 + 170 , 7 @ @ public final class SystemDistributedKeyspace 
 keyspaceName , 
 cfname , 
 id . toString ( ) ) ; 
 - executeInternalSilent ( fmtQuery ) ; 
 + processSilent ( fmtQuery ) ; 
 } 
 
 public static void failedRepairJob ( UUID id , String keyspaceName , String cfname , Throwable t ) 
 @ @ - 180 , 14 + 184 , 19 @ @ public final class SystemDistributedKeyspace 
 keyspaceName , 
 cfname , 
 id . toString ( ) ) ; 
 - executeInternalSilent ( fmtQry , t . getMessage ( ) , sw . toString ( ) ) ; 
 + processSilent ( fmtQry , t . getMessage ( ) , sw . toString ( ) ) ; 
 } 
 
 - private static void executeInternalSilent ( String fmtQry , Object . . . values ) 
 + private static void processSilent ( String fmtQry , String . . . values ) 
 { 
 try 
 { 
 - QueryProcessor . executeInternal ( fmtQry , values ) ; 
 + List < ByteBuffer > valueList = new ArrayList < > ( ) ; 
 + for ( String v : values ) 
 + { 
 + valueList . add ( ByteBufferUtil . bytes ( v ) ) ; 
 + } 
 + QueryProcessor . process ( fmtQry , ConsistencyLevel . ONE , valueList ) ; 
 } 
 catch ( Throwable t ) 
 {

NEAREST DIFF:
diff - - git a / bin / cqlsh b / bin / cqlsh 
 index 3bef142 . . 5f99e45 100755 
 - - - a / bin / cqlsh 
 + + + b / bin / cqlsh 
 @ @ - 2690 , 7 + 2690 , 7 @ @ def setup _ cqlruleset ( cqlmodule ) : 
 def main ( options , hostname , port ) : 
 setup _ cqlruleset ( options . cqlmodule ) 
 
 - if os . path . exists ( HISTORY ) and readline is not None : 
 + if os . path . exists ( HISTORY ) and readline is not None and readline . get _ history _ length ( ) > 0 : 
 readline . read _ history _ file ( HISTORY ) 
 delims = readline . get _ completer _ delims ( ) 
 delims . replace ( " ' " , " " )
