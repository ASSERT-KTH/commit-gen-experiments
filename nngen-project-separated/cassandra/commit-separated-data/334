BLEU SCORE: 0.014199193612838947

TEST MSG: Fix ALTER TABLE statement to atomically propagate changes to the table and its MVs
GENERATED MSG: Invalidate prepared statements when indexes are modified

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 5e6d189 . . 5e95b75 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 3 . 0 . 15 <nl> + * Fix ALTER TABLE statement to atomically propagate changes to the table and its MVs ( CASSANDRA - 12952 ) <nl> * Fixed ambiguous output of nodetool tablestats command ( CASSANDRA - 13722 ) <nl> * JMXEnabledThreadPoolExecutor with corePoolSize equal to maxPoolSize ( Backport CASSANDRA - 13329 ) <nl> * Fix Digest mismatch Exception if hints file has UnknownColumnFamily ( CASSANDRA - 13696 ) <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / AlterTableStatement . java b / src / java / org / apache / cassandra / cql3 / statements / AlterTableStatement . java <nl> index 756bb96 . . 5db4b9f 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / AlterTableStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / AlterTableStatement . java <nl> @ @ - 297 , 13 + 297 , 7 @ @ public class AlterTableStatement extends SchemaAlteringStatement <nl> break ; <nl> } <nl> <nl> - MigrationManager . announceColumnFamilyUpdate ( cfm , isLocalOnly ) ; <nl> - <nl> - if ( viewUpdates ! = null ) <nl> - { <nl> - for ( ViewDefinition viewUpdate : viewUpdates ) <nl> - MigrationManager . announceViewUpdate ( viewUpdate , isLocalOnly ) ; <nl> - } <nl> + MigrationManager . announceColumnFamilyUpdate ( cfm , viewUpdates , isLocalOnly ) ; <nl> return new Event . SchemaChange ( Event . SchemaChange . Change . UPDATED , Event . SchemaChange . Target . TABLE , keyspace ( ) , columnFamily ( ) ) ; <nl> } <nl> <nl> diff - - git a / src / java / org / apache / cassandra / schema / SchemaKeyspace . java b / src / java / org / apache / cassandra / schema / SchemaKeyspace . java <nl> index 8719b2f . . 63017ec 100644 <nl> - - - a / src / java / org / apache / cassandra / schema / SchemaKeyspace . java <nl> + + + b / src / java / org / apache / cassandra / schema / SchemaKeyspace . java <nl> @ @ - 731 , 13 + 731 , 11 @ @ public final class SchemaKeyspace <nl> return mutation ; <nl> } <nl> <nl> - public static Mutation makeUpdateViewMutation ( KeyspaceMetadata keyspace , <nl> + public static Mutation makeUpdateViewMutation ( Mutation mutation , <nl> ViewDefinition oldView , <nl> ViewDefinition newView , <nl> long timestamp ) <nl> { <nl> - Mutation mutation = makeCreateKeyspaceMutation ( keyspace . name , keyspace . params , timestamp ) ; <nl> - <nl> addViewToSchemaMutation ( newView , timestamp , false , mutation ) ; <nl> <nl> MapDifference < ByteBuffer , ColumnDefinition > columnDiff = Maps . difference ( oldView . metadata . getColumnMetadata ( ) , <nl> diff - - git a / src / java / org / apache / cassandra / service / MigrationManager . java b / src / java / org / apache / cassandra / service / MigrationManager . java <nl> index 7b7cd8f . . b4893a9 100644 <nl> - - - a / src / java / org / apache / cassandra / service / MigrationManager . java <nl> + + + b / src / java / org / apache / cassandra / service / MigrationManager . java <nl> @ @ - 413 , 6 + 413 , 11 @ @ public class MigrationManager <nl> <nl> public static void announceColumnFamilyUpdate ( CFMetaData cfm , boolean announceLocally ) throws ConfigurationException <nl> { <nl> + announceColumnFamilyUpdate ( cfm , null , announceLocally ) ; <nl> + } <nl> + <nl> + public static void announceColumnFamilyUpdate ( CFMetaData cfm , Collection < ViewDefinition > views , boolean announceLocally ) throws ConfigurationException <nl> + { <nl> cfm . validate ( ) ; <nl> <nl> CFMetaData oldCfm = Schema . instance . getCFMetaData ( cfm . ksName , cfm . cfName ) ; <nl> @ @ - 422 , 23 + 427 , 38 @ @ public class MigrationManager <nl> <nl> oldCfm . validateCompatibility ( cfm ) ; <nl> <nl> + long timestamp = FBUtilities . timestampMicros ( ) ; <nl> + <nl> logger . info ( String . format ( " Update table ' % s / % s ' From % s To % s " , cfm . ksName , cfm . cfName , oldCfm , cfm ) ) ; <nl> - announce ( SchemaKeyspace . makeUpdateTableMutation ( ksm , oldCfm , cfm , FBUtilities . timestampMicros ( ) ) , announceLocally ) ; <nl> + Mutation mutation = SchemaKeyspace . makeUpdateTableMutation ( ksm , oldCfm , cfm , timestamp ) ; <nl> + <nl> + if ( views ! = null ) <nl> + views . forEach ( view - > addViewUpdateToMutation ( view , mutation , timestamp ) ) ; <nl> + <nl> + announce ( mutation , announceLocally ) ; <nl> } <nl> <nl> public static void announceViewUpdate ( ViewDefinition view , boolean announceLocally ) throws ConfigurationException <nl> { <nl> + KeyspaceMetadata ksm = Schema . instance . getKSMetaData ( view . ksName ) ; <nl> + long timestamp = FBUtilities . timestampMicros ( ) ; <nl> + Mutation mutation = SchemaKeyspace . makeCreateKeyspaceMutation ( ksm . name , ksm . params , timestamp ) ; <nl> + addViewUpdateToMutation ( view , mutation , timestamp ) ; <nl> + announce ( mutation , announceLocally ) ; <nl> + } <nl> + <nl> + private static void addViewUpdateToMutation ( ViewDefinition view , Mutation mutation , long timestamp ) <nl> + { <nl> view . metadata . validate ( ) ; <nl> <nl> ViewDefinition oldView = Schema . instance . getView ( view . ksName , view . viewName ) ; <nl> if ( oldView = = null ) <nl> throw new ConfigurationException ( String . format ( " Cannot update non existing materialized view ' % s ' in keyspace ' % s ' . " , view . viewName , view . ksName ) ) ; <nl> - KeyspaceMetadata ksm = Schema . instance . getKSMetaData ( view . ksName ) ; <nl> <nl> oldView . metadata . validateCompatibility ( view . metadata ) ; <nl> <nl> logger . info ( String . format ( " Update view ' % s / % s ' From % s To % s " , view . ksName , view . viewName , oldView , view ) ) ; <nl> - announce ( SchemaKeyspace . makeUpdateViewMutation ( ksm , oldView , view , FBUtilities . timestampMicros ( ) ) , announceLocally ) ; <nl> + SchemaKeyspace . makeUpdateViewMutation ( mutation , oldView , view , timestamp ) ; <nl> } <nl> <nl> public static void announceTypeUpdate ( UserType updatedType , boolean announceLocally )
NEAREST DIFF (one line): ELIMINATEDSENTENCE

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 5e6d189 . . 5e95b75 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 3 . 0 . 15 
 + * Fix ALTER TABLE statement to atomically propagate changes to the table and its MVs ( CASSANDRA - 12952 ) 
 * Fixed ambiguous output of nodetool tablestats command ( CASSANDRA - 13722 ) 
 * JMXEnabledThreadPoolExecutor with corePoolSize equal to maxPoolSize ( Backport CASSANDRA - 13329 ) 
 * Fix Digest mismatch Exception if hints file has UnknownColumnFamily ( CASSANDRA - 13696 ) 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / AlterTableStatement . java b / src / java / org / apache / cassandra / cql3 / statements / AlterTableStatement . java 
 index 756bb96 . . 5db4b9f 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / AlterTableStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / AlterTableStatement . java 
 @ @ - 297 , 13 + 297 , 7 @ @ public class AlterTableStatement extends SchemaAlteringStatement 
 break ; 
 } 
 
 - MigrationManager . announceColumnFamilyUpdate ( cfm , isLocalOnly ) ; 
 - 
 - if ( viewUpdates ! = null ) 
 - { 
 - for ( ViewDefinition viewUpdate : viewUpdates ) 
 - MigrationManager . announceViewUpdate ( viewUpdate , isLocalOnly ) ; 
 - } 
 + MigrationManager . announceColumnFamilyUpdate ( cfm , viewUpdates , isLocalOnly ) ; 
 return new Event . SchemaChange ( Event . SchemaChange . Change . UPDATED , Event . SchemaChange . Target . TABLE , keyspace ( ) , columnFamily ( ) ) ; 
 } 
 
 diff - - git a / src / java / org / apache / cassandra / schema / SchemaKeyspace . java b / src / java / org / apache / cassandra / schema / SchemaKeyspace . java 
 index 8719b2f . . 63017ec 100644 
 - - - a / src / java / org / apache / cassandra / schema / SchemaKeyspace . java 
 + + + b / src / java / org / apache / cassandra / schema / SchemaKeyspace . java 
 @ @ - 731 , 13 + 731 , 11 @ @ public final class SchemaKeyspace 
 return mutation ; 
 } 
 
 - public static Mutation makeUpdateViewMutation ( KeyspaceMetadata keyspace , 
 + public static Mutation makeUpdateViewMutation ( Mutation mutation , 
 ViewDefinition oldView , 
 ViewDefinition newView , 
 long timestamp ) 
 { 
 - Mutation mutation = makeCreateKeyspaceMutation ( keyspace . name , keyspace . params , timestamp ) ; 
 - 
 addViewToSchemaMutation ( newView , timestamp , false , mutation ) ; 
 
 MapDifference < ByteBuffer , ColumnDefinition > columnDiff = Maps . difference ( oldView . metadata . getColumnMetadata ( ) , 
 diff - - git a / src / java / org / apache / cassandra / service / MigrationManager . java b / src / java / org / apache / cassandra / service / MigrationManager . java 
 index 7b7cd8f . . b4893a9 100644 
 - - - a / src / java / org / apache / cassandra / service / MigrationManager . java 
 + + + b / src / java / org / apache / cassandra / service / MigrationManager . java 
 @ @ - 413 , 6 + 413 , 11 @ @ public class MigrationManager 
 
 public static void announceColumnFamilyUpdate ( CFMetaData cfm , boolean announceLocally ) throws ConfigurationException 
 { 
 + announceColumnFamilyUpdate ( cfm , null , announceLocally ) ; 
 + } 
 + 
 + public static void announceColumnFamilyUpdate ( CFMetaData cfm , Collection < ViewDefinition > views , boolean announceLocally ) throws ConfigurationException 
 + { 
 cfm . validate ( ) ; 
 
 CFMetaData oldCfm = Schema . instance . getCFMetaData ( cfm . ksName , cfm . cfName ) ; 
 @ @ - 422 , 23 + 427 , 38 @ @ public class MigrationManager 
 
 oldCfm . validateCompatibility ( cfm ) ; 
 
 + long timestamp = FBUtilities . timestampMicros ( ) ; 
 + 
 logger . info ( String . format ( " Update table ' % s / % s ' From % s To % s " , cfm . ksName , cfm . cfName , oldCfm , cfm ) ) ; 
 - announce ( SchemaKeyspace . makeUpdateTableMutation ( ksm , oldCfm , cfm , FBUtilities . timestampMicros ( ) ) , announceLocally ) ; 
 + Mutation mutation = SchemaKeyspace . makeUpdateTableMutation ( ksm , oldCfm , cfm , timestamp ) ; 
 + 
 + if ( views ! = null ) 
 + views . forEach ( view - > addViewUpdateToMutation ( view , mutation , timestamp ) ) ; 
 + 
 + announce ( mutation , announceLocally ) ; 
 } 
 
 public static void announceViewUpdate ( ViewDefinition view , boolean announceLocally ) throws ConfigurationException 
 { 
 + KeyspaceMetadata ksm = Schema . instance . getKSMetaData ( view . ksName ) ; 
 + long timestamp = FBUtilities . timestampMicros ( ) ; 
 + Mutation mutation = SchemaKeyspace . makeCreateKeyspaceMutation ( ksm . name , ksm . params , timestamp ) ; 
 + addViewUpdateToMutation ( view , mutation , timestamp ) ; 
 + announce ( mutation , announceLocally ) ; 
 + } 
 + 
 + private static void addViewUpdateToMutation ( ViewDefinition view , Mutation mutation , long timestamp ) 
 + { 
 view . metadata . validate ( ) ; 
 
 ViewDefinition oldView = Schema . instance . getView ( view . ksName , view . viewName ) ; 
 if ( oldView = = null ) 
 throw new ConfigurationException ( String . format ( " Cannot update non existing materialized view ' % s ' in keyspace ' % s ' . " , view . viewName , view . ksName ) ) ; 
 - KeyspaceMetadata ksm = Schema . instance . getKSMetaData ( view . ksName ) ; 
 
 oldView . metadata . validateCompatibility ( view . metadata ) ; 
 
 logger . info ( String . format ( " Update view ' % s / % s ' From % s To % s " , view . ksName , view . viewName , oldView , view ) ) ; 
 - announce ( SchemaKeyspace . makeUpdateViewMutation ( ksm , oldView , view , FBUtilities . timestampMicros ( ) ) , announceLocally ) ; 
 + SchemaKeyspace . makeUpdateViewMutation ( mutation , oldView , view , timestamp ) ; 
 } 
 
 public static void announceTypeUpdate ( UserType updatedType , boolean announceLocally )

NEAREST DIFF:
ELIMINATEDSENTENCE
