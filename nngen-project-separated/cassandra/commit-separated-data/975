BLEU SCORE: 0.020980574531482755

TEST MSG: Fix intra - node serialization issue for multicolumn - restrictions
GENERATED MSG: merge from 2 . 1

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 045b867 . . 87bb0c0 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 2 . 2 . 6 <nl> + * Fix intra - node serialization issue for multicolumn - restrictions ( CASSANDRA - 11196 ) <nl> * Non - obsoleting compaction operations over compressed files can impose rate limit on normal reads ( CASSANDRA - 11301 ) <nl> * Add missing newline at end of bin / cqlsh ( CASSANDRA - 11325 ) <nl> * Fix AE in nodetool cfstats ( backport CASSANDRA - 10859 ) ( CASSANDRA - 11297 ) <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / restrictions / PrimaryKeyRestrictionSet . java b / src / java / org / apache / cassandra / cql3 / restrictions / PrimaryKeyRestrictionSet . java <nl> index 936dbd6 . . 7ce228c 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / restrictions / PrimaryKeyRestrictionSet . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / restrictions / PrimaryKeyRestrictionSet . java <nl> @ @ - 20 , 6 + 20 , 8 @ @ package org . apache . cassandra . cql3 . restrictions ; <nl> import java . nio . ByteBuffer ; <nl> import java . util . * ; <nl> <nl> + import com . google . common . collect . Lists ; <nl> + <nl> import org . apache . cassandra . db . composites . Composite ; <nl> import org . apache . cassandra . config . ColumnDefinition ; <nl> import org . apache . cassandra . cql3 . QueryOptions ; <nl> @ @ - 201 , 7 + 203 , 24 @ @ final class PrimaryKeyRestrictionSet extends AbstractPrimaryKeyRestrictions <nl> if ( r . isSlice ( ) ) <nl> { <nl> r . appendBoundTo ( builder , bound , options ) ; <nl> - return filterAndSort ( setEocs ( r , bound , builder . build ( ) ) ) ; <nl> + <nl> + / / Since CASSANDRA - 7281 , the composites might not end with the same components and it is possible <nl> + / / that one of the composites is an empty one . Unfortunatly , AbstractCType will always sort <nl> + / / Composites . EMPTY before all the other components due to its EOC , even if it is not the desired <nl> + / / behaviour in some cases . To avoid that problem the code will use normal composites for the empty <nl> + / / ones until the composites are properly sorted . They will then be replaced by Composites . EMPTY as <nl> + / / it is what is expected by the intra - node serialization . <nl> + / / It is clearly a hack but it does not make a lot of sense to refactor 2 . 2 for that as the problem is <nl> + / / already solved in 3 . 0 . <nl> + List < Composite > composites = filterAndSort ( setEocs ( r , bound , builder . build ( ) ) ) ; <nl> + return Lists . transform ( composites , new com . google . common . base . Function < Composite , Composite > ( ) <nl> + { <nl> + @ Override <nl> + public Composite apply ( Composite composite ) <nl> + { <nl> + return composite . isEmpty ( ) ? Composites . EMPTY : composite ; <nl> + } <nl> + } ) ; <nl> } <nl> <nl> r . appendBoundTo ( builder , bound , options ) ; <nl> @ @ - 234 , 6 + 253 , 7 @ @ final class PrimaryKeyRestrictionSet extends AbstractPrimaryKeyRestrictions <nl> <nl> TreeSet < Composite > set = new TreeSet < Composite > ( ctype ) ; <nl> set . addAll ( composites ) ; <nl> + <nl> return new ArrayList < > ( set ) ; <nl> } <nl> <nl> diff - - git a / test / unit / org / apache / cassandra / cql3 / restrictions / PrimaryKeyRestrictionSetTest . java b / test / unit / org / apache / cassandra / cql3 / restrictions / PrimaryKeyRestrictionSetTest . java <nl> index 1deeb9e . . bf5128f 100644 <nl> - - - a / test / unit / org / apache / cassandra / cql3 / restrictions / PrimaryKeyRestrictionSetTest . java <nl> + + + b / test / unit / org / apache / cassandra / cql3 / restrictions / PrimaryKeyRestrictionSetTest . java <nl> @ @ - 31 , 6 + 31 , 7 @ @ import org . apache . cassandra . cql3 . statements . Bound ; <nl> import org . apache . cassandra . db . ColumnFamilyType ; <nl> import org . apache . cassandra . db . composites . Composite ; <nl> import org . apache . cassandra . db . composites . Composite . EOC ; <nl> + import org . apache . cassandra . db . composites . Composites ; <nl> import org . apache . cassandra . db . composites . CompoundSparseCellNameType ; <nl> import org . apache . cassandra . db . marshal . AbstractType ; <nl> import org . apache . cassandra . db . marshal . Int32Type ; <nl> @ @ - 1682 , 7 + 1683 , 7 @ @ public class PrimaryKeyRestrictionSetTest <nl> * / <nl> private static void assertEmptyComposite ( Composite composite ) <nl> { <nl> - assertTrue ( composite . isEmpty ( ) ) ; <nl> + assertEquals ( Composites . EMPTY , composite ) ; <nl> } <nl> <nl> / * *
NEAREST DIFF (one line): ELIMINATEDSENTENCE

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 045b867 . . 87bb0c0 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 2 . 2 . 6 
 + * Fix intra - node serialization issue for multicolumn - restrictions ( CASSANDRA - 11196 ) 
 * Non - obsoleting compaction operations over compressed files can impose rate limit on normal reads ( CASSANDRA - 11301 ) 
 * Add missing newline at end of bin / cqlsh ( CASSANDRA - 11325 ) 
 * Fix AE in nodetool cfstats ( backport CASSANDRA - 10859 ) ( CASSANDRA - 11297 ) 
 diff - - git a / src / java / org / apache / cassandra / cql3 / restrictions / PrimaryKeyRestrictionSet . java b / src / java / org / apache / cassandra / cql3 / restrictions / PrimaryKeyRestrictionSet . java 
 index 936dbd6 . . 7ce228c 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / restrictions / PrimaryKeyRestrictionSet . java 
 + + + b / src / java / org / apache / cassandra / cql3 / restrictions / PrimaryKeyRestrictionSet . java 
 @ @ - 20 , 6 + 20 , 8 @ @ package org . apache . cassandra . cql3 . restrictions ; 
 import java . nio . ByteBuffer ; 
 import java . util . * ; 
 
 + import com . google . common . collect . Lists ; 
 + 
 import org . apache . cassandra . db . composites . Composite ; 
 import org . apache . cassandra . config . ColumnDefinition ; 
 import org . apache . cassandra . cql3 . QueryOptions ; 
 @ @ - 201 , 7 + 203 , 24 @ @ final class PrimaryKeyRestrictionSet extends AbstractPrimaryKeyRestrictions 
 if ( r . isSlice ( ) ) 
 { 
 r . appendBoundTo ( builder , bound , options ) ; 
 - return filterAndSort ( setEocs ( r , bound , builder . build ( ) ) ) ; 
 + 
 + / / Since CASSANDRA - 7281 , the composites might not end with the same components and it is possible 
 + / / that one of the composites is an empty one . Unfortunatly , AbstractCType will always sort 
 + / / Composites . EMPTY before all the other components due to its EOC , even if it is not the desired 
 + / / behaviour in some cases . To avoid that problem the code will use normal composites for the empty 
 + / / ones until the composites are properly sorted . They will then be replaced by Composites . EMPTY as 
 + / / it is what is expected by the intra - node serialization . 
 + / / It is clearly a hack but it does not make a lot of sense to refactor 2 . 2 for that as the problem is 
 + / / already solved in 3 . 0 . 
 + List < Composite > composites = filterAndSort ( setEocs ( r , bound , builder . build ( ) ) ) ; 
 + return Lists . transform ( composites , new com . google . common . base . Function < Composite , Composite > ( ) 
 + { 
 + @ Override 
 + public Composite apply ( Composite composite ) 
 + { 
 + return composite . isEmpty ( ) ? Composites . EMPTY : composite ; 
 + } 
 + } ) ; 
 } 
 
 r . appendBoundTo ( builder , bound , options ) ; 
 @ @ - 234 , 6 + 253 , 7 @ @ final class PrimaryKeyRestrictionSet extends AbstractPrimaryKeyRestrictions 
 
 TreeSet < Composite > set = new TreeSet < Composite > ( ctype ) ; 
 set . addAll ( composites ) ; 
 + 
 return new ArrayList < > ( set ) ; 
 } 
 
 diff - - git a / test / unit / org / apache / cassandra / cql3 / restrictions / PrimaryKeyRestrictionSetTest . java b / test / unit / org / apache / cassandra / cql3 / restrictions / PrimaryKeyRestrictionSetTest . java 
 index 1deeb9e . . bf5128f 100644 
 - - - a / test / unit / org / apache / cassandra / cql3 / restrictions / PrimaryKeyRestrictionSetTest . java 
 + + + b / test / unit / org / apache / cassandra / cql3 / restrictions / PrimaryKeyRestrictionSetTest . java 
 @ @ - 31 , 6 + 31 , 7 @ @ import org . apache . cassandra . cql3 . statements . Bound ; 
 import org . apache . cassandra . db . ColumnFamilyType ; 
 import org . apache . cassandra . db . composites . Composite ; 
 import org . apache . cassandra . db . composites . Composite . EOC ; 
 + import org . apache . cassandra . db . composites . Composites ; 
 import org . apache . cassandra . db . composites . CompoundSparseCellNameType ; 
 import org . apache . cassandra . db . marshal . AbstractType ; 
 import org . apache . cassandra . db . marshal . Int32Type ; 
 @ @ - 1682 , 7 + 1683 , 7 @ @ public class PrimaryKeyRestrictionSetTest 
 * / 
 private static void assertEmptyComposite ( Composite composite ) 
 { 
 - assertTrue ( composite . isEmpty ( ) ) ; 
 + assertEquals ( Composites . EMPTY , composite ) ; 
 } 
 
 / * *

NEAREST DIFF:
ELIMINATEDSENTENCE
