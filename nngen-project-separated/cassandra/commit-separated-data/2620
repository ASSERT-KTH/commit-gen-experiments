BLEU SCORE: 0.08116697886877475

TEST MSG: Fix race processing range scan responses
GENERATED MSG: handle replica unavailability in index scan

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index c89ae51 . . 64dc248 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 2 . 0 . 7 <nl> + * Fix race processing range scan responses ( CASSANDRA - 6820 ) <nl> * Allow deleting snapshots from dropped keyspaces ( CASSANDRA - 6821 ) <nl> * Add uuid ( ) function ( CASSANDRA - 6473 ) <nl> * Omit tombstones from schema digests ( CASSANDRA - 6862 ) <nl> diff - - git a / src / java / org / apache / cassandra / service / ReadCallback . java b / src / java / org / apache / cassandra / service / ReadCallback . java <nl> index 085787c . . 150fabe 100644 <nl> - - - a / src / java / org / apache / cassandra / service / ReadCallback . java <nl> + + + b / src / java / org / apache / cassandra / service / ReadCallback . java <nl> @ @ - 76 , 6 + 76 , 8 @ @ public class ReadCallback < TMessage , TResolved > implements IAsyncCallback < TMessag <nl> this . resolver = resolver ; <nl> this . start = System . nanoTime ( ) ; <nl> this . endpoints = endpoints ; <nl> + / / we don ' t support read repair ( or rapid read protection ) for range scans yet ( CASSANDRA - 6897 ) <nl> + assert ! ( resolver instanceof RangeSliceResponseResolver ) | | blockfor > = endpoints . size ( ) ; <nl> } <nl> <nl> public boolean await ( long timePastStart , TimeUnit unit ) <nl> diff - - git a / src / java / org / apache / cassandra / service / StorageProxy . java b / src / java / org / apache / cassandra / service / StorageProxy . java <nl> index a6912c2 . . 12f9ece 100644 <nl> - - - a / src / java / org / apache / cassandra / service / StorageProxy . java <nl> + + + b / src / java / org / apache / cassandra / service / StorageProxy . java <nl> @ @ - 1473 , 7 + 1473 , 8 @ @ public class StorageProxy implements StorageProxyMBean <nl> <nl> / / collect replies and resolve according to consistency level <nl> RangeSliceResponseResolver resolver = new RangeSliceResponseResolver ( nodeCmd . keyspace , command . timestamp ) ; <nl> - ReadCallback < RangeSliceReply , Iterable < Row > > handler = new ReadCallback ( resolver , consistency _ level , nodeCmd , filteredEndpoints ) ; <nl> + List < InetAddress > minimalEndpoints = filteredEndpoints . subList ( 0 , Math . min ( filteredEndpoints . size ( ) , consistency _ level . blockFor ( keyspace ) ) ) ; <nl> + ReadCallback < RangeSliceReply , Iterable < Row > > handler = new ReadCallback < > ( resolver , consistency _ level , nodeCmd , minimalEndpoints ) ; <nl> handler . assureSufficientLiveNodes ( ) ; <nl> resolver . setSources ( filteredEndpoints ) ; <nl> if ( filteredEndpoints . size ( ) = = 1
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 30e8275 . . e4d8d3f 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 40 , 6 + 40 , 7 @ @ dev <nl> * retain reference to PendingFile sstables ( CASSANDRA - 1749 ) <nl> * fix sstableimport regression ( CASSANDRA - 1753 ) <nl> * fix for bootstrap when no non - system tables are defined ( CASSANDRA - 1732 ) <nl> + * handle replica unavailability in index scan ( CASSANDRA - 1755 ) <nl> <nl> <nl> 0 . 7 . 0 - beta3 <nl> diff - - git a / src / java / org / apache / cassandra / avro / CassandraServer . java b / src / java / org / apache / cassandra / avro / CassandraServer . java <nl> index 325d3aa . . bec5039 100644 <nl> - - - a / src / java / org / apache / cassandra / avro / CassandraServer . java <nl> + + + b / src / java / org / apache / cassandra / avro / CassandraServer . java <nl> @ @ - 1100 , 6 + 1100 , 10 @ @ public class CassandraServer implements Cassandra { <nl> { <nl> throw new TimedOutException ( ) ; <nl> } <nl> + catch ( org . apache . cassandra . thrift . UnavailableException e ) <nl> + { <nl> + throw newUnavailableException ( ) ; <nl> + } <nl> return avronateKeySlices ( rows , column _ parent , column _ predicate ) ; <nl> } <nl> <nl> diff - - git a / src / java / org / apache / cassandra / service / StorageProxy . java b / src / java / org / apache / cassandra / service / StorageProxy . java <nl> index 522cef0 . . 3f26f14 100644 <nl> - - - a / src / java / org / apache / cassandra / service / StorageProxy . java <nl> + + + b / src / java / org / apache / cassandra / service / StorageProxy . java <nl> @ @ - 647 , 7 + 647 , 7 @ @ public class StorageProxy implements StorageProxyMBean <nl> } <nl> <nl> public static List < Row > scan ( String keyspace , String column _ family , IndexClause index _ clause , SlicePredicate column _ predicate , ConsistencyLevel consistency _ level ) <nl> - throws IOException , TimeoutException <nl> + throws IOException , TimeoutException , UnavailableException <nl> { <nl> IPartitioner p = StorageService . getPartitioner ( ) ; <nl> <nl> @ @ - 666 , 7 + 666 , 11 @ @ public class StorageProxy implements StorageProxyMBean <nl> RangeSliceResponseResolver resolver = new RangeSliceResponseResolver ( keyspace , liveEndpoints ) ; <nl> AbstractReplicationStrategy rs = Table . open ( keyspace ) . replicationStrategy ; <nl> QuorumResponseHandler < List < Row > > handler = rs . getQuorumResponseHandler ( resolver , consistency _ level ) ; <nl> - / / TODO bail early if live endpoints can ' t satisfy requested consistency level <nl> + <nl> + / / bail early if live endpoints can ' t satisfy requested consistency level <nl> + if ( handler . blockfor > liveEndpoints . size ( ) ) <nl> + throw new UnavailableException ( ) ; <nl> + <nl> IndexScanCommand command = new IndexScanCommand ( keyspace , column _ family , index _ clause , column _ predicate , range ) ; <nl> Message message = command . getMessage ( ) ; <nl> for ( InetAddress endpoint : liveEndpoints )

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index c89ae51 . . 64dc248 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 2 . 0 . 7 
 + * Fix race processing range scan responses ( CASSANDRA - 6820 ) 
 * Allow deleting snapshots from dropped keyspaces ( CASSANDRA - 6821 ) 
 * Add uuid ( ) function ( CASSANDRA - 6473 ) 
 * Omit tombstones from schema digests ( CASSANDRA - 6862 ) 
 diff - - git a / src / java / org / apache / cassandra / service / ReadCallback . java b / src / java / org / apache / cassandra / service / ReadCallback . java 
 index 085787c . . 150fabe 100644 
 - - - a / src / java / org / apache / cassandra / service / ReadCallback . java 
 + + + b / src / java / org / apache / cassandra / service / ReadCallback . java 
 @ @ - 76 , 6 + 76 , 8 @ @ public class ReadCallback < TMessage , TResolved > implements IAsyncCallback < TMessag 
 this . resolver = resolver ; 
 this . start = System . nanoTime ( ) ; 
 this . endpoints = endpoints ; 
 + / / we don ' t support read repair ( or rapid read protection ) for range scans yet ( CASSANDRA - 6897 ) 
 + assert ! ( resolver instanceof RangeSliceResponseResolver ) | | blockfor > = endpoints . size ( ) ; 
 } 
 
 public boolean await ( long timePastStart , TimeUnit unit ) 
 diff - - git a / src / java / org / apache / cassandra / service / StorageProxy . java b / src / java / org / apache / cassandra / service / StorageProxy . java 
 index a6912c2 . . 12f9ece 100644 
 - - - a / src / java / org / apache / cassandra / service / StorageProxy . java 
 + + + b / src / java / org / apache / cassandra / service / StorageProxy . java 
 @ @ - 1473 , 7 + 1473 , 8 @ @ public class StorageProxy implements StorageProxyMBean 
 
 / / collect replies and resolve according to consistency level 
 RangeSliceResponseResolver resolver = new RangeSliceResponseResolver ( nodeCmd . keyspace , command . timestamp ) ; 
 - ReadCallback < RangeSliceReply , Iterable < Row > > handler = new ReadCallback ( resolver , consistency _ level , nodeCmd , filteredEndpoints ) ; 
 + List < InetAddress > minimalEndpoints = filteredEndpoints . subList ( 0 , Math . min ( filteredEndpoints . size ( ) , consistency _ level . blockFor ( keyspace ) ) ) ; 
 + ReadCallback < RangeSliceReply , Iterable < Row > > handler = new ReadCallback < > ( resolver , consistency _ level , nodeCmd , minimalEndpoints ) ; 
 handler . assureSufficientLiveNodes ( ) ; 
 resolver . setSources ( filteredEndpoints ) ; 
 if ( filteredEndpoints . size ( ) = = 1

NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 30e8275 . . e4d8d3f 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 40 , 6 + 40 , 7 @ @ dev 
 * retain reference to PendingFile sstables ( CASSANDRA - 1749 ) 
 * fix sstableimport regression ( CASSANDRA - 1753 ) 
 * fix for bootstrap when no non - system tables are defined ( CASSANDRA - 1732 ) 
 + * handle replica unavailability in index scan ( CASSANDRA - 1755 ) 
 
 
 0 . 7 . 0 - beta3 
 diff - - git a / src / java / org / apache / cassandra / avro / CassandraServer . java b / src / java / org / apache / cassandra / avro / CassandraServer . java 
 index 325d3aa . . bec5039 100644 
 - - - a / src / java / org / apache / cassandra / avro / CassandraServer . java 
 + + + b / src / java / org / apache / cassandra / avro / CassandraServer . java 
 @ @ - 1100 , 6 + 1100 , 10 @ @ public class CassandraServer implements Cassandra { 
 { 
 throw new TimedOutException ( ) ; 
 } 
 + catch ( org . apache . cassandra . thrift . UnavailableException e ) 
 + { 
 + throw newUnavailableException ( ) ; 
 + } 
 return avronateKeySlices ( rows , column _ parent , column _ predicate ) ; 
 } 
 
 diff - - git a / src / java / org / apache / cassandra / service / StorageProxy . java b / src / java / org / apache / cassandra / service / StorageProxy . java 
 index 522cef0 . . 3f26f14 100644 
 - - - a / src / java / org / apache / cassandra / service / StorageProxy . java 
 + + + b / src / java / org / apache / cassandra / service / StorageProxy . java 
 @ @ - 647 , 7 + 647 , 7 @ @ public class StorageProxy implements StorageProxyMBean 
 } 
 
 public static List < Row > scan ( String keyspace , String column _ family , IndexClause index _ clause , SlicePredicate column _ predicate , ConsistencyLevel consistency _ level ) 
 - throws IOException , TimeoutException 
 + throws IOException , TimeoutException , UnavailableException 
 { 
 IPartitioner p = StorageService . getPartitioner ( ) ; 
 
 @ @ - 666 , 7 + 666 , 11 @ @ public class StorageProxy implements StorageProxyMBean 
 RangeSliceResponseResolver resolver = new RangeSliceResponseResolver ( keyspace , liveEndpoints ) ; 
 AbstractReplicationStrategy rs = Table . open ( keyspace ) . replicationStrategy ; 
 QuorumResponseHandler < List < Row > > handler = rs . getQuorumResponseHandler ( resolver , consistency _ level ) ; 
 - / / TODO bail early if live endpoints can ' t satisfy requested consistency level 
 + 
 + / / bail early if live endpoints can ' t satisfy requested consistency level 
 + if ( handler . blockfor > liveEndpoints . size ( ) ) 
 + throw new UnavailableException ( ) ; 
 + 
 IndexScanCommand command = new IndexScanCommand ( keyspace , column _ family , index _ clause , column _ predicate , range ) ; 
 Message message = command . getMessage ( ) ; 
 for ( InetAddress endpoint : liveEndpoints )
