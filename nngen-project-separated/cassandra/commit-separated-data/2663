BLEU SCORE: 2.765421850739168E-4

TEST MSG: add ChecksummedSequentialWriter
GENERATED MSG: Only count compaction as active ( for throttling ) once the compaction lock has been acquired .

TEST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / io / util / ChecksummedSequentialWriter . java b / src / java / org / apache / cassandra / io / util / ChecksummedSequentialWriter . java <nl> new file mode 100644 <nl> index 0000000 . . 3c4c257 <nl> - - - / dev / null <nl> + + + b / src / java / org / apache / cassandra / io / util / ChecksummedSequentialWriter . java <nl> @ @ - 0 , 0 + 1 , 36 @ @ <nl> + package org . apache . cassandra . io . util ; <nl> + <nl> + import java . io . File ; <nl> + <nl> + import org . apache . cassandra . io . sstable . Descriptor ; <nl> + <nl> + public class ChecksummedSequentialWriter extends SequentialWriter <nl> + { <nl> + private final SequentialWriter crcWriter ; <nl> + private final DataIntegrityMetadata . ChecksumWriter crcMetadata ; <nl> + <nl> + public ChecksummedSequentialWriter ( File file , int bufferSize , boolean skipIOCache , File crcPath ) <nl> + { <nl> + super ( file , bufferSize , skipIOCache ) ; <nl> + crcWriter = new SequentialWriter ( crcPath , 8 * 1024 , true ) ; <nl> + crcMetadata = new DataIntegrityMetadata . ChecksumWriter ( crcWriter . stream ) ; <nl> + crcMetadata . writeChunkSize ( buffer . length ) ; <nl> + } <nl> + <nl> + protected void flushData ( ) <nl> + { <nl> + super . flushData ( ) ; <nl> + crcMetadata . append ( buffer , 0 , validBufferBytes ) ; <nl> + } <nl> + <nl> + public void writeFullChecksum ( Descriptor descriptor ) <nl> + { <nl> + crcMetadata . writeFullChecksum ( descriptor ) ; <nl> + } <nl> + <nl> + public void close ( ) <nl> + { <nl> + super . close ( ) ; <nl> + crcWriter . close ( ) ; <nl> + } <nl> + }
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 2a80fb1 . . 6db56a7 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 3 + 1 , 9 @ @ <nl> + 1 . 0 . 1 <nl> + * Fix handling of tombstone by SSTableExport / Import ( CASSANDRA - 3357 ) <nl> + * Only count compaction as active ( for throttling ) when they have <nl> + successfully acquired the compaction lock ( CASSANDRA - 3344 ) <nl> + <nl> + <nl> 1 . 0 . 0 - final <nl> * close scrubbed sstable fd before deleting it ( CASSANDRA - 3318 ) <nl> * fix bug preventing obsolete commitlog segments from being removed <nl> @ @ - 30 , 7 + 36 , 6 @ @ Fixes merged from 0 . 8 below : <nl> * Nodetool no longer leaks threads and closes JMX connections ( CASSANDRA - 3309 ) <nl> * fix truncate allowing data to be replayed post - restart ( CASSANDRA - 3297 ) <nl> * Move SimpleAuthority and SimpleAuthenticator to examples ( CASSANDRA - 2922 ) <nl> - * Fix handling of tombstone by SSTableExport / Import ( CASSANDRA - 3357 ) <nl> <nl> <nl> 1 . 0 . 0 - rc2 <nl> diff - - git a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java <nl> index 020c6ff . . d462053 100644 <nl> - - - a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java <nl> + + + b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java <nl> @ @ - 959 , 7 + 959 , 7 @ @ public class CompactionManager implements CompactionManagerMBean <nl> <nl> public int getActiveCompactions ( ) <nl> { <nl> - return executor . getActiveCount ( ) + validationExecutor . getActiveCount ( ) ; <nl> + return CompactionExecutor . compactions . size ( ) ; <nl> } <nl> <nl> private static class CompactionExecutor extends DebuggableThreadPoolExecutor implements CompactionExecutorStatsCollector

TEST DIFF:
diff - - git a / src / java / org / apache / cassandra / io / util / ChecksummedSequentialWriter . java b / src / java / org / apache / cassandra / io / util / ChecksummedSequentialWriter . java 
 new file mode 100644 
 index 0000000 . . 3c4c257 
 - - - / dev / null 
 + + + b / src / java / org / apache / cassandra / io / util / ChecksummedSequentialWriter . java 
 @ @ - 0 , 0 + 1 , 36 @ @ 
 + package org . apache . cassandra . io . util ; 
 + 
 + import java . io . File ; 
 + 
 + import org . apache . cassandra . io . sstable . Descriptor ; 
 + 
 + public class ChecksummedSequentialWriter extends SequentialWriter 
 + { 
 + private final SequentialWriter crcWriter ; 
 + private final DataIntegrityMetadata . ChecksumWriter crcMetadata ; 
 + 
 + public ChecksummedSequentialWriter ( File file , int bufferSize , boolean skipIOCache , File crcPath ) 
 + { 
 + super ( file , bufferSize , skipIOCache ) ; 
 + crcWriter = new SequentialWriter ( crcPath , 8 * 1024 , true ) ; 
 + crcMetadata = new DataIntegrityMetadata . ChecksumWriter ( crcWriter . stream ) ; 
 + crcMetadata . writeChunkSize ( buffer . length ) ; 
 + } 
 + 
 + protected void flushData ( ) 
 + { 
 + super . flushData ( ) ; 
 + crcMetadata . append ( buffer , 0 , validBufferBytes ) ; 
 + } 
 + 
 + public void writeFullChecksum ( Descriptor descriptor ) 
 + { 
 + crcMetadata . writeFullChecksum ( descriptor ) ; 
 + } 
 + 
 + public void close ( ) 
 + { 
 + super . close ( ) ; 
 + crcWriter . close ( ) ; 
 + } 
 + }

NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 2a80fb1 . . 6db56a7 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 3 + 1 , 9 @ @ 
 + 1 . 0 . 1 
 + * Fix handling of tombstone by SSTableExport / Import ( CASSANDRA - 3357 ) 
 + * Only count compaction as active ( for throttling ) when they have 
 + successfully acquired the compaction lock ( CASSANDRA - 3344 ) 
 + 
 + 
 1 . 0 . 0 - final 
 * close scrubbed sstable fd before deleting it ( CASSANDRA - 3318 ) 
 * fix bug preventing obsolete commitlog segments from being removed 
 @ @ - 30 , 7 + 36 , 6 @ @ Fixes merged from 0 . 8 below : 
 * Nodetool no longer leaks threads and closes JMX connections ( CASSANDRA - 3309 ) 
 * fix truncate allowing data to be replayed post - restart ( CASSANDRA - 3297 ) 
 * Move SimpleAuthority and SimpleAuthenticator to examples ( CASSANDRA - 2922 ) 
 - * Fix handling of tombstone by SSTableExport / Import ( CASSANDRA - 3357 ) 
 
 
 1 . 0 . 0 - rc2 
 diff - - git a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java 
 index 020c6ff . . d462053 100644 
 - - - a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java 
 + + + b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java 
 @ @ - 959 , 7 + 959 , 7 @ @ public class CompactionManager implements CompactionManagerMBean 
 
 public int getActiveCompactions ( ) 
 { 
 - return executor . getActiveCount ( ) + validationExecutor . getActiveCount ( ) ; 
 + return CompactionExecutor . compactions . size ( ) ; 
 } 
 
 private static class CompactionExecutor extends DebuggableThreadPoolExecutor implements CompactionExecutorStatsCollector
