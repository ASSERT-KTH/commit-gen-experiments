BLEU SCORE: 0.027611988917697356

TEST MSG: add SASI validation for partitioner and complex columns
GENERATED MSG: make NetworkTopologyStrategy the default

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index f3248df . . df97bbd 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 3 . 4 <nl> + * add SASI validation for partitioner and complex columns ( CASSANDRA - 11169 ) <nl> * Add caching of encrypted credentials in PasswordAuthenticator ( CASSANDRA - 7715 ) <nl> * fix SASI memtable switching on flush ( CASSANDRA - 11159 ) <nl> * Remove duplicate offline compaction tracking ( CASSANDRA - 11148 ) <nl> diff - - git a / src / java / org / apache / cassandra / index / sasi / SASIIndex . java b / src / java / org / apache / cassandra / index / sasi / SASIIndex . java <nl> index 90cc72e . . 0b9d900 100644 <nl> - - - a / src / java / org / apache / cassandra / index / sasi / SASIIndex . java <nl> + + + b / src / java / org / apache / cassandra / index / sasi / SASIIndex . java <nl> @ @ - 35 , 6 + 35 , 7 @ @ import org . apache . cassandra . db . marshal . AbstractType ; <nl> import org . apache . cassandra . db . partitions . PartitionIterator ; <nl> import org . apache . cassandra . db . partitions . PartitionUpdate ; <nl> import org . apache . cassandra . db . rows . Row ; <nl> + import org . apache . cassandra . dht . Murmur3Partitioner ; <nl> import org . apache . cassandra . exceptions . ConfigurationException ; <nl> import org . apache . cassandra . exceptions . InvalidRequestException ; <nl> import org . apache . cassandra . index . Index ; <nl> @ @ - 121 , 6 + 122 , 9 @ @ public class SASIIndex implements Index , INotificationConsumer <nl> <nl> public static Map < String , String > validateOptions ( Map < String , String > options , CFMetaData cfm ) <nl> { <nl> + if ( ! ( cfm . partitioner instanceof Murmur3Partitioner ) ) <nl> + throw new ConfigurationException ( " SASI only supports Murmur3Partitioner . " ) ; <nl> + <nl> String targetColumn = options . get ( " target " ) ; <nl> if ( targetColumn = = null ) <nl> throw new ConfigurationException ( " unknown target column " ) ; <nl> @ @ - 129 , 6 + 133 , 9 @ @ public class SASIIndex implements Index , INotificationConsumer <nl> if ( target = = null ) <nl> throw new ConfigurationException ( " failed to retrieve target column for : " + targetColumn ) ; <nl> <nl> + if ( target . left . isComplex ( ) ) <nl> + throw new ConfigurationException ( " complex columns are not yet supported by SASI " ) ; <nl> + <nl> IndexMode . validateAnalyzer ( options ) ; <nl> <nl> IndexMode mode = IndexMode . getMode ( target . left , options ) ;
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 6f30f7a . . c9c8150 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 6 + 1 , 7 @ @ <nl> 0 . 8 - dev <nl> * avoid double RowMutation serialization on write path ( CASSANDRA - 1800 ) <nl> * adds support for columns that act as incr / decr counters ( CASSANDRA - 1072 ) <nl> + * make NetworkTopologyStrategy the default ( CASSANDRA - 1960 ) <nl> <nl> <nl> 0 . 7 . 1 - dev <nl> diff - - git a / conf / cassandra . yaml b / conf / cassandra . yaml <nl> index 66cda46 . . 4bdf966 100644 <nl> - - - a / conf / cassandra . yaml <nl> + + + b / conf / cassandra . yaml <nl> @ @ - 314 , 8 + 314 , 7 @ @ index _ interval : 128 <nl> # With NetworkTopologyStrategy , <nl> # for each datacenter , you can specify how many replicas you want <nl> # on a per - keyspace basis . Replicas are placed on different racks <nl> - # within each DC , if possible . This strategy also requires rack aware <nl> - # snitch , such as RackInferringSnitch or PropertyFileSnitch . <nl> + # within each DC , if possible . <nl> # An example : <nl> # - name : Keyspace1 <nl> # replica _ placement _ strategy : org . apache . cassandra . locator . NetworkTopologyStrategy <nl> diff - - git a / src / java / org / apache / cassandra / cli / CliClient . java b / src / java / org / apache / cassandra / cli / CliClient . java <nl> index 0d5d014 . . de31e11 100644 <nl> - - - a / src / java / org / apache / cassandra / cli / CliClient . java <nl> + + + b / src / java / org / apache / cassandra / cli / CliClient . java <nl> @ @ - 18 , 6 + 18 , 8 @ @ <nl> package org . apache . cassandra . cli ; <nl> <nl> import java . io . IOException ; <nl> + import java . net . InetAddress ; <nl> + import java . net . UnknownHostException ; <nl> import java . nio . ByteBuffer ; <nl> import java . util . * ; <nl> <nl> @ @ - 29 , 6 + 31 , 7 @ @ import org . apache . cassandra . config . ConfigurationException ; <nl> import org . apache . cassandra . db . ColumnFamilyStoreMBean ; <nl> import org . apache . cassandra . db . CompactionManagerMBean ; <nl> import org . apache . cassandra . db . marshal . * ; <nl> + import org . apache . cassandra . locator . SimpleSnitch ; <nl> import org . apache . cassandra . thrift . * ; <nl> import org . apache . cassandra . tools . NodeProbe ; <nl> import org . apache . cassandra . utils . ByteBufferUtil ; <nl> @ @ - 92 , 7 + 95 , 8 @ @ public class CliClient extends CliUserHelp <nl> PLACEMENT _ STRATEGY , <nl> STRATEGY _ OPTIONS <nl> } <nl> - private static final String DEFAULT _ PLACEMENT _ STRATEGY = " org . apache . cassandra . locator . SimpleStrategy " ; <nl> + <nl> + private static final String DEFAULT _ PLACEMENT _ STRATEGY = " org . apache . cassandra . locator . NetworkTopologyStrategy " ; <nl> <nl> private Cassandra . Client thriftClient = null ; <nl> private CliSessionState sessionState = null ; <nl> @ @ - 803 , 6 + 807 , 30 @ @ public class CliClient extends CliUserHelp <nl> } <nl> } <nl> <nl> + / / using default snitch options if strategy is NetworkTopologyStrategy and no options were set . <nl> + if ( ksDef . getStrategy _ class ( ) . contains ( " . NetworkTopologyStrategy " ) ) <nl> + { <nl> + Map < String , String > currentStrategyOptions = ksDef . getStrategy _ options ( ) ; <nl> + <nl> + / / adding default data center from SimpleSnitch <nl> + if ( currentStrategyOptions = = null | | currentStrategyOptions . isEmpty ( ) ) <nl> + { <nl> + SimpleSnitch snitch = new SimpleSnitch ( ) ; <nl> + Map < String , String > options = new HashMap < String , String > ( ) ; <nl> + <nl> + try <nl> + { <nl> + options . put ( snitch . getDatacenter ( InetAddress . getLocalHost ( ) ) , " 1 " ) ; <nl> + } <nl> + catch ( UnknownHostException e ) <nl> + { <nl> + throw new RuntimeException ( e . getMessage ( ) ) ; <nl> + } <nl> + <nl> + ksDef . setStrategy _ options ( options ) ; <nl> + } <nl> + } <nl> + <nl> return ksDef ; <nl> } <nl> <nl> diff - - git a / src / java / org / apache / cassandra / config / KSMetaData . java b / src / java / org / apache / cassandra / config / KSMetaData . java <nl> index ca6e732 . . 753a974 100644 <nl> - - - a / src / java / org / apache / cassandra / config / KSMetaData . java <nl> + + + b / src / java / org / apache / cassandra / config / KSMetaData . java <nl> @ @ - 28 , 7 + 28 , 7 @ @ import org . apache . commons . lang . ObjectUtils ; <nl> import org . apache . avro . util . Utf8 ; <nl> import org . apache . cassandra . io . SerDeUtils ; <nl> import org . apache . cassandra . locator . AbstractReplicationStrategy ; <nl> - import org . apache . cassandra . locator . SimpleStrategy ; <nl> + import org . apache . cassandra . locator . NetworkTopologyStrategy ; <nl> <nl> public final class KSMetaData <nl> { <nl> @ @ - 41 , 7 + 41 , 7 @ @ public final class KSMetaData <nl> public KSMetaData ( String name , Class < ? extends AbstractReplicationStrategy > strategyClass , Map < String , String > strategyOptions , int replicationFactor , CFMetaData . . . cfDefs ) <nl> { <nl> this . name = name ; <nl> - this . strategyClass = strategyClass = = null ? SimpleStrategy . class : strategyClass ; <nl> + this . strategyClass = strategyClass = = null ? NetworkTopologyStrategy . class : strategyClass ; <nl> this . strategyOptions = strategyOptions ; <nl> this . replicationFactor = replicationFactor ; <nl> Map < String , CFMetaData > cfmap = new HashMap < String , CFMetaData > ( ) ;

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index f3248df . . df97bbd 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 3 . 4 
 + * add SASI validation for partitioner and complex columns ( CASSANDRA - 11169 ) 
 * Add caching of encrypted credentials in PasswordAuthenticator ( CASSANDRA - 7715 ) 
 * fix SASI memtable switching on flush ( CASSANDRA - 11159 ) 
 * Remove duplicate offline compaction tracking ( CASSANDRA - 11148 ) 
 diff - - git a / src / java / org / apache / cassandra / index / sasi / SASIIndex . java b / src / java / org / apache / cassandra / index / sasi / SASIIndex . java 
 index 90cc72e . . 0b9d900 100644 
 - - - a / src / java / org / apache / cassandra / index / sasi / SASIIndex . java 
 + + + b / src / java / org / apache / cassandra / index / sasi / SASIIndex . java 
 @ @ - 35 , 6 + 35 , 7 @ @ import org . apache . cassandra . db . marshal . AbstractType ; 
 import org . apache . cassandra . db . partitions . PartitionIterator ; 
 import org . apache . cassandra . db . partitions . PartitionUpdate ; 
 import org . apache . cassandra . db . rows . Row ; 
 + import org . apache . cassandra . dht . Murmur3Partitioner ; 
 import org . apache . cassandra . exceptions . ConfigurationException ; 
 import org . apache . cassandra . exceptions . InvalidRequestException ; 
 import org . apache . cassandra . index . Index ; 
 @ @ - 121 , 6 + 122 , 9 @ @ public class SASIIndex implements Index , INotificationConsumer 
 
 public static Map < String , String > validateOptions ( Map < String , String > options , CFMetaData cfm ) 
 { 
 + if ( ! ( cfm . partitioner instanceof Murmur3Partitioner ) ) 
 + throw new ConfigurationException ( " SASI only supports Murmur3Partitioner . " ) ; 
 + 
 String targetColumn = options . get ( " target " ) ; 
 if ( targetColumn = = null ) 
 throw new ConfigurationException ( " unknown target column " ) ; 
 @ @ - 129 , 6 + 133 , 9 @ @ public class SASIIndex implements Index , INotificationConsumer 
 if ( target = = null ) 
 throw new ConfigurationException ( " failed to retrieve target column for : " + targetColumn ) ; 
 
 + if ( target . left . isComplex ( ) ) 
 + throw new ConfigurationException ( " complex columns are not yet supported by SASI " ) ; 
 + 
 IndexMode . validateAnalyzer ( options ) ; 
 
 IndexMode mode = IndexMode . getMode ( target . left , options ) ;

NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 6f30f7a . . c9c8150 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 6 + 1 , 7 @ @ 
 0 . 8 - dev 
 * avoid double RowMutation serialization on write path ( CASSANDRA - 1800 ) 
 * adds support for columns that act as incr / decr counters ( CASSANDRA - 1072 ) 
 + * make NetworkTopologyStrategy the default ( CASSANDRA - 1960 ) 
 
 
 0 . 7 . 1 - dev 
 diff - - git a / conf / cassandra . yaml b / conf / cassandra . yaml 
 index 66cda46 . . 4bdf966 100644 
 - - - a / conf / cassandra . yaml 
 + + + b / conf / cassandra . yaml 
 @ @ - 314 , 8 + 314 , 7 @ @ index _ interval : 128 
 # With NetworkTopologyStrategy , 
 # for each datacenter , you can specify how many replicas you want 
 # on a per - keyspace basis . Replicas are placed on different racks 
 - # within each DC , if possible . This strategy also requires rack aware 
 - # snitch , such as RackInferringSnitch or PropertyFileSnitch . 
 + # within each DC , if possible . 
 # An example : 
 # - name : Keyspace1 
 # replica _ placement _ strategy : org . apache . cassandra . locator . NetworkTopologyStrategy 
 diff - - git a / src / java / org / apache / cassandra / cli / CliClient . java b / src / java / org / apache / cassandra / cli / CliClient . java 
 index 0d5d014 . . de31e11 100644 
 - - - a / src / java / org / apache / cassandra / cli / CliClient . java 
 + + + b / src / java / org / apache / cassandra / cli / CliClient . java 
 @ @ - 18 , 6 + 18 , 8 @ @ 
 package org . apache . cassandra . cli ; 
 
 import java . io . IOException ; 
 + import java . net . InetAddress ; 
 + import java . net . UnknownHostException ; 
 import java . nio . ByteBuffer ; 
 import java . util . * ; 
 
 @ @ - 29 , 6 + 31 , 7 @ @ import org . apache . cassandra . config . ConfigurationException ; 
 import org . apache . cassandra . db . ColumnFamilyStoreMBean ; 
 import org . apache . cassandra . db . CompactionManagerMBean ; 
 import org . apache . cassandra . db . marshal . * ; 
 + import org . apache . cassandra . locator . SimpleSnitch ; 
 import org . apache . cassandra . thrift . * ; 
 import org . apache . cassandra . tools . NodeProbe ; 
 import org . apache . cassandra . utils . ByteBufferUtil ; 
 @ @ - 92 , 7 + 95 , 8 @ @ public class CliClient extends CliUserHelp 
 PLACEMENT _ STRATEGY , 
 STRATEGY _ OPTIONS 
 } 
 - private static final String DEFAULT _ PLACEMENT _ STRATEGY = " org . apache . cassandra . locator . SimpleStrategy " ; 
 + 
 + private static final String DEFAULT _ PLACEMENT _ STRATEGY = " org . apache . cassandra . locator . NetworkTopologyStrategy " ; 
 
 private Cassandra . Client thriftClient = null ; 
 private CliSessionState sessionState = null ; 
 @ @ - 803 , 6 + 807 , 30 @ @ public class CliClient extends CliUserHelp 
 } 
 } 
 
 + / / using default snitch options if strategy is NetworkTopologyStrategy and no options were set . 
 + if ( ksDef . getStrategy _ class ( ) . contains ( " . NetworkTopologyStrategy " ) ) 
 + { 
 + Map < String , String > currentStrategyOptions = ksDef . getStrategy _ options ( ) ; 
 + 
 + / / adding default data center from SimpleSnitch 
 + if ( currentStrategyOptions = = null | | currentStrategyOptions . isEmpty ( ) ) 
 + { 
 + SimpleSnitch snitch = new SimpleSnitch ( ) ; 
 + Map < String , String > options = new HashMap < String , String > ( ) ; 
 + 
 + try 
 + { 
 + options . put ( snitch . getDatacenter ( InetAddress . getLocalHost ( ) ) , " 1 " ) ; 
 + } 
 + catch ( UnknownHostException e ) 
 + { 
 + throw new RuntimeException ( e . getMessage ( ) ) ; 
 + } 
 + 
 + ksDef . setStrategy _ options ( options ) ; 
 + } 
 + } 
 + 
 return ksDef ; 
 } 
 
 diff - - git a / src / java / org / apache / cassandra / config / KSMetaData . java b / src / java / org / apache / cassandra / config / KSMetaData . java 
 index ca6e732 . . 753a974 100644 
 - - - a / src / java / org / apache / cassandra / config / KSMetaData . java 
 + + + b / src / java / org / apache / cassandra / config / KSMetaData . java 
 @ @ - 28 , 7 + 28 , 7 @ @ import org . apache . commons . lang . ObjectUtils ; 
 import org . apache . avro . util . Utf8 ; 
 import org . apache . cassandra . io . SerDeUtils ; 
 import org . apache . cassandra . locator . AbstractReplicationStrategy ; 
 - import org . apache . cassandra . locator . SimpleStrategy ; 
 + import org . apache . cassandra . locator . NetworkTopologyStrategy ; 
 
 public final class KSMetaData 
 { 
 @ @ - 41 , 7 + 41 , 7 @ @ public final class KSMetaData 
 public KSMetaData ( String name , Class < ? extends AbstractReplicationStrategy > strategyClass , Map < String , String > strategyOptions , int replicationFactor , CFMetaData . . . cfDefs ) 
 { 
 this . name = name ; 
 - this . strategyClass = strategyClass = = null ? SimpleStrategy . class : strategyClass ; 
 + this . strategyClass = strategyClass = = null ? NetworkTopologyStrategy . class : strategyClass ; 
 this . strategyOptions = strategyOptions ; 
 this . replicationFactor = replicationFactor ; 
 Map < String , CFMetaData > cfmap = new HashMap < String , CFMetaData > ( ) ;
