BLEU SCORE: 0.05816635421147513

TEST MSG: 2 . 1 format sstable filenames with tmp are not handled by 3 . 0
GENERATED MSG: merge from 1 . 0

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index eacc110 . . b23c2d1 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 12 , 6 + 12 , 7 @ @ <nl> * Bytecode inspection for Java - UDFs ( CASSANDRA - 9890 ) <nl> * Use byte to serialize MT hash length ( CASSANDRA - 9792 ) <nl> * Replace usage of Adler32 with CRC32 ( CASSANDRA - 8684 ) <nl> + * Fix migration to new format from 2 . 1 SSTable ( CASSANDRA - 10006 ) <nl> Merged from 2 . 2 : <nl> * Add checksum to saved cache files ( CASSANDRA - 9265 ) <nl> * Log warning when using an aggregate without partition key ( CASSANDRA - 9737 ) <nl> diff - - git a / src / java / org / apache / cassandra / db / SystemKeyspace . java b / src / java / org / apache / cassandra / db / SystemKeyspace . java <nl> index bc0be65 . . d24b18b 100644 <nl> - - - a / src / java / org / apache / cassandra / db / SystemKeyspace . java <nl> + + + b / src / java / org / apache / cassandra / db / SystemKeyspace . java <nl> @ @ - 1307 , 7 + 1307 , 7 @ @ public final class SystemKeyspace <nl> } <nl> <nl> / * * <nl> - * Check data directories for old files that can be removed when migrating from 2 . 2 to 3 . 0 , <nl> + * Check data directories for old files that can be removed when migrating from 2 . 1 or 2 . 2 to 3 . 0 , <nl> * these checks can be removed in 4 . 0 , see CASSANDRA - 7066 <nl> * / <nl> public static void migrateDataDirs ( ) <nl> @ @ - 1323 , 13 + 1323 , 13 @ @ public final class SystemKeyspace <nl> { <nl> for ( File cfdir : ksdir . listFiles ( ( d , n ) - > d . isDirectory ( ) ) ) <nl> { <nl> - if ( Descriptor . isLegacyFile ( cfdir . getName ( ) ) ) <nl> + if ( Descriptor . isLegacyFile ( cfdir ) ) <nl> { <nl> FileUtils . deleteRecursive ( cfdir ) ; <nl> } <nl> else <nl> { <nl> - FileUtils . delete ( cfdir . listFiles ( ( d , n ) - > Descriptor . isLegacyFile ( n ) ) ) ; <nl> + FileUtils . delete ( cfdir . listFiles ( ( d , n ) - > Descriptor . isLegacyFile ( new File ( d , n ) ) ) ) ; <nl> } <nl> } <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / io / sstable / Descriptor . java b / src / java / org / apache / cassandra / io / sstable / Descriptor . java <nl> index 519f14e . . 38829df 100644 <nl> - - - a / src / java / org / apache / cassandra / io / sstable / Descriptor . java <nl> + + + b / src / java / org / apache / cassandra / io / sstable / Descriptor . java <nl> @ @ - 19 , 6 + 19 , 7 @ @ package org . apache . cassandra . io . sstable ; <nl> <nl> import java . io . File ; <nl> import java . util . * ; <nl> + import java . util . regex . Pattern ; <nl> <nl> import com . google . common . base . CharMatcher ; <nl> import com . google . common . base . Objects ; <nl> @ @ - 30 , 7 + 31 , 6 @ @ import org . apache . cassandra . io . sstable . format . Version ; <nl> import org . apache . cassandra . io . sstable . metadata . IMetadataSerializer ; <nl> import org . apache . cassandra . io . sstable . metadata . LegacyMetadataSerializer ; <nl> import org . apache . cassandra . io . sstable . metadata . MetadataSerializer ; <nl> - import org . apache . cassandra . net . MessagingService ; <nl> import org . apache . cassandra . utils . Pair ; <nl> <nl> import static org . apache . cassandra . io . sstable . Component . separator ; <nl> @ @ - 163 , 20 + 163 , 29 @ @ public class Descriptor <nl> } <nl> <nl> / * * <nl> - * Files obsoleted by CASSANDRA - 7066 : <nl> - * - temporary files used to start with either tmp or tmplink <nl> - * - system . compactions _ in _ progress sstable files <nl> + * Files obsoleted by CASSANDRA - 7066 : temporary files and compactions _ in _ progress . We support <nl> + * versions 2 . 1 ( ka ) and 2 . 2 ( la ) . <nl> + * Temporary files have tmp - or tmplink - at the beginning for 2 . 2 sstables or after ks - cf - for 2 . 1 sstables <nl> * / <nl> - public static boolean isLegacyFile ( String fileName ) <nl> + <nl> + private final static String LEGACY _ COMP _ IN _ PROG _ REGEX _ STR = " ^ compactions _ in _ progress ( \ \ - [ \ \ d , a - f ] { 32 } ) ? $ " ; <nl> + private final static Pattern LEGACY _ COMP _ IN _ PROG _ REGEX = Pattern . compile ( LEGACY _ COMP _ IN _ PROG _ REGEX _ STR ) ; <nl> + private final static String LEGACY _ TMP _ REGEX _ STR = " ^ ( ( . * ) \ \ - ( . * ) \ \ - ) ? tmp ( link ) ? \ \ - ( la | ka ) \ \ - ( \ \ d ) * \ \ - ( . * ) $ " ; <nl> + private final static Pattern LEGACY _ TMP _ REGEX = Pattern . compile ( LEGACY _ TMP _ REGEX _ STR ) ; <nl> + <nl> + public static boolean isLegacyFile ( File file ) <nl> { <nl> - return fileName . startsWith ( " compactions _ in _ progress " ) | | <nl> - fileName . startsWith ( " tmp " ) | | <nl> - fileName . startsWith ( " tmplink " ) ; <nl> + if ( file . isDirectory ( ) ) <nl> + return file . getParentFile ( ) ! = null & & <nl> + file . getParentFile ( ) . getName ( ) . equalsIgnoreCase ( " system " ) & & <nl> + LEGACY _ COMP _ IN _ PROG _ REGEX . matcher ( file . getName ( ) ) . matches ( ) ; <nl> + else <nl> + return LEGACY _ TMP _ REGEX . matcher ( file . getName ( ) ) . matches ( ) ; <nl> } <nl> <nl> public static boolean isValidFile ( String fileName ) <nl> { <nl> - return fileName . endsWith ( " . db " ) & & ! isLegacyFile ( fileName ) ; <nl> + return fileName . endsWith ( " . db " ) & & ! LEGACY _ TMP _ REGEX . matcher ( fileName ) . matches ( ) ; <nl> } <nl> <nl> / * * <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - CompressionInfo . db b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - CompressionInfo . db <nl> new file mode 100644 <nl> index 0000000 . . d9446df <nl> Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - CompressionInfo . db differ <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Data . db b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Data . db <nl> new file mode 100644 <nl> index 0000000 . . f7b696d <nl> Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Data . db differ <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Digest . sha1 b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Digest . sha1 <nl> new file mode 100644 <nl> index 0000000 . . 55756dd <nl> - - - / dev / null <nl> + + + b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Digest . sha1 <nl> @ @ - 0 , 0 + 1 @ @ <nl> + 3043896114 <nl> \ No newline at end of file <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Filter . db b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Filter . db <nl> new file mode 100644 <nl> index 0000000 . . 3015f10 <nl> Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Filter . db differ <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Index . db b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Index . db <nl> new file mode 100644 <nl> index 0000000 . . c8b59fb <nl> Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Index . db differ <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Statistics . db b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Statistics . db <nl> new file mode 100644 <nl> index 0000000 . . 8535f6a <nl> Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Statistics . db differ <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Summary . db b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Summary . db <nl> new file mode 100644 <nl> index 0000000 . . d9ce8c2 <nl> Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Summary . db differ <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - TOC . txt b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - TOC . txt <nl> new file mode 100644 <nl> index 0000000 . . 7dc8930 <nl> - - - / dev / null <nl> + + + b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - TOC . txt <nl> @ @ - 0 , 0 + 1 , 8 @ @ <nl> + Data . db <nl> + TOC . txt <nl> + Filter . db <nl> + Statistics . db <nl> + Summary . db <nl> + Index . db <nl> + Digest . sha1 <nl> + CompressionInfo . db <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - CompressionInfo . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - CompressionInfo . db <nl> new file mode 100644 <nl> index 0000000 . . b867db8 <nl> Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - CompressionInfo . db differ <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Data . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Data . db <nl> new file mode 100644 <nl> index 0000000 . . f14d86d <nl> Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Data . db differ <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Digest . sha1 b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Digest . sha1 <nl> new file mode 100644 <nl> index 0000000 . . 2f4daa9 <nl> - - - / dev / null <nl> + + + b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Digest . sha1 <nl> @ @ - 0 , 0 + 1 @ @ <nl> + 4283441474 <nl> \ No newline at end of file <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Filter . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Filter . db <nl> new file mode 100644 <nl> index 0000000 . . a5bdd8e <nl> Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Filter . db differ <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Index . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Index . db <nl> new file mode 100644 <nl> index 0000000 . . 5d71315 <nl> Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Index . db differ <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Statistics . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Statistics . db <nl> new file mode 100644 <nl> index 0000000 . . aeb2bb8 <nl> Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Statistics . db differ <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Summary . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Summary . db <nl> new file mode 100644 <nl> index 0000000 . . 602ec06 <nl> Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Summary . db differ <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - TOC . txt b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - TOC . txt <nl> new file mode 100644 <nl> index 0000000 . . 7dc8930 <nl> - - - / dev / null <nl> + + + b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - TOC . txt <nl> @ @ - 0 , 0 + 1 , 8 @ @ <nl> + Data . db <nl> + TOC . txt <nl> + Filter . db <nl> + Statistics . db <nl> + Summary . db <nl> + Index . db <nl> + Digest . sha1 <nl> + CompressionInfo . db <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmp - ka - 4 - Data . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmp - ka - 4 - Data . db <nl> new file mode 100644 <nl> index 0000000 . . f14d86d <nl> Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmp - ka - 4 - Data . db differ <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmp - ka - 4 - Index . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmp - ka - 4 - Index . db <nl> new file mode 100644 <nl> index 0000000 . . 5d71315 <nl> Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmp - ka - 4 - Index . db differ <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmplink - ka - 4 - Data . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmplink - ka - 4 - Data . db <nl> new file mode 100644 <nl> index 0000000 . . f14d86d <nl> Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmplink - ka - 4 - Data . db differ <nl> diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmplink - ka - 4 - Index . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmplink - ka - 4 - Index . db <nl> new file mode 100644 <nl> index 0000000 . . 5d71315 <nl> Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmplink - ka - 4 - Index . db differ <nl> diff - - git a / test / unit / org / apache / cassandra / db / SystemKeyspaceTest . java b / test / unit / org / apache / cassandra / db / SystemKeyspaceTest . java <nl> index d58985c . . 9fc3503 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / SystemKeyspaceTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / SystemKeyspaceTest . java <nl> @ @ - 153 , 9 + 153 , 20 @ @ public class SystemKeyspaceTest <nl> } <nl> <nl> @ Test <nl> - public void testMigrateDataDirs ( ) throws IOException <nl> + public void testMigrateDataDirs _ 2 _ 1 ( ) throws IOException <nl> { <nl> - Path migrationSSTableRoot = Paths . get ( System . getProperty ( MIGRATION _ SSTABLES _ ROOT ) , " 2 . 2 " ) ; <nl> + testMigrateDataDirs ( " 2 . 1 " ) ; <nl> + } <nl> + <nl> + @ Test <nl> + public void testMigrateDataDirs _ 2 _ 2 ( ) throws IOException <nl> + { <nl> + testMigrateDataDirs ( " 2 . 2 " ) ; <nl> + } <nl> + <nl> + private void testMigrateDataDirs ( String version ) throws IOException <nl> + { <nl> + Path migrationSSTableRoot = Paths . get ( System . getProperty ( MIGRATION _ SSTABLES _ ROOT ) , version ) ; <nl> Path dataDir = Paths . get ( DatabaseDescriptor . getAllDataFileLocations ( ) [ 0 ] ) ; <nl> <nl> FileUtils . copyDirectory ( migrationSSTableRoot . toFile ( ) , dataDir . toFile ( ) ) ; <nl> @ @ - 178 , 13 + 189 , 13 @ @ public class SystemKeyspaceTest <nl> { <nl> for ( File cfdir : ksdir . listFiles ( ( d , n ) - > d . isDirectory ( ) ) ) <nl> { <nl> - if ( Descriptor . isLegacyFile ( cfdir . getName ( ) ) ) <nl> + if ( Descriptor . isLegacyFile ( cfdir ) ) <nl> { <nl> ret + + ; <nl> } <nl> else <nl> { <nl> - File [ ] legacyFiles = cfdir . listFiles ( ( d , n ) - > Descriptor . isLegacyFile ( n ) ) ; <nl> + File [ ] legacyFiles = cfdir . listFiles ( ( d , n ) - > Descriptor . isLegacyFile ( new File ( d , n ) ) ) ; <nl> ret + = legacyFiles . length ; <nl> } <nl> }
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index d518830 . . 52cc2c1 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 29 , 7 + 29 , 7 @ @ <nl> * add scheduler JMX metrics ( CASSANDRA - 2962 ) <nl> * add block level checksum for compressed data ( CASSANDRA - 1717 ) <nl> * make column family backed column map pluggable and introduce unsynchronized <nl> - ArrayList backed one to speedup reads ( CASSANDRA - 2843 ) <nl> + ArrayList backed one to speedup reads ( CASSANDRA - 2843 , 3165 ) <nl> * refactoring of the secondary index api ( CASSANDRA - 2982 ) <nl> * make CL > ONE reads wait for digest reconciliation before returning <nl> ( CASSANDRA - 2494 ) <nl> diff - - git a / src / java / org / apache / cassandra / db / ArrayBackedSortedColumns . java b / src / java / org / apache / cassandra / db / ArrayBackedSortedColumns . java <nl> index c316a85 . . 71c7213 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ArrayBackedSortedColumns . java <nl> + + + b / src / java / org / apache / cassandra / db / ArrayBackedSortedColumns . java <nl> @ @ - 67 , 6 + 67 , 11 @ @ public class ArrayBackedSortedColumns extends ArrayList < IColumn > implements ISor <nl> this . reversed = reversed ; <nl> } <nl> <nl> + public ISortedColumns . Factory getFactory ( ) <nl> + { <nl> + return factory ( ) ; <nl> + } <nl> + <nl> public AbstractType < ? > getComparator ( ) <nl> { <nl> return comparator ; <nl> diff - - git a / src / java / org / apache / cassandra / db / ColumnFamily . java b / src / java / org / apache / cassandra / db / ColumnFamily . java <nl> index 1239d1c . . 38bc0d7 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ColumnFamily . java <nl> + + + b / src / java / org / apache / cassandra / db / ColumnFamily . java <nl> @ @ - 81 , 14 + 81 , 19 @ @ public class ColumnFamily extends AbstractColumnContainer <nl> this . cfm = cfm ; <nl> } <nl> <nl> - public ColumnFamily cloneMeShallow ( ) <nl> + public ColumnFamily cloneMeShallow ( ISortedColumns . Factory factory ) <nl> { <nl> - ColumnFamily cf = ColumnFamily . create ( cfm ) ; <nl> + ColumnFamily cf = ColumnFamily . create ( cfm , factory ) ; <nl> / / since deletion info is immutable , aliasing it is fine <nl> cf . deletionInfo . set ( deletionInfo . get ( ) ) ; <nl> return cf ; <nl> } <nl> <nl> + public ColumnFamily cloneMeShallow ( ) <nl> + { <nl> + return cloneMeShallow ( columns . getFactory ( ) ) ; <nl> + } <nl> + <nl> public AbstractType getSubComparator ( ) <nl> { <nl> IColumnSerializer s = getColumnSerializer ( ) ; <nl> diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> index 0bfd1c5 . . 552d3e9 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> @ @ - 1162 , 8 + 1162 , 11 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean <nl> } <nl> } <nl> <nl> - / * * filter a cached row , which will not be modified by the filter , but may be modified by throwing out <nl> - * tombstones that are no longer relevant . * / <nl> + / * * <nl> + * Filter a cached row , which will not be modified by the filter , but may be modified by throwing out <nl> + * tombstones that are no longer relevant . <nl> + * The returned column family won ' t be thread safe . <nl> + * / <nl> ColumnFamily filterColumnFamily ( ColumnFamily cached , QueryFilter filter , int gcBefore ) <nl> { <nl> / / special case slicing the entire row : <nl> @ @ - 1184 , 7 + 1187 , 7 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean <nl> IColumn sc = cached . getColumn ( filter . path . superColumnName ) ; <nl> if ( sc = = null | | sliceFilter . count > = sc . getSubColumns ( ) . size ( ) ) <nl> { <nl> - ColumnFamily cf = cached . cloneMeShallow ( ) ; <nl> + ColumnFamily cf = cached . cloneMeShallow ( ArrayBackedSortedColumns . factory ( ) ) ; <nl> if ( sc ! = null ) <nl> cf . addColumn ( sc , HeapAllocator . instance ) ; <nl> return removeDeleted ( cf , gcBefore ) ; <nl> @ @ - 1203 , 7 + 1206 , 7 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean <nl> } <nl> <nl> IColumnIterator ci = filter . getMemtableColumnIterator ( cached , null , getComparator ( ) ) ; <nl> - ColumnFamily cf = ci . getColumnFamily ( ) . cloneMeShallow ( ) ; <nl> + ColumnFamily cf = ci . getColumnFamily ( ) . cloneMeShallow ( ArrayBackedSortedColumns . factory ( ) ) ; <nl> filter . collateColumns ( cf , Collections . singletonList ( ci ) , getComparator ( ) , gcBefore ) ; <nl> / / TODO this is necessary because when we collate supercolumns together , we don ' t check <nl> / / their subcolumns for relevance , so we need to do a second prune post facto here . <nl> diff - - git a / src / java / org / apache / cassandra / db / ISortedColumns . java b / src / java / org / apache / cassandra / db / ISortedColumns . java <nl> index 37f5a60 . . 624dec7 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ISortedColumns . java <nl> + + + b / src / java / org / apache / cassandra / db / ISortedColumns . java <nl> @ @ - 42 , 6 + 42 , 11 @ @ public interface ISortedColumns extends IIterableColumns <nl> public ISortedColumns cloneMe ( ) ; <nl> <nl> / * * <nl> + * Returns the factory used for this ISortedColumns implementation . <nl> + * / <nl> + public Factory getFactory ( ) ; <nl> + <nl> + / * * <nl> * Adds a column to this column map . <nl> * If a column with the same name is already present in the map , it will <nl> * be replaced by the newly added column . <nl> diff - - git a / src / java / org / apache / cassandra / db / ThreadSafeSortedColumns . java b / src / java / org / apache / cassandra / db / ThreadSafeSortedColumns . java <nl> index cd2488a . . 13a111a 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ThreadSafeSortedColumns . java <nl> + + + b / src / java / org / apache / cassandra / db / ThreadSafeSortedColumns . java <nl> @ @ - 62 , 6 + 62 , 11 @ @ public class ThreadSafeSortedColumns extends ConcurrentSkipListMap < ByteBuffer , I <nl> super ( columns ) ; <nl> } <nl> <nl> + public ISortedColumns . Factory getFactory ( ) <nl> + { <nl> + return factory ( ) ; <nl> + } <nl> + <nl> public ISortedColumns cloneMe ( ) <nl> { <nl> return new ThreadSafeSortedColumns ( this ) ; <nl> diff - - git a / src / java / org / apache / cassandra / db / TreeMapBackedSortedColumns . java b / src / java / org / apache / cassandra / db / TreeMapBackedSortedColumns . java <nl> index 34e83dc . . 6c3fc42 100644 <nl> - - - a / src / java / org / apache / cassandra / db / TreeMapBackedSortedColumns . java <nl> + + + b / src / java / org / apache / cassandra / db / TreeMapBackedSortedColumns . java <nl> @ @ - 62 , 6 + 62 , 11 @ @ public class TreeMapBackedSortedColumns extends TreeMap < ByteBuffer , IColumn > imp <nl> super ( columns ) ; <nl> } <nl> <nl> + public ISortedColumns . Factory getFactory ( ) <nl> + { <nl> + return factory ( ) ; <nl> + } <nl> + <nl> public ISortedColumns cloneMe ( ) <nl> { <nl> return new TreeMapBackedSortedColumns ( this ) ;

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index eacc110 . . b23c2d1 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 12 , 6 + 12 , 7 @ @ 
 * Bytecode inspection for Java - UDFs ( CASSANDRA - 9890 ) 
 * Use byte to serialize MT hash length ( CASSANDRA - 9792 ) 
 * Replace usage of Adler32 with CRC32 ( CASSANDRA - 8684 ) 
 + * Fix migration to new format from 2 . 1 SSTable ( CASSANDRA - 10006 ) 
 Merged from 2 . 2 : 
 * Add checksum to saved cache files ( CASSANDRA - 9265 ) 
 * Log warning when using an aggregate without partition key ( CASSANDRA - 9737 ) 
 diff - - git a / src / java / org / apache / cassandra / db / SystemKeyspace . java b / src / java / org / apache / cassandra / db / SystemKeyspace . java 
 index bc0be65 . . d24b18b 100644 
 - - - a / src / java / org / apache / cassandra / db / SystemKeyspace . java 
 + + + b / src / java / org / apache / cassandra / db / SystemKeyspace . java 
 @ @ - 1307 , 7 + 1307 , 7 @ @ public final class SystemKeyspace 
 } 
 
 / * * 
 - * Check data directories for old files that can be removed when migrating from 2 . 2 to 3 . 0 , 
 + * Check data directories for old files that can be removed when migrating from 2 . 1 or 2 . 2 to 3 . 0 , 
 * these checks can be removed in 4 . 0 , see CASSANDRA - 7066 
 * / 
 public static void migrateDataDirs ( ) 
 @ @ - 1323 , 13 + 1323 , 13 @ @ public final class SystemKeyspace 
 { 
 for ( File cfdir : ksdir . listFiles ( ( d , n ) - > d . isDirectory ( ) ) ) 
 { 
 - if ( Descriptor . isLegacyFile ( cfdir . getName ( ) ) ) 
 + if ( Descriptor . isLegacyFile ( cfdir ) ) 
 { 
 FileUtils . deleteRecursive ( cfdir ) ; 
 } 
 else 
 { 
 - FileUtils . delete ( cfdir . listFiles ( ( d , n ) - > Descriptor . isLegacyFile ( n ) ) ) ; 
 + FileUtils . delete ( cfdir . listFiles ( ( d , n ) - > Descriptor . isLegacyFile ( new File ( d , n ) ) ) ) ; 
 } 
 } 
 } 
 diff - - git a / src / java / org / apache / cassandra / io / sstable / Descriptor . java b / src / java / org / apache / cassandra / io / sstable / Descriptor . java 
 index 519f14e . . 38829df 100644 
 - - - a / src / java / org / apache / cassandra / io / sstable / Descriptor . java 
 + + + b / src / java / org / apache / cassandra / io / sstable / Descriptor . java 
 @ @ - 19 , 6 + 19 , 7 @ @ package org . apache . cassandra . io . sstable ; 
 
 import java . io . File ; 
 import java . util . * ; 
 + import java . util . regex . Pattern ; 
 
 import com . google . common . base . CharMatcher ; 
 import com . google . common . base . Objects ; 
 @ @ - 30 , 7 + 31 , 6 @ @ import org . apache . cassandra . io . sstable . format . Version ; 
 import org . apache . cassandra . io . sstable . metadata . IMetadataSerializer ; 
 import org . apache . cassandra . io . sstable . metadata . LegacyMetadataSerializer ; 
 import org . apache . cassandra . io . sstable . metadata . MetadataSerializer ; 
 - import org . apache . cassandra . net . MessagingService ; 
 import org . apache . cassandra . utils . Pair ; 
 
 import static org . apache . cassandra . io . sstable . Component . separator ; 
 @ @ - 163 , 20 + 163 , 29 @ @ public class Descriptor 
 } 
 
 / * * 
 - * Files obsoleted by CASSANDRA - 7066 : 
 - * - temporary files used to start with either tmp or tmplink 
 - * - system . compactions _ in _ progress sstable files 
 + * Files obsoleted by CASSANDRA - 7066 : temporary files and compactions _ in _ progress . We support 
 + * versions 2 . 1 ( ka ) and 2 . 2 ( la ) . 
 + * Temporary files have tmp - or tmplink - at the beginning for 2 . 2 sstables or after ks - cf - for 2 . 1 sstables 
 * / 
 - public static boolean isLegacyFile ( String fileName ) 
 + 
 + private final static String LEGACY _ COMP _ IN _ PROG _ REGEX _ STR = " ^ compactions _ in _ progress ( \ \ - [ \ \ d , a - f ] { 32 } ) ? $ " ; 
 + private final static Pattern LEGACY _ COMP _ IN _ PROG _ REGEX = Pattern . compile ( LEGACY _ COMP _ IN _ PROG _ REGEX _ STR ) ; 
 + private final static String LEGACY _ TMP _ REGEX _ STR = " ^ ( ( . * ) \ \ - ( . * ) \ \ - ) ? tmp ( link ) ? \ \ - ( la | ka ) \ \ - ( \ \ d ) * \ \ - ( . * ) $ " ; 
 + private final static Pattern LEGACY _ TMP _ REGEX = Pattern . compile ( LEGACY _ TMP _ REGEX _ STR ) ; 
 + 
 + public static boolean isLegacyFile ( File file ) 
 { 
 - return fileName . startsWith ( " compactions _ in _ progress " ) | | 
 - fileName . startsWith ( " tmp " ) | | 
 - fileName . startsWith ( " tmplink " ) ; 
 + if ( file . isDirectory ( ) ) 
 + return file . getParentFile ( ) ! = null & & 
 + file . getParentFile ( ) . getName ( ) . equalsIgnoreCase ( " system " ) & & 
 + LEGACY _ COMP _ IN _ PROG _ REGEX . matcher ( file . getName ( ) ) . matches ( ) ; 
 + else 
 + return LEGACY _ TMP _ REGEX . matcher ( file . getName ( ) ) . matches ( ) ; 
 } 
 
 public static boolean isValidFile ( String fileName ) 
 { 
 - return fileName . endsWith ( " . db " ) & & ! isLegacyFile ( fileName ) ; 
 + return fileName . endsWith ( " . db " ) & & ! LEGACY _ TMP _ REGEX . matcher ( fileName ) . matches ( ) ; 
 } 
 
 / * * 
 diff - - git a / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - CompressionInfo . db b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - CompressionInfo . db 
 new file mode 100644 
 index 0000000 . . d9446df 
 Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - CompressionInfo . db differ 
 diff - - git a / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Data . db b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Data . db 
 new file mode 100644 
 index 0000000 . . f7b696d 
 Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Data . db differ 
 diff - - git a / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Digest . sha1 b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Digest . sha1 
 new file mode 100644 
 index 0000000 . . 55756dd 
 - - - / dev / null 
 + + + b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Digest . sha1 
 @ @ - 0 , 0 + 1 @ @ 
 + 3043896114 
 \ No newline at end of file 
 diff - - git a / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Filter . db b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Filter . db 
 new file mode 100644 
 index 0000000 . . 3015f10 
 Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Filter . db differ 
 diff - - git a / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Index . db b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Index . db 
 new file mode 100644 
 index 0000000 . . c8b59fb 
 Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Index . db differ 
 diff - - git a / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Statistics . db b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Statistics . db 
 new file mode 100644 
 index 0000000 . . 8535f6a 
 Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Statistics . db differ 
 diff - - git a / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Summary . db b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Summary . db 
 new file mode 100644 
 index 0000000 . . d9ce8c2 
 Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - Summary . db differ 
 diff - - git a / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - TOC . txt b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - TOC . txt 
 new file mode 100644 
 index 0000000 . . 7dc8930 
 - - - / dev / null 
 + + + b / test / data / migration - sstables / 2 . 1 / system / compactions _ in _ progress - 55080ab05d9c388690a4acb25fe1f77b / system - compactions _ in _ progress - ka - 1 - TOC . txt 
 @ @ - 0 , 0 + 1 , 8 @ @ 
 + Data . db 
 + TOC . txt 
 + Filter . db 
 + Statistics . db 
 + Summary . db 
 + Index . db 
 + Digest . sha1 
 + CompressionInfo . db 
 diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - CompressionInfo . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - CompressionInfo . db 
 new file mode 100644 
 index 0000000 . . b867db8 
 Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - CompressionInfo . db differ 
 diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Data . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Data . db 
 new file mode 100644 
 index 0000000 . . f14d86d 
 Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Data . db differ 
 diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Digest . sha1 b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Digest . sha1 
 new file mode 100644 
 index 0000000 . . 2f4daa9 
 - - - / dev / null 
 + + + b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Digest . sha1 
 @ @ - 0 , 0 + 1 @ @ 
 + 4283441474 
 \ No newline at end of file 
 diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Filter . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Filter . db 
 new file mode 100644 
 index 0000000 . . a5bdd8e 
 Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Filter . db differ 
 diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Index . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Index . db 
 new file mode 100644 
 index 0000000 . . 5d71315 
 Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Index . db differ 
 diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Statistics . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Statistics . db 
 new file mode 100644 
 index 0000000 . . aeb2bb8 
 Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Statistics . db differ 
 diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Summary . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Summary . db 
 new file mode 100644 
 index 0000000 . . 602ec06 
 Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - Summary . db differ 
 diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - TOC . txt b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - TOC . txt 
 new file mode 100644 
 index 0000000 . . 7dc8930 
 - - - / dev / null 
 + + + b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - ka - 3 - TOC . txt 
 @ @ - 0 , 0 + 1 , 8 @ @ 
 + Data . db 
 + TOC . txt 
 + Filter . db 
 + Statistics . db 
 + Summary . db 
 + Index . db 
 + Digest . sha1 
 + CompressionInfo . db 
 diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmp - ka - 4 - Data . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmp - ka - 4 - Data . db 
 new file mode 100644 
 index 0000000 . . f14d86d 
 Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmp - ka - 4 - Data . db differ 
 diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmp - ka - 4 - Index . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmp - ka - 4 - Index . db 
 new file mode 100644 
 index 0000000 . . 5d71315 
 Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmp - ka - 4 - Index . db differ 
 diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmplink - ka - 4 - Data . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmplink - ka - 4 - Data . db 
 new file mode 100644 
 index 0000000 . . f14d86d 
 Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmplink - ka - 4 - Data . db differ 
 diff - - git a / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmplink - ka - 4 - Index . db b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmplink - ka - 4 - Index . db 
 new file mode 100644 
 index 0000000 . . 5d71315 
 Binary files / dev / null and b / test / data / migration - sstables / 2 . 1 / test / foo - 0094ac203e7411e59149ef9f87394ca6 / test - foo - tmplink - ka - 4 - Index . db differ 
 diff - - git a / test / unit / org / apache / cassandra / db / SystemKeyspaceTest . java b / test / unit / org / apache / cassandra / db / SystemKeyspaceTest . java 
 index d58985c . . 9fc3503 100644 
 - - - a / test / unit / org / apache / cassandra / db / SystemKeyspaceTest . java 
 + + + b / test / unit / org / apache / cassandra / db / SystemKeyspaceTest . java 
 @ @ - 153 , 9 + 153 , 20 @ @ public class SystemKeyspaceTest 
 } 
 
 @ Test 
 - public void testMigrateDataDirs ( ) throws IOException 
 + public void testMigrateDataDirs _ 2 _ 1 ( ) throws IOException 
 { 
 - Path migrationSSTableRoot = Paths . get ( System . getProperty ( MIGRATION _ SSTABLES _ ROOT ) , " 2 . 2 " ) ; 
 + testMigrateDataDirs ( " 2 . 1 " ) ; 
 + } 
 + 
 + @ Test 
 + public void testMigrateDataDirs _ 2 _ 2 ( ) throws IOException 
 + { 
 + testMigrateDataDirs ( " 2 . 2 " ) ; 
 + } 
 + 
 + private void testMigrateDataDirs ( String version ) throws IOException 
 + { 
 + Path migrationSSTableRoot = Paths . get ( System . getProperty ( MIGRATION _ SSTABLES _ ROOT ) , version ) ; 
 Path dataDir = Paths . get ( DatabaseDescriptor . getAllDataFileLocations ( ) [ 0 ] ) ; 
 
 FileUtils . copyDirectory ( migrationSSTableRoot . toFile ( ) , dataDir . toFile ( ) ) ; 
 @ @ - 178 , 13 + 189 , 13 @ @ public class SystemKeyspaceTest 
 { 
 for ( File cfdir : ksdir . listFiles ( ( d , n ) - > d . isDirectory ( ) ) ) 
 { 
 - if ( Descriptor . isLegacyFile ( cfdir . getName ( ) ) ) 
 + if ( Descriptor . isLegacyFile ( cfdir ) ) 
 { 
 ret + + ; 
 } 
 else 
 { 
 - File [ ] legacyFiles = cfdir . listFiles ( ( d , n ) - > Descriptor . isLegacyFile ( n ) ) ; 
 + File [ ] legacyFiles = cfdir . listFiles ( ( d , n ) - > Descriptor . isLegacyFile ( new File ( d , n ) ) ) ; 
 ret + = legacyFiles . length ; 
 } 
 }

NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index d518830 . . 52cc2c1 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 29 , 7 + 29 , 7 @ @ 
 * add scheduler JMX metrics ( CASSANDRA - 2962 ) 
 * add block level checksum for compressed data ( CASSANDRA - 1717 ) 
 * make column family backed column map pluggable and introduce unsynchronized 
 - ArrayList backed one to speedup reads ( CASSANDRA - 2843 ) 
 + ArrayList backed one to speedup reads ( CASSANDRA - 2843 , 3165 ) 
 * refactoring of the secondary index api ( CASSANDRA - 2982 ) 
 * make CL > ONE reads wait for digest reconciliation before returning 
 ( CASSANDRA - 2494 ) 
 diff - - git a / src / java / org / apache / cassandra / db / ArrayBackedSortedColumns . java b / src / java / org / apache / cassandra / db / ArrayBackedSortedColumns . java 
 index c316a85 . . 71c7213 100644 
 - - - a / src / java / org / apache / cassandra / db / ArrayBackedSortedColumns . java 
 + + + b / src / java / org / apache / cassandra / db / ArrayBackedSortedColumns . java 
 @ @ - 67 , 6 + 67 , 11 @ @ public class ArrayBackedSortedColumns extends ArrayList < IColumn > implements ISor 
 this . reversed = reversed ; 
 } 
 
 + public ISortedColumns . Factory getFactory ( ) 
 + { 
 + return factory ( ) ; 
 + } 
 + 
 public AbstractType < ? > getComparator ( ) 
 { 
 return comparator ; 
 diff - - git a / src / java / org / apache / cassandra / db / ColumnFamily . java b / src / java / org / apache / cassandra / db / ColumnFamily . java 
 index 1239d1c . . 38bc0d7 100644 
 - - - a / src / java / org / apache / cassandra / db / ColumnFamily . java 
 + + + b / src / java / org / apache / cassandra / db / ColumnFamily . java 
 @ @ - 81 , 14 + 81 , 19 @ @ public class ColumnFamily extends AbstractColumnContainer 
 this . cfm = cfm ; 
 } 
 
 - public ColumnFamily cloneMeShallow ( ) 
 + public ColumnFamily cloneMeShallow ( ISortedColumns . Factory factory ) 
 { 
 - ColumnFamily cf = ColumnFamily . create ( cfm ) ; 
 + ColumnFamily cf = ColumnFamily . create ( cfm , factory ) ; 
 / / since deletion info is immutable , aliasing it is fine 
 cf . deletionInfo . set ( deletionInfo . get ( ) ) ; 
 return cf ; 
 } 
 
 + public ColumnFamily cloneMeShallow ( ) 
 + { 
 + return cloneMeShallow ( columns . getFactory ( ) ) ; 
 + } 
 + 
 public AbstractType getSubComparator ( ) 
 { 
 IColumnSerializer s = getColumnSerializer ( ) ; 
 diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 index 0bfd1c5 . . 552d3e9 100644 
 - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 @ @ - 1162 , 8 + 1162 , 11 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean 
 } 
 } 
 
 - / * * filter a cached row , which will not be modified by the filter , but may be modified by throwing out 
 - * tombstones that are no longer relevant . * / 
 + / * * 
 + * Filter a cached row , which will not be modified by the filter , but may be modified by throwing out 
 + * tombstones that are no longer relevant . 
 + * The returned column family won ' t be thread safe . 
 + * / 
 ColumnFamily filterColumnFamily ( ColumnFamily cached , QueryFilter filter , int gcBefore ) 
 { 
 / / special case slicing the entire row : 
 @ @ - 1184 , 7 + 1187 , 7 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean 
 IColumn sc = cached . getColumn ( filter . path . superColumnName ) ; 
 if ( sc = = null | | sliceFilter . count > = sc . getSubColumns ( ) . size ( ) ) 
 { 
 - ColumnFamily cf = cached . cloneMeShallow ( ) ; 
 + ColumnFamily cf = cached . cloneMeShallow ( ArrayBackedSortedColumns . factory ( ) ) ; 
 if ( sc ! = null ) 
 cf . addColumn ( sc , HeapAllocator . instance ) ; 
 return removeDeleted ( cf , gcBefore ) ; 
 @ @ - 1203 , 7 + 1206 , 7 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean 
 } 
 
 IColumnIterator ci = filter . getMemtableColumnIterator ( cached , null , getComparator ( ) ) ; 
 - ColumnFamily cf = ci . getColumnFamily ( ) . cloneMeShallow ( ) ; 
 + ColumnFamily cf = ci . getColumnFamily ( ) . cloneMeShallow ( ArrayBackedSortedColumns . factory ( ) ) ; 
 filter . collateColumns ( cf , Collections . singletonList ( ci ) , getComparator ( ) , gcBefore ) ; 
 / / TODO this is necessary because when we collate supercolumns together , we don ' t check 
 / / their subcolumns for relevance , so we need to do a second prune post facto here . 
 diff - - git a / src / java / org / apache / cassandra / db / ISortedColumns . java b / src / java / org / apache / cassandra / db / ISortedColumns . java 
 index 37f5a60 . . 624dec7 100644 
 - - - a / src / java / org / apache / cassandra / db / ISortedColumns . java 
 + + + b / src / java / org / apache / cassandra / db / ISortedColumns . java 
 @ @ - 42 , 6 + 42 , 11 @ @ public interface ISortedColumns extends IIterableColumns 
 public ISortedColumns cloneMe ( ) ; 
 
 / * * 
 + * Returns the factory used for this ISortedColumns implementation . 
 + * / 
 + public Factory getFactory ( ) ; 
 + 
 + / * * 
 * Adds a column to this column map . 
 * If a column with the same name is already present in the map , it will 
 * be replaced by the newly added column . 
 diff - - git a / src / java / org / apache / cassandra / db / ThreadSafeSortedColumns . java b / src / java / org / apache / cassandra / db / ThreadSafeSortedColumns . java 
 index cd2488a . . 13a111a 100644 
 - - - a / src / java / org / apache / cassandra / db / ThreadSafeSortedColumns . java 
 + + + b / src / java / org / apache / cassandra / db / ThreadSafeSortedColumns . java 
 @ @ - 62 , 6 + 62 , 11 @ @ public class ThreadSafeSortedColumns extends ConcurrentSkipListMap < ByteBuffer , I 
 super ( columns ) ; 
 } 
 
 + public ISortedColumns . Factory getFactory ( ) 
 + { 
 + return factory ( ) ; 
 + } 
 + 
 public ISortedColumns cloneMe ( ) 
 { 
 return new ThreadSafeSortedColumns ( this ) ; 
 diff - - git a / src / java / org / apache / cassandra / db / TreeMapBackedSortedColumns . java b / src / java / org / apache / cassandra / db / TreeMapBackedSortedColumns . java 
 index 34e83dc . . 6c3fc42 100644 
 - - - a / src / java / org / apache / cassandra / db / TreeMapBackedSortedColumns . java 
 + + + b / src / java / org / apache / cassandra / db / TreeMapBackedSortedColumns . java 
 @ @ - 62 , 6 + 62 , 11 @ @ public class TreeMapBackedSortedColumns extends TreeMap < ByteBuffer , IColumn > imp 
 super ( columns ) ; 
 } 
 
 + public ISortedColumns . Factory getFactory ( ) 
 + { 
 + return factory ( ) ; 
 + } 
 + 
 public ISortedColumns cloneMe ( ) 
 { 
 return new TreeMapBackedSortedColumns ( this ) ;
