BLEU SCORE: 0.029381754016308166

TEST MSG: Fix Util . spinAssertEquals
GENERATED MSG: add check for sane start / end keys

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 9d328ae . . b550885 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 2 . 2 . 9 <nl> + * Fix Util . spinAssertEquals ( CASSANDRA - 12283 ) <nl> * Fix potential NPE for compactionstats ( CASSANDRA - 12462 ) <nl> * Prepare legacy authenticate statement if credentials table initialised after node startup ( CASSANDRA - 12813 ) <nl> * Change cassandra . wait _ for _ tracing _ events _ timeout _ secs default to 0 ( CASSANDRA - 12754 ) <nl> diff - - git a / test / unit / org / apache / cassandra / Util . java b / test / unit / org / apache / cassandra / Util . java <nl> index 91aa5fd . . f6b4771 100644 <nl> - - - a / test / unit / org / apache / cassandra / Util . java <nl> + + + b / test / unit / org / apache / cassandra / Util . java <nl> @ @ - 24 , 18 + 24 , 12 @ @ import java . io . * ; <nl> import java . net . InetAddress ; <nl> import java . net . UnknownHostException ; <nl> import java . nio . ByteBuffer ; <nl> - import java . nio . channels . FileChannel ; <nl> import java . util . * ; <nl> import java . util . concurrent . Callable ; <nl> import java . util . concurrent . Future ; <nl> <nl> import com . google . common . base . Supplier ; <nl> - import com . google . common . collect . ImmutableMap ; <nl> - import com . google . common . collect . ImmutableSet ; <nl> <nl> - import org . apache . cassandra . cache . CachingOptions ; <nl> - import org . apache . cassandra . config . CFMetaData ; <nl> - import org . apache . cassandra . config . KSMetaData ; <nl> import org . apache . cassandra . db . * ; <nl> import org . apache . cassandra . db . composites . * ; <nl> import org . apache . cassandra . db . compaction . AbstractCompactionTask ; <nl> @ @ - 46 , 27 + 40 , 16 @ @ import org . apache . cassandra . db . filter . QueryFilter ; <nl> import org . apache . cassandra . db . filter . SliceQueryFilter ; <nl> import org . apache . cassandra . db . filter . NamesQueryFilter ; <nl> import org . apache . cassandra . db . marshal . AbstractType ; <nl> - import org . apache . cassandra . db . marshal . UTF8Type ; <nl> import org . apache . cassandra . dht . * ; <nl> import org . apache . cassandra . dht . RandomPartitioner . BigIntegerToken ; <nl> import org . apache . cassandra . gms . ApplicationState ; <nl> import org . apache . cassandra . gms . Gossiper ; <nl> import org . apache . cassandra . gms . VersionedValue ; <nl> - import org . apache . cassandra . io . sstable . Component ; <nl> import org . apache . cassandra . io . sstable . Descriptor ; <nl> - import org . apache . cassandra . io . sstable . IndexSummary ; <nl> import org . apache . cassandra . io . sstable . format . SSTableReader ; <nl> - import org . apache . cassandra . io . sstable . format . big . BigTableReader ; <nl> - import org . apache . cassandra . io . sstable . metadata . MetadataCollector ; <nl> - import org . apache . cassandra . io . sstable . metadata . MetadataType ; <nl> - import org . apache . cassandra . io . sstable . metadata . StatsMetadata ; <nl> - import org . apache . cassandra . io . util . * ; <nl> - import org . apache . cassandra . locator . SimpleStrategy ; <nl> import org . apache . cassandra . service . StorageService ; <nl> - import org . apache . cassandra . utils . AlwaysPresentFilter ; <nl> import org . apache . cassandra . utils . ByteBufferUtil ; <nl> import org . apache . cassandra . utils . CounterId ; <nl> - import org . apache . hadoop . fs . FileUtil ; <nl> <nl> import static org . junit . Assert . assertEquals ; <nl> import static org . junit . Assert . assertTrue ; <nl> @ @ - 80 , 7 + 63 , 7 @ @ public class Util <nl> return StorageService . getPartitioner ( ) . decorateKey ( ByteBufferUtil . bytes ( key ) ) ; <nl> } <nl> <nl> - public static DecoratedKey dk ( String key , AbstractType type ) <nl> + public static DecoratedKey dk ( String key , AbstractType < ? > type ) <nl> { <nl> return StorageService . getPartitioner ( ) . decorateKey ( type . fromString ( key ) ) ; <nl> } <nl> @ @ - 386 , 8 + 369 , 8 @ @ public class Util <nl> <nl> public static void spinAssertEquals ( Object expected , Supplier < Object > s , int timeoutInSeconds ) <nl> { <nl> - long now = System . currentTimeMillis ( ) ; <nl> - while ( System . currentTimeMillis ( ) - now < now + ( 1000 * timeoutInSeconds ) ) <nl> + long start = System . currentTimeMillis ( ) ; <nl> + while ( System . currentTimeMillis ( ) < start + ( 1000 * timeoutInSeconds ) ) <nl> { <nl> if ( s . get ( ) . equals ( expected ) ) <nl> break ;
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index f01f133 . . 8b94421 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 10 , 6 + 10 , 7 @ @ <nl> ( CASSANDRA - 2419 ) <nl> * JDBC CQL driver exposes getColumn for access to timestamp <nl> * JDBC ResultSetMetadata properties added to AbstractType <nl> + * r / m clustertool ( CASSANDRA - 2607 ) <nl> <nl> <nl> 0 . 8 . 0 - beta2 <nl> diff - - git a / NEWS . txt b / NEWS . txt <nl> index 760ff39 . . 8a4a64e 100644 <nl> - - - a / NEWS . txt <nl> + + + b / NEWS . txt <nl> @ @ - 37 , 6 + 37 , 13 @ @ Features <nl> will be removed in a future major release once we are satisfied that <nl> memtable _ total _ space _ in _ mb works adequately . <nl> <nl> + Tools <nl> + - - - - - <nl> + - stress and py _ stress moved from contrib / to tools / <nl> + - clustertool was removed ( see <nl> + https : / / issues . apache . org / jira / browse / CASSANDRA - 2607 for examples <nl> + of how to script nodetool across the cluster instead ) <nl> + <nl> Other <nl> - - - - - <nl> - In the past , sstable2json would write column names and values as <nl> diff - - git a / bin / clustertool b / bin / clustertool <nl> deleted file mode 100755 <nl> index 0dbfd02 . . 0000000 <nl> - - - a / bin / clustertool <nl> + + + / dev / null <nl> @ @ - 1 , 57 + 0 , 0 @ @ <nl> - # ! / bin / sh <nl> - # Licensed to the Apache Software Foundation ( ASF ) under one <nl> - # or more contributor license agreements . See the NOTICE file <nl> - # distributed with this work for additional information <nl> - # regarding copyright ownership . The ASF licenses this file <nl> - # to you under the Apache License , Version 2 . 0 ( the <nl> - # " License " ) ; you may not use this file except in compliance <nl> - # with the License . You may obtain a copy of the License at <nl> - # <nl> - # http : / / www . apache . org / licenses / LICENSE - 2 . 0 <nl> - # <nl> - # Unless required by applicable law or agreed to in writing , software <nl> - # distributed under the License is distributed on an " AS IS " BASIS , <nl> - # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . <nl> - # See the License for the specific language governing permissions and <nl> - # limitations under the License . <nl> - <nl> - <nl> - if [ " x $ CASSANDRA _ INCLUDE " = " x " ] ; then <nl> - for include in / usr / share / cassandra / cassandra . in . sh \ <nl> - / usr / local / share / cassandra / cassandra . in . sh \ <nl> - / opt / cassandra / cassandra . in . sh \ <nl> - ` dirname $ 0 ` / cassandra . in . sh ; do <nl> - if [ - r $ include ] ; then <nl> - . $ include <nl> - break <nl> - fi <nl> - done <nl> - elif [ - r $ CASSANDRA _ INCLUDE ] ; then <nl> - . $ CASSANDRA _ INCLUDE <nl> - fi <nl> - <nl> - # Use JAVA _ HOME if set , otherwise look for java in PATH <nl> - if [ - x $ JAVA _ HOME / bin / java ] ; then <nl> - JAVA = $ JAVA _ HOME / bin / java <nl> - else <nl> - JAVA = ` which java ` <nl> - fi <nl> - <nl> - if [ - z $ CASSANDRA _ CONF - o - z $ CLASSPATH ] ; then <nl> - echo " You must set the CASSANDRA _ CONF and CLASSPATH vars " > & 2 <nl> - exit 1 <nl> - fi <nl> - <nl> - # Special - case path variables . <nl> - case " ` uname ` " in <nl> - CYGWIN * ) <nl> - CLASSPATH = ` cygpath - p - w " $ CLASSPATH " ` <nl> - CASSANDRA _ CONF = ` cygpath - p - w " $ CASSANDRA _ CONF " ` <nl> - ; ; <nl> - esac <nl> - <nl> - $ JAVA - cp $ CLASSPATH \ <nl> - - Dlog4j . configuration = log4j - tools . properties \ <nl> - org . apache . cassandra . tools . ClusterCmd $ @ <nl> - <nl> - # vi : ai sw = 4 ts = 4 tw = 0 et <nl> diff - - git a / bin / clustertool . bat b / bin / clustertool . bat <nl> deleted file mode 100644 <nl> index c607f2f . . 0000000 <nl> - - - a / bin / clustertool . bat <nl> + + + / dev / null <nl> @ @ - 1 , 67 + 0 , 0 @ @ <nl> - @ REM <nl> - @ REM Licensed to the Apache Software Foundation ( ASF ) under one or more <nl> - @ REM contributor license agreements . See the NOTICE file distributed with <nl> - @ REM this work for additional information regarding copyright ownership . <nl> - @ REM The ASF licenses this file to You under the Apache License , Version 2 . 0 <nl> - @ REM ( the " License " ) ; you may not use this file except in compliance with <nl> - @ REM the License . You may obtain a copy of the License at <nl> - @ REM <nl> - @ REM http : / / www . apache . org / licenses / LICENSE - 2 . 0 <nl> - @ REM <nl> - @ REM Unless required by applicable law or agreed to in writing , software <nl> - @ REM distributed under the License is distributed on an " AS IS " BASIS , <nl> - @ REM WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . <nl> - @ REM See the License for the specific language governing permissions and <nl> - @ REM limitations under the License . <nl> - <nl> - @ echo off <nl> - if " % OS % " = = " Windows _ NT " setlocal <nl> - <nl> - if NOT DEFINED CASSANDRA _ HOME set CASSANDRA _ HOME = % ~ dp0 . . <nl> - if NOT DEFINED CASSANDRA _ CONF set CASSANDRA _ CONF = % CASSANDRA _ HOME % \ conf <nl> - if NOT DEFINED CASSANDRA _ MAIN set CASSANDRA _ MAIN = org . apache . cassandra . tools . ClusterCmd <nl> - if NOT DEFINED JAVA _ HOME goto err <nl> - <nl> - REM * * * * * JAVA options * * * * * <nl> - set JAVA _ OPTS = ^ <nl> - - Dlog4j . configuration = log4j - tools . properties <nl> - <nl> - REM * * * * * CLASSPATH library setting * * * * * <nl> - <nl> - REM Ensure that any user defined CLASSPATH variables are not used on startup <nl> - set CLASSPATH = % CASSANDRA _ HOME % \ conf <nl> - <nl> - REM For each jar in the CASSANDRA _ HOME lib directory call append to build the CLASSPATH variable . <nl> - for % % i in ( % CASSANDRA _ HOME % \ lib \ * . jar ) do call : append % % ~ fi <nl> - goto okClasspath <nl> - <nl> - : append <nl> - set CLASSPATH = % CLASSPATH % ; % 1 % 2 <nl> - goto : eof <nl> - <nl> - : okClasspath <nl> - REM Include the build \ classes \ main directory so it works in development <nl> - set CASSANDRA _ CLASSPATH = % CLASSPATH % ; % CASSANDRA _ HOME % \ build \ classes \ main ; % CASSANDRA _ CONF % ; % CASSANDRA _ HOME % \ build \ classes \ thrift <nl> - <nl> - set CASSANDRA _ PARAMS = <nl> - set TOOLS _ PARAMS = <nl> - <nl> - FOR % % A IN ( % * ) DO call : appendToolsParams % % A <nl> - <nl> - goto runTool <nl> - <nl> - : appendToolsParams <nl> - set TOOLS _ PARAMS = % TOOLS _ PARAMS % % 1 <nl> - goto : eof <nl> - <nl> - : runTool <nl> - " % JAVA _ HOME % \ bin \ java " % JAVA _ OPTS % % CASSANDRA _ PARAMS % - cp " % CASSANDRA _ CLASSPATH % " " % CASSANDRA _ MAIN % " % TOOLS _ PARAMS % <nl> - goto finally <nl> - <nl> - : err <nl> - echo JAVA _ HOME environment variable must be set ! <nl> - pause <nl> - <nl> - : finally <nl> - <nl> - ENDLOCAL <nl> diff - - git a / src / java / org / apache / cassandra / tools / ClusterCmd . java b / src / java / org / apache / cassandra / tools / ClusterCmd . java <nl> deleted file mode 100644 <nl> index b4db791 . . 0000000 <nl> - - - a / src / java / org / apache / cassandra / tools / ClusterCmd . java <nl> + + + / dev / null <nl> @ @ - 1 , 272 + 0 , 0 @ @ <nl> - / * * <nl> - * Licensed to the Apache Software Foundation ( ASF ) under one <nl> - * or more contributor license agreements . See the NOTICE file <nl> - * distributed with this work for additional information <nl> - * regarding copyright ownership . The ASF licenses this file <nl> - * to you under the Apache License , Version 2 . 0 ( the <nl> - * " License " ) ; you may not use this file except in compliance <nl> - * with the License . You may obtain a copy of the License at <nl> - * <nl> - * http : / / www . apache . org / licenses / LICENSE - 2 . 0 <nl> - * <nl> - * Unless required by applicable law or agreed to in writing , software <nl> - * distributed under the License is distributed on an " AS IS " BASIS , <nl> - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . <nl> - * See the License for the specific language governing permissions and <nl> - * limitations under the License . <nl> - * / <nl> - package org . apache . cassandra . tools ; <nl> - <nl> - import java . io . IOException ; <nl> - import java . net . InetAddress ; <nl> - import java . util . List ; <nl> - <nl> - import org . apache . commons . cli . * ; <nl> - <nl> - / * * <nl> - * JMX cluster wide operations for Cassandra . <nl> - * / <nl> - public class ClusterCmd { <nl> - private static final String HOST _ OPT _ LONG = " host " ; <nl> - private static final String HOST _ OPT _ SHORT = " h " ; <nl> - private static final String PORT _ OPT _ LONG = " port " ; <nl> - private static final String PORT _ OPT _ SHORT = " p " ; <nl> - private static final int defaultPort = 7199 ; <nl> - private static Options options = null ; <nl> - private CommandLine cmd = null ; <nl> - private NodeProbe probe ; <nl> - <nl> - static <nl> - { <nl> - options = new Options ( ) ; <nl> - Option optHost = new Option ( HOST _ OPT _ SHORT , HOST _ OPT _ LONG , true , " node hostname or ip address " ) ; <nl> - optHost . setRequired ( true ) ; <nl> - options . addOption ( optHost ) ; <nl> - options . addOption ( PORT _ OPT _ SHORT , PORT _ OPT _ LONG , true , " remote jmx agent port number ( defaults to " + defaultPort + " ) " ) ; <nl> - } <nl> - <nl> - / * * <nl> - * Creates a ClusterProbe using command - line arguments . <nl> - * <nl> - * @ param cmdArgs list of arguments passed on the command line <nl> - * @ throws ParseException for missing required , or unrecognized options <nl> - * @ throws IOException on connection failures <nl> - * / <nl> - private ClusterCmd ( String [ ] cmdArgs ) throws ParseException , IOException , InterruptedException <nl> - { <nl> - parseArgs ( cmdArgs ) ; <nl> - String host = cmd . getOptionValue ( HOST _ OPT _ SHORT ) ; <nl> - <nl> - String portNum = cmd . getOptionValue ( PORT _ OPT _ SHORT ) ; <nl> - int port ; <nl> - if ( portNum ! = null ) <nl> - { <nl> - try <nl> - { <nl> - port = Integer . parseInt ( portNum ) ; <nl> - } <nl> - catch ( NumberFormatException e ) <nl> - { <nl> - throw new ParseException ( " Port must be a number " ) ; <nl> - } <nl> - } <nl> - else <nl> - { <nl> - port = defaultPort ; <nl> - } <nl> - <nl> - probe = new NodeProbe ( host , port ) ; <nl> - } <nl> - <nl> - / * * <nl> - * Creates a ClusterProbe using the specified JMX host and port . <nl> - * <nl> - * @ param host hostname or IP address of the JMX agent <nl> - * @ param port TCP port of the remote JMX agent <nl> - * @ throws IOException on connection failures <nl> - * / <nl> - public ClusterCmd ( String host , int port ) throws IOException , InterruptedException <nl> - { <nl> - probe = new NodeProbe ( host , port ) ; <nl> - } <nl> - <nl> - / * * <nl> - * Creates a ClusterProbe using the specified JMX host and default port . <nl> - * <nl> - * @ param host hostname or IP address of the JMX agent <nl> - * @ throws IOException on connection failures <nl> - * / <nl> - public ClusterCmd ( String host ) throws IOException , InterruptedException <nl> - { <nl> - this ( host , defaultPort ) ; <nl> - } <nl> - <nl> - / * * <nl> - * Parse the supplied command line arguments . <nl> - * <nl> - * @ param args arguments passed on the command line <nl> - * @ throws ParseException for missing required , or unrecognized options <nl> - * / <nl> - private void parseArgs ( String [ ] args ) throws ParseException <nl> - { <nl> - CommandLineParser parser = new PosixParser ( ) ; <nl> - cmd = parser . parse ( options , args ) ; <nl> - } <nl> - <nl> - / * * <nl> - * Retrieve any non - option arguments passed on the command line . <nl> - * <nl> - * @ return non - option command args <nl> - * / <nl> - private String [ ] getArgs ( ) <nl> - { <nl> - return cmd . getArgs ( ) ; <nl> - } <nl> - <nl> - / * * <nl> - * Prints usage information to stdout . <nl> - * / <nl> - private static void printUsage ( ) <nl> - { <nl> - HelpFormatter hf = new HelpFormatter ( ) ; <nl> - String header = String . format ( <nl> - " % nAvailable commands : get _ endpoints [ keyspace ] [ key ] , global _ snapshot [ name ] , clear _ global _ snapshot , " + <nl> - " truncate < keyspace > < cfname > " ) ; <nl> - String usage = String . format ( " java % s - host < arg > < command > % n " , ClusterCmd . class . getName ( ) ) ; <nl> - hf . printHelp ( usage , " " , options , header ) ; <nl> - } <nl> - <nl> - public void close ( ) throws IOException <nl> - { <nl> - probe . close ( ) ; <nl> - } <nl> - <nl> - public void printEndpoints ( String keyspace , String key ) <nl> - { <nl> - List < InetAddress > endpoints = probe . getEndpoints ( keyspace , key ) ; <nl> - System . out . println ( String . format ( " % - 17s : % s " , " Key " , key ) ) ; <nl> - System . out . println ( String . format ( " % - 17s : % s " , " Endpoints " , endpoints ) ) ; <nl> - } <nl> - <nl> - / * * <nl> - * Take a snapshot of all tables on all ( live ) nodes in the cluster <nl> - * <nl> - * @ param snapshotName name of the snapshot <nl> - * / <nl> - public void takeGlobalSnapshot ( String snapshotName ) throws IOException , InterruptedException <nl> - { <nl> - <nl> - for ( String liveNode : probe . getLiveNodes ( ) ) <nl> - { <nl> - try <nl> - { <nl> - NodeProbe hostProbe = new NodeProbe ( liveNode , probe . port ) ; <nl> - hostProbe . takeSnapshot ( snapshotName ) ; <nl> - System . out . println ( liveNode + " snapshot taken in directory : " + snapshotName ) ; <nl> - } <nl> - catch ( IOException e ) <nl> - { <nl> - System . out . println ( liveNode + " snapshot FAILED : " + e . getMessage ( ) ) ; <nl> - } <nl> - } <nl> - } <nl> - <nl> - / * * <nl> - * Remove all the existing snapshots from all ( live ) nodes in the cluster <nl> - * / <nl> - public void clearGlobalSnapshot ( String tag ) throws IOException , InterruptedException <nl> - { <nl> - for ( String liveNode : probe . getLiveNodes ( ) ) <nl> - { <nl> - try <nl> - { <nl> - NodeProbe hostProbe = new NodeProbe ( liveNode , probe . port ) ; <nl> - hostProbe . clearSnapshot ( tag ) ; <nl> - System . out . println ( liveNode + " snapshot cleared " ) ; <nl> - } <nl> - catch ( IOException e ) <nl> - { <nl> - System . out . println ( liveNode + " snapshot clear FAILED : " + e . getMessage ( ) ) ; <nl> - } <nl> - } <nl> - } <nl> - <nl> - public void truncate ( String tableName , String cfName ) <nl> - { <nl> - probe . truncate ( tableName , cfName ) ; <nl> - } <nl> - <nl> - / * * <nl> - * @ param args <nl> - * / <nl> - public static void main ( String [ ] args ) throws IOException , InterruptedException <nl> - { <nl> - ClusterCmd clusterCmd = null ; <nl> - try <nl> - { <nl> - clusterCmd = new ClusterCmd ( args ) ; <nl> - } <nl> - catch ( ParseException pe ) <nl> - { <nl> - System . err . println ( pe . getMessage ( ) ) ; <nl> - ClusterCmd . printUsage ( ) ; <nl> - System . exit ( 1 ) ; <nl> - } <nl> - catch ( IOException ioe ) <nl> - { <nl> - System . err . println ( " Error connecting to remote JMX agent ! " ) ; <nl> - ioe . printStackTrace ( ) ; <nl> - System . exit ( 3 ) ; <nl> - } <nl> - <nl> - if ( clusterCmd . getArgs ( ) . length < 1 ) <nl> - { <nl> - System . err . println ( " Missing argument for command . " ) ; <nl> - ClusterCmd . printUsage ( ) ; <nl> - System . exit ( 1 ) ; <nl> - } <nl> - <nl> - / / Execute the requested command . <nl> - String [ ] arguments = clusterCmd . getArgs ( ) ; <nl> - String cmdName = arguments [ 0 ] ; <nl> - if ( cmdName . equals ( " get _ endpoints " ) ) <nl> - { <nl> - if ( arguments . length < = 2 ) <nl> - { <nl> - System . err . println ( " missing keyspace and / or key argument " ) ; <nl> - ClusterCmd . printUsage ( ) ; <nl> - System . exit ( 1 ) ; <nl> - } <nl> - clusterCmd . printEndpoints ( arguments [ 1 ] , arguments [ 2 ] ) ; <nl> - } <nl> - else if ( cmdName . equals ( " global _ snapshot " ) ) <nl> - { <nl> - String snapshotName = arguments . length > 1 ? arguments [ 1 ] : new Long ( System . currentTimeMillis ( ) ) . toString ( ) ; <nl> - clusterCmd . takeGlobalSnapshot ( snapshotName ) ; <nl> - } <nl> - else if ( cmdName . equals ( " clear _ global _ snapshot " ) ) <nl> - { <nl> - String snapshotName = arguments . length > 1 ? arguments [ 1 ] : " " ; <nl> - clusterCmd . clearGlobalSnapshot ( snapshotName ) ; <nl> - } <nl> - else if ( cmdName . equals ( " truncate " ) ) <nl> - { <nl> - if ( arguments . length ! = 3 ) <nl> - { <nl> - System . err . println ( " truncate requires < keyspace > and < columnfamily > arguments " ) ; <nl> - } <nl> - String tableName = arguments [ 1 ] ; <nl> - String cfName = arguments [ 2 ] ; <nl> - clusterCmd . truncate ( tableName , cfName ) ; <nl> - } <nl> - else <nl> - { <nl> - System . err . println ( " Unrecognized command : " + cmdName + " . " ) ; <nl> - ClusterCmd . printUsage ( ) ; <nl> - System . exit ( 1 ) ; <nl> - } <nl> - <nl> - System . exit ( 0 ) ; <nl> - } <nl> - <nl> - }

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 9d328ae . . b550885 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 2 . 2 . 9 
 + * Fix Util . spinAssertEquals ( CASSANDRA - 12283 ) 
 * Fix potential NPE for compactionstats ( CASSANDRA - 12462 ) 
 * Prepare legacy authenticate statement if credentials table initialised after node startup ( CASSANDRA - 12813 ) 
 * Change cassandra . wait _ for _ tracing _ events _ timeout _ secs default to 0 ( CASSANDRA - 12754 ) 
 diff - - git a / test / unit / org / apache / cassandra / Util . java b / test / unit / org / apache / cassandra / Util . java 
 index 91aa5fd . . f6b4771 100644 
 - - - a / test / unit / org / apache / cassandra / Util . java 
 + + + b / test / unit / org / apache / cassandra / Util . java 
 @ @ - 24 , 18 + 24 , 12 @ @ import java . io . * ; 
 import java . net . InetAddress ; 
 import java . net . UnknownHostException ; 
 import java . nio . ByteBuffer ; 
 - import java . nio . channels . FileChannel ; 
 import java . util . * ; 
 import java . util . concurrent . Callable ; 
 import java . util . concurrent . Future ; 
 
 import com . google . common . base . Supplier ; 
 - import com . google . common . collect . ImmutableMap ; 
 - import com . google . common . collect . ImmutableSet ; 
 
 - import org . apache . cassandra . cache . CachingOptions ; 
 - import org . apache . cassandra . config . CFMetaData ; 
 - import org . apache . cassandra . config . KSMetaData ; 
 import org . apache . cassandra . db . * ; 
 import org . apache . cassandra . db . composites . * ; 
 import org . apache . cassandra . db . compaction . AbstractCompactionTask ; 
 @ @ - 46 , 27 + 40 , 16 @ @ import org . apache . cassandra . db . filter . QueryFilter ; 
 import org . apache . cassandra . db . filter . SliceQueryFilter ; 
 import org . apache . cassandra . db . filter . NamesQueryFilter ; 
 import org . apache . cassandra . db . marshal . AbstractType ; 
 - import org . apache . cassandra . db . marshal . UTF8Type ; 
 import org . apache . cassandra . dht . * ; 
 import org . apache . cassandra . dht . RandomPartitioner . BigIntegerToken ; 
 import org . apache . cassandra . gms . ApplicationState ; 
 import org . apache . cassandra . gms . Gossiper ; 
 import org . apache . cassandra . gms . VersionedValue ; 
 - import org . apache . cassandra . io . sstable . Component ; 
 import org . apache . cassandra . io . sstable . Descriptor ; 
 - import org . apache . cassandra . io . sstable . IndexSummary ; 
 import org . apache . cassandra . io . sstable . format . SSTableReader ; 
 - import org . apache . cassandra . io . sstable . format . big . BigTableReader ; 
 - import org . apache . cassandra . io . sstable . metadata . MetadataCollector ; 
 - import org . apache . cassandra . io . sstable . metadata . MetadataType ; 
 - import org . apache . cassandra . io . sstable . metadata . StatsMetadata ; 
 - import org . apache . cassandra . io . util . * ; 
 - import org . apache . cassandra . locator . SimpleStrategy ; 
 import org . apache . cassandra . service . StorageService ; 
 - import org . apache . cassandra . utils . AlwaysPresentFilter ; 
 import org . apache . cassandra . utils . ByteBufferUtil ; 
 import org . apache . cassandra . utils . CounterId ; 
 - import org . apache . hadoop . fs . FileUtil ; 
 
 import static org . junit . Assert . assertEquals ; 
 import static org . junit . Assert . assertTrue ; 
 @ @ - 80 , 7 + 63 , 7 @ @ public class Util 
 return StorageService . getPartitioner ( ) . decorateKey ( ByteBufferUtil . bytes ( key ) ) ; 
 } 
 
 - public static DecoratedKey dk ( String key , AbstractType type ) 
 + public static DecoratedKey dk ( String key , AbstractType < ? > type ) 
 { 
 return StorageService . getPartitioner ( ) . decorateKey ( type . fromString ( key ) ) ; 
 } 
 @ @ - 386 , 8 + 369 , 8 @ @ public class Util 
 
 public static void spinAssertEquals ( Object expected , Supplier < Object > s , int timeoutInSeconds ) 
 { 
 - long now = System . currentTimeMillis ( ) ; 
 - while ( System . currentTimeMillis ( ) - now < now + ( 1000 * timeoutInSeconds ) ) 
 + long start = System . currentTimeMillis ( ) ; 
 + while ( System . currentTimeMillis ( ) < start + ( 1000 * timeoutInSeconds ) ) 
 { 
 if ( s . get ( ) . equals ( expected ) ) 
 break ;

NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index f01f133 . . 8b94421 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 10 , 6 + 10 , 7 @ @ 
 ( CASSANDRA - 2419 ) 
 * JDBC CQL driver exposes getColumn for access to timestamp 
 * JDBC ResultSetMetadata properties added to AbstractType 
 + * r / m clustertool ( CASSANDRA - 2607 ) 
 
 
 0 . 8 . 0 - beta2 
 diff - - git a / NEWS . txt b / NEWS . txt 
 index 760ff39 . . 8a4a64e 100644 
 - - - a / NEWS . txt 
 + + + b / NEWS . txt 
 @ @ - 37 , 6 + 37 , 13 @ @ Features 
 will be removed in a future major release once we are satisfied that 
 memtable _ total _ space _ in _ mb works adequately . 
 
 + Tools 
 + - - - - - 
 + - stress and py _ stress moved from contrib / to tools / 
 + - clustertool was removed ( see 
 + https : / / issues . apache . org / jira / browse / CASSANDRA - 2607 for examples 
 + of how to script nodetool across the cluster instead ) 
 + 
 Other 
 - - - - - 
 - In the past , sstable2json would write column names and values as 
 diff - - git a / bin / clustertool b / bin / clustertool 
 deleted file mode 100755 
 index 0dbfd02 . . 0000000 
 - - - a / bin / clustertool 
 + + + / dev / null 
 @ @ - 1 , 57 + 0 , 0 @ @ 
 - # ! / bin / sh 
 - # Licensed to the Apache Software Foundation ( ASF ) under one 
 - # or more contributor license agreements . See the NOTICE file 
 - # distributed with this work for additional information 
 - # regarding copyright ownership . The ASF licenses this file 
 - # to you under the Apache License , Version 2 . 0 ( the 
 - # " License " ) ; you may not use this file except in compliance 
 - # with the License . You may obtain a copy of the License at 
 - # 
 - # http : / / www . apache . org / licenses / LICENSE - 2 . 0 
 - # 
 - # Unless required by applicable law or agreed to in writing , software 
 - # distributed under the License is distributed on an " AS IS " BASIS , 
 - # WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . 
 - # See the License for the specific language governing permissions and 
 - # limitations under the License . 
 - 
 - 
 - if [ " x $ CASSANDRA _ INCLUDE " = " x " ] ; then 
 - for include in / usr / share / cassandra / cassandra . in . sh \ 
 - / usr / local / share / cassandra / cassandra . in . sh \ 
 - / opt / cassandra / cassandra . in . sh \ 
 - ` dirname $ 0 ` / cassandra . in . sh ; do 
 - if [ - r $ include ] ; then 
 - . $ include 
 - break 
 - fi 
 - done 
 - elif [ - r $ CASSANDRA _ INCLUDE ] ; then 
 - . $ CASSANDRA _ INCLUDE 
 - fi 
 - 
 - # Use JAVA _ HOME if set , otherwise look for java in PATH 
 - if [ - x $ JAVA _ HOME / bin / java ] ; then 
 - JAVA = $ JAVA _ HOME / bin / java 
 - else 
 - JAVA = ` which java ` 
 - fi 
 - 
 - if [ - z $ CASSANDRA _ CONF - o - z $ CLASSPATH ] ; then 
 - echo " You must set the CASSANDRA _ CONF and CLASSPATH vars " > & 2 
 - exit 1 
 - fi 
 - 
 - # Special - case path variables . 
 - case " ` uname ` " in 
 - CYGWIN * ) 
 - CLASSPATH = ` cygpath - p - w " $ CLASSPATH " ` 
 - CASSANDRA _ CONF = ` cygpath - p - w " $ CASSANDRA _ CONF " ` 
 - ; ; 
 - esac 
 - 
 - $ JAVA - cp $ CLASSPATH \ 
 - - Dlog4j . configuration = log4j - tools . properties \ 
 - org . apache . cassandra . tools . ClusterCmd $ @ 
 - 
 - # vi : ai sw = 4 ts = 4 tw = 0 et 
 diff - - git a / bin / clustertool . bat b / bin / clustertool . bat 
 deleted file mode 100644 
 index c607f2f . . 0000000 
 - - - a / bin / clustertool . bat 
 + + + / dev / null 
 @ @ - 1 , 67 + 0 , 0 @ @ 
 - @ REM 
 - @ REM Licensed to the Apache Software Foundation ( ASF ) under one or more 
 - @ REM contributor license agreements . See the NOTICE file distributed with 
 - @ REM this work for additional information regarding copyright ownership . 
 - @ REM The ASF licenses this file to You under the Apache License , Version 2 . 0 
 - @ REM ( the " License " ) ; you may not use this file except in compliance with 
 - @ REM the License . You may obtain a copy of the License at 
 - @ REM 
 - @ REM http : / / www . apache . org / licenses / LICENSE - 2 . 0 
 - @ REM 
 - @ REM Unless required by applicable law or agreed to in writing , software 
 - @ REM distributed under the License is distributed on an " AS IS " BASIS , 
 - @ REM WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . 
 - @ REM See the License for the specific language governing permissions and 
 - @ REM limitations under the License . 
 - 
 - @ echo off 
 - if " % OS % " = = " Windows _ NT " setlocal 
 - 
 - if NOT DEFINED CASSANDRA _ HOME set CASSANDRA _ HOME = % ~ dp0 . . 
 - if NOT DEFINED CASSANDRA _ CONF set CASSANDRA _ CONF = % CASSANDRA _ HOME % \ conf 
 - if NOT DEFINED CASSANDRA _ MAIN set CASSANDRA _ MAIN = org . apache . cassandra . tools . ClusterCmd 
 - if NOT DEFINED JAVA _ HOME goto err 
 - 
 - REM * * * * * JAVA options * * * * * 
 - set JAVA _ OPTS = ^ 
 - - Dlog4j . configuration = log4j - tools . properties 
 - 
 - REM * * * * * CLASSPATH library setting * * * * * 
 - 
 - REM Ensure that any user defined CLASSPATH variables are not used on startup 
 - set CLASSPATH = % CASSANDRA _ HOME % \ conf 
 - 
 - REM For each jar in the CASSANDRA _ HOME lib directory call append to build the CLASSPATH variable . 
 - for % % i in ( % CASSANDRA _ HOME % \ lib \ * . jar ) do call : append % % ~ fi 
 - goto okClasspath 
 - 
 - : append 
 - set CLASSPATH = % CLASSPATH % ; % 1 % 2 
 - goto : eof 
 - 
 - : okClasspath 
 - REM Include the build \ classes \ main directory so it works in development 
 - set CASSANDRA _ CLASSPATH = % CLASSPATH % ; % CASSANDRA _ HOME % \ build \ classes \ main ; % CASSANDRA _ CONF % ; % CASSANDRA _ HOME % \ build \ classes \ thrift 
 - 
 - set CASSANDRA _ PARAMS = 
 - set TOOLS _ PARAMS = 
 - 
 - FOR % % A IN ( % * ) DO call : appendToolsParams % % A 
 - 
 - goto runTool 
 - 
 - : appendToolsParams 
 - set TOOLS _ PARAMS = % TOOLS _ PARAMS % % 1 
 - goto : eof 
 - 
 - : runTool 
 - " % JAVA _ HOME % \ bin \ java " % JAVA _ OPTS % % CASSANDRA _ PARAMS % - cp " % CASSANDRA _ CLASSPATH % " " % CASSANDRA _ MAIN % " % TOOLS _ PARAMS % 
 - goto finally 
 - 
 - : err 
 - echo JAVA _ HOME environment variable must be set ! 
 - pause 
 - 
 - : finally 
 - 
 - ENDLOCAL 
 diff - - git a / src / java / org / apache / cassandra / tools / ClusterCmd . java b / src / java / org / apache / cassandra / tools / ClusterCmd . java 
 deleted file mode 100644 
 index b4db791 . . 0000000 
 - - - a / src / java / org / apache / cassandra / tools / ClusterCmd . java 
 + + + / dev / null 
 @ @ - 1 , 272 + 0 , 0 @ @ 
 - / * * 
 - * Licensed to the Apache Software Foundation ( ASF ) under one 
 - * or more contributor license agreements . See the NOTICE file 
 - * distributed with this work for additional information 
 - * regarding copyright ownership . The ASF licenses this file 
 - * to you under the Apache License , Version 2 . 0 ( the 
 - * " License " ) ; you may not use this file except in compliance 
 - * with the License . You may obtain a copy of the License at 
 - * 
 - * http : / / www . apache . org / licenses / LICENSE - 2 . 0 
 - * 
 - * Unless required by applicable law or agreed to in writing , software 
 - * distributed under the License is distributed on an " AS IS " BASIS , 
 - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . 
 - * See the License for the specific language governing permissions and 
 - * limitations under the License . 
 - * / 
 - package org . apache . cassandra . tools ; 
 - 
 - import java . io . IOException ; 
 - import java . net . InetAddress ; 
 - import java . util . List ; 
 - 
 - import org . apache . commons . cli . * ; 
 - 
 - / * * 
 - * JMX cluster wide operations for Cassandra . 
 - * / 
 - public class ClusterCmd { 
 - private static final String HOST _ OPT _ LONG = " host " ; 
 - private static final String HOST _ OPT _ SHORT = " h " ; 
 - private static final String PORT _ OPT _ LONG = " port " ; 
 - private static final String PORT _ OPT _ SHORT = " p " ; 
 - private static final int defaultPort = 7199 ; 
 - private static Options options = null ; 
 - private CommandLine cmd = null ; 
 - private NodeProbe probe ; 
 - 
 - static 
 - { 
 - options = new Options ( ) ; 
 - Option optHost = new Option ( HOST _ OPT _ SHORT , HOST _ OPT _ LONG , true , " node hostname or ip address " ) ; 
 - optHost . setRequired ( true ) ; 
 - options . addOption ( optHost ) ; 
 - options . addOption ( PORT _ OPT _ SHORT , PORT _ OPT _ LONG , true , " remote jmx agent port number ( defaults to " + defaultPort + " ) " ) ; 
 - } 
 - 
 - / * * 
 - * Creates a ClusterProbe using command - line arguments . 
 - * 
 - * @ param cmdArgs list of arguments passed on the command line 
 - * @ throws ParseException for missing required , or unrecognized options 
 - * @ throws IOException on connection failures 
 - * / 
 - private ClusterCmd ( String [ ] cmdArgs ) throws ParseException , IOException , InterruptedException 
 - { 
 - parseArgs ( cmdArgs ) ; 
 - String host = cmd . getOptionValue ( HOST _ OPT _ SHORT ) ; 
 - 
 - String portNum = cmd . getOptionValue ( PORT _ OPT _ SHORT ) ; 
 - int port ; 
 - if ( portNum ! = null ) 
 - { 
 - try 
 - { 
 - port = Integer . parseInt ( portNum ) ; 
 - } 
 - catch ( NumberFormatException e ) 
 - { 
 - throw new ParseException ( " Port must be a number " ) ; 
 - } 
 - } 
 - else 
 - { 
 - port = defaultPort ; 
 - } 
 - 
 - probe = new NodeProbe ( host , port ) ; 
 - } 
 - 
 - / * * 
 - * Creates a ClusterProbe using the specified JMX host and port . 
 - * 
 - * @ param host hostname or IP address of the JMX agent 
 - * @ param port TCP port of the remote JMX agent 
 - * @ throws IOException on connection failures 
 - * / 
 - public ClusterCmd ( String host , int port ) throws IOException , InterruptedException 
 - { 
 - probe = new NodeProbe ( host , port ) ; 
 - } 
 - 
 - / * * 
 - * Creates a ClusterProbe using the specified JMX host and default port . 
 - * 
 - * @ param host hostname or IP address of the JMX agent 
 - * @ throws IOException on connection failures 
 - * / 
 - public ClusterCmd ( String host ) throws IOException , InterruptedException 
 - { 
 - this ( host , defaultPort ) ; 
 - } 
 - 
 - / * * 
 - * Parse the supplied command line arguments . 
 - * 
 - * @ param args arguments passed on the command line 
 - * @ throws ParseException for missing required , or unrecognized options 
 - * / 
 - private void parseArgs ( String [ ] args ) throws ParseException 
 - { 
 - CommandLineParser parser = new PosixParser ( ) ; 
 - cmd = parser . parse ( options , args ) ; 
 - } 
 - 
 - / * * 
 - * Retrieve any non - option arguments passed on the command line . 
 - * 
 - * @ return non - option command args 
 - * / 
 - private String [ ] getArgs ( ) 
 - { 
 - return cmd . getArgs ( ) ; 
 - } 
 - 
 - / * * 
 - * Prints usage information to stdout . 
 - * / 
 - private static void printUsage ( ) 
 - { 
 - HelpFormatter hf = new HelpFormatter ( ) ; 
 - String header = String . format ( 
 - " % nAvailable commands : get _ endpoints [ keyspace ] [ key ] , global _ snapshot [ name ] , clear _ global _ snapshot , " + 
 - " truncate < keyspace > < cfname > " ) ; 
 - String usage = String . format ( " java % s - host < arg > < command > % n " , ClusterCmd . class . getName ( ) ) ; 
 - hf . printHelp ( usage , " " , options , header ) ; 
 - } 
 - 
 - public void close ( ) throws IOException 
 - { 
 - probe . close ( ) ; 
 - } 
 - 
 - public void printEndpoints ( String keyspace , String key ) 
 - { 
 - List < InetAddress > endpoints = probe . getEndpoints ( keyspace , key ) ; 
 - System . out . println ( String . format ( " % - 17s : % s " , " Key " , key ) ) ; 
 - System . out . println ( String . format ( " % - 17s : % s " , " Endpoints " , endpoints ) ) ; 
 - } 
 - 
 - / * * 
 - * Take a snapshot of all tables on all ( live ) nodes in the cluster 
 - * 
 - * @ param snapshotName name of the snapshot 
 - * / 
 - public void takeGlobalSnapshot ( String snapshotName ) throws IOException , InterruptedException 
 - { 
 - 
 - for ( String liveNode : probe . getLiveNodes ( ) ) 
 - { 
 - try 
 - { 
 - NodeProbe hostProbe = new NodeProbe ( liveNode , probe . port ) ; 
 - hostProbe . takeSnapshot ( snapshotName ) ; 
 - System . out . println ( liveNode + " snapshot taken in directory : " + snapshotName ) ; 
 - } 
 - catch ( IOException e ) 
 - { 
 - System . out . println ( liveNode + " snapshot FAILED : " + e . getMessage ( ) ) ; 
 - } 
 - } 
 - } 
 - 
 - / * * 
 - * Remove all the existing snapshots from all ( live ) nodes in the cluster 
 - * / 
 - public void clearGlobalSnapshot ( String tag ) throws IOException , InterruptedException 
 - { 
 - for ( String liveNode : probe . getLiveNodes ( ) ) 
 - { 
 - try 
 - { 
 - NodeProbe hostProbe = new NodeProbe ( liveNode , probe . port ) ; 
 - hostProbe . clearSnapshot ( tag ) ; 
 - System . out . println ( liveNode + " snapshot cleared " ) ; 
 - } 
 - catch ( IOException e ) 
 - { 
 - System . out . println ( liveNode + " snapshot clear FAILED : " + e . getMessage ( ) ) ; 
 - } 
 - } 
 - } 
 - 
 - public void truncate ( String tableName , String cfName ) 
 - { 
 - probe . truncate ( tableName , cfName ) ; 
 - } 
 - 
 - / * * 
 - * @ param args 
 - * / 
 - public static void main ( String [ ] args ) throws IOException , InterruptedException 
 - { 
 - ClusterCmd clusterCmd = null ; 
 - try 
 - { 
 - clusterCmd = new ClusterCmd ( args ) ; 
 - } 
 - catch ( ParseException pe ) 
 - { 
 - System . err . println ( pe . getMessage ( ) ) ; 
 - ClusterCmd . printUsage ( ) ; 
 - System . exit ( 1 ) ; 
 - } 
 - catch ( IOException ioe ) 
 - { 
 - System . err . println ( " Error connecting to remote JMX agent ! " ) ; 
 - ioe . printStackTrace ( ) ; 
 - System . exit ( 3 ) ; 
 - } 
 - 
 - if ( clusterCmd . getArgs ( ) . length < 1 ) 
 - { 
 - System . err . println ( " Missing argument for command . " ) ; 
 - ClusterCmd . printUsage ( ) ; 
 - System . exit ( 1 ) ; 
 - } 
 - 
 - / / Execute the requested command . 
 - String [ ] arguments = clusterCmd . getArgs ( ) ; 
 - String cmdName = arguments [ 0 ] ; 
 - if ( cmdName . equals ( " get _ endpoints " ) ) 
 - { 
 - if ( arguments . length < = 2 ) 
 - { 
 - System . err . println ( " missing keyspace and / or key argument " ) ; 
 - ClusterCmd . printUsage ( ) ; 
 - System . exit ( 1 ) ; 
 - } 
 - clusterCmd . printEndpoints ( arguments [ 1 ] , arguments [ 2 ] ) ; 
 - } 
 - else if ( cmdName . equals ( " global _ snapshot " ) ) 
 - { 
 - String snapshotName = arguments . length > 1 ? arguments [ 1 ] : new Long ( System . currentTimeMillis ( ) ) . toString ( ) ; 
 - clusterCmd . takeGlobalSnapshot ( snapshotName ) ; 
 - } 
 - else if ( cmdName . equals ( " clear _ global _ snapshot " ) ) 
 - { 
 - String snapshotName = arguments . length > 1 ? arguments [ 1 ] : " " ; 
 - clusterCmd . clearGlobalSnapshot ( snapshotName ) ; 
 - } 
 - else if ( cmdName . equals ( " truncate " ) ) 
 - { 
 - if ( arguments . length ! = 3 ) 
 - { 
 - System . err . println ( " truncate requires < keyspace > and < columnfamily > arguments " ) ; 
 - } 
 - String tableName = arguments [ 1 ] ; 
 - String cfName = arguments [ 2 ] ; 
 - clusterCmd . truncate ( tableName , cfName ) ; 
 - } 
 - else 
 - { 
 - System . err . println ( " Unrecognized command : " + cmdName + " . " ) ; 
 - ClusterCmd . printUsage ( ) ; 
 - System . exit ( 1 ) ; 
 - } 
 - 
 - System . exit ( 0 ) ; 
 - } 
 - 
 - }
