BLEU SCORE: 0.024455939372403628

TEST MSG: Followup to 6916 , don ' t try to snapshot readers that are opened early .
GENERATED MSG: merge from 1 . 2

TEST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> index 417a5b4 . . 3786ef5 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> @ @ - 2144 , 7 + 2144 , 7 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean <nl> { <nl> for ( SSTableReader ssTable : currentView . sstables ) <nl> { <nl> - if ( predicate ! = null & & ! predicate . apply ( ssTable ) ) <nl> + if ( ssTable . isOpenEarly | | ( predicate ! = null & & ! predicate . apply ( ssTable ) ) ) <nl> { <nl> continue ; <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / io / sstable / SSTableReader . java b / src / java / org / apache / cassandra / io / sstable / SSTableReader . java <nl> index 98fe5b6 . . 53f7e53 100644 <nl> - - - a / src / java / org / apache / cassandra / io / sstable / SSTableReader . java <nl> + + + b / src / java / org / apache / cassandra / io / sstable / SSTableReader . java <nl> @ @ - 159 , 6 + 159 , 7 @ @ public class SSTableReader extends SSTable <nl> * The age is in milliseconds since epoc and is local to this host . <nl> * / <nl> public final long maxDataAge ; <nl> + public final boolean isOpenEarly ; <nl> <nl> / / indexfile and datafile : might be null before a call to load ( ) <nl> private SegmentedFile ifile ; <nl> @ @ - 336 , 7 + 337 , 8 @ @ public class SSTableReader extends SSTable <nl> metadata , <nl> partitioner , <nl> System . currentTimeMillis ( ) , <nl> - statsMetadata ) ; <nl> + statsMetadata , <nl> + false ) ; <nl> <nl> / / special implementation of load to use non - pooled SegmentedFile builders <nl> SegmentedFile . Builder ibuilder = new BufferedSegmentedFile . Builder ( ) ; <nl> @ @ - 384 , 7 + 386 , 8 @ @ public class SSTableReader extends SSTable <nl> metadata , <nl> partitioner , <nl> System . currentTimeMillis ( ) , <nl> - statsMetadata ) ; <nl> + statsMetadata , <nl> + false ) ; <nl> <nl> / / load index and filter <nl> long start = System . nanoTime ( ) ; <nl> @ @ - 463 , 7 + 466 , 8 @ @ public class SSTableReader extends SSTable <nl> IndexSummary isummary , <nl> IFilter bf , <nl> long maxDataAge , <nl> - StatsMetadata sstableMetadata ) <nl> + StatsMetadata sstableMetadata , <nl> + boolean isOpenEarly ) <nl> { <nl> assert desc ! = null & & partitioner ! = null & & ifile ! = null & & dfile ! = null & & isummary ! = null & & bf ! = null & & sstableMetadata ! = null ; <nl> return new SSTableReader ( desc , <nl> @ @ - 474 , 7 + 478 , 8 @ @ public class SSTableReader extends SSTable <nl> isummary , <nl> bf , <nl> maxDataAge , <nl> - sstableMetadata ) ; <nl> + sstableMetadata , <nl> + isOpenEarly ) ; <nl> } <nl> <nl> <nl> @ @ - 483 , 11 + 488 , 13 @ @ public class SSTableReader extends SSTable <nl> CFMetaData metadata , <nl> IPartitioner partitioner , <nl> long maxDataAge , <nl> - StatsMetadata sstableMetadata ) <nl> + StatsMetadata sstableMetadata , <nl> + boolean isOpenEarly ) <nl> { <nl> super ( desc , components , metadata , partitioner ) ; <nl> this . sstableMetadata = sstableMetadata ; <nl> this . maxDataAge = maxDataAge ; <nl> + this . isOpenEarly = isOpenEarly ; <nl> <nl> deletingTask = new SSTableDeletingTask ( this ) ; <nl> <nl> @ @ - 524 , 9 + 531 , 10 @ @ public class SSTableReader extends SSTable <nl> IndexSummary indexSummary , <nl> IFilter bloomFilter , <nl> long maxDataAge , <nl> - StatsMetadata sstableMetadata ) <nl> + StatsMetadata sstableMetadata , <nl> + boolean isOpenEarly ) <nl> { <nl> - this ( desc , components , metadata , partitioner , maxDataAge , sstableMetadata ) ; <nl> + this ( desc , components , metadata , partitioner , maxDataAge , sstableMetadata , isOpenEarly ) ; <nl> <nl> this . ifile = ifile ; <nl> this . dfile = dfile ; <nl> @ @ - 947 , 7 + 955 , 7 @ @ public class SSTableReader extends SSTable <nl> <nl> if ( readMeterSyncFuture ! = null ) <nl> readMeterSyncFuture . cancel ( false ) ; <nl> - SSTableReader replacement = new SSTableReader ( descriptor , components , metadata , partitioner , ifile , dfile , indexSummary . readOnlyClone ( ) , bf , maxDataAge , sstableMetadata ) ; <nl> + SSTableReader replacement = new SSTableReader ( descriptor , components , metadata , partitioner , ifile , dfile , indexSummary . readOnlyClone ( ) , bf , maxDataAge , sstableMetadata , isOpenEarly ) ; <nl> replacement . readMeter = this . readMeter ; <nl> replacement . first = this . last . compareTo ( newStart ) > 0 ? newStart : this . last ; <nl> replacement . last = this . last ; <nl> @ @ - 1010 , 7 + 1018 , 7 @ @ public class SSTableReader extends SSTable <nl> if ( readMeterSyncFuture ! = null ) <nl> readMeterSyncFuture . cancel ( false ) ; <nl> <nl> - SSTableReader replacement = new SSTableReader ( descriptor , components , metadata , partitioner , ifile , dfile , newSummary , bf , maxDataAge , sstableMetadata ) ; <nl> + SSTableReader replacement = new SSTableReader ( descriptor , components , metadata , partitioner , ifile , dfile , newSummary , bf , maxDataAge , sstableMetadata , isOpenEarly ) ; <nl> replacement . readMeter = this . readMeter ; <nl> replacement . first = this . first ; <nl> replacement . last = this . last ; <nl> diff - - git a / src / java / org / apache / cassandra / io / sstable / SSTableWriter . java b / src / java / org / apache / cassandra / io / sstable / SSTableWriter . java <nl> index 9e667f6 . . f32bb96 100644 <nl> - - - a / src / java / org / apache / cassandra / io / sstable / SSTableWriter . java <nl> + + + b / src / java / org / apache / cassandra / io / sstable / SSTableWriter . java <nl> @ @ - 390 , 7 + 390 , 7 @ @ public class SSTableWriter extends SSTable <nl> components , metadata , <nl> partitioner , ifile , <nl> dfile , iwriter . summary . build ( partitioner , exclusiveUpperBoundOfReadableIndex ) , <nl> - iwriter . bf , maxDataAge , sstableMetadata ) ; <nl> + iwriter . bf , maxDataAge , sstableMetadata , true ) ; <nl> <nl> / / now it ' s open , find the ACTUAL last readable key ( i . e . for which the data file has also been flushed ) <nl> sstable . first = getMinimalKey ( first ) ; <nl> @ @ - 440 , 7 + 440 , 8 @ @ public class SSTableWriter extends SSTable <nl> iwriter . summary . build ( partitioner ) , <nl> iwriter . bf , <nl> maxDataAge , <nl> - sstableMetadata ) ; <nl> + sstableMetadata , <nl> + false ) ; <nl> sstable . first = getMinimalKey ( first ) ; <nl> sstable . last = getMinimalKey ( last ) ; <nl> / / try to save the summaries to disk
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index b935425 . . 7f5a487 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 1 . 2 - rc1 <nl> + * fix cqlsh rendering of blob fields ( CASSANDRA - 4970 ) <nl> * fix cqlsh DESCRIBE command ( CASSANDRA - 4913 ) <nl> * save truncation position in system table ( CASSANDRA - 4906 ) <nl> * Move CompressionMetadata off - heap ( CASSANDRA - 4937 ) <nl> diff - - git a / pylib / cqlshlib / formatting . py b / pylib / cqlshlib / formatting . py <nl> index d15c083 . . bab3506 100644 <nl> - - - a / pylib / cqlshlib / formatting . py <nl> + + + b / pylib / cqlshlib / formatting . py <nl> @ @ - 88 , 8 + 88 , 8 @ @ def formatter _ for ( typname ) : <nl> return f <nl> return registrator <nl> <nl> - @ formatter _ for ( ' bytes ' ) <nl> - def format _ value _ bytes ( val , colormap , * * _ ) : <nl> + @ formatter _ for ( ' blob ' ) <nl> + def format _ value _ blob ( val , colormap , * * _ ) : <nl> bval = ' ' . join ( ' % 02x ' % ord ( c ) for c in val ) <nl> return colorme ( bval , colormap , ' hex ' ) <nl>

TEST DIFF:
diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 index 417a5b4 . . 3786ef5 100644 
 - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 @ @ - 2144 , 7 + 2144 , 7 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean 
 { 
 for ( SSTableReader ssTable : currentView . sstables ) 
 { 
 - if ( predicate ! = null & & ! predicate . apply ( ssTable ) ) 
 + if ( ssTable . isOpenEarly | | ( predicate ! = null & & ! predicate . apply ( ssTable ) ) ) 
 { 
 continue ; 
 } 
 diff - - git a / src / java / org / apache / cassandra / io / sstable / SSTableReader . java b / src / java / org / apache / cassandra / io / sstable / SSTableReader . java 
 index 98fe5b6 . . 53f7e53 100644 
 - - - a / src / java / org / apache / cassandra / io / sstable / SSTableReader . java 
 + + + b / src / java / org / apache / cassandra / io / sstable / SSTableReader . java 
 @ @ - 159 , 6 + 159 , 7 @ @ public class SSTableReader extends SSTable 
 * The age is in milliseconds since epoc and is local to this host . 
 * / 
 public final long maxDataAge ; 
 + public final boolean isOpenEarly ; 
 
 / / indexfile and datafile : might be null before a call to load ( ) 
 private SegmentedFile ifile ; 
 @ @ - 336 , 7 + 337 , 8 @ @ public class SSTableReader extends SSTable 
 metadata , 
 partitioner , 
 System . currentTimeMillis ( ) , 
 - statsMetadata ) ; 
 + statsMetadata , 
 + false ) ; 
 
 / / special implementation of load to use non - pooled SegmentedFile builders 
 SegmentedFile . Builder ibuilder = new BufferedSegmentedFile . Builder ( ) ; 
 @ @ - 384 , 7 + 386 , 8 @ @ public class SSTableReader extends SSTable 
 metadata , 
 partitioner , 
 System . currentTimeMillis ( ) , 
 - statsMetadata ) ; 
 + statsMetadata , 
 + false ) ; 
 
 / / load index and filter 
 long start = System . nanoTime ( ) ; 
 @ @ - 463 , 7 + 466 , 8 @ @ public class SSTableReader extends SSTable 
 IndexSummary isummary , 
 IFilter bf , 
 long maxDataAge , 
 - StatsMetadata sstableMetadata ) 
 + StatsMetadata sstableMetadata , 
 + boolean isOpenEarly ) 
 { 
 assert desc ! = null & & partitioner ! = null & & ifile ! = null & & dfile ! = null & & isummary ! = null & & bf ! = null & & sstableMetadata ! = null ; 
 return new SSTableReader ( desc , 
 @ @ - 474 , 7 + 478 , 8 @ @ public class SSTableReader extends SSTable 
 isummary , 
 bf , 
 maxDataAge , 
 - sstableMetadata ) ; 
 + sstableMetadata , 
 + isOpenEarly ) ; 
 } 
 
 
 @ @ - 483 , 11 + 488 , 13 @ @ public class SSTableReader extends SSTable 
 CFMetaData metadata , 
 IPartitioner partitioner , 
 long maxDataAge , 
 - StatsMetadata sstableMetadata ) 
 + StatsMetadata sstableMetadata , 
 + boolean isOpenEarly ) 
 { 
 super ( desc , components , metadata , partitioner ) ; 
 this . sstableMetadata = sstableMetadata ; 
 this . maxDataAge = maxDataAge ; 
 + this . isOpenEarly = isOpenEarly ; 
 
 deletingTask = new SSTableDeletingTask ( this ) ; 
 
 @ @ - 524 , 9 + 531 , 10 @ @ public class SSTableReader extends SSTable 
 IndexSummary indexSummary , 
 IFilter bloomFilter , 
 long maxDataAge , 
 - StatsMetadata sstableMetadata ) 
 + StatsMetadata sstableMetadata , 
 + boolean isOpenEarly ) 
 { 
 - this ( desc , components , metadata , partitioner , maxDataAge , sstableMetadata ) ; 
 + this ( desc , components , metadata , partitioner , maxDataAge , sstableMetadata , isOpenEarly ) ; 
 
 this . ifile = ifile ; 
 this . dfile = dfile ; 
 @ @ - 947 , 7 + 955 , 7 @ @ public class SSTableReader extends SSTable 
 
 if ( readMeterSyncFuture ! = null ) 
 readMeterSyncFuture . cancel ( false ) ; 
 - SSTableReader replacement = new SSTableReader ( descriptor , components , metadata , partitioner , ifile , dfile , indexSummary . readOnlyClone ( ) , bf , maxDataAge , sstableMetadata ) ; 
 + SSTableReader replacement = new SSTableReader ( descriptor , components , metadata , partitioner , ifile , dfile , indexSummary . readOnlyClone ( ) , bf , maxDataAge , sstableMetadata , isOpenEarly ) ; 
 replacement . readMeter = this . readMeter ; 
 replacement . first = this . last . compareTo ( newStart ) > 0 ? newStart : this . last ; 
 replacement . last = this . last ; 
 @ @ - 1010 , 7 + 1018 , 7 @ @ public class SSTableReader extends SSTable 
 if ( readMeterSyncFuture ! = null ) 
 readMeterSyncFuture . cancel ( false ) ; 
 
 - SSTableReader replacement = new SSTableReader ( descriptor , components , metadata , partitioner , ifile , dfile , newSummary , bf , maxDataAge , sstableMetadata ) ; 
 + SSTableReader replacement = new SSTableReader ( descriptor , components , metadata , partitioner , ifile , dfile , newSummary , bf , maxDataAge , sstableMetadata , isOpenEarly ) ; 
 replacement . readMeter = this . readMeter ; 
 replacement . first = this . first ; 
 replacement . last = this . last ; 
 diff - - git a / src / java / org / apache / cassandra / io / sstable / SSTableWriter . java b / src / java / org / apache / cassandra / io / sstable / SSTableWriter . java 
 index 9e667f6 . . f32bb96 100644 
 - - - a / src / java / org / apache / cassandra / io / sstable / SSTableWriter . java 
 + + + b / src / java / org / apache / cassandra / io / sstable / SSTableWriter . java 
 @ @ - 390 , 7 + 390 , 7 @ @ public class SSTableWriter extends SSTable 
 components , metadata , 
 partitioner , ifile , 
 dfile , iwriter . summary . build ( partitioner , exclusiveUpperBoundOfReadableIndex ) , 
 - iwriter . bf , maxDataAge , sstableMetadata ) ; 
 + iwriter . bf , maxDataAge , sstableMetadata , true ) ; 
 
 / / now it ' s open , find the ACTUAL last readable key ( i . e . for which the data file has also been flushed ) 
 sstable . first = getMinimalKey ( first ) ; 
 @ @ - 440 , 7 + 440 , 8 @ @ public class SSTableWriter extends SSTable 
 iwriter . summary . build ( partitioner ) , 
 iwriter . bf , 
 maxDataAge , 
 - sstableMetadata ) ; 
 + sstableMetadata , 
 + false ) ; 
 sstable . first = getMinimalKey ( first ) ; 
 sstable . last = getMinimalKey ( last ) ; 
 / / try to save the summaries to disk

NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index b935425 . . 7f5a487 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 1 . 2 - rc1 
 + * fix cqlsh rendering of blob fields ( CASSANDRA - 4970 ) 
 * fix cqlsh DESCRIBE command ( CASSANDRA - 4913 ) 
 * save truncation position in system table ( CASSANDRA - 4906 ) 
 * Move CompressionMetadata off - heap ( CASSANDRA - 4937 ) 
 diff - - git a / pylib / cqlshlib / formatting . py b / pylib / cqlshlib / formatting . py 
 index d15c083 . . bab3506 100644 
 - - - a / pylib / cqlshlib / formatting . py 
 + + + b / pylib / cqlshlib / formatting . py 
 @ @ - 88 , 8 + 88 , 8 @ @ def formatter _ for ( typname ) : 
 return f 
 return registrator 
 
 - @ formatter _ for ( ' bytes ' ) 
 - def format _ value _ bytes ( val , colormap , * * _ ) : 
 + @ formatter _ for ( ' blob ' ) 
 + def format _ value _ blob ( val , colormap , * * _ ) : 
 bval = ' ' . join ( ' % 02x ' % ord ( c ) for c in val ) 
 return colorme ( bval , colormap , ' hex ' ) 

