BLEU SCORE: 0.03416211359799979

TEST MSG: Compact hints after partial replay to clean out tombstones
GENERATED MSG: don ' t try to run tests that are no longer there

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 5511e01 . . 82783f8 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 2 , 6 + 2 , 7 @ @ <nl> * Fix upgradesstables NPE for non - CF - based indexes ( CASSANDRA - 6645 ) <nl> * Fix partition and range deletes not triggering flush ( CASSANDRA - 6655 ) <nl> * Fix mean cells and mean row size per sstable calculations ( CASSANDRA - 6667 ) <nl> + * Compact hints after partial replay to clean out tombstones ( CASSANDRA - 6666 ) <nl> <nl> <nl> 1 . 2 . 15 <nl> diff - - git a / src / java / org / apache / cassandra / db / HintedHandOffManager . java b / src / java / org / apache / cassandra / db / HintedHandOffManager . java <nl> index ede49e4 . . b1ccbc3 100644 <nl> - - - a / src / java / org / apache / cassandra / db / HintedHandOffManager . java <nl> + + + b / src / java / org / apache / cassandra / db / HintedHandOffManager . java <nl> @ @ - 309 , 6 + 309 , 7 @ @ public class HintedHandOffManager implements HintedHandOffManagerMBean <nl> / ( StorageService . instance . getTokenMetadata ( ) . getAllEndpoints ( ) . size ( ) - 1 ) ; <nl> RateLimiter rateLimiter = RateLimiter . create ( throttleInKB = = 0 ? Double . MAX _ VALUE : throttleInKB * 1024 ) ; <nl> <nl> + boolean finished = false ; <nl> delivery : <nl> while ( true ) <nl> { <nl> @ @ - 323 , 13 + 324 , 17 @ @ public class HintedHandOffManager implements HintedHandOffManagerMBean <nl> ( int ) ( System . currentTimeMillis ( ) / 1000 ) ) ; <nl> <nl> if ( pagingFinished ( hintsPage , startColumn ) ) <nl> + { <nl> + logger . info ( " Finished hinted handoff of { } rows to endpoint { } " , rowsReplayed , endpoint ) ; <nl> + finished = true ; <nl> break ; <nl> + } <nl> <nl> / / check if node is still alive and we should continue delivery process <nl> if ( ! FailureDetector . instance . isAlive ( endpoint ) ) <nl> { <nl> logger . info ( " Endpoint { } died during hint delivery ; aborting ( { } delivered ) " , endpoint , rowsReplayed ) ; <nl> - return ; <nl> + break ; <nl> } <nl> <nl> List < WriteResponseHandler > responseHandlers = Lists . newArrayList ( ) ; <nl> @ @ - 420 , 20 + 425 , 21 @ @ public class HintedHandOffManager implements HintedHandOffManagerMBean <nl> catch ( WriteTimeoutException e ) <nl> { <nl> logger . info ( " Timed out replaying hints to { } ; aborting ( { } delivered ) " , endpoint , rowsReplayed ) ; <nl> - return ; <nl> + break delivery ; <nl> } <nl> } <nl> } <nl> <nl> - logger . info ( " Finished hinted handoff of { } rows to endpoint { } " , rowsReplayed , endpoint ) ; <nl> - <nl> - try <nl> + if ( finished | | rowsReplayed . get ( ) > = DatabaseDescriptor . getTombstoneDebugThreshold ( ) ) <nl> { <nl> - compact ( ) . get ( ) ; <nl> - } <nl> - catch ( Exception e ) <nl> - { <nl> - throw new RuntimeException ( e ) ; <nl> + try <nl> + { <nl> + compact ( ) . get ( ) ; <nl> + } <nl> + catch ( Exception e ) <nl> + { <nl> + throw new RuntimeException ( e ) ; <nl> + } <nl> } <nl> } <nl>
NEAREST DIFF (one line): diff - - git a / build . xml b / build . xml <nl> index d3fce2b . . aaef5e3 100644 <nl> - - - a / build . xml <nl> + + + b / build . xml <nl> @ @ - 785 , 7 + 785 , 7 @ @ url = $ { svn . entry . url } ? pathrev = $ { svn . entry . commit . revision } <nl> < / target > <nl> <nl> < ! - - creates release tarballs - - > <nl> - < target name = " artifacts " depends = " jar , javadoc , py - cql - driver , tx - cql - driver " <nl> + < target name = " artifacts " depends = " jar , javadoc , tx - cql - driver " <nl> description = " Create Cassandra release artifacts " > <nl> < mkdir dir = " $ { dist . dir } " / > <nl> < copy todir = " $ { dist . dir } / lib " > <nl> @ @ - 1214 , 17 + 1214 , 6 @ @ url = $ { svn . entry . url } ? pathrev = $ { svn . entry . commit . revision } <nl> 	 < delete dir = " build / eclipse - classes " / > <nl> < / target > <nl> <nl> - < target name = " py - cql - driver " <nl> - description = " Generate Python CQL driver artifact " > <nl> - < echo > Creating Python CQL driver artifact . . . < / echo > <nl> - < exec executable = " python " dir = " $ { basedir } / drivers / py " failonerror = " true " > <nl> - < arg line = " setup . py " / > <nl> - < arg line = " sdist " / > <nl> - < arg line = " - - dist - dir " / > <nl> - < arg line = " $ { build . dir } " / > <nl> - < / exec > <nl> - < / target > <nl> - <nl> < target name = " tx - cql - driver " <nl> description = " Generate Twisted CQL driver artifact " > <nl> < echo > Creating Twisted CQL driver artifact . . . < / echo >

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 5511e01 . . 82783f8 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 2 , 6 + 2 , 7 @ @ 
 * Fix upgradesstables NPE for non - CF - based indexes ( CASSANDRA - 6645 ) 
 * Fix partition and range deletes not triggering flush ( CASSANDRA - 6655 ) 
 * Fix mean cells and mean row size per sstable calculations ( CASSANDRA - 6667 ) 
 + * Compact hints after partial replay to clean out tombstones ( CASSANDRA - 6666 ) 
 
 
 1 . 2 . 15 
 diff - - git a / src / java / org / apache / cassandra / db / HintedHandOffManager . java b / src / java / org / apache / cassandra / db / HintedHandOffManager . java 
 index ede49e4 . . b1ccbc3 100644 
 - - - a / src / java / org / apache / cassandra / db / HintedHandOffManager . java 
 + + + b / src / java / org / apache / cassandra / db / HintedHandOffManager . java 
 @ @ - 309 , 6 + 309 , 7 @ @ public class HintedHandOffManager implements HintedHandOffManagerMBean 
 / ( StorageService . instance . getTokenMetadata ( ) . getAllEndpoints ( ) . size ( ) - 1 ) ; 
 RateLimiter rateLimiter = RateLimiter . create ( throttleInKB = = 0 ? Double . MAX _ VALUE : throttleInKB * 1024 ) ; 
 
 + boolean finished = false ; 
 delivery : 
 while ( true ) 
 { 
 @ @ - 323 , 13 + 324 , 17 @ @ public class HintedHandOffManager implements HintedHandOffManagerMBean 
 ( int ) ( System . currentTimeMillis ( ) / 1000 ) ) ; 
 
 if ( pagingFinished ( hintsPage , startColumn ) ) 
 + { 
 + logger . info ( " Finished hinted handoff of { } rows to endpoint { } " , rowsReplayed , endpoint ) ; 
 + finished = true ; 
 break ; 
 + } 
 
 / / check if node is still alive and we should continue delivery process 
 if ( ! FailureDetector . instance . isAlive ( endpoint ) ) 
 { 
 logger . info ( " Endpoint { } died during hint delivery ; aborting ( { } delivered ) " , endpoint , rowsReplayed ) ; 
 - return ; 
 + break ; 
 } 
 
 List < WriteResponseHandler > responseHandlers = Lists . newArrayList ( ) ; 
 @ @ - 420 , 20 + 425 , 21 @ @ public class HintedHandOffManager implements HintedHandOffManagerMBean 
 catch ( WriteTimeoutException e ) 
 { 
 logger . info ( " Timed out replaying hints to { } ; aborting ( { } delivered ) " , endpoint , rowsReplayed ) ; 
 - return ; 
 + break delivery ; 
 } 
 } 
 } 
 
 - logger . info ( " Finished hinted handoff of { } rows to endpoint { } " , rowsReplayed , endpoint ) ; 
 - 
 - try 
 + if ( finished | | rowsReplayed . get ( ) > = DatabaseDescriptor . getTombstoneDebugThreshold ( ) ) 
 { 
 - compact ( ) . get ( ) ; 
 - } 
 - catch ( Exception e ) 
 - { 
 - throw new RuntimeException ( e ) ; 
 + try 
 + { 
 + compact ( ) . get ( ) ; 
 + } 
 + catch ( Exception e ) 
 + { 
 + throw new RuntimeException ( e ) ; 
 + } 
 } 
 } 


NEAREST DIFF:
diff - - git a / build . xml b / build . xml 
 index d3fce2b . . aaef5e3 100644 
 - - - a / build . xml 
 + + + b / build . xml 
 @ @ - 785 , 7 + 785 , 7 @ @ url = $ { svn . entry . url } ? pathrev = $ { svn . entry . commit . revision } 
 < / target > 
 
 < ! - - creates release tarballs - - > 
 - < target name = " artifacts " depends = " jar , javadoc , py - cql - driver , tx - cql - driver " 
 + < target name = " artifacts " depends = " jar , javadoc , tx - cql - driver " 
 description = " Create Cassandra release artifacts " > 
 < mkdir dir = " $ { dist . dir } " / > 
 < copy todir = " $ { dist . dir } / lib " > 
 @ @ - 1214 , 17 + 1214 , 6 @ @ url = $ { svn . entry . url } ? pathrev = $ { svn . entry . commit . revision } 
 	 < delete dir = " build / eclipse - classes " / > 
 < / target > 
 
 - < target name = " py - cql - driver " 
 - description = " Generate Python CQL driver artifact " > 
 - < echo > Creating Python CQL driver artifact . . . < / echo > 
 - < exec executable = " python " dir = " $ { basedir } / drivers / py " failonerror = " true " > 
 - < arg line = " setup . py " / > 
 - < arg line = " sdist " / > 
 - < arg line = " - - dist - dir " / > 
 - < arg line = " $ { build . dir } " / > 
 - < / exec > 
 - < / target > 
 - 
 < target name = " tx - cql - driver " 
 description = " Generate Twisted CQL driver artifact " > 
 < echo > Creating Twisted CQL driver artifact . . . < / echo >
