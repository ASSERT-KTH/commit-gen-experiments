BLEU SCORE: 0.08745825313180632

TEST MSG: merge from 1 . 2
GENERATED MSG: Backport leveled integrity check from trunk

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 182bada . . a54231e 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 11 , 7 + 11 , 8 @ @ <nl> * cqlsh : handle symlinks properly ( CASSANDRA - 6425 ) <nl> * Don ' t resubmit counter mutation runnables internally ( CASSANDRA - 6427 ) <nl> Merged from 1 . 2 : <nl> - * Fix thundering herd on endpoint cache invalidation ( CASSANDRA - 6345 ) <nl> + * Randomize batchlog candidates selection ( CASSANDRA - 6481 ) <nl> + * Fix thundering herd on endpoint cache invalidation ( CASSANDRA - 6345 , 6485 ) <nl> * cqlsh : quote single quotes in strings inside collections ( CASSANDRA - 6172 ) <nl> * Improve gossip performance for typical messages ( CASSANDRA - 6409 ) <nl> * Throw IRE if a prepared statement has more markers than supported <nl> diff - - git a / src / java / org / apache / cassandra / locator / AbstractReplicationStrategy . java b / src / java / org / apache / cassandra / locator / AbstractReplicationStrategy . java <nl> index 69c133b . . 742e0b6 100644 <nl> - - - a / src / java / org / apache / cassandra / locator / AbstractReplicationStrategy . java <nl> + + + b / src / java / org / apache / cassandra / locator / AbstractReplicationStrategy . java <nl> @ @ - 116 , 19 + 116 , 20 @ @ public abstract class AbstractReplicationStrategy <nl> ArrayList < InetAddress > endpoints = getCachedEndpoints ( keyToken ) ; <nl> if ( endpoints = = null ) <nl> { <nl> - if ( tokenMetadataClone = = null ) <nl> + TokenMetadata tm ; / / local reference in case another thread nulls tMC out from under us <nl> + if ( ( tm = tokenMetadataClone ) = = null ) <nl> { <nl> / / synchronize to prevent thundering herd post - invalidation <nl> synchronized ( this ) <nl> { <nl> - if ( tokenMetadataClone = = null ) <nl> - tokenMetadataClone = tokenMetadata . cloneOnlyTokenMap ( ) ; <nl> + if ( ( tm = tokenMetadataClone ) = = null ) <nl> + tm = tokenMetadataClone = tokenMetadata . cloneOnlyTokenMap ( ) ; <nl> } <nl> / / if our clone got invalidated , it ' s possible there is a new token to account for too <nl> - keyToken = TokenMetadata . firstToken ( tokenMetadataClone . sortedTokens ( ) , searchToken ) ; <nl> + keyToken = TokenMetadata . firstToken ( tm . sortedTokens ( ) , searchToken ) ; <nl> } <nl> <nl> - endpoints = new ArrayList < InetAddress > ( calculateNaturalEndpoints ( searchToken , tokenMetadataClone ) ) ; <nl> + endpoints = new ArrayList < InetAddress > ( calculateNaturalEndpoints ( searchToken , tm ) ) ; <nl> cachedEndpoints . put ( keyToken , endpoints ) ; <nl> } <nl>
NEAREST DIFF (one line): diff - - git a / doc / cql3 / CQL . textile b / doc / cql3 / CQL . textile <nl> index fdc158a . . 2255e0b 100644 <nl> - - - a / doc / cql3 / CQL . textile <nl> + + + b / doc / cql3 / CQL . textile <nl> @ @ - 52 , 7 + 52 , 7 @ @ h3 ( # constants ) . Constants <nl> CQL defines 3 kinds of _ implicitly - typed constants _ : strings , numbers and uuids : <nl> * A string constant is an arbitrary sequence of characters characters enclosed by single - quote ( @ ' @ ) . One can include a single - quote in a string by repeating it , e . g . @ ' It ' ' s raining today ' @ . Those are not to be confused with quoted identifiers that use double - quotes . <nl> * Numeric constants are either integer constant defined by @ - ? [ 0 - 9 ] + @ or a float constant defined by @ - ? [ 0 - 9 ] + . [ 0 - 9 ] * @ . <nl> - * A " UUID " : http : / / en . wikipedia . org / wiki / Universally _ unique _ identifier constant is defined by @ hex { 8 } - hex { 4 } - hex { 4 } - hex { 12 } @ where @ hex @ is an hexadecimal character , e . g . @ [ 0 - 9a - fA - F ] @ and @ { 4 } @ is the number of such characters . <nl> + * A " UUID " : http : / / en . wikipedia . org / wiki / Universally _ unique _ identifier constant is defined by @ hex { 8 } - hex { 4 } - hex { 4 } - hex { 4 } - hex { 12 } @ where @ hex @ is an hexadecimal character , e . g . @ [ 0 - 9a - fA - F ] @ and @ { 4 } @ is the number of such characters . <nl> <nl> <nl> h3 . Comments

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 182bada . . a54231e 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 11 , 7 + 11 , 8 @ @ 
 * cqlsh : handle symlinks properly ( CASSANDRA - 6425 ) 
 * Don ' t resubmit counter mutation runnables internally ( CASSANDRA - 6427 ) 
 Merged from 1 . 2 : 
 - * Fix thundering herd on endpoint cache invalidation ( CASSANDRA - 6345 ) 
 + * Randomize batchlog candidates selection ( CASSANDRA - 6481 ) 
 + * Fix thundering herd on endpoint cache invalidation ( CASSANDRA - 6345 , 6485 ) 
 * cqlsh : quote single quotes in strings inside collections ( CASSANDRA - 6172 ) 
 * Improve gossip performance for typical messages ( CASSANDRA - 6409 ) 
 * Throw IRE if a prepared statement has more markers than supported 
 diff - - git a / src / java / org / apache / cassandra / locator / AbstractReplicationStrategy . java b / src / java / org / apache / cassandra / locator / AbstractReplicationStrategy . java 
 index 69c133b . . 742e0b6 100644 
 - - - a / src / java / org / apache / cassandra / locator / AbstractReplicationStrategy . java 
 + + + b / src / java / org / apache / cassandra / locator / AbstractReplicationStrategy . java 
 @ @ - 116 , 19 + 116 , 20 @ @ public abstract class AbstractReplicationStrategy 
 ArrayList < InetAddress > endpoints = getCachedEndpoints ( keyToken ) ; 
 if ( endpoints = = null ) 
 { 
 - if ( tokenMetadataClone = = null ) 
 + TokenMetadata tm ; / / local reference in case another thread nulls tMC out from under us 
 + if ( ( tm = tokenMetadataClone ) = = null ) 
 { 
 / / synchronize to prevent thundering herd post - invalidation 
 synchronized ( this ) 
 { 
 - if ( tokenMetadataClone = = null ) 
 - tokenMetadataClone = tokenMetadata . cloneOnlyTokenMap ( ) ; 
 + if ( ( tm = tokenMetadataClone ) = = null ) 
 + tm = tokenMetadataClone = tokenMetadata . cloneOnlyTokenMap ( ) ; 
 } 
 / / if our clone got invalidated , it ' s possible there is a new token to account for too 
 - keyToken = TokenMetadata . firstToken ( tokenMetadataClone . sortedTokens ( ) , searchToken ) ; 
 + keyToken = TokenMetadata . firstToken ( tm . sortedTokens ( ) , searchToken ) ; 
 } 
 
 - endpoints = new ArrayList < InetAddress > ( calculateNaturalEndpoints ( searchToken , tokenMetadataClone ) ) ; 
 + endpoints = new ArrayList < InetAddress > ( calculateNaturalEndpoints ( searchToken , tm ) ) ; 
 cachedEndpoints . put ( keyToken , endpoints ) ; 
 } 


NEAREST DIFF:
diff - - git a / doc / cql3 / CQL . textile b / doc / cql3 / CQL . textile 
 index fdc158a . . 2255e0b 100644 
 - - - a / doc / cql3 / CQL . textile 
 + + + b / doc / cql3 / CQL . textile 
 @ @ - 52 , 7 + 52 , 7 @ @ h3 ( # constants ) . Constants 
 CQL defines 3 kinds of _ implicitly - typed constants _ : strings , numbers and uuids : 
 * A string constant is an arbitrary sequence of characters characters enclosed by single - quote ( @ ' @ ) . One can include a single - quote in a string by repeating it , e . g . @ ' It ' ' s raining today ' @ . Those are not to be confused with quoted identifiers that use double - quotes . 
 * Numeric constants are either integer constant defined by @ - ? [ 0 - 9 ] + @ or a float constant defined by @ - ? [ 0 - 9 ] + . [ 0 - 9 ] * @ . 
 - * A " UUID " : http : / / en . wikipedia . org / wiki / Universally _ unique _ identifier constant is defined by @ hex { 8 } - hex { 4 } - hex { 4 } - hex { 12 } @ where @ hex @ is an hexadecimal character , e . g . @ [ 0 - 9a - fA - F ] @ and @ { 4 } @ is the number of such characters . 
 + * A " UUID " : http : / / en . wikipedia . org / wiki / Universally _ unique _ identifier constant is defined by @ hex { 8 } - hex { 4 } - hex { 4 } - hex { 4 } - hex { 12 } @ where @ hex @ is an hexadecimal character , e . g . @ [ 0 - 9a - fA - F ] @ and @ { 4 } @ is the number of such characters . 
 
 
 h3 . Comments
