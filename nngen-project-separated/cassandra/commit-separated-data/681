BLEU SCORE: 0.010122231330332757

TEST MSG: Move migration tasks to non - periodic queue , assure flush executor shutdown after non - periodic executor .
GENERATED MSG: fix unbootstrap when no data is present in a transfer range

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index d28e419 . . a3a34c1 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 2 . 2 . 8 <nl> + * Move migration tasks to non - periodic queue , assure flush executor shutdown after non - periodic executor ( CASSANDRA - 12251 ) <nl> * cqlsh copy : fixed possible race in initializing feeding thread ( CASSANDRA - 11701 ) <nl> * Only set broadcast _ rpc _ address on Ec2MultiRegionSnitch if it ' s not set ( CASSANDRA - 11357 ) <nl> * Update StorageProxy range metrics for timeouts , failures and unavailables ( CASSANDRA - 9507 ) <nl> diff - - git a / src / java / org / apache / cassandra / service / MigrationManager . java b / src / java / org / apache / cassandra / service / MigrationManager . java <nl> index f7a2a48 . . 4cb5ed7 100644 <nl> - - - a / src / java / org / apache / cassandra / service / MigrationManager . java <nl> + + + b / src / java / org / apache / cassandra / service / MigrationManager . java <nl> @ @ - 129 , 7 + 129 , 7 @ @ public class MigrationManager <nl> submitMigrationTask ( endpoint ) ; <nl> } <nl> } ; <nl> - ScheduledExecutors . optionalTasks . schedule ( runnable , MIGRATION _ DELAY _ IN _ MS , TimeUnit . MILLISECONDS ) ; <nl> + ScheduledExecutors . nonPeriodicTasks . schedule ( runnable , MIGRATION _ DELAY _ IN _ MS , TimeUnit . MILLISECONDS ) ; <nl> } <nl> } <nl> <nl> diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java <nl> index 3148f5e . . e8ab54e 100644 <nl> - - - a / src / java / org / apache / cassandra / service / StorageService . java <nl> + + + b / src / java / org / apache / cassandra / service / StorageService . java <nl> @ @ - 3903 , 8 + 3903 , 6 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE <nl> / / there are no segments to replay , so we force the recycling of any remaining ( should be at most one ) <nl> CommitLog . instance . forceRecycleAllSegments ( ) ; <nl> <nl> - ColumnFamilyStore . shutdownPostFlushExecutor ( ) ; <nl> - <nl> CommitLog . instance . shutdownBlocking ( ) ; <nl> <nl> / / wait for miscellaneous tasks like sstable and commitlog segment deletion <nl> @ @ - 3912 , 6 + 3910 , 8 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE <nl> if ( ! ScheduledExecutors . nonPeriodicTasks . awaitTermination ( 1 , TimeUnit . MINUTES ) ) <nl> logger . warn ( " Miscellaneous task executor still busy after one minute ; proceeding with shutdown " ) ; <nl> <nl> + ColumnFamilyStore . shutdownPostFlushExecutor ( ) ; <nl> + <nl> setMode ( Mode . DRAINED , true ) ; <nl> } <nl>
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index dcc67d1 . . cf79af2 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 9 , 6 + 9 , 7 @ @ dev <nl> * remove assertion causing rare ( and harmless ) error messages in <nl> commitlog ( CASSANDRA - 1330 ) <nl> * fix moving nodes with no keyspaces defined ( CASSANDRA - 1574 ) <nl> + * fix unbootstrap when no data is present in a transfer range ( CASSANDRA - 1573 ) <nl> <nl> <nl> 0 . 7 - beta2 <nl> diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java <nl> index 293c56c . . b5faeda 100644 <nl> - - - a / src / java / org / apache / cassandra / service / StorageService . java <nl> + + + b / src / java / org / apache / cassandra / service / StorageService . java <nl> @ @ - 396 , 7 + 396 , 7 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe <nl> if ( DatabaseDescriptor . getNonSystemTables ( ) . size ( ) > 0 ) <nl> { <nl> bootstrap ( token ) ; <nl> - assert ! isBootstrapMode ; / / bootstrap will block until finishec <nl> + assert ! isBootstrapMode ; / / bootstrap will block until finished <nl> } <nl> else <nl> { <nl> diff - - git a / src / java / org / apache / cassandra / streaming / StreamOut . java b / src / java / org / apache / cassandra / streaming / StreamOut . java <nl> index 2a3b342 . . 6328055 100644 <nl> - - - a / src / java / org / apache / cassandra / streaming / StreamOut . java <nl> + + + b / src / java / org / apache / cassandra / streaming / StreamOut . java <nl> @ @ - 150 , 6 + 150 , 10 @ @ public class StreamOut <nl> session . addFilesToStream ( pending ) ; <nl> session . begin ( ) ; <nl> } <nl> + else <nl> + { <nl> + session . close ( ) ; <nl> + } <nl> } <nl> <nl> / / called prior to sending anything .

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index d28e419 . . a3a34c1 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 2 . 2 . 8 
 + * Move migration tasks to non - periodic queue , assure flush executor shutdown after non - periodic executor ( CASSANDRA - 12251 ) 
 * cqlsh copy : fixed possible race in initializing feeding thread ( CASSANDRA - 11701 ) 
 * Only set broadcast _ rpc _ address on Ec2MultiRegionSnitch if it ' s not set ( CASSANDRA - 11357 ) 
 * Update StorageProxy range metrics for timeouts , failures and unavailables ( CASSANDRA - 9507 ) 
 diff - - git a / src / java / org / apache / cassandra / service / MigrationManager . java b / src / java / org / apache / cassandra / service / MigrationManager . java 
 index f7a2a48 . . 4cb5ed7 100644 
 - - - a / src / java / org / apache / cassandra / service / MigrationManager . java 
 + + + b / src / java / org / apache / cassandra / service / MigrationManager . java 
 @ @ - 129 , 7 + 129 , 7 @ @ public class MigrationManager 
 submitMigrationTask ( endpoint ) ; 
 } 
 } ; 
 - ScheduledExecutors . optionalTasks . schedule ( runnable , MIGRATION _ DELAY _ IN _ MS , TimeUnit . MILLISECONDS ) ; 
 + ScheduledExecutors . nonPeriodicTasks . schedule ( runnable , MIGRATION _ DELAY _ IN _ MS , TimeUnit . MILLISECONDS ) ; 
 } 
 } 
 
 diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java 
 index 3148f5e . . e8ab54e 100644 
 - - - a / src / java / org / apache / cassandra / service / StorageService . java 
 + + + b / src / java / org / apache / cassandra / service / StorageService . java 
 @ @ - 3903 , 8 + 3903 , 6 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE 
 / / there are no segments to replay , so we force the recycling of any remaining ( should be at most one ) 
 CommitLog . instance . forceRecycleAllSegments ( ) ; 
 
 - ColumnFamilyStore . shutdownPostFlushExecutor ( ) ; 
 - 
 CommitLog . instance . shutdownBlocking ( ) ; 
 
 / / wait for miscellaneous tasks like sstable and commitlog segment deletion 
 @ @ - 3912 , 6 + 3910 , 8 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE 
 if ( ! ScheduledExecutors . nonPeriodicTasks . awaitTermination ( 1 , TimeUnit . MINUTES ) ) 
 logger . warn ( " Miscellaneous task executor still busy after one minute ; proceeding with shutdown " ) ; 
 
 + ColumnFamilyStore . shutdownPostFlushExecutor ( ) ; 
 + 
 setMode ( Mode . DRAINED , true ) ; 
 } 


NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index dcc67d1 . . cf79af2 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 9 , 6 + 9 , 7 @ @ dev 
 * remove assertion causing rare ( and harmless ) error messages in 
 commitlog ( CASSANDRA - 1330 ) 
 * fix moving nodes with no keyspaces defined ( CASSANDRA - 1574 ) 
 + * fix unbootstrap when no data is present in a transfer range ( CASSANDRA - 1573 ) 
 
 
 0 . 7 - beta2 
 diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java 
 index 293c56c . . b5faeda 100644 
 - - - a / src / java / org / apache / cassandra / service / StorageService . java 
 + + + b / src / java / org / apache / cassandra / service / StorageService . java 
 @ @ - 396 , 7 + 396 , 7 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe 
 if ( DatabaseDescriptor . getNonSystemTables ( ) . size ( ) > 0 ) 
 { 
 bootstrap ( token ) ; 
 - assert ! isBootstrapMode ; / / bootstrap will block until finishec 
 + assert ! isBootstrapMode ; / / bootstrap will block until finished 
 } 
 else 
 { 
 diff - - git a / src / java / org / apache / cassandra / streaming / StreamOut . java b / src / java / org / apache / cassandra / streaming / StreamOut . java 
 index 2a3b342 . . 6328055 100644 
 - - - a / src / java / org / apache / cassandra / streaming / StreamOut . java 
 + + + b / src / java / org / apache / cassandra / streaming / StreamOut . java 
 @ @ - 150 , 6 + 150 , 10 @ @ public class StreamOut 
 session . addFilesToStream ( pending ) ; 
 session . begin ( ) ; 
 } 
 + else 
 + { 
 + session . close ( ) ; 
 + } 
 } 
 
 / / called prior to sending anything .
