BLEU SCORE: 0.07768562846380175

TEST MSG: Fix race in Thrift server that can exhaust the pool of worker threads
GENERATED MSG: Fix handling of RejectedExecution in sync Thrift server

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 6bd3aba . . 11ded69 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 31 , 6 + 31 , 7 @ @ <nl> * Fix availability validation for LOCAL _ ONE CL ( CASSANDRA - 7319 ) <nl> * Hint streaming can cause decommission to fail ( CASSANDRA - 7219 ) <nl> * RepairTask didn ' t send a correct message on IllegalArgumentException ( CASSANDRA - 7336 ) <nl> + * Fix race in Thrift server that can exhaust the pool of worker threads ( CASSANDRA - 6788 ) <nl> <nl> <nl> 1 . 2 . 16 <nl> diff - - git a / src / java / org / apache / cassandra / thrift / CustomTThreadPoolServer . java b / src / java / org / apache / cassandra / thrift / CustomTThreadPoolServer . java <nl> index 7014443 . . 6913fba 100644 <nl> - - - a / src / java / org / apache / cassandra / thrift / CustomTThreadPoolServer . java <nl> + + + b / src / java / org / apache / cassandra / thrift / CustomTThreadPoolServer . java <nl> @ @ - 21 , 6 + 21 , 7 @ @ import java . net . InetSocketAddress ; <nl> import java . net . SocketAddress ; <nl> import java . net . SocketTimeoutException ; <nl> import java . util . concurrent . ExecutorService ; <nl> + import java . util . concurrent . RejectedExecutionException ; <nl> import java . util . concurrent . SynchronousQueue ; <nl> import java . util . concurrent . ThreadPoolExecutor ; <nl> import java . util . concurrent . TimeUnit ; <nl> @ @ - 97 , 7 + 98 , 7 @ @ public class CustomTThreadPoolServer extends TServer <nl> { <nl> try <nl> { <nl> - Thread . sleep ( 100 ) ; <nl> + Thread . sleep ( 10 ) ; <nl> } <nl> catch ( InterruptedException e ) <nl> { <nl> @ @ - 122 , 6 + 123 , 12 @ @ public class CustomTThreadPoolServer extends TServer <nl> logger . warn ( " Transport error occurred during acceptance of message . " , ttx ) ; <nl> } <nl> } <nl> + catch ( RejectedExecutionException e ) <nl> + { <nl> + / / worker thread decremented activeClients but hadn ' t finished exiting <nl> + logger . debug ( " Dropping client connection because our limit of { } has been reached " , args . maxWorkerThreads ) ; <nl> + continue ; <nl> + } <nl> <nl> if ( activeClients . get ( ) > = args . maxWorkerThreads ) <nl> logger . warn ( " Maximum number of clients " + args . maxWorkerThreads + " reached " ) ; <nl> @ @ - 218 , 19 + 225 , 13 @ @ public class CustomTThreadPoolServer extends TServer <nl> } <nl> finally <nl> { <nl> - activeClients . decrementAndGet ( ) ; <nl> if ( socket ! = null ) <nl> ThriftSessionManager . instance . connectionComplete ( socket ) ; <nl> - } <nl> - <nl> - if ( inputTransport ! = null ) <nl> - { <nl> - inputTransport . close ( ) ; <nl> - } <nl> - <nl> - if ( outputTransport ! = null ) <nl> - { <nl> - outputTransport . close ( ) ; <nl> + if ( inputTransport ! = null ) <nl> + inputTransport . close ( ) ; <nl> + if ( outputTransport ! = null ) <nl> + outputTransport . close ( ) ; <nl> + activeClients . decrementAndGet ( ) ; <nl> } <nl> } <nl> }
NEAREST DIFF (one line): ELIMINATEDSENTENCE

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 6bd3aba . . 11ded69 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 31 , 6 + 31 , 7 @ @ 
 * Fix availability validation for LOCAL _ ONE CL ( CASSANDRA - 7319 ) 
 * Hint streaming can cause decommission to fail ( CASSANDRA - 7219 ) 
 * RepairTask didn ' t send a correct message on IllegalArgumentException ( CASSANDRA - 7336 ) 
 + * Fix race in Thrift server that can exhaust the pool of worker threads ( CASSANDRA - 6788 ) 
 
 
 1 . 2 . 16 
 diff - - git a / src / java / org / apache / cassandra / thrift / CustomTThreadPoolServer . java b / src / java / org / apache / cassandra / thrift / CustomTThreadPoolServer . java 
 index 7014443 . . 6913fba 100644 
 - - - a / src / java / org / apache / cassandra / thrift / CustomTThreadPoolServer . java 
 + + + b / src / java / org / apache / cassandra / thrift / CustomTThreadPoolServer . java 
 @ @ - 21 , 6 + 21 , 7 @ @ import java . net . InetSocketAddress ; 
 import java . net . SocketAddress ; 
 import java . net . SocketTimeoutException ; 
 import java . util . concurrent . ExecutorService ; 
 + import java . util . concurrent . RejectedExecutionException ; 
 import java . util . concurrent . SynchronousQueue ; 
 import java . util . concurrent . ThreadPoolExecutor ; 
 import java . util . concurrent . TimeUnit ; 
 @ @ - 97 , 7 + 98 , 7 @ @ public class CustomTThreadPoolServer extends TServer 
 { 
 try 
 { 
 - Thread . sleep ( 100 ) ; 
 + Thread . sleep ( 10 ) ; 
 } 
 catch ( InterruptedException e ) 
 { 
 @ @ - 122 , 6 + 123 , 12 @ @ public class CustomTThreadPoolServer extends TServer 
 logger . warn ( " Transport error occurred during acceptance of message . " , ttx ) ; 
 } 
 } 
 + catch ( RejectedExecutionException e ) 
 + { 
 + / / worker thread decremented activeClients but hadn ' t finished exiting 
 + logger . debug ( " Dropping client connection because our limit of { } has been reached " , args . maxWorkerThreads ) ; 
 + continue ; 
 + } 
 
 if ( activeClients . get ( ) > = args . maxWorkerThreads ) 
 logger . warn ( " Maximum number of clients " + args . maxWorkerThreads + " reached " ) ; 
 @ @ - 218 , 19 + 225 , 13 @ @ public class CustomTThreadPoolServer extends TServer 
 } 
 finally 
 { 
 - activeClients . decrementAndGet ( ) ; 
 if ( socket ! = null ) 
 ThriftSessionManager . instance . connectionComplete ( socket ) ; 
 - } 
 - 
 - if ( inputTransport ! = null ) 
 - { 
 - inputTransport . close ( ) ; 
 - } 
 - 
 - if ( outputTransport ! = null ) 
 - { 
 - outputTransport . close ( ) ; 
 + if ( inputTransport ! = null ) 
 + inputTransport . close ( ) ; 
 + if ( outputTransport ! = null ) 
 + outputTransport . close ( ) ; 
 + activeClients . decrementAndGet ( ) ; 
 } 
 } 
 }

NEAREST DIFF:
ELIMINATEDSENTENCE
