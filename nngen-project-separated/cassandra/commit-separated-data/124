BLEU SCORE: 0.037477767366779206

TEST MSG: Fix assertions in PaxosState and PrepareResponse after TableMetadata was made immutable
GENERATED MSG: fix unbootstrap when no data is present in a transfer range

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 4ea32c9 . . fd236a2 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 4 . 0 <nl> + * Fix assertions in LWTs after TableMetadata was made immutable ( CASSANDRA - 14356 ) <nl> * Abort compactions quicker ( CASSANDRA - 14397 ) <nl> * Support light - weight transactions in cassandra - stress ( CASSANDRA - 13529 ) <nl> * Make AsyncOneResponse use the correct timeout ( CASSANDRA - 14509 ) <nl> diff - - git a / src / java / org / apache / cassandra / service / paxos / PaxosState . java b / src / java / org / apache / cassandra / service / paxos / PaxosState . java <nl> index 7d59374 . . 6e02435 100644 <nl> - - - a / src / java / org / apache / cassandra / service / paxos / PaxosState . java <nl> + + + b / src / java / org / apache / cassandra / service / paxos / PaxosState . java <nl> @ @ - 46 , 7 + 46 , 7 @ @ public class PaxosState <nl> public PaxosState ( Commit promised , Commit accepted , Commit mostRecentCommit ) <nl> { <nl> assert promised . update . partitionKey ( ) . equals ( accepted . update . partitionKey ( ) ) & & accepted . update . partitionKey ( ) . equals ( mostRecentCommit . update . partitionKey ( ) ) ; <nl> - assert promised . update . metadata ( ) = = accepted . update . metadata ( ) & & accepted . update . metadata ( ) = = mostRecentCommit . update . metadata ( ) ; <nl> + assert promised . update . metadata ( ) . id . equals ( accepted . update . metadata ( ) . id ) & & accepted . update . metadata ( ) . id . equals ( mostRecentCommit . update . metadata ( ) . id ) ; <nl> <nl> this . promised = promised ; <nl> this . accepted = accepted ; <nl> diff - - git a / src / java / org / apache / cassandra / service / paxos / PrepareResponse . java b / src / java / org / apache / cassandra / service / paxos / PrepareResponse . java <nl> index 2110dd7 . . 4c7becc 100644 <nl> - - - a / src / java / org / apache / cassandra / service / paxos / PrepareResponse . java <nl> + + + b / src / java / org / apache / cassandra / service / paxos / PrepareResponse . java <nl> @ @ - 45 , 7 + 45 , 7 @ @ public class PrepareResponse <nl> public PrepareResponse ( boolean promised , Commit inProgressCommit , Commit mostRecentCommit ) <nl> { <nl> assert inProgressCommit . update . partitionKey ( ) . equals ( mostRecentCommit . update . partitionKey ( ) ) ; <nl> - assert inProgressCommit . update . metadata ( ) = = mostRecentCommit . update . metadata ( ) ; <nl> + assert inProgressCommit . update . metadata ( ) . id . equals ( mostRecentCommit . update . metadata ( ) . id ) ; <nl> <nl> this . promised = promised ; <nl> this . mostRecentCommit = mostRecentCommit ;
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index dcc67d1 . . cf79af2 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 9 , 6 + 9 , 7 @ @ dev <nl> * remove assertion causing rare ( and harmless ) error messages in <nl> commitlog ( CASSANDRA - 1330 ) <nl> * fix moving nodes with no keyspaces defined ( CASSANDRA - 1574 ) <nl> + * fix unbootstrap when no data is present in a transfer range ( CASSANDRA - 1573 ) <nl> <nl> <nl> 0 . 7 - beta2 <nl> diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java <nl> index 293c56c . . b5faeda 100644 <nl> - - - a / src / java / org / apache / cassandra / service / StorageService . java <nl> + + + b / src / java / org / apache / cassandra / service / StorageService . java <nl> @ @ - 396 , 7 + 396 , 7 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe <nl> if ( DatabaseDescriptor . getNonSystemTables ( ) . size ( ) > 0 ) <nl> { <nl> bootstrap ( token ) ; <nl> - assert ! isBootstrapMode ; / / bootstrap will block until finishec <nl> + assert ! isBootstrapMode ; / / bootstrap will block until finished <nl> } <nl> else <nl> { <nl> diff - - git a / src / java / org / apache / cassandra / streaming / StreamOut . java b / src / java / org / apache / cassandra / streaming / StreamOut . java <nl> index 2a3b342 . . 6328055 100644 <nl> - - - a / src / java / org / apache / cassandra / streaming / StreamOut . java <nl> + + + b / src / java / org / apache / cassandra / streaming / StreamOut . java <nl> @ @ - 150 , 6 + 150 , 10 @ @ public class StreamOut <nl> session . addFilesToStream ( pending ) ; <nl> session . begin ( ) ; <nl> } <nl> + else <nl> + { <nl> + session . close ( ) ; <nl> + } <nl> } <nl> <nl> / / called prior to sending anything .

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 4ea32c9 . . fd236a2 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 4 . 0 
 + * Fix assertions in LWTs after TableMetadata was made immutable ( CASSANDRA - 14356 ) 
 * Abort compactions quicker ( CASSANDRA - 14397 ) 
 * Support light - weight transactions in cassandra - stress ( CASSANDRA - 13529 ) 
 * Make AsyncOneResponse use the correct timeout ( CASSANDRA - 14509 ) 
 diff - - git a / src / java / org / apache / cassandra / service / paxos / PaxosState . java b / src / java / org / apache / cassandra / service / paxos / PaxosState . java 
 index 7d59374 . . 6e02435 100644 
 - - - a / src / java / org / apache / cassandra / service / paxos / PaxosState . java 
 + + + b / src / java / org / apache / cassandra / service / paxos / PaxosState . java 
 @ @ - 46 , 7 + 46 , 7 @ @ public class PaxosState 
 public PaxosState ( Commit promised , Commit accepted , Commit mostRecentCommit ) 
 { 
 assert promised . update . partitionKey ( ) . equals ( accepted . update . partitionKey ( ) ) & & accepted . update . partitionKey ( ) . equals ( mostRecentCommit . update . partitionKey ( ) ) ; 
 - assert promised . update . metadata ( ) = = accepted . update . metadata ( ) & & accepted . update . metadata ( ) = = mostRecentCommit . update . metadata ( ) ; 
 + assert promised . update . metadata ( ) . id . equals ( accepted . update . metadata ( ) . id ) & & accepted . update . metadata ( ) . id . equals ( mostRecentCommit . update . metadata ( ) . id ) ; 
 
 this . promised = promised ; 
 this . accepted = accepted ; 
 diff - - git a / src / java / org / apache / cassandra / service / paxos / PrepareResponse . java b / src / java / org / apache / cassandra / service / paxos / PrepareResponse . java 
 index 2110dd7 . . 4c7becc 100644 
 - - - a / src / java / org / apache / cassandra / service / paxos / PrepareResponse . java 
 + + + b / src / java / org / apache / cassandra / service / paxos / PrepareResponse . java 
 @ @ - 45 , 7 + 45 , 7 @ @ public class PrepareResponse 
 public PrepareResponse ( boolean promised , Commit inProgressCommit , Commit mostRecentCommit ) 
 { 
 assert inProgressCommit . update . partitionKey ( ) . equals ( mostRecentCommit . update . partitionKey ( ) ) ; 
 - assert inProgressCommit . update . metadata ( ) = = mostRecentCommit . update . metadata ( ) ; 
 + assert inProgressCommit . update . metadata ( ) . id . equals ( mostRecentCommit . update . metadata ( ) . id ) ; 
 
 this . promised = promised ; 
 this . mostRecentCommit = mostRecentCommit ;

NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index dcc67d1 . . cf79af2 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 9 , 6 + 9 , 7 @ @ dev 
 * remove assertion causing rare ( and harmless ) error messages in 
 commitlog ( CASSANDRA - 1330 ) 
 * fix moving nodes with no keyspaces defined ( CASSANDRA - 1574 ) 
 + * fix unbootstrap when no data is present in a transfer range ( CASSANDRA - 1573 ) 
 
 
 0 . 7 - beta2 
 diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java 
 index 293c56c . . b5faeda 100644 
 - - - a / src / java / org / apache / cassandra / service / StorageService . java 
 + + + b / src / java / org / apache / cassandra / service / StorageService . java 
 @ @ - 396 , 7 + 396 , 7 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe 
 if ( DatabaseDescriptor . getNonSystemTables ( ) . size ( ) > 0 ) 
 { 
 bootstrap ( token ) ; 
 - assert ! isBootstrapMode ; / / bootstrap will block until finishec 
 + assert ! isBootstrapMode ; / / bootstrap will block until finished 
 } 
 else 
 { 
 diff - - git a / src / java / org / apache / cassandra / streaming / StreamOut . java b / src / java / org / apache / cassandra / streaming / StreamOut . java 
 index 2a3b342 . . 6328055 100644 
 - - - a / src / java / org / apache / cassandra / streaming / StreamOut . java 
 + + + b / src / java / org / apache / cassandra / streaming / StreamOut . java 
 @ @ - 150 , 6 + 150 , 10 @ @ public class StreamOut 
 session . addFilesToStream ( pending ) ; 
 session . begin ( ) ; 
 } 
 + else 
 + { 
 + session . close ( ) ; 
 + } 
 } 
 
 / / called prior to sending anything .
