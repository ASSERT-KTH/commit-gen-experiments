BLEU SCORE: 0.019071414280313313

TEST MSG: don ' t use o . a . commons . io for one method
GENERATED MSG: check rename return code , and close before renaming . patch by jbellis ; reviewed by Stu Hood for CASSANDRA - 630

TEST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> index c5afb25 . . 33b7303 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> @ @ - 17 , 9 + 17 , 7 @ @ <nl> * / <nl> package org . apache . cassandra . db ; <nl> <nl> - import java . io . File ; <nl> - import java . io . FileFilter ; <nl> - import java . io . IOException ; <nl> + import java . io . * ; <nl> import java . lang . management . ManagementFactory ; <nl> import java . nio . ByteBuffer ; <nl> import java . util . * ; <nl> @ @ - 2173 , 9 + 2171 , 12 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean <nl> final JSONObject manifestJSON = new JSONObject ( ) ; <nl> manifestJSON . put ( " files " , filesJSONArr ) ; <nl> <nl> + <nl> try <nl> { <nl> - org . apache . commons . io . FileUtils . writeStringToFile ( manifestFile , manifestJSON . toJSONString ( ) ) ; <nl> + PrintStream out = new PrintStream ( manifestFile ) ; <nl> + out . println ( manifestJSON . toJSONString ( ) ) ; <nl> + out . close ( ) ; <nl> } <nl> catch ( IOException e ) <nl> {
NEAREST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / io / SSTableWriter . java b / src / java / org / apache / cassandra / io / SSTableWriter . java <nl> index db336c1 . . 581904b 100644 <nl> - - - a / src / java / org / apache / cassandra / io / SSTableWriter . java <nl> + + + b / src / java / org / apache / cassandra / io / SSTableWriter . java <nl> @ @ - 21 , 11 + 21 , 7 @ @ package org . apache . cassandra . io ; <nl> * / <nl> <nl> <nl> - import java . io . File ; <nl> - import java . io . IOException ; <nl> - import java . io . FileOutputStream ; <nl> - import java . io . DataOutputStream ; <nl> - import java . util . Comparator ; <nl> + import java . io . * ; <nl> import java . util . ArrayList ; <nl> <nl> import org . apache . log4j . Logger ; <nl> @ @ - 34 , 6 + 30 , 7 @ @ import org . apache . cassandra . db . DecoratedKey ; <nl> import org . apache . cassandra . dht . IPartitioner ; <nl> import org . apache . cassandra . service . StorageService ; <nl> import org . apache . cassandra . utils . BloomFilter ; <nl> + import org . apache . cassandra . utils . FBUtilities ; <nl> import org . apache . cassandra . config . DatabaseDescriptor ; <nl> import com . reardencommerce . kernel . collections . shared . evictable . ConcurrentLinkedHashMap ; <nl> <nl> @ @ - 148 , 7 + 145 , 14 @ @ public class SSTableWriter extends SSTable <nl> static String rename ( String tmpFilename ) <nl> { <nl> String filename = tmpFilename . replace ( " - " + SSTable . TEMPFILE _ MARKER , " " ) ; <nl> - new File ( tmpFilename ) . renameTo ( new File ( filename ) ) ; <nl> + try <nl> + { <nl> + FBUtilities . renameWithConfirm ( tmpFilename , filename ) ; <nl> + } <nl> + catch ( IOException e ) <nl> + { <nl> + throw new IOError ( e ) ; <nl> + } <nl> return filename ; <nl> } <nl> <nl> diff - - git a / src / java / org / apache / cassandra / net / io / ContentStreamState . java b / src / java / org / apache / cassandra / net / io / ContentStreamState . java <nl> index 307824e . . eebb987 100644 <nl> - - - a / src / java / org / apache / cassandra / net / io / ContentStreamState . java <nl> + + + b / src / java / org / apache / cassandra / net / io / ContentStreamState . java <nl> @ @ - 86 , 9 + 86 , 9 @ @ class ContentStreamState extends StartState <nl> { <nl> if ( logger _ . isDebugEnabled ( ) ) <nl> logger _ . debug ( " Removing stream context " + streamContext _ ) ; <nl> - handleStreamCompletion ( remoteAddress . getAddress ( ) ) ; <nl> - bytesRead _ = 0L ; <nl> fc _ . close ( ) ; <nl> + handleStreamCompletion ( remoteAddress . getAddress ( ) ) ; <nl> + bytesRead _ = 0L ; <nl> morphState ( ) ; <nl> } <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / utils / FBUtilities . java b / src / java / org / apache / cassandra / utils / FBUtilities . java <nl> index 7bfb014 . . ade808e 100644 <nl> - - - a / src / java / org / apache / cassandra / utils / FBUtilities . java <nl> + + + b / src / java / org / apache / cassandra / utils / FBUtilities . java <nl> @ @ - 280 , 4 + 280 , 12 @ @ public class FBUtilities <nl> return null ; <nl> return dis . readUTF ( ) ; <nl> } <nl> + <nl> + public static void renameWithConfirm ( String tmpFilename , String filename ) throws IOException <nl> + { <nl> + if ( ! new File ( tmpFilename ) . renameTo ( new File ( filename ) ) ) <nl> + { <nl> + throw new IOException ( " rename failed of " + filename ) ; <nl> + } <nl> + } <nl> }

TEST DIFF:
diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 index c5afb25 . . 33b7303 100644 
 - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 @ @ - 17 , 9 + 17 , 7 @ @ 
 * / 
 package org . apache . cassandra . db ; 
 
 - import java . io . File ; 
 - import java . io . FileFilter ; 
 - import java . io . IOException ; 
 + import java . io . * ; 
 import java . lang . management . ManagementFactory ; 
 import java . nio . ByteBuffer ; 
 import java . util . * ; 
 @ @ - 2173 , 9 + 2171 , 12 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean 
 final JSONObject manifestJSON = new JSONObject ( ) ; 
 manifestJSON . put ( " files " , filesJSONArr ) ; 
 
 + 
 try 
 { 
 - org . apache . commons . io . FileUtils . writeStringToFile ( manifestFile , manifestJSON . toJSONString ( ) ) ; 
 + PrintStream out = new PrintStream ( manifestFile ) ; 
 + out . println ( manifestJSON . toJSONString ( ) ) ; 
 + out . close ( ) ; 
 } 
 catch ( IOException e ) 
 {

NEAREST DIFF:
diff - - git a / src / java / org / apache / cassandra / io / SSTableWriter . java b / src / java / org / apache / cassandra / io / SSTableWriter . java 
 index db336c1 . . 581904b 100644 
 - - - a / src / java / org / apache / cassandra / io / SSTableWriter . java 
 + + + b / src / java / org / apache / cassandra / io / SSTableWriter . java 
 @ @ - 21 , 11 + 21 , 7 @ @ package org . apache . cassandra . io ; 
 * / 
 
 
 - import java . io . File ; 
 - import java . io . IOException ; 
 - import java . io . FileOutputStream ; 
 - import java . io . DataOutputStream ; 
 - import java . util . Comparator ; 
 + import java . io . * ; 
 import java . util . ArrayList ; 
 
 import org . apache . log4j . Logger ; 
 @ @ - 34 , 6 + 30 , 7 @ @ import org . apache . cassandra . db . DecoratedKey ; 
 import org . apache . cassandra . dht . IPartitioner ; 
 import org . apache . cassandra . service . StorageService ; 
 import org . apache . cassandra . utils . BloomFilter ; 
 + import org . apache . cassandra . utils . FBUtilities ; 
 import org . apache . cassandra . config . DatabaseDescriptor ; 
 import com . reardencommerce . kernel . collections . shared . evictable . ConcurrentLinkedHashMap ; 
 
 @ @ - 148 , 7 + 145 , 14 @ @ public class SSTableWriter extends SSTable 
 static String rename ( String tmpFilename ) 
 { 
 String filename = tmpFilename . replace ( " - " + SSTable . TEMPFILE _ MARKER , " " ) ; 
 - new File ( tmpFilename ) . renameTo ( new File ( filename ) ) ; 
 + try 
 + { 
 + FBUtilities . renameWithConfirm ( tmpFilename , filename ) ; 
 + } 
 + catch ( IOException e ) 
 + { 
 + throw new IOError ( e ) ; 
 + } 
 return filename ; 
 } 
 
 diff - - git a / src / java / org / apache / cassandra / net / io / ContentStreamState . java b / src / java / org / apache / cassandra / net / io / ContentStreamState . java 
 index 307824e . . eebb987 100644 
 - - - a / src / java / org / apache / cassandra / net / io / ContentStreamState . java 
 + + + b / src / java / org / apache / cassandra / net / io / ContentStreamState . java 
 @ @ - 86 , 9 + 86 , 9 @ @ class ContentStreamState extends StartState 
 { 
 if ( logger _ . isDebugEnabled ( ) ) 
 logger _ . debug ( " Removing stream context " + streamContext _ ) ; 
 - handleStreamCompletion ( remoteAddress . getAddress ( ) ) ; 
 - bytesRead _ = 0L ; 
 fc _ . close ( ) ; 
 + handleStreamCompletion ( remoteAddress . getAddress ( ) ) ; 
 + bytesRead _ = 0L ; 
 morphState ( ) ; 
 } 
 } 
 diff - - git a / src / java / org / apache / cassandra / utils / FBUtilities . java b / src / java / org / apache / cassandra / utils / FBUtilities . java 
 index 7bfb014 . . ade808e 100644 
 - - - a / src / java / org / apache / cassandra / utils / FBUtilities . java 
 + + + b / src / java / org / apache / cassandra / utils / FBUtilities . java 
 @ @ - 280 , 4 + 280 , 12 @ @ public class FBUtilities 
 return null ; 
 return dis . readUTF ( ) ; 
 } 
 + 
 + public static void renameWithConfirm ( String tmpFilename , String filename ) throws IOException 
 + { 
 + if ( ! new File ( tmpFilename ) . renameTo ( new File ( filename ) ) ) 
 + { 
 + throw new IOException ( " rename failed of " + filename ) ; 
 + } 
 + } 
 }
