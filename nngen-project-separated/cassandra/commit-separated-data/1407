BLEU SCORE: 7.81475073118011E-4

TEST MSG: Fixed coverity defects
GENERATED MSG: validate UTF8 keys in legacy OPP and COPP . patch by Nick Bailey ; reviewed by Stu Hood and jbellis

TEST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / utils / MerkleTrees . java b / src / java / org / apache / cassandra / utils / MerkleTrees . java <nl> index 43c023e . . b950b3b 100644 <nl> - - - a / src / java / org / apache / cassandra / utils / MerkleTrees . java <nl> + + + b / src / java / org / apache / cassandra / utils / MerkleTrees . java <nl> @ @ - 125 , 6 + 125 , 7 @ @ public class MerkleTrees implements Iterable < Map . Entry < Range < Token > , MerkleTree > <nl> * @ param t <nl> * @ return <nl> * / <nl> + @ VisibleForTesting <nl> public MerkleTree . TreeRange get ( Token t ) <nl> { <nl> return getMerkleTree ( t ) . get ( t ) ; <nl> @ @ - 167 , 6 + 168 , 7 @ @ public class MerkleTrees implements Iterable < Map . Entry < Range < Token > , MerkleTree > <nl> * <nl> * @ param t <nl> * / <nl> + @ VisibleForTesting <nl> public void invalidate ( Token t ) <nl> { <nl> getMerkleTree ( t ) . invalidate ( t ) ; <nl> @ @ - 215 , 7 + 217 , 7 @ @ public class MerkleTrees implements Iterable < Map . Entry < Range < Token > , MerkleTree > <nl> return merkleTrees . get ( range ) ; <nl> } <nl> <nl> - return null ; <nl> + throw new AssertionError ( " Expected tree for token " + t ) ; <nl> } <nl> <nl> private void addTrees ( Collection < MerkleTree > trees ) <nl> diff - - git a / test / unit / org / apache / cassandra / repair / LocalSyncTaskTest . java b / test / unit / org / apache / cassandra / repair / LocalSyncTaskTest . java <nl> index db3f683 . . 734e91b 100644 <nl> - - - a / test / unit / org / apache / cassandra / repair / LocalSyncTaskTest . java <nl> + + + b / test / unit / org / apache / cassandra / repair / LocalSyncTaskTest . java <nl> @ @ - 20 , 9 + 20 , 7 @ @ package org . apache . cassandra . repair ; <nl> <nl> import java . net . InetAddress ; <nl> import java . util . Arrays ; <nl> - import java . util . HashMap ; <nl> import java . util . HashSet ; <nl> - import java . util . Map ; <nl> import java . util . Set ; <nl> import java . util . UUID ; <nl>
NEAREST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / dht / CollatingOrderPreservingPartitioner . java b / src / java / org / apache / cassandra / dht / CollatingOrderPreservingPartitioner . java <nl> index 7fb9dd0 . . 76b878b 100644 <nl> - - - a / src / java / org / apache / cassandra / dht / CollatingOrderPreservingPartitioner . java <nl> + + + b / src / java / org / apache / cassandra / dht / CollatingOrderPreservingPartitioner . java <nl> @ @ - 19 , 6 + 19 , 7 @ @ <nl> package org . apache . cassandra . dht ; <nl> <nl> import java . math . BigInteger ; <nl> + import java . nio . charset . CharacterCodingException ; <nl> import java . text . Collator ; <nl> import java . util . Arrays ; <nl> import java . util . Comparator ; <nl> @ @ - 39 , 7 + 40 , 16 @ @ public class CollatingOrderPreservingPartitioner extends AbstractByteOrderedPart <nl> { <nl> if ( key . length = = 0 ) <nl> return MINIMUM ; <nl> - String skey = new String ( key , FBUtilities . UTF8 ) ; <nl> + <nl> + String skey ; <nl> + try <nl> + { <nl> + skey = FBUtilities . decodeToUTF8 ( key ) ; <nl> + } <nl> + catch ( CharacterCodingException e ) <nl> + { <nl> + throw new RuntimeException ( " The provided key was not UTF8 encoded . " , e ) ; <nl> + } <nl> return new BytesToken ( collator . getCollationKey ( skey ) . toByteArray ( ) ) ; <nl> } <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / dht / OrderPreservingPartitioner . java b / src / java / org / apache / cassandra / dht / OrderPreservingPartitioner . java <nl> index 9e1522e . . 27aa614 100644 <nl> - - - a / src / java / org / apache / cassandra / dht / OrderPreservingPartitioner . java <nl> + + + b / src / java / org / apache / cassandra / dht / OrderPreservingPartitioner . java <nl> @ @ - 20 , 6 + 20 , 7 @ @ package org . apache . cassandra . dht ; <nl> <nl> import java . io . UnsupportedEncodingException ; <nl> import java . math . BigInteger ; <nl> + import java . nio . charset . CharacterCodingException ; <nl> import java . util . Arrays ; <nl> import java . util . Comparator ; <nl> import java . util . Random ; <nl> @ @ - 163 , 6 + 164 , 15 @ @ public class OrderPreservingPartitioner implements IPartitioner < StringToken > <nl> <nl> public StringToken getToken ( byte [ ] key ) <nl> { <nl> - return new StringToken ( new String ( key , FBUtilities . UTF8 ) ) ; <nl> + String skey ; <nl> + try <nl> + { <nl> + skey = FBUtilities . decodeToUTF8 ( key ) ; <nl> + } <nl> + catch ( CharacterCodingException e ) <nl> + { <nl> + throw new RuntimeException ( " The provided key was not UTF8 encoded . " , e ) ; <nl> + } <nl> + return new StringToken ( skey ) ; <nl> } <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / utils / FBUtilities . java b / src / java / org / apache / cassandra / utils / FBUtilities . java <nl> index e6fce1f . . e2ffb2f 100644 <nl> - - - a / src / java / org / apache / cassandra / utils / FBUtilities . java <nl> + + + b / src / java / org / apache / cassandra / utils / FBUtilities . java <nl> @ @ - 27 , 7 + 27 , 9 @ @ import java . net . InetAddress ; <nl> import java . net . URL ; <nl> import java . net . UnknownHostException ; <nl> import java . nio . ByteBuffer ; <nl> + import java . nio . charset . CharacterCodingException ; <nl> import java . nio . charset . Charset ; <nl> + import java . nio . charset . CharsetDecoder ; <nl> import java . security . MessageDigest ; <nl> import java . util . Arrays ; <nl> import java . util . Collections ; <nl> @ @ - 37 , 6 + 39 , 7 @ @ import java . util . concurrent . atomic . AtomicInteger ; <nl> import java . util . concurrent . atomic . AtomicLong ; <nl> import java . util . concurrent . atomic . AtomicReference ; <nl> <nl> + import com . google . common . base . Charsets ; <nl> import org . apache . commons . collections . iterators . CollatingIterator ; <nl> import org . slf4j . Logger ; <nl> import org . slf4j . LoggerFactory ; <nl> @ @ - 63 , 6 + 66 , 7 @ @ public class FBUtilities <nl> private static volatile InetAddress localInetAddress _ ; <nl> <nl> public static final int MAX _ UNSIGNED _ SHORT = 0xFFFF ; <nl> + public static final CharsetDecoder utf8Decoder = Charsets . UTF _ 8 . newDecoder ( ) ; <nl> <nl> public static Charset UTF8 ; <nl> static <nl> @ @ - 480 , 6 + 484 , 11 @ @ public class FBUtilities <nl> return utflen ; <nl> } <nl> <nl> + public static String decodeToUTF8 ( byte [ ] bytes ) throws CharacterCodingException <nl> + { <nl> + return utf8Decoder . decode ( ByteBuffer . wrap ( bytes ) ) . toString ( ) ; <nl> + } <nl> + <nl> / * * <nl> * Test if a particular bit is set using a bit mask . <nl> * <nl> diff - - git a / test / unit / org / apache / cassandra / utils / FBUtilitiesTest . java b / test / unit / org / apache / cassandra / utils / FBUtilitiesTest . java <nl> index 216f41d . . 7ad79b7 100644 <nl> - - - a / test / unit / org / apache / cassandra / utils / FBUtilitiesTest . java <nl> + + + b / test / unit / org / apache / cassandra / utils / FBUtilitiesTest . java <nl> @ @ - 21 , 6 + 21 , 8 @ @ package org . apache . cassandra . utils ; <nl> import static org . junit . Assert . assertArrayEquals ; <nl> import static org . junit . Assert . assertEquals ; <nl> <nl> + import java . io . IOException ; <nl> + import java . nio . charset . CharacterCodingException ; <nl> import java . util . concurrent . atomic . AtomicReference ; <nl> <nl> import org . apache . cassandra . db . IClock ; <nl> @ @ - 80 , 4 + 82 , 11 @ @ public class FBUtilitiesTest <nl> FBUtilities . atomicSetMax ( atomicClock , new TimestampClock ( 3L ) ) ; <nl> assert ( ( TimestampClock ) atomicClock . get ( ) ) . timestamp ( ) = = 9L ; <nl> } <nl> + <nl> + @ Test ( expected = CharacterCodingException . class ) <nl> + public void testDecode ( ) throws IOException <nl> + { <nl> + byte [ ] bytes = new byte [ ] { ( byte ) 0xff , ( byte ) 0xfe } ; <nl> + FBUtilities . decodeToUTF8 ( bytes ) ; <nl> + } <nl> }

TEST DIFF:
diff - - git a / src / java / org / apache / cassandra / utils / MerkleTrees . java b / src / java / org / apache / cassandra / utils / MerkleTrees . java 
 index 43c023e . . b950b3b 100644 
 - - - a / src / java / org / apache / cassandra / utils / MerkleTrees . java 
 + + + b / src / java / org / apache / cassandra / utils / MerkleTrees . java 
 @ @ - 125 , 6 + 125 , 7 @ @ public class MerkleTrees implements Iterable < Map . Entry < Range < Token > , MerkleTree > 
 * @ param t 
 * @ return 
 * / 
 + @ VisibleForTesting 
 public MerkleTree . TreeRange get ( Token t ) 
 { 
 return getMerkleTree ( t ) . get ( t ) ; 
 @ @ - 167 , 6 + 168 , 7 @ @ public class MerkleTrees implements Iterable < Map . Entry < Range < Token > , MerkleTree > 
 * 
 * @ param t 
 * / 
 + @ VisibleForTesting 
 public void invalidate ( Token t ) 
 { 
 getMerkleTree ( t ) . invalidate ( t ) ; 
 @ @ - 215 , 7 + 217 , 7 @ @ public class MerkleTrees implements Iterable < Map . Entry < Range < Token > , MerkleTree > 
 return merkleTrees . get ( range ) ; 
 } 
 
 - return null ; 
 + throw new AssertionError ( " Expected tree for token " + t ) ; 
 } 
 
 private void addTrees ( Collection < MerkleTree > trees ) 
 diff - - git a / test / unit / org / apache / cassandra / repair / LocalSyncTaskTest . java b / test / unit / org / apache / cassandra / repair / LocalSyncTaskTest . java 
 index db3f683 . . 734e91b 100644 
 - - - a / test / unit / org / apache / cassandra / repair / LocalSyncTaskTest . java 
 + + + b / test / unit / org / apache / cassandra / repair / LocalSyncTaskTest . java 
 @ @ - 20 , 9 + 20 , 7 @ @ package org . apache . cassandra . repair ; 
 
 import java . net . InetAddress ; 
 import java . util . Arrays ; 
 - import java . util . HashMap ; 
 import java . util . HashSet ; 
 - import java . util . Map ; 
 import java . util . Set ; 
 import java . util . UUID ; 


NEAREST DIFF:
diff - - git a / src / java / org / apache / cassandra / dht / CollatingOrderPreservingPartitioner . java b / src / java / org / apache / cassandra / dht / CollatingOrderPreservingPartitioner . java 
 index 7fb9dd0 . . 76b878b 100644 
 - - - a / src / java / org / apache / cassandra / dht / CollatingOrderPreservingPartitioner . java 
 + + + b / src / java / org / apache / cassandra / dht / CollatingOrderPreservingPartitioner . java 
 @ @ - 19 , 6 + 19 , 7 @ @ 
 package org . apache . cassandra . dht ; 
 
 import java . math . BigInteger ; 
 + import java . nio . charset . CharacterCodingException ; 
 import java . text . Collator ; 
 import java . util . Arrays ; 
 import java . util . Comparator ; 
 @ @ - 39 , 7 + 40 , 16 @ @ public class CollatingOrderPreservingPartitioner extends AbstractByteOrderedPart 
 { 
 if ( key . length = = 0 ) 
 return MINIMUM ; 
 - String skey = new String ( key , FBUtilities . UTF8 ) ; 
 + 
 + String skey ; 
 + try 
 + { 
 + skey = FBUtilities . decodeToUTF8 ( key ) ; 
 + } 
 + catch ( CharacterCodingException e ) 
 + { 
 + throw new RuntimeException ( " The provided key was not UTF8 encoded . " , e ) ; 
 + } 
 return new BytesToken ( collator . getCollationKey ( skey ) . toByteArray ( ) ) ; 
 } 
 } 
 diff - - git a / src / java / org / apache / cassandra / dht / OrderPreservingPartitioner . java b / src / java / org / apache / cassandra / dht / OrderPreservingPartitioner . java 
 index 9e1522e . . 27aa614 100644 
 - - - a / src / java / org / apache / cassandra / dht / OrderPreservingPartitioner . java 
 + + + b / src / java / org / apache / cassandra / dht / OrderPreservingPartitioner . java 
 @ @ - 20 , 6 + 20 , 7 @ @ package org . apache . cassandra . dht ; 
 
 import java . io . UnsupportedEncodingException ; 
 import java . math . BigInteger ; 
 + import java . nio . charset . CharacterCodingException ; 
 import java . util . Arrays ; 
 import java . util . Comparator ; 
 import java . util . Random ; 
 @ @ - 163 , 6 + 164 , 15 @ @ public class OrderPreservingPartitioner implements IPartitioner < StringToken > 
 
 public StringToken getToken ( byte [ ] key ) 
 { 
 - return new StringToken ( new String ( key , FBUtilities . UTF8 ) ) ; 
 + String skey ; 
 + try 
 + { 
 + skey = FBUtilities . decodeToUTF8 ( key ) ; 
 + } 
 + catch ( CharacterCodingException e ) 
 + { 
 + throw new RuntimeException ( " The provided key was not UTF8 encoded . " , e ) ; 
 + } 
 + return new StringToken ( skey ) ; 
 } 
 } 
 diff - - git a / src / java / org / apache / cassandra / utils / FBUtilities . java b / src / java / org / apache / cassandra / utils / FBUtilities . java 
 index e6fce1f . . e2ffb2f 100644 
 - - - a / src / java / org / apache / cassandra / utils / FBUtilities . java 
 + + + b / src / java / org / apache / cassandra / utils / FBUtilities . java 
 @ @ - 27 , 7 + 27 , 9 @ @ import java . net . InetAddress ; 
 import java . net . URL ; 
 import java . net . UnknownHostException ; 
 import java . nio . ByteBuffer ; 
 + import java . nio . charset . CharacterCodingException ; 
 import java . nio . charset . Charset ; 
 + import java . nio . charset . CharsetDecoder ; 
 import java . security . MessageDigest ; 
 import java . util . Arrays ; 
 import java . util . Collections ; 
 @ @ - 37 , 6 + 39 , 7 @ @ import java . util . concurrent . atomic . AtomicInteger ; 
 import java . util . concurrent . atomic . AtomicLong ; 
 import java . util . concurrent . atomic . AtomicReference ; 
 
 + import com . google . common . base . Charsets ; 
 import org . apache . commons . collections . iterators . CollatingIterator ; 
 import org . slf4j . Logger ; 
 import org . slf4j . LoggerFactory ; 
 @ @ - 63 , 6 + 66 , 7 @ @ public class FBUtilities 
 private static volatile InetAddress localInetAddress _ ; 
 
 public static final int MAX _ UNSIGNED _ SHORT = 0xFFFF ; 
 + public static final CharsetDecoder utf8Decoder = Charsets . UTF _ 8 . newDecoder ( ) ; 
 
 public static Charset UTF8 ; 
 static 
 @ @ - 480 , 6 + 484 , 11 @ @ public class FBUtilities 
 return utflen ; 
 } 
 
 + public static String decodeToUTF8 ( byte [ ] bytes ) throws CharacterCodingException 
 + { 
 + return utf8Decoder . decode ( ByteBuffer . wrap ( bytes ) ) . toString ( ) ; 
 + } 
 + 
 / * * 
 * Test if a particular bit is set using a bit mask . 
 * 
 diff - - git a / test / unit / org / apache / cassandra / utils / FBUtilitiesTest . java b / test / unit / org / apache / cassandra / utils / FBUtilitiesTest . java 
 index 216f41d . . 7ad79b7 100644 
 - - - a / test / unit / org / apache / cassandra / utils / FBUtilitiesTest . java 
 + + + b / test / unit / org / apache / cassandra / utils / FBUtilitiesTest . java 
 @ @ - 21 , 6 + 21 , 8 @ @ package org . apache . cassandra . utils ; 
 import static org . junit . Assert . assertArrayEquals ; 
 import static org . junit . Assert . assertEquals ; 
 
 + import java . io . IOException ; 
 + import java . nio . charset . CharacterCodingException ; 
 import java . util . concurrent . atomic . AtomicReference ; 
 
 import org . apache . cassandra . db . IClock ; 
 @ @ - 80 , 4 + 82 , 11 @ @ public class FBUtilitiesTest 
 FBUtilities . atomicSetMax ( atomicClock , new TimestampClock ( 3L ) ) ; 
 assert ( ( TimestampClock ) atomicClock . get ( ) ) . timestamp ( ) = = 9L ; 
 } 
 + 
 + @ Test ( expected = CharacterCodingException . class ) 
 + public void testDecode ( ) throws IOException 
 + { 
 + byte [ ] bytes = new byte [ ] { ( byte ) 0xff , ( byte ) 0xfe } ; 
 + FBUtilities . decodeToUTF8 ( bytes ) ; 
 + } 
 }
