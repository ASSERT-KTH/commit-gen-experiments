BLEU SCORE: 0.03283637368030199

TEST MSG: Add range tombstones to read repair digests
GENERATED MSG: merge from 1 . 0

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index ae7410e . . 495dab2 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 2 . 1 . 0 - beta2 <nl> + * Add range tombstones to read repair digests ( CASSANDRA - 6863 ) <nl> * Fix BTree . clear for large updates ( CASSANDRA - 6943 ) <nl> * Fail write instead of logging a warning when unable to append to CL <nl> ( CASSANDRA - 6764 ) <nl> diff - - git a / src / java / org / apache / cassandra / db / ColumnFamily . java b / src / java / org / apache / cassandra / db / ColumnFamily . java <nl> index da404b0 . . 4f85610 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ColumnFamily . java <nl> + + + b / src / java / org / apache / cassandra / db / ColumnFamily . java <nl> @ @ - 313 , 8 + 313 , 11 @ @ public abstract class ColumnFamily implements Iterable < Cell > , IRowCacheEntry <nl> } <nl> } <nl> <nl> + cfDiff . setDeletionInfo ( deletionInfo ( ) . diff ( cfComposite . deletionInfo ( ) ) ) ; <nl> + <nl> if ( ! cfDiff . isEmpty ( ) ) <nl> return cfDiff ; <nl> + <nl> return null ; <nl> } <nl> <nl> @ @ - 385 , 6 + 388 , 8 @ @ public abstract class ColumnFamily implements Iterable < Cell > , IRowCacheEntry <nl> { <nl> for ( Cell cell : this ) <nl> cell . updateDigest ( digest ) ; <nl> + if ( MessagingService . instance ( ) . areAllNodesAtLeast21 ( ) ) <nl> + deletionInfo ( ) . updateDigest ( digest ) ; <nl> } <nl> <nl> public static ColumnFamily diff ( ColumnFamily cf1 , ColumnFamily cf2 ) <nl> diff - - git a / src / java / org / apache / cassandra / db / DeletionInfo . java b / src / java / org / apache / cassandra / db / DeletionInfo . java <nl> index 8601bce . . a167b85 100644 <nl> - - - a / src / java / org / apache / cassandra / db / DeletionInfo . java <nl> + + + b / src / java / org / apache / cassandra / db / DeletionInfo . java <nl> @ @ - 19 , 7 + 19 , 9 @ @ package org . apache . cassandra . db ; <nl> <nl> import java . io . DataInput ; <nl> import java . io . IOException ; <nl> - import java . util . * ; <nl> + import java . security . MessageDigest ; <nl> + import java . util . Comparator ; <nl> + import java . util . Iterator ; <nl> <nl> import com . google . common . base . Objects ; <nl> import com . google . common . collect . Iterators ; <nl> @ @ - 29 , 6 + 31 , 7 @ @ import org . apache . cassandra . db . composites . CType ; <nl> import org . apache . cassandra . db . composites . Composite ; <nl> import org . apache . cassandra . io . IVersionedSerializer ; <nl> import org . apache . cassandra . io . util . DataOutputPlus ; <nl> + import org . apache . cassandra . utils . ByteBufferUtil ; <nl> import org . apache . cassandra . utils . ObjectSizes ; <nl> <nl> / * * <nl> @ @ - 168 , 6 + 171 , 35 @ @ public class DeletionInfo implements IMeasurableMemory <nl> } <nl> <nl> / * * <nl> + * Evaluates difference between this deletion info and superset for read repair <nl> + * <nl> + * @ return the difference between the two , or LIVE if no difference <nl> + * / <nl> + public DeletionInfo diff ( DeletionInfo superset ) <nl> + { <nl> + RangeTombstoneList rangeDiff = superset . ranges = = null | | superset . ranges . isEmpty ( ) <nl> + ? null <nl> + : ranges = = null ? superset . ranges : ranges . diff ( superset . ranges ) ; <nl> + <nl> + return topLevel . markedForDeleteAt ! = superset . topLevel . markedForDeleteAt | | rangeDiff ! = null <nl> + ? new DeletionInfo ( superset . topLevel , rangeDiff ) <nl> + : DeletionInfo . live ( ) ; <nl> + } <nl> + <nl> + <nl> + / * * <nl> + * Digests deletion info . Used to trigger read repair on mismatch . <nl> + * / <nl> + public void updateDigest ( MessageDigest digest ) <nl> + { <nl> + if ( topLevel . markedForDeleteAt ! = Long . MIN _ VALUE ) <nl> + digest . update ( ByteBufferUtil . bytes ( topLevel . markedForDeleteAt ) ) ; <nl> + <nl> + if ( ranges ! = null ) <nl> + ranges . updateDigest ( digest ) ; <nl> + } <nl> + <nl> + / * * <nl> * Returns true if { @ code purge } would remove the top - level tombstone or any of the range <nl> * tombstones , false otherwise . <nl> * @ param gcBefore timestamp ( in seconds ) before which tombstones should be purged <nl> diff - - git a / src / java / org / apache / cassandra / db / RangeTombstoneList . java b / src / java / org / apache / cassandra / db / RangeTombstoneList . java <nl> index dd0b9a6 . . b06c520 100644 <nl> - - - a / src / java / org / apache / cassandra / db / RangeTombstoneList . java <nl> + + + b / src / java / org / apache / cassandra / db / RangeTombstoneList . java <nl> @ @ - 19 , 12 + 19 , 16 @ @ package org . apache . cassandra . db ; <nl> <nl> import java . io . DataInput ; <nl> import java . io . IOException ; <nl> + import java . nio . ByteBuffer ; <nl> + import java . security . MessageDigest ; <nl> import java . util . Arrays ; <nl> import java . util . Comparator ; <nl> import java . util . Iterator ; <nl> <nl> import com . google . common . collect . AbstractIterator ; <nl> import com . google . common . collect . Iterators ; <nl> + import org . slf4j . Logger ; <nl> + import org . slf4j . LoggerFactory ; <nl> <nl> import org . apache . cassandra . cache . IMeasurableMemory ; <nl> import org . apache . cassandra . db . composites . CType ; <nl> @ @ - 32 , 10 + 36 , 7 @ @ import org . apache . cassandra . db . composites . Composite ; <nl> import org . apache . cassandra . io . IVersionedSerializer ; <nl> import org . apache . cassandra . io . util . DataOutputPlus ; <nl> import org . apache . cassandra . net . MessagingService ; <nl> - <nl> import org . apache . cassandra . utils . ObjectSizes ; <nl> - import org . slf4j . Logger ; <nl> - import org . slf4j . LoggerFactory ; <nl> <nl> / * * <nl> * Data structure holding the range tombstones of a ColumnFamily . <nl> @ @ - 384 , 6 + 385 , 64 @ @ public class RangeTombstoneList implements Iterable < RangeTombstone > , IMeasurable <nl> } <nl> } ; <nl> } <nl> + <nl> + / * * <nl> + * Evaluates a diff between superset ( known to be all merged tombstones ) and this list for read repair <nl> + * <nl> + * @ return null if there is no difference <nl> + * / <nl> + public RangeTombstoneList diff ( RangeTombstoneList superset ) <nl> + { <nl> + if ( isEmpty ( ) ) <nl> + return superset ; <nl> + <nl> + assert size < = superset . size ; <nl> + <nl> + RangeTombstoneList diff = null ; <nl> + <nl> + int j = 0 ; / / index to iterate through our own list <nl> + for ( int i = 0 ; i < superset . size ; i + + ) <nl> + { <nl> + boolean sameStart = j < size & & starts [ j ] . equals ( superset . starts [ i ] ) ; <nl> + / / don ' t care about local deletion time here . for RR it doesn ' t makes sense <nl> + if ( ! sameStart <nl> + | | ! ends [ j ] . equals ( superset . ends [ i ] ) <nl> + | | markedAts [ j ] ! = superset . markedAts [ i ] ) <nl> + { <nl> + if ( diff = = null ) <nl> + diff = new RangeTombstoneList ( comparator , Math . min ( 8 , superset . size - i ) ) ; <nl> + diff . add ( superset . starts [ i ] , superset . ends [ i ] , superset . markedAts [ i ] , superset . delTimes [ i ] ) ; <nl> + <nl> + if ( sameStart ) <nl> + j + + ; <nl> + } <nl> + else <nl> + { <nl> + j + + ; <nl> + } <nl> + } <nl> + <nl> + return diff ; <nl> + } <nl> + <nl> + / * * <nl> + * Calculates digest for triggering read repair on mismatch <nl> + * / <nl> + public void updateDigest ( MessageDigest digest ) <nl> + { <nl> + ByteBuffer longBuffer = ByteBuffer . allocate ( 8 ) ; <nl> + for ( int i = 0 ; i < size ; i + + ) <nl> + { <nl> + for ( int j = 0 ; j < starts [ i ] . size ( ) ; j + + ) <nl> + digest . update ( starts [ i ] . get ( j ) . duplicate ( ) ) ; <nl> + for ( int j = 0 ; j < ends [ i ] . size ( ) ; j + + ) <nl> + digest . update ( ends [ i ] . get ( j ) . duplicate ( ) ) ; <nl> + <nl> + longBuffer . putLong ( 0 , markedAts [ i ] ) ; <nl> + digest . update ( longBuffer . array ( ) , 0 , 8 ) ; <nl> + } <nl> + } <nl> + <nl> <nl> @ Override <nl> public boolean equals ( Object o ) <nl> @ @ - 393 , 7 + 452 , 7 @ @ public class RangeTombstoneList implements Iterable < RangeTombstone > , IMeasurable <nl> RangeTombstoneList that = ( RangeTombstoneList ) o ; <nl> if ( size ! = that . size ) <nl> return false ; <nl> - <nl> + <nl> for ( int i = 0 ; i < size ; i + + ) <nl> { <nl> if ( ! starts [ i ] . equals ( that . starts [ i ] ) ) <nl> @ @ - 779 , 4 + 838 , 5 @ @ public class RangeTombstoneList implements Iterable < RangeTombstone > , IMeasurable <nl> return false ; <nl> } <nl> } <nl> + <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / net / MessagingService . java b / src / java / org / apache / cassandra / net / MessagingService . java <nl> index 6d9a1b5 . . 4ef57d3 100644 <nl> - - - a / src / java / org / apache / cassandra / net / MessagingService . java <nl> + + + b / src / java / org / apache / cassandra / net / MessagingService . java <nl> @ @ - 84 , 6 + 84 , 8 @ @ public final class MessagingService implements MessagingServiceMBean <nl> * / <nl> public static final int PROTOCOL _ MAGIC = 0xCA552DFA ; <nl> <nl> + private boolean allNodesAtLeast21 ; <nl> + <nl> / * All verb handler identifiers * / <nl> public enum Verb <nl> { <nl> @ @ - 760 , 20 + 762 , 47 @ @ public final class MessagingService implements MessagingServiceMBean <nl> return packed > > > ( start + 1 ) - count & ~ ( - 1 < < count ) ; <nl> } <nl> <nl> + public boolean areAllNodesAtLeast21 ( ) <nl> + { <nl> + return allNodesAtLeast21 ; <nl> + } <nl> + <nl> / * * <nl> * @ return the last version associated with address , or @ param version if this is the first such version <nl> * / <nl> public int setVersion ( InetAddress endpoint , int version ) <nl> { <nl> logger . debug ( " Setting version { } for { } " , version , endpoint ) ; <nl> + if ( version < VERSION _ 21 ) <nl> + allNodesAtLeast21 = false ; <nl> Integer v = versions . put ( endpoint , version ) ; <nl> + <nl> + / / if the version was increased to 2 . 0 or later , see if all nodes are > = 2 . 0 now <nl> + if ( v ! = null & & v < VERSION _ 21 & & version > = VERSION _ 21 ) <nl> + refreshAllNodesAtLeast21 ( ) ; <nl> + <nl> return v = = null ? version : v ; <nl> } <nl> <nl> public void resetVersion ( InetAddress endpoint ) <nl> { <nl> logger . debug ( " Reseting version for { } " , endpoint ) ; <nl> - versions . remove ( endpoint ) ; <nl> + Integer removed = versions . remove ( endpoint ) ; <nl> + if ( removed ! = null & & removed < = VERSION _ 21 ) <nl> + refreshAllNodesAtLeast21 ( ) ; <nl> + } <nl> + <nl> + private void refreshAllNodesAtLeast21 ( ) <nl> + { <nl> + for ( Integer version : versions . values ( ) ) <nl> + { <nl> + if ( version < VERSION _ 21 ) <nl> + { <nl> + allNodesAtLeast21 = false ; <nl> + return ; <nl> + } <nl> + } <nl> + allNodesAtLeast21 = true ; <nl> } <nl> <nl> public int getVersion ( InetAddress endpoint ) <nl> @ @ - 807 , 6 + 836 , 7 @ @ public final class MessagingService implements MessagingServiceMBean <nl> return versions . containsKey ( endpoint ) ; <nl> } <nl> <nl> + <nl> public void incrementDroppedMessages ( Verb verb ) <nl> { <nl> assert DROPPABLE _ VERBS . contains ( verb ) : " Verb " + verb + " should not legally be dropped " ; <nl> diff - - git a / test / unit / org / apache / cassandra / Util . java b / test / unit / org / apache / cassandra / Util . java <nl> index b74f2c9 . . fe80009 100644 <nl> - - - a / test / unit / org / apache / cassandra / Util . java <nl> + + + b / test / unit / org / apache / cassandra / Util . java <nl> @ @ - 368 , 4 + 368 , 11 @ @ public class Util <nl> throw new RuntimeException ( e ) ; <nl> } <nl> } <nl> + <nl> + public static RangeTombstone tombstone ( String start , String finish , long timestamp , int localtime ) <nl> + { <nl> + Composite startName = CellNames . simpleDense ( ByteBufferUtil . bytes ( start ) ) ; <nl> + Composite endName = CellNames . simpleDense ( ByteBufferUtil . bytes ( finish ) ) ; <nl> + return new RangeTombstone ( startName , endName , timestamp , localtime ) ; <nl> + } <nl> } <nl> diff - - git a / test / unit / org / apache / cassandra / db / ColumnFamilyTest . java b / test / unit / org / apache / cassandra / db / ColumnFamilyTest . java <nl> index b791b03 . . 7f8da96 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / ColumnFamilyTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / ColumnFamilyTest . java <nl> @ @ - 22 , 12 + 22 , 13 @ @ import java . io . ByteArrayInputStream ; <nl> import java . io . DataInputStream ; <nl> import java . io . IOException ; <nl> import java . nio . ByteBuffer ; <nl> - import java . util . * ; <nl> + import java . util . TreeMap ; <nl> <nl> import com . google . common . collect . Iterables ; <nl> import org . junit . Test ; <nl> <nl> import org . apache . cassandra . SchemaLoader ; <nl> + import org . apache . cassandra . Util ; <nl> import org . apache . cassandra . io . sstable . ColumnStats ; <nl> import org . apache . cassandra . io . util . DataOutputBuffer ; <nl> import org . apache . cassandra . net . MessagingService ; <nl> @ @ - 35 , 6 + 36 , 7 @ @ import org . apache . cassandra . utils . ByteBufferUtil ; <nl> <nl> import static org . apache . cassandra . Util . column ; <nl> import static org . apache . cassandra . Util . cellname ; <nl> + import static org . apache . cassandra . Util . tombstone ; <nl> import static org . junit . Assert . assertEquals ; <nl> <nl> public class ColumnFamilyTest extends SchemaLoader <nl> @ @ - 105 , 6 + 107 , 48 @ @ public class ColumnFamilyTest extends SchemaLoader <nl> } <nl> <nl> @ Test <nl> + public void testDigest ( ) <nl> + { <nl> + ColumnFamily cf = ArrayBackedSortedColumns . factory . create ( " Keyspace1 " , " Standard1 " ) ; <nl> + ColumnFamily cf2 = ArrayBackedSortedColumns . factory . create ( " Keyspace1 " , " Standard1 " ) ; <nl> + <nl> + ByteBuffer digest = ColumnFamily . digest ( cf ) ; <nl> + <nl> + cf . addColumn ( column ( " col1 " , " " , 1 ) ) ; <nl> + cf2 . addColumn ( column ( " col1 " , " " , 1 ) ) ; <nl> + <nl> + assert ! digest . equals ( ColumnFamily . digest ( cf ) ) ; <nl> + <nl> + digest = ColumnFamily . digest ( cf ) ; <nl> + assert digest . equals ( ColumnFamily . digest ( cf2 ) ) ; <nl> + <nl> + cf . addColumn ( column ( " col2 " , " " , 2 ) ) ; <nl> + assert ! digest . equals ( ColumnFamily . digest ( cf ) ) ; <nl> + <nl> + digest = ColumnFamily . digest ( cf ) ; <nl> + cf . addColumn ( column ( " col1 " , " " , 3 ) ) ; <nl> + assert ! digest . equals ( ColumnFamily . digest ( cf ) ) ; <nl> + <nl> + digest = ColumnFamily . digest ( cf ) ; <nl> + cf . delete ( new DeletionTime ( 4 , 4 ) ) ; <nl> + assert ! digest . equals ( ColumnFamily . digest ( cf ) ) ; <nl> + <nl> + digest = ColumnFamily . digest ( cf ) ; <nl> + cf . delete ( tombstone ( " col1 " , " col11 " , 5 , 5 ) ) ; <nl> + assert ! digest . equals ( ColumnFamily . digest ( cf ) ) ; <nl> + <nl> + digest = ColumnFamily . digest ( cf ) ; <nl> + assert digest . equals ( ColumnFamily . digest ( cf ) ) ; <nl> + <nl> + cf . delete ( tombstone ( " col2 " , " col21 " , 5 , 5 ) ) ; <nl> + assert ! digest . equals ( ColumnFamily . digest ( cf ) ) ; <nl> + <nl> + digest = ColumnFamily . digest ( cf ) ; <nl> + cf . delete ( tombstone ( " col1 " , " col11 " , 5 , 5 ) ) ; / / this does not change RangeTombstoneLList <nl> + assert digest . equals ( ColumnFamily . digest ( cf ) ) ; <nl> + } <nl> + <nl> + @ Test <nl> public void testTimestamp ( ) <nl> { <nl> ColumnFamily cf = ArrayBackedSortedColumns . factory . create ( " Keyspace1 " , " Standard1 " ) ; <nl> diff - - git a / test / unit / org / apache / cassandra / db / RowTest . java b / test / unit / org / apache / cassandra / db / RowTest . java <nl> index f024c44 . . 3de7fdc 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / RowTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / RowTest . java <nl> @ @ - 20 , 19 + 20 , 19 @ @ package org . apache . cassandra . db ; <nl> <nl> import java . util . Arrays ; <nl> import java . util . concurrent . TimeUnit ; <nl> - import org . junit . Test ; <nl> <nl> import com . google . common . util . concurrent . Uninterruptibles ; <nl> + import org . junit . Test ; <nl> <nl> import org . apache . cassandra . SchemaLoader ; <nl> - import org . apache . cassandra . db . composites . * ; <nl> + import org . apache . cassandra . db . composites . CellNames ; <nl> import org . apache . cassandra . utils . ByteBufferUtil ; <nl> <nl> + import static org . apache . cassandra . Util . column ; <nl> + import static org . apache . cassandra . Util . tombstone ; <nl> import static org . junit . Assert . assertEquals ; <nl> import static org . junit . Assert . assertFalse ; <nl> <nl> - import static org . apache . cassandra . Util . column ; <nl> - <nl> public class RowTest extends SchemaLoader <nl> { <nl> @ Test <nl> @ @ - 48 , 6 + 48 , 38 @ @ public class RowTest extends SchemaLoader <nl> ColumnFamily cfDiff = cf1 . diff ( cf2 ) ; <nl> assertFalse ( cfDiff . hasColumns ( ) ) ; <nl> assertEquals ( cfDiff . deletionInfo ( ) , delInfo ) ; <nl> + <nl> + RangeTombstone tombstone1 = tombstone ( " 1 " , " 11 " , ( long ) 123 , 123 ) ; <nl> + RangeTombstone tombstone1 _ 2 = tombstone ( " 111 " , " 112 " , ( long ) 1230 , 123 ) ; <nl> + RangeTombstone tombstone2 _ 1 = tombstone ( " 2 " , " 22 " , ( long ) 123 , 123 ) ; <nl> + RangeTombstone tombstone2 _ 2 = tombstone ( " 2 " , " 24 " , ( long ) 123 , 123 ) ; <nl> + RangeTombstone tombstone3 _ 1 = tombstone ( " 3 " , " 31 " , ( long ) 123 , 123 ) ; <nl> + RangeTombstone tombstone3 _ 2 = tombstone ( " 3 " , " 31 " , ( long ) 1230 , 123 ) ; <nl> + RangeTombstone tombstone4 _ 1 = tombstone ( " 4 " , " 41 " , ( long ) 123 , 123 ) ; <nl> + RangeTombstone tombstone4 _ 2 = tombstone ( " 4 " , " 41 " , ( long ) 123 , 1230 ) ; <nl> + RangeTombstone tombstone5 _ 2 = tombstone ( " 5 " , " 51 " , ( long ) 123 , 1230 ) ; <nl> + cf1 . delete ( tombstone1 ) ; <nl> + cf1 . delete ( tombstone2 _ 1 ) ; <nl> + cf1 . delete ( tombstone3 _ 1 ) ; <nl> + cf1 . delete ( tombstone4 _ 1 ) ; <nl> + <nl> + cf2 . delete ( tombstone1 ) ; <nl> + cf2 . delete ( tombstone1 _ 2 ) ; <nl> + cf2 . delete ( tombstone2 _ 2 ) ; <nl> + cf2 . delete ( tombstone3 _ 2 ) ; <nl> + cf2 . delete ( tombstone4 _ 2 ) ; <nl> + cf2 . delete ( tombstone5 _ 2 ) ; <nl> + <nl> + cfDiff = cf1 . diff ( cf2 ) ; <nl> + assertEquals ( 0 , cfDiff . getColumnCount ( ) ) ; <nl> + <nl> + / / only tmbstones which differ in superset or have more recent timestamp to be in diff <nl> + delInfo . add ( tombstone1 _ 2 , cf1 . getComparator ( ) ) ; <nl> + delInfo . add ( tombstone2 _ 2 , cf1 . getComparator ( ) ) ; <nl> + delInfo . add ( tombstone3 _ 2 , cf1 . getComparator ( ) ) ; <nl> + delInfo . add ( tombstone5 _ 2 , cf1 . getComparator ( ) ) ; <nl> + <nl> + assertEquals ( delInfo , cfDiff . deletionInfo ( ) ) ; <nl> } <nl> <nl> @ Test
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index d518830 . . 52cc2c1 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 29 , 7 + 29 , 7 @ @ <nl> * add scheduler JMX metrics ( CASSANDRA - 2962 ) <nl> * add block level checksum for compressed data ( CASSANDRA - 1717 ) <nl> * make column family backed column map pluggable and introduce unsynchronized <nl> - ArrayList backed one to speedup reads ( CASSANDRA - 2843 ) <nl> + ArrayList backed one to speedup reads ( CASSANDRA - 2843 , 3165 ) <nl> * refactoring of the secondary index api ( CASSANDRA - 2982 ) <nl> * make CL > ONE reads wait for digest reconciliation before returning <nl> ( CASSANDRA - 2494 ) <nl> diff - - git a / src / java / org / apache / cassandra / db / ArrayBackedSortedColumns . java b / src / java / org / apache / cassandra / db / ArrayBackedSortedColumns . java <nl> index c316a85 . . 71c7213 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ArrayBackedSortedColumns . java <nl> + + + b / src / java / org / apache / cassandra / db / ArrayBackedSortedColumns . java <nl> @ @ - 67 , 6 + 67 , 11 @ @ public class ArrayBackedSortedColumns extends ArrayList < IColumn > implements ISor <nl> this . reversed = reversed ; <nl> } <nl> <nl> + public ISortedColumns . Factory getFactory ( ) <nl> + { <nl> + return factory ( ) ; <nl> + } <nl> + <nl> public AbstractType < ? > getComparator ( ) <nl> { <nl> return comparator ; <nl> diff - - git a / src / java / org / apache / cassandra / db / ColumnFamily . java b / src / java / org / apache / cassandra / db / ColumnFamily . java <nl> index 1239d1c . . 38bc0d7 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ColumnFamily . java <nl> + + + b / src / java / org / apache / cassandra / db / ColumnFamily . java <nl> @ @ - 81 , 14 + 81 , 19 @ @ public class ColumnFamily extends AbstractColumnContainer <nl> this . cfm = cfm ; <nl> } <nl> <nl> - public ColumnFamily cloneMeShallow ( ) <nl> + public ColumnFamily cloneMeShallow ( ISortedColumns . Factory factory ) <nl> { <nl> - ColumnFamily cf = ColumnFamily . create ( cfm ) ; <nl> + ColumnFamily cf = ColumnFamily . create ( cfm , factory ) ; <nl> / / since deletion info is immutable , aliasing it is fine <nl> cf . deletionInfo . set ( deletionInfo . get ( ) ) ; <nl> return cf ; <nl> } <nl> <nl> + public ColumnFamily cloneMeShallow ( ) <nl> + { <nl> + return cloneMeShallow ( columns . getFactory ( ) ) ; <nl> + } <nl> + <nl> public AbstractType getSubComparator ( ) <nl> { <nl> IColumnSerializer s = getColumnSerializer ( ) ; <nl> diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> index 0bfd1c5 . . 552d3e9 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> @ @ - 1162 , 8 + 1162 , 11 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean <nl> } <nl> } <nl> <nl> - / * * filter a cached row , which will not be modified by the filter , but may be modified by throwing out <nl> - * tombstones that are no longer relevant . * / <nl> + / * * <nl> + * Filter a cached row , which will not be modified by the filter , but may be modified by throwing out <nl> + * tombstones that are no longer relevant . <nl> + * The returned column family won ' t be thread safe . <nl> + * / <nl> ColumnFamily filterColumnFamily ( ColumnFamily cached , QueryFilter filter , int gcBefore ) <nl> { <nl> / / special case slicing the entire row : <nl> @ @ - 1184 , 7 + 1187 , 7 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean <nl> IColumn sc = cached . getColumn ( filter . path . superColumnName ) ; <nl> if ( sc = = null | | sliceFilter . count > = sc . getSubColumns ( ) . size ( ) ) <nl> { <nl> - ColumnFamily cf = cached . cloneMeShallow ( ) ; <nl> + ColumnFamily cf = cached . cloneMeShallow ( ArrayBackedSortedColumns . factory ( ) ) ; <nl> if ( sc ! = null ) <nl> cf . addColumn ( sc , HeapAllocator . instance ) ; <nl> return removeDeleted ( cf , gcBefore ) ; <nl> @ @ - 1203 , 7 + 1206 , 7 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean <nl> } <nl> <nl> IColumnIterator ci = filter . getMemtableColumnIterator ( cached , null , getComparator ( ) ) ; <nl> - ColumnFamily cf = ci . getColumnFamily ( ) . cloneMeShallow ( ) ; <nl> + ColumnFamily cf = ci . getColumnFamily ( ) . cloneMeShallow ( ArrayBackedSortedColumns . factory ( ) ) ; <nl> filter . collateColumns ( cf , Collections . singletonList ( ci ) , getComparator ( ) , gcBefore ) ; <nl> / / TODO this is necessary because when we collate supercolumns together , we don ' t check <nl> / / their subcolumns for relevance , so we need to do a second prune post facto here . <nl> diff - - git a / src / java / org / apache / cassandra / db / ISortedColumns . java b / src / java / org / apache / cassandra / db / ISortedColumns . java <nl> index 37f5a60 . . 624dec7 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ISortedColumns . java <nl> + + + b / src / java / org / apache / cassandra / db / ISortedColumns . java <nl> @ @ - 42 , 6 + 42 , 11 @ @ public interface ISortedColumns extends IIterableColumns <nl> public ISortedColumns cloneMe ( ) ; <nl> <nl> / * * <nl> + * Returns the factory used for this ISortedColumns implementation . <nl> + * / <nl> + public Factory getFactory ( ) ; <nl> + <nl> + / * * <nl> * Adds a column to this column map . <nl> * If a column with the same name is already present in the map , it will <nl> * be replaced by the newly added column . <nl> diff - - git a / src / java / org / apache / cassandra / db / ThreadSafeSortedColumns . java b / src / java / org / apache / cassandra / db / ThreadSafeSortedColumns . java <nl> index cd2488a . . 13a111a 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ThreadSafeSortedColumns . java <nl> + + + b / src / java / org / apache / cassandra / db / ThreadSafeSortedColumns . java <nl> @ @ - 62 , 6 + 62 , 11 @ @ public class ThreadSafeSortedColumns extends ConcurrentSkipListMap < ByteBuffer , I <nl> super ( columns ) ; <nl> } <nl> <nl> + public ISortedColumns . Factory getFactory ( ) <nl> + { <nl> + return factory ( ) ; <nl> + } <nl> + <nl> public ISortedColumns cloneMe ( ) <nl> { <nl> return new ThreadSafeSortedColumns ( this ) ; <nl> diff - - git a / src / java / org / apache / cassandra / db / TreeMapBackedSortedColumns . java b / src / java / org / apache / cassandra / db / TreeMapBackedSortedColumns . java <nl> index 34e83dc . . 6c3fc42 100644 <nl> - - - a / src / java / org / apache / cassandra / db / TreeMapBackedSortedColumns . java <nl> + + + b / src / java / org / apache / cassandra / db / TreeMapBackedSortedColumns . java <nl> @ @ - 62 , 6 + 62 , 11 @ @ public class TreeMapBackedSortedColumns extends TreeMap < ByteBuffer , IColumn > imp <nl> super ( columns ) ; <nl> } <nl> <nl> + public ISortedColumns . Factory getFactory ( ) <nl> + { <nl> + return factory ( ) ; <nl> + } <nl> + <nl> public ISortedColumns cloneMe ( ) <nl> { <nl> return new TreeMapBackedSortedColumns ( this ) ;

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index ae7410e . . 495dab2 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 2 . 1 . 0 - beta2 
 + * Add range tombstones to read repair digests ( CASSANDRA - 6863 ) 
 * Fix BTree . clear for large updates ( CASSANDRA - 6943 ) 
 * Fail write instead of logging a warning when unable to append to CL 
 ( CASSANDRA - 6764 ) 
 diff - - git a / src / java / org / apache / cassandra / db / ColumnFamily . java b / src / java / org / apache / cassandra / db / ColumnFamily . java 
 index da404b0 . . 4f85610 100644 
 - - - a / src / java / org / apache / cassandra / db / ColumnFamily . java 
 + + + b / src / java / org / apache / cassandra / db / ColumnFamily . java 
 @ @ - 313 , 8 + 313 , 11 @ @ public abstract class ColumnFamily implements Iterable < Cell > , IRowCacheEntry 
 } 
 } 
 
 + cfDiff . setDeletionInfo ( deletionInfo ( ) . diff ( cfComposite . deletionInfo ( ) ) ) ; 
 + 
 if ( ! cfDiff . isEmpty ( ) ) 
 return cfDiff ; 
 + 
 return null ; 
 } 
 
 @ @ - 385 , 6 + 388 , 8 @ @ public abstract class ColumnFamily implements Iterable < Cell > , IRowCacheEntry 
 { 
 for ( Cell cell : this ) 
 cell . updateDigest ( digest ) ; 
 + if ( MessagingService . instance ( ) . areAllNodesAtLeast21 ( ) ) 
 + deletionInfo ( ) . updateDigest ( digest ) ; 
 } 
 
 public static ColumnFamily diff ( ColumnFamily cf1 , ColumnFamily cf2 ) 
 diff - - git a / src / java / org / apache / cassandra / db / DeletionInfo . java b / src / java / org / apache / cassandra / db / DeletionInfo . java 
 index 8601bce . . a167b85 100644 
 - - - a / src / java / org / apache / cassandra / db / DeletionInfo . java 
 + + + b / src / java / org / apache / cassandra / db / DeletionInfo . java 
 @ @ - 19 , 7 + 19 , 9 @ @ package org . apache . cassandra . db ; 
 
 import java . io . DataInput ; 
 import java . io . IOException ; 
 - import java . util . * ; 
 + import java . security . MessageDigest ; 
 + import java . util . Comparator ; 
 + import java . util . Iterator ; 
 
 import com . google . common . base . Objects ; 
 import com . google . common . collect . Iterators ; 
 @ @ - 29 , 6 + 31 , 7 @ @ import org . apache . cassandra . db . composites . CType ; 
 import org . apache . cassandra . db . composites . Composite ; 
 import org . apache . cassandra . io . IVersionedSerializer ; 
 import org . apache . cassandra . io . util . DataOutputPlus ; 
 + import org . apache . cassandra . utils . ByteBufferUtil ; 
 import org . apache . cassandra . utils . ObjectSizes ; 
 
 / * * 
 @ @ - 168 , 6 + 171 , 35 @ @ public class DeletionInfo implements IMeasurableMemory 
 } 
 
 / * * 
 + * Evaluates difference between this deletion info and superset for read repair 
 + * 
 + * @ return the difference between the two , or LIVE if no difference 
 + * / 
 + public DeletionInfo diff ( DeletionInfo superset ) 
 + { 
 + RangeTombstoneList rangeDiff = superset . ranges = = null | | superset . ranges . isEmpty ( ) 
 + ? null 
 + : ranges = = null ? superset . ranges : ranges . diff ( superset . ranges ) ; 
 + 
 + return topLevel . markedForDeleteAt ! = superset . topLevel . markedForDeleteAt | | rangeDiff ! = null 
 + ? new DeletionInfo ( superset . topLevel , rangeDiff ) 
 + : DeletionInfo . live ( ) ; 
 + } 
 + 
 + 
 + / * * 
 + * Digests deletion info . Used to trigger read repair on mismatch . 
 + * / 
 + public void updateDigest ( MessageDigest digest ) 
 + { 
 + if ( topLevel . markedForDeleteAt ! = Long . MIN _ VALUE ) 
 + digest . update ( ByteBufferUtil . bytes ( topLevel . markedForDeleteAt ) ) ; 
 + 
 + if ( ranges ! = null ) 
 + ranges . updateDigest ( digest ) ; 
 + } 
 + 
 + / * * 
 * Returns true if { @ code purge } would remove the top - level tombstone or any of the range 
 * tombstones , false otherwise . 
 * @ param gcBefore timestamp ( in seconds ) before which tombstones should be purged 
 diff - - git a / src / java / org / apache / cassandra / db / RangeTombstoneList . java b / src / java / org / apache / cassandra / db / RangeTombstoneList . java 
 index dd0b9a6 . . b06c520 100644 
 - - - a / src / java / org / apache / cassandra / db / RangeTombstoneList . java 
 + + + b / src / java / org / apache / cassandra / db / RangeTombstoneList . java 
 @ @ - 19 , 12 + 19 , 16 @ @ package org . apache . cassandra . db ; 
 
 import java . io . DataInput ; 
 import java . io . IOException ; 
 + import java . nio . ByteBuffer ; 
 + import java . security . MessageDigest ; 
 import java . util . Arrays ; 
 import java . util . Comparator ; 
 import java . util . Iterator ; 
 
 import com . google . common . collect . AbstractIterator ; 
 import com . google . common . collect . Iterators ; 
 + import org . slf4j . Logger ; 
 + import org . slf4j . LoggerFactory ; 
 
 import org . apache . cassandra . cache . IMeasurableMemory ; 
 import org . apache . cassandra . db . composites . CType ; 
 @ @ - 32 , 10 + 36 , 7 @ @ import org . apache . cassandra . db . composites . Composite ; 
 import org . apache . cassandra . io . IVersionedSerializer ; 
 import org . apache . cassandra . io . util . DataOutputPlus ; 
 import org . apache . cassandra . net . MessagingService ; 
 - 
 import org . apache . cassandra . utils . ObjectSizes ; 
 - import org . slf4j . Logger ; 
 - import org . slf4j . LoggerFactory ; 
 
 / * * 
 * Data structure holding the range tombstones of a ColumnFamily . 
 @ @ - 384 , 6 + 385 , 64 @ @ public class RangeTombstoneList implements Iterable < RangeTombstone > , IMeasurable 
 } 
 } ; 
 } 
 + 
 + / * * 
 + * Evaluates a diff between superset ( known to be all merged tombstones ) and this list for read repair 
 + * 
 + * @ return null if there is no difference 
 + * / 
 + public RangeTombstoneList diff ( RangeTombstoneList superset ) 
 + { 
 + if ( isEmpty ( ) ) 
 + return superset ; 
 + 
 + assert size < = superset . size ; 
 + 
 + RangeTombstoneList diff = null ; 
 + 
 + int j = 0 ; / / index to iterate through our own list 
 + for ( int i = 0 ; i < superset . size ; i + + ) 
 + { 
 + boolean sameStart = j < size & & starts [ j ] . equals ( superset . starts [ i ] ) ; 
 + / / don ' t care about local deletion time here . for RR it doesn ' t makes sense 
 + if ( ! sameStart 
 + | | ! ends [ j ] . equals ( superset . ends [ i ] ) 
 + | | markedAts [ j ] ! = superset . markedAts [ i ] ) 
 + { 
 + if ( diff = = null ) 
 + diff = new RangeTombstoneList ( comparator , Math . min ( 8 , superset . size - i ) ) ; 
 + diff . add ( superset . starts [ i ] , superset . ends [ i ] , superset . markedAts [ i ] , superset . delTimes [ i ] ) ; 
 + 
 + if ( sameStart ) 
 + j + + ; 
 + } 
 + else 
 + { 
 + j + + ; 
 + } 
 + } 
 + 
 + return diff ; 
 + } 
 + 
 + / * * 
 + * Calculates digest for triggering read repair on mismatch 
 + * / 
 + public void updateDigest ( MessageDigest digest ) 
 + { 
 + ByteBuffer longBuffer = ByteBuffer . allocate ( 8 ) ; 
 + for ( int i = 0 ; i < size ; i + + ) 
 + { 
 + for ( int j = 0 ; j < starts [ i ] . size ( ) ; j + + ) 
 + digest . update ( starts [ i ] . get ( j ) . duplicate ( ) ) ; 
 + for ( int j = 0 ; j < ends [ i ] . size ( ) ; j + + ) 
 + digest . update ( ends [ i ] . get ( j ) . duplicate ( ) ) ; 
 + 
 + longBuffer . putLong ( 0 , markedAts [ i ] ) ; 
 + digest . update ( longBuffer . array ( ) , 0 , 8 ) ; 
 + } 
 + } 
 + 
 
 @ Override 
 public boolean equals ( Object o ) 
 @ @ - 393 , 7 + 452 , 7 @ @ public class RangeTombstoneList implements Iterable < RangeTombstone > , IMeasurable 
 RangeTombstoneList that = ( RangeTombstoneList ) o ; 
 if ( size ! = that . size ) 
 return false ; 
 - 
 + 
 for ( int i = 0 ; i < size ; i + + ) 
 { 
 if ( ! starts [ i ] . equals ( that . starts [ i ] ) ) 
 @ @ - 779 , 4 + 838 , 5 @ @ public class RangeTombstoneList implements Iterable < RangeTombstone > , IMeasurable 
 return false ; 
 } 
 } 
 + 
 } 
 diff - - git a / src / java / org / apache / cassandra / net / MessagingService . java b / src / java / org / apache / cassandra / net / MessagingService . java 
 index 6d9a1b5 . . 4ef57d3 100644 
 - - - a / src / java / org / apache / cassandra / net / MessagingService . java 
 + + + b / src / java / org / apache / cassandra / net / MessagingService . java 
 @ @ - 84 , 6 + 84 , 8 @ @ public final class MessagingService implements MessagingServiceMBean 
 * / 
 public static final int PROTOCOL _ MAGIC = 0xCA552DFA ; 
 
 + private boolean allNodesAtLeast21 ; 
 + 
 / * All verb handler identifiers * / 
 public enum Verb 
 { 
 @ @ - 760 , 20 + 762 , 47 @ @ public final class MessagingService implements MessagingServiceMBean 
 return packed > > > ( start + 1 ) - count & ~ ( - 1 < < count ) ; 
 } 
 
 + public boolean areAllNodesAtLeast21 ( ) 
 + { 
 + return allNodesAtLeast21 ; 
 + } 
 + 
 / * * 
 * @ return the last version associated with address , or @ param version if this is the first such version 
 * / 
 public int setVersion ( InetAddress endpoint , int version ) 
 { 
 logger . debug ( " Setting version { } for { } " , version , endpoint ) ; 
 + if ( version < VERSION _ 21 ) 
 + allNodesAtLeast21 = false ; 
 Integer v = versions . put ( endpoint , version ) ; 
 + 
 + / / if the version was increased to 2 . 0 or later , see if all nodes are > = 2 . 0 now 
 + if ( v ! = null & & v < VERSION _ 21 & & version > = VERSION _ 21 ) 
 + refreshAllNodesAtLeast21 ( ) ; 
 + 
 return v = = null ? version : v ; 
 } 
 
 public void resetVersion ( InetAddress endpoint ) 
 { 
 logger . debug ( " Reseting version for { } " , endpoint ) ; 
 - versions . remove ( endpoint ) ; 
 + Integer removed = versions . remove ( endpoint ) ; 
 + if ( removed ! = null & & removed < = VERSION _ 21 ) 
 + refreshAllNodesAtLeast21 ( ) ; 
 + } 
 + 
 + private void refreshAllNodesAtLeast21 ( ) 
 + { 
 + for ( Integer version : versions . values ( ) ) 
 + { 
 + if ( version < VERSION _ 21 ) 
 + { 
 + allNodesAtLeast21 = false ; 
 + return ; 
 + } 
 + } 
 + allNodesAtLeast21 = true ; 
 } 
 
 public int getVersion ( InetAddress endpoint ) 
 @ @ - 807 , 6 + 836 , 7 @ @ public final class MessagingService implements MessagingServiceMBean 
 return versions . containsKey ( endpoint ) ; 
 } 
 
 + 
 public void incrementDroppedMessages ( Verb verb ) 
 { 
 assert DROPPABLE _ VERBS . contains ( verb ) : " Verb " + verb + " should not legally be dropped " ; 
 diff - - git a / test / unit / org / apache / cassandra / Util . java b / test / unit / org / apache / cassandra / Util . java 
 index b74f2c9 . . fe80009 100644 
 - - - a / test / unit / org / apache / cassandra / Util . java 
 + + + b / test / unit / org / apache / cassandra / Util . java 
 @ @ - 368 , 4 + 368 , 11 @ @ public class Util 
 throw new RuntimeException ( e ) ; 
 } 
 } 
 + 
 + public static RangeTombstone tombstone ( String start , String finish , long timestamp , int localtime ) 
 + { 
 + Composite startName = CellNames . simpleDense ( ByteBufferUtil . bytes ( start ) ) ; 
 + Composite endName = CellNames . simpleDense ( ByteBufferUtil . bytes ( finish ) ) ; 
 + return new RangeTombstone ( startName , endName , timestamp , localtime ) ; 
 + } 
 } 
 diff - - git a / test / unit / org / apache / cassandra / db / ColumnFamilyTest . java b / test / unit / org / apache / cassandra / db / ColumnFamilyTest . java 
 index b791b03 . . 7f8da96 100644 
 - - - a / test / unit / org / apache / cassandra / db / ColumnFamilyTest . java 
 + + + b / test / unit / org / apache / cassandra / db / ColumnFamilyTest . java 
 @ @ - 22 , 12 + 22 , 13 @ @ import java . io . ByteArrayInputStream ; 
 import java . io . DataInputStream ; 
 import java . io . IOException ; 
 import java . nio . ByteBuffer ; 
 - import java . util . * ; 
 + import java . util . TreeMap ; 
 
 import com . google . common . collect . Iterables ; 
 import org . junit . Test ; 
 
 import org . apache . cassandra . SchemaLoader ; 
 + import org . apache . cassandra . Util ; 
 import org . apache . cassandra . io . sstable . ColumnStats ; 
 import org . apache . cassandra . io . util . DataOutputBuffer ; 
 import org . apache . cassandra . net . MessagingService ; 
 @ @ - 35 , 6 + 36 , 7 @ @ import org . apache . cassandra . utils . ByteBufferUtil ; 
 
 import static org . apache . cassandra . Util . column ; 
 import static org . apache . cassandra . Util . cellname ; 
 + import static org . apache . cassandra . Util . tombstone ; 
 import static org . junit . Assert . assertEquals ; 
 
 public class ColumnFamilyTest extends SchemaLoader 
 @ @ - 105 , 6 + 107 , 48 @ @ public class ColumnFamilyTest extends SchemaLoader 
 } 
 
 @ Test 
 + public void testDigest ( ) 
 + { 
 + ColumnFamily cf = ArrayBackedSortedColumns . factory . create ( " Keyspace1 " , " Standard1 " ) ; 
 + ColumnFamily cf2 = ArrayBackedSortedColumns . factory . create ( " Keyspace1 " , " Standard1 " ) ; 
 + 
 + ByteBuffer digest = ColumnFamily . digest ( cf ) ; 
 + 
 + cf . addColumn ( column ( " col1 " , " " , 1 ) ) ; 
 + cf2 . addColumn ( column ( " col1 " , " " , 1 ) ) ; 
 + 
 + assert ! digest . equals ( ColumnFamily . digest ( cf ) ) ; 
 + 
 + digest = ColumnFamily . digest ( cf ) ; 
 + assert digest . equals ( ColumnFamily . digest ( cf2 ) ) ; 
 + 
 + cf . addColumn ( column ( " col2 " , " " , 2 ) ) ; 
 + assert ! digest . equals ( ColumnFamily . digest ( cf ) ) ; 
 + 
 + digest = ColumnFamily . digest ( cf ) ; 
 + cf . addColumn ( column ( " col1 " , " " , 3 ) ) ; 
 + assert ! digest . equals ( ColumnFamily . digest ( cf ) ) ; 
 + 
 + digest = ColumnFamily . digest ( cf ) ; 
 + cf . delete ( new DeletionTime ( 4 , 4 ) ) ; 
 + assert ! digest . equals ( ColumnFamily . digest ( cf ) ) ; 
 + 
 + digest = ColumnFamily . digest ( cf ) ; 
 + cf . delete ( tombstone ( " col1 " , " col11 " , 5 , 5 ) ) ; 
 + assert ! digest . equals ( ColumnFamily . digest ( cf ) ) ; 
 + 
 + digest = ColumnFamily . digest ( cf ) ; 
 + assert digest . equals ( ColumnFamily . digest ( cf ) ) ; 
 + 
 + cf . delete ( tombstone ( " col2 " , " col21 " , 5 , 5 ) ) ; 
 + assert ! digest . equals ( ColumnFamily . digest ( cf ) ) ; 
 + 
 + digest = ColumnFamily . digest ( cf ) ; 
 + cf . delete ( tombstone ( " col1 " , " col11 " , 5 , 5 ) ) ; / / this does not change RangeTombstoneLList 
 + assert digest . equals ( ColumnFamily . digest ( cf ) ) ; 
 + } 
 + 
 + @ Test 
 public void testTimestamp ( ) 
 { 
 ColumnFamily cf = ArrayBackedSortedColumns . factory . create ( " Keyspace1 " , " Standard1 " ) ; 
 diff - - git a / test / unit / org / apache / cassandra / db / RowTest . java b / test / unit / org / apache / cassandra / db / RowTest . java 
 index f024c44 . . 3de7fdc 100644 
 - - - a / test / unit / org / apache / cassandra / db / RowTest . java 
 + + + b / test / unit / org / apache / cassandra / db / RowTest . java 
 @ @ - 20 , 19 + 20 , 19 @ @ package org . apache . cassandra . db ; 
 
 import java . util . Arrays ; 
 import java . util . concurrent . TimeUnit ; 
 - import org . junit . Test ; 
 
 import com . google . common . util . concurrent . Uninterruptibles ; 
 + import org . junit . Test ; 
 
 import org . apache . cassandra . SchemaLoader ; 
 - import org . apache . cassandra . db . composites . * ; 
 + import org . apache . cassandra . db . composites . CellNames ; 
 import org . apache . cassandra . utils . ByteBufferUtil ; 
 
 + import static org . apache . cassandra . Util . column ; 
 + import static org . apache . cassandra . Util . tombstone ; 
 import static org . junit . Assert . assertEquals ; 
 import static org . junit . Assert . assertFalse ; 
 
 - import static org . apache . cassandra . Util . column ; 
 - 
 public class RowTest extends SchemaLoader 
 { 
 @ Test 
 @ @ - 48 , 6 + 48 , 38 @ @ public class RowTest extends SchemaLoader 
 ColumnFamily cfDiff = cf1 . diff ( cf2 ) ; 
 assertFalse ( cfDiff . hasColumns ( ) ) ; 
 assertEquals ( cfDiff . deletionInfo ( ) , delInfo ) ; 
 + 
 + RangeTombstone tombstone1 = tombstone ( " 1 " , " 11 " , ( long ) 123 , 123 ) ; 
 + RangeTombstone tombstone1 _ 2 = tombstone ( " 111 " , " 112 " , ( long ) 1230 , 123 ) ; 
 + RangeTombstone tombstone2 _ 1 = tombstone ( " 2 " , " 22 " , ( long ) 123 , 123 ) ; 
 + RangeTombstone tombstone2 _ 2 = tombstone ( " 2 " , " 24 " , ( long ) 123 , 123 ) ; 
 + RangeTombstone tombstone3 _ 1 = tombstone ( " 3 " , " 31 " , ( long ) 123 , 123 ) ; 
 + RangeTombstone tombstone3 _ 2 = tombstone ( " 3 " , " 31 " , ( long ) 1230 , 123 ) ; 
 + RangeTombstone tombstone4 _ 1 = tombstone ( " 4 " , " 41 " , ( long ) 123 , 123 ) ; 
 + RangeTombstone tombstone4 _ 2 = tombstone ( " 4 " , " 41 " , ( long ) 123 , 1230 ) ; 
 + RangeTombstone tombstone5 _ 2 = tombstone ( " 5 " , " 51 " , ( long ) 123 , 1230 ) ; 
 + cf1 . delete ( tombstone1 ) ; 
 + cf1 . delete ( tombstone2 _ 1 ) ; 
 + cf1 . delete ( tombstone3 _ 1 ) ; 
 + cf1 . delete ( tombstone4 _ 1 ) ; 
 + 
 + cf2 . delete ( tombstone1 ) ; 
 + cf2 . delete ( tombstone1 _ 2 ) ; 
 + cf2 . delete ( tombstone2 _ 2 ) ; 
 + cf2 . delete ( tombstone3 _ 2 ) ; 
 + cf2 . delete ( tombstone4 _ 2 ) ; 
 + cf2 . delete ( tombstone5 _ 2 ) ; 
 + 
 + cfDiff = cf1 . diff ( cf2 ) ; 
 + assertEquals ( 0 , cfDiff . getColumnCount ( ) ) ; 
 + 
 + / / only tmbstones which differ in superset or have more recent timestamp to be in diff 
 + delInfo . add ( tombstone1 _ 2 , cf1 . getComparator ( ) ) ; 
 + delInfo . add ( tombstone2 _ 2 , cf1 . getComparator ( ) ) ; 
 + delInfo . add ( tombstone3 _ 2 , cf1 . getComparator ( ) ) ; 
 + delInfo . add ( tombstone5 _ 2 , cf1 . getComparator ( ) ) ; 
 + 
 + assertEquals ( delInfo , cfDiff . deletionInfo ( ) ) ; 
 } 
 
 @ Test

NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index d518830 . . 52cc2c1 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 29 , 7 + 29 , 7 @ @ 
 * add scheduler JMX metrics ( CASSANDRA - 2962 ) 
 * add block level checksum for compressed data ( CASSANDRA - 1717 ) 
 * make column family backed column map pluggable and introduce unsynchronized 
 - ArrayList backed one to speedup reads ( CASSANDRA - 2843 ) 
 + ArrayList backed one to speedup reads ( CASSANDRA - 2843 , 3165 ) 
 * refactoring of the secondary index api ( CASSANDRA - 2982 ) 
 * make CL > ONE reads wait for digest reconciliation before returning 
 ( CASSANDRA - 2494 ) 
 diff - - git a / src / java / org / apache / cassandra / db / ArrayBackedSortedColumns . java b / src / java / org / apache / cassandra / db / ArrayBackedSortedColumns . java 
 index c316a85 . . 71c7213 100644 
 - - - a / src / java / org / apache / cassandra / db / ArrayBackedSortedColumns . java 
 + + + b / src / java / org / apache / cassandra / db / ArrayBackedSortedColumns . java 
 @ @ - 67 , 6 + 67 , 11 @ @ public class ArrayBackedSortedColumns extends ArrayList < IColumn > implements ISor 
 this . reversed = reversed ; 
 } 
 
 + public ISortedColumns . Factory getFactory ( ) 
 + { 
 + return factory ( ) ; 
 + } 
 + 
 public AbstractType < ? > getComparator ( ) 
 { 
 return comparator ; 
 diff - - git a / src / java / org / apache / cassandra / db / ColumnFamily . java b / src / java / org / apache / cassandra / db / ColumnFamily . java 
 index 1239d1c . . 38bc0d7 100644 
 - - - a / src / java / org / apache / cassandra / db / ColumnFamily . java 
 + + + b / src / java / org / apache / cassandra / db / ColumnFamily . java 
 @ @ - 81 , 14 + 81 , 19 @ @ public class ColumnFamily extends AbstractColumnContainer 
 this . cfm = cfm ; 
 } 
 
 - public ColumnFamily cloneMeShallow ( ) 
 + public ColumnFamily cloneMeShallow ( ISortedColumns . Factory factory ) 
 { 
 - ColumnFamily cf = ColumnFamily . create ( cfm ) ; 
 + ColumnFamily cf = ColumnFamily . create ( cfm , factory ) ; 
 / / since deletion info is immutable , aliasing it is fine 
 cf . deletionInfo . set ( deletionInfo . get ( ) ) ; 
 return cf ; 
 } 
 
 + public ColumnFamily cloneMeShallow ( ) 
 + { 
 + return cloneMeShallow ( columns . getFactory ( ) ) ; 
 + } 
 + 
 public AbstractType getSubComparator ( ) 
 { 
 IColumnSerializer s = getColumnSerializer ( ) ; 
 diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 index 0bfd1c5 . . 552d3e9 100644 
 - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 @ @ - 1162 , 8 + 1162 , 11 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean 
 } 
 } 
 
 - / * * filter a cached row , which will not be modified by the filter , but may be modified by throwing out 
 - * tombstones that are no longer relevant . * / 
 + / * * 
 + * Filter a cached row , which will not be modified by the filter , but may be modified by throwing out 
 + * tombstones that are no longer relevant . 
 + * The returned column family won ' t be thread safe . 
 + * / 
 ColumnFamily filterColumnFamily ( ColumnFamily cached , QueryFilter filter , int gcBefore ) 
 { 
 / / special case slicing the entire row : 
 @ @ - 1184 , 7 + 1187 , 7 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean 
 IColumn sc = cached . getColumn ( filter . path . superColumnName ) ; 
 if ( sc = = null | | sliceFilter . count > = sc . getSubColumns ( ) . size ( ) ) 
 { 
 - ColumnFamily cf = cached . cloneMeShallow ( ) ; 
 + ColumnFamily cf = cached . cloneMeShallow ( ArrayBackedSortedColumns . factory ( ) ) ; 
 if ( sc ! = null ) 
 cf . addColumn ( sc , HeapAllocator . instance ) ; 
 return removeDeleted ( cf , gcBefore ) ; 
 @ @ - 1203 , 7 + 1206 , 7 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean 
 } 
 
 IColumnIterator ci = filter . getMemtableColumnIterator ( cached , null , getComparator ( ) ) ; 
 - ColumnFamily cf = ci . getColumnFamily ( ) . cloneMeShallow ( ) ; 
 + ColumnFamily cf = ci . getColumnFamily ( ) . cloneMeShallow ( ArrayBackedSortedColumns . factory ( ) ) ; 
 filter . collateColumns ( cf , Collections . singletonList ( ci ) , getComparator ( ) , gcBefore ) ; 
 / / TODO this is necessary because when we collate supercolumns together , we don ' t check 
 / / their subcolumns for relevance , so we need to do a second prune post facto here . 
 diff - - git a / src / java / org / apache / cassandra / db / ISortedColumns . java b / src / java / org / apache / cassandra / db / ISortedColumns . java 
 index 37f5a60 . . 624dec7 100644 
 - - - a / src / java / org / apache / cassandra / db / ISortedColumns . java 
 + + + b / src / java / org / apache / cassandra / db / ISortedColumns . java 
 @ @ - 42 , 6 + 42 , 11 @ @ public interface ISortedColumns extends IIterableColumns 
 public ISortedColumns cloneMe ( ) ; 
 
 / * * 
 + * Returns the factory used for this ISortedColumns implementation . 
 + * / 
 + public Factory getFactory ( ) ; 
 + 
 + / * * 
 * Adds a column to this column map . 
 * If a column with the same name is already present in the map , it will 
 * be replaced by the newly added column . 
 diff - - git a / src / java / org / apache / cassandra / db / ThreadSafeSortedColumns . java b / src / java / org / apache / cassandra / db / ThreadSafeSortedColumns . java 
 index cd2488a . . 13a111a 100644 
 - - - a / src / java / org / apache / cassandra / db / ThreadSafeSortedColumns . java 
 + + + b / src / java / org / apache / cassandra / db / ThreadSafeSortedColumns . java 
 @ @ - 62 , 6 + 62 , 11 @ @ public class ThreadSafeSortedColumns extends ConcurrentSkipListMap < ByteBuffer , I 
 super ( columns ) ; 
 } 
 
 + public ISortedColumns . Factory getFactory ( ) 
 + { 
 + return factory ( ) ; 
 + } 
 + 
 public ISortedColumns cloneMe ( ) 
 { 
 return new ThreadSafeSortedColumns ( this ) ; 
 diff - - git a / src / java / org / apache / cassandra / db / TreeMapBackedSortedColumns . java b / src / java / org / apache / cassandra / db / TreeMapBackedSortedColumns . java 
 index 34e83dc . . 6c3fc42 100644 
 - - - a / src / java / org / apache / cassandra / db / TreeMapBackedSortedColumns . java 
 + + + b / src / java / org / apache / cassandra / db / TreeMapBackedSortedColumns . java 
 @ @ - 62 , 6 + 62 , 11 @ @ public class TreeMapBackedSortedColumns extends TreeMap < ByteBuffer , IColumn > imp 
 super ( columns ) ; 
 } 
 
 + public ISortedColumns . Factory getFactory ( ) 
 + { 
 + return factory ( ) ; 
 + } 
 + 
 public ISortedColumns cloneMe ( ) 
 { 
 return new TreeMapBackedSortedColumns ( this ) ;
