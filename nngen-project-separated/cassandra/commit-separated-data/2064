BLEU SCORE: 0.056697911109760024

TEST MSG: Fix requests with skipMetadata = false returning no metadata
GENERATED MSG: Fix broken paging state with prepared statement

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 417e8c1 . . 688dc32 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 6 @ @ <nl> 2 . 1 . 1 <nl> + * Fix EXECUTE request with skipMetadata = false returning no metadata <nl> + ( CASSANDRA - 8054 ) <nl> * Allow concurrent use of CQLBulkOutputFormat ( CASSANDRA - 7776 ) <nl> * Shutdown JVM on OOM ( CASSANDRA - 7507 ) <nl> * Upgrade netty version and enable epoll event loop ( CASSANDRA - 7761 ) <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / ResultSet . java b / src / java / org / apache / cassandra / cql3 / ResultSet . java <nl> index 25635fa . . 3928060 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / ResultSet . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / ResultSet . java <nl> @ @ - 92 , 16 + 92 , 6 @ @ public class ResultSet <nl> } <nl> } <nl> <nl> - public ResultSet withPagingState ( PagingState state ) <nl> - { <nl> - if ( state = = null ) <nl> - return this ; <nl> - <nl> - / / The metadata is shared by all execution of a given statement . So if there is a paging state <nl> - / / we need to copy the metadata <nl> - return new ResultSet ( metadata . withPagingState ( state ) , rows ) ; <nl> - } <nl> - <nl> public ResultSet makeCountResult ( ColumnIdentifier alias ) <nl> { <nl> assert metadata . names ! = null ; <nl> @ @ - 250 , 14 + 240 , 14 @ @ public class ResultSet <nl> <nl> public static final Metadata EMPTY = new Metadata ( EnumSet . of ( Flag . NO _ METADATA ) , null , 0 , null ) ; <nl> <nl> - public final EnumSet < Flag > flags ; <nl> + private final EnumSet < Flag > flags ; <nl> / / Please note that columnCount can actually be smaller than names , even if names is not null . This is <nl> / / used to include columns in the resultSet that we need to do post - query re - orderings <nl> / / ( SelectStatement . orderResults ) but that shouldn ' t be sent to the user as they haven ' t been requested <nl> / / ( CASSANDRA - 4911 ) . So the serialization code will exclude any columns in name whose index is > = columnCount . <nl> public final List < ColumnSpecification > names ; <nl> - public final int columnCount ; <nl> - public final PagingState pagingState ; <nl> + private final int columnCount ; <nl> + private PagingState pagingState ; <nl> <nl> public Metadata ( List < ColumnSpecification > names ) <nl> { <nl> @ @ - 274 , 6 + 264 , 11 @ @ public class ResultSet <nl> this . pagingState = pagingState ; <nl> } <nl> <nl> + public Metadata copy ( ) <nl> + { <nl> + return new Metadata ( flags , names , columnCount , pagingState ) ; <nl> + } <nl> + <nl> / / The maximum number of values that the ResultSet can hold . This can be bigger than columnCount due to CASSANDRA - 4911 <nl> public int valueCount ( ) <nl> { <nl> @ @ - 305 , 14 + 300 , 13 @ @ public class ResultSet <nl> return true ; <nl> } <nl> <nl> - public Metadata withPagingState ( PagingState pagingState ) <nl> + public void setHasMorePages ( PagingState pagingState ) <nl> { <nl> if ( pagingState = = null ) <nl> - return this ; <nl> + return ; <nl> <nl> - EnumSet < Flag > newFlags = EnumSet . copyOf ( flags ) ; <nl> - newFlags . add ( Flag . HAS _ MORE _ PAGES ) ; <nl> - return new Metadata ( newFlags , names , columnCount , pagingState ) ; <nl> + flags . add ( Flag . HAS _ MORE _ PAGES ) ; <nl> + this . pagingState = pagingState ; <nl> } <nl> <nl> public void setSkipMetadata ( ) <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java b / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java <nl> index ccda356 . . a8c9d44 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java <nl> @ @ - 226 , 7 + 226 , 10 @ @ public class SelectStatement implements CQLStatement , MeasurableForPreparedCache <nl> List < Row > page = pager . fetchPage ( pageSize ) ; <nl> ResultMessage . Rows msg = processResults ( page , options , limit , now ) ; <nl> <nl> - return pager . isExhausted ( ) ? msg : msg . withPagingState ( pager . state ( ) ) ; <nl> + if ( ! pager . isExhausted ( ) ) <nl> + msg . result . metadata . setHasMorePages ( pager . state ( ) ) ; <nl> + <nl> + return msg ; <nl> } <nl> } <nl> <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / Selection . java b / src / java / org / apache / cassandra / cql3 / statements / Selection . java <nl> index 0f0cb62 . . 7893b4d 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / Selection . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / Selection . java <nl> @ @ - 287 , 7 + 287 , 7 @ @ public abstract class Selection <nl> <nl> private ResultSetBuilder ( long now ) <nl> { <nl> - this . resultSet = new ResultSet ( getResultMetadata ( ) , new ArrayList < List < ByteBuffer > > ( ) ) ; <nl> + this . resultSet = new ResultSet ( getResultMetadata ( ) . copy ( ) , new ArrayList < List < ByteBuffer > > ( ) ) ; <nl> this . timestamps = collectTimestamps ? new long [ columns . size ( ) ] : null ; <nl> this . ttls = collectTTLs ? new int [ columns . size ( ) ] : null ; <nl> this . now = now ; <nl> diff - - git a / src / java / org / apache / cassandra / transport / messages / ResultMessage . java b / src / java / org / apache / cassandra / transport / messages / ResultMessage . java <nl> index 935a139 . . 723beed 100644 <nl> - - - a / src / java / org / apache / cassandra / transport / messages / ResultMessage . java <nl> + + + b / src / java / org / apache / cassandra / transport / messages / ResultMessage . java <nl> @ @ - 220 , 11 + 220 , 6 @ @ public abstract class ResultMessage extends Message . Response <nl> this . result = result ; <nl> } <nl> <nl> - public Rows withPagingState ( PagingState state ) <nl> - { <nl> - return new Rows ( result . withPagingState ( state ) ) ; <nl> - } <nl> - <nl> public CqlResult toThriftResult ( ) <nl> { <nl> return result . toThriftResult ( ) ;
NEAREST DIFF (one line): ELIMINATEDSENTENCE

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 417e8c1 . . 688dc32 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 6 @ @ 
 2 . 1 . 1 
 + * Fix EXECUTE request with skipMetadata = false returning no metadata 
 + ( CASSANDRA - 8054 ) 
 * Allow concurrent use of CQLBulkOutputFormat ( CASSANDRA - 7776 ) 
 * Shutdown JVM on OOM ( CASSANDRA - 7507 ) 
 * Upgrade netty version and enable epoll event loop ( CASSANDRA - 7761 ) 
 diff - - git a / src / java / org / apache / cassandra / cql3 / ResultSet . java b / src / java / org / apache / cassandra / cql3 / ResultSet . java 
 index 25635fa . . 3928060 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / ResultSet . java 
 + + + b / src / java / org / apache / cassandra / cql3 / ResultSet . java 
 @ @ - 92 , 16 + 92 , 6 @ @ public class ResultSet 
 } 
 } 
 
 - public ResultSet withPagingState ( PagingState state ) 
 - { 
 - if ( state = = null ) 
 - return this ; 
 - 
 - / / The metadata is shared by all execution of a given statement . So if there is a paging state 
 - / / we need to copy the metadata 
 - return new ResultSet ( metadata . withPagingState ( state ) , rows ) ; 
 - } 
 - 
 public ResultSet makeCountResult ( ColumnIdentifier alias ) 
 { 
 assert metadata . names ! = null ; 
 @ @ - 250 , 14 + 240 , 14 @ @ public class ResultSet 
 
 public static final Metadata EMPTY = new Metadata ( EnumSet . of ( Flag . NO _ METADATA ) , null , 0 , null ) ; 
 
 - public final EnumSet < Flag > flags ; 
 + private final EnumSet < Flag > flags ; 
 / / Please note that columnCount can actually be smaller than names , even if names is not null . This is 
 / / used to include columns in the resultSet that we need to do post - query re - orderings 
 / / ( SelectStatement . orderResults ) but that shouldn ' t be sent to the user as they haven ' t been requested 
 / / ( CASSANDRA - 4911 ) . So the serialization code will exclude any columns in name whose index is > = columnCount . 
 public final List < ColumnSpecification > names ; 
 - public final int columnCount ; 
 - public final PagingState pagingState ; 
 + private final int columnCount ; 
 + private PagingState pagingState ; 
 
 public Metadata ( List < ColumnSpecification > names ) 
 { 
 @ @ - 274 , 6 + 264 , 11 @ @ public class ResultSet 
 this . pagingState = pagingState ; 
 } 
 
 + public Metadata copy ( ) 
 + { 
 + return new Metadata ( flags , names , columnCount , pagingState ) ; 
 + } 
 + 
 / / The maximum number of values that the ResultSet can hold . This can be bigger than columnCount due to CASSANDRA - 4911 
 public int valueCount ( ) 
 { 
 @ @ - 305 , 14 + 300 , 13 @ @ public class ResultSet 
 return true ; 
 } 
 
 - public Metadata withPagingState ( PagingState pagingState ) 
 + public void setHasMorePages ( PagingState pagingState ) 
 { 
 if ( pagingState = = null ) 
 - return this ; 
 + return ; 
 
 - EnumSet < Flag > newFlags = EnumSet . copyOf ( flags ) ; 
 - newFlags . add ( Flag . HAS _ MORE _ PAGES ) ; 
 - return new Metadata ( newFlags , names , columnCount , pagingState ) ; 
 + flags . add ( Flag . HAS _ MORE _ PAGES ) ; 
 + this . pagingState = pagingState ; 
 } 
 
 public void setSkipMetadata ( ) 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java b / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java 
 index ccda356 . . a8c9d44 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java 
 @ @ - 226 , 7 + 226 , 10 @ @ public class SelectStatement implements CQLStatement , MeasurableForPreparedCache 
 List < Row > page = pager . fetchPage ( pageSize ) ; 
 ResultMessage . Rows msg = processResults ( page , options , limit , now ) ; 
 
 - return pager . isExhausted ( ) ? msg : msg . withPagingState ( pager . state ( ) ) ; 
 + if ( ! pager . isExhausted ( ) ) 
 + msg . result . metadata . setHasMorePages ( pager . state ( ) ) ; 
 + 
 + return msg ; 
 } 
 } 
 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / Selection . java b / src / java / org / apache / cassandra / cql3 / statements / Selection . java 
 index 0f0cb62 . . 7893b4d 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / Selection . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / Selection . java 
 @ @ - 287 , 7 + 287 , 7 @ @ public abstract class Selection 
 
 private ResultSetBuilder ( long now ) 
 { 
 - this . resultSet = new ResultSet ( getResultMetadata ( ) , new ArrayList < List < ByteBuffer > > ( ) ) ; 
 + this . resultSet = new ResultSet ( getResultMetadata ( ) . copy ( ) , new ArrayList < List < ByteBuffer > > ( ) ) ; 
 this . timestamps = collectTimestamps ? new long [ columns . size ( ) ] : null ; 
 this . ttls = collectTTLs ? new int [ columns . size ( ) ] : null ; 
 this . now = now ; 
 diff - - git a / src / java / org / apache / cassandra / transport / messages / ResultMessage . java b / src / java / org / apache / cassandra / transport / messages / ResultMessage . java 
 index 935a139 . . 723beed 100644 
 - - - a / src / java / org / apache / cassandra / transport / messages / ResultMessage . java 
 + + + b / src / java / org / apache / cassandra / transport / messages / ResultMessage . java 
 @ @ - 220 , 11 + 220 , 6 @ @ public abstract class ResultMessage extends Message . Response 
 this . result = result ; 
 } 
 
 - public Rows withPagingState ( PagingState state ) 
 - { 
 - return new Rows ( result . withPagingState ( state ) ) ; 
 - } 
 - 
 public CqlResult toThriftResult ( ) 
 { 
 return result . toThriftResult ( ) ;

NEAREST DIFF:
ELIMINATEDSENTENCE
