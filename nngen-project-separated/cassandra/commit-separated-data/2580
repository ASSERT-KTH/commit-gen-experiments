BLEU SCORE: 0.020980574531482755

TEST MSG: Continue with assassinate even if the endpoint vanishes during the
GENERATED MSG: Correctly expire gossip states for edge cases .

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index a9a93a4 . . b3a794f 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 6 + 1 , 7 @ @ <nl> 1 . 2 . 17 <nl> * Fix BatchlogManager # deleteBatch ( ) use of millisecond timsestamps <nl> ( CASSANDRA - 6822 ) <nl> + * Continue assassinating even if the endpoint vanishes ( CASSANDRA - 6787 ) <nl> <nl> <nl> 1 . 2 . 16 <nl> diff - - git a / src / java / org / apache / cassandra / gms / Gossiper . java b / src / java / org / apache / cassandra / gms / Gossiper . java <nl> index b51bbd3 . . 5d2780e 100644 <nl> - - - a / src / java / org / apache / cassandra / gms / Gossiper . java <nl> + + + b / src / java / org / apache / cassandra / gms / Gossiper . java <nl> @ @ - 483 , 8 + 483 , 10 @ @ public class Gossiper implements IFailureDetectionEventListener , GossiperMBean <nl> throw new AssertionError ( e ) ; <nl> } <nl> / / make sure it did not change <nl> - epState = endpointStateMap . get ( endpoint ) ; <nl> - if ( epState . getHeartBeatState ( ) . getGeneration ( ) ! = generation ) <nl> + EndpointState newState = endpointStateMap . get ( endpoint ) ; <nl> + if ( newState = = null ) <nl> + logger . warn ( " Endpoint { } disappeared while trying to assassinate , continuing anyway " , endpoint ) ; <nl> + else if ( newState . getHeartBeatState ( ) . getGeneration ( ) ! = generation ) <nl> throw new RuntimeException ( " Endpoint " + endpoint + " generation changed while trying to remove it " ) ; <nl> epState . updateTimestamp ( ) ; / / make sure we don ' t evict it too soon <nl> epState . getHeartBeatState ( ) . forceNewerGenerationUnsafe ( ) ;
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 6b3a705 . . e0e8079 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 7 , 6 + 7 , 7 @ @ <nl> * configure populate _ io _ cache _ on _ flush per - CF ( CASSANDRA - 4694 ) <nl> * allow configuration of internode socket buffer ( CASSANDRA - 3378 ) <nl> * Make sstable directory picking blacklist - aware again ( CASSANDRA - 5193 ) <nl> + * Correctly expire gossip states for edge cases ( CASSANDRA - 5216 ) <nl> <nl> 1 . 2 . 1 <nl> * stream undelivered hints on decommission ( CASSANDRA - 5128 ) <nl> diff - - git a / src / java / org / apache / cassandra / gms / Gossiper . java b / src / java / org / apache / cassandra / gms / Gossiper . java <nl> index 9ee2f61 . . c9d0d51 100644 <nl> - - - a / src / java / org / apache / cassandra / gms / Gossiper . java <nl> + + + b / src / java / org / apache / cassandra / gms / Gossiper . java <nl> @ @ - 234 , 6 + 234 , 8 @ @ public class Gossiper implements IFailureDetectionEventListener , GossiperMBean <nl> { <nl> markDead ( endpoint , epState ) ; <nl> } <nl> + else <nl> + epState . markDead ( ) ; <nl> } <nl> <nl> / * * <nl> @ @ - 389 , 8 + 391 , 10 @ @ public class Gossiper implements IFailureDetectionEventListener , GossiperMBean <nl> EndpointState epState = endpointStateMap . get ( endpoint ) ; <nl> epState . updateTimestamp ( ) ; / / make sure we don ' t evict it too soon <nl> epState . getHeartBeatState ( ) . forceNewerGenerationUnsafe ( ) ; <nl> - epState . addApplicationState ( ApplicationState . STATUS , StorageService . instance . valueFactory . removedNonlocal ( hostId , computeExpireTime ( ) ) ) ; <nl> + long expireTime = computeExpireTime ( ) ; <nl> + epState . addApplicationState ( ApplicationState . STATUS , StorageService . instance . valueFactory . removedNonlocal ( hostId , expireTime ) ) ; <nl> logger . info ( " Completing removal of " + endpoint ) ; <nl> + addExpireTimeForEndpoint ( endpoint , expireTime ) ; <nl> endpointStateMap . put ( endpoint , epState ) ; <nl> / / ensure at least one gossip round occurs before returning <nl> try <nl> diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java <nl> index 979b68e . . 34b2f12 100644 <nl> - - - a / src / java / org / apache / cassandra / service / StorageService . java <nl> + + + b / src / java / org / apache / cassandra / service / StorageService . java <nl> @ @ - 1554 , 7 + 1554 , 10 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE <nl> } <nl> } <nl> else / / now that the gossiper has told us about this nonexistent member , notify the gossiper to remove it <nl> + { <nl> + addExpireTimeIfFound ( endpoint , extractExpireTime ( pieces , MessagingService . instance ( ) . getVersion ( endpoint ) ) ) ; <nl> removeEndpoint ( endpoint ) ; <nl> + } <nl> } <nl> <nl> private void excise ( Collection < Token > tokens , InetAddress endpoint )

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index a9a93a4 . . b3a794f 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 6 + 1 , 7 @ @ 
 1 . 2 . 17 
 * Fix BatchlogManager # deleteBatch ( ) use of millisecond timsestamps 
 ( CASSANDRA - 6822 ) 
 + * Continue assassinating even if the endpoint vanishes ( CASSANDRA - 6787 ) 
 
 
 1 . 2 . 16 
 diff - - git a / src / java / org / apache / cassandra / gms / Gossiper . java b / src / java / org / apache / cassandra / gms / Gossiper . java 
 index b51bbd3 . . 5d2780e 100644 
 - - - a / src / java / org / apache / cassandra / gms / Gossiper . java 
 + + + b / src / java / org / apache / cassandra / gms / Gossiper . java 
 @ @ - 483 , 8 + 483 , 10 @ @ public class Gossiper implements IFailureDetectionEventListener , GossiperMBean 
 throw new AssertionError ( e ) ; 
 } 
 / / make sure it did not change 
 - epState = endpointStateMap . get ( endpoint ) ; 
 - if ( epState . getHeartBeatState ( ) . getGeneration ( ) ! = generation ) 
 + EndpointState newState = endpointStateMap . get ( endpoint ) ; 
 + if ( newState = = null ) 
 + logger . warn ( " Endpoint { } disappeared while trying to assassinate , continuing anyway " , endpoint ) ; 
 + else if ( newState . getHeartBeatState ( ) . getGeneration ( ) ! = generation ) 
 throw new RuntimeException ( " Endpoint " + endpoint + " generation changed while trying to remove it " ) ; 
 epState . updateTimestamp ( ) ; / / make sure we don ' t evict it too soon 
 epState . getHeartBeatState ( ) . forceNewerGenerationUnsafe ( ) ;

NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 6b3a705 . . e0e8079 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 7 , 6 + 7 , 7 @ @ 
 * configure populate _ io _ cache _ on _ flush per - CF ( CASSANDRA - 4694 ) 
 * allow configuration of internode socket buffer ( CASSANDRA - 3378 ) 
 * Make sstable directory picking blacklist - aware again ( CASSANDRA - 5193 ) 
 + * Correctly expire gossip states for edge cases ( CASSANDRA - 5216 ) 
 
 1 . 2 . 1 
 * stream undelivered hints on decommission ( CASSANDRA - 5128 ) 
 diff - - git a / src / java / org / apache / cassandra / gms / Gossiper . java b / src / java / org / apache / cassandra / gms / Gossiper . java 
 index 9ee2f61 . . c9d0d51 100644 
 - - - a / src / java / org / apache / cassandra / gms / Gossiper . java 
 + + + b / src / java / org / apache / cassandra / gms / Gossiper . java 
 @ @ - 234 , 6 + 234 , 8 @ @ public class Gossiper implements IFailureDetectionEventListener , GossiperMBean 
 { 
 markDead ( endpoint , epState ) ; 
 } 
 + else 
 + epState . markDead ( ) ; 
 } 
 
 / * * 
 @ @ - 389 , 8 + 391 , 10 @ @ public class Gossiper implements IFailureDetectionEventListener , GossiperMBean 
 EndpointState epState = endpointStateMap . get ( endpoint ) ; 
 epState . updateTimestamp ( ) ; / / make sure we don ' t evict it too soon 
 epState . getHeartBeatState ( ) . forceNewerGenerationUnsafe ( ) ; 
 - epState . addApplicationState ( ApplicationState . STATUS , StorageService . instance . valueFactory . removedNonlocal ( hostId , computeExpireTime ( ) ) ) ; 
 + long expireTime = computeExpireTime ( ) ; 
 + epState . addApplicationState ( ApplicationState . STATUS , StorageService . instance . valueFactory . removedNonlocal ( hostId , expireTime ) ) ; 
 logger . info ( " Completing removal of " + endpoint ) ; 
 + addExpireTimeForEndpoint ( endpoint , expireTime ) ; 
 endpointStateMap . put ( endpoint , epState ) ; 
 / / ensure at least one gossip round occurs before returning 
 try 
 diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java 
 index 979b68e . . 34b2f12 100644 
 - - - a / src / java / org / apache / cassandra / service / StorageService . java 
 + + + b / src / java / org / apache / cassandra / service / StorageService . java 
 @ @ - 1554 , 7 + 1554 , 10 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE 
 } 
 } 
 else / / now that the gossiper has told us about this nonexistent member , notify the gossiper to remove it 
 + { 
 + addExpireTimeIfFound ( endpoint , extractExpireTime ( pieces , MessagingService . instance ( ) . getVersion ( endpoint ) ) ) ; 
 removeEndpoint ( endpoint ) ; 
 + } 
 } 
 
 private void excise ( Collection < Token > tokens , InetAddress endpoint )
