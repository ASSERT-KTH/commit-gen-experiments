BLEU SCORE: 0.020980574531482755

TEST MSG: Fix IllegalArgumentException when upgrading from 1 . 2 with SC
GENERATED MSG: cqlsh : handle CUSTOM 2i in DESCRIBE output

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 41c89e1 . . 8eb10cd 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 30 , 6 + 30 , 8 @ @ <nl> * Fix NPE on BulkLoader caused by losing StreamEvent ( CASSANDRA - 6636 ) <nl> * Fix truncating compression metadata ( CASSANDRA - 6791 ) <nl> * Fix UPDATE updating PRIMARY KEY columns implicitly ( CASSANDRA - 6782 ) <nl> + * Fix IllegalArgumentException when updating from 1 . 2 with SuperColumns <nl> + ( CASSANDRA - 6733 ) <nl> Merged from 1 . 2 : <nl> * Add CMSClassUnloadingEnabled JVM option ( CASSANDRA - 6541 ) <nl> * Catch memtable flush exceptions during shutdown ( CASSANDRA - 6735 ) <nl> diff - - git a / src / java / org / apache / cassandra / db / columniterator / IndexedSliceReader . java b / src / java / org / apache / cassandra / db / columniterator / IndexedSliceReader . java <nl> index 036d0cf . . b6aa085 100644 <nl> - - - a / src / java / org / apache / cassandra / db / columniterator / IndexedSliceReader . java <nl> + + + b / src / java / org / apache / cassandra / db / columniterator / IndexedSliceReader . java <nl> @ @ - 179 , 6 + 179 , 34 @ @ class IndexedSliceReader extends AbstractIterator < OnDiskAtom > implements OnDiskA <nl> } <nl> } <nl> <nl> + static int indexFor ( SSTableReader sstable , ByteBuffer name , List < IndexHelper . IndexInfo > indexes , AbstractType < ? > comparator , boolean reversed , int startIdx ) <nl> + { <nl> + / / If it ' s a super CF and the sstable is from the old format , then the index will contain old format info , i . e . non composite <nl> + / / SC names . So we need to 1 ) use only the SC name part of the comparator and 2 ) extract only that part from ' name ' <nl> + if ( sstable . metadata . isSuper ( ) & & sstable . descriptor . version . hasSuperColumns ) <nl> + { <nl> + AbstractType < ? > scComparator = SuperColumns . getComparatorFor ( sstable . metadata , false ) ; <nl> + ByteBuffer scName = SuperColumns . scName ( name ) ; <nl> + return IndexHelper . indexFor ( scName , indexes , scComparator , reversed , startIdx ) ; <nl> + } <nl> + return IndexHelper . indexFor ( name , indexes , comparator , reversed , startIdx ) ; <nl> + } <nl> + <nl> + static ByteBuffer forIndexComparison ( SSTableReader sstable , ByteBuffer name ) <nl> + { <nl> + / / See indexFor above . <nl> + return sstable . metadata . isSuper ( ) & & sstable . descriptor . version . hasSuperColumns <nl> + ? SuperColumns . scName ( name ) <nl> + : name ; <nl> + } <nl> + <nl> + static AbstractType < ? > comparatorForIndex ( SSTableReader sstable , AbstractType < ? > comparator ) <nl> + { <nl> + return sstable . metadata . isSuper ( ) & & sstable . descriptor . version . hasSuperColumns <nl> + ? SuperColumns . getComparatorFor ( sstable . metadata , false ) <nl> + : comparator ; <nl> + } <nl> + <nl> private abstract class BlockFetcher <nl> { <nl> protected int currentSliceIdx ; <nl> @ @ - 219 , 16 + 247 , 22 @ @ class IndexedSliceReader extends AbstractIterator < OnDiskAtom > implements OnDiskA <nl> return start . remaining ( ) ! = 0 & & comparator . compare ( name , start ) < 0 ; <nl> } <nl> <nl> + protected boolean isIndexEntryBeforeSliceStart ( ByteBuffer name ) <nl> + { <nl> + ByteBuffer start = currentStart ( ) ; <nl> + return start . remaining ( ) ! = 0 & & comparatorForIndex ( sstable , comparator ) . compare ( name , forIndexComparison ( sstable , start ) ) < 0 ; <nl> + } <nl> + <nl> protected boolean isColumnBeforeSliceFinish ( OnDiskAtom column ) <nl> { <nl> ByteBuffer finish = currentFinish ( ) ; <nl> return finish . remaining ( ) = = 0 | | comparator . compare ( column . name ( ) , finish ) < = 0 ; <nl> } <nl> <nl> - protected boolean isAfterSliceFinish ( ByteBuffer name ) <nl> + protected boolean isIndexEntryAfterSliceFinish ( ByteBuffer name ) <nl> { <nl> ByteBuffer finish = currentFinish ( ) ; <nl> - return finish . remaining ( ) ! = 0 & & comparator . compare ( name , finish ) > 0 ; <nl> + return finish . remaining ( ) ! = 0 & & comparatorForIndex ( sstable , comparator ) . compare ( name , forIndexComparison ( sstable , finish ) ) > 0 ; <nl> } <nl> } <nl> <nl> @ @ - 259 , 7 + 293 , 7 @ @ class IndexedSliceReader extends AbstractIterator < OnDiskAtom > implements OnDiskA <nl> { <nl> while ( + + currentSliceIdx < slices . length ) <nl> { <nl> - nextIndexIdx = IndexHelper . indexFor ( slices [ currentSliceIdx ] . start , indexes , comparator , reversed , nextIndexIdx ) ; <nl> + nextIndexIdx = indexFor ( sstable , slices [ currentSliceIdx ] . start , indexes , comparator , reversed , nextIndexIdx ) ; <nl> if ( nextIndexIdx < 0 | | nextIndexIdx > = indexes . size ( ) ) <nl> / / no index block for that slice <nl> continue ; <nl> @ @ - 268 , 12 + 302 , 12 @ @ class IndexedSliceReader extends AbstractIterator < OnDiskAtom > implements OnDiskA <nl> IndexInfo info = indexes . get ( nextIndexIdx ) ; <nl> if ( reversed ) <nl> { <nl> - if ( ! isBeforeSliceStart ( info . lastName ) ) <nl> + if ( ! isIndexEntryBeforeSliceStart ( info . lastName ) ) <nl> return true ; <nl> } <nl> else <nl> { <nl> - if ( ! isAfterSliceFinish ( info . firstName ) ) <nl> + if ( ! isIndexEntryAfterSliceFinish ( info . firstName ) ) <nl> return true ; <nl> } <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / db / columniterator / SSTableNamesIterator . java b / src / java / org / apache / cassandra / db / columniterator / SSTableNamesIterator . java <nl> index 3467244 . . 2e84d8d 100644 <nl> - - - a / src / java / org / apache / cassandra / db / columniterator / SSTableNamesIterator . java <nl> + + + b / src / java / org / apache / cassandra / db / columniterator / SSTableNamesIterator . java <nl> @ @ - 189 , 13 + 189 , 15 @ @ public class SSTableNamesIterator extends AbstractIterator < OnDiskAtom > implement <nl> int lastIndexIdx = - 1 ; <nl> for ( ByteBuffer name : columns ) <nl> { <nl> - int index = IndexHelper . indexFor ( name , indexList , comparator , false , lastIndexIdx ) ; <nl> + int index = IndexedSliceReader . indexFor ( sstable , name , indexList , comparator , false , lastIndexIdx ) ; <nl> if ( index < 0 | | index = = indexList . size ( ) ) <nl> continue ; <nl> IndexHelper . IndexInfo indexInfo = indexList . get ( index ) ; <nl> / / Check the index block does contain the column names and that we haven ' t inserted this block yet . <nl> - if ( comparator . compare ( name , indexInfo . firstName ) < 0 | | index = = lastIndexIdx ) <nl> + if ( IndexedSliceReader . comparatorForIndex ( sstable , comparator ) . compare ( IndexedSliceReader . forIndexComparison ( sstable , name ) , indexInfo . firstName ) < 0 <nl> + | | index = = lastIndexIdx ) <nl> continue ; <nl> + <nl> ranges . add ( indexInfo ) ; <nl> lastIndexIdx = index ; <nl> }
NEAREST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / config / CFMetaData . java b / src / java / org / apache / cassandra / config / CFMetaData . java <nl> index 5639292 . . 3611986 100644 <nl> - - - a / src / java / org / apache / cassandra / config / CFMetaData . java <nl> + + + b / src / java / org / apache / cassandra / config / CFMetaData . java <nl> @ @ - 91 , 81 + 91 , 80 @ @ public final class CFMetaData <nl> / / Note that this is the default only for user created tables <nl> public final static String DEFAULT _ COMPRESSOR = LZ4Compressor . class . getCanonicalName ( ) ; <nl> <nl> - public static final CFMetaData IndexCf = compile ( 5 , " CREATE TABLE \ " " + SystemKeyspace . INDEX _ CF + " \ " ( " <nl> - + " table _ name text , " <nl> - + " index _ name text , " <nl> - + " PRIMARY KEY ( table _ name , index _ name ) " <nl> - + " ) WITH COMPACT STORAGE AND COMMENT = ' indexes that have been completed ' " ) ; <nl> - <nl> - public static final CFMetaData CounterIdCf = compile ( 6 , " CREATE TABLE \ " " + SystemKeyspace . COUNTER _ ID _ CF + " \ " ( " <nl> - + " key text , " <nl> - + " id timeuuid , " <nl> - + " PRIMARY KEY ( key , id ) " <nl> - + " ) WITH COMPACT STORAGE AND COMMENT = ' counter node IDs ' " ) ; <nl> - <nl> - / / new - style schema <nl> - public static final CFMetaData SchemaKeyspacesCf = compile ( 8 , " CREATE TABLE " + SystemKeyspace . SCHEMA _ KEYSPACES _ CF + " ( " <nl> - + " keyspace _ name text PRIMARY KEY , " <nl> - + " durable _ writes boolean , " <nl> - + " strategy _ class text , " <nl> - + " strategy _ options text " <nl> - + " ) WITH COMPACT STORAGE AND COMMENT = ' keyspace definitions ' AND gc _ grace _ seconds = 8640 " ) ; <nl> - <nl> - public static final CFMetaData SchemaColumnFamiliesCf = compile ( 9 , " CREATE TABLE " + SystemKeyspace . SCHEMA _ COLUMNFAMILIES _ CF + " ( " <nl> - + " keyspace _ name text , " <nl> - + " columnfamily _ name text , " <nl> - + " type text , " <nl> - + " comparator text , " <nl> - + " subcomparator text , " <nl> - + " comment text , " <nl> - + " read _ repair _ chance double , " <nl> - + " local _ read _ repair _ chance double , " <nl> - + " replicate _ on _ write boolean , " <nl> - + " gc _ grace _ seconds int , " <nl> - + " default _ validator text , " <nl> - + " key _ validator text , " <nl> - + " min _ compaction _ threshold int , " <nl> - + " max _ compaction _ threshold int , " <nl> - + " memtable _ flush _ period _ in _ ms int , " <nl> - + " key _ alias text , " / / that one is kept for compatibility sake <nl> - + " key _ aliases text , " <nl> - + " bloom _ filter _ fp _ chance double , " <nl> - + " caching text , " <nl> - + " default _ time _ to _ live int , " <nl> - + " compaction _ strategy _ class text , " <nl> - + " compression _ parameters text , " <nl> - + " value _ alias text , " <nl> - + " column _ aliases text , " <nl> - + " compaction _ strategy _ options text , " <nl> - + " default _ read _ consistency text , " <nl> - + " default _ write _ consistency text , " <nl> - + " speculative _ retry text , " <nl> - + " populate _ io _ cache _ on _ flush boolean , " <nl> - + " index _ interval int , " <nl> - + " dropped _ columns map < text , bigint > , " <nl> - + " PRIMARY KEY ( keyspace _ name , columnfamily _ name ) " <nl> - + " ) WITH COMMENT = ' ColumnFamily definitions ' AND gc _ grace _ seconds = 8640 " ) ; <nl> - <nl> - public static final CFMetaData SchemaColumnsCf = compile ( 10 , " CREATE TABLE " + SystemKeyspace . SCHEMA _ COLUMNS _ CF + " ( " <nl> - + " keyspace _ name text , " <nl> - + " columnfamily _ name text , " <nl> - + " column _ name text , " <nl> - + " validator text , " <nl> - + " index _ type text , " <nl> - + " index _ options text , " <nl> - + " index _ name text , " <nl> - + " component _ index int , " <nl> - + " type text , " <nl> - + " PRIMARY KEY ( keyspace _ name , columnfamily _ name , column _ name ) " <nl> - + " ) WITH COMMENT = ' ColumnFamily column attributes ' AND gc _ grace _ seconds = 8640 " ) ; <nl> - <nl> - public static final CFMetaData SchemaTriggerCf = compile ( " CREATE TABLE \ " " + SystemKeyspace . SCHEMA _ TRIGGERS _ CF + " \ " ( " <nl> - + " keyspace _ name text , " <nl> - + " column _ family text , " <nl> - + " trigger _ name text , " <nl> - + " trigger _ options map < text , text > , " <nl> - + " PRIMARY KEY ( keyspace _ name , column _ family , trigger _ name ) " <nl> - + " ) WITH COMMENT = ' triggers metadata table ' " ) ; <nl> + public static final CFMetaData IndexCf = compile ( " CREATE TABLE \ " " + SystemKeyspace . INDEX _ CF + " \ " ( " <nl> + + " table _ name text , " <nl> + + " index _ name text , " <nl> + + " PRIMARY KEY ( table _ name , index _ name ) " <nl> + + " ) WITH COMPACT STORAGE AND COMMENT = ' indexes that have been completed ' " ) ; <nl> + <nl> + public static final CFMetaData CounterIdCf = compile ( " CREATE TABLE \ " " + SystemKeyspace . COUNTER _ ID _ CF + " \ " ( " <nl> + + " key text , " <nl> + + " id timeuuid , " <nl> + + " PRIMARY KEY ( key , id ) " <nl> + + " ) WITH COMPACT STORAGE AND COMMENT = ' counter node IDs ' " ) ; <nl> + <nl> + public static final CFMetaData SchemaKeyspacesCf = compile ( " CREATE TABLE " + SystemKeyspace . SCHEMA _ KEYSPACES _ CF + " ( " <nl> + + " keyspace _ name text PRIMARY KEY , " <nl> + + " durable _ writes boolean , " <nl> + + " strategy _ class text , " <nl> + + " strategy _ options text " <nl> + + " ) WITH COMPACT STORAGE AND COMMENT = ' keyspace definitions ' AND gc _ grace _ seconds = 8640 " ) ; <nl> + <nl> + public static final CFMetaData SchemaColumnFamiliesCf = compile ( " CREATE TABLE " + SystemKeyspace . SCHEMA _ COLUMNFAMILIES _ CF + " ( " <nl> + + " keyspace _ name text , " <nl> + + " columnfamily _ name text , " <nl> + + " type text , " <nl> + + " comparator text , " <nl> + + " subcomparator text , " <nl> + + " comment text , " <nl> + + " read _ repair _ chance double , " <nl> + + " local _ read _ repair _ chance double , " <nl> + + " replicate _ on _ write boolean , " <nl> + + " gc _ grace _ seconds int , " <nl> + + " default _ validator text , " <nl> + + " key _ validator text , " <nl> + + " min _ compaction _ threshold int , " <nl> + + " max _ compaction _ threshold int , " <nl> + + " memtable _ flush _ period _ in _ ms int , " <nl> + + " key _ alias text , " / / that one is kept for compatibility sake <nl> + + " key _ aliases text , " <nl> + + " bloom _ filter _ fp _ chance double , " <nl> + + " caching text , " <nl> + + " default _ time _ to _ live int , " <nl> + + " compaction _ strategy _ class text , " <nl> + + " compression _ parameters text , " <nl> + + " value _ alias text , " <nl> + + " column _ aliases text , " <nl> + + " compaction _ strategy _ options text , " <nl> + + " default _ read _ consistency text , " <nl> + + " default _ write _ consistency text , " <nl> + + " speculative _ retry text , " <nl> + + " populate _ io _ cache _ on _ flush boolean , " <nl> + + " index _ interval int , " <nl> + + " dropped _ columns map < text , bigint > , " <nl> + + " PRIMARY KEY ( keyspace _ name , columnfamily _ name ) " <nl> + + " ) WITH COMMENT = ' ColumnFamily definitions ' AND gc _ grace _ seconds = 8640 " ) ; <nl> + <nl> + public static final CFMetaData SchemaColumnsCf = compile ( " CREATE TABLE " + SystemKeyspace . SCHEMA _ COLUMNS _ CF + " ( " <nl> + + " keyspace _ name text , " <nl> + + " columnfamily _ name text , " <nl> + + " column _ name text , " <nl> + + " validator text , " <nl> + + " index _ type text , " <nl> + + " index _ options text , " <nl> + + " index _ name text , " <nl> + + " component _ index int , " <nl> + + " type text , " <nl> + + " PRIMARY KEY ( keyspace _ name , columnfamily _ name , column _ name ) " <nl> + + " ) WITH COMMENT = ' ColumnFamily column attributes ' AND gc _ grace _ seconds = 8640 " ) ; <nl> + <nl> + public static final CFMetaData SchemaTriggersCf = compile ( " CREATE TABLE " + SystemKeyspace . SCHEMA _ TRIGGERS _ CF + " ( " <nl> + + " keyspace _ name text , " <nl> + + " columnfamily _ name text , " <nl> + + " trigger _ name text , " <nl> + + " trigger _ options map < text , text > , " <nl> + + " PRIMARY KEY ( keyspace _ name , columnfamily _ name , trigger _ name ) " <nl> + + " ) WITH COMMENT = ' triggers metadata table ' " ) ; <nl> <nl> public static final CFMetaData HintsCf = compile ( " CREATE TABLE " + SystemKeyspace . HINTS _ CF + " ( " <nl> + " target _ id uuid , " <nl> @ @ - 353 , 7 + 352 , 7 @ @ public final class CFMetaData <nl> public final String ksName ; / / name of keyspace <nl> public final String cfName ; / / name of this column family <nl> public final ColumnFamilyType cfType ; / / standard , super <nl> - public volatile AbstractType < ? > comparator ; / / bytes , long , timeuuid , utf8 , etc . <nl> + public volatile AbstractType < ? > comparator ; / / bytes , long , timeuuid , utf8 , etc . <nl> <nl> / / OPTIONAL <nl> private volatile String comment = " " ; <nl> @ @ - 372 , 7 + 371 , 7 @ @ public final class CFMetaData <nl> private volatile int defaultTimeToLive = DEFAULT _ DEFAULT _ TIME _ TO _ LIVE ; <nl> private volatile SpeculativeRetry speculativeRetry = DEFAULT _ SPECULATIVE _ RETRY ; <nl> private volatile boolean populateIoCacheOnFlush = DEFAULT _ POPULATE _ IO _ CACHE _ ON _ FLUSH ; <nl> - private volatile Map < ByteBuffer , Long > droppedColumns = new HashMap < ByteBuffer , Long > ( ) ; <nl> + private volatile Map < ByteBuffer , Long > droppedColumns = new HashMap < > ( ) ; <nl> private volatile Map < String , Map < String , String > > triggers = new HashMap < > ( ) ; <nl> private volatile Collection < String > cachedTriggers ; <nl> <nl> @ @ - 452 , 19 + 451 , 19 @ @ public final class CFMetaData <nl> return new HashMap < > ( triggers ) ; <nl> } <nl> <nl> - private static CFMetaData compile ( String cql , String keyspace ) <nl> + private static CFMetaData compile ( String cql ) <nl> { <nl> - return compile ( null , cql , keyspace ) ; <nl> + return compile ( cql , Keyspace . SYSTEM _ KS ) ; <nl> } <nl> <nl> - private static CFMetaData compile ( Integer id , String cql , String keyspace ) <nl> + private static CFMetaData compile ( String cql , String keyspace ) <nl> { <nl> try <nl> { <nl> CreateTableStatement statement = ( CreateTableStatement ) QueryProcessor . parseStatement ( cql ) . prepare ( ) . statement ; <nl> - CFMetaData cfmd = newSystemMetadata ( keyspace , statement . columnFamily ( ) , " " , statement . comparator , null ) ; <nl> - statement . applyPropertiesTo ( cfmd ) ; <nl> - return cfmd . rebuild ( ) ; <nl> + CFMetaData cfm = newSystemMetadata ( keyspace , statement . columnFamily ( ) , " " , statement . comparator , null ) ; <nl> + statement . applyPropertiesTo ( cfm ) ; <nl> + return cfm . rebuild ( ) ; <nl> } <nl> catch ( RequestValidationException e ) <nl> { <nl> @ @ - 472 , 16 + 471 , 6 @ @ public final class CFMetaData <nl> } <nl> } <nl> <nl> - private static CFMetaData compile ( String cql ) <nl> - { <nl> - return compile ( null , cql , Keyspace . SYSTEM _ KS ) ; <nl> - } <nl> - <nl> - private static CFMetaData compile ( int id , String cql ) <nl> - { <nl> - return compile ( id , cql , Keyspace . SYSTEM _ KS ) ; <nl> - } <nl> - <nl> private static AbstractType < ? > makeComparator ( ColumnFamilyType cftype , AbstractType < ? > comp , AbstractType < ? > subcc ) <nl> { <nl> return cftype = = ColumnFamilyType . Super <nl> @ @ - 1441 , 7 + 1430 , 7 @ @ public final class CFMetaData <nl> if ( fromThrift & & cd . type ! = ColumnDefinition . Type . REGULAR ) <nl> continue ; <nl> <nl> - cd . deleteFromSchema ( rm , cfName , getColumnDefinitionComparator ( cd ) , modificationTimestamp ) ; <nl> + cd . deleteFromSchema ( rm , cfName , modificationTimestamp ) ; <nl> } <nl> <nl> / / newly added columns <nl> @ @ - 1482 , 12 + 1471 , 12 @ @ public final class CFMetaData <nl> cf . addAtom ( new RangeTombstone ( builder . build ( ) , builder . buildAsEndOfRange ( ) , timestamp , ldt ) ) ; <nl> <nl> ColumnFamily tcf = rm . addOrGet ( SystemKeyspace . SCHEMA _ TRIGGERS _ CF ) ; <nl> - ColumnNameBuilder tbuilder = SchemaTriggerCf . getCfDef ( ) . getColumnNameBuilder ( ) ; <nl> + ColumnNameBuilder tbuilder = SchemaTriggersCf . getCfDef ( ) . getColumnNameBuilder ( ) ; <nl> tbuilder . add ( ByteBufferUtil . bytes ( cfName ) ) ; <nl> tcf . addAtom ( new RangeTombstone ( tbuilder . build ( ) , tbuilder . buildAsEndOfRange ( ) , timestamp , ldt ) ) ; <nl> <nl> for ( ColumnDefinition cd : column _ metadata . values ( ) ) <nl> - cd . deleteFromSchema ( rm , cfName , getColumnDefinitionComparator ( cd ) , timestamp ) ; <nl> + cd . deleteFromSchema ( rm , cfName , timestamp ) ; <nl> <nl> return rm ; <nl> } <nl> @ @ - 1776 , 8 + 1765 , 7 @ @ public final class CFMetaData <nl> <nl> public boolean removeColumnDefinition ( ColumnDefinition def ) <nl> { <nl> - boolean removed = column _ metadata . remove ( def . name ) ! = null ; <nl> - return removed ; <nl> + return column _ metadata . remove ( def . name ) ! = null ; <nl> } <nl> <nl> public void recordColumnDrop ( ColumnDefinition def ) <nl> diff - - git a / src / java / org / apache / cassandra / config / ColumnDefinition . java b / src / java / org / apache / cassandra / config / ColumnDefinition . java <nl> index 00a784f . . 6b979b7 100644 <nl> - - - a / src / java / org / apache / cassandra / config / ColumnDefinition . java <nl> + + + b / src / java / org / apache / cassandra / config / ColumnDefinition . java <nl> @ @ - 195 , 7 + 195 , 7 @ @ public class ColumnDefinition <nl> * @ param cfName The name of the parent ColumnFamily <nl> * @ param timestamp The timestamp to use for column modification <nl> * / <nl> - public void deleteFromSchema ( RowMutation rm , String cfName , AbstractType < ? > comparator , long timestamp ) <nl> + public void deleteFromSchema ( RowMutation rm , String cfName , long timestamp ) <nl> { <nl> ColumnFamily cf = rm . addOrGet ( SystemKeyspace . SCHEMA _ COLUMNS _ CF ) ; <nl> int ldt = ( int ) ( System . currentTimeMillis ( ) / 1000 ) ; <nl> diff - - git a / src / java / org / apache / cassandra / config / KSMetaData . java b / src / java / org / apache / cassandra / config / KSMetaData . java <nl> index 798a688 . . edeb20e 100644 <nl> - - - a / src / java / org / apache / cassandra / config / KSMetaData . java <nl> + + + b / src / java / org / apache / cassandra / config / KSMetaData . java <nl> @ @ - 84 , 7 + 84 , 7 @ @ public final class KSMetaData <nl> CFMetaData . PeerEventsCf , <nl> CFMetaData . HintsCf , <nl> CFMetaData . IndexCf , <nl> - CFMetaData . SchemaTriggerCf , <nl> + CFMetaData . SchemaTriggersCf , <nl> CFMetaData . CounterIdCf , <nl> CFMetaData . SchemaKeyspacesCf , <nl> CFMetaData . SchemaColumnFamiliesCf , <nl> diff - - git a / src / java / org / apache / cassandra / config / TriggerOptions . java b / src / java / org / apache / cassandra / config / TriggerOptions . java <nl> index 95d99bd . . 7411756 100644 <nl> - - - a / src / java / org / apache / cassandra / config / TriggerOptions . java <nl> + + + b / src / java / org / apache / cassandra / config / TriggerOptions . java <nl> @ @ - 43 , 7 + 43 , 7 @ @ public class TriggerOptions <nl> <nl> public static Map < String , Map < String , String > > getAllTriggers ( String ksName , String cfName ) <nl> { <nl> - String req = " SELECT * FROM system . % s WHERE keyspace _ name = ' % s ' AND column _ family = ' % s ' " ; <nl> + String req = " SELECT * FROM system . % s WHERE keyspace _ name = ' % s ' AND columnfamily _ name = ' % s ' " ; <nl> UntypedResultSet result = processInternal ( String . format ( req , SystemKeyspace . SCHEMA _ TRIGGERS _ CF , ksName , cfName ) ) ; <nl> Map < String , Map < String , String > > triggers = new HashMap < > ( ) ; <nl> if ( result . isEmpty ( ) ) <nl> @ @ - 57 , 7 + 57 , 7 @ @ public class TriggerOptions <nl> { <nl> ColumnFamily cf = rm . addOrGet ( SystemKeyspace . SCHEMA _ TRIGGERS _ CF ) ; <nl> assert tentry . getValue ( ) . get ( CLASS _ KEY ) ! = null ; <nl> - ColumnNameBuilder builder = CFMetaData . SchemaTriggerCf . getCfDef ( ) . getColumnNameBuilder ( ) ; <nl> + ColumnNameBuilder builder = CFMetaData . SchemaTriggersCf . getCfDef ( ) . getColumnNameBuilder ( ) ; <nl> builder . add ( ByteBufferUtil . bytes ( cfName ) ) . add ( ByteBufferUtil . bytes ( tentry . getKey ( ) ) ) . add ( ByteBufferUtil . bytes ( OPTIONS _ KEY ) ) ; <nl> for ( Entry < String , String > entry : tentry . getValue ( ) . entrySet ( ) ) <nl> { <nl> @ @ - 71 , 7 + 71 , 7 @ @ public class TriggerOptions <nl> { <nl> ColumnFamily cf = rm . addOrGet ( SystemKeyspace . SCHEMA _ TRIGGERS _ CF ) ; <nl> int ldt = ( int ) ( System . currentTimeMillis ( ) / 1000 ) ; <nl> - ColumnNameBuilder builder = CFMetaData . SchemaTriggerCf . getCfDef ( ) . getColumnNameBuilder ( ) ; <nl> + ColumnNameBuilder builder = CFMetaData . SchemaTriggersCf . getCfDef ( ) . getColumnNameBuilder ( ) ; <nl> builder . add ( ByteBufferUtil . bytes ( cfName ) ) . add ( ByteBufferUtil . bytes ( tentry . getKey ( ) ) ) ; <nl> cf . addAtom ( new RangeTombstone ( builder . build ( ) , builder . buildAsEndOfRange ( ) , modificationTimestamp , ldt ) ) ; <nl> }

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 41c89e1 . . 8eb10cd 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 30 , 6 + 30 , 8 @ @ 
 * Fix NPE on BulkLoader caused by losing StreamEvent ( CASSANDRA - 6636 ) 
 * Fix truncating compression metadata ( CASSANDRA - 6791 ) 
 * Fix UPDATE updating PRIMARY KEY columns implicitly ( CASSANDRA - 6782 ) 
 + * Fix IllegalArgumentException when updating from 1 . 2 with SuperColumns 
 + ( CASSANDRA - 6733 ) 
 Merged from 1 . 2 : 
 * Add CMSClassUnloadingEnabled JVM option ( CASSANDRA - 6541 ) 
 * Catch memtable flush exceptions during shutdown ( CASSANDRA - 6735 ) 
 diff - - git a / src / java / org / apache / cassandra / db / columniterator / IndexedSliceReader . java b / src / java / org / apache / cassandra / db / columniterator / IndexedSliceReader . java 
 index 036d0cf . . b6aa085 100644 
 - - - a / src / java / org / apache / cassandra / db / columniterator / IndexedSliceReader . java 
 + + + b / src / java / org / apache / cassandra / db / columniterator / IndexedSliceReader . java 
 @ @ - 179 , 6 + 179 , 34 @ @ class IndexedSliceReader extends AbstractIterator < OnDiskAtom > implements OnDiskA 
 } 
 } 
 
 + static int indexFor ( SSTableReader sstable , ByteBuffer name , List < IndexHelper . IndexInfo > indexes , AbstractType < ? > comparator , boolean reversed , int startIdx ) 
 + { 
 + / / If it ' s a super CF and the sstable is from the old format , then the index will contain old format info , i . e . non composite 
 + / / SC names . So we need to 1 ) use only the SC name part of the comparator and 2 ) extract only that part from ' name ' 
 + if ( sstable . metadata . isSuper ( ) & & sstable . descriptor . version . hasSuperColumns ) 
 + { 
 + AbstractType < ? > scComparator = SuperColumns . getComparatorFor ( sstable . metadata , false ) ; 
 + ByteBuffer scName = SuperColumns . scName ( name ) ; 
 + return IndexHelper . indexFor ( scName , indexes , scComparator , reversed , startIdx ) ; 
 + } 
 + return IndexHelper . indexFor ( name , indexes , comparator , reversed , startIdx ) ; 
 + } 
 + 
 + static ByteBuffer forIndexComparison ( SSTableReader sstable , ByteBuffer name ) 
 + { 
 + / / See indexFor above . 
 + return sstable . metadata . isSuper ( ) & & sstable . descriptor . version . hasSuperColumns 
 + ? SuperColumns . scName ( name ) 
 + : name ; 
 + } 
 + 
 + static AbstractType < ? > comparatorForIndex ( SSTableReader sstable , AbstractType < ? > comparator ) 
 + { 
 + return sstable . metadata . isSuper ( ) & & sstable . descriptor . version . hasSuperColumns 
 + ? SuperColumns . getComparatorFor ( sstable . metadata , false ) 
 + : comparator ; 
 + } 
 + 
 private abstract class BlockFetcher 
 { 
 protected int currentSliceIdx ; 
 @ @ - 219 , 16 + 247 , 22 @ @ class IndexedSliceReader extends AbstractIterator < OnDiskAtom > implements OnDiskA 
 return start . remaining ( ) ! = 0 & & comparator . compare ( name , start ) < 0 ; 
 } 
 
 + protected boolean isIndexEntryBeforeSliceStart ( ByteBuffer name ) 
 + { 
 + ByteBuffer start = currentStart ( ) ; 
 + return start . remaining ( ) ! = 0 & & comparatorForIndex ( sstable , comparator ) . compare ( name , forIndexComparison ( sstable , start ) ) < 0 ; 
 + } 
 + 
 protected boolean isColumnBeforeSliceFinish ( OnDiskAtom column ) 
 { 
 ByteBuffer finish = currentFinish ( ) ; 
 return finish . remaining ( ) = = 0 | | comparator . compare ( column . name ( ) , finish ) < = 0 ; 
 } 
 
 - protected boolean isAfterSliceFinish ( ByteBuffer name ) 
 + protected boolean isIndexEntryAfterSliceFinish ( ByteBuffer name ) 
 { 
 ByteBuffer finish = currentFinish ( ) ; 
 - return finish . remaining ( ) ! = 0 & & comparator . compare ( name , finish ) > 0 ; 
 + return finish . remaining ( ) ! = 0 & & comparatorForIndex ( sstable , comparator ) . compare ( name , forIndexComparison ( sstable , finish ) ) > 0 ; 
 } 
 } 
 
 @ @ - 259 , 7 + 293 , 7 @ @ class IndexedSliceReader extends AbstractIterator < OnDiskAtom > implements OnDiskA 
 { 
 while ( + + currentSliceIdx < slices . length ) 
 { 
 - nextIndexIdx = IndexHelper . indexFor ( slices [ currentSliceIdx ] . start , indexes , comparator , reversed , nextIndexIdx ) ; 
 + nextIndexIdx = indexFor ( sstable , slices [ currentSliceIdx ] . start , indexes , comparator , reversed , nextIndexIdx ) ; 
 if ( nextIndexIdx < 0 | | nextIndexIdx > = indexes . size ( ) ) 
 / / no index block for that slice 
 continue ; 
 @ @ - 268 , 12 + 302 , 12 @ @ class IndexedSliceReader extends AbstractIterator < OnDiskAtom > implements OnDiskA 
 IndexInfo info = indexes . get ( nextIndexIdx ) ; 
 if ( reversed ) 
 { 
 - if ( ! isBeforeSliceStart ( info . lastName ) ) 
 + if ( ! isIndexEntryBeforeSliceStart ( info . lastName ) ) 
 return true ; 
 } 
 else 
 { 
 - if ( ! isAfterSliceFinish ( info . firstName ) ) 
 + if ( ! isIndexEntryAfterSliceFinish ( info . firstName ) ) 
 return true ; 
 } 
 } 
 diff - - git a / src / java / org / apache / cassandra / db / columniterator / SSTableNamesIterator . java b / src / java / org / apache / cassandra / db / columniterator / SSTableNamesIterator . java 
 index 3467244 . . 2e84d8d 100644 
 - - - a / src / java / org / apache / cassandra / db / columniterator / SSTableNamesIterator . java 
 + + + b / src / java / org / apache / cassandra / db / columniterator / SSTableNamesIterator . java 
 @ @ - 189 , 13 + 189 , 15 @ @ public class SSTableNamesIterator extends AbstractIterator < OnDiskAtom > implement 
 int lastIndexIdx = - 1 ; 
 for ( ByteBuffer name : columns ) 
 { 
 - int index = IndexHelper . indexFor ( name , indexList , comparator , false , lastIndexIdx ) ; 
 + int index = IndexedSliceReader . indexFor ( sstable , name , indexList , comparator , false , lastIndexIdx ) ; 
 if ( index < 0 | | index = = indexList . size ( ) ) 
 continue ; 
 IndexHelper . IndexInfo indexInfo = indexList . get ( index ) ; 
 / / Check the index block does contain the column names and that we haven ' t inserted this block yet . 
 - if ( comparator . compare ( name , indexInfo . firstName ) < 0 | | index = = lastIndexIdx ) 
 + if ( IndexedSliceReader . comparatorForIndex ( sstable , comparator ) . compare ( IndexedSliceReader . forIndexComparison ( sstable , name ) , indexInfo . firstName ) < 0 
 + | | index = = lastIndexIdx ) 
 continue ; 
 + 
 ranges . add ( indexInfo ) ; 
 lastIndexIdx = index ; 
 }

NEAREST DIFF:
diff - - git a / src / java / org / apache / cassandra / config / CFMetaData . java b / src / java / org / apache / cassandra / config / CFMetaData . java 
 index 5639292 . . 3611986 100644 
 - - - a / src / java / org / apache / cassandra / config / CFMetaData . java 
 + + + b / src / java / org / apache / cassandra / config / CFMetaData . java 
 @ @ - 91 , 81 + 91 , 80 @ @ public final class CFMetaData 
 / / Note that this is the default only for user created tables 
 public final static String DEFAULT _ COMPRESSOR = LZ4Compressor . class . getCanonicalName ( ) ; 
 
 - public static final CFMetaData IndexCf = compile ( 5 , " CREATE TABLE \ " " + SystemKeyspace . INDEX _ CF + " \ " ( " 
 - + " table _ name text , " 
 - + " index _ name text , " 
 - + " PRIMARY KEY ( table _ name , index _ name ) " 
 - + " ) WITH COMPACT STORAGE AND COMMENT = ' indexes that have been completed ' " ) ; 
 - 
 - public static final CFMetaData CounterIdCf = compile ( 6 , " CREATE TABLE \ " " + SystemKeyspace . COUNTER _ ID _ CF + " \ " ( " 
 - + " key text , " 
 - + " id timeuuid , " 
 - + " PRIMARY KEY ( key , id ) " 
 - + " ) WITH COMPACT STORAGE AND COMMENT = ' counter node IDs ' " ) ; 
 - 
 - / / new - style schema 
 - public static final CFMetaData SchemaKeyspacesCf = compile ( 8 , " CREATE TABLE " + SystemKeyspace . SCHEMA _ KEYSPACES _ CF + " ( " 
 - + " keyspace _ name text PRIMARY KEY , " 
 - + " durable _ writes boolean , " 
 - + " strategy _ class text , " 
 - + " strategy _ options text " 
 - + " ) WITH COMPACT STORAGE AND COMMENT = ' keyspace definitions ' AND gc _ grace _ seconds = 8640 " ) ; 
 - 
 - public static final CFMetaData SchemaColumnFamiliesCf = compile ( 9 , " CREATE TABLE " + SystemKeyspace . SCHEMA _ COLUMNFAMILIES _ CF + " ( " 
 - + " keyspace _ name text , " 
 - + " columnfamily _ name text , " 
 - + " type text , " 
 - + " comparator text , " 
 - + " subcomparator text , " 
 - + " comment text , " 
 - + " read _ repair _ chance double , " 
 - + " local _ read _ repair _ chance double , " 
 - + " replicate _ on _ write boolean , " 
 - + " gc _ grace _ seconds int , " 
 - + " default _ validator text , " 
 - + " key _ validator text , " 
 - + " min _ compaction _ threshold int , " 
 - + " max _ compaction _ threshold int , " 
 - + " memtable _ flush _ period _ in _ ms int , " 
 - + " key _ alias text , " / / that one is kept for compatibility sake 
 - + " key _ aliases text , " 
 - + " bloom _ filter _ fp _ chance double , " 
 - + " caching text , " 
 - + " default _ time _ to _ live int , " 
 - + " compaction _ strategy _ class text , " 
 - + " compression _ parameters text , " 
 - + " value _ alias text , " 
 - + " column _ aliases text , " 
 - + " compaction _ strategy _ options text , " 
 - + " default _ read _ consistency text , " 
 - + " default _ write _ consistency text , " 
 - + " speculative _ retry text , " 
 - + " populate _ io _ cache _ on _ flush boolean , " 
 - + " index _ interval int , " 
 - + " dropped _ columns map < text , bigint > , " 
 - + " PRIMARY KEY ( keyspace _ name , columnfamily _ name ) " 
 - + " ) WITH COMMENT = ' ColumnFamily definitions ' AND gc _ grace _ seconds = 8640 " ) ; 
 - 
 - public static final CFMetaData SchemaColumnsCf = compile ( 10 , " CREATE TABLE " + SystemKeyspace . SCHEMA _ COLUMNS _ CF + " ( " 
 - + " keyspace _ name text , " 
 - + " columnfamily _ name text , " 
 - + " column _ name text , " 
 - + " validator text , " 
 - + " index _ type text , " 
 - + " index _ options text , " 
 - + " index _ name text , " 
 - + " component _ index int , " 
 - + " type text , " 
 - + " PRIMARY KEY ( keyspace _ name , columnfamily _ name , column _ name ) " 
 - + " ) WITH COMMENT = ' ColumnFamily column attributes ' AND gc _ grace _ seconds = 8640 " ) ; 
 - 
 - public static final CFMetaData SchemaTriggerCf = compile ( " CREATE TABLE \ " " + SystemKeyspace . SCHEMA _ TRIGGERS _ CF + " \ " ( " 
 - + " keyspace _ name text , " 
 - + " column _ family text , " 
 - + " trigger _ name text , " 
 - + " trigger _ options map < text , text > , " 
 - + " PRIMARY KEY ( keyspace _ name , column _ family , trigger _ name ) " 
 - + " ) WITH COMMENT = ' triggers metadata table ' " ) ; 
 + public static final CFMetaData IndexCf = compile ( " CREATE TABLE \ " " + SystemKeyspace . INDEX _ CF + " \ " ( " 
 + + " table _ name text , " 
 + + " index _ name text , " 
 + + " PRIMARY KEY ( table _ name , index _ name ) " 
 + + " ) WITH COMPACT STORAGE AND COMMENT = ' indexes that have been completed ' " ) ; 
 + 
 + public static final CFMetaData CounterIdCf = compile ( " CREATE TABLE \ " " + SystemKeyspace . COUNTER _ ID _ CF + " \ " ( " 
 + + " key text , " 
 + + " id timeuuid , " 
 + + " PRIMARY KEY ( key , id ) " 
 + + " ) WITH COMPACT STORAGE AND COMMENT = ' counter node IDs ' " ) ; 
 + 
 + public static final CFMetaData SchemaKeyspacesCf = compile ( " CREATE TABLE " + SystemKeyspace . SCHEMA _ KEYSPACES _ CF + " ( " 
 + + " keyspace _ name text PRIMARY KEY , " 
 + + " durable _ writes boolean , " 
 + + " strategy _ class text , " 
 + + " strategy _ options text " 
 + + " ) WITH COMPACT STORAGE AND COMMENT = ' keyspace definitions ' AND gc _ grace _ seconds = 8640 " ) ; 
 + 
 + public static final CFMetaData SchemaColumnFamiliesCf = compile ( " CREATE TABLE " + SystemKeyspace . SCHEMA _ COLUMNFAMILIES _ CF + " ( " 
 + + " keyspace _ name text , " 
 + + " columnfamily _ name text , " 
 + + " type text , " 
 + + " comparator text , " 
 + + " subcomparator text , " 
 + + " comment text , " 
 + + " read _ repair _ chance double , " 
 + + " local _ read _ repair _ chance double , " 
 + + " replicate _ on _ write boolean , " 
 + + " gc _ grace _ seconds int , " 
 + + " default _ validator text , " 
 + + " key _ validator text , " 
 + + " min _ compaction _ threshold int , " 
 + + " max _ compaction _ threshold int , " 
 + + " memtable _ flush _ period _ in _ ms int , " 
 + + " key _ alias text , " / / that one is kept for compatibility sake 
 + + " key _ aliases text , " 
 + + " bloom _ filter _ fp _ chance double , " 
 + + " caching text , " 
 + + " default _ time _ to _ live int , " 
 + + " compaction _ strategy _ class text , " 
 + + " compression _ parameters text , " 
 + + " value _ alias text , " 
 + + " column _ aliases text , " 
 + + " compaction _ strategy _ options text , " 
 + + " default _ read _ consistency text , " 
 + + " default _ write _ consistency text , " 
 + + " speculative _ retry text , " 
 + + " populate _ io _ cache _ on _ flush boolean , " 
 + + " index _ interval int , " 
 + + " dropped _ columns map < text , bigint > , " 
 + + " PRIMARY KEY ( keyspace _ name , columnfamily _ name ) " 
 + + " ) WITH COMMENT = ' ColumnFamily definitions ' AND gc _ grace _ seconds = 8640 " ) ; 
 + 
 + public static final CFMetaData SchemaColumnsCf = compile ( " CREATE TABLE " + SystemKeyspace . SCHEMA _ COLUMNS _ CF + " ( " 
 + + " keyspace _ name text , " 
 + + " columnfamily _ name text , " 
 + + " column _ name text , " 
 + + " validator text , " 
 + + " index _ type text , " 
 + + " index _ options text , " 
 + + " index _ name text , " 
 + + " component _ index int , " 
 + + " type text , " 
 + + " PRIMARY KEY ( keyspace _ name , columnfamily _ name , column _ name ) " 
 + + " ) WITH COMMENT = ' ColumnFamily column attributes ' AND gc _ grace _ seconds = 8640 " ) ; 
 + 
 + public static final CFMetaData SchemaTriggersCf = compile ( " CREATE TABLE " + SystemKeyspace . SCHEMA _ TRIGGERS _ CF + " ( " 
 + + " keyspace _ name text , " 
 + + " columnfamily _ name text , " 
 + + " trigger _ name text , " 
 + + " trigger _ options map < text , text > , " 
 + + " PRIMARY KEY ( keyspace _ name , columnfamily _ name , trigger _ name ) " 
 + + " ) WITH COMMENT = ' triggers metadata table ' " ) ; 
 
 public static final CFMetaData HintsCf = compile ( " CREATE TABLE " + SystemKeyspace . HINTS _ CF + " ( " 
 + " target _ id uuid , " 
 @ @ - 353 , 7 + 352 , 7 @ @ public final class CFMetaData 
 public final String ksName ; / / name of keyspace 
 public final String cfName ; / / name of this column family 
 public final ColumnFamilyType cfType ; / / standard , super 
 - public volatile AbstractType < ? > comparator ; / / bytes , long , timeuuid , utf8 , etc . 
 + public volatile AbstractType < ? > comparator ; / / bytes , long , timeuuid , utf8 , etc . 
 
 / / OPTIONAL 
 private volatile String comment = " " ; 
 @ @ - 372 , 7 + 371 , 7 @ @ public final class CFMetaData 
 private volatile int defaultTimeToLive = DEFAULT _ DEFAULT _ TIME _ TO _ LIVE ; 
 private volatile SpeculativeRetry speculativeRetry = DEFAULT _ SPECULATIVE _ RETRY ; 
 private volatile boolean populateIoCacheOnFlush = DEFAULT _ POPULATE _ IO _ CACHE _ ON _ FLUSH ; 
 - private volatile Map < ByteBuffer , Long > droppedColumns = new HashMap < ByteBuffer , Long > ( ) ; 
 + private volatile Map < ByteBuffer , Long > droppedColumns = new HashMap < > ( ) ; 
 private volatile Map < String , Map < String , String > > triggers = new HashMap < > ( ) ; 
 private volatile Collection < String > cachedTriggers ; 
 
 @ @ - 452 , 19 + 451 , 19 @ @ public final class CFMetaData 
 return new HashMap < > ( triggers ) ; 
 } 
 
 - private static CFMetaData compile ( String cql , String keyspace ) 
 + private static CFMetaData compile ( String cql ) 
 { 
 - return compile ( null , cql , keyspace ) ; 
 + return compile ( cql , Keyspace . SYSTEM _ KS ) ; 
 } 
 
 - private static CFMetaData compile ( Integer id , String cql , String keyspace ) 
 + private static CFMetaData compile ( String cql , String keyspace ) 
 { 
 try 
 { 
 CreateTableStatement statement = ( CreateTableStatement ) QueryProcessor . parseStatement ( cql ) . prepare ( ) . statement ; 
 - CFMetaData cfmd = newSystemMetadata ( keyspace , statement . columnFamily ( ) , " " , statement . comparator , null ) ; 
 - statement . applyPropertiesTo ( cfmd ) ; 
 - return cfmd . rebuild ( ) ; 
 + CFMetaData cfm = newSystemMetadata ( keyspace , statement . columnFamily ( ) , " " , statement . comparator , null ) ; 
 + statement . applyPropertiesTo ( cfm ) ; 
 + return cfm . rebuild ( ) ; 
 } 
 catch ( RequestValidationException e ) 
 { 
 @ @ - 472 , 16 + 471 , 6 @ @ public final class CFMetaData 
 } 
 } 
 
 - private static CFMetaData compile ( String cql ) 
 - { 
 - return compile ( null , cql , Keyspace . SYSTEM _ KS ) ; 
 - } 
 - 
 - private static CFMetaData compile ( int id , String cql ) 
 - { 
 - return compile ( id , cql , Keyspace . SYSTEM _ KS ) ; 
 - } 
 - 
 private static AbstractType < ? > makeComparator ( ColumnFamilyType cftype , AbstractType < ? > comp , AbstractType < ? > subcc ) 
 { 
 return cftype = = ColumnFamilyType . Super 
 @ @ - 1441 , 7 + 1430 , 7 @ @ public final class CFMetaData 
 if ( fromThrift & & cd . type ! = ColumnDefinition . Type . REGULAR ) 
 continue ; 
 
 - cd . deleteFromSchema ( rm , cfName , getColumnDefinitionComparator ( cd ) , modificationTimestamp ) ; 
 + cd . deleteFromSchema ( rm , cfName , modificationTimestamp ) ; 
 } 
 
 / / newly added columns 
 @ @ - 1482 , 12 + 1471 , 12 @ @ public final class CFMetaData 
 cf . addAtom ( new RangeTombstone ( builder . build ( ) , builder . buildAsEndOfRange ( ) , timestamp , ldt ) ) ; 
 
 ColumnFamily tcf = rm . addOrGet ( SystemKeyspace . SCHEMA _ TRIGGERS _ CF ) ; 
 - ColumnNameBuilder tbuilder = SchemaTriggerCf . getCfDef ( ) . getColumnNameBuilder ( ) ; 
 + ColumnNameBuilder tbuilder = SchemaTriggersCf . getCfDef ( ) . getColumnNameBuilder ( ) ; 
 tbuilder . add ( ByteBufferUtil . bytes ( cfName ) ) ; 
 tcf . addAtom ( new RangeTombstone ( tbuilder . build ( ) , tbuilder . buildAsEndOfRange ( ) , timestamp , ldt ) ) ; 
 
 for ( ColumnDefinition cd : column _ metadata . values ( ) ) 
 - cd . deleteFromSchema ( rm , cfName , getColumnDefinitionComparator ( cd ) , timestamp ) ; 
 + cd . deleteFromSchema ( rm , cfName , timestamp ) ; 
 
 return rm ; 
 } 
 @ @ - 1776 , 8 + 1765 , 7 @ @ public final class CFMetaData 
 
 public boolean removeColumnDefinition ( ColumnDefinition def ) 
 { 
 - boolean removed = column _ metadata . remove ( def . name ) ! = null ; 
 - return removed ; 
 + return column _ metadata . remove ( def . name ) ! = null ; 
 } 
 
 public void recordColumnDrop ( ColumnDefinition def ) 
 diff - - git a / src / java / org / apache / cassandra / config / ColumnDefinition . java b / src / java / org / apache / cassandra / config / ColumnDefinition . java 
 index 00a784f . . 6b979b7 100644 
 - - - a / src / java / org / apache / cassandra / config / ColumnDefinition . java 
 + + + b / src / java / org / apache / cassandra / config / ColumnDefinition . java 
 @ @ - 195 , 7 + 195 , 7 @ @ public class ColumnDefinition 
 * @ param cfName The name of the parent ColumnFamily 
 * @ param timestamp The timestamp to use for column modification 
 * / 
 - public void deleteFromSchema ( RowMutation rm , String cfName , AbstractType < ? > comparator , long timestamp ) 
 + public void deleteFromSchema ( RowMutation rm , String cfName , long timestamp ) 
 { 
 ColumnFamily cf = rm . addOrGet ( SystemKeyspace . SCHEMA _ COLUMNS _ CF ) ; 
 int ldt = ( int ) ( System . currentTimeMillis ( ) / 1000 ) ; 
 diff - - git a / src / java / org / apache / cassandra / config / KSMetaData . java b / src / java / org / apache / cassandra / config / KSMetaData . java 
 index 798a688 . . edeb20e 100644 
 - - - a / src / java / org / apache / cassandra / config / KSMetaData . java 
 + + + b / src / java / org / apache / cassandra / config / KSMetaData . java 
 @ @ - 84 , 7 + 84 , 7 @ @ public final class KSMetaData 
 CFMetaData . PeerEventsCf , 
 CFMetaData . HintsCf , 
 CFMetaData . IndexCf , 
 - CFMetaData . SchemaTriggerCf , 
 + CFMetaData . SchemaTriggersCf , 
 CFMetaData . CounterIdCf , 
 CFMetaData . SchemaKeyspacesCf , 
 CFMetaData . SchemaColumnFamiliesCf , 
 diff - - git a / src / java / org / apache / cassandra / config / TriggerOptions . java b / src / java / org / apache / cassandra / config / TriggerOptions . java 
 index 95d99bd . . 7411756 100644 
 - - - a / src / java / org / apache / cassandra / config / TriggerOptions . java 
 + + + b / src / java / org / apache / cassandra / config / TriggerOptions . java 
 @ @ - 43 , 7 + 43 , 7 @ @ public class TriggerOptions 
 
 public static Map < String , Map < String , String > > getAllTriggers ( String ksName , String cfName ) 
 { 
 - String req = " SELECT * FROM system . % s WHERE keyspace _ name = ' % s ' AND column _ family = ' % s ' " ; 
 + String req = " SELECT * FROM system . % s WHERE keyspace _ name = ' % s ' AND columnfamily _ name = ' % s ' " ; 
 UntypedResultSet result = processInternal ( String . format ( req , SystemKeyspace . SCHEMA _ TRIGGERS _ CF , ksName , cfName ) ) ; 
 Map < String , Map < String , String > > triggers = new HashMap < > ( ) ; 
 if ( result . isEmpty ( ) ) 
 @ @ - 57 , 7 + 57 , 7 @ @ public class TriggerOptions 
 { 
 ColumnFamily cf = rm . addOrGet ( SystemKeyspace . SCHEMA _ TRIGGERS _ CF ) ; 
 assert tentry . getValue ( ) . get ( CLASS _ KEY ) ! = null ; 
 - ColumnNameBuilder builder = CFMetaData . SchemaTriggerCf . getCfDef ( ) . getColumnNameBuilder ( ) ; 
 + ColumnNameBuilder builder = CFMetaData . SchemaTriggersCf . getCfDef ( ) . getColumnNameBuilder ( ) ; 
 builder . add ( ByteBufferUtil . bytes ( cfName ) ) . add ( ByteBufferUtil . bytes ( tentry . getKey ( ) ) ) . add ( ByteBufferUtil . bytes ( OPTIONS _ KEY ) ) ; 
 for ( Entry < String , String > entry : tentry . getValue ( ) . entrySet ( ) ) 
 { 
 @ @ - 71 , 7 + 71 , 7 @ @ public class TriggerOptions 
 { 
 ColumnFamily cf = rm . addOrGet ( SystemKeyspace . SCHEMA _ TRIGGERS _ CF ) ; 
 int ldt = ( int ) ( System . currentTimeMillis ( ) / 1000 ) ; 
 - ColumnNameBuilder builder = CFMetaData . SchemaTriggerCf . getCfDef ( ) . getColumnNameBuilder ( ) ; 
 + ColumnNameBuilder builder = CFMetaData . SchemaTriggersCf . getCfDef ( ) . getColumnNameBuilder ( ) ; 
 builder . add ( ByteBufferUtil . bytes ( cfName ) ) . add ( ByteBufferUtil . bytes ( tentry . getKey ( ) ) ) ; 
 cf . addAtom ( new RangeTombstone ( builder . build ( ) , builder . buildAsEndOfRange ( ) , modificationTimestamp , ldt ) ) ; 
 }
