BLEU SCORE: 0.01098475607466579

TEST MSG: Fix merge from CASSANDRA - 8359
GENERATED MSG: change snapshot - before - compaction to only snapshot ( w / o flush ) CFS being compacted

TEST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / db / compaction / DateTieredCompactionStrategy . java b / src / java / org / apache / cassandra / db / compaction / DateTieredCompactionStrategy . java <nl> index 7841c93 . . d955ebf 100644 <nl> - - - a / src / java / org / apache / cassandra / db / compaction / DateTieredCompactionStrategy . java <nl> + + + b / src / java / org / apache / cassandra / db / compaction / DateTieredCompactionStrategy . java <nl> @ @ - 74 , 7 + 74 , 7 @ @ public class DateTieredCompactionStrategy extends AbstractCompactionStrategy <nl> if ( ! isEnabled ( ) | | cfs . getSSTables ( ) . isEmpty ( ) ) <nl> return Collections . emptyList ( ) ; <nl> <nl> - Set < SSTableReader > uncompacting = cfs . getUncompactingSSTables ( ) ; <nl> + Set < SSTableReader > uncompacting = Sets . intersection ( sstables , cfs . getUncompactingSSTables ( ) ) ; <nl> <nl> / / Find fully expired SSTables . Those will be included no matter what . <nl> Set < SSTableReader > expired = CompactionController . getFullyExpiredSSTables ( cfs , uncompacting , cfs . getOverlappingSSTables ( uncompacting ) , gcBefore ) ; <nl> diff - - git a / test / unit / org / apache / cassandra / db / compaction / DateTieredCompactionStrategyTest . java b / test / unit / org / apache / cassandra / db / compaction / DateTieredCompactionStrategyTest . java <nl> index becddeb . . 743a337 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / compaction / DateTieredCompactionStrategyTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / compaction / DateTieredCompactionStrategyTest . java <nl> @ @ - 306 , 6 + 306 , 8 @ @ public class DateTieredCompactionStrategyTest extends SchemaLoader <nl> options . put ( DateTieredCompactionStrategyOptions . TIMESTAMP _ RESOLUTION _ KEY , " MILLISECONDS " ) ; <nl> options . put ( DateTieredCompactionStrategyOptions . MAX _ SSTABLE _ AGE _ KEY , Double . toString ( ( 1d / ( 24 * 60 * 60 ) ) ) ) ; <nl> DateTieredCompactionStrategy dtcs = new DateTieredCompactionStrategy ( cfs , options ) ; <nl> + for ( SSTableReader sstable : cfs . getSSTables ( ) ) <nl> + dtcs . addSSTable ( sstable ) ; <nl> dtcs . startup ( ) ; <nl> assertNull ( dtcs . getNextBackgroundTask ( ( int ) ( System . currentTimeMillis ( ) / 1000 ) ) ) ; <nl> Thread . sleep ( 7000 ) ;
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 7018e57 . . fe04571 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 69 , 6 + 69 , 9 @ @ <nl> * fix system tests ( CASSANDRA - 3827 ) <nl> * CQL support for altering key _ validation _ class in ALTER TABLE ( CASSANDRA - 3781 ) <nl> * turn compression on by default ( CASSANDRA - 3871 ) <nl> + Merged from 1 . 0 : <nl> + * Only snapshot CF being compacted for snapshot _ before _ compaction <nl> + ( CASSANDRA - 3803 ) <nl> <nl> <nl> 1 . 0 . 8 <nl> diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> index b4d1602 . . 85698d6 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> @ @ - 1364 , 7 + 1364 , 7 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean <nl> return metadata . comparator ; <nl> } <nl> <nl> - private void snapshotWithoutFlush ( String snapshotName ) <nl> + public void snapshotWithoutFlush ( String snapshotName ) <nl> { <nl> for ( ColumnFamilyStore cfs : concatWithIndexes ( ) ) <nl> { <nl> diff - - git a / src / java / org / apache / cassandra / db / compaction / CompactionTask . java b / src / java / org / apache / cassandra / db / compaction / CompactionTask . java <nl> index 5b68a2a . . 683241f 100644 <nl> - - - a / src / java / org / apache / cassandra / db / compaction / CompactionTask . java <nl> + + + b / src / java / org / apache / cassandra / db / compaction / CompactionTask . java <nl> @ @ - 102 , 7 + 102 , 7 @ @ public class CompactionTask extends AbstractCompactionTask <nl> } <nl> <nl> if ( DatabaseDescriptor . isSnapshotBeforeCompaction ( ) ) <nl> - cfs . table . snapshot ( System . currentTimeMillis ( ) + " - " + " compact - " + cfs . columnFamily ) ; <nl> + cfs . snapshotWithoutFlush ( System . currentTimeMillis ( ) + " - " + " compact - " + cfs . columnFamily ) ; <nl> <nl> / / sanity check : all sstables must belong to the same cfs <nl> for ( SSTableReader sstable : toCompact )

TEST DIFF:
diff - - git a / src / java / org / apache / cassandra / db / compaction / DateTieredCompactionStrategy . java b / src / java / org / apache / cassandra / db / compaction / DateTieredCompactionStrategy . java 
 index 7841c93 . . d955ebf 100644 
 - - - a / src / java / org / apache / cassandra / db / compaction / DateTieredCompactionStrategy . java 
 + + + b / src / java / org / apache / cassandra / db / compaction / DateTieredCompactionStrategy . java 
 @ @ - 74 , 7 + 74 , 7 @ @ public class DateTieredCompactionStrategy extends AbstractCompactionStrategy 
 if ( ! isEnabled ( ) | | cfs . getSSTables ( ) . isEmpty ( ) ) 
 return Collections . emptyList ( ) ; 
 
 - Set < SSTableReader > uncompacting = cfs . getUncompactingSSTables ( ) ; 
 + Set < SSTableReader > uncompacting = Sets . intersection ( sstables , cfs . getUncompactingSSTables ( ) ) ; 
 
 / / Find fully expired SSTables . Those will be included no matter what . 
 Set < SSTableReader > expired = CompactionController . getFullyExpiredSSTables ( cfs , uncompacting , cfs . getOverlappingSSTables ( uncompacting ) , gcBefore ) ; 
 diff - - git a / test / unit / org / apache / cassandra / db / compaction / DateTieredCompactionStrategyTest . java b / test / unit / org / apache / cassandra / db / compaction / DateTieredCompactionStrategyTest . java 
 index becddeb . . 743a337 100644 
 - - - a / test / unit / org / apache / cassandra / db / compaction / DateTieredCompactionStrategyTest . java 
 + + + b / test / unit / org / apache / cassandra / db / compaction / DateTieredCompactionStrategyTest . java 
 @ @ - 306 , 6 + 306 , 8 @ @ public class DateTieredCompactionStrategyTest extends SchemaLoader 
 options . put ( DateTieredCompactionStrategyOptions . TIMESTAMP _ RESOLUTION _ KEY , " MILLISECONDS " ) ; 
 options . put ( DateTieredCompactionStrategyOptions . MAX _ SSTABLE _ AGE _ KEY , Double . toString ( ( 1d / ( 24 * 60 * 60 ) ) ) ) ; 
 DateTieredCompactionStrategy dtcs = new DateTieredCompactionStrategy ( cfs , options ) ; 
 + for ( SSTableReader sstable : cfs . getSSTables ( ) ) 
 + dtcs . addSSTable ( sstable ) ; 
 dtcs . startup ( ) ; 
 assertNull ( dtcs . getNextBackgroundTask ( ( int ) ( System . currentTimeMillis ( ) / 1000 ) ) ) ; 
 Thread . sleep ( 7000 ) ;

NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 7018e57 . . fe04571 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 69 , 6 + 69 , 9 @ @ 
 * fix system tests ( CASSANDRA - 3827 ) 
 * CQL support for altering key _ validation _ class in ALTER TABLE ( CASSANDRA - 3781 ) 
 * turn compression on by default ( CASSANDRA - 3871 ) 
 + Merged from 1 . 0 : 
 + * Only snapshot CF being compacted for snapshot _ before _ compaction 
 + ( CASSANDRA - 3803 ) 
 
 
 1 . 0 . 8 
 diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 index b4d1602 . . 85698d6 100644 
 - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 @ @ - 1364 , 7 + 1364 , 7 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean 
 return metadata . comparator ; 
 } 
 
 - private void snapshotWithoutFlush ( String snapshotName ) 
 + public void snapshotWithoutFlush ( String snapshotName ) 
 { 
 for ( ColumnFamilyStore cfs : concatWithIndexes ( ) ) 
 { 
 diff - - git a / src / java / org / apache / cassandra / db / compaction / CompactionTask . java b / src / java / org / apache / cassandra / db / compaction / CompactionTask . java 
 index 5b68a2a . . 683241f 100644 
 - - - a / src / java / org / apache / cassandra / db / compaction / CompactionTask . java 
 + + + b / src / java / org / apache / cassandra / db / compaction / CompactionTask . java 
 @ @ - 102 , 7 + 102 , 7 @ @ public class CompactionTask extends AbstractCompactionTask 
 } 
 
 if ( DatabaseDescriptor . isSnapshotBeforeCompaction ( ) ) 
 - cfs . table . snapshot ( System . currentTimeMillis ( ) + " - " + " compact - " + cfs . columnFamily ) ; 
 + cfs . snapshotWithoutFlush ( System . currentTimeMillis ( ) + " - " + " compact - " + cfs . columnFamily ) ; 
 
 / / sanity check : all sstables must belong to the same cfs 
 for ( SSTableReader sstable : toCompact )
