BLEU SCORE: 0.011514383434815713

TEST MSG: fixing Directories instantiations where CFS . initialDirectories should be used
GENERATED MSG: Fix race when opening ColumnFamilyStore ; patch by yukim reviewed by jbellis for CASSANDRA - 5350

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index a59dff1 . . 0cafa83 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 3 . 0 . 7 <nl> + * Fix Directories instantiations where CFS . initialDirectories should be used ( CASSANDRA - 11849 ) <nl> * Avoid referencing DatabaseDescriptor in AbstractType ( CASSANDRA - 11912 ) <nl> * Fix sstables not being protected from removal during index build ( CASSANDRA - 11905 ) <nl> * cqlsh : Suppress stack trace from Read / WriteFailures ( CASSANDRA - 11032 ) <nl> diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> index 7ca6d96 . . 3264327 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> @ @ - 580 , 7 + 580 , 7 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean <nl> * / <nl> public static void scrubDataDirectories ( CFMetaData metadata ) <nl> { <nl> - Directories directories = new Directories ( metadata ) ; <nl> + Directories directories = new Directories ( metadata , initialDirectories ) ; <nl> <nl> / / clear ephemeral snapshots that were not properly cleared last session ( CASSANDRA - 7357 ) <nl> clearEphemeralSnapshots ( directories ) ; <nl> diff - - git a / src / java / org / apache / cassandra / db / lifecycle / LogTransaction . java b / src / java / org / apache / cassandra / db / lifecycle / LogTransaction . java <nl> index ce76165 . . b34ca60 100644 <nl> - - - a / src / java / org / apache / cassandra / db / lifecycle / LogTransaction . java <nl> + + + b / src / java / org / apache / cassandra / db / lifecycle / LogTransaction . java <nl> @ @ - 32 , 6 + 32 , 7 @ @ import org . slf4j . LoggerFactory ; <nl> <nl> import org . apache . cassandra . concurrent . ScheduledExecutors ; <nl> import org . apache . cassandra . config . CFMetaData ; <nl> + import org . apache . cassandra . db . ColumnFamilyStore ; <nl> import org . apache . cassandra . db . Directories ; <nl> import org . apache . cassandra . db . SystemKeyspace ; <nl> import org . apache . cassandra . db . compaction . OperationType ; <nl> @ @ - 385 , 7 + 386 , 7 @ @ class LogTransaction extends Transactional . AbstractTransactional implements Tran <nl> * / <nl> static void removeUnfinishedLeftovers ( CFMetaData metadata ) <nl> { <nl> - removeUnfinishedLeftovers ( new Directories ( metadata ) . getCFDirectories ( ) ) ; <nl> + removeUnfinishedLeftovers ( new Directories ( metadata , ColumnFamilyStore . getInitialDirectories ( ) ) . getCFDirectories ( ) ) ; <nl> } <nl> <nl> @ VisibleForTesting <nl> diff - - git a / src / java / org / apache / cassandra / tools / StandaloneSSTableUtil . java b / src / java / org / apache / cassandra / tools / StandaloneSSTableUtil . java <nl> index 6e2be1d . . 7aa07d0 100644 <nl> - - - a / src / java / org / apache / cassandra / tools / StandaloneSSTableUtil . java <nl> + + + b / src / java / org / apache / cassandra / tools / StandaloneSSTableUtil . java <nl> @ @ - 20 , 6 + 20 , 7 @ @ package org . apache . cassandra . tools ; <nl> <nl> import org . apache . cassandra . config . CFMetaData ; <nl> import org . apache . cassandra . config . Schema ; <nl> + import org . apache . cassandra . db . ColumnFamilyStore ; <nl> import org . apache . cassandra . db . Directories ; <nl> import org . apache . cassandra . db . lifecycle . LifecycleTransaction ; <nl> import org . apache . cassandra . utils . OutputHandler ; <nl> @ @ - 81 , 7 + 82 , 7 @ @ public class StandaloneSSTableUtil <nl> <nl> private static void listFiles ( Options options , CFMetaData metadata , OutputHandler handler ) throws IOException <nl> { <nl> - Directories directories = new Directories ( metadata ) ; <nl> + Directories directories = new Directories ( metadata , ColumnFamilyStore . getInitialDirectories ( ) ) ; <nl> <nl> for ( File dir : directories . getCFDirectories ( ) ) <nl> {
NEAREST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / db / compaction / LeveledManifest . java b / src / java / org / apache / cassandra / db / compaction / LeveledManifest . java <nl> index d241a85 . . 643fe44 100644 <nl> - - - a / src / java / org / apache / cassandra / db / compaction / LeveledManifest . java <nl> + + + b / src / java / org / apache / cassandra / db / compaction / LeveledManifest . java <nl> @ @ - 132 , 9 + 132 , 7 @ @ public class LeveledManifest <nl> / / the level for the added sstables is the max of the removed ones , <nl> / / plus one if the removed were all on the same level <nl> for ( SSTableReader sstable : removed ) <nl> - { <nl> remove ( sstable ) ; <nl> - } <nl> <nl> / / it ' s valid to do a remove w / o an add ( e . g . on truncate ) <nl> if ( ! added . iterator ( ) . hasNext ( ) ) <nl> @ @ - 274 , 9 + 272 , 11 @ @ public class LeveledManifest <nl> return Collections . emptyList ( ) ; <nl> } <nl> <nl> - public int getLevelSize ( int i ) <nl> + public synchronized int getLevelSize ( int i ) <nl> { <nl> - return generations . length > i ? generations [ i ] . size ( ) : 0 ; <nl> + if ( i > generations . length ) <nl> + throw new ArrayIndexOutOfBoundsException ( " Maximum valid generation is " + ( generations . length - 1 ) ) ; <nl> + return generations [ i ] . size ( ) ; <nl> } <nl> <nl> public synchronized int [ ] getAllLevelSize ( )

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index a59dff1 . . 0cafa83 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 3 . 0 . 7 
 + * Fix Directories instantiations where CFS . initialDirectories should be used ( CASSANDRA - 11849 ) 
 * Avoid referencing DatabaseDescriptor in AbstractType ( CASSANDRA - 11912 ) 
 * Fix sstables not being protected from removal during index build ( CASSANDRA - 11905 ) 
 * cqlsh : Suppress stack trace from Read / WriteFailures ( CASSANDRA - 11032 ) 
 diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 index 7ca6d96 . . 3264327 100644 
 - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 @ @ - 580 , 7 + 580 , 7 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean 
 * / 
 public static void scrubDataDirectories ( CFMetaData metadata ) 
 { 
 - Directories directories = new Directories ( metadata ) ; 
 + Directories directories = new Directories ( metadata , initialDirectories ) ; 
 
 / / clear ephemeral snapshots that were not properly cleared last session ( CASSANDRA - 7357 ) 
 clearEphemeralSnapshots ( directories ) ; 
 diff - - git a / src / java / org / apache / cassandra / db / lifecycle / LogTransaction . java b / src / java / org / apache / cassandra / db / lifecycle / LogTransaction . java 
 index ce76165 . . b34ca60 100644 
 - - - a / src / java / org / apache / cassandra / db / lifecycle / LogTransaction . java 
 + + + b / src / java / org / apache / cassandra / db / lifecycle / LogTransaction . java 
 @ @ - 32 , 6 + 32 , 7 @ @ import org . slf4j . LoggerFactory ; 
 
 import org . apache . cassandra . concurrent . ScheduledExecutors ; 
 import org . apache . cassandra . config . CFMetaData ; 
 + import org . apache . cassandra . db . ColumnFamilyStore ; 
 import org . apache . cassandra . db . Directories ; 
 import org . apache . cassandra . db . SystemKeyspace ; 
 import org . apache . cassandra . db . compaction . OperationType ; 
 @ @ - 385 , 7 + 386 , 7 @ @ class LogTransaction extends Transactional . AbstractTransactional implements Tran 
 * / 
 static void removeUnfinishedLeftovers ( CFMetaData metadata ) 
 { 
 - removeUnfinishedLeftovers ( new Directories ( metadata ) . getCFDirectories ( ) ) ; 
 + removeUnfinishedLeftovers ( new Directories ( metadata , ColumnFamilyStore . getInitialDirectories ( ) ) . getCFDirectories ( ) ) ; 
 } 
 
 @ VisibleForTesting 
 diff - - git a / src / java / org / apache / cassandra / tools / StandaloneSSTableUtil . java b / src / java / org / apache / cassandra / tools / StandaloneSSTableUtil . java 
 index 6e2be1d . . 7aa07d0 100644 
 - - - a / src / java / org / apache / cassandra / tools / StandaloneSSTableUtil . java 
 + + + b / src / java / org / apache / cassandra / tools / StandaloneSSTableUtil . java 
 @ @ - 20 , 6 + 20 , 7 @ @ package org . apache . cassandra . tools ; 
 
 import org . apache . cassandra . config . CFMetaData ; 
 import org . apache . cassandra . config . Schema ; 
 + import org . apache . cassandra . db . ColumnFamilyStore ; 
 import org . apache . cassandra . db . Directories ; 
 import org . apache . cassandra . db . lifecycle . LifecycleTransaction ; 
 import org . apache . cassandra . utils . OutputHandler ; 
 @ @ - 81 , 7 + 82 , 7 @ @ public class StandaloneSSTableUtil 
 
 private static void listFiles ( Options options , CFMetaData metadata , OutputHandler handler ) throws IOException 
 { 
 - Directories directories = new Directories ( metadata ) ; 
 + Directories directories = new Directories ( metadata , ColumnFamilyStore . getInitialDirectories ( ) ) ; 
 
 for ( File dir : directories . getCFDirectories ( ) ) 
 {

NEAREST DIFF:
diff - - git a / src / java / org / apache / cassandra / db / compaction / LeveledManifest . java b / src / java / org / apache / cassandra / db / compaction / LeveledManifest . java 
 index d241a85 . . 643fe44 100644 
 - - - a / src / java / org / apache / cassandra / db / compaction / LeveledManifest . java 
 + + + b / src / java / org / apache / cassandra / db / compaction / LeveledManifest . java 
 @ @ - 132 , 9 + 132 , 7 @ @ public class LeveledManifest 
 / / the level for the added sstables is the max of the removed ones , 
 / / plus one if the removed were all on the same level 
 for ( SSTableReader sstable : removed ) 
 - { 
 remove ( sstable ) ; 
 - } 
 
 / / it ' s valid to do a remove w / o an add ( e . g . on truncate ) 
 if ( ! added . iterator ( ) . hasNext ( ) ) 
 @ @ - 274 , 9 + 272 , 11 @ @ public class LeveledManifest 
 return Collections . emptyList ( ) ; 
 } 
 
 - public int getLevelSize ( int i ) 
 + public synchronized int getLevelSize ( int i ) 
 { 
 - return generations . length > i ? generations [ i ] . size ( ) : 0 ; 
 + if ( i > generations . length ) 
 + throw new ArrayIndexOutOfBoundsException ( " Maximum valid generation is " + ( generations . length - 1 ) ) ; 
 + return generations [ i ] . size ( ) ; 
 } 
 
 public synchronized int [ ] getAllLevelSize ( )
