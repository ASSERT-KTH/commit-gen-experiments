BLEU SCORE: 0.037477767366779206

TEST MSG: Avoid race - prone second " scrub " of system keyspace
GENERATED MSG: Fix pessimistic unit tests post - 4671

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 8eb10cd . . 19cedd8 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 2 . 0 . 6 <nl> + * Avoid race - prone second " scrub " of system keyspace ( CASSANDRA - 6797 ) <nl> * Pool CqlRecordWriter clients by inetaddress rather than Range <nl> ( CASSANDRA - 6665 ) <nl> * Fix compaction _ history timestamps ( CASSANDRA - 6784 ) <nl> diff - - git a / src / java / org / apache / cassandra / service / CassandraDaemon . java b / src / java / org / apache / cassandra / service / CassandraDaemon . java <nl> index b3f7ff3 . . d8c56f1 100644 <nl> - - - a / src / java / org / apache / cassandra / service / CassandraDaemon . java <nl> + + + b / src / java / org / apache / cassandra / service / CassandraDaemon . java <nl> @ @ - 264 , 6 + 264 , 10 @ @ public class CassandraDaemon <nl> / / clean up debris in the rest of the keyspaces <nl> for ( String keyspaceName : Schema . instance . getKeyspaces ( ) ) <nl> { <nl> + / / Skip system as we ' ve already cleaned it <nl> + if ( keyspaceName . equals ( Keyspace . SYSTEM _ KS ) ) <nl> + continue ; <nl> + <nl> for ( CFMetaData cfm : Schema . instance . getKeyspaceMetaData ( keyspaceName ) . values ( ) ) <nl> ColumnFamilyStore . scrubDataDirectories ( keyspaceName , cfm . cfName ) ; <nl> }
NEAREST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / tools / NodeProbe . java b / src / java / org / apache / cassandra / tools / NodeProbe . java <nl> index 45f6e18 . . ed93359 100644 <nl> - - - a / src / java / org / apache / cassandra / tools / NodeProbe . java <nl> + + + b / src / java / org / apache / cassandra / tools / NodeProbe . java <nl> @ @ - 814 , 8 + 814 , 6 @ @ class ColumnFamilyStoreMBeanIterator implements Iterator < Map . Entry < String , Colum <nl> return tableCmp ; <nl> <nl> / / get CF name and split it for index name <nl> - String q = e1 . getValue ( ) . getColumnFamilyName ( ) ; <nl> - String h = e2 . getValue ( ) . getColumnFamilyName ( ) ; <nl> String e1CF [ ] = e1 . getValue ( ) . getColumnFamilyName ( ) . split ( " \ \ . " ) ; <nl> String e2CF [ ] = e1 . getValue ( ) . getColumnFamilyName ( ) . split ( " \ \ . " ) ; <nl> assert e1CF . length < = 2 & & e2CF . length < = 2 : " unexpected split count for column family name " ;

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 8eb10cd . . 19cedd8 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 2 . 0 . 6 
 + * Avoid race - prone second " scrub " of system keyspace ( CASSANDRA - 6797 ) 
 * Pool CqlRecordWriter clients by inetaddress rather than Range 
 ( CASSANDRA - 6665 ) 
 * Fix compaction _ history timestamps ( CASSANDRA - 6784 ) 
 diff - - git a / src / java / org / apache / cassandra / service / CassandraDaemon . java b / src / java / org / apache / cassandra / service / CassandraDaemon . java 
 index b3f7ff3 . . d8c56f1 100644 
 - - - a / src / java / org / apache / cassandra / service / CassandraDaemon . java 
 + + + b / src / java / org / apache / cassandra / service / CassandraDaemon . java 
 @ @ - 264 , 6 + 264 , 10 @ @ public class CassandraDaemon 
 / / clean up debris in the rest of the keyspaces 
 for ( String keyspaceName : Schema . instance . getKeyspaces ( ) ) 
 { 
 + / / Skip system as we ' ve already cleaned it 
 + if ( keyspaceName . equals ( Keyspace . SYSTEM _ KS ) ) 
 + continue ; 
 + 
 for ( CFMetaData cfm : Schema . instance . getKeyspaceMetaData ( keyspaceName ) . values ( ) ) 
 ColumnFamilyStore . scrubDataDirectories ( keyspaceName , cfm . cfName ) ; 
 }

NEAREST DIFF:
diff - - git a / src / java / org / apache / cassandra / tools / NodeProbe . java b / src / java / org / apache / cassandra / tools / NodeProbe . java 
 index 45f6e18 . . ed93359 100644 
 - - - a / src / java / org / apache / cassandra / tools / NodeProbe . java 
 + + + b / src / java / org / apache / cassandra / tools / NodeProbe . java 
 @ @ - 814 , 8 + 814 , 6 @ @ class ColumnFamilyStoreMBeanIterator implements Iterator < Map . Entry < String , Colum 
 return tableCmp ; 
 
 / / get CF name and split it for index name 
 - String q = e1 . getValue ( ) . getColumnFamilyName ( ) ; 
 - String h = e2 . getValue ( ) . getColumnFamilyName ( ) ; 
 String e1CF [ ] = e1 . getValue ( ) . getColumnFamilyName ( ) . split ( " \ \ . " ) ; 
 String e2CF [ ] = e1 . getValue ( ) . getColumnFamilyName ( ) . split ( " \ \ . " ) ; 
 assert e1CF . length < = 2 & & e2CF . length < = 2 : " unexpected split count for column family name " ;
