BLEU SCORE: 0.08116697886877475

TEST MSG: fixed bug in CompactionManager . needsCleanup
GENERATED MSG: merge from 1 . 1

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 42dc4ee . . 3531737 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 4 , 7 + 4 , 7 @ @ <nl> * Fix accounting in FileCacheService to allow re - using RAR ( CASSANDRA - 6838 ) <nl> * Fix static counter columns ( CASSANDRA - 6827 ) <nl> * Restore expiring - > deleted ( cell ) compaction optimization ( CASSANDRA - 6844 ) <nl> - <nl> + * Fix CompactionManager . needsCleanup ( CASSANDRA - 6845 ) <nl> <nl> 2 . 0 . 6 <nl> * Avoid race - prone second " scrub " of system keyspace ( CASSANDRA - 6797 ) <nl> diff - - git a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java <nl> index 02cf433 . . 453176e 100644 <nl> - - - a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java <nl> + + + b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java <nl> @ @ - 493 , 7 + 493 , 7 @ @ public class CompactionManager implements CompactionManagerMBean <nl> return false ; <nl> } <nl> <nl> - if ( i = = ( ownedRanges . size ( ) - 1 ) ) <nl> + if ( i = = ( sortedRanges . size ( ) - 1 ) ) <nl> { <nl> / / we ' re at the last range and we found a key beyond the end of the range <nl> return true ;
NEAREST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / db / HintedHandOffManager . java b / src / java / org / apache / cassandra / db / HintedHandOffManager . java <nl> index a83fbab . . e2dc046 100644 <nl> - - - a / src / java / org / apache / cassandra / db / HintedHandOffManager . java <nl> + + + b / src / java / org / apache / cassandra / db / HintedHandOffManager . java <nl> @ @ - 391 , 7 + 391 , 9 @ @ public class HintedHandOffManager implements HintedHandOffManagerMBean <nl> { <nl> Token < ? > token = StorageService . getPartitioner ( ) . getTokenFactory ( ) . fromByteArray ( row . key . key ) ; <nl> InetAddress target = StorageService . instance . getTokenMetadata ( ) . getEndpoint ( token ) ; <nl> - scheduleHintDelivery ( target ) ; <nl> + / / token may have since been removed ( in which case we have just read back a tombstone ) <nl> + if ( target ! = null ) <nl> + scheduleHintDelivery ( target ) ; <nl> } <nl> <nl> if ( logger _ . isDebugEnabled ( ) )

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 42dc4ee . . 3531737 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 4 , 7 + 4 , 7 @ @ 
 * Fix accounting in FileCacheService to allow re - using RAR ( CASSANDRA - 6838 ) 
 * Fix static counter columns ( CASSANDRA - 6827 ) 
 * Restore expiring - > deleted ( cell ) compaction optimization ( CASSANDRA - 6844 ) 
 - 
 + * Fix CompactionManager . needsCleanup ( CASSANDRA - 6845 ) 
 
 2 . 0 . 6 
 * Avoid race - prone second " scrub " of system keyspace ( CASSANDRA - 6797 ) 
 diff - - git a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java 
 index 02cf433 . . 453176e 100644 
 - - - a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java 
 + + + b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java 
 @ @ - 493 , 7 + 493 , 7 @ @ public class CompactionManager implements CompactionManagerMBean 
 return false ; 
 } 
 
 - if ( i = = ( ownedRanges . size ( ) - 1 ) ) 
 + if ( i = = ( sortedRanges . size ( ) - 1 ) ) 
 { 
 / / we ' re at the last range and we found a key beyond the end of the range 
 return true ;

NEAREST DIFF:
diff - - git a / src / java / org / apache / cassandra / db / HintedHandOffManager . java b / src / java / org / apache / cassandra / db / HintedHandOffManager . java 
 index a83fbab . . e2dc046 100644 
 - - - a / src / java / org / apache / cassandra / db / HintedHandOffManager . java 
 + + + b / src / java / org / apache / cassandra / db / HintedHandOffManager . java 
 @ @ - 391 , 7 + 391 , 9 @ @ public class HintedHandOffManager implements HintedHandOffManagerMBean 
 { 
 Token < ? > token = StorageService . getPartitioner ( ) . getTokenFactory ( ) . fromByteArray ( row . key . key ) ; 
 InetAddress target = StorageService . instance . getTokenMetadata ( ) . getEndpoint ( token ) ; 
 - scheduleHintDelivery ( target ) ; 
 + / / token may have since been removed ( in which case we have just read back a tombstone ) 
 + if ( target ! = null ) 
 + scheduleHintDelivery ( target ) ; 
 } 
 
 if ( logger _ . isDebugEnabled ( ) )
