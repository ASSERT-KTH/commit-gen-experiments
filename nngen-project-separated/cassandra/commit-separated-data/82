BLEU SCORE: 0.021597011339333432

TEST MSG: Static deletions are corrupted in 3 . 0 - > 2 . { 1 , 2 } messages ( again )
GENERATED MSG: Fix out - of - space error treatment in memtable flushing

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 12c16b7 . . 037e2a8 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 3 . 0 . 18 <nl> + * Fix corrupted static collection deletions in 3 . 0 < - > 2 . { 1 , 2 } messages ( CASSANDRA - 14568 ) <nl> * Handle failures in parallelAllSSTableOperation ( cleanup / upgradesstables / etc ) ( CASSANDRA - 14657 ) <nl> * Improve TokenMetaData cache populating performance avoid long locking ( CASSANDRA - 14660 ) <nl> * Fix static column order for SELECT * wildcard queries ( CASSANDRA - 14638 ) <nl> diff - - git a / src / java / org / apache / cassandra / db / LegacyLayout . java b / src / java / org / apache / cassandra / db / LegacyLayout . java <nl> index e0f66e3 . . 2115c7d 100644 <nl> - - - a / src / java / org / apache / cassandra / db / LegacyLayout . java <nl> + + + b / src / java / org / apache / cassandra / db / LegacyLayout . java <nl> @ @ - 25 , 7 + 25 , 6 @ @ import java . security . MessageDigest ; <nl> import java . util . * ; <nl> <nl> import org . apache . cassandra . cql3 . SuperColumnCompatibility ; <nl> - import org . apache . cassandra . thrift . Column ; <nl> import org . apache . cassandra . utils . AbstractIterator ; <nl> import com . google . common . collect . Iterators ; <nl> import com . google . common . collect . Lists ; <nl> @ @ - 46 , 6 + 45 , 7 @ @ import org . apache . cassandra . utils . * ; <nl> import org . slf4j . Logger ; <nl> import org . slf4j . LoggerFactory ; <nl> <nl> + import static com . google . common . collect . Iterables . all ; <nl> import static org . apache . cassandra . utils . ByteBufferUtil . bytes ; <nl> <nl> / * * <nl> @ @ - 201 , 16 + 201 , 19 @ @ public abstract class LegacyLayout <nl> List < ByteBuffer > components = CompositeType . splitName ( bound ) ; <nl> byte eoc = CompositeType . lastEOC ( bound ) ; <nl> <nl> + / / if the bound we have decoded is static , 2 . 2 format requires there to be N empty clusterings <nl> + assert ! isStatic | | <nl> + ( components . size ( ) > = clusteringSize <nl> + & & all ( components . subList ( 0 , clusteringSize ) , ByteBufferUtil . EMPTY _ BYTE _ BUFFER : : equals ) ) ; <nl> / / There can be more components than the clustering size only in the case this is the bound of a collection <nl> / / range tombstone . In which case , there is exactly one more component , and that component is the name of the <nl> / / collection being selected / deleted . <nl> - assert components . size ( ) < = clusteringSize | | ( ! metadata . isCompactTable ( ) & & components . size ( ) = = clusteringSize + 1 ) ; <nl> - <nl> ColumnDefinition collectionName = null ; <nl> - if ( components . size ( ) > ( isStatic ? 0 : clusteringSize ) ) <nl> + if ( components . size ( ) > clusteringSize ) <nl> { <nl> + assert clusteringSize + 1 = = components . size ( ) & & ! metadata . isCompactTable ( ) ; <nl> / / pop the collection name from the back of the list of clusterings <nl> - ByteBuffer collectionNameBytes = components . remove ( isStatic ? 0 : clusteringSize ) ; <nl> + ByteBuffer collectionNameBytes = components . remove ( clusteringSize ) ; <nl> collectionName = metadata . getColumnDefinition ( collectionNameBytes ) ; <nl> } <nl> <nl> @ @ - 799 , 12 + 802 , 18 @ @ public abstract class LegacyLayout <nl> if ( ! delTime . isLive ( ) ) <nl> { <nl> Clustering clustering = row . clustering ( ) ; <nl> + boolean isStatic = clustering = = Clustering . STATIC _ CLUSTERING ; <nl> + assert isStatic = = col . isStatic ( ) ; <nl> <nl> - Slice . Bound startBound = Slice . Bound . inclusiveStartOf ( clustering ) ; <nl> - Slice . Bound endBound = Slice . Bound . inclusiveEndOf ( clustering ) ; <nl> + Slice . Bound startBound = isStatic <nl> + ? LegacyDeletionInfo . staticBound ( metadata , true ) <nl> + : Slice . Bound . inclusiveStartOf ( clustering ) ; <nl> + Slice . Bound endBound = isStatic <nl> + ? LegacyDeletionInfo . staticBound ( metadata , false ) <nl> + : Slice . Bound . inclusiveEndOf ( clustering ) ; <nl> <nl> - LegacyLayout . LegacyBound start = new LegacyLayout . LegacyBound ( startBound , col . isStatic ( ) , col ) ; <nl> - LegacyLayout . LegacyBound end = new LegacyLayout . LegacyBound ( endBound , col . isStatic ( ) , col ) ; <nl> + LegacyLayout . LegacyBound start = new LegacyLayout . LegacyBound ( startBound , isStatic , col ) ; <nl> + LegacyLayout . LegacyBound end = new LegacyLayout . LegacyBound ( endBound , isStatic , col ) ; <nl> <nl> deletions . add ( start , end , delTime . markedForDeleteAt ( ) , delTime . localDeletionTime ( ) ) ; <nl> } <nl> @ @ - 1496 , 6 + 1505 , 12 @ @ public abstract class LegacyLayout <nl> { <nl> public boolean isCell ( ) ; <nl> <nl> + / / note that for static atoms , LegacyCell and LegacyRangeTombstone behave differently here : <nl> + / / - LegacyCell returns the modern Clustering . STATIC _ CLUSTERING <nl> + / / - LegacyRangeTombstone returns the 2 . 2 bound ( i . e . N empty ByteBuffer , where N is number of clusterings ) <nl> + / / in LegacyDeletionInfo . add ( ) , we split any LRT with a static bound out into the inRowRangeTombstones collection <nl> + / / these are merged with regular row cells , in the CellGrouper , and their clustering is obtained via start . bound . getAsClustering <nl> + / / ( also , it should be impossibly to issue raw static row deletions anyway ) <nl> public ClusteringPrefix clustering ( ) ; <nl> public boolean isStatic ( ) ; <nl> <nl> @ @ - 1689 , 6 + 1704 , 7 @ @ public abstract class LegacyLayout <nl> this . deletionTime = deletionTime ; <nl> } <nl> <nl> + / * * @ see LegacyAtom # clustering for static inconsistencies explained * / <nl> public ClusteringPrefix clustering ( ) <nl> { <nl> return start . bound ; <nl> diff - - git a / test / unit / org / apache / cassandra / db / LegacyLayoutTest . java b / test / unit / org / apache / cassandra / db / LegacyLayoutTest . java <nl> index 44d8a70 . . ce818c0 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / LegacyLayoutTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / LegacyLayoutTest . java <nl> @ @ - 187 , 7 + 187 , 6 @ @ public class LegacyLayoutTest <nl> } <nl> } <nl> <nl> - <nl> @ Test <nl> public void testStaticRangeTombstoneRoundTripUnexpectedDeletion ( ) throws Throwable <nl> {
NEAREST DIFF (one line): ELIMINATEDSENTENCE

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 12c16b7 . . 037e2a8 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 3 . 0 . 18 
 + * Fix corrupted static collection deletions in 3 . 0 < - > 2 . { 1 , 2 } messages ( CASSANDRA - 14568 ) 
 * Handle failures in parallelAllSSTableOperation ( cleanup / upgradesstables / etc ) ( CASSANDRA - 14657 ) 
 * Improve TokenMetaData cache populating performance avoid long locking ( CASSANDRA - 14660 ) 
 * Fix static column order for SELECT * wildcard queries ( CASSANDRA - 14638 ) 
 diff - - git a / src / java / org / apache / cassandra / db / LegacyLayout . java b / src / java / org / apache / cassandra / db / LegacyLayout . java 
 index e0f66e3 . . 2115c7d 100644 
 - - - a / src / java / org / apache / cassandra / db / LegacyLayout . java 
 + + + b / src / java / org / apache / cassandra / db / LegacyLayout . java 
 @ @ - 25 , 7 + 25 , 6 @ @ import java . security . MessageDigest ; 
 import java . util . * ; 
 
 import org . apache . cassandra . cql3 . SuperColumnCompatibility ; 
 - import org . apache . cassandra . thrift . Column ; 
 import org . apache . cassandra . utils . AbstractIterator ; 
 import com . google . common . collect . Iterators ; 
 import com . google . common . collect . Lists ; 
 @ @ - 46 , 6 + 45 , 7 @ @ import org . apache . cassandra . utils . * ; 
 import org . slf4j . Logger ; 
 import org . slf4j . LoggerFactory ; 
 
 + import static com . google . common . collect . Iterables . all ; 
 import static org . apache . cassandra . utils . ByteBufferUtil . bytes ; 
 
 / * * 
 @ @ - 201 , 16 + 201 , 19 @ @ public abstract class LegacyLayout 
 List < ByteBuffer > components = CompositeType . splitName ( bound ) ; 
 byte eoc = CompositeType . lastEOC ( bound ) ; 
 
 + / / if the bound we have decoded is static , 2 . 2 format requires there to be N empty clusterings 
 + assert ! isStatic | | 
 + ( components . size ( ) > = clusteringSize 
 + & & all ( components . subList ( 0 , clusteringSize ) , ByteBufferUtil . EMPTY _ BYTE _ BUFFER : : equals ) ) ; 
 / / There can be more components than the clustering size only in the case this is the bound of a collection 
 / / range tombstone . In which case , there is exactly one more component , and that component is the name of the 
 / / collection being selected / deleted . 
 - assert components . size ( ) < = clusteringSize | | ( ! metadata . isCompactTable ( ) & & components . size ( ) = = clusteringSize + 1 ) ; 
 - 
 ColumnDefinition collectionName = null ; 
 - if ( components . size ( ) > ( isStatic ? 0 : clusteringSize ) ) 
 + if ( components . size ( ) > clusteringSize ) 
 { 
 + assert clusteringSize + 1 = = components . size ( ) & & ! metadata . isCompactTable ( ) ; 
 / / pop the collection name from the back of the list of clusterings 
 - ByteBuffer collectionNameBytes = components . remove ( isStatic ? 0 : clusteringSize ) ; 
 + ByteBuffer collectionNameBytes = components . remove ( clusteringSize ) ; 
 collectionName = metadata . getColumnDefinition ( collectionNameBytes ) ; 
 } 
 
 @ @ - 799 , 12 + 802 , 18 @ @ public abstract class LegacyLayout 
 if ( ! delTime . isLive ( ) ) 
 { 
 Clustering clustering = row . clustering ( ) ; 
 + boolean isStatic = clustering = = Clustering . STATIC _ CLUSTERING ; 
 + assert isStatic = = col . isStatic ( ) ; 
 
 - Slice . Bound startBound = Slice . Bound . inclusiveStartOf ( clustering ) ; 
 - Slice . Bound endBound = Slice . Bound . inclusiveEndOf ( clustering ) ; 
 + Slice . Bound startBound = isStatic 
 + ? LegacyDeletionInfo . staticBound ( metadata , true ) 
 + : Slice . Bound . inclusiveStartOf ( clustering ) ; 
 + Slice . Bound endBound = isStatic 
 + ? LegacyDeletionInfo . staticBound ( metadata , false ) 
 + : Slice . Bound . inclusiveEndOf ( clustering ) ; 
 
 - LegacyLayout . LegacyBound start = new LegacyLayout . LegacyBound ( startBound , col . isStatic ( ) , col ) ; 
 - LegacyLayout . LegacyBound end = new LegacyLayout . LegacyBound ( endBound , col . isStatic ( ) , col ) ; 
 + LegacyLayout . LegacyBound start = new LegacyLayout . LegacyBound ( startBound , isStatic , col ) ; 
 + LegacyLayout . LegacyBound end = new LegacyLayout . LegacyBound ( endBound , isStatic , col ) ; 
 
 deletions . add ( start , end , delTime . markedForDeleteAt ( ) , delTime . localDeletionTime ( ) ) ; 
 } 
 @ @ - 1496 , 6 + 1505 , 12 @ @ public abstract class LegacyLayout 
 { 
 public boolean isCell ( ) ; 
 
 + / / note that for static atoms , LegacyCell and LegacyRangeTombstone behave differently here : 
 + / / - LegacyCell returns the modern Clustering . STATIC _ CLUSTERING 
 + / / - LegacyRangeTombstone returns the 2 . 2 bound ( i . e . N empty ByteBuffer , where N is number of clusterings ) 
 + / / in LegacyDeletionInfo . add ( ) , we split any LRT with a static bound out into the inRowRangeTombstones collection 
 + / / these are merged with regular row cells , in the CellGrouper , and their clustering is obtained via start . bound . getAsClustering 
 + / / ( also , it should be impossibly to issue raw static row deletions anyway ) 
 public ClusteringPrefix clustering ( ) ; 
 public boolean isStatic ( ) ; 
 
 @ @ - 1689 , 6 + 1704 , 7 @ @ public abstract class LegacyLayout 
 this . deletionTime = deletionTime ; 
 } 
 
 + / * * @ see LegacyAtom # clustering for static inconsistencies explained * / 
 public ClusteringPrefix clustering ( ) 
 { 
 return start . bound ; 
 diff - - git a / test / unit / org / apache / cassandra / db / LegacyLayoutTest . java b / test / unit / org / apache / cassandra / db / LegacyLayoutTest . java 
 index 44d8a70 . . ce818c0 100644 
 - - - a / test / unit / org / apache / cassandra / db / LegacyLayoutTest . java 
 + + + b / test / unit / org / apache / cassandra / db / LegacyLayoutTest . java 
 @ @ - 187 , 7 + 187 , 6 @ @ public class LegacyLayoutTest 
 } 
 } 
 
 - 
 @ Test 
 public void testStaticRangeTombstoneRoundTripUnexpectedDeletion ( ) throws Throwable 
 {

NEAREST DIFF:
ELIMINATEDSENTENCE
