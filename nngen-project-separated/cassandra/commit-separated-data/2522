BLEU SCORE: 0.027611988917697356

TEST MSG: Optimize Cell liveness checks and clean up Cell
GENERATED MSG: merge from 0 . 8

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index a4811f6 . . 34533cc 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 55 , 6 + 55 , 7 @ @ <nl> * Multi - threaded scrub / cleanup / upgradesstables ( CASSANDRA - 5547 ) <nl> * Optimize cellname comparison ( CASSANDRA - 6934 ) <nl> * Native protocol v3 ( CASSANDRA - 6855 ) <nl> + * Optimize Cell liveness checks and clean up Cell ( CASSANDRA - 7119 ) <nl> Merged from 2 . 0 : <nl> * Allow overriding cassandra - rackdc . properties file ( CASSANDRA - 7072 ) <nl> * Set JMX RMI port to 7199 ( CASSANDRA - 7087 ) <nl> diff - - git a / src / java / org / apache / cassandra / cql / QueryProcessor . java b / src / java / org / apache / cassandra / cql / QueryProcessor . java <nl> index 3b35555 . . 3c1d555 100644 <nl> - - - a / src / java / org / apache / cassandra / cql / QueryProcessor . java <nl> + + + b / src / java / org / apache / cassandra / cql / QueryProcessor . java <nl> @ @ - 469 , 7 + 469 , 7 @ @ public class QueryProcessor <nl> { <nl> for ( org . apache . cassandra . db . Cell c : row . cf . getSortedColumns ( ) ) <nl> { <nl> - if ( c . isMarkedForDelete ( now ) ) <nl> + if ( ! c . isLive ( now ) ) <nl> continue ; <nl> <nl> ColumnDefinition cd = metadata . getColumnDefinition ( c . name ( ) ) ; <nl> @ @ - 515 , 7 + 515 , 7 @ @ public class QueryProcessor <nl> if ( cd ! = null ) <nl> result . schema . value _ types . put ( nameBytes , TypeParser . getShortName ( cd . type ) ) ; <nl> org . apache . cassandra . db . Cell c = row . cf . getColumn ( name ) ; <nl> - if ( c = = null | | c . isMarkedForDelete ( System . currentTimeMillis ( ) ) ) <nl> + if ( c = = null | | ! c . isLive ( ) ) <nl> thriftColumns . add ( new Column ( ) . setName ( nameBytes ) ) ; <nl> else <nl> thriftColumns . add ( thriftify ( c ) ) ; <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / Selection . java b / src / java / org / apache / cassandra / cql3 / statements / Selection . java <nl> index c506cc6 . . af1e621 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / Selection . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / Selection . java <nl> @ @ - 315 , 7 + 315 , 7 @ @ public abstract class Selection <nl> <nl> private boolean isDead ( Cell c ) <nl> { <nl> - return c = = null | | c . isMarkedForDelete ( now ) ; <nl> + return c = = null | | ! c . isLive ( now ) ; <nl> } <nl> <nl> public void newRow ( ) throws InvalidRequestException <nl> diff - - git a / src / java / org / apache / cassandra / db / AbstractCell . java b / src / java / org / apache / cassandra / db / AbstractCell . java <nl> index 1075278 . . 238b8c0 100644 <nl> - - - a / src / java / org / apache / cassandra / db / AbstractCell . java <nl> + + + b / src / java / org / apache / cassandra / db / AbstractCell . java <nl> @ @ - 63 , 32 + 63 , 21 @ @ public abstract class AbstractCell implements Cell <nl> } ; <nl> } <nl> <nl> - @ Override <nl> - public boolean isMarkedForDelete ( long now ) <nl> + public boolean isLive ( ) <nl> { <nl> - return false ; <nl> + return true ; <nl> } <nl> <nl> - @ Override <nl> public boolean isLive ( long now ) <nl> { <nl> - return ! isMarkedForDelete ( now ) ; <nl> - } <nl> - <nl> - / / Don ' t call unless the column is actually marked for delete . <nl> - @ Override <nl> - public long getMarkedForDeleteAt ( ) <nl> - { <nl> - return Long . MAX _ VALUE ; <nl> + return true ; <nl> } <nl> <nl> - @ Override <nl> public int cellDataSize ( ) <nl> { <nl> return name ( ) . dataSize ( ) + value ( ) . remaining ( ) + TypeSizes . NATIVE . sizeof ( timestamp ( ) ) ; <nl> } <nl> <nl> - @ Override <nl> public int serializedSize ( CellNameType type , TypeSizes typeSizes ) <nl> { <nl> / * <nl> @ @ - 103 , 13 + 92 , 11 @ @ public abstract class AbstractCell implements Cell <nl> return ( ( int ) type . cellSerializer ( ) . serializedSize ( name ( ) , typeSizes ) ) + 1 + typeSizes . sizeof ( timestamp ( ) ) + typeSizes . sizeof ( valueSize ) + valueSize ; <nl> } <nl> <nl> - @ Override <nl> public int serializationFlags ( ) <nl> { <nl> return 0 ; <nl> } <nl> <nl> - @ Override <nl> public Cell diff ( Cell cell ) <nl> { <nl> if ( timestamp ( ) < cell . timestamp ( ) ) <nl> @ @ - 117 , 7 + 104 , 6 @ @ public abstract class AbstractCell implements Cell <nl> return null ; <nl> } <nl> <nl> - @ Override <nl> public void updateDigest ( MessageDigest digest ) <nl> { <nl> digest . update ( name ( ) . toByteBuffer ( ) . duplicate ( ) ) ; <nl> @ @ - 127 , 19 + 113 , 17 @ @ public abstract class AbstractCell implements Cell <nl> FBUtilities . updateWithByte ( digest , serializationFlags ( ) ) ; <nl> } <nl> <nl> - @ Override <nl> public int getLocalDeletionTime ( ) <nl> { <nl> return Integer . MAX _ VALUE ; <nl> } <nl> <nl> - @ Override <nl> public Cell reconcile ( Cell cell ) <nl> { <nl> / / tombstones take precedence . ( if both are tombstones , then it doesn ' t matter which one we use . ) <nl> - if ( isMarkedForDelete ( System . currentTimeMillis ( ) ) ) <nl> + if ( ! isLive ( ) ) <nl> return timestamp ( ) < cell . timestamp ( ) ? cell : this ; <nl> - if ( cell . isMarkedForDelete ( System . currentTimeMillis ( ) ) ) <nl> + if ( ! cell . isLive ( ) ) <nl> return timestamp ( ) > cell . timestamp ( ) ? this : cell ; <nl> / / break ties by comparing values . <nl> if ( timestamp ( ) = = cell . timestamp ( ) ) <nl> @ @ - 164 , 23 + 148 , 20 @ @ public abstract class AbstractCell implements Cell <nl> throw new UnsupportedOperationException ( ) ; <nl> } <nl> <nl> - @ Override <nl> public String getString ( CellNameType comparator ) <nl> { <nl> return String . format ( " % s : % b : % d @ % d " , <nl> - comparator . getString ( name ( ) ) , <nl> - isMarkedForDelete ( System . currentTimeMillis ( ) ) , <nl> - value ( ) . remaining ( ) , <nl> - timestamp ( ) ) ; <nl> + comparator . getString ( name ( ) ) , <nl> + ! isLive ( ) , <nl> + value ( ) . remaining ( ) , <nl> + timestamp ( ) ) ; <nl> } <nl> <nl> - @ Override <nl> public void validateName ( CFMetaData metadata ) throws MarshalException <nl> { <nl> metadata . comparator . validate ( name ( ) ) ; <nl> } <nl> <nl> - @ Override <nl> public void validateFields ( CFMetaData metadata ) throws MarshalException <nl> { <nl> validateName ( metadata ) ; <nl> @ @ - 225 , 7 + 206 , 7 @ @ public abstract class AbstractCell implements Cell <nl> assert ( b instanceof CounterCell ) | | ( b instanceof DeletedCell ) : " Wrong class type : " + b . getClass ( ) ; <nl> <nl> / / live + tombstone : track last tombstone <nl> - if ( b . isMarkedForDelete ( Long . MIN _ VALUE ) ) / / cannot be an expired cell , so the current time is irrelevant <nl> + if ( ! b . isLive ( ) ) / / cannot be an expired cell , so the current time is irrelevant <nl> { <nl> / / live < tombstone <nl> if ( a . timestamp ( ) < b . timestamp ( ) ) <nl> diff - - git a / src / java / org / apache / cassandra / db / BufferCounterUpdateCell . java b / src / java / org / apache / cassandra / db / BufferCounterUpdateCell . java <nl> index 44ab83e . . 24c9fad 100644 <nl> - - - a / src / java / org / apache / cassandra / db / BufferCounterUpdateCell . java <nl> + + + b / src / java / org / apache / cassandra / db / BufferCounterUpdateCell . java <nl> @ @ - 55 , 16 + 55 , 16 @ @ public class BufferCounterUpdateCell extends BufferCell implements CounterUpdate <nl> public Cell reconcile ( Cell cell ) <nl> { <nl> / / The only time this could happen is if a batchAdd ships two <nl> - / / increment for the same cell . Hence we simply sums the delta . <nl> + / / increment for the same cell . Hence we simply sums the delta and the timestamps . <nl> <nl> / / tombstones take precedence <nl> - if ( cell . isMarkedForDelete ( Long . MIN _ VALUE ) ) / / can ' t be an expired cell , so the current time is irrelevant <nl> + if ( ! cell . isLive ( ) ) / / can ' t be an expired cell , so the current time is irrelevant <nl> return timestamp > cell . timestamp ( ) ? this : cell ; <nl> <nl> / / neither is tombstoned <nl> assert cell instanceof CounterUpdateCell : " Wrong class type . " ; <nl> CounterUpdateCell c = ( CounterUpdateCell ) cell ; <nl> - return new BufferCounterUpdateCell ( name , delta ( ) + c . delta ( ) , Math . max ( timestamp , c . timestamp ( ) ) ) ; <nl> + return new BufferCounterUpdateCell ( name , delta ( ) + c . delta ( ) , timestamp + c . timestamp ( ) ) ; <nl> } <nl> <nl> @ Override <nl> diff - - git a / src / java / org / apache / cassandra / db / BufferDeletedCell . java b / src / java / org / apache / cassandra / db / BufferDeletedCell . java <nl> index a6518de . . bcc170f 100644 <nl> - - - a / src / java / org / apache / cassandra / db / BufferDeletedCell . java <nl> + + + b / src / java / org / apache / cassandra / db / BufferDeletedCell . java <nl> @ @ - 54 , 15 + 54 , 15 @ @ public class BufferDeletedCell extends BufferCell implements DeletedCell <nl> } <nl> <nl> @ Override <nl> - public boolean isMarkedForDelete ( long now ) <nl> + public boolean isLive ( ) <nl> { <nl> - return true ; <nl> + return false ; <nl> } <nl> <nl> @ Override <nl> - public long getMarkedForDeleteAt ( ) <nl> + public boolean isLive ( long now ) <nl> { <nl> - return timestamp ; <nl> + return false ; <nl> } <nl> <nl> @ Override <nl> diff - - git a / src / java / org / apache / cassandra / db / BufferExpiringCell . java b / src / java / org / apache / cassandra / db / BufferExpiringCell . java <nl> index 95ed45a . . 38d84f4 100644 <nl> - - - a / src / java / org / apache / cassandra / db / BufferExpiringCell . java <nl> + + + b / src / java / org / apache / cassandra / db / BufferExpiringCell . java <nl> @ @ - 114 , 15 + 114 , 15 @ @ public class BufferExpiringCell extends BufferCell implements ExpiringCell <nl> } <nl> <nl> @ Override <nl> - public boolean isMarkedForDelete ( long now ) <nl> + public boolean isLive ( ) <nl> { <nl> - return ( int ) ( now / 1000 ) > = getLocalDeletionTime ( ) ; <nl> + return isLive ( System . currentTimeMillis ( ) ) ; <nl> } <nl> <nl> @ Override <nl> - public long getMarkedForDeleteAt ( ) <nl> + public boolean isLive ( long now ) <nl> { <nl> - return timestamp ; <nl> + return ( int ) ( now / 1000 ) < getLocalDeletionTime ( ) ; <nl> } <nl> <nl> @ Override <nl> diff - - git a / src / java / org / apache / cassandra / db / Cell . java b / src / java / org / apache / cassandra / db / Cell . java <nl> index c19b5dd . . f91376d 100644 <nl> - - - a / src / java / org / apache / cassandra / db / Cell . java <nl> + + + b / src / java / org / apache / cassandra / db / Cell . java <nl> @ @ - 22 , 7 + 22 , 6 @ @ import java . nio . ByteBuffer ; <nl> import org . apache . cassandra . config . CFMetaData ; <nl> import org . apache . cassandra . db . composites . CellName ; <nl> import org . apache . cassandra . db . composites . CellNameType ; <nl> - import org . apache . cassandra . serializers . MarshalException ; <nl> import org . apache . cassandra . utils . concurrent . OpOrder ; <nl> import org . apache . cassandra . utils . memory . AbstractAllocator ; <nl> import org . apache . cassandra . utils . FBUtilities ; <nl> @ @ - 44 , 13 + 43 , 10 @ @ public interface Cell extends OnDiskAtom <nl> <nl> public ByteBuffer value ( ) ; <nl> <nl> - public boolean isMarkedForDelete ( long now ) ; <nl> + public boolean isLive ( ) ; <nl> <nl> public boolean isLive ( long now ) ; <nl> <nl> - / / Don ' t call unless the column is actually marked for delete . <nl> - public long getMarkedForDeleteAt ( ) ; <nl> - <nl> public int cellDataSize ( ) ; <nl> <nl> / / returns the size of the Cell and all references on the heap , excluding any costs associated with byte arrays <nl> @ @ - 58 , 6 + 54 , 7 @ @ public interface Cell extends OnDiskAtom <nl> public long excessHeapSizeExcludingData ( ) ; <nl> <nl> public int serializedSize ( CellNameType type , TypeSizes typeSizes ) ; <nl> + <nl> public int serializationFlags ( ) ; <nl> <nl> public Cell diff ( Cell cell ) ; <nl> @ @ - 69 , 6 + 66 , 4 @ @ public interface Cell extends OnDiskAtom <nl> public Cell localCopy ( CFMetaData metaData , MemtableAllocator allocator , OpOrder . Group opGroup ) ; <nl> <nl> public String getString ( CellNameType comparator ) ; <nl> - <nl> - void validateName ( CFMetaData metadata ) throws MarshalException ; <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / db / CounterMutation . java b / src / java / org / apache / cassandra / db / CounterMutation . java <nl> index 32571cc . . 58889c1 100644 <nl> - - - a / src / java / org / apache / cassandra / db / CounterMutation . java <nl> + + + b / src / java / org / apache / cassandra / db / CounterMutation . java <nl> @ @ - 265 , 7 + 265 , 7 @ @ public class CounterMutation implements IMutation <nl> continue ; <nl> <nl> Cell cell = cf = = null ? null : cf . getColumn ( counterUpdateCells . get ( i ) . name ( ) ) ; <nl> - if ( cell = = null | | cell . isMarkedForDelete ( Long . MIN _ VALUE ) ) / / absent or a tombstone . <nl> + if ( cell = = null | | ! cell . isLive ( ) ) / / absent or a tombstone . <nl> currentValues [ i ] = ClockAndCount . BLANK ; <nl> else <nl> currentValues [ i ] = CounterContext . instance ( ) . getLocalClockAndCount ( cell . value ( ) ) ; <nl> diff - - git a / src / java / org / apache / cassandra / db / HintedHandOffManager . java b / src / java / org / apache / cassandra / db / HintedHandOffManager . java <nl> index 8c892d6 . . 0337756 100644 <nl> - - - a / src / java / org / apache / cassandra / db / HintedHandOffManager . java <nl> + + + b / src / java / org / apache / cassandra / db / HintedHandOffManager . java <nl> @ @ - 402 , 7 + 402 , 7 @ @ public class HintedHandOffManager implements HintedHandOffManagerMBean <nl> / / in which the local deletion timestamp was generated on the last column in the old page , in which <nl> / / case the hint will have no columns ( since it ' s deleted ) but will still be included in the resultset <nl> / / since ( even with gcgs = 0 ) it ' s still a " relevant " tombstone . <nl> - if ( ! hint . isLive ( System . currentTimeMillis ( ) ) ) <nl> + if ( ! hint . isLive ( ) ) <nl> continue ; <nl> <nl> startColumn = hint . name ( ) ; <nl> diff - - git a / src / java / org / apache / cassandra / db / NativeDeletedCell . java b / src / java / org / apache / cassandra / db / NativeDeletedCell . java <nl> index 8bfc95b . . 20118a4 100644 <nl> - - - a / src / java / org / apache / cassandra / db / NativeDeletedCell . java <nl> + + + b / src / java / org / apache / cassandra / db / NativeDeletedCell . java <nl> @ @ - 50 , 15 + 50 , 15 @ @ public class NativeDeletedCell extends NativeCell implements DeletedCell <nl> } <nl> <nl> @ Override <nl> - public boolean isMarkedForDelete ( long now ) <nl> + public boolean isLive ( ) <nl> { <nl> - return true ; <nl> + return false ; <nl> } <nl> <nl> @ Override <nl> - public long getMarkedForDeleteAt ( ) <nl> + public boolean isLive ( long now ) <nl> { <nl> - return timestamp ( ) ; <nl> + return false ; <nl> } <nl> <nl> @ Override <nl> diff - - git a / src / java / org / apache / cassandra / db / NativeExpiringCell . java b / src / java / org / apache / cassandra / db / NativeExpiringCell . java <nl> index 0822fbd . . fcadb16 100644 <nl> - - - a / src / java / org / apache / cassandra / db / NativeExpiringCell . java <nl> + + + b / src / java / org / apache / cassandra / db / NativeExpiringCell . java <nl> @ @ - 76 , 15 + 76 , 15 @ @ public class NativeExpiringCell extends NativeCell implements ExpiringCell <nl> } <nl> <nl> @ Override <nl> - public boolean isMarkedForDelete ( long now ) <nl> + public boolean isLive ( ) <nl> { <nl> - return ( int ) ( now / 1000 ) > = getLocalDeletionTime ( ) ; <nl> + return isLive ( System . currentTimeMillis ( ) ) ; <nl> } <nl> <nl> @ Override <nl> - public long getMarkedForDeleteAt ( ) <nl> + public boolean isLive ( long now ) <nl> { <nl> - return timestamp ( ) ; <nl> + return ( int ) ( now / 1000 ) < getLocalDeletionTime ( ) ; <nl> } <nl> <nl> @ Override <nl> diff - - git a / src / java / org / apache / cassandra / db / compaction / LazilyCompactedRow . java b / src / java / org / apache / cassandra / db / compaction / LazilyCompactedRow . java <nl> index 4f211f4 . . d0f3610 100644 <nl> - - - a / src / java / org / apache / cassandra / db / compaction / LazilyCompactedRow . java <nl> + + + b / src / java / org / apache / cassandra / db / compaction / LazilyCompactedRow . java <nl> @ @ - 223 , 11 + 223 , 8 @ @ public class LazilyCompactedRow extends AbstractCompactedRow <nl> if ( indexer = = SecondaryIndexManager . nullUpdater ) <nl> return ; <nl> <nl> - if ( ! cell . isMarkedForDelete ( System . currentTimeMillis ( ) ) <nl> - & & ! container . getColumn ( cell . name ( ) ) . equals ( cell ) ) <nl> - { <nl> + if ( cell . isLive ( ) & & ! container . getColumn ( cell . name ( ) ) . equals ( cell ) ) <nl> indexer . remove ( cell ) ; <nl> - } <nl> } <nl> } <nl> <nl> diff - - git a / src / java / org / apache / cassandra / db / composites / AbstractCellNameType . java b / src / java / org / apache / cassandra / db / composites / AbstractCellNameType . java <nl> index 826f71a . . 56be8cf 100644 <nl> - - - a / src / java / org / apache / cassandra / db / composites / AbstractCellNameType . java <nl> + + + b / src / java / org / apache / cassandra / db / composites / AbstractCellNameType . java <nl> @ @ - 271 , 7 + 271 , 7 @ @ public abstract class AbstractCellNameType extends AbstractCType implements Cell <nl> while ( cells . hasNext ( ) ) <nl> { <nl> final Cell cell = cells . next ( ) ; <nl> - if ( cell . isMarkedForDelete ( now ) ) <nl> + if ( ! cell . isLive ( now ) ) <nl> continue ; <nl> <nl> return new CQL3Row ( ) <nl> @ @ - 343 , 7 + 343 , 7 @ @ public abstract class AbstractCellNameType extends AbstractCType implements Cell <nl> while ( cells . hasNext ( ) ) <nl> { <nl> Cell cell = cells . next ( ) ; <nl> - if ( cell . isMarkedForDelete ( now ) ) <nl> + if ( ! cell . isLive ( now ) ) <nl> continue ; <nl> <nl> nextCell = cell ; <nl> diff - - git a / src / java / org / apache / cassandra / db / index / AbstractSimplePerColumnSecondaryIndex . java b / src / java / org / apache / cassandra / db / index / AbstractSimplePerColumnSecondaryIndex . java <nl> index 164c96f . . b64d84f 100644 <nl> - - - a / src / java / org / apache / cassandra / db / index / AbstractSimplePerColumnSecondaryIndex . java <nl> + + + b / src / java / org / apache / cassandra / db / index / AbstractSimplePerColumnSecondaryIndex . java <nl> @ @ - 31 , 7 + 31 , 6 @ @ import org . apache . cassandra . dht . LocalToken ; <nl> import org . apache . cassandra . utils . ByteBufferUtil ; <nl> import org . apache . cassandra . utils . FBUtilities ; <nl> import org . apache . cassandra . utils . concurrent . OpOrder ; <nl> - import org . apache . cassandra . utils . memory . MemtableAllocator ; <nl> <nl> / * * <nl> * Implements a secondary index for a column family using a second column family <nl> @ @ - 89 , 7 + 88 , 7 @ @ public abstract class AbstractSimplePerColumnSecondaryIndex extends PerColumnSec <nl> <nl> public void delete ( ByteBuffer rowKey , Cell cell , OpOrder . Group opGroup ) <nl> { <nl> - if ( cell . isMarkedForDelete ( System . currentTimeMillis ( ) ) ) <nl> + if ( ! cell . isLive ( ) ) <nl> return ; <nl> <nl> DecoratedKey valueKey = getIndexKeyFor ( getIndexedValue ( rowKey , cell ) ) ; <nl> diff - - git a / src / java / org / apache / cassandra / db / index / SecondaryIndexManager . java b / src / java / org / apache / cassandra / db / index / SecondaryIndexManager . java <nl> index 39bc26b . . 36c7e1e 100644 <nl> - - - a / src / java / org / apache / cassandra / db / index / SecondaryIndexManager . java <nl> + + + b / src / java / org / apache / cassandra / db / index / SecondaryIndexManager . java <nl> @ @ - 656 , 7 + 656 , 7 @ @ public class SecondaryIndexManager <nl> <nl> public void remove ( Cell cell ) <nl> { <nl> - if ( cell . isMarkedForDelete ( System . currentTimeMillis ( ) ) ) <nl> + if ( ! cell . isLive ( ) ) <nl> return ; <nl> <nl> for ( SecondaryIndex index : indexFor ( cell . name ( ) ) ) <nl> @ @ - 693 , 7 + 693 , 7 @ @ public class SecondaryIndexManager <nl> <nl> public void insert ( Cell cell ) <nl> { <nl> - if ( cell . isMarkedForDelete ( System . currentTimeMillis ( ) ) ) <nl> + if ( ! cell . isLive ( ) ) <nl> return ; <nl> <nl> for ( SecondaryIndex index : indexFor ( cell . name ( ) ) ) <nl> @ @ - 710 , 7 + 710 , 7 @ @ public class SecondaryIndexManager <nl> { <nl> if ( index instanceof PerColumnSecondaryIndex ) <nl> { <nl> - if ( ! cell . isMarkedForDelete ( System . currentTimeMillis ( ) ) ) <nl> + if ( cell . isLive ( ) ) <nl> ( ( PerColumnSecondaryIndex ) index ) . update ( key . getKey ( ) , oldCell , cell , opGroup ) ; <nl> else <nl> ( ( PerColumnSecondaryIndex ) index ) . delete ( key . getKey ( ) , oldCell , opGroup ) ; <nl> @ @ - 720 , 7 + 720 , 7 @ @ public class SecondaryIndexManager <nl> <nl> public void remove ( Cell cell ) <nl> { <nl> - if ( cell . isMarkedForDelete ( System . currentTimeMillis ( ) ) ) <nl> + if ( ! cell . isLive ( ) ) <nl> return ; <nl> <nl> for ( SecondaryIndex index : indexFor ( cell . name ( ) ) ) <nl> diff - - git a / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnCollectionKey . java b / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnCollectionKey . java <nl> index 2aff39d . . 2d25f8e 100644 <nl> - - - a / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnCollectionKey . java <nl> + + + b / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnCollectionKey . java <nl> @ @ - 100 , 7 + 100 , 7 @ @ public class CompositesIndexOnCollectionKey extends CompositesIndex <nl> public boolean isStale ( IndexedEntry entry , ColumnFamily data , long now ) <nl> { <nl> CellName name = data . getComparator ( ) . create ( entry . indexedEntryPrefix , columnDef , entry . indexValue . getKey ( ) ) ; <nl> - Cell liveCell = data . getColumn ( name ) ; <nl> - return ( liveCell = = null | | liveCell . isMarkedForDelete ( now ) ) ; <nl> + Cell cell = data . getColumn ( name ) ; <nl> + return cell = = null | | ! cell . isLive ( now ) ; <nl> } <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnCollectionValue . java b / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnCollectionValue . java <nl> index 67293aa . . 63589f4 100644 <nl> - - - a / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnCollectionValue . java <nl> + + + b / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnCollectionValue . java <nl> @ @ - 48 , 7 + 48 , 7 @ @ public class CompositesIndexOnCollectionValue extends CompositesIndex <nl> public static CellNameType buildIndexComparator ( CFMetaData baseMetadata , ColumnDefinition columnDef ) <nl> { <nl> int prefixSize = columnDef . position ( ) ; <nl> - List < AbstractType < ? > > types = new ArrayList < AbstractType < ? > > ( prefixSize + 2 ) ; <nl> + List < AbstractType < ? > > types = new ArrayList < > ( prefixSize + 2 ) ; <nl> types . add ( SecondaryIndex . keyComparator ) ; <nl> for ( int i = 0 ; i < prefixSize ; i + + ) <nl> types . add ( baseMetadata . comparator . subtype ( i ) ) ; <nl> @ @ - 98 , 11 + 98 , 7 @ @ public class CompositesIndexOnCollectionValue extends CompositesIndex <nl> public boolean isStale ( IndexedEntry entry , ColumnFamily data , long now ) <nl> { <nl> CellName name = data . getComparator ( ) . create ( entry . indexedEntryPrefix , columnDef , entry . indexedEntryCollectionKey ) ; <nl> - Cell liveCell = data . getColumn ( name ) ; <nl> - if ( liveCell = = null | | liveCell . isMarkedForDelete ( now ) ) <nl> - return true ; <nl> - <nl> - ByteBuffer liveValue = liveCell . value ( ) ; <nl> - return ( ( CollectionType ) columnDef . type ) . valueComparator ( ) . compare ( entry . indexValue . getKey ( ) , liveValue ) ! = 0 ; <nl> + Cell cell = data . getColumn ( name ) ; <nl> + return cell = = null | | ! cell . isLive ( now ) | | ( ( CollectionType ) columnDef . type ) . valueComparator ( ) . compare ( entry . indexValue . getKey ( ) , cell . value ( ) ) ! = 0 ; <nl> } <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnRegular . java b / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnRegular . java <nl> index 0cfd240 . . b9dc07f 100644 <nl> - - - a / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnRegular . java <nl> + + + b / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnRegular . java <nl> @ @ - 90 , 11 + 90 , 7 @ @ public class CompositesIndexOnRegular extends CompositesIndex <nl> public boolean isStale ( IndexedEntry entry , ColumnFamily data , long now ) <nl> { <nl> CellName name = data . getComparator ( ) . create ( entry . indexedEntryPrefix , columnDef ) ; <nl> - Cell liveCell = data . getColumn ( name ) ; <nl> - if ( liveCell = = null | | liveCell . isMarkedForDelete ( now ) ) <nl> - return true ; <nl> - <nl> - ByteBuffer liveValue = liveCell . value ( ) ; <nl> - return columnDef . type . compare ( entry . indexValue . getKey ( ) , liveValue ) ! = 0 ; <nl> + Cell cell = data . getColumn ( name ) ; <nl> + return cell = = null | | ! cell . isLive ( now ) | | columnDef . type . compare ( entry . indexValue . getKey ( ) , cell . value ( ) ) ! = 0 ; <nl> } <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / db / index / composites / CompositesSearcher . java b / src / java / org / apache / cassandra / db / index / composites / CompositesSearcher . java <nl> index 22d4361 . . dbce024 100644 <nl> - - - a / src / java / org / apache / cassandra / db / index / composites / CompositesSearcher . java <nl> + + + b / src / java / org / apache / cassandra / db / index / composites / CompositesSearcher . java <nl> @ @ - 19 , 11 + 19 , 7 @ @ package org . apache . cassandra . db . index . composites ; <nl> <nl> import java . io . IOException ; <nl> import java . nio . ByteBuffer ; <nl> - import java . util . ArrayDeque ; <nl> - import java . util . Collection ; <nl> - import java . util . Deque ; <nl> - import java . util . List ; <nl> - import java . util . Set ; <nl> + import java . util . * ; <nl> <nl> import org . slf4j . Logger ; <nl> import org . slf4j . LoggerFactory ; <nl> @ @ - 205 , 7 + 201 , 7 @ @ public class CompositesSearcher extends SecondaryIndexSearcher <nl> { <nl> Cell cell = indexCells . poll ( ) ; <nl> lastSeenPrefix = cell . name ( ) ; <nl> - if ( cell . isMarkedForDelete ( filter . timestamp ) ) <nl> + if ( ! cell . isLive ( filter . timestamp ) ) <nl> { <nl> logger . trace ( " skipping { } " , cell . name ( ) ) ; <nl> continue ; <nl> diff - - git a / src / java / org / apache / cassandra / db / index / keys / KeysIndex . java b / src / java / org / apache / cassandra / db / index / keys / KeysIndex . java <nl> index e532a53 . . 7cacb67 100644 <nl> - - - a / src / java / org / apache / cassandra / db / index / keys / KeysIndex . java <nl> + + + b / src / java / org / apache / cassandra / db / index / keys / KeysIndex . java <nl> @ @ - 52 , 12 + 52 , 8 @ @ public class KeysIndex extends AbstractSimplePerColumnSecondaryIndex <nl> <nl> public boolean isIndexEntryStale ( ByteBuffer indexedValue , ColumnFamily data , long now ) <nl> { <nl> - Cell liveCell = data . getColumn ( data . getComparator ( ) . makeCellName ( columnDef . name . bytes ) ) ; <nl> - if ( liveCell = = null | | liveCell . isMarkedForDelete ( now ) ) <nl> - return true ; <nl> - <nl> - ByteBuffer liveValue = liveCell . value ( ) ; <nl> - return columnDef . type . compare ( indexedValue , liveValue ) ! = 0 ; <nl> + Cell cell = data . getColumn ( data . getComparator ( ) . makeCellName ( columnDef . name . bytes ) ) ; <nl> + return cell = = null | | ! cell . isLive ( now ) | | columnDef . type . compare ( indexedValue , cell . value ( ) ) ! = 0 ; <nl> } <nl> <nl> public void validateOptions ( ) throws ConfigurationException <nl> diff - - git a / src / java / org / apache / cassandra / db / index / keys / KeysSearcher . java b / src / java / org / apache / cassandra / db / index / keys / KeysSearcher . java <nl> index d166c08 . . 4055b7c 100644 <nl> - - - a / src / java / org / apache / cassandra / db / index / keys / KeysSearcher . java <nl> + + + b / src / java / org / apache / cassandra / db / index / keys / KeysSearcher . java <nl> @ @ - 154 , 7 + 154 , 7 @ @ public class KeysSearcher extends SecondaryIndexSearcher <nl> { <nl> Cell cell = indexColumns . next ( ) ; <nl> lastSeenKey = cell . name ( ) ; <nl> - if ( cell . isMarkedForDelete ( filter . timestamp ) ) <nl> + if ( ! cell . isLive ( filter . timestamp ) ) <nl> { <nl> logger . trace ( " skipping { } " , cell . name ( ) ) ; <nl> continue ; <nl> diff - - git a / src / java / org / apache / cassandra / service / CacheService . java b / src / java / org / apache / cassandra / service / CacheService . java <nl> index 048bad4 . . 78f6d66 100644 <nl> - - - a / src / java / org / apache / cassandra / service / CacheService . java <nl> + + + b / src / java / org / apache / cassandra / service / CacheService . java <nl> @ @ - 406 , 7 + 406 , 7 @ @ public class CacheService implements CacheServiceMBean <nl> if ( cf = = null ) <nl> return null ; <nl> Cell cell = cf . getColumn ( cellName ) ; <nl> - if ( cell = = null | | cell . isMarkedForDelete ( Long . MIN _ VALUE ) ) <nl> + if ( cell = = null | | ! cell . isLive ( Long . MIN _ VALUE ) ) <nl> return null ; <nl> ClockAndCount clockAndCount = CounterContext . instance ( ) . getLocalClockAndCount ( cell . value ( ) ) ; <nl> return Pair . create ( CounterCacheKey . create ( cfs . metadata . cfId , partitionKey , cellName ) , clockAndCount ) ; <nl> diff - - git a / src / java / org / apache / cassandra / thrift / CassandraServer . java b / src / java / org / apache / cassandra / thrift / CassandraServer . java <nl> index 3040aaf . . 069cec7 100644 <nl> - - - a / src / java / org / apache / cassandra / thrift / CassandraServer . java <nl> + + + b / src / java / org / apache / cassandra / thrift / CassandraServer . java <nl> @ @ - 137 , 7 + 137 , 7 @ @ public class CassandraServer implements Cassandra . Iface <nl> ArrayList < ColumnOrSuperColumn > thriftColumns = new ArrayList < ColumnOrSuperColumn > ( cells . size ( ) ) ; <nl> for ( Cell cell : cells ) <nl> { <nl> - if ( cell . isMarkedForDelete ( now ) ) <nl> + if ( ! cell . isLive ( now ) ) <nl> continue ; <nl> <nl> thriftColumns . add ( thriftifyColumnWithName ( cell , cell . name ( ) . toByteBuffer ( ) ) ) ; <nl> @ @ - 176 , 7 + 176 , 7 @ @ public class CassandraServer implements Cassandra . Iface <nl> List < Column > thriftColumns = new ArrayList < Column > ( cells . size ( ) ) ; <nl> for ( Cell cell : cells ) <nl> { <nl> - if ( cell . isMarkedForDelete ( now ) ) <nl> + if ( ! cell . isLive ( now ) ) <nl> continue ; <nl> <nl> thriftColumns . add ( thriftifySubColumn ( cell ) ) ; <nl> @ @ - 201 , 7 + 201 , 7 @ @ public class CassandraServer implements Cassandra . Iface <nl> ArrayList < ColumnOrSuperColumn > thriftSuperColumns = new ArrayList < ColumnOrSuperColumn > ( cells . size ( ) ) ; <nl> for ( Cell cell : cells ) <nl> { <nl> - if ( cell . isMarkedForDelete ( now ) ) <nl> + if ( ! cell . isLive ( now ) ) <nl> continue ; <nl> <nl> thriftSuperColumns . add ( thriftifyColumnWithName ( cell , SuperColumns . subName ( cell . name ( ) ) ) ) ; <nl> @ @ - 225 , 7 + 225 , 7 @ @ public class CassandraServer implements Cassandra . Iface <nl> SuperColumn current = null ; <nl> for ( Cell cell : cells ) <nl> { <nl> - if ( cell . isMarkedForDelete ( now ) ) <nl> + if ( ! cell . isLive ( now ) ) <nl> continue ; <nl> <nl> ByteBuffer scName = SuperColumns . scName ( cell . name ( ) ) ; <nl> @ @ - 249 , 7 + 249 , 7 @ @ public class CassandraServer implements Cassandra . Iface <nl> CounterSuperColumn current = null ; <nl> for ( Cell cell : cells ) <nl> { <nl> - if ( cell . isMarkedForDelete ( now ) ) <nl> + if ( ! cell . isLive ( now ) ) <nl> continue ; <nl> <nl> ByteBuffer scName = SuperColumns . scName ( cell . name ( ) ) ; <nl> diff - - git a / test / unit / org / apache / cassandra / db / ColumnFamilyTest . java b / test / unit / org / apache / cassandra / db / ColumnFamilyTest . java <nl> index 7f8da96 . . 151cbdc 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / ColumnFamilyTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / ColumnFamilyTest . java <nl> @ @ - 38 , 6 + 38 , 7 @ @ import static org . apache . cassandra . Util . column ; <nl> import static org . apache . cassandra . Util . cellname ; <nl> import static org . apache . cassandra . Util . tombstone ; <nl> import static org . junit . Assert . assertEquals ; <nl> + import static org . junit . Assert . assertFalse ; <nl> <nl> public class ColumnFamilyTest extends SchemaLoader <nl> { <nl> @ @ - 184 , 9 + 185 , 9 @ @ public class ColumnFamilyTest extends SchemaLoader <nl> <nl> / / check that tombstone wins timestamp ties <nl> cf _ result . addTombstone ( cellname ( " col1 " ) , 0 , 3 ) ; <nl> - assert cf _ result . getColumn ( cellname ( " col1 " ) ) . isMarkedForDelete ( System . currentTimeMillis ( ) ) ; <nl> + assertFalse ( cf _ result . getColumn ( cellname ( " col1 " ) ) . isLive ( ) ) ; <nl> cf _ result . addColumn ( cellname ( " col1 " ) , val2 , 3 ) ; <nl> - assert cf _ result . getColumn ( cellname ( " col1 " ) ) . isMarkedForDelete ( System . currentTimeMillis ( ) ) ; <nl> + assertFalse ( cf _ result . getColumn ( cellname ( " col1 " ) ) . isLive ( ) ) ; <nl> <nl> / / check that column value wins timestamp ties in absence of tombstone <nl> cf _ result . addColumn ( cellname ( " col3 " ) , val , 2 ) ; <nl> diff - - git a / test / unit / org / apache / cassandra / db / CounterCellTest . java b / test / unit / org / apache / cassandra / db / CounterCellTest . java <nl> index efc365d . . 645c8a7 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / CounterCellTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / CounterCellTest . java <nl> @ @ - 90 , 8 + 90 , 8 @ @ public class CounterCellTest extends SchemaLoader <nl> left = new BufferDeletedCell ( cellname ( " x " ) , 1 , 1L ) ; <nl> right = new BufferDeletedCell ( cellname ( " x " ) , 2 , 2L ) ; <nl> <nl> - assert left . reconcile ( right ) . getMarkedForDeleteAt ( ) = = right . getMarkedForDeleteAt ( ) ; <nl> - assert right . reconcile ( left ) . getMarkedForDeleteAt ( ) = = right . getMarkedForDeleteAt ( ) ; <nl> + assert left . reconcile ( right ) . timestamp ( ) = = right . timestamp ( ) ; <nl> + assert right . reconcile ( left ) . timestamp ( ) = = right . timestamp ( ) ; <nl> <nl> / / tombstone > live <nl> left = new BufferDeletedCell ( cellname ( " x " ) , 1 , 2L ) ; <nl> @ @ - 119 , 7 + 119 , 7 @ @ public class CounterCellTest extends SchemaLoader <nl> assert reconciled . name ( ) = = right . name ( ) ; <nl> assert reconciled . value ( ) = = right . value ( ) ; <nl> assert reconciled . timestamp ( ) = = right . timestamp ( ) ; <nl> - assert ( ( CounterCell ) reconciled ) . timestampOfLastDelete ( ) = = left . getMarkedForDeleteAt ( ) ; <nl> + assert ( ( CounterCell ) reconciled ) . timestampOfLastDelete ( ) = = left . timestamp ( ) ; <nl> <nl> / / live < tombstone <nl> left = BufferCounterCell . createLocal ( cellname ( " x " ) , 0L , 1L , Long . MIN _ VALUE ) ; <nl> @ @ - 147 , 7 + 147 , 7 @ @ public class CounterCellTest extends SchemaLoader <nl> assert reconciled . name ( ) = = left . name ( ) ; <nl> assert reconciled . value ( ) = = left . value ( ) ; <nl> assert reconciled . timestamp ( ) = = left . timestamp ( ) ; <nl> - assert ( ( CounterCell ) reconciled ) . timestampOfLastDelete ( ) = = right . getMarkedForDeleteAt ( ) ; <nl> + assert ( ( CounterCell ) reconciled ) . timestampOfLastDelete ( ) = = right . timestamp ( ) ; <nl> <nl> / / live < live last delete <nl> left = new BufferCounterCell ( cellname ( " x " ) , cc . createRemote ( CounterId . fromInt ( 1 ) , 2L , 3L ) , 1L , Long . MIN _ VALUE ) ; <nl> diff - - git a / test / unit / org / apache / cassandra / db / RangeTombstoneTest . java b / test / unit / org / apache / cassandra / db / RangeTombstoneTest . java <nl> index 6ac5f13 . . ace0ae3 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / RangeTombstoneTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / RangeTombstoneTest . java <nl> @ @ - 467 , 7 + 467 , 7 @ @ public class RangeTombstoneTest extends SchemaLoader <nl> <nl> private static boolean isLive ( ColumnFamily cf , Cell c ) <nl> { <nl> - return c ! = null & & ! c . isMarkedForDelete ( System . currentTimeMillis ( ) ) & & ! cf . deletionInfo ( ) . isDeleted ( c ) ; <nl> + return c ! = null & & c . isLive ( ) & & ! cf . deletionInfo ( ) . isDeleted ( c ) ; <nl> } <nl> <nl> private static CellName b ( int i ) <nl> diff - - git a / test / unit / org / apache / cassandra / db / RemoveCellTest . java b / test / unit / org / apache / cassandra / db / RemoveCellTest . java <nl> index 1624913 . . 77ff02d 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / RemoveCellTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / RemoveCellTest . java <nl> @ @ - 20 , 16 + 20 , 14 @ @ package org . apache . cassandra . db ; <nl> <nl> import org . junit . Test ; <nl> <nl> + import static org . junit . Assert . assertFalse ; <nl> import static org . junit . Assert . assertNull ; <nl> - import static org . junit . Assert . assertTrue ; <nl> - <nl> - import org . apache . cassandra . db . filter . QueryFilter ; <nl> <nl> import org . apache . cassandra . SchemaLoader ; <nl> import org . apache . cassandra . Util ; <nl> + import org . apache . cassandra . db . filter . QueryFilter ; <nl> import org . apache . cassandra . utils . ByteBufferUtil ; <nl> <nl> - <nl> public class RemoveCellTest extends SchemaLoader <nl> { <nl> @ Test <nl> @ @ - 52 , 7 + 50 , 7 @ @ public class RemoveCellTest extends SchemaLoader <nl> rm . apply ( ) ; <nl> <nl> ColumnFamily retrieved = store . getColumnFamily ( Util . namesQueryFilter ( store , dk , " Column1 " ) ) ; <nl> - assert retrieved . getColumn ( Util . cellname ( " Column1 " ) ) . isMarkedForDelete ( System . currentTimeMillis ( ) ) ; <nl> + assertFalse ( retrieved . getColumn ( Util . cellname ( " Column1 " ) ) . isLive ( ) ) ; <nl> assertNull ( Util . cloneAndRemoveDeleted ( retrieved , Integer . MAX _ VALUE ) ) ; <nl> assertNull ( Util . cloneAndRemoveDeleted ( store . getColumnFamily ( QueryFilter . getIdentityFilter ( dk , <nl> " Standard1 " , <nl> @ @ - 72 , 15 + 70 , 15 @ @ public class RemoveCellTest extends SchemaLoader <nl> long timestamp = System . currentTimeMillis ( ) ; <nl> int localDeletionTime = ( int ) ( timestamp / 1000 ) ; <nl> Cell c = dc ( " dc1 " , localDeletionTime , timestamp ) ; <nl> - assertTrue ( " DeletedCell was not marked for delete " , c . isMarkedForDelete ( timestamp ) ) ; <nl> + assertFalse ( " DeletedCell was not marked for delete " , c . isLive ( timestamp ) ) ; <nl> <nl> / / Simulate a node that is 30 seconds behind <nl> c = dc ( " dc2 " , localDeletionTime + 30 , timestamp + 30000 ) ; <nl> - assertTrue ( " DeletedCell was not marked for delete " , c . isMarkedForDelete ( timestamp ) ) ; <nl> + assertFalse ( " DeletedCell was not marked for delete " , c . isLive ( timestamp ) ) ; <nl> <nl> / / Simulate a node that is 30 ahead behind <nl> c = dc ( " dc3 " , localDeletionTime - 30 , timestamp - 30000 ) ; <nl> - assertTrue ( " DeletedCell was not marked for delete " , c . isMarkedForDelete ( timestamp ) ) ; <nl> + assertFalse ( " DeletedCell was not marked for delete " , c . isLive ( timestamp ) ) ; <nl> } <nl> <nl> } <nl> diff - - git a / test / unit / org / apache / cassandra / db / RemoveSubCellTest . java b / test / unit / org / apache / cassandra / db / RemoveSubCellTest . java <nl> index 6eee4a6 . . cec1bce 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / RemoveSubCellTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / RemoveSubCellTest . java <nl> @ @ - 23 , 6 + 23 , 7 @ @ import java . util . concurrent . TimeUnit ; <nl> <nl> import org . junit . Test ; <nl> <nl> + import static org . junit . Assert . assertFalse ; <nl> import static org . junit . Assert . assertNull ; <nl> import org . apache . cassandra . db . composites . * ; <nl> import org . apache . cassandra . db . filter . QueryFilter ; <nl> @ @ - 58 , 7 + 59 , 7 @ @ public class RemoveSubCellTest extends SchemaLoader <nl> rm . apply ( ) ; <nl> <nl> ColumnFamily retrieved = store . getColumnFamily ( QueryFilter . getIdentityFilter ( dk , " Super1 " , System . currentTimeMillis ( ) ) ) ; <nl> - assert retrieved . getColumn ( cname ) . isMarkedForDelete ( System . currentTimeMillis ( ) ) ; <nl> + assertFalse ( retrieved . getColumn ( cname ) . isLive ( ) ) ; <nl> assertNull ( Util . cloneAndRemoveDeleted ( retrieved , Integer . MAX _ VALUE ) ) ; <nl> } <nl> <nl> @ @ - 94 , 7 + 95 , 7 @ @ public class RemoveSubCellTest extends SchemaLoader <nl> rm . apply ( ) ; <nl> <nl> ColumnFamily retrieved = store . getColumnFamily ( filter ) ; <nl> - assert retrieved . getColumn ( cname ) . isMarkedForDelete ( System . currentTimeMillis ( ) ) ; <nl> + assertFalse ( retrieved . getColumn ( cname ) . isLive ( ) ) ; <nl> assertNull ( Util . cloneAndRemoveDeleted ( retrieved , Integer . MAX _ VALUE ) ) ; <nl> } <nl> } <nl> diff - - git a / test / unit / org / apache / cassandra / db / RowTest . java b / test / unit / org / apache / cassandra / db / RowTest . java <nl> index 653c9f5 . . 22e112e 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / RowTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / RowTest . java <nl> @ @ - 32 , 6 + 32 , 7 @ @ import static org . apache . cassandra . Util . column ; <nl> import static org . apache . cassandra . Util . tombstone ; <nl> import static org . junit . Assert . assertEquals ; <nl> import static org . junit . Assert . assertFalse ; <nl> + import static org . junit . Assert . assertTrue ; <nl> <nl> public class RowTest extends SchemaLoader <nl> { <nl> @ @ - 101 , 12 + 102 , 12 @ @ public class RowTest extends SchemaLoader <nl> public void testExpiringColumnExpiration ( ) <nl> { <nl> Cell c = new BufferExpiringCell ( CellNames . simpleDense ( ByteBufferUtil . bytes ( " one " ) ) , ByteBufferUtil . bytes ( " A " ) , 0 , 1 ) ; <nl> - assert ! c . isMarkedForDelete ( System . currentTimeMillis ( ) ) ; <nl> + assertTrue ( c . isLive ( ) ) ; <nl> <nl> / / Because we keep the local deletion time with a precision of a <nl> / / second , we could have to wait 2 seconds in worst case scenario . <nl> Uninterruptibles . sleepUninterruptibly ( 2 , TimeUnit . SECONDS ) ; <nl> <nl> - assert c . isMarkedForDelete ( System . currentTimeMillis ( ) ) & & c . getMarkedForDeleteAt ( ) = = 0 ; <nl> + assert ! c . isLive ( ) & & c . timestamp ( ) = = 0 ; <nl> } <nl> } <nl> diff - - git a / test / unit / org / apache / cassandra / db / compaction / CompactionsPurgeTest . java b / test / unit / org / apache / cassandra / db / compaction / CompactionsPurgeTest . java <nl> index f9cfb2c . . 751e7ae 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / compaction / CompactionsPurgeTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / compaction / CompactionsPurgeTest . java <nl> @ @ - 187 , 7 + 187 , 7 @ @ public class CompactionsPurgeTest extends SchemaLoader <nl> / / We should have both the c1 and c2 tombstones still . Since the min timestamp in the c2 tombstone <nl> / / sstable is older than the c1 tombstone , it is invalid to throw out the c1 tombstone . <nl> ColumnFamily cf = cfs . getColumnFamily ( QueryFilter . getIdentityFilter ( key3 , cfName , System . currentTimeMillis ( ) ) ) ; <nl> - assertFalse ( cf . getColumn ( cellname ( " c2 " ) ) . isLive ( System . currentTimeMillis ( ) ) ) ; <nl> + assertFalse ( cf . getColumn ( cellname ( " c2 " ) ) . isLive ( ) ) ; <nl> assertEquals ( 2 , cf . getColumnCount ( ) ) ; <nl> } <nl> <nl> @ @ - 273 , 7 + 273 , 7 @ @ public class CompactionsPurgeTest extends SchemaLoader <nl> ColumnFamily cf = cfs . getColumnFamily ( QueryFilter . getIdentityFilter ( key , cfName , System . currentTimeMillis ( ) ) ) ; <nl> assertEquals ( 10 , cf . getColumnCount ( ) ) ; <nl> for ( Cell c : cf ) <nl> - assert ! c . isMarkedForDelete ( System . currentTimeMillis ( ) ) ; <nl> + assert c . isLive ( ) ; <nl> } <nl> <nl> @ Test <nl> @ @ - 317 , 7 + 317 , 7 @ @ public class CompactionsPurgeTest extends SchemaLoader <nl> cf = cfs . getColumnFamily ( filter ) ; <nl> assertEquals ( 10 , cf . getColumnCount ( ) ) ; <nl> for ( Cell c : cf ) <nl> - assert ! c . isMarkedForDelete ( System . currentTimeMillis ( ) ) ; <nl> + assert c . isLive ( ) ; <nl> } <nl> <nl> @ Test <nl> diff - - git a / test / unit / org / apache / cassandra / db / index / PerRowSecondaryIndexTest . java b / test / unit / org / apache / cassandra / db / index / PerRowSecondaryIndexTest . java <nl> index 7eb899f . . 158dd2c 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / index / PerRowSecondaryIndexTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / index / PerRowSecondaryIndexTest . java <nl> @ @ - 38 , 11 + 38 , 8 @ @ import org . apache . cassandra . db . filter . QueryFilter ; <nl> import org . apache . cassandra . exceptions . ConfigurationException ; <nl> import org . apache . cassandra . utils . ByteBufferUtil ; <nl> import org . apache . cassandra . utils . concurrent . OpOrder ; <nl> - import org . apache . cassandra . utils . memory . MemtableAllocator ; <nl> <nl> - import static org . junit . Assert . assertEquals ; <nl> - import static org . junit . Assert . assertNotNull ; <nl> - import static org . junit . Assert . assertTrue ; <nl> + import static org . junit . Assert . * ; <nl> <nl> public class PerRowSecondaryIndexTest extends SchemaLoader <nl> { <nl> @ @ - 96 , 9 + 93 , 8 @ @ public class PerRowSecondaryIndexTest extends SchemaLoader <nl> assertNotNull ( indexedRow ) ; <nl> <nl> for ( Cell cell : indexedRow . getSortedColumns ( ) ) <nl> - { <nl> - assertTrue ( cell . isMarkedForDelete ( System . currentTimeMillis ( ) ) ) ; <nl> - } <nl> + assertFalse ( cell . isLive ( ) ) ; <nl> + <nl> assertTrue ( Arrays . equals ( " k2 " . getBytes ( ) , PerRowSecondaryIndexTest . TestIndex . LAST _ INDEXED _ KEY . array ( ) ) ) ; <nl> } <nl> <nl> @ @ - 114 , 9 + 110 , 8 @ @ public class PerRowSecondaryIndexTest extends SchemaLoader <nl> ColumnFamily indexedRow = PerRowSecondaryIndexTest . TestIndex . LAST _ INDEXED _ ROW ; <nl> assertNotNull ( indexedRow ) ; <nl> for ( Cell cell : indexedRow . getSortedColumns ( ) ) <nl> - { <nl> - assertTrue ( cell . isMarkedForDelete ( System . currentTimeMillis ( ) ) ) ; <nl> - } <nl> + assertFalse ( cell . isLive ( ) ) ; <nl> + <nl> assertTrue ( Arrays . equals ( " k3 " . getBytes ( ) , PerRowSecondaryIndexTest . TestIndex . LAST _ INDEXED _ KEY . array ( ) ) ) ; <nl> } <nl> <nl> diff - - git a / test / unit / org / apache / cassandra / service / QueryPagerTest . java b / test / unit / org / apache / cassandra / service / QueryPagerTest . java <nl> index ad70eff . . abd030d 100644 <nl> - - - a / test / unit / org / apache / cassandra / service / QueryPagerTest . java <nl> + + + b / test / unit / org / apache / cassandra / service / QueryPagerTest . java <nl> @ @ - 165 , 7 + 165 , 7 @ @ public class QueryPagerTest extends SchemaLoader <nl> for ( Cell c : r . cf ) <nl> { <nl> / / Ignore deleted cells if we have them <nl> - if ( ! c . isLive ( 0 ) ) <nl> + if ( ! c . isLive ( ) ) <nl> continue ; <nl> <nl> ByteBuffer expected = names [ i + + ] ;
NEAREST DIFF (one line): diff - - git a / lib / licenses / guava - r05 . txt b / lib / licenses / guava - r05 . txt <nl> deleted file mode 100644 <nl> index d645695 . . 0000000 <nl> - - - a / lib / licenses / guava - r05 . txt <nl> + + + / dev / null <nl> @ @ - 1 , 202 + 0 , 0 @ @ <nl> - <nl> - Apache License <nl> - Version 2 . 0 , January 2004 <nl> - http : / / www . apache . org / licenses / <nl> - <nl> - TERMS AND CONDITIONS FOR USE , REPRODUCTION , AND DISTRIBUTION <nl> - <nl> - 1 . Definitions . <nl> - <nl> - " License " shall mean the terms and conditions for use , reproduction , <nl> - and distribution as defined by Sections 1 through 9 of this document . <nl> - <nl> - " Licensor " shall mean the copyright owner or entity authorized by <nl> - the copyright owner that is granting the License . <nl> - <nl> - " Legal Entity " shall mean the union of the acting entity and all <nl> - other entities that control , are controlled by , or are under common <nl> - control with that entity . For the purposes of this definition , <nl> - " control " means ( i ) the power , direct or indirect , to cause the <nl> - direction or management of such entity , whether by contract or <nl> - otherwise , or ( ii ) ownership of fifty percent ( 50 % ) or more of the <nl> - outstanding shares , or ( iii ) beneficial ownership of such entity . <nl> - <nl> - " You " ( or " Your " ) shall mean an individual or Legal Entity <nl> - exercising permissions granted by this License . <nl> - <nl> - " Source " form shall mean the preferred form for making modifications , <nl> - including but not limited to software source code , documentation <nl> - source , and configuration files . <nl> - <nl> - " Object " form shall mean any form resulting from mechanical <nl> - transformation or translation of a Source form , including but <nl> - not limited to compiled object code , generated documentation , <nl> - and conversions to other media types . <nl> - <nl> - " Work " shall mean the work of authorship , whether in Source or <nl> - Object form , made available under the License , as indicated by a <nl> - copyright notice that is included in or attached to the work <nl> - ( an example is provided in the Appendix below ) . <nl> - <nl> - " Derivative Works " shall mean any work , whether in Source or Object <nl> - form , that is based on ( or derived from ) the Work and for which the <nl> - editorial revisions , annotations , elaborations , or other modifications <nl> - represent , as a whole , an original work of authorship . For the purposes <nl> - of this License , Derivative Works shall not include works that remain <nl> - separable from , or merely link ( or bind by name ) to the interfaces of , <nl> - the Work and Derivative Works thereof . <nl> - <nl> - " Contribution " shall mean any work of authorship , including <nl> - the original version of the Work and any modifications or additions <nl> - to that Work or Derivative Works thereof , that is intentionally <nl> - submitted to Licensor for inclusion in the Work by the copyright owner <nl> - or by an individual or Legal Entity authorized to submit on behalf of <nl> - the copyright owner . For the purposes of this definition , " submitted " <nl> - means any form of electronic , verbal , or written communication sent <nl> - to the Licensor or its representatives , including but not limited to <nl> - communication on electronic mailing lists , source code control systems , <nl> - and issue tracking systems that are managed by , or on behalf of , the <nl> - Licensor for the purpose of discussing and improving the Work , but <nl> - excluding communication that is conspicuously marked or otherwise <nl> - designated in writing by the copyright owner as " Not a Contribution . " <nl> - <nl> - " Contributor " shall mean Licensor and any individual or Legal Entity <nl> - on behalf of whom a Contribution has been received by Licensor and <nl> - subsequently incorporated within the Work . <nl> - <nl> - 2 . Grant of Copyright License . Subject to the terms and conditions of <nl> - this License , each Contributor hereby grants to You a perpetual , <nl> - worldwide , non - exclusive , no - charge , royalty - free , irrevocable <nl> - copyright license to reproduce , prepare Derivative Works of , <nl> - publicly display , publicly perform , sublicense , and distribute the <nl> - Work and such Derivative Works in Source or Object form . <nl> - <nl> - 3 . Grant of Patent License . Subject to the terms and conditions of <nl> - this License , each Contributor hereby grants to You a perpetual , <nl> - worldwide , non - exclusive , no - charge , royalty - free , irrevocable <nl> - ( except as stated in this section ) patent license to make , have made , <nl> - use , offer to sell , sell , import , and otherwise transfer the Work , <nl> - where such license applies only to those patent claims licensable <nl> - by such Contributor that are necessarily infringed by their <nl> - Contribution ( s ) alone or by combination of their Contribution ( s ) <nl> - with the Work to which such Contribution ( s ) was submitted . If You <nl> - institute patent litigation against any entity ( including a <nl> - cross - claim or counterclaim in a lawsuit ) alleging that the Work <nl> - or a Contribution incorporated within the Work constitutes direct <nl> - or contributory patent infringement , then any patent licenses <nl> - granted to You under this License for that Work shall terminate <nl> - as of the date such litigation is filed . <nl> - <nl> - 4 . Redistribution . You may reproduce and distribute copies of the <nl> - Work or Derivative Works thereof in any medium , with or without <nl> - modifications , and in Source or Object form , provided that You <nl> - meet the following conditions : <nl> - <nl> - ( a ) You must give any other recipients of the Work or <nl> - Derivative Works a copy of this License ; and <nl> - <nl> - ( b ) You must cause any modified files to carry prominent notices <nl> - stating that You changed the files ; and <nl> - <nl> - ( c ) You must retain , in the Source form of any Derivative Works <nl> - that You distribute , all copyright , patent , trademark , and <nl> - attribution notices from the Source form of the Work , <nl> - excluding those notices that do not pertain to any part of <nl> - the Derivative Works ; and <nl> - <nl> - ( d ) If the Work includes a " NOTICE " text file as part of its <nl> - distribution , then any Derivative Works that You distribute must <nl> - include a readable copy of the attribution notices contained <nl> - within such NOTICE file , excluding those notices that do not <nl> - pertain to any part of the Derivative Works , in at least one <nl> - of the following places : within a NOTICE text file distributed <nl> - as part of the Derivative Works ; within the Source form or <nl> - documentation , if provided along with the Derivative Works ; or , <nl> - within a display generated by the Derivative Works , if and <nl> - wherever such third - party notices normally appear . The contents <nl> - of the NOTICE file are for informational purposes only and <nl> - do not modify the License . You may add Your own attribution <nl> - notices within Derivative Works that You distribute , alongside <nl> - or as an addendum to the NOTICE text from the Work , provided <nl> - that such additional attribution notices cannot be construed <nl> - as modifying the License . <nl> - <nl> - You may add Your own copyright statement to Your modifications and <nl> - may provide additional or different license terms and conditions <nl> - for use , reproduction , or distribution of Your modifications , or <nl> - for any such Derivative Works as a whole , provided Your use , <nl> - reproduction , and distribution of the Work otherwise complies with <nl> - the conditions stated in this License . <nl> - <nl> - 5 . Submission of Contributions . Unless You explicitly state otherwise , <nl> - any Contribution intentionally submitted for inclusion in the Work <nl> - by You to the Licensor shall be under the terms and conditions of <nl> - this License , without any additional terms or conditions . <nl> - Notwithstanding the above , nothing herein shall supersede or modify <nl> - the terms of any separate license agreement you may have executed <nl> - with Licensor regarding such Contributions . <nl> - <nl> - 6 . Trademarks . This License does not grant permission to use the trade <nl> - names , trademarks , service marks , or product names of the Licensor , <nl> - except as required for reasonable and customary use in describing the <nl> - origin of the Work and reproducing the content of the NOTICE file . <nl> - <nl> - 7 . Disclaimer of Warranty . Unless required by applicable law or <nl> - agreed to in writing , Licensor provides the Work ( and each <nl> - Contributor provides its Contributions ) on an " AS IS " BASIS , <nl> - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or <nl> - implied , including , without limitation , any warranties or conditions <nl> - of TITLE , NON - INFRINGEMENT , MERCHANTABILITY , or FITNESS FOR A <nl> - PARTICULAR PURPOSE . You are solely responsible for determining the <nl> - appropriateness of using or redistributing the Work and assume any <nl> - risks associated with Your exercise of permissions under this License . <nl> - <nl> - 8 . Limitation of Liability . In no event and under no legal theory , <nl> - whether in tort ( including negligence ) , contract , or otherwise , <nl> - unless required by applicable law ( such as deliberate and grossly <nl> - negligent acts ) or agreed to in writing , shall any Contributor be <nl> - liable to You for damages , including any direct , indirect , special , <nl> - incidental , or consequential damages of any character arising as a <nl> - result of this License or out of the use or inability to use the <nl> - Work ( including but not limited to damages for loss of goodwill , <nl> - work stoppage , computer failure or malfunction , or any and all <nl> - other commercial damages or losses ) , even if such Contributor <nl> - has been advised of the possibility of such damages . <nl> - <nl> - 9 . Accepting Warranty or Additional Liability . While redistributing <nl> - the Work or Derivative Works thereof , You may choose to offer , <nl> - and charge a fee for , acceptance of support , warranty , indemnity , <nl> - or other liability obligations and / or rights consistent with this <nl> - License . However , in accepting such obligations , You may act only <nl> - on Your own behalf and on Your sole responsibility , not on behalf <nl> - of any other Contributor , and only if You agree to indemnify , <nl> - defend , and hold each Contributor harmless for any liability <nl> - incurred by , or claims asserted against , such Contributor by reason <nl> - of your accepting any such warranty or additional liability . <nl> - <nl> - END OF TERMS AND CONDITIONS <nl> - <nl> - APPENDIX : How to apply the Apache License to your work . <nl> - <nl> - To apply the Apache License to your work , attach the following <nl> - boilerplate notice , with the fields enclosed by brackets " [ ] " <nl> - replaced with your own identifying information . ( Don ' t include <nl> - the brackets ! ) The text should be enclosed in the appropriate <nl> - comment syntax for the file format . We also recommend that a <nl> - file or class name and description of purpose be included on the <nl> - same " printed page " as the copyright notice for easier <nl> - identification within third - party archives . <nl> - <nl> - Copyright [ yyyy ] [ name of copyright owner ] <nl> - <nl> - Licensed under the Apache License , Version 2 . 0 ( the " License " ) ; <nl> - you may not use this file except in compliance with the License . <nl> - You may obtain a copy of the License at <nl> - <nl> - http : / / www . apache . org / licenses / LICENSE - 2 . 0 <nl> - <nl> - Unless required by applicable law or agreed to in writing , software <nl> - distributed under the License is distributed on an " AS IS " BASIS , <nl> - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . <nl> - See the License for the specific language governing permissions and <nl> - limitations under the License . <nl> diff - - git a / lib / licenses / guava - r08 . txt b / lib / licenses / guava - r08 . txt <nl> new file mode 100644 <nl> index 0000000 . . d645695 <nl> - - - / dev / null <nl> + + + b / lib / licenses / guava - r08 . txt <nl> @ @ - 0 , 0 + 1 , 202 @ @ <nl> + <nl> + Apache License <nl> + Version 2 . 0 , January 2004 <nl> + http : / / www . apache . org / licenses / <nl> + <nl> + TERMS AND CONDITIONS FOR USE , REPRODUCTION , AND DISTRIBUTION <nl> + <nl> + 1 . Definitions . <nl> + <nl> + " License " shall mean the terms and conditions for use , reproduction , <nl> + and distribution as defined by Sections 1 through 9 of this document . <nl> + <nl> + " Licensor " shall mean the copyright owner or entity authorized by <nl> + the copyright owner that is granting the License . <nl> + <nl> + " Legal Entity " shall mean the union of the acting entity and all <nl> + other entities that control , are controlled by , or are under common <nl> + control with that entity . For the purposes of this definition , <nl> + " control " means ( i ) the power , direct or indirect , to cause the <nl> + direction or management of such entity , whether by contract or <nl> + otherwise , or ( ii ) ownership of fifty percent ( 50 % ) or more of the <nl> + outstanding shares , or ( iii ) beneficial ownership of such entity . <nl> + <nl> + " You " ( or " Your " ) shall mean an individual or Legal Entity <nl> + exercising permissions granted by this License . <nl> + <nl> + " Source " form shall mean the preferred form for making modifications , <nl> + including but not limited to software source code , documentation <nl> + source , and configuration files . <nl> + <nl> + " Object " form shall mean any form resulting from mechanical <nl> + transformation or translation of a Source form , including but <nl> + not limited to compiled object code , generated documentation , <nl> + and conversions to other media types . <nl> + <nl> + " Work " shall mean the work of authorship , whether in Source or <nl> + Object form , made available under the License , as indicated by a <nl> + copyright notice that is included in or attached to the work <nl> + ( an example is provided in the Appendix below ) . <nl> + <nl> + " Derivative Works " shall mean any work , whether in Source or Object <nl> + form , that is based on ( or derived from ) the Work and for which the <nl> + editorial revisions , annotations , elaborations , or other modifications <nl> + represent , as a whole , an original work of authorship . For the purposes <nl> + of this License , Derivative Works shall not include works that remain <nl> + separable from , or merely link ( or bind by name ) to the interfaces of , <nl> + the Work and Derivative Works thereof . <nl> + <nl> + " Contribution " shall mean any work of authorship , including <nl> + the original version of the Work and any modifications or additions <nl> + to that Work or Derivative Works thereof , that is intentionally <nl> + submitted to Licensor for inclusion in the Work by the copyright owner <nl> + or by an individual or Legal Entity authorized to submit on behalf of <nl> + the copyright owner . For the purposes of this definition , " submitted " <nl> + means any form of electronic , verbal , or written communication sent <nl> + to the Licensor or its representatives , including but not limited to <nl> + communication on electronic mailing lists , source code control systems , <nl> + and issue tracking systems that are managed by , or on behalf of , the <nl> + Licensor for the purpose of discussing and improving the Work , but <nl> + excluding communication that is conspicuously marked or otherwise <nl> + designated in writing by the copyright owner as " Not a Contribution . " <nl> + <nl> + " Contributor " shall mean Licensor and any individual or Legal Entity <nl> + on behalf of whom a Contribution has been received by Licensor and <nl> + subsequently incorporated within the Work . <nl> + <nl> + 2 . Grant of Copyright License . Subject to the terms and conditions of <nl> + this License , each Contributor hereby grants to You a perpetual , <nl> + worldwide , non - exclusive , no - charge , royalty - free , irrevocable <nl> + copyright license to reproduce , prepare Derivative Works of , <nl> + publicly display , publicly perform , sublicense , and distribute the <nl> + Work and such Derivative Works in Source or Object form . <nl> + <nl> + 3 . Grant of Patent License . Subject to the terms and conditions of <nl> + this License , each Contributor hereby grants to You a perpetual , <nl> + worldwide , non - exclusive , no - charge , royalty - free , irrevocable <nl> + ( except as stated in this section ) patent license to make , have made , <nl> + use , offer to sell , sell , import , and otherwise transfer the Work , <nl> + where such license applies only to those patent claims licensable <nl> + by such Contributor that are necessarily infringed by their <nl> + Contribution ( s ) alone or by combination of their Contribution ( s ) <nl> + with the Work to which such Contribution ( s ) was submitted . If You <nl> + institute patent litigation against any entity ( including a <nl> + cross - claim or counterclaim in a lawsuit ) alleging that the Work <nl> + or a Contribution incorporated within the Work constitutes direct <nl> + or contributory patent infringement , then any patent licenses <nl> + granted to You under this License for that Work shall terminate <nl> + as of the date such litigation is filed . <nl> + <nl> + 4 . Redistribution . You may reproduce and distribute copies of the <nl> + Work or Derivative Works thereof in any medium , with or without <nl> + modifications , and in Source or Object form , provided that You <nl> + meet the following conditions : <nl> + <nl> + ( a ) You must give any other recipients of the Work or <nl> + Derivative Works a copy of this License ; and <nl> + <nl> + ( b ) You must cause any modified files to carry prominent notices <nl> + stating that You changed the files ; and <nl> + <nl> + ( c ) You must retain , in the Source form of any Derivative Works <nl> + that You distribute , all copyright , patent , trademark , and <nl> + attribution notices from the Source form of the Work , <nl> + excluding those notices that do not pertain to any part of <nl> + the Derivative Works ; and <nl> + <nl> + ( d ) If the Work includes a " NOTICE " text file as part of its <nl> + distribution , then any Derivative Works that You distribute must <nl> + include a readable copy of the attribution notices contained <nl> + within such NOTICE file , excluding those notices that do not <nl> + pertain to any part of the Derivative Works , in at least one <nl> + of the following places : within a NOTICE text file distributed <nl> + as part of the Derivative Works ; within the Source form or <nl> + documentation , if provided along with the Derivative Works ; or , <nl> + within a display generated by the Derivative Works , if and <nl> + wherever such third - party notices normally appear . The contents <nl> + of the NOTICE file are for informational purposes only and <nl> + do not modify the License . You may add Your own attribution <nl> + notices within Derivative Works that You distribute , alongside <nl> + or as an addendum to the NOTICE text from the Work , provided <nl> + that such additional attribution notices cannot be construed <nl> + as modifying the License . <nl> + <nl> + You may add Your own copyright statement to Your modifications and <nl> + may provide additional or different license terms and conditions <nl> + for use , reproduction , or distribution of Your modifications , or <nl> + for any such Derivative Works as a whole , provided Your use , <nl> + reproduction , and distribution of the Work otherwise complies with <nl> + the conditions stated in this License . <nl> + <nl> + 5 . Submission of Contributions . Unless You explicitly state otherwise , <nl> + any Contribution intentionally submitted for inclusion in the Work <nl> + by You to the Licensor shall be under the terms and conditions of <nl> + this License , without any additional terms or conditions . <nl> + Notwithstanding the above , nothing herein shall supersede or modify <nl> + the terms of any separate license agreement you may have executed <nl> + with Licensor regarding such Contributions . <nl> + <nl> + 6 . Trademarks . This License does not grant permission to use the trade <nl> + names , trademarks , service marks , or product names of the Licensor , <nl> + except as required for reasonable and customary use in describing the <nl> + origin of the Work and reproducing the content of the NOTICE file . <nl> + <nl> + 7 . Disclaimer of Warranty . Unless required by applicable law or <nl> + agreed to in writing , Licensor provides the Work ( and each <nl> + Contributor provides its Contributions ) on an " AS IS " BASIS , <nl> + WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or <nl> + implied , including , without limitation , any warranties or conditions <nl> + of TITLE , NON - INFRINGEMENT , MERCHANTABILITY , or FITNESS FOR A <nl> + PARTICULAR PURPOSE . You are solely responsible for determining the <nl> + appropriateness of using or redistributing the Work and assume any <nl> + risks associated with Your exercise of permissions under this License . <nl> + <nl> + 8 . Limitation of Liability . In no event and under no legal theory , <nl> + whether in tort ( including negligence ) , contract , or otherwise , <nl> + unless required by applicable law ( such as deliberate and grossly <nl> + negligent acts ) or agreed to in writing , shall any Contributor be <nl> + liable to You for damages , including any direct , indirect , special , <nl> + incidental , or consequential damages of any character arising as a <nl> + result of this License or out of the use or inability to use the <nl> + Work ( including but not limited to damages for loss of goodwill , <nl> + work stoppage , computer failure or malfunction , or any and all <nl> + other commercial damages or losses ) , even if such Contributor <nl> + has been advised of the possibility of such damages . <nl> + <nl> + 9 . Accepting Warranty or Additional Liability . While redistributing <nl> + the Work or Derivative Works thereof , You may choose to offer , <nl> + and charge a fee for , acceptance of support , warranty , indemnity , <nl> + or other liability obligations and / or rights consistent with this <nl> + License . However , in accepting such obligations , You may act only <nl> + on Your own behalf and on Your sole responsibility , not on behalf <nl> + of any other Contributor , and only if You agree to indemnify , <nl> + defend , and hold each Contributor harmless for any liability <nl> + incurred by , or claims asserted against , such Contributor by reason <nl> + of your accepting any such warranty or additional liability . <nl> + <nl> + END OF TERMS AND CONDITIONS <nl> + <nl> + APPENDIX : How to apply the Apache License to your work . <nl> + <nl> + To apply the Apache License to your work , attach the following <nl> + boilerplate notice , with the fields enclosed by brackets " [ ] " <nl> + replaced with your own identifying information . ( Don ' t include <nl> + the brackets ! ) The text should be enclosed in the appropriate <nl> + comment syntax for the file format . We also recommend that a <nl> + file or class name and description of purpose be included on the <nl> + same " printed page " as the copyright notice for easier <nl> + identification within third - party archives . <nl> + <nl> + Copyright [ yyyy ] [ name of copyright owner ] <nl> + <nl> + Licensed under the Apache License , Version 2 . 0 ( the " License " ) ; <nl> + you may not use this file except in compliance with the License . <nl> + You may obtain a copy of the License at <nl> + <nl> + http : / / www . apache . org / licenses / LICENSE - 2 . 0 <nl> + <nl> + Unless required by applicable law or agreed to in writing , software <nl> + distributed under the License is distributed on an " AS IS " BASIS , <nl> + WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . <nl> + See the License for the specific language governing permissions and <nl> + limitations under the License .

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index a4811f6 . . 34533cc 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 55 , 6 + 55 , 7 @ @ 
 * Multi - threaded scrub / cleanup / upgradesstables ( CASSANDRA - 5547 ) 
 * Optimize cellname comparison ( CASSANDRA - 6934 ) 
 * Native protocol v3 ( CASSANDRA - 6855 ) 
 + * Optimize Cell liveness checks and clean up Cell ( CASSANDRA - 7119 ) 
 Merged from 2 . 0 : 
 * Allow overriding cassandra - rackdc . properties file ( CASSANDRA - 7072 ) 
 * Set JMX RMI port to 7199 ( CASSANDRA - 7087 ) 
 diff - - git a / src / java / org / apache / cassandra / cql / QueryProcessor . java b / src / java / org / apache / cassandra / cql / QueryProcessor . java 
 index 3b35555 . . 3c1d555 100644 
 - - - a / src / java / org / apache / cassandra / cql / QueryProcessor . java 
 + + + b / src / java / org / apache / cassandra / cql / QueryProcessor . java 
 @ @ - 469 , 7 + 469 , 7 @ @ public class QueryProcessor 
 { 
 for ( org . apache . cassandra . db . Cell c : row . cf . getSortedColumns ( ) ) 
 { 
 - if ( c . isMarkedForDelete ( now ) ) 
 + if ( ! c . isLive ( now ) ) 
 continue ; 
 
 ColumnDefinition cd = metadata . getColumnDefinition ( c . name ( ) ) ; 
 @ @ - 515 , 7 + 515 , 7 @ @ public class QueryProcessor 
 if ( cd ! = null ) 
 result . schema . value _ types . put ( nameBytes , TypeParser . getShortName ( cd . type ) ) ; 
 org . apache . cassandra . db . Cell c = row . cf . getColumn ( name ) ; 
 - if ( c = = null | | c . isMarkedForDelete ( System . currentTimeMillis ( ) ) ) 
 + if ( c = = null | | ! c . isLive ( ) ) 
 thriftColumns . add ( new Column ( ) . setName ( nameBytes ) ) ; 
 else 
 thriftColumns . add ( thriftify ( c ) ) ; 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / Selection . java b / src / java / org / apache / cassandra / cql3 / statements / Selection . java 
 index c506cc6 . . af1e621 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / Selection . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / Selection . java 
 @ @ - 315 , 7 + 315 , 7 @ @ public abstract class Selection 
 
 private boolean isDead ( Cell c ) 
 { 
 - return c = = null | | c . isMarkedForDelete ( now ) ; 
 + return c = = null | | ! c . isLive ( now ) ; 
 } 
 
 public void newRow ( ) throws InvalidRequestException 
 diff - - git a / src / java / org / apache / cassandra / db / AbstractCell . java b / src / java / org / apache / cassandra / db / AbstractCell . java 
 index 1075278 . . 238b8c0 100644 
 - - - a / src / java / org / apache / cassandra / db / AbstractCell . java 
 + + + b / src / java / org / apache / cassandra / db / AbstractCell . java 
 @ @ - 63 , 32 + 63 , 21 @ @ public abstract class AbstractCell implements Cell 
 } ; 
 } 
 
 - @ Override 
 - public boolean isMarkedForDelete ( long now ) 
 + public boolean isLive ( ) 
 { 
 - return false ; 
 + return true ; 
 } 
 
 - @ Override 
 public boolean isLive ( long now ) 
 { 
 - return ! isMarkedForDelete ( now ) ; 
 - } 
 - 
 - / / Don ' t call unless the column is actually marked for delete . 
 - @ Override 
 - public long getMarkedForDeleteAt ( ) 
 - { 
 - return Long . MAX _ VALUE ; 
 + return true ; 
 } 
 
 - @ Override 
 public int cellDataSize ( ) 
 { 
 return name ( ) . dataSize ( ) + value ( ) . remaining ( ) + TypeSizes . NATIVE . sizeof ( timestamp ( ) ) ; 
 } 
 
 - @ Override 
 public int serializedSize ( CellNameType type , TypeSizes typeSizes ) 
 { 
 / * 
 @ @ - 103 , 13 + 92 , 11 @ @ public abstract class AbstractCell implements Cell 
 return ( ( int ) type . cellSerializer ( ) . serializedSize ( name ( ) , typeSizes ) ) + 1 + typeSizes . sizeof ( timestamp ( ) ) + typeSizes . sizeof ( valueSize ) + valueSize ; 
 } 
 
 - @ Override 
 public int serializationFlags ( ) 
 { 
 return 0 ; 
 } 
 
 - @ Override 
 public Cell diff ( Cell cell ) 
 { 
 if ( timestamp ( ) < cell . timestamp ( ) ) 
 @ @ - 117 , 7 + 104 , 6 @ @ public abstract class AbstractCell implements Cell 
 return null ; 
 } 
 
 - @ Override 
 public void updateDigest ( MessageDigest digest ) 
 { 
 digest . update ( name ( ) . toByteBuffer ( ) . duplicate ( ) ) ; 
 @ @ - 127 , 19 + 113 , 17 @ @ public abstract class AbstractCell implements Cell 
 FBUtilities . updateWithByte ( digest , serializationFlags ( ) ) ; 
 } 
 
 - @ Override 
 public int getLocalDeletionTime ( ) 
 { 
 return Integer . MAX _ VALUE ; 
 } 
 
 - @ Override 
 public Cell reconcile ( Cell cell ) 
 { 
 / / tombstones take precedence . ( if both are tombstones , then it doesn ' t matter which one we use . ) 
 - if ( isMarkedForDelete ( System . currentTimeMillis ( ) ) ) 
 + if ( ! isLive ( ) ) 
 return timestamp ( ) < cell . timestamp ( ) ? cell : this ; 
 - if ( cell . isMarkedForDelete ( System . currentTimeMillis ( ) ) ) 
 + if ( ! cell . isLive ( ) ) 
 return timestamp ( ) > cell . timestamp ( ) ? this : cell ; 
 / / break ties by comparing values . 
 if ( timestamp ( ) = = cell . timestamp ( ) ) 
 @ @ - 164 , 23 + 148 , 20 @ @ public abstract class AbstractCell implements Cell 
 throw new UnsupportedOperationException ( ) ; 
 } 
 
 - @ Override 
 public String getString ( CellNameType comparator ) 
 { 
 return String . format ( " % s : % b : % d @ % d " , 
 - comparator . getString ( name ( ) ) , 
 - isMarkedForDelete ( System . currentTimeMillis ( ) ) , 
 - value ( ) . remaining ( ) , 
 - timestamp ( ) ) ; 
 + comparator . getString ( name ( ) ) , 
 + ! isLive ( ) , 
 + value ( ) . remaining ( ) , 
 + timestamp ( ) ) ; 
 } 
 
 - @ Override 
 public void validateName ( CFMetaData metadata ) throws MarshalException 
 { 
 metadata . comparator . validate ( name ( ) ) ; 
 } 
 
 - @ Override 
 public void validateFields ( CFMetaData metadata ) throws MarshalException 
 { 
 validateName ( metadata ) ; 
 @ @ - 225 , 7 + 206 , 7 @ @ public abstract class AbstractCell implements Cell 
 assert ( b instanceof CounterCell ) | | ( b instanceof DeletedCell ) : " Wrong class type : " + b . getClass ( ) ; 
 
 / / live + tombstone : track last tombstone 
 - if ( b . isMarkedForDelete ( Long . MIN _ VALUE ) ) / / cannot be an expired cell , so the current time is irrelevant 
 + if ( ! b . isLive ( ) ) / / cannot be an expired cell , so the current time is irrelevant 
 { 
 / / live < tombstone 
 if ( a . timestamp ( ) < b . timestamp ( ) ) 
 diff - - git a / src / java / org / apache / cassandra / db / BufferCounterUpdateCell . java b / src / java / org / apache / cassandra / db / BufferCounterUpdateCell . java 
 index 44ab83e . . 24c9fad 100644 
 - - - a / src / java / org / apache / cassandra / db / BufferCounterUpdateCell . java 
 + + + b / src / java / org / apache / cassandra / db / BufferCounterUpdateCell . java 
 @ @ - 55 , 16 + 55 , 16 @ @ public class BufferCounterUpdateCell extends BufferCell implements CounterUpdate 
 public Cell reconcile ( Cell cell ) 
 { 
 / / The only time this could happen is if a batchAdd ships two 
 - / / increment for the same cell . Hence we simply sums the delta . 
 + / / increment for the same cell . Hence we simply sums the delta and the timestamps . 
 
 / / tombstones take precedence 
 - if ( cell . isMarkedForDelete ( Long . MIN _ VALUE ) ) / / can ' t be an expired cell , so the current time is irrelevant 
 + if ( ! cell . isLive ( ) ) / / can ' t be an expired cell , so the current time is irrelevant 
 return timestamp > cell . timestamp ( ) ? this : cell ; 
 
 / / neither is tombstoned 
 assert cell instanceof CounterUpdateCell : " Wrong class type . " ; 
 CounterUpdateCell c = ( CounterUpdateCell ) cell ; 
 - return new BufferCounterUpdateCell ( name , delta ( ) + c . delta ( ) , Math . max ( timestamp , c . timestamp ( ) ) ) ; 
 + return new BufferCounterUpdateCell ( name , delta ( ) + c . delta ( ) , timestamp + c . timestamp ( ) ) ; 
 } 
 
 @ Override 
 diff - - git a / src / java / org / apache / cassandra / db / BufferDeletedCell . java b / src / java / org / apache / cassandra / db / BufferDeletedCell . java 
 index a6518de . . bcc170f 100644 
 - - - a / src / java / org / apache / cassandra / db / BufferDeletedCell . java 
 + + + b / src / java / org / apache / cassandra / db / BufferDeletedCell . java 
 @ @ - 54 , 15 + 54 , 15 @ @ public class BufferDeletedCell extends BufferCell implements DeletedCell 
 } 
 
 @ Override 
 - public boolean isMarkedForDelete ( long now ) 
 + public boolean isLive ( ) 
 { 
 - return true ; 
 + return false ; 
 } 
 
 @ Override 
 - public long getMarkedForDeleteAt ( ) 
 + public boolean isLive ( long now ) 
 { 
 - return timestamp ; 
 + return false ; 
 } 
 
 @ Override 
 diff - - git a / src / java / org / apache / cassandra / db / BufferExpiringCell . java b / src / java / org / apache / cassandra / db / BufferExpiringCell . java 
 index 95ed45a . . 38d84f4 100644 
 - - - a / src / java / org / apache / cassandra / db / BufferExpiringCell . java 
 + + + b / src / java / org / apache / cassandra / db / BufferExpiringCell . java 
 @ @ - 114 , 15 + 114 , 15 @ @ public class BufferExpiringCell extends BufferCell implements ExpiringCell 
 } 
 
 @ Override 
 - public boolean isMarkedForDelete ( long now ) 
 + public boolean isLive ( ) 
 { 
 - return ( int ) ( now / 1000 ) > = getLocalDeletionTime ( ) ; 
 + return isLive ( System . currentTimeMillis ( ) ) ; 
 } 
 
 @ Override 
 - public long getMarkedForDeleteAt ( ) 
 + public boolean isLive ( long now ) 
 { 
 - return timestamp ; 
 + return ( int ) ( now / 1000 ) < getLocalDeletionTime ( ) ; 
 } 
 
 @ Override 
 diff - - git a / src / java / org / apache / cassandra / db / Cell . java b / src / java / org / apache / cassandra / db / Cell . java 
 index c19b5dd . . f91376d 100644 
 - - - a / src / java / org / apache / cassandra / db / Cell . java 
 + + + b / src / java / org / apache / cassandra / db / Cell . java 
 @ @ - 22 , 7 + 22 , 6 @ @ import java . nio . ByteBuffer ; 
 import org . apache . cassandra . config . CFMetaData ; 
 import org . apache . cassandra . db . composites . CellName ; 
 import org . apache . cassandra . db . composites . CellNameType ; 
 - import org . apache . cassandra . serializers . MarshalException ; 
 import org . apache . cassandra . utils . concurrent . OpOrder ; 
 import org . apache . cassandra . utils . memory . AbstractAllocator ; 
 import org . apache . cassandra . utils . FBUtilities ; 
 @ @ - 44 , 13 + 43 , 10 @ @ public interface Cell extends OnDiskAtom 
 
 public ByteBuffer value ( ) ; 
 
 - public boolean isMarkedForDelete ( long now ) ; 
 + public boolean isLive ( ) ; 
 
 public boolean isLive ( long now ) ; 
 
 - / / Don ' t call unless the column is actually marked for delete . 
 - public long getMarkedForDeleteAt ( ) ; 
 - 
 public int cellDataSize ( ) ; 
 
 / / returns the size of the Cell and all references on the heap , excluding any costs associated with byte arrays 
 @ @ - 58 , 6 + 54 , 7 @ @ public interface Cell extends OnDiskAtom 
 public long excessHeapSizeExcludingData ( ) ; 
 
 public int serializedSize ( CellNameType type , TypeSizes typeSizes ) ; 
 + 
 public int serializationFlags ( ) ; 
 
 public Cell diff ( Cell cell ) ; 
 @ @ - 69 , 6 + 66 , 4 @ @ public interface Cell extends OnDiskAtom 
 public Cell localCopy ( CFMetaData metaData , MemtableAllocator allocator , OpOrder . Group opGroup ) ; 
 
 public String getString ( CellNameType comparator ) ; 
 - 
 - void validateName ( CFMetaData metadata ) throws MarshalException ; 
 } 
 diff - - git a / src / java / org / apache / cassandra / db / CounterMutation . java b / src / java / org / apache / cassandra / db / CounterMutation . java 
 index 32571cc . . 58889c1 100644 
 - - - a / src / java / org / apache / cassandra / db / CounterMutation . java 
 + + + b / src / java / org / apache / cassandra / db / CounterMutation . java 
 @ @ - 265 , 7 + 265 , 7 @ @ public class CounterMutation implements IMutation 
 continue ; 
 
 Cell cell = cf = = null ? null : cf . getColumn ( counterUpdateCells . get ( i ) . name ( ) ) ; 
 - if ( cell = = null | | cell . isMarkedForDelete ( Long . MIN _ VALUE ) ) / / absent or a tombstone . 
 + if ( cell = = null | | ! cell . isLive ( ) ) / / absent or a tombstone . 
 currentValues [ i ] = ClockAndCount . BLANK ; 
 else 
 currentValues [ i ] = CounterContext . instance ( ) . getLocalClockAndCount ( cell . value ( ) ) ; 
 diff - - git a / src / java / org / apache / cassandra / db / HintedHandOffManager . java b / src / java / org / apache / cassandra / db / HintedHandOffManager . java 
 index 8c892d6 . . 0337756 100644 
 - - - a / src / java / org / apache / cassandra / db / HintedHandOffManager . java 
 + + + b / src / java / org / apache / cassandra / db / HintedHandOffManager . java 
 @ @ - 402 , 7 + 402 , 7 @ @ public class HintedHandOffManager implements HintedHandOffManagerMBean 
 / / in which the local deletion timestamp was generated on the last column in the old page , in which 
 / / case the hint will have no columns ( since it ' s deleted ) but will still be included in the resultset 
 / / since ( even with gcgs = 0 ) it ' s still a " relevant " tombstone . 
 - if ( ! hint . isLive ( System . currentTimeMillis ( ) ) ) 
 + if ( ! hint . isLive ( ) ) 
 continue ; 
 
 startColumn = hint . name ( ) ; 
 diff - - git a / src / java / org / apache / cassandra / db / NativeDeletedCell . java b / src / java / org / apache / cassandra / db / NativeDeletedCell . java 
 index 8bfc95b . . 20118a4 100644 
 - - - a / src / java / org / apache / cassandra / db / NativeDeletedCell . java 
 + + + b / src / java / org / apache / cassandra / db / NativeDeletedCell . java 
 @ @ - 50 , 15 + 50 , 15 @ @ public class NativeDeletedCell extends NativeCell implements DeletedCell 
 } 
 
 @ Override 
 - public boolean isMarkedForDelete ( long now ) 
 + public boolean isLive ( ) 
 { 
 - return true ; 
 + return false ; 
 } 
 
 @ Override 
 - public long getMarkedForDeleteAt ( ) 
 + public boolean isLive ( long now ) 
 { 
 - return timestamp ( ) ; 
 + return false ; 
 } 
 
 @ Override 
 diff - - git a / src / java / org / apache / cassandra / db / NativeExpiringCell . java b / src / java / org / apache / cassandra / db / NativeExpiringCell . java 
 index 0822fbd . . fcadb16 100644 
 - - - a / src / java / org / apache / cassandra / db / NativeExpiringCell . java 
 + + + b / src / java / org / apache / cassandra / db / NativeExpiringCell . java 
 @ @ - 76 , 15 + 76 , 15 @ @ public class NativeExpiringCell extends NativeCell implements ExpiringCell 
 } 
 
 @ Override 
 - public boolean isMarkedForDelete ( long now ) 
 + public boolean isLive ( ) 
 { 
 - return ( int ) ( now / 1000 ) > = getLocalDeletionTime ( ) ; 
 + return isLive ( System . currentTimeMillis ( ) ) ; 
 } 
 
 @ Override 
 - public long getMarkedForDeleteAt ( ) 
 + public boolean isLive ( long now ) 
 { 
 - return timestamp ( ) ; 
 + return ( int ) ( now / 1000 ) < getLocalDeletionTime ( ) ; 
 } 
 
 @ Override 
 diff - - git a / src / java / org / apache / cassandra / db / compaction / LazilyCompactedRow . java b / src / java / org / apache / cassandra / db / compaction / LazilyCompactedRow . java 
 index 4f211f4 . . d0f3610 100644 
 - - - a / src / java / org / apache / cassandra / db / compaction / LazilyCompactedRow . java 
 + + + b / src / java / org / apache / cassandra / db / compaction / LazilyCompactedRow . java 
 @ @ - 223 , 11 + 223 , 8 @ @ public class LazilyCompactedRow extends AbstractCompactedRow 
 if ( indexer = = SecondaryIndexManager . nullUpdater ) 
 return ; 
 
 - if ( ! cell . isMarkedForDelete ( System . currentTimeMillis ( ) ) 
 - & & ! container . getColumn ( cell . name ( ) ) . equals ( cell ) ) 
 - { 
 + if ( cell . isLive ( ) & & ! container . getColumn ( cell . name ( ) ) . equals ( cell ) ) 
 indexer . remove ( cell ) ; 
 - } 
 } 
 } 
 
 diff - - git a / src / java / org / apache / cassandra / db / composites / AbstractCellNameType . java b / src / java / org / apache / cassandra / db / composites / AbstractCellNameType . java 
 index 826f71a . . 56be8cf 100644 
 - - - a / src / java / org / apache / cassandra / db / composites / AbstractCellNameType . java 
 + + + b / src / java / org / apache / cassandra / db / composites / AbstractCellNameType . java 
 @ @ - 271 , 7 + 271 , 7 @ @ public abstract class AbstractCellNameType extends AbstractCType implements Cell 
 while ( cells . hasNext ( ) ) 
 { 
 final Cell cell = cells . next ( ) ; 
 - if ( cell . isMarkedForDelete ( now ) ) 
 + if ( ! cell . isLive ( now ) ) 
 continue ; 
 
 return new CQL3Row ( ) 
 @ @ - 343 , 7 + 343 , 7 @ @ public abstract class AbstractCellNameType extends AbstractCType implements Cell 
 while ( cells . hasNext ( ) ) 
 { 
 Cell cell = cells . next ( ) ; 
 - if ( cell . isMarkedForDelete ( now ) ) 
 + if ( ! cell . isLive ( now ) ) 
 continue ; 
 
 nextCell = cell ; 
 diff - - git a / src / java / org / apache / cassandra / db / index / AbstractSimplePerColumnSecondaryIndex . java b / src / java / org / apache / cassandra / db / index / AbstractSimplePerColumnSecondaryIndex . java 
 index 164c96f . . b64d84f 100644 
 - - - a / src / java / org / apache / cassandra / db / index / AbstractSimplePerColumnSecondaryIndex . java 
 + + + b / src / java / org / apache / cassandra / db / index / AbstractSimplePerColumnSecondaryIndex . java 
 @ @ - 31 , 7 + 31 , 6 @ @ import org . apache . cassandra . dht . LocalToken ; 
 import org . apache . cassandra . utils . ByteBufferUtil ; 
 import org . apache . cassandra . utils . FBUtilities ; 
 import org . apache . cassandra . utils . concurrent . OpOrder ; 
 - import org . apache . cassandra . utils . memory . MemtableAllocator ; 
 
 / * * 
 * Implements a secondary index for a column family using a second column family 
 @ @ - 89 , 7 + 88 , 7 @ @ public abstract class AbstractSimplePerColumnSecondaryIndex extends PerColumnSec 
 
 public void delete ( ByteBuffer rowKey , Cell cell , OpOrder . Group opGroup ) 
 { 
 - if ( cell . isMarkedForDelete ( System . currentTimeMillis ( ) ) ) 
 + if ( ! cell . isLive ( ) ) 
 return ; 
 
 DecoratedKey valueKey = getIndexKeyFor ( getIndexedValue ( rowKey , cell ) ) ; 
 diff - - git a / src / java / org / apache / cassandra / db / index / SecondaryIndexManager . java b / src / java / org / apache / cassandra / db / index / SecondaryIndexManager . java 
 index 39bc26b . . 36c7e1e 100644 
 - - - a / src / java / org / apache / cassandra / db / index / SecondaryIndexManager . java 
 + + + b / src / java / org / apache / cassandra / db / index / SecondaryIndexManager . java 
 @ @ - 656 , 7 + 656 , 7 @ @ public class SecondaryIndexManager 
 
 public void remove ( Cell cell ) 
 { 
 - if ( cell . isMarkedForDelete ( System . currentTimeMillis ( ) ) ) 
 + if ( ! cell . isLive ( ) ) 
 return ; 
 
 for ( SecondaryIndex index : indexFor ( cell . name ( ) ) ) 
 @ @ - 693 , 7 + 693 , 7 @ @ public class SecondaryIndexManager 
 
 public void insert ( Cell cell ) 
 { 
 - if ( cell . isMarkedForDelete ( System . currentTimeMillis ( ) ) ) 
 + if ( ! cell . isLive ( ) ) 
 return ; 
 
 for ( SecondaryIndex index : indexFor ( cell . name ( ) ) ) 
 @ @ - 710 , 7 + 710 , 7 @ @ public class SecondaryIndexManager 
 { 
 if ( index instanceof PerColumnSecondaryIndex ) 
 { 
 - if ( ! cell . isMarkedForDelete ( System . currentTimeMillis ( ) ) ) 
 + if ( cell . isLive ( ) ) 
 ( ( PerColumnSecondaryIndex ) index ) . update ( key . getKey ( ) , oldCell , cell , opGroup ) ; 
 else 
 ( ( PerColumnSecondaryIndex ) index ) . delete ( key . getKey ( ) , oldCell , opGroup ) ; 
 @ @ - 720 , 7 + 720 , 7 @ @ public class SecondaryIndexManager 
 
 public void remove ( Cell cell ) 
 { 
 - if ( cell . isMarkedForDelete ( System . currentTimeMillis ( ) ) ) 
 + if ( ! cell . isLive ( ) ) 
 return ; 
 
 for ( SecondaryIndex index : indexFor ( cell . name ( ) ) ) 
 diff - - git a / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnCollectionKey . java b / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnCollectionKey . java 
 index 2aff39d . . 2d25f8e 100644 
 - - - a / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnCollectionKey . java 
 + + + b / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnCollectionKey . java 
 @ @ - 100 , 7 + 100 , 7 @ @ public class CompositesIndexOnCollectionKey extends CompositesIndex 
 public boolean isStale ( IndexedEntry entry , ColumnFamily data , long now ) 
 { 
 CellName name = data . getComparator ( ) . create ( entry . indexedEntryPrefix , columnDef , entry . indexValue . getKey ( ) ) ; 
 - Cell liveCell = data . getColumn ( name ) ; 
 - return ( liveCell = = null | | liveCell . isMarkedForDelete ( now ) ) ; 
 + Cell cell = data . getColumn ( name ) ; 
 + return cell = = null | | ! cell . isLive ( now ) ; 
 } 
 } 
 diff - - git a / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnCollectionValue . java b / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnCollectionValue . java 
 index 67293aa . . 63589f4 100644 
 - - - a / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnCollectionValue . java 
 + + + b / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnCollectionValue . java 
 @ @ - 48 , 7 + 48 , 7 @ @ public class CompositesIndexOnCollectionValue extends CompositesIndex 
 public static CellNameType buildIndexComparator ( CFMetaData baseMetadata , ColumnDefinition columnDef ) 
 { 
 int prefixSize = columnDef . position ( ) ; 
 - List < AbstractType < ? > > types = new ArrayList < AbstractType < ? > > ( prefixSize + 2 ) ; 
 + List < AbstractType < ? > > types = new ArrayList < > ( prefixSize + 2 ) ; 
 types . add ( SecondaryIndex . keyComparator ) ; 
 for ( int i = 0 ; i < prefixSize ; i + + ) 
 types . add ( baseMetadata . comparator . subtype ( i ) ) ; 
 @ @ - 98 , 11 + 98 , 7 @ @ public class CompositesIndexOnCollectionValue extends CompositesIndex 
 public boolean isStale ( IndexedEntry entry , ColumnFamily data , long now ) 
 { 
 CellName name = data . getComparator ( ) . create ( entry . indexedEntryPrefix , columnDef , entry . indexedEntryCollectionKey ) ; 
 - Cell liveCell = data . getColumn ( name ) ; 
 - if ( liveCell = = null | | liveCell . isMarkedForDelete ( now ) ) 
 - return true ; 
 - 
 - ByteBuffer liveValue = liveCell . value ( ) ; 
 - return ( ( CollectionType ) columnDef . type ) . valueComparator ( ) . compare ( entry . indexValue . getKey ( ) , liveValue ) ! = 0 ; 
 + Cell cell = data . getColumn ( name ) ; 
 + return cell = = null | | ! cell . isLive ( now ) | | ( ( CollectionType ) columnDef . type ) . valueComparator ( ) . compare ( entry . indexValue . getKey ( ) , cell . value ( ) ) ! = 0 ; 
 } 
 } 
 diff - - git a / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnRegular . java b / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnRegular . java 
 index 0cfd240 . . b9dc07f 100644 
 - - - a / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnRegular . java 
 + + + b / src / java / org / apache / cassandra / db / index / composites / CompositesIndexOnRegular . java 
 @ @ - 90 , 11 + 90 , 7 @ @ public class CompositesIndexOnRegular extends CompositesIndex 
 public boolean isStale ( IndexedEntry entry , ColumnFamily data , long now ) 
 { 
 CellName name = data . getComparator ( ) . create ( entry . indexedEntryPrefix , columnDef ) ; 
 - Cell liveCell = data . getColumn ( name ) ; 
 - if ( liveCell = = null | | liveCell . isMarkedForDelete ( now ) ) 
 - return true ; 
 - 
 - ByteBuffer liveValue = liveCell . value ( ) ; 
 - return columnDef . type . compare ( entry . indexValue . getKey ( ) , liveValue ) ! = 0 ; 
 + Cell cell = data . getColumn ( name ) ; 
 + return cell = = null | | ! cell . isLive ( now ) | | columnDef . type . compare ( entry . indexValue . getKey ( ) , cell . value ( ) ) ! = 0 ; 
 } 
 } 
 diff - - git a / src / java / org / apache / cassandra / db / index / composites / CompositesSearcher . java b / src / java / org / apache / cassandra / db / index / composites / CompositesSearcher . java 
 index 22d4361 . . dbce024 100644 
 - - - a / src / java / org / apache / cassandra / db / index / composites / CompositesSearcher . java 
 + + + b / src / java / org / apache / cassandra / db / index / composites / CompositesSearcher . java 
 @ @ - 19 , 11 + 19 , 7 @ @ package org . apache . cassandra . db . index . composites ; 
 
 import java . io . IOException ; 
 import java . nio . ByteBuffer ; 
 - import java . util . ArrayDeque ; 
 - import java . util . Collection ; 
 - import java . util . Deque ; 
 - import java . util . List ; 
 - import java . util . Set ; 
 + import java . util . * ; 
 
 import org . slf4j . Logger ; 
 import org . slf4j . LoggerFactory ; 
 @ @ - 205 , 7 + 201 , 7 @ @ public class CompositesSearcher extends SecondaryIndexSearcher 
 { 
 Cell cell = indexCells . poll ( ) ; 
 lastSeenPrefix = cell . name ( ) ; 
 - if ( cell . isMarkedForDelete ( filter . timestamp ) ) 
 + if ( ! cell . isLive ( filter . timestamp ) ) 
 { 
 logger . trace ( " skipping { } " , cell . name ( ) ) ; 
 continue ; 
 diff - - git a / src / java / org / apache / cassandra / db / index / keys / KeysIndex . java b / src / java / org / apache / cassandra / db / index / keys / KeysIndex . java 
 index e532a53 . . 7cacb67 100644 
 - - - a / src / java / org / apache / cassandra / db / index / keys / KeysIndex . java 
 + + + b / src / java / org / apache / cassandra / db / index / keys / KeysIndex . java 
 @ @ - 52 , 12 + 52 , 8 @ @ public class KeysIndex extends AbstractSimplePerColumnSecondaryIndex 
 
 public boolean isIndexEntryStale ( ByteBuffer indexedValue , ColumnFamily data , long now ) 
 { 
 - Cell liveCell = data . getColumn ( data . getComparator ( ) . makeCellName ( columnDef . name . bytes ) ) ; 
 - if ( liveCell = = null | | liveCell . isMarkedForDelete ( now ) ) 
 - return true ; 
 - 
 - ByteBuffer liveValue = liveCell . value ( ) ; 
 - return columnDef . type . compare ( indexedValue , liveValue ) ! = 0 ; 
 + Cell cell = data . getColumn ( data . getComparator ( ) . makeCellName ( columnDef . name . bytes ) ) ; 
 + return cell = = null | | ! cell . isLive ( now ) | | columnDef . type . compare ( indexedValue , cell . value ( ) ) ! = 0 ; 
 } 
 
 public void validateOptions ( ) throws ConfigurationException 
 diff - - git a / src / java / org / apache / cassandra / db / index / keys / KeysSearcher . java b / src / java / org / apache / cassandra / db / index / keys / KeysSearcher . java 
 index d166c08 . . 4055b7c 100644 
 - - - a / src / java / org / apache / cassandra / db / index / keys / KeysSearcher . java 
 + + + b / src / java / org / apache / cassandra / db / index / keys / KeysSearcher . java 
 @ @ - 154 , 7 + 154 , 7 @ @ public class KeysSearcher extends SecondaryIndexSearcher 
 { 
 Cell cell = indexColumns . next ( ) ; 
 lastSeenKey = cell . name ( ) ; 
 - if ( cell . isMarkedForDelete ( filter . timestamp ) ) 
 + if ( ! cell . isLive ( filter . timestamp ) ) 
 { 
 logger . trace ( " skipping { } " , cell . name ( ) ) ; 
 continue ; 
 diff - - git a / src / java / org / apache / cassandra / service / CacheService . java b / src / java / org / apache / cassandra / service / CacheService . java 
 index 048bad4 . . 78f6d66 100644 
 - - - a / src / java / org / apache / cassandra / service / CacheService . java 
 + + + b / src / java / org / apache / cassandra / service / CacheService . java 
 @ @ - 406 , 7 + 406 , 7 @ @ public class CacheService implements CacheServiceMBean 
 if ( cf = = null ) 
 return null ; 
 Cell cell = cf . getColumn ( cellName ) ; 
 - if ( cell = = null | | cell . isMarkedForDelete ( Long . MIN _ VALUE ) ) 
 + if ( cell = = null | | ! cell . isLive ( Long . MIN _ VALUE ) ) 
 return null ; 
 ClockAndCount clockAndCount = CounterContext . instance ( ) . getLocalClockAndCount ( cell . value ( ) ) ; 
 return Pair . create ( CounterCacheKey . create ( cfs . metadata . cfId , partitionKey , cellName ) , clockAndCount ) ; 
 diff - - git a / src / java / org / apache / cassandra / thrift / CassandraServer . java b / src / java / org / apache / cassandra / thrift / CassandraServer . java 
 index 3040aaf . . 069cec7 100644 
 - - - a / src / java / org / apache / cassandra / thrift / CassandraServer . java 
 + + + b / src / java / org / apache / cassandra / thrift / CassandraServer . java 
 @ @ - 137 , 7 + 137 , 7 @ @ public class CassandraServer implements Cassandra . Iface 
 ArrayList < ColumnOrSuperColumn > thriftColumns = new ArrayList < ColumnOrSuperColumn > ( cells . size ( ) ) ; 
 for ( Cell cell : cells ) 
 { 
 - if ( cell . isMarkedForDelete ( now ) ) 
 + if ( ! cell . isLive ( now ) ) 
 continue ; 
 
 thriftColumns . add ( thriftifyColumnWithName ( cell , cell . name ( ) . toByteBuffer ( ) ) ) ; 
 @ @ - 176 , 7 + 176 , 7 @ @ public class CassandraServer implements Cassandra . Iface 
 List < Column > thriftColumns = new ArrayList < Column > ( cells . size ( ) ) ; 
 for ( Cell cell : cells ) 
 { 
 - if ( cell . isMarkedForDelete ( now ) ) 
 + if ( ! cell . isLive ( now ) ) 
 continue ; 
 
 thriftColumns . add ( thriftifySubColumn ( cell ) ) ; 
 @ @ - 201 , 7 + 201 , 7 @ @ public class CassandraServer implements Cassandra . Iface 
 ArrayList < ColumnOrSuperColumn > thriftSuperColumns = new ArrayList < ColumnOrSuperColumn > ( cells . size ( ) ) ; 
 for ( Cell cell : cells ) 
 { 
 - if ( cell . isMarkedForDelete ( now ) ) 
 + if ( ! cell . isLive ( now ) ) 
 continue ; 
 
 thriftSuperColumns . add ( thriftifyColumnWithName ( cell , SuperColumns . subName ( cell . name ( ) ) ) ) ; 
 @ @ - 225 , 7 + 225 , 7 @ @ public class CassandraServer implements Cassandra . Iface 
 SuperColumn current = null ; 
 for ( Cell cell : cells ) 
 { 
 - if ( cell . isMarkedForDelete ( now ) ) 
 + if ( ! cell . isLive ( now ) ) 
 continue ; 
 
 ByteBuffer scName = SuperColumns . scName ( cell . name ( ) ) ; 
 @ @ - 249 , 7 + 249 , 7 @ @ public class CassandraServer implements Cassandra . Iface 
 CounterSuperColumn current = null ; 
 for ( Cell cell : cells ) 
 { 
 - if ( cell . isMarkedForDelete ( now ) ) 
 + if ( ! cell . isLive ( now ) ) 
 continue ; 
 
 ByteBuffer scName = SuperColumns . scName ( cell . name ( ) ) ; 
 diff - - git a / test / unit / org / apache / cassandra / db / ColumnFamilyTest . java b / test / unit / org / apache / cassandra / db / ColumnFamilyTest . java 
 index 7f8da96 . . 151cbdc 100644 
 - - - a / test / unit / org / apache / cassandra / db / ColumnFamilyTest . java 
 + + + b / test / unit / org / apache / cassandra / db / ColumnFamilyTest . java 
 @ @ - 38 , 6 + 38 , 7 @ @ import static org . apache . cassandra . Util . column ; 
 import static org . apache . cassandra . Util . cellname ; 
 import static org . apache . cassandra . Util . tombstone ; 
 import static org . junit . Assert . assertEquals ; 
 + import static org . junit . Assert . assertFalse ; 
 
 public class ColumnFamilyTest extends SchemaLoader 
 { 
 @ @ - 184 , 9 + 185 , 9 @ @ public class ColumnFamilyTest extends SchemaLoader 
 
 / / check that tombstone wins timestamp ties 
 cf _ result . addTombstone ( cellname ( " col1 " ) , 0 , 3 ) ; 
 - assert cf _ result . getColumn ( cellname ( " col1 " ) ) . isMarkedForDelete ( System . currentTimeMillis ( ) ) ; 
 + assertFalse ( cf _ result . getColumn ( cellname ( " col1 " ) ) . isLive ( ) ) ; 
 cf _ result . addColumn ( cellname ( " col1 " ) , val2 , 3 ) ; 
 - assert cf _ result . getColumn ( cellname ( " col1 " ) ) . isMarkedForDelete ( System . currentTimeMillis ( ) ) ; 
 + assertFalse ( cf _ result . getColumn ( cellname ( " col1 " ) ) . isLive ( ) ) ; 
 
 / / check that column value wins timestamp ties in absence of tombstone 
 cf _ result . addColumn ( cellname ( " col3 " ) , val , 2 ) ; 
 diff - - git a / test / unit / org / apache / cassandra / db / CounterCellTest . java b / test / unit / org / apache / cassandra / db / CounterCellTest . java 
 index efc365d . . 645c8a7 100644 
 - - - a / test / unit / org / apache / cassandra / db / CounterCellTest . java 
 + + + b / test / unit / org / apache / cassandra / db / CounterCellTest . java 
 @ @ - 90 , 8 + 90 , 8 @ @ public class CounterCellTest extends SchemaLoader 
 left = new BufferDeletedCell ( cellname ( " x " ) , 1 , 1L ) ; 
 right = new BufferDeletedCell ( cellname ( " x " ) , 2 , 2L ) ; 
 
 - assert left . reconcile ( right ) . getMarkedForDeleteAt ( ) = = right . getMarkedForDeleteAt ( ) ; 
 - assert right . reconcile ( left ) . getMarkedForDeleteAt ( ) = = right . getMarkedForDeleteAt ( ) ; 
 + assert left . reconcile ( right ) . timestamp ( ) = = right . timestamp ( ) ; 
 + assert right . reconcile ( left ) . timestamp ( ) = = right . timestamp ( ) ; 
 
 / / tombstone > live 
 left = new BufferDeletedCell ( cellname ( " x " ) , 1 , 2L ) ; 
 @ @ - 119 , 7 + 119 , 7 @ @ public class CounterCellTest extends SchemaLoader 
 assert reconciled . name ( ) = = right . name ( ) ; 
 assert reconciled . value ( ) = = right . value ( ) ; 
 assert reconciled . timestamp ( ) = = right . timestamp ( ) ; 
 - assert ( ( CounterCell ) reconciled ) . timestampOfLastDelete ( ) = = left . getMarkedForDeleteAt ( ) ; 
 + assert ( ( CounterCell ) reconciled ) . timestampOfLastDelete ( ) = = left . timestamp ( ) ; 
 
 / / live < tombstone 
 left = BufferCounterCell . createLocal ( cellname ( " x " ) , 0L , 1L , Long . MIN _ VALUE ) ; 
 @ @ - 147 , 7 + 147 , 7 @ @ public class CounterCellTest extends SchemaLoader 
 assert reconciled . name ( ) = = left . name ( ) ; 
 assert reconciled . value ( ) = = left . value ( ) ; 
 assert reconciled . timestamp ( ) = = left . timestamp ( ) ; 
 - assert ( ( CounterCell ) reconciled ) . timestampOfLastDelete ( ) = = right . getMarkedForDeleteAt ( ) ; 
 + assert ( ( CounterCell ) reconciled ) . timestampOfLastDelete ( ) = = right . timestamp ( ) ; 
 
 / / live < live last delete 
 left = new BufferCounterCell ( cellname ( " x " ) , cc . createRemote ( CounterId . fromInt ( 1 ) , 2L , 3L ) , 1L , Long . MIN _ VALUE ) ; 
 diff - - git a / test / unit / org / apache / cassandra / db / RangeTombstoneTest . java b / test / unit / org / apache / cassandra / db / RangeTombstoneTest . java 
 index 6ac5f13 . . ace0ae3 100644 
 - - - a / test / unit / org / apache / cassandra / db / RangeTombstoneTest . java 
 + + + b / test / unit / org / apache / cassandra / db / RangeTombstoneTest . java 
 @ @ - 467 , 7 + 467 , 7 @ @ public class RangeTombstoneTest extends SchemaLoader 
 
 private static boolean isLive ( ColumnFamily cf , Cell c ) 
 { 
 - return c ! = null & & ! c . isMarkedForDelete ( System . currentTimeMillis ( ) ) & & ! cf . deletionInfo ( ) . isDeleted ( c ) ; 
 + return c ! = null & & c . isLive ( ) & & ! cf . deletionInfo ( ) . isDeleted ( c ) ; 
 } 
 
 private static CellName b ( int i ) 
 diff - - git a / test / unit / org / apache / cassandra / db / RemoveCellTest . java b / test / unit / org / apache / cassandra / db / RemoveCellTest . java 
 index 1624913 . . 77ff02d 100644 
 - - - a / test / unit / org / apache / cassandra / db / RemoveCellTest . java 
 + + + b / test / unit / org / apache / cassandra / db / RemoveCellTest . java 
 @ @ - 20 , 16 + 20 , 14 @ @ package org . apache . cassandra . db ; 
 
 import org . junit . Test ; 
 
 + import static org . junit . Assert . assertFalse ; 
 import static org . junit . Assert . assertNull ; 
 - import static org . junit . Assert . assertTrue ; 
 - 
 - import org . apache . cassandra . db . filter . QueryFilter ; 
 
 import org . apache . cassandra . SchemaLoader ; 
 import org . apache . cassandra . Util ; 
 + import org . apache . cassandra . db . filter . QueryFilter ; 
 import org . apache . cassandra . utils . ByteBufferUtil ; 
 
 - 
 public class RemoveCellTest extends SchemaLoader 
 { 
 @ Test 
 @ @ - 52 , 7 + 50 , 7 @ @ public class RemoveCellTest extends SchemaLoader 
 rm . apply ( ) ; 
 
 ColumnFamily retrieved = store . getColumnFamily ( Util . namesQueryFilter ( store , dk , " Column1 " ) ) ; 
 - assert retrieved . getColumn ( Util . cellname ( " Column1 " ) ) . isMarkedForDelete ( System . currentTimeMillis ( ) ) ; 
 + assertFalse ( retrieved . getColumn ( Util . cellname ( " Column1 " ) ) . isLive ( ) ) ; 
 assertNull ( Util . cloneAndRemoveDeleted ( retrieved , Integer . MAX _ VALUE ) ) ; 
 assertNull ( Util . cloneAndRemoveDeleted ( store . getColumnFamily ( QueryFilter . getIdentityFilter ( dk , 
 " Standard1 " , 
 @ @ - 72 , 15 + 70 , 15 @ @ public class RemoveCellTest extends SchemaLoader 
 long timestamp = System . currentTimeMillis ( ) ; 
 int localDeletionTime = ( int ) ( timestamp / 1000 ) ; 
 Cell c = dc ( " dc1 " , localDeletionTime , timestamp ) ; 
 - assertTrue ( " DeletedCell was not marked for delete " , c . isMarkedForDelete ( timestamp ) ) ; 
 + assertFalse ( " DeletedCell was not marked for delete " , c . isLive ( timestamp ) ) ; 
 
 / / Simulate a node that is 30 seconds behind 
 c = dc ( " dc2 " , localDeletionTime + 30 , timestamp + 30000 ) ; 
 - assertTrue ( " DeletedCell was not marked for delete " , c . isMarkedForDelete ( timestamp ) ) ; 
 + assertFalse ( " DeletedCell was not marked for delete " , c . isLive ( timestamp ) ) ; 
 
 / / Simulate a node that is 30 ahead behind 
 c = dc ( " dc3 " , localDeletionTime - 30 , timestamp - 30000 ) ; 
 - assertTrue ( " DeletedCell was not marked for delete " , c . isMarkedForDelete ( timestamp ) ) ; 
 + assertFalse ( " DeletedCell was not marked for delete " , c . isLive ( timestamp ) ) ; 
 } 
 
 } 
 diff - - git a / test / unit / org / apache / cassandra / db / RemoveSubCellTest . java b / test / unit / org / apache / cassandra / db / RemoveSubCellTest . java 
 index 6eee4a6 . . cec1bce 100644 
 - - - a / test / unit / org / apache / cassandra / db / RemoveSubCellTest . java 
 + + + b / test / unit / org / apache / cassandra / db / RemoveSubCellTest . java 
 @ @ - 23 , 6 + 23 , 7 @ @ import java . util . concurrent . TimeUnit ; 
 
 import org . junit . Test ; 
 
 + import static org . junit . Assert . assertFalse ; 
 import static org . junit . Assert . assertNull ; 
 import org . apache . cassandra . db . composites . * ; 
 import org . apache . cassandra . db . filter . QueryFilter ; 
 @ @ - 58 , 7 + 59 , 7 @ @ public class RemoveSubCellTest extends SchemaLoader 
 rm . apply ( ) ; 
 
 ColumnFamily retrieved = store . getColumnFamily ( QueryFilter . getIdentityFilter ( dk , " Super1 " , System . currentTimeMillis ( ) ) ) ; 
 - assert retrieved . getColumn ( cname ) . isMarkedForDelete ( System . currentTimeMillis ( ) ) ; 
 + assertFalse ( retrieved . getColumn ( cname ) . isLive ( ) ) ; 
 assertNull ( Util . cloneAndRemoveDeleted ( retrieved , Integer . MAX _ VALUE ) ) ; 
 } 
 
 @ @ - 94 , 7 + 95 , 7 @ @ public class RemoveSubCellTest extends SchemaLoader 
 rm . apply ( ) ; 
 
 ColumnFamily retrieved = store . getColumnFamily ( filter ) ; 
 - assert retrieved . getColumn ( cname ) . isMarkedForDelete ( System . currentTimeMillis ( ) ) ; 
 + assertFalse ( retrieved . getColumn ( cname ) . isLive ( ) ) ; 
 assertNull ( Util . cloneAndRemoveDeleted ( retrieved , Integer . MAX _ VALUE ) ) ; 
 } 
 } 
 diff - - git a / test / unit / org / apache / cassandra / db / RowTest . java b / test / unit / org / apache / cassandra / db / RowTest . java 
 index 653c9f5 . . 22e112e 100644 
 - - - a / test / unit / org / apache / cassandra / db / RowTest . java 
 + + + b / test / unit / org / apache / cassandra / db / RowTest . java 
 @ @ - 32 , 6 + 32 , 7 @ @ import static org . apache . cassandra . Util . column ; 
 import static org . apache . cassandra . Util . tombstone ; 
 import static org . junit . Assert . assertEquals ; 
 import static org . junit . Assert . assertFalse ; 
 + import static org . junit . Assert . assertTrue ; 
 
 public class RowTest extends SchemaLoader 
 { 
 @ @ - 101 , 12 + 102 , 12 @ @ public class RowTest extends SchemaLoader 
 public void testExpiringColumnExpiration ( ) 
 { 
 Cell c = new BufferExpiringCell ( CellNames . simpleDense ( ByteBufferUtil . bytes ( " one " ) ) , ByteBufferUtil . bytes ( " A " ) , 0 , 1 ) ; 
 - assert ! c . isMarkedForDelete ( System . currentTimeMillis ( ) ) ; 
 + assertTrue ( c . isLive ( ) ) ; 
 
 / / Because we keep the local deletion time with a precision of a 
 / / second , we could have to wait 2 seconds in worst case scenario . 
 Uninterruptibles . sleepUninterruptibly ( 2 , TimeUnit . SECONDS ) ; 
 
 - assert c . isMarkedForDelete ( System . currentTimeMillis ( ) ) & & c . getMarkedForDeleteAt ( ) = = 0 ; 
 + assert ! c . isLive ( ) & & c . timestamp ( ) = = 0 ; 
 } 
 } 
 diff - - git a / test / unit / org / apache / cassandra / db / compaction / CompactionsPurgeTest . java b / test / unit / org / apache / cassandra / db / compaction / CompactionsPurgeTest . java 
 index f9cfb2c . . 751e7ae 100644 
 - - - a / test / unit / org / apache / cassandra / db / compaction / CompactionsPurgeTest . java 
 + + + b / test / unit / org / apache / cassandra / db / compaction / CompactionsPurgeTest . java 
 @ @ - 187 , 7 + 187 , 7 @ @ public class CompactionsPurgeTest extends SchemaLoader 
 / / We should have both the c1 and c2 tombstones still . Since the min timestamp in the c2 tombstone 
 / / sstable is older than the c1 tombstone , it is invalid to throw out the c1 tombstone . 
 ColumnFamily cf = cfs . getColumnFamily ( QueryFilter . getIdentityFilter ( key3 , cfName , System . currentTimeMillis ( ) ) ) ; 
 - assertFalse ( cf . getColumn ( cellname ( " c2 " ) ) . isLive ( System . currentTimeMillis ( ) ) ) ; 
 + assertFalse ( cf . getColumn ( cellname ( " c2 " ) ) . isLive ( ) ) ; 
 assertEquals ( 2 , cf . getColumnCount ( ) ) ; 
 } 
 
 @ @ - 273 , 7 + 273 , 7 @ @ public class CompactionsPurgeTest extends SchemaLoader 
 ColumnFamily cf = cfs . getColumnFamily ( QueryFilter . getIdentityFilter ( key , cfName , System . currentTimeMillis ( ) ) ) ; 
 assertEquals ( 10 , cf . getColumnCount ( ) ) ; 
 for ( Cell c : cf ) 
 - assert ! c . isMarkedForDelete ( System . currentTimeMillis ( ) ) ; 
 + assert c . isLive ( ) ; 
 } 
 
 @ Test 
 @ @ - 317 , 7 + 317 , 7 @ @ public class CompactionsPurgeTest extends SchemaLoader 
 cf = cfs . getColumnFamily ( filter ) ; 
 assertEquals ( 10 , cf . getColumnCount ( ) ) ; 
 for ( Cell c : cf ) 
 - assert ! c . isMarkedForDelete ( System . currentTimeMillis ( ) ) ; 
 + assert c . isLive ( ) ; 
 } 
 
 @ Test 
 diff - - git a / test / unit / org / apache / cassandra / db / index / PerRowSecondaryIndexTest . java b / test / unit / org / apache / cassandra / db / index / PerRowSecondaryIndexTest . java 
 index 7eb899f . . 158dd2c 100644 
 - - - a / test / unit / org / apache / cassandra / db / index / PerRowSecondaryIndexTest . java 
 + + + b / test / unit / org / apache / cassandra / db / index / PerRowSecondaryIndexTest . java 
 @ @ - 38 , 11 + 38 , 8 @ @ import org . apache . cassandra . db . filter . QueryFilter ; 
 import org . apache . cassandra . exceptions . ConfigurationException ; 
 import org . apache . cassandra . utils . ByteBufferUtil ; 
 import org . apache . cassandra . utils . concurrent . OpOrder ; 
 - import org . apache . cassandra . utils . memory . MemtableAllocator ; 
 
 - import static org . junit . Assert . assertEquals ; 
 - import static org . junit . Assert . assertNotNull ; 
 - import static org . junit . Assert . assertTrue ; 
 + import static org . junit . Assert . * ; 
 
 public class PerRowSecondaryIndexTest extends SchemaLoader 
 { 
 @ @ - 96 , 9 + 93 , 8 @ @ public class PerRowSecondaryIndexTest extends SchemaLoader 
 assertNotNull ( indexedRow ) ; 
 
 for ( Cell cell : indexedRow . getSortedColumns ( ) ) 
 - { 
 - assertTrue ( cell . isMarkedForDelete ( System . currentTimeMillis ( ) ) ) ; 
 - } 
 + assertFalse ( cell . isLive ( ) ) ; 
 + 
 assertTrue ( Arrays . equals ( " k2 " . getBytes ( ) , PerRowSecondaryIndexTest . TestIndex . LAST _ INDEXED _ KEY . array ( ) ) ) ; 
 } 
 
 @ @ - 114 , 9 + 110 , 8 @ @ public class PerRowSecondaryIndexTest extends SchemaLoader 
 ColumnFamily indexedRow = PerRowSecondaryIndexTest . TestIndex . LAST _ INDEXED _ ROW ; 
 assertNotNull ( indexedRow ) ; 
 for ( Cell cell : indexedRow . getSortedColumns ( ) ) 
 - { 
 - assertTrue ( cell . isMarkedForDelete ( System . currentTimeMillis ( ) ) ) ; 
 - } 
 + assertFalse ( cell . isLive ( ) ) ; 
 + 
 assertTrue ( Arrays . equals ( " k3 " . getBytes ( ) , PerRowSecondaryIndexTest . TestIndex . LAST _ INDEXED _ KEY . array ( ) ) ) ; 
 } 
 
 diff - - git a / test / unit / org / apache / cassandra / service / QueryPagerTest . java b / test / unit / org / apache / cassandra / service / QueryPagerTest . java 
 index ad70eff . . abd030d 100644 
 - - - a / test / unit / org / apache / cassandra / service / QueryPagerTest . java 
 + + + b / test / unit / org / apache / cassandra / service / QueryPagerTest . java 
 @ @ - 165 , 7 + 165 , 7 @ @ public class QueryPagerTest extends SchemaLoader 
 for ( Cell c : r . cf ) 
 { 
 / / Ignore deleted cells if we have them 
 - if ( ! c . isLive ( 0 ) ) 
 + if ( ! c . isLive ( ) ) 
 continue ; 
 
 ByteBuffer expected = names [ i + + ] ;

NEAREST DIFF:
diff - - git a / lib / licenses / guava - r05 . txt b / lib / licenses / guava - r05 . txt 
 deleted file mode 100644 
 index d645695 . . 0000000 
 - - - a / lib / licenses / guava - r05 . txt 
 + + + / dev / null 
 @ @ - 1 , 202 + 0 , 0 @ @ 
 - 
 - Apache License 
 - Version 2 . 0 , January 2004 
 - http : / / www . apache . org / licenses / 
 - 
 - TERMS AND CONDITIONS FOR USE , REPRODUCTION , AND DISTRIBUTION 
 - 
 - 1 . Definitions . 
 - 
 - " License " shall mean the terms and conditions for use , reproduction , 
 - and distribution as defined by Sections 1 through 9 of this document . 
 - 
 - " Licensor " shall mean the copyright owner or entity authorized by 
 - the copyright owner that is granting the License . 
 - 
 - " Legal Entity " shall mean the union of the acting entity and all 
 - other entities that control , are controlled by , or are under common 
 - control with that entity . For the purposes of this definition , 
 - " control " means ( i ) the power , direct or indirect , to cause the 
 - direction or management of such entity , whether by contract or 
 - otherwise , or ( ii ) ownership of fifty percent ( 50 % ) or more of the 
 - outstanding shares , or ( iii ) beneficial ownership of such entity . 
 - 
 - " You " ( or " Your " ) shall mean an individual or Legal Entity 
 - exercising permissions granted by this License . 
 - 
 - " Source " form shall mean the preferred form for making modifications , 
 - including but not limited to software source code , documentation 
 - source , and configuration files . 
 - 
 - " Object " form shall mean any form resulting from mechanical 
 - transformation or translation of a Source form , including but 
 - not limited to compiled object code , generated documentation , 
 - and conversions to other media types . 
 - 
 - " Work " shall mean the work of authorship , whether in Source or 
 - Object form , made available under the License , as indicated by a 
 - copyright notice that is included in or attached to the work 
 - ( an example is provided in the Appendix below ) . 
 - 
 - " Derivative Works " shall mean any work , whether in Source or Object 
 - form , that is based on ( or derived from ) the Work and for which the 
 - editorial revisions , annotations , elaborations , or other modifications 
 - represent , as a whole , an original work of authorship . For the purposes 
 - of this License , Derivative Works shall not include works that remain 
 - separable from , or merely link ( or bind by name ) to the interfaces of , 
 - the Work and Derivative Works thereof . 
 - 
 - " Contribution " shall mean any work of authorship , including 
 - the original version of the Work and any modifications or additions 
 - to that Work or Derivative Works thereof , that is intentionally 
 - submitted to Licensor for inclusion in the Work by the copyright owner 
 - or by an individual or Legal Entity authorized to submit on behalf of 
 - the copyright owner . For the purposes of this definition , " submitted " 
 - means any form of electronic , verbal , or written communication sent 
 - to the Licensor or its representatives , including but not limited to 
 - communication on electronic mailing lists , source code control systems , 
 - and issue tracking systems that are managed by , or on behalf of , the 
 - Licensor for the purpose of discussing and improving the Work , but 
 - excluding communication that is conspicuously marked or otherwise 
 - designated in writing by the copyright owner as " Not a Contribution . " 
 - 
 - " Contributor " shall mean Licensor and any individual or Legal Entity 
 - on behalf of whom a Contribution has been received by Licensor and 
 - subsequently incorporated within the Work . 
 - 
 - 2 . Grant of Copyright License . Subject to the terms and conditions of 
 - this License , each Contributor hereby grants to You a perpetual , 
 - worldwide , non - exclusive , no - charge , royalty - free , irrevocable 
 - copyright license to reproduce , prepare Derivative Works of , 
 - publicly display , publicly perform , sublicense , and distribute the 
 - Work and such Derivative Works in Source or Object form . 
 - 
 - 3 . Grant of Patent License . Subject to the terms and conditions of 
 - this License , each Contributor hereby grants to You a perpetual , 
 - worldwide , non - exclusive , no - charge , royalty - free , irrevocable 
 - ( except as stated in this section ) patent license to make , have made , 
 - use , offer to sell , sell , import , and otherwise transfer the Work , 
 - where such license applies only to those patent claims licensable 
 - by such Contributor that are necessarily infringed by their 
 - Contribution ( s ) alone or by combination of their Contribution ( s ) 
 - with the Work to which such Contribution ( s ) was submitted . If You 
 - institute patent litigation against any entity ( including a 
 - cross - claim or counterclaim in a lawsuit ) alleging that the Work 
 - or a Contribution incorporated within the Work constitutes direct 
 - or contributory patent infringement , then any patent licenses 
 - granted to You under this License for that Work shall terminate 
 - as of the date such litigation is filed . 
 - 
 - 4 . Redistribution . You may reproduce and distribute copies of the 
 - Work or Derivative Works thereof in any medium , with or without 
 - modifications , and in Source or Object form , provided that You 
 - meet the following conditions : 
 - 
 - ( a ) You must give any other recipients of the Work or 
 - Derivative Works a copy of this License ; and 
 - 
 - ( b ) You must cause any modified files to carry prominent notices 
 - stating that You changed the files ; and 
 - 
 - ( c ) You must retain , in the Source form of any Derivative Works 
 - that You distribute , all copyright , patent , trademark , and 
 - attribution notices from the Source form of the Work , 
 - excluding those notices that do not pertain to any part of 
 - the Derivative Works ; and 
 - 
 - ( d ) If the Work includes a " NOTICE " text file as part of its 
 - distribution , then any Derivative Works that You distribute must 
 - include a readable copy of the attribution notices contained 
 - within such NOTICE file , excluding those notices that do not 
 - pertain to any part of the Derivative Works , in at least one 
 - of the following places : within a NOTICE text file distributed 
 - as part of the Derivative Works ; within the Source form or 
 - documentation , if provided along with the Derivative Works ; or , 
 - within a display generated by the Derivative Works , if and 
 - wherever such third - party notices normally appear . The contents 
 - of the NOTICE file are for informational purposes only and 
 - do not modify the License . You may add Your own attribution 
 - notices within Derivative Works that You distribute , alongside 
 - or as an addendum to the NOTICE text from the Work , provided 
 - that such additional attribution notices cannot be construed 
 - as modifying the License . 
 - 
 - You may add Your own copyright statement to Your modifications and 
 - may provide additional or different license terms and conditions 
 - for use , reproduction , or distribution of Your modifications , or 
 - for any such Derivative Works as a whole , provided Your use , 
 - reproduction , and distribution of the Work otherwise complies with 
 - the conditions stated in this License . 
 - 
 - 5 . Submission of Contributions . Unless You explicitly state otherwise , 
 - any Contribution intentionally submitted for inclusion in the Work 
 - by You to the Licensor shall be under the terms and conditions of 
 - this License , without any additional terms or conditions . 
 - Notwithstanding the above , nothing herein shall supersede or modify 
 - the terms of any separate license agreement you may have executed 
 - with Licensor regarding such Contributions . 
 - 
 - 6 . Trademarks . This License does not grant permission to use the trade 
 - names , trademarks , service marks , or product names of the Licensor , 
 - except as required for reasonable and customary use in describing the 
 - origin of the Work and reproducing the content of the NOTICE file . 
 - 
 - 7 . Disclaimer of Warranty . Unless required by applicable law or 
 - agreed to in writing , Licensor provides the Work ( and each 
 - Contributor provides its Contributions ) on an " AS IS " BASIS , 
 - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or 
 - implied , including , without limitation , any warranties or conditions 
 - of TITLE , NON - INFRINGEMENT , MERCHANTABILITY , or FITNESS FOR A 
 - PARTICULAR PURPOSE . You are solely responsible for determining the 
 - appropriateness of using or redistributing the Work and assume any 
 - risks associated with Your exercise of permissions under this License . 
 - 
 - 8 . Limitation of Liability . In no event and under no legal theory , 
 - whether in tort ( including negligence ) , contract , or otherwise , 
 - unless required by applicable law ( such as deliberate and grossly 
 - negligent acts ) or agreed to in writing , shall any Contributor be 
 - liable to You for damages , including any direct , indirect , special , 
 - incidental , or consequential damages of any character arising as a 
 - result of this License or out of the use or inability to use the 
 - Work ( including but not limited to damages for loss of goodwill , 
 - work stoppage , computer failure or malfunction , or any and all 
 - other commercial damages or losses ) , even if such Contributor 
 - has been advised of the possibility of such damages . 
 - 
 - 9 . Accepting Warranty or Additional Liability . While redistributing 
 - the Work or Derivative Works thereof , You may choose to offer , 
 - and charge a fee for , acceptance of support , warranty , indemnity , 
 - or other liability obligations and / or rights consistent with this 
 - License . However , in accepting such obligations , You may act only 
 - on Your own behalf and on Your sole responsibility , not on behalf 
 - of any other Contributor , and only if You agree to indemnify , 
 - defend , and hold each Contributor harmless for any liability 
 - incurred by , or claims asserted against , such Contributor by reason 
 - of your accepting any such warranty or additional liability . 
 - 
 - END OF TERMS AND CONDITIONS 
 - 
 - APPENDIX : How to apply the Apache License to your work . 
 - 
 - To apply the Apache License to your work , attach the following 
 - boilerplate notice , with the fields enclosed by brackets " [ ] " 
 - replaced with your own identifying information . ( Don ' t include 
 - the brackets ! ) The text should be enclosed in the appropriate 
 - comment syntax for the file format . We also recommend that a 
 - file or class name and description of purpose be included on the 
 - same " printed page " as the copyright notice for easier 
 - identification within third - party archives . 
 - 
 - Copyright [ yyyy ] [ name of copyright owner ] 
 - 
 - Licensed under the Apache License , Version 2 . 0 ( the " License " ) ; 
 - you may not use this file except in compliance with the License . 
 - You may obtain a copy of the License at 
 - 
 - http : / / www . apache . org / licenses / LICENSE - 2 . 0 
 - 
 - Unless required by applicable law or agreed to in writing , software 
 - distributed under the License is distributed on an " AS IS " BASIS , 
 - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . 
 - See the License for the specific language governing permissions and 
 - limitations under the License . 
 diff - - git a / lib / licenses / guava - r08 . txt b / lib / licenses / guava - r08 . txt 
 new file mode 100644 
 index 0000000 . . d645695 
 - - - / dev / null 
 + + + b / lib / licenses / guava - r08 . txt 
 @ @ - 0 , 0 + 1 , 202 @ @ 
 + 
 + Apache License 
 + Version 2 . 0 , January 2004 
 + http : / / www . apache . org / licenses / 
 + 
 + TERMS AND CONDITIONS FOR USE , REPRODUCTION , AND DISTRIBUTION 
 + 
 + 1 . Definitions . 
 + 
 + " License " shall mean the terms and conditions for use , reproduction , 
 + and distribution as defined by Sections 1 through 9 of this document . 
 + 
 + " Licensor " shall mean the copyright owner or entity authorized by 
 + the copyright owner that is granting the License . 
 + 
 + " Legal Entity " shall mean the union of the acting entity and all 
 + other entities that control , are controlled by , or are under common 
 + control with that entity . For the purposes of this definition , 
 + " control " means ( i ) the power , direct or indirect , to cause the 
 + direction or management of such entity , whether by contract or 
 + otherwise , or ( ii ) ownership of fifty percent ( 50 % ) or more of the 
 + outstanding shares , or ( iii ) beneficial ownership of such entity . 
 + 
 + " You " ( or " Your " ) shall mean an individual or Legal Entity 
 + exercising permissions granted by this License . 
 + 
 + " Source " form shall mean the preferred form for making modifications , 
 + including but not limited to software source code , documentation 
 + source , and configuration files . 
 + 
 + " Object " form shall mean any form resulting from mechanical 
 + transformation or translation of a Source form , including but 
 + not limited to compiled object code , generated documentation , 
 + and conversions to other media types . 
 + 
 + " Work " shall mean the work of authorship , whether in Source or 
 + Object form , made available under the License , as indicated by a 
 + copyright notice that is included in or attached to the work 
 + ( an example is provided in the Appendix below ) . 
 + 
 + " Derivative Works " shall mean any work , whether in Source or Object 
 + form , that is based on ( or derived from ) the Work and for which the 
 + editorial revisions , annotations , elaborations , or other modifications 
 + represent , as a whole , an original work of authorship . For the purposes 
 + of this License , Derivative Works shall not include works that remain 
 + separable from , or merely link ( or bind by name ) to the interfaces of , 
 + the Work and Derivative Works thereof . 
 + 
 + " Contribution " shall mean any work of authorship , including 
 + the original version of the Work and any modifications or additions 
 + to that Work or Derivative Works thereof , that is intentionally 
 + submitted to Licensor for inclusion in the Work by the copyright owner 
 + or by an individual or Legal Entity authorized to submit on behalf of 
 + the copyright owner . For the purposes of this definition , " submitted " 
 + means any form of electronic , verbal , or written communication sent 
 + to the Licensor or its representatives , including but not limited to 
 + communication on electronic mailing lists , source code control systems , 
 + and issue tracking systems that are managed by , or on behalf of , the 
 + Licensor for the purpose of discussing and improving the Work , but 
 + excluding communication that is conspicuously marked or otherwise 
 + designated in writing by the copyright owner as " Not a Contribution . " 
 + 
 + " Contributor " shall mean Licensor and any individual or Legal Entity 
 + on behalf of whom a Contribution has been received by Licensor and 
 + subsequently incorporated within the Work . 
 + 
 + 2 . Grant of Copyright License . Subject to the terms and conditions of 
 + this License , each Contributor hereby grants to You a perpetual , 
 + worldwide , non - exclusive , no - charge , royalty - free , irrevocable 
 + copyright license to reproduce , prepare Derivative Works of , 
 + publicly display , publicly perform , sublicense , and distribute the 
 + Work and such Derivative Works in Source or Object form . 
 + 
 + 3 . Grant of Patent License . Subject to the terms and conditions of 
 + this License , each Contributor hereby grants to You a perpetual , 
 + worldwide , non - exclusive , no - charge , royalty - free , irrevocable 
 + ( except as stated in this section ) patent license to make , have made , 
 + use , offer to sell , sell , import , and otherwise transfer the Work , 
 + where such license applies only to those patent claims licensable 
 + by such Contributor that are necessarily infringed by their 
 + Contribution ( s ) alone or by combination of their Contribution ( s ) 
 + with the Work to which such Contribution ( s ) was submitted . If You 
 + institute patent litigation against any entity ( including a 
 + cross - claim or counterclaim in a lawsuit ) alleging that the Work 
 + or a Contribution incorporated within the Work constitutes direct 
 + or contributory patent infringement , then any patent licenses 
 + granted to You under this License for that Work shall terminate 
 + as of the date such litigation is filed . 
 + 
 + 4 . Redistribution . You may reproduce and distribute copies of the 
 + Work or Derivative Works thereof in any medium , with or without 
 + modifications , and in Source or Object form , provided that You 
 + meet the following conditions : 
 + 
 + ( a ) You must give any other recipients of the Work or 
 + Derivative Works a copy of this License ; and 
 + 
 + ( b ) You must cause any modified files to carry prominent notices 
 + stating that You changed the files ; and 
 + 
 + ( c ) You must retain , in the Source form of any Derivative Works 
 + that You distribute , all copyright , patent , trademark , and 
 + attribution notices from the Source form of the Work , 
 + excluding those notices that do not pertain to any part of 
 + the Derivative Works ; and 
 + 
 + ( d ) If the Work includes a " NOTICE " text file as part of its 
 + distribution , then any Derivative Works that You distribute must 
 + include a readable copy of the attribution notices contained 
 + within such NOTICE file , excluding those notices that do not 
 + pertain to any part of the Derivative Works , in at least one 
 + of the following places : within a NOTICE text file distributed 
 + as part of the Derivative Works ; within the Source form or 
 + documentation , if provided along with the Derivative Works ; or , 
 + within a display generated by the Derivative Works , if and 
 + wherever such third - party notices normally appear . The contents 
 + of the NOTICE file are for informational purposes only and 
 + do not modify the License . You may add Your own attribution 
 + notices within Derivative Works that You distribute , alongside 
 + or as an addendum to the NOTICE text from the Work , provided 
 + that such additional attribution notices cannot be construed 
 + as modifying the License . 
 + 
 + You may add Your own copyright statement to Your modifications and 
 + may provide additional or different license terms and conditions 
 + for use , reproduction , or distribution of Your modifications , or 
 + for any such Derivative Works as a whole , provided Your use , 
 + reproduction , and distribution of the Work otherwise complies with 
 + the conditions stated in this License . 
 + 
 + 5 . Submission of Contributions . Unless You explicitly state otherwise , 
 + any Contribution intentionally submitted for inclusion in the Work 
 + by You to the Licensor shall be under the terms and conditions of 
 + this License , without any additional terms or conditions . 
 + Notwithstanding the above , nothing herein shall supersede or modify 
 + the terms of any separate license agreement you may have executed 
 + with Licensor regarding such Contributions . 
 + 
 + 6 . Trademarks . This License does not grant permission to use the trade 
 + names , trademarks , service marks , or product names of the Licensor , 
 + except as required for reasonable and customary use in describing the 
 + origin of the Work and reproducing the content of the NOTICE file . 
 + 
 + 7 . Disclaimer of Warranty . Unless required by applicable law or 
 + agreed to in writing , Licensor provides the Work ( and each 
 + Contributor provides its Contributions ) on an " AS IS " BASIS , 
 + WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or 
 + implied , including , without limitation , any warranties or conditions 
 + of TITLE , NON - INFRINGEMENT , MERCHANTABILITY , or FITNESS FOR A 
 + PARTICULAR PURPOSE . You are solely responsible for determining the 
 + appropriateness of using or redistributing the Work and assume any 
 + risks associated with Your exercise of permissions under this License . 
 + 
 + 8 . Limitation of Liability . In no event and under no legal theory , 
 + whether in tort ( including negligence ) , contract , or otherwise , 
 + unless required by applicable law ( such as deliberate and grossly 
 + negligent acts ) or agreed to in writing , shall any Contributor be 
 + liable to You for damages , including any direct , indirect , special , 
 + incidental , or consequential damages of any character arising as a 
 + result of this License or out of the use or inability to use the 
 + Work ( including but not limited to damages for loss of goodwill , 
 + work stoppage , computer failure or malfunction , or any and all 
 + other commercial damages or losses ) , even if such Contributor 
 + has been advised of the possibility of such damages . 
 + 
 + 9 . Accepting Warranty or Additional Liability . While redistributing 
 + the Work or Derivative Works thereof , You may choose to offer , 
 + and charge a fee for , acceptance of support , warranty , indemnity , 
 + or other liability obligations and / or rights consistent with this 
 + License . However , in accepting such obligations , You may act only 
 + on Your own behalf and on Your sole responsibility , not on behalf 
 + of any other Contributor , and only if You agree to indemnify , 
 + defend , and hold each Contributor harmless for any liability 
 + incurred by , or claims asserted against , such Contributor by reason 
 + of your accepting any such warranty or additional liability . 
 + 
 + END OF TERMS AND CONDITIONS 
 + 
 + APPENDIX : How to apply the Apache License to your work . 
 + 
 + To apply the Apache License to your work , attach the following 
 + boilerplate notice , with the fields enclosed by brackets " [ ] " 
 + replaced with your own identifying information . ( Don ' t include 
 + the brackets ! ) The text should be enclosed in the appropriate 
 + comment syntax for the file format . We also recommend that a 
 + file or class name and description of purpose be included on the 
 + same " printed page " as the copyright notice for easier 
 + identification within third - party archives . 
 + 
 + Copyright [ yyyy ] [ name of copyright owner ] 
 + 
 + Licensed under the Apache License , Version 2 . 0 ( the " License " ) ; 
 + you may not use this file except in compliance with the License . 
 + You may obtain a copy of the License at 
 + 
 + http : / / www . apache . org / licenses / LICENSE - 2 . 0 
 + 
 + Unless required by applicable law or agreed to in writing , software 
 + distributed under the License is distributed on an " AS IS " BASIS , 
 + WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . 
 + See the License for the specific language governing permissions and 
 + limitations under the License .
