BLEU SCORE: 0.05522397783539471

TEST MSG: Remove unnecessary file existence check during anticompaction .
GENERATED MSG: acquire compactionlock during truncate

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index bdabf29 . . e8a301a 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 2 . 2 . 7 <nl> + * Remove unnescessary file existence check during anticompaction ( CASSANDRA - 11660 ) <nl> * Add missing files to debian packages ( CASSANDRA - 11642 ) <nl> * Avoid calling Iterables : : concat in loops during ModificationStatement : : getFunctions ( CASSANDRA - 11621 ) <nl> * cqlsh : COPY FROM should use regular inserts for single statement batches and <nl> diff - - git a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java <nl> index 675d3cc . . 3f41672 100644 <nl> - - - a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java <nl> + + + b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java <nl> @ @ - 1235 , 17 + 1235 , 9 @ @ public class CompactionManager implements CompactionManagerMBean <nl> { <nl> long groupMaxDataAge = - 1 ; <nl> <nl> - / / check that compaction hasn ' t stolen any sstables used in previous repair sessions <nl> - / / if we need to skip the anticompaction , it will be carried out by the next repair <nl> for ( Iterator < SSTableReader > i = anticompactionGroup . originals ( ) . iterator ( ) ; i . hasNext ( ) ; ) <nl> { <nl> SSTableReader sstable = i . next ( ) ; <nl> - if ( ! new File ( sstable . getFilename ( ) ) . exists ( ) ) <nl> - { <nl> - logger . info ( " Skipping anticompaction for { } , required sstable was compacted and is no longer available . " , sstable ) ; <nl> - i . remove ( ) ; <nl> - continue ; <nl> - } <nl> if ( groupMaxDataAge < sstable . maxDataAge ) <nl> groupMaxDataAge = sstable . maxDataAge ; <nl> }
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 07de8f1 . . d512207 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 5 , 6 + 5 , 9 @ @ <nl> * Cache for CompressionMetadata objects ( CASSANDRA - 3427 ) <nl> * synchronize BiMap of bootstrapping tokens ( CASSANDRA - 3417 ) <nl> * Avoid large array allocation for compressed chunk offsets ( CASSANDRA - 3432 ) <nl> + Merged from 0 . 8 : <nl> + * acquire compactionlock during truncate ( CASSANDRA - 3399 ) <nl> + <nl> <nl> 1 . 0 . 1 <nl> * acquire references during index build to prevent delete problems <nl> @ @ - 50 , 6 + 53 , 8 @ @ <nl> * improve CompactionTask extensibility ( CASSANDRA - 3330 ) <nl> * Allow one leveled compaction task to kick off another ( CASSANDRA - 3363 ) <nl> Merged from 0 . 8 : <nl> + * fix truncate allowing data to be replayed post - restart ( CASSANDRA - 3297 ) <nl> + * make iwriter final in IndexWriter to avoid NPE ( CASSANDRA - 2863 ) <nl> * ( CQL ) update grammar to require key clause in DELETE statement <nl> ( CASSANDRA - 3349 ) <nl> * ( CQL ) allow numeric keyspace names in USE statement ( CASSANDRA - 3350 ) <nl> @ @ - 82 , 6 + 87 , 7 @ @ Merged from 0 . 8 : <nl> * Fix race in AntiEntropyService ( CASSANDRA - 3400 ) <nl> * allow encryption only between datacenters ( CASSANDRA - 2802 ) <nl> <nl> + <nl> 1 . 0 . 0 - final <nl> * close scrubbed sstable fd before deleting it ( CASSANDRA - 3318 ) <nl> * fix bug preventing obsolete commitlog segments from being removed <nl> diff - - git a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java <nl> index 4a5ec37 . . 734786d 100644 <nl> - - - a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java <nl> + + + b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java <nl> @ @ - 919 , 15 + 919 , 23 @ @ public class CompactionManager implements CompactionManagerMBean <nl> { <nl> public void runMayThrow ( ) throws InterruptedException , IOException <nl> { <nl> - for ( ColumnFamilyStore cfs : main . concatWithIndexes ( ) ) <nl> + compactionLock . writeLock ( ) . lock ( ) ; <nl> + try <nl> { <nl> - List < SSTableReader > truncatedSSTables = new ArrayList < SSTableReader > ( ) ; <nl> - for ( SSTableReader sstable : cfs . getSSTables ( ) ) <nl> + for ( ColumnFamilyStore cfs : main . concatWithIndexes ( ) ) <nl> { <nl> - if ( ! sstable . newSince ( truncatedAt ) ) <nl> - truncatedSSTables . add ( sstable ) ; <nl> + List < SSTableReader > truncatedSSTables = new ArrayList < SSTableReader > ( ) ; <nl> + for ( SSTableReader sstable : cfs . getSSTables ( ) ) <nl> + { <nl> + if ( ! sstable . newSince ( truncatedAt ) ) <nl> + truncatedSSTables . add ( sstable ) ; <nl> + } <nl> + cfs . markCompacted ( truncatedSSTables ) ; <nl> } <nl> - cfs . markCompacted ( truncatedSSTables ) ; <nl> + } <nl> + finally <nl> + { <nl> + compactionLock . writeLock ( ) . unlock ( ) ; <nl> } <nl> <nl> main . invalidateRowCache ( ) ;

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index bdabf29 . . e8a301a 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 2 . 2 . 7 
 + * Remove unnescessary file existence check during anticompaction ( CASSANDRA - 11660 ) 
 * Add missing files to debian packages ( CASSANDRA - 11642 ) 
 * Avoid calling Iterables : : concat in loops during ModificationStatement : : getFunctions ( CASSANDRA - 11621 ) 
 * cqlsh : COPY FROM should use regular inserts for single statement batches and 
 diff - - git a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java 
 index 675d3cc . . 3f41672 100644 
 - - - a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java 
 + + + b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java 
 @ @ - 1235 , 17 + 1235 , 9 @ @ public class CompactionManager implements CompactionManagerMBean 
 { 
 long groupMaxDataAge = - 1 ; 
 
 - / / check that compaction hasn ' t stolen any sstables used in previous repair sessions 
 - / / if we need to skip the anticompaction , it will be carried out by the next repair 
 for ( Iterator < SSTableReader > i = anticompactionGroup . originals ( ) . iterator ( ) ; i . hasNext ( ) ; ) 
 { 
 SSTableReader sstable = i . next ( ) ; 
 - if ( ! new File ( sstable . getFilename ( ) ) . exists ( ) ) 
 - { 
 - logger . info ( " Skipping anticompaction for { } , required sstable was compacted and is no longer available . " , sstable ) ; 
 - i . remove ( ) ; 
 - continue ; 
 - } 
 if ( groupMaxDataAge < sstable . maxDataAge ) 
 groupMaxDataAge = sstable . maxDataAge ; 
 }

NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 07de8f1 . . d512207 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 5 , 6 + 5 , 9 @ @ 
 * Cache for CompressionMetadata objects ( CASSANDRA - 3427 ) 
 * synchronize BiMap of bootstrapping tokens ( CASSANDRA - 3417 ) 
 * Avoid large array allocation for compressed chunk offsets ( CASSANDRA - 3432 ) 
 + Merged from 0 . 8 : 
 + * acquire compactionlock during truncate ( CASSANDRA - 3399 ) 
 + 
 
 1 . 0 . 1 
 * acquire references during index build to prevent delete problems 
 @ @ - 50 , 6 + 53 , 8 @ @ 
 * improve CompactionTask extensibility ( CASSANDRA - 3330 ) 
 * Allow one leveled compaction task to kick off another ( CASSANDRA - 3363 ) 
 Merged from 0 . 8 : 
 + * fix truncate allowing data to be replayed post - restart ( CASSANDRA - 3297 ) 
 + * make iwriter final in IndexWriter to avoid NPE ( CASSANDRA - 2863 ) 
 * ( CQL ) update grammar to require key clause in DELETE statement 
 ( CASSANDRA - 3349 ) 
 * ( CQL ) allow numeric keyspace names in USE statement ( CASSANDRA - 3350 ) 
 @ @ - 82 , 6 + 87 , 7 @ @ Merged from 0 . 8 : 
 * Fix race in AntiEntropyService ( CASSANDRA - 3400 ) 
 * allow encryption only between datacenters ( CASSANDRA - 2802 ) 
 
 + 
 1 . 0 . 0 - final 
 * close scrubbed sstable fd before deleting it ( CASSANDRA - 3318 ) 
 * fix bug preventing obsolete commitlog segments from being removed 
 diff - - git a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java 
 index 4a5ec37 . . 734786d 100644 
 - - - a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java 
 + + + b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java 
 @ @ - 919 , 15 + 919 , 23 @ @ public class CompactionManager implements CompactionManagerMBean 
 { 
 public void runMayThrow ( ) throws InterruptedException , IOException 
 { 
 - for ( ColumnFamilyStore cfs : main . concatWithIndexes ( ) ) 
 + compactionLock . writeLock ( ) . lock ( ) ; 
 + try 
 { 
 - List < SSTableReader > truncatedSSTables = new ArrayList < SSTableReader > ( ) ; 
 - for ( SSTableReader sstable : cfs . getSSTables ( ) ) 
 + for ( ColumnFamilyStore cfs : main . concatWithIndexes ( ) ) 
 { 
 - if ( ! sstable . newSince ( truncatedAt ) ) 
 - truncatedSSTables . add ( sstable ) ; 
 + List < SSTableReader > truncatedSSTables = new ArrayList < SSTableReader > ( ) ; 
 + for ( SSTableReader sstable : cfs . getSSTables ( ) ) 
 + { 
 + if ( ! sstable . newSince ( truncatedAt ) ) 
 + truncatedSSTables . add ( sstable ) ; 
 + } 
 + cfs . markCompacted ( truncatedSSTables ) ; 
 } 
 - cfs . markCompacted ( truncatedSSTables ) ; 
 + } 
 + finally 
 + { 
 + compactionLock . writeLock ( ) . unlock ( ) ; 
 } 
 
 main . invalidateRowCache ( ) ;
