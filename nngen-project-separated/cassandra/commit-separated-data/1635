BLEU SCORE: 0.02133165846478451

TEST MSG: Clean up MessagingService . allNodesAtLeast21 and related digest logic
GENERATED MSG: Fix count ( * ) queries in a mixed cluster

TEST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / db / ColumnFamily . java b / src / java / org / apache / cassandra / db / ColumnFamily . java <nl> index 9caf20b . . 006ced7 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ColumnFamily . java <nl> + + + b / src / java / org / apache / cassandra / db / ColumnFamily . java <nl> @ @ - 395 , 8 + 395 , 8 @ @ public abstract class ColumnFamily implements Iterable < Cell > , IRowCacheEntry <nl> { <nl> for ( Cell cell : this ) <nl> cell . updateDigest ( digest ) ; <nl> - if ( MessagingService . instance ( ) . areAllNodesAtLeast21 ( ) ) <nl> - deletionInfo ( ) . updateDigest ( digest ) ; <nl> + <nl> + deletionInfo ( ) . updateDigest ( digest ) ; <nl> } <nl> <nl> public static ColumnFamily diff ( ColumnFamily cf1 , ColumnFamily cf2 ) <nl> diff - - git a / src / java / org / apache / cassandra / net / MessagingService . java b / src / java / org / apache / cassandra / net / MessagingService . java <nl> index bde004d . . a7346f3 100644 <nl> - - - a / src / java / org / apache / cassandra / net / MessagingService . java <nl> + + + b / src / java / org / apache / cassandra / net / MessagingService . java <nl> @ @ - 92 , 8 + 92 , 6 @ @ public final class MessagingService implements MessagingServiceMBean <nl> * / <nl> public static final int PROTOCOL _ MAGIC = 0xCA552DFA ; <nl> <nl> - private boolean allNodesAtLeast21 = true ; <nl> - <nl> / * All verb handler identifiers * / <nl> public enum Verb <nl> { <nl> @ @ - 791 , 47 + 789 , 20 @ @ public final class MessagingService implements MessagingServiceMBean <nl> return packed > > > ( start + 1 ) - count & ~ ( - 1 < < count ) ; <nl> } <nl> <nl> - public boolean areAllNodesAtLeast21 ( ) <nl> - { <nl> - return allNodesAtLeast21 ; <nl> - } <nl> - <nl> / * * <nl> * @ return the last version associated with address , or @ param version if this is the first such version <nl> * / <nl> public int setVersion ( InetAddress endpoint , int version ) <nl> { <nl> logger . debug ( " Setting version { } for { } " , version , endpoint ) ; <nl> - if ( version < VERSION _ 21 ) <nl> - allNodesAtLeast21 = false ; <nl> Integer v = versions . put ( endpoint , version ) ; <nl> - <nl> - / / if the version was increased to 2 . 0 or later , see if all nodes are > = 2 . 0 now <nl> - if ( v ! = null & & v < VERSION _ 21 & & version > = VERSION _ 21 ) <nl> - refreshAllNodesAtLeast21 ( ) ; <nl> - <nl> return v = = null ? version : v ; <nl> } <nl> <nl> public void resetVersion ( InetAddress endpoint ) <nl> { <nl> logger . debug ( " Resetting version for { } " , endpoint ) ; <nl> - Integer removed = versions . remove ( endpoint ) ; <nl> - if ( removed ! = null & & removed < = VERSION _ 21 ) <nl> - refreshAllNodesAtLeast21 ( ) ; <nl> - } <nl> - <nl> - private void refreshAllNodesAtLeast21 ( ) <nl> - { <nl> - for ( Integer version : versions . values ( ) ) <nl> - { <nl> - if ( version < VERSION _ 21 ) <nl> - { <nl> - allNodesAtLeast21 = false ; <nl> - return ; <nl> - } <nl> - } <nl> - allNodesAtLeast21 = true ; <nl> + versions . remove ( endpoint ) ; <nl> } <nl> <nl> public int getVersion ( InetAddress endpoint )
NEAREST DIFF (one line): ELIMINATEDSENTENCE

TEST DIFF:
diff - - git a / src / java / org / apache / cassandra / db / ColumnFamily . java b / src / java / org / apache / cassandra / db / ColumnFamily . java 
 index 9caf20b . . 006ced7 100644 
 - - - a / src / java / org / apache / cassandra / db / ColumnFamily . java 
 + + + b / src / java / org / apache / cassandra / db / ColumnFamily . java 
 @ @ - 395 , 8 + 395 , 8 @ @ public abstract class ColumnFamily implements Iterable < Cell > , IRowCacheEntry 
 { 
 for ( Cell cell : this ) 
 cell . updateDigest ( digest ) ; 
 - if ( MessagingService . instance ( ) . areAllNodesAtLeast21 ( ) ) 
 - deletionInfo ( ) . updateDigest ( digest ) ; 
 + 
 + deletionInfo ( ) . updateDigest ( digest ) ; 
 } 
 
 public static ColumnFamily diff ( ColumnFamily cf1 , ColumnFamily cf2 ) 
 diff - - git a / src / java / org / apache / cassandra / net / MessagingService . java b / src / java / org / apache / cassandra / net / MessagingService . java 
 index bde004d . . a7346f3 100644 
 - - - a / src / java / org / apache / cassandra / net / MessagingService . java 
 + + + b / src / java / org / apache / cassandra / net / MessagingService . java 
 @ @ - 92 , 8 + 92 , 6 @ @ public final class MessagingService implements MessagingServiceMBean 
 * / 
 public static final int PROTOCOL _ MAGIC = 0xCA552DFA ; 
 
 - private boolean allNodesAtLeast21 = true ; 
 - 
 / * All verb handler identifiers * / 
 public enum Verb 
 { 
 @ @ - 791 , 47 + 789 , 20 @ @ public final class MessagingService implements MessagingServiceMBean 
 return packed > > > ( start + 1 ) - count & ~ ( - 1 < < count ) ; 
 } 
 
 - public boolean areAllNodesAtLeast21 ( ) 
 - { 
 - return allNodesAtLeast21 ; 
 - } 
 - 
 / * * 
 * @ return the last version associated with address , or @ param version if this is the first such version 
 * / 
 public int setVersion ( InetAddress endpoint , int version ) 
 { 
 logger . debug ( " Setting version { } for { } " , version , endpoint ) ; 
 - if ( version < VERSION _ 21 ) 
 - allNodesAtLeast21 = false ; 
 Integer v = versions . put ( endpoint , version ) ; 
 - 
 - / / if the version was increased to 2 . 0 or later , see if all nodes are > = 2 . 0 now 
 - if ( v ! = null & & v < VERSION _ 21 & & version > = VERSION _ 21 ) 
 - refreshAllNodesAtLeast21 ( ) ; 
 - 
 return v = = null ? version : v ; 
 } 
 
 public void resetVersion ( InetAddress endpoint ) 
 { 
 logger . debug ( " Resetting version for { } " , endpoint ) ; 
 - Integer removed = versions . remove ( endpoint ) ; 
 - if ( removed ! = null & & removed < = VERSION _ 21 ) 
 - refreshAllNodesAtLeast21 ( ) ; 
 - } 
 - 
 - private void refreshAllNodesAtLeast21 ( ) 
 - { 
 - for ( Integer version : versions . values ( ) ) 
 - { 
 - if ( version < VERSION _ 21 ) 
 - { 
 - allNodesAtLeast21 = false ; 
 - return ; 
 - } 
 - } 
 - allNodesAtLeast21 = true ; 
 + versions . remove ( endpoint ) ; 
 } 
 
 public int getVersion ( InetAddress endpoint )

NEAREST DIFF:
ELIMINATEDSENTENCE
