BLEU SCORE: 0.016932492841722675

TEST MSG: Don ' t try to get ancestors from half - renamed sstables
GENERATED MSG: Invalidate row cache when dropping CF

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index d06345e . . 2ca3b43 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 2 . 1 . 12 <nl> + * Don ' t try to get ancestors from half - renamed sstables ( CASSANDRA - 10501 ) <nl> * Avoid repetition of JVM _ OPTS in debian package ( CASSANDRA - 10251 ) <nl> * Fix potential NPE from handling result of SIM . highestSelectivityIndex ( CASSANDRA - 10550 ) <nl> * Fix paging issues with partitions containing only static columns data <nl> diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> index ffaa276 . . 906e18c 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> @ @ - 646 , 6 + 646 , 11 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean <nl> Set < Integer > completedAncestors = new HashSet < > ( ) ; <nl> for ( Map . Entry < Descriptor , Set < Component > > sstableFiles : directories . sstableLister ( ) . skipTemporary ( true ) . list ( ) . entrySet ( ) ) <nl> { <nl> + / / we rename the Data component last - if it does not exist as a final file , we should ignore this sstable and <nl> + / / it will be removed during startup <nl> + if ( ! sstableFiles . getValue ( ) . contains ( Component . DATA ) ) <nl> + continue ; <nl> + <nl> Descriptor desc = sstableFiles . getKey ( ) ; <nl> <nl> Set < Integer > ancestors ;
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index cd6895f . . 57ad75d 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 26 , 6 + 26 , 7 @ @ <nl> * Fix paging with reversed slices ( CASSANDRA - 6343 ) <nl> * Set minTimestamp correctly to be able to drop expired sstables ( CASSANDRA - 6337 ) <nl> Merged from 1 . 2 : <nl> + * Invalidate row cache when dropping CF ( CASSANDRA - 6351 ) <nl> * add non - jamm path for cached statements ( CASSANDRA - 6293 ) <nl> * ( Hadoop ) Require CFRR batchSize to be at least 2 ( CASSANDRA - 6114 ) <nl> * Fix altering column types ( CASSANDRA - 6185 ) <nl> diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> index 4346224 . . 137d597 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> @ @ - 328 , 6 + 328 , 12 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean <nl> SystemKeyspace . removeTruncationRecord ( metadata . cfId ) ; <nl> data . unreferenceSSTables ( ) ; <nl> indexManager . invalidate ( ) ; <nl> + <nl> + for ( RowCacheKey key : CacheService . instance . rowCache . getKeySet ( ) ) <nl> + { <nl> + if ( key . cfId = = metadata . cfId ) <nl> + invalidateCachedRow ( key ) ; <nl> + } <nl> } <nl> catch ( Exception e ) <nl> { <nl> @ @ - 1257 , 7 + 1263 , 7 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean <nl> finally <nl> { <nl> if ( sentinelSuccess & & data = = null ) <nl> - CacheService . instance . rowCache . remove ( key ) ; <nl> + invalidateCachedRow ( key ) ; <nl> } <nl> } <nl> <nl> @ @ - 1967 , 7 + 1973 , 7 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean <nl> for ( RowCacheKey key : CacheService . instance . rowCache . getKeySet ( ) ) <nl> { <nl> if ( key . cfId = = metadata . cfId ) <nl> - CacheService . instance . rowCache . remove ( key ) ; <nl> + invalidateCachedRow ( key ) ; <nl> } <nl> } <nl> } ;

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index d06345e . . 2ca3b43 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 2 . 1 . 12 
 + * Don ' t try to get ancestors from half - renamed sstables ( CASSANDRA - 10501 ) 
 * Avoid repetition of JVM _ OPTS in debian package ( CASSANDRA - 10251 ) 
 * Fix potential NPE from handling result of SIM . highestSelectivityIndex ( CASSANDRA - 10550 ) 
 * Fix paging issues with partitions containing only static columns data 
 diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 index ffaa276 . . 906e18c 100644 
 - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 @ @ - 646 , 6 + 646 , 11 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean 
 Set < Integer > completedAncestors = new HashSet < > ( ) ; 
 for ( Map . Entry < Descriptor , Set < Component > > sstableFiles : directories . sstableLister ( ) . skipTemporary ( true ) . list ( ) . entrySet ( ) ) 
 { 
 + / / we rename the Data component last - if it does not exist as a final file , we should ignore this sstable and 
 + / / it will be removed during startup 
 + if ( ! sstableFiles . getValue ( ) . contains ( Component . DATA ) ) 
 + continue ; 
 + 
 Descriptor desc = sstableFiles . getKey ( ) ; 
 
 Set < Integer > ancestors ;

NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index cd6895f . . 57ad75d 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 26 , 6 + 26 , 7 @ @ 
 * Fix paging with reversed slices ( CASSANDRA - 6343 ) 
 * Set minTimestamp correctly to be able to drop expired sstables ( CASSANDRA - 6337 ) 
 Merged from 1 . 2 : 
 + * Invalidate row cache when dropping CF ( CASSANDRA - 6351 ) 
 * add non - jamm path for cached statements ( CASSANDRA - 6293 ) 
 * ( Hadoop ) Require CFRR batchSize to be at least 2 ( CASSANDRA - 6114 ) 
 * Fix altering column types ( CASSANDRA - 6185 ) 
 diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 index 4346224 . . 137d597 100644 
 - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 @ @ - 328 , 6 + 328 , 12 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean 
 SystemKeyspace . removeTruncationRecord ( metadata . cfId ) ; 
 data . unreferenceSSTables ( ) ; 
 indexManager . invalidate ( ) ; 
 + 
 + for ( RowCacheKey key : CacheService . instance . rowCache . getKeySet ( ) ) 
 + { 
 + if ( key . cfId = = metadata . cfId ) 
 + invalidateCachedRow ( key ) ; 
 + } 
 } 
 catch ( Exception e ) 
 { 
 @ @ - 1257 , 7 + 1263 , 7 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean 
 finally 
 { 
 if ( sentinelSuccess & & data = = null ) 
 - CacheService . instance . rowCache . remove ( key ) ; 
 + invalidateCachedRow ( key ) ; 
 } 
 } 
 
 @ @ - 1967 , 7 + 1973 , 7 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean 
 for ( RowCacheKey key : CacheService . instance . rowCache . getKeySet ( ) ) 
 { 
 if ( key . cfId = = metadata . cfId ) 
 - CacheService . instance . rowCache . remove ( key ) ; 
 + invalidateCachedRow ( key ) ; 
 } 
 } 
 } ;
