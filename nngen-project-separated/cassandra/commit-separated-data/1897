BLEU SCORE: 0.02383853510228548

TEST MSG: Duplicate rows returned when in clause has repeated values
GENERATED MSG: merge from 1 . 0 . 0

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index f1eaa77 . . 9cd8189 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 2 . 1 . 3 <nl> + * Duplicate rows returned when in clause has repeated values ( CASSANDRA - 6707 ) <nl> * Add tooling to detect hot partitions ( CASSANDRA - 7974 ) <nl> * Fix cassandra - stress user - mode truncation of partition generation ( CASSANDRA - 8608 ) <nl> * Only stream from unrepaired sstables during inc repair ( CASSANDRA - 8267 ) <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java b / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java <nl> index 30259dd . . 633d43c 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java <nl> @ @ - 65 , 6 + 65 , 13 @ @ public class SelectStatement implements CQLStatement <nl> <nl> private static final int DEFAULT _ COUNT _ PAGE _ SIZE = 10000 ; <nl> <nl> + / * * <nl> + * In the current version a query containing duplicate values in an IN restriction on the partition key will <nl> + * cause the same record to be returned multiple time . This behavior will be changed in 3 . 0 but until then <nl> + * we will log a warning the first time this problem occurs . <nl> + * / <nl> + private static volatile boolean HAS _ LOGGED _ WARNING _ FOR _ IN _ RESTRICTION _ WITH _ DUPLICATES ; <nl> + <nl> private final int boundTerms ; <nl> public final CFMetaData cfm ; <nl> public final Parameters parameters ; <nl> @ @ - 588 , 6 + 595 , 13 @ @ public class SelectStatement implements CQLStatement <nl> <nl> if ( builder . remainingCount ( ) = = 1 ) <nl> { <nl> + if ( values . size ( ) > 1 & & ! HAS _ LOGGED _ WARNING _ FOR _ IN _ RESTRICTION _ WITH _ DUPLICATES & & containsDuplicates ( values ) ) <nl> + { <nl> + / / This approach does not fully prevent race conditions but it is not a big deal . <nl> + HAS _ LOGGED _ WARNING _ FOR _ IN _ RESTRICTION _ WITH _ DUPLICATES = true ; <nl> + logger . warn ( " SELECT queries with IN restrictions on the partition key containing duplicate values will return duplicate rows . " ) ; <nl> + } <nl> + <nl> for ( ByteBuffer val : values ) <nl> { <nl> if ( val = = null ) <nl> @ @ - 609 , 6 + 623 , 17 @ @ public class SelectStatement implements CQLStatement <nl> return keys ; <nl> } <nl> <nl> + / * * <nl> + * Checks if the specified list contains duplicate values . <nl> + * <nl> + * @ param values the values to check <nl> + * @ return < code > true < / code > if the specified list contains duplicate values , < code > false < / code > otherwise . <nl> + * / <nl> + private static boolean containsDuplicates ( List < ByteBuffer > values ) <nl> + { <nl> + return new HashSet < > ( values ) . size ( ) < values . size ( ) ; <nl> + } <nl> + <nl> private ByteBuffer getKeyBound ( Bound b , QueryOptions options ) throws InvalidRequestException <nl> { <nl> / / Deal with unrestricted partition key components ( special - casing is required to deal with 2i queries on the first
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 630ee2e . . 1f0f0e9 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 10 @ @ <nl> - 1 . 0 - dev <nl> + 1 . 1 - dev <nl> + <nl> + <nl> + 1 . 0 . 1 <nl> + <nl> + <nl> + 1 . 0 <nl> * removed binarymemtable ( CASSANDRA - 2692 ) <nl> * add commitlog _ total _ space _ in _ mb to prevent fragmented logs ( CASSANDRA - 2427 ) <nl> * removed commitlog _ rotation _ threshold _ in _ mb configuration ( CASSANDRA - 2771 )

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index f1eaa77 . . 9cd8189 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 2 . 1 . 3 
 + * Duplicate rows returned when in clause has repeated values ( CASSANDRA - 6707 ) 
 * Add tooling to detect hot partitions ( CASSANDRA - 7974 ) 
 * Fix cassandra - stress user - mode truncation of partition generation ( CASSANDRA - 8608 ) 
 * Only stream from unrepaired sstables during inc repair ( CASSANDRA - 8267 ) 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java b / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java 
 index 30259dd . . 633d43c 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java 
 @ @ - 65 , 6 + 65 , 13 @ @ public class SelectStatement implements CQLStatement 
 
 private static final int DEFAULT _ COUNT _ PAGE _ SIZE = 10000 ; 
 
 + / * * 
 + * In the current version a query containing duplicate values in an IN restriction on the partition key will 
 + * cause the same record to be returned multiple time . This behavior will be changed in 3 . 0 but until then 
 + * we will log a warning the first time this problem occurs . 
 + * / 
 + private static volatile boolean HAS _ LOGGED _ WARNING _ FOR _ IN _ RESTRICTION _ WITH _ DUPLICATES ; 
 + 
 private final int boundTerms ; 
 public final CFMetaData cfm ; 
 public final Parameters parameters ; 
 @ @ - 588 , 6 + 595 , 13 @ @ public class SelectStatement implements CQLStatement 
 
 if ( builder . remainingCount ( ) = = 1 ) 
 { 
 + if ( values . size ( ) > 1 & & ! HAS _ LOGGED _ WARNING _ FOR _ IN _ RESTRICTION _ WITH _ DUPLICATES & & containsDuplicates ( values ) ) 
 + { 
 + / / This approach does not fully prevent race conditions but it is not a big deal . 
 + HAS _ LOGGED _ WARNING _ FOR _ IN _ RESTRICTION _ WITH _ DUPLICATES = true ; 
 + logger . warn ( " SELECT queries with IN restrictions on the partition key containing duplicate values will return duplicate rows . " ) ; 
 + } 
 + 
 for ( ByteBuffer val : values ) 
 { 
 if ( val = = null ) 
 @ @ - 609 , 6 + 623 , 17 @ @ public class SelectStatement implements CQLStatement 
 return keys ; 
 } 
 
 + / * * 
 + * Checks if the specified list contains duplicate values . 
 + * 
 + * @ param values the values to check 
 + * @ return < code > true < / code > if the specified list contains duplicate values , < code > false < / code > otherwise . 
 + * / 
 + private static boolean containsDuplicates ( List < ByteBuffer > values ) 
 + { 
 + return new HashSet < > ( values ) . size ( ) < values . size ( ) ; 
 + } 
 + 
 private ByteBuffer getKeyBound ( Bound b , QueryOptions options ) throws InvalidRequestException 
 { 
 / / Deal with unrestricted partition key components ( special - casing is required to deal with 2i queries on the first

NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 630ee2e . . 1f0f0e9 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 10 @ @ 
 - 1 . 0 - dev 
 + 1 . 1 - dev 
 + 
 + 
 + 1 . 0 . 1 
 + 
 + 
 + 1 . 0 
 * removed binarymemtable ( CASSANDRA - 2692 ) 
 * add commitlog _ total _ space _ in _ mb to prevent fragmented logs ( CASSANDRA - 2427 ) 
 * removed commitlog _ rotation _ threshold _ in _ mb configuration ( CASSANDRA - 2771 )
