BLEU SCORE: 0.010074736594413143

TEST MSG: Do not persist ReversedType in system _ schema . columns
GENERATED MSG: replace ColumnValidator code with AbstractType and clean up to avoid reflection on the request path . also use final fields in ColumnDefinition . patch by jbellis

TEST DIFF (one line): diff - - git a / lib / cassandra - driver - core - 3 . 0 . 0 - alpha3 - 7b60bed - SNAPSHOT - shaded . jar b / lib / cassandra - driver - core - 3 . 0 . 0 - alpha3 - 7b60bed - SNAPSHOT - shaded . jar <nl> new file mode 100644 <nl> index 0000000 . . 405919f <nl> Binary files / dev / null and b / lib / cassandra - driver - core - 3 . 0 . 0 - alpha3 - 7b60bed - SNAPSHOT - shaded . jar differ <nl> diff - - git a / lib / cassandra - driver - core - 3 . 0 . 0 - alpha3 - d56dd0b - SNAPSHOT - shaded . jar b / lib / cassandra - driver - core - 3 . 0 . 0 - alpha3 - d56dd0b - SNAPSHOT - shaded . jar <nl> deleted file mode 100644 <nl> index 79d5a8a . . 0000000 <nl> Binary files a / lib / cassandra - driver - core - 3 . 0 . 0 - alpha3 - d56dd0b - SNAPSHOT - shaded . jar and / dev / null differ <nl> diff - - git a / lib / cassandra - driver - internal - only - 3 . 0 . 0a2 . post0 - 9f91a6d . zip b / lib / cassandra - driver - internal - only - 3 . 0 . 0a2 . post0 - 9f91a6d . zip <nl> new file mode 100644 <nl> index 0000000 . . ff4d150 <nl> Binary files / dev / null and b / lib / cassandra - driver - internal - only - 3 . 0 . 0a2 . post0 - 9f91a6d . zip differ <nl> diff - - git a / lib / cassandra - driver - internal - only - 3 . 0 . 0a2 . post0 - fecbd54 . zip b / lib / cassandra - driver - internal - only - 3 . 0 . 0a2 . post0 - fecbd54 . zip <nl> deleted file mode 100644 <nl> index fe9e0de . . 0000000 <nl> Binary files a / lib / cassandra - driver - internal - only - 3 . 0 . 0a2 . post0 - fecbd54 . zip and / dev / null differ <nl> diff - - git a / src / java / org / apache / cassandra / config / ColumnDefinition . java b / src / java / org / apache / cassandra / config / ColumnDefinition . java <nl> index 7dc425f . . 96513c2 100644 <nl> - - - a / src / java / org / apache / cassandra / config / ColumnDefinition . java <nl> + + + b / src / java / org / apache / cassandra / config / ColumnDefinition . java <nl> @ @ - 37 , 6 + 37 , 11 @ @ public class ColumnDefinition extends ColumnSpecification implements Comparable < <nl> <nl> public static final int NO _ POSITION = - 1 ; <nl> <nl> + public enum ClusteringOrder <nl> + { <nl> + ASC , DESC , NONE <nl> + } <nl> + <nl> / * <nl> * The type of CQL3 column this definition represents . <nl> * There is 4 main type of CQL3 columns : those parts of the partition key , <nl> @ @ - 222 , 6 + 227 , 14 @ @ public class ColumnDefinition extends ColumnSpecification implements Comparable < <nl> return kind = = Kind . REGULAR ; <nl> } <nl> <nl> + public ClusteringOrder clusteringOrder ( ) <nl> + { <nl> + if ( ! isClusteringColumn ( ) ) <nl> + return ClusteringOrder . NONE ; <nl> + <nl> + return type . isReversed ( ) ? ClusteringOrder . DESC : ClusteringOrder . ASC ; <nl> + } <nl> + <nl> / * * <nl> * For convenience sake , if position = = NO _ POSITION , this method will return 0 . The callers should first check <nl> * isOnAllComponents ( ) to distinguish between proper 0 position and NO _ POSITION . <nl> diff - - git a / src / java / org / apache / cassandra / schema / SchemaKeyspace . java b / src / java / org / apache / cassandra / schema / SchemaKeyspace . java <nl> index d8992bd . . 2376fad 100644 <nl> - - - a / src / java / org / apache / cassandra / schema / SchemaKeyspace . java <nl> + + + b / src / java / org / apache / cassandra / schema / SchemaKeyspace . java <nl> @ @ - 34 , 6 + 34 , 7 @ @ import org . slf4j . Logger ; <nl> import org . slf4j . LoggerFactory ; <nl> <nl> import org . apache . cassandra . config . * ; <nl> + import org . apache . cassandra . config . ColumnDefinition . ClusteringOrder ; <nl> import org . apache . cassandra . cql3 . ColumnIdentifier ; <nl> import org . apache . cassandra . cql3 . QueryProcessor ; <nl> import org . apache . cassandra . cql3 . UntypedResultSet ; <nl> @ @ - 117 , 6 + 118 , 7 @ @ public final class SchemaKeyspace <nl> + " keyspace _ name text , " <nl> + " table _ name text , " <nl> + " column _ name text , " <nl> + + " clustering _ order text , " <nl> + " column _ name _ bytes blob , " <nl> + " kind text , " <nl> + " position int , " <nl> @ @ - 1163 , 10 + 1165 , 15 @ @ public final class SchemaKeyspace <nl> { <nl> RowUpdateBuilder adder = new RowUpdateBuilder ( Columns , timestamp , mutation ) . clustering ( table . cfName , column . name . toString ( ) ) ; <nl> <nl> + AbstractType < ? > type = column . type ; <nl> + if ( type instanceof ReversedType ) <nl> + type = ( ( ReversedType ) type ) . baseType ; <nl> + <nl> adder . add ( " column _ name _ bytes " , column . name . bytes ) <nl> . add ( " kind " , column . kind . toString ( ) . toLowerCase ( ) ) <nl> . add ( " position " , column . isOnAllComponents ( ) ? ColumnDefinition . NO _ POSITION : column . position ( ) ) <nl> - . add ( " type " , column . type . toString ( ) ) <nl> + . add ( " clustering _ order " , column . clusteringOrder ( ) . toString ( ) . toLowerCase ( ) ) <nl> + . add ( " type " , type . toString ( ) ) <nl> . build ( ) ; <nl> } <nl> <nl> @ @ - 1193 , 8 + 1200 , 11 @ @ public final class SchemaKeyspace <nl> ColumnDefinition . Kind kind = ColumnDefinition . Kind . valueOf ( row . getString ( " kind " ) . toUpperCase ( ) ) ; <nl> <nl> int position = row . getInt ( " position " ) ; <nl> + ClusteringOrder order = ClusteringOrder . valueOf ( row . getString ( " clustering _ order " ) . toUpperCase ( ) ) ; <nl> <nl> AbstractType < ? > type = parseType ( row . getString ( " type " ) ) ; <nl> + if ( order = = ClusteringOrder . DESC ) <nl> + type = ReversedType . getInstance ( type ) ; <nl> <nl> return new ColumnDefinition ( keyspace , table , name , type , position , kind ) ; <nl> }
NEAREST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / config / CFMetaData . java b / src / java / org / apache / cassandra / config / CFMetaData . java <nl> index 79509bb . . 4fe4692 100644 <nl> - - - a / src / java / org / apache / cassandra / config / CFMetaData . java <nl> + + + b / src / java / org / apache / cassandra / config / CFMetaData . java <nl> @ @ - 36 , 7 + 36 , 6 @ @ import org . apache . cassandra . db . clock . TimestampReconciler ; <nl> import org . apache . cassandra . db . marshal . * ; <nl> import org . apache . cassandra . db . migration . Migration ; <nl> import org . apache . cassandra . locator . DatacenterShardStrategy ; <nl> - import org . apache . cassandra . service . ColumnValidator ; <nl> import org . apache . cassandra . utils . FBUtilities ; <nl> import org . apache . cassandra . utils . Pair ; <nl> <nl> @ @ - 323 , 34 + 322 , 11 @ @ public final class CFMetaData <nl> return idGen . getAndIncrement ( ) ; <nl> } <nl> <nl> - public ColumnValidator getColumnValidator ( byte [ ] column ) <nl> + public AbstractType getValueValidator ( byte [ ] column ) <nl> { <nl> - ColumnValidator validator = null ; <nl> ColumnDefinition columnDefinition = column _ metadata . get ( column ) ; <nl> - <nl> - if ( columnDefinition ! = null ) <nl> - { <nl> - String className = columnDefinition . validation _ class ; <nl> - if ( className ! = null & & className . trim ( ) . length ( ) > 0 ) <nl> - { <nl> - try <nl> - { <nl> - validator = ( ColumnValidator ) Class . forName ( className ) . newInstance ( ) ; <nl> - } <nl> - catch ( ClassNotFoundException cnfe ) <nl> - { <nl> - throw new MarshalException ( " could not find validation class + " + className , cnfe ) ; <nl> - } <nl> - catch ( InstantiationException ie ) <nl> - { <nl> - throw new MarshalException ( " could not instantiate validation class " + className , ie ) ; <nl> - } <nl> - catch ( IllegalAccessException iae ) <nl> - { <nl> - throw new MarshalException ( " IllegalAccessException instantiating validation class " + className , iae ) ; <nl> - } <nl> - } <nl> - } <nl> - return validator ; <nl> + if ( columnDefinition = = null ) <nl> + return null ; <nl> + return columnDefinition . validator ; <nl> } <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / config / ColumnDefinition . java b / src / java / org / apache / cassandra / config / ColumnDefinition . java <nl> index 0290980 . . 6a19e4d 100644 <nl> - - - a / src / java / org / apache / cassandra / config / ColumnDefinition . java <nl> + + + b / src / java / org / apache / cassandra / config / ColumnDefinition . java <nl> @ @ - 6 , 58 + 6 , 50 @ @ import java . util . * ; <nl> import org . apache . commons . lang . builder . EqualsBuilder ; <nl> import org . apache . commons . lang . builder . HashCodeBuilder ; <nl> <nl> + import org . apache . cassandra . db . marshal . AbstractType ; <nl> import org . apache . cassandra . thrift . ColumnDef ; <nl> import org . apache . cassandra . utils . FBUtilities ; <nl> <nl> public class ColumnDefinition { <nl> - public byte [ ] name ; <nl> - public String validation _ class ; <nl> - public String index _ type ; <nl> - public String index _ name ; <nl> + public final byte [ ] name ; <nl> + public final AbstractType validator ; <nl> + public final String index _ type ; <nl> + public final String index _ name ; <nl> <nl> - public ColumnDefinition ( ) <nl> - { <nl> - this ( null , null , null , null ) ; <nl> - } <nl> - <nl> - public ColumnDefinition ( byte [ ] name , String validation _ class , String index _ type , String index _ name ) <nl> + public ColumnDefinition ( byte [ ] name , String validation _ class , String index _ type , String index _ name ) throws ConfigurationException <nl> { <nl> this . name = name ; <nl> - this . validation _ class = validation _ class ; <nl> this . index _ type = index _ type ; <nl> this . index _ name = index _ name ; <nl> + this . validator = DatabaseDescriptor . getComparator ( validation _ class ) ; <nl> } <nl> <nl> @ Override <nl> - public int hashCode ( ) <nl> + public boolean equals ( Object o ) <nl> { <nl> - return new HashCodeBuilder ( ) <nl> - . append ( name ) <nl> - . append ( validation _ class ) <nl> - . append ( index _ type ) <nl> - . append ( index _ name ) <nl> - . toHashCode ( ) ; <nl> + if ( this = = o ) <nl> + return true ; <nl> + if ( o = = null | | getClass ( ) ! = o . getClass ( ) ) <nl> + return false ; <nl> + <nl> + ColumnDefinition that = ( ColumnDefinition ) o ; <nl> + if ( index _ name ! = null ? ! index _ name . equals ( that . index _ name ) : that . index _ name ! = null ) <nl> + return false ; <nl> + if ( index _ type ! = null ? ! index _ type . equals ( that . index _ type ) : that . index _ type ! = null ) <nl> + return false ; <nl> + if ( ! Arrays . equals ( name , that . name ) ) <nl> + return false ; <nl> + return ! ( validator ! = null ? ! validator . equals ( that . validator ) : that . validator ! = null ) ; <nl> } <nl> <nl> @ Override <nl> - public boolean equals ( Object obj ) <nl> + public int hashCode ( ) <nl> { <nl> - if ( obj = = this ) <nl> - { <nl> - return true ; <nl> - } <nl> - else if ( obj = = null | | obj . getClass ( ) ! = getClass ( ) ) <nl> - { <nl> - return false ; <nl> - } <nl> - <nl> - ColumnDefinition rhs = ( ColumnDefinition ) obj ; <nl> - return new EqualsBuilder ( ) <nl> - . append ( name , rhs . name ) <nl> - . append ( validation _ class , rhs . validation _ class ) <nl> - . append ( index _ name , rhs . index _ name ) <nl> - . append ( index _ type , rhs . index _ type ) <nl> - . isEquals ( ) ; <nl> + int result = name ! = null ? Arrays . hashCode ( name ) : 0 ; <nl> + result = 31 * result + ( validator ! = null ? validator . hashCode ( ) : 0 ) ; <nl> + result = 31 * result + ( index _ type ! = null ? index _ type . hashCode ( ) : 0 ) ; <nl> + result = 31 * result + ( index _ name ! = null ? index _ name . hashCode ( ) : 0 ) ; <nl> + return result ; <nl> } <nl> <nl> public static byte [ ] serialize ( ColumnDefinition cd ) throws IOException <nl> @ @ - 66 , 24 + 58 , 15 @ @ public class ColumnDefinition { <nl> DataOutputStream out = new DataOutputStream ( bout ) ; <nl> out . writeInt ( cd . name . length ) ; <nl> out . write ( cd . name ) ; <nl> - <nl> - out . writeBoolean ( cd . validation _ class ! = null ) ; <nl> - if ( cd . validation _ class ! = null ) <nl> - { <nl> - out . writeUTF ( cd . validation _ class ) ; <nl> - } <nl> + out . writeUTF ( cd . validator . getClass ( ) . getName ( ) ) ; <nl> <nl> out . writeBoolean ( cd . index _ type ! = null ) ; <nl> if ( cd . index _ type ! = null ) <nl> - { <nl> out . writeUTF ( cd . index _ type ) ; <nl> - } <nl> <nl> out . writeBoolean ( cd . index _ name ! = null ) ; <nl> if ( cd . index _ name ! = null ) <nl> - { <nl> out . writeUTF ( cd . index _ name ) ; <nl> - } <nl> <nl> out . close ( ) ; <nl> return bout . toByteArray ( ) ; <nl> @ @ - 91 , 37 + 74 , 36 @ @ public class ColumnDefinition { <nl> <nl> public static ColumnDefinition deserialize ( byte [ ] bytes ) throws IOException <nl> { <nl> - ColumnDefinition cd = new ColumnDefinition ( ) ; <nl> DataInputStream in = new DataInputStream ( new ByteArrayInputStream ( bytes ) ) ; <nl> int nameSize = in . readInt ( ) ; <nl> - cd . name = new byte [ nameSize ] ; <nl> - if ( in . read ( cd . name , 0 , nameSize ) ! = nameSize ) <nl> - throw new IOException ( " short read of ColumnDefinition name " ) ; <nl> - <nl> - if ( in . readBoolean ( ) ) <nl> - cd . validation _ class = in . readUTF ( ) ; <nl> + byte [ ] name = new byte [ nameSize ] ; <nl> + in . readFully ( name ) ; <nl> + String validation _ class = in . readUTF ( ) ; <nl> <nl> + String index _ type = null ; <nl> if ( in . readBoolean ( ) ) <nl> - cd . index _ type = in . readUTF ( ) ; <nl> + index _ type = in . readUTF ( ) ; <nl> <nl> + String index _ name = null ; <nl> if ( in . readBoolean ( ) ) <nl> - cd . index _ name = in . readUTF ( ) ; <nl> + index _ name = in . readUTF ( ) ; <nl> <nl> - return cd ; <nl> + try <nl> + { <nl> + return new ColumnDefinition ( name , validation _ class , index _ type , index _ name ) ; <nl> + } <nl> + catch ( ConfigurationException e ) <nl> + { <nl> + throw new RuntimeException ( e ) ; <nl> + } <nl> } <nl> <nl> - public static ColumnDefinition fromColumnDef ( ColumnDef thriftColumnDef ) <nl> + public static ColumnDefinition fromColumnDef ( ColumnDef cd ) throws ConfigurationException <nl> { <nl> - assert thriftColumnDef ! = null ; <nl> - ColumnDefinition cd = new ColumnDefinition ( ) ; <nl> - cd . name = thriftColumnDef . name ; <nl> - cd . validation _ class = thriftColumnDef . validation _ class ; <nl> - cd . index _ type = thriftColumnDef . index _ type ; <nl> - cd . index _ name = thriftColumnDef . index _ name ; <nl> - return cd ; <nl> + return new ColumnDefinition ( cd . name , cd . validation _ class , cd . index _ type , cd . index _ name ) ; <nl> } <nl> <nl> - public static Map < byte [ ] , ColumnDefinition > fromColumnDef ( List < ColumnDef > thriftDefs ) <nl> + public static Map < byte [ ] , ColumnDefinition > fromColumnDef ( List < ColumnDef > thriftDefs ) throws ConfigurationException <nl> { <nl> if ( thriftDefs = = null ) <nl> return Collections . emptyMap ( ) ; <nl> diff - - git a / src / java / org / apache / cassandra / config / DatabaseDescriptor . java b / src / java / org / apache / cassandra / config / DatabaseDescriptor . java <nl> index d381711 . . 18bcfcc 100644 <nl> - - - a / src / java / org / apache / cassandra / config / DatabaseDescriptor . java <nl> + + + b / src / java / org / apache / cassandra / config / DatabaseDescriptor . java <nl> @ @ - 46 , 7 + 46 , 6 @ @ import org . apache . cassandra . dht . IPartitioner ; <nl> import org . apache . cassandra . io . util . FileUtils ; <nl> import org . apache . cassandra . locator . AbstractReplicationStrategy ; <nl> import org . apache . cassandra . locator . IEndpointSnitch ; <nl> - import org . apache . cassandra . service . ColumnValidator ; <nl> import org . apache . cassandra . service . StorageService ; <nl> import org . apache . cassandra . utils . FBUtilities ; <nl> import org . apache . cassandra . utils . Pair ; <nl> @ @ - 1081 , 8 + 1080 , 8 @ @ public class DatabaseDescriptor <nl> return conf . hinted _ handoff _ enabled ; <nl> } <nl> <nl> - public static ColumnValidator getColumnValidator ( String keyspace , String cf , byte [ ] column ) <nl> + public static AbstractType getValueValidator ( String keyspace , String cf , byte [ ] column ) <nl> { <nl> - return getCFMetaData ( keyspace , cf ) . getColumnValidator ( column ) ; <nl> + return getCFMetaData ( keyspace , cf ) . getValueValidator ( column ) ; <nl> } <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / db / marshal / AbstractType . java b / src / java / org / apache / cassandra / db / marshal / AbstractType . java <nl> index 651fdac . . b3cf7b1 100644 <nl> - - - a / src / java / org / apache / cassandra / db / marshal / AbstractType . java <nl> + + + b / src / java / org / apache / cassandra / db / marshal / AbstractType . java <nl> @ @ - 86 , 12 + 86 , 4 @ @ public abstract class AbstractType implements Comparator < byte [ ] > <nl> } <nl> return builder . toString ( ) ; <nl> } <nl> - <nl> - public final boolean equals ( Object obj ) <nl> - { <nl> - if ( obj = = null ) <nl> - return false ; <nl> - else <nl> - return obj . getClass ( ) . getName ( ) . equals ( getClass ( ) . getName ( ) ) ; <nl> - } <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / service / ColumnValidator . java b / src / java / org / apache / cassandra / service / ColumnValidator . java <nl> deleted file mode 100644 <nl> index a19f25f . . 0000000 <nl> - - - a / src / java / org / apache / cassandra / service / ColumnValidator . java <nl> + + + / dev / null <nl> @ @ - 1 , 9 + 0 , 0 @ @ <nl> - package org . apache . cassandra . service ; <nl> - <nl> - import org . apache . cassandra . thrift . Column ; <nl> - import org . apache . cassandra . thrift . ColumnParent ; <nl> - <nl> - public interface ColumnValidator <nl> - { <nl> - public void validate ( String keyspace , ColumnParent column _ parent , Column column ) ; <nl> - } <nl> diff - - git a / src / java / org / apache / cassandra / service / ExampleColumnValidator . java b / src / java / org / apache / cassandra / service / ExampleColumnValidator . java <nl> deleted file mode 100644 <nl> index df6a93d . . 0000000 <nl> - - - a / src / java / org / apache / cassandra / service / ExampleColumnValidator . java <nl> + + + / dev / null <nl> @ @ - 1 , 15 + 0 , 0 @ @ <nl> - package org . apache . cassandra . service ; <nl> - <nl> - import org . apache . cassandra . db . marshal . MarshalException ; <nl> - import org . apache . cassandra . thrift . Column ; <nl> - import org . apache . cassandra . thrift . ColumnParent ; <nl> - <nl> - public class ExampleColumnValidator implements ColumnValidator <nl> - { <nl> - @ Override <nl> - public void validate ( String keyspace , ColumnParent column _ parent , Column column ) <nl> - { <nl> - if ( column . value . length % 2 = = 0 ) <nl> - throw new MarshalException ( " column . value . length is even " ) ; <nl> - } <nl> - } <nl> diff - - git a / src / java / org / apache / cassandra / thrift / ThriftValidation . java b / src / java / org / apache / cassandra / thrift / ThriftValidation . java <nl> index 3a51b16 . . 2ae5679 100644 <nl> - - - a / src / java / org / apache / cassandra / thrift / ThriftValidation . java <nl> + + + b / src / java / org / apache / cassandra / thrift / ThriftValidation . java <nl> @ @ - 34 , 7 + 34 , 6 @ @ import org . apache . cassandra . dht . IPartitioner ; <nl> import org . apache . cassandra . dht . RandomPartitioner ; <nl> import org . apache . cassandra . dht . Token ; <nl> import org . apache . cassandra . locator . DatacenterShardStrategy ; <nl> - import org . apache . cassandra . service . ColumnValidator ; <nl> import org . apache . cassandra . service . StorageService ; <nl> import org . apache . cassandra . utils . FBUtilities ; <nl> <nl> @ @ - 52 , 7 + 51 , 7 @ @ public class ThriftValidation <nl> if ( key . length > FBUtilities . MAX _ UNSIGNED _ SHORT ) <nl> { <nl> throw new InvalidRequestException ( " Key length of " + key . length + <nl> - " is longer than maximum of " + FBUtilities . MAX _ UNSIGNED _ SHORT ) ; <nl> + " is longer than maximum of " + FBUtilities . MAX _ UNSIGNED _ SHORT ) ; <nl> } <nl> } <nl> <nl> @ @ - 148 , 7 + 147 , 7 @ @ public class ThriftValidation <nl> } <nl> <nl> private static void validateColumns ( String keyspace , String columnFamilyName , byte [ ] superColumnName , Iterable < byte [ ] > column _ names ) <nl> - throws InvalidRequestException <nl> + throws InvalidRequestException <nl> { <nl> if ( superColumnName ! = null ) <nl> { <nl> @ @ - 282 , 7 + 281 , 7 @ @ public class ThriftValidation <nl> if ( del . predicate . slice _ range ! = null ) <nl> throw new InvalidRequestException ( " Deletion does not yet support SliceRange predicates . " ) ; <nl> } <nl> - <nl> + <nl> if ( ColumnFamilyType . Standard = = DatabaseDescriptor . getColumnFamilyType ( keyspace , cfName ) & & del . super _ column ! = null ) <nl> { <nl> String msg = String . format ( " deletion of super _ column is not possible on a standard ColumnFamily ( KeySpace = % s ColumnFamily = % s Deletion = % s ) " , keyspace , cfName , del ) ; <nl> @ @ - 302 , 33 + 301 , 27 @ @ public class ThriftValidation <nl> validateColumns ( keyspace , cfName , scName , predicate . column _ names ) ; <nl> } <nl> <nl> - public static void runExternalColumnVerifier ( String keyspace , ColumnParent column _ parent , Column column ) throws InvalidRequestException <nl> + public static void validateColumn ( String keyspace , ColumnParent column _ parent , Column column ) throws InvalidRequestException <nl> { <nl> + validateTtl ( column ) ; <nl> + validateColumns ( keyspace , column _ parent , Arrays . asList ( column . name ) ) ; <nl> try <nl> { <nl> - ColumnValidator validator = null ; <nl> - validator = DatabaseDescriptor . getColumnValidator ( keyspace , column _ parent . column _ family , column . name ) ; <nl> + AbstractType validator = DatabaseDescriptor . getValueValidator ( keyspace , column _ parent . column _ family , column . name ) ; <nl> if ( validator ! = null ) <nl> - validator . validate ( keyspace , column _ parent , column ) ; <nl> + validator . validate ( column . value ) ; <nl> } <nl> catch ( MarshalException me ) <nl> { <nl> - String msg = String . format ( " [ % s ] [ % s ] [ md5 ( byte [ ] ) = % s ] = [ md5 ( byte [ ] ) = % s ] failed validation ( % s ) " , <nl> - keyspace , column _ parent . getColumn _ family ( ) , <nl> - FBUtilities . hexHash ( " MD5 " , column . name ) , <nl> - FBUtilities . hexHash ( " MD5 " , column . value ) , <nl> - me . getMessage ( ) ) ; <nl> - throw new InvalidRequestException ( msg ) ; / / why doesn ' t IRE except a caused _ by argument ? <nl> + throw new InvalidRequestException ( String . format ( " [ % s ] [ % s ] [ % s ] = [ % s ] failed validation ( % s ) " , <nl> + keyspace , <nl> + column _ parent . getColumn _ family ( ) , <nl> + FBUtilities . bytesToHex ( column . name ) , <nl> + FBUtilities . bytesToHex ( column . value ) , <nl> + me . getMessage ( ) ) ) ; <nl> } <nl> } <nl> <nl> - public static void validateColumn ( String keyspace , ColumnParent column _ parent , Column column ) throws InvalidRequestException <nl> - { <nl> - validateTtl ( column ) ; <nl> - validateColumns ( keyspace , column _ parent , Arrays . asList ( column . name ) ) ; <nl> - runExternalColumnVerifier ( keyspace , column _ parent , column ) ; <nl> - } <nl> - <nl> public static void validatePredicate ( String keyspace , ColumnParent column _ parent , SlicePredicate predicate ) <nl> throws InvalidRequestException <nl> { <nl> diff - - git a / src / java / org / apache / cassandra / utils / FBUtilities . java b / src / java / org / apache / cassandra / utils / FBUtilities . java <nl> index c6e2512 . . 61d60aa 100644 <nl> - - - a / src / java / org / apache / cassandra / utils / FBUtilities . java <nl> + + + b / src / java / org / apache / cassandra / utils / FBUtilities . java <nl> @ @ - 237 , 11 + 237 , 6 @ @ public class FBUtilities <nl> return hash . abs ( ) ; <nl> } <nl> <nl> - public static String hexHash ( String type , byte [ ] . . . data ) <nl> - { <nl> - return bytesToHex ( hash ( type , data ) ) ; <nl> - } <nl> - <nl> public static byte [ ] hash ( String type , byte [ ] . . . data ) <nl> { <nl> 	 byte [ ] result ; <nl> diff - - git a / test / system / test _ thrift _ server . py b / test / system / test _ thrift _ server . py <nl> index 457c94f . . 2c62936 100644 <nl> - - - a / test / system / test _ thrift _ server . py <nl> + + + b / test / system / test _ thrift _ server . py <nl> @ @ - 1093 , 41 + 1093 , 23 @ @ class TestMutations ( ThriftTester ) : <nl> def test _ column _ validators ( self ) : <nl> ks = ' Keyspace1 ' <nl> _ set _ keyspace ( ks ) <nl> - cd = ColumnDef ( ' col ' , ' org . apache . cassandra . service . ExampleColumnValidator ' , None , None ) <nl> + cd = ColumnDef ( ' col ' , ' LongType ' , None , None ) <nl> cf = CfDef ( ' Keyspace1 ' , ' ValidatorColumnFamily ' , column _ metadata = [ cd ] ) <nl> client . system _ add _ column _ family ( cf ) <nl> dks = client . describe _ keyspace ( ks ) <nl> assert ' ValidatorColumnFamily ' in dks <nl> <nl> cp = ColumnParent ( ' ValidatorColumnFamily ' ) <nl> - col0 = Column ( ' col ' , ' valuegood ' , Clock ( 0 ) ) <nl> - col1 = Column ( ' col ' , ' valuebad ' , Clock ( 0 ) ) <nl> + col0 = Column ( ' col ' , _ i64 ( 42 ) , Clock ( 0 ) ) <nl> + col1 = Column ( ' col ' , " ceci n ' est pas 64bit " , Clock ( 0 ) ) <nl> client . insert ( ' key0 ' , cp , col0 , ConsistencyLevel . ONE ) <nl> e = _ expect _ exception ( lambda : client . insert ( ' key1 ' , cp , col1 , ConsistencyLevel . ONE ) , InvalidRequestException ) <nl> assert e . why . find ( " failed validation " ) > = 0 <nl> - assert e . why . find ( " column . value . length is even " ) > = 0 <nl> - <nl> - def test _ super _ column _ validators ( self ) : <nl> - ks = ' Keyspace1 ' <nl> - _ set _ keyspace ( ks ) <nl> - cd = ColumnDef ( ' col ' , ' org . apache . cassandra . service . ExampleColumnValidator ' , None , None ) <nl> - cf = CfDef ( ' Keyspace1 ' , ' SuperValidatorColumnFamily ' , ' Super ' , column _ metadata = [ cd ] ) <nl> - client . system _ add _ column _ family ( cf ) <nl> - dks = client . describe _ keyspace ( ' Keyspace1 ' ) <nl> - assert ' SuperValidatorColumnFamily ' in dks <nl> - <nl> - cp = ColumnParent ( ' SuperValidatorColumnFamily ' , ' a subcolumn ' ) <nl> - col0 = Column ( ' col ' , ' valuegood ' , Clock ( 0 ) ) <nl> - col1 = Column ( ' col ' , ' valuebad ' , Clock ( 0 ) ) <nl> - client . insert ( ' key0 ' , cp , col0 , ConsistencyLevel . ONE ) <nl> - e = _ expect _ exception ( lambda : client . insert ( ' key1 ' , cp , col1 , ConsistencyLevel . ONE ) , InvalidRequestException ) <nl> - assert e . why . find ( " failed validation " ) > = 0 <nl> - assert e . why . find ( " column . value . length is even " ) > = 0 <nl> <nl> def test _ system _ column _ family _ operations ( self ) : <nl> _ set _ keyspace ( ' Keyspace1 ' ) <nl> # create <nl> - cd = ColumnDef ( ' ValidationColumn ' , ' randomclass ' , None , None ) <nl> + cd = ColumnDef ( ' ValidationColumn ' , ' BytesType ' , None , None ) <nl> newcf = CfDef ( ' Keyspace1 ' , ' NewColumnFamily ' , column _ metadata = [ cd ] ) <nl> client . system _ add _ column _ family ( newcf ) <nl> ks1 = client . describe _ keyspace ( ' Keyspace1 ' ) <nl> @ @ - 1150 , 7 + 1132 , 7 @ @ class TestMutations ( ThriftTester ) : <nl> _ set _ keyspace ( ' Keyspace1 ' ) <nl> <nl> # create <nl> - cd = ColumnDef ( ' ValidationColumn ' , ' randomclass ' , None , None ) <nl> + cd = ColumnDef ( ' ValidationColumn ' , ' BytesType ' , None , None ) <nl> newcf = CfDef ( ' Keyspace1 ' , ' NewSuperColumnFamily ' , ' Super ' , column _ metadata = [ cd ] ) <nl> client . system _ add _ column _ family ( newcf ) <nl> ks1 = client . describe _ keyspace ( ' Keyspace1 ' ) <nl> diff - - git a / test / unit / org / apache / cassandra / config / ColumnDefinitionTest . java b / test / unit / org / apache / cassandra / config / ColumnDefinitionTest . java <nl> index 623e30f . . 64d8e17 100644 <nl> - - - a / test / unit / org / apache / cassandra / config / ColumnDefinitionTest . java <nl> + + + b / test / unit / org / apache / cassandra / config / ColumnDefinitionTest . java <nl> @ @ - 7 , 17 + 7 , 15 @ @ public class ColumnDefinitionTest <nl> @ Test <nl> public void testSerializeDeserialize ( ) throws Exception <nl> { <nl> - ColumnDefinition cd0 = new ColumnDefinition ( <nl> - " TestColumnDefinitionName0 " . getBytes ( " UTF8 " ) , <nl> - " org . apache . cassandra . config . RandomClass0 " , <nl> - " random index name 0 " , <nl> - " random index type 0 " ) ; <nl> + ColumnDefinition cd0 = new ColumnDefinition ( " TestColumnDefinitionName0 " . getBytes ( " UTF8 " ) , <nl> + " BytesType " , <nl> + " random index type 0 " , <nl> + " random index name 0 " ) ; <nl> <nl> - ColumnDefinition cd1 = new ColumnDefinition ( <nl> - " TestColumnDefinition1 " . getBytes ( " UTF8 " ) , <nl> - " org . apache . cassandra . config . RandomClass1 " , <nl> - null , <nl> - null ) ; <nl> + ColumnDefinition cd1 = new ColumnDefinition ( " TestColumnDefinition1 " . getBytes ( " UTF8 " ) , <nl> + " LongType " , <nl> + null , <nl> + null ) ; <nl> <nl> testSerializeDeserialize ( cd0 ) ; <nl> testSerializeDeserialize ( cd1 ) ; <nl> diff - - git a / test / unit / org / apache / cassandra / db / DefsTest . java b / test / unit / org / apache / cassandra / db / DefsTest . java <nl> index d620686 . . 2a4a478 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / DefsTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / DefsTest . java <nl> @ @ - 169 , 43 + 169 , 6 @ @ public class DefsTest extends CleanupHelper <nl> } <nl> <nl> @ Test <nl> - public void testCanAddColumnDefinitionsInColumnMetaData ( ) throws Exception <nl> - { <nl> - String ks = " Keyspace1 " ; <nl> - String cf = " ValidatorColumnFamily " ; <nl> - KSMetaData original = DatabaseDescriptor . getTableDefinition ( ks ) ; <nl> - <nl> - Map < byte [ ] , ColumnDefinition > column _ metadata = new TreeMap < byte [ ] , ColumnDefinition > ( FBUtilities . byteArrayComparator ) ; <nl> - <nl> - ColumnDefinition cd0 = new ColumnDefinition ( ) ; <nl> - cd0 . name = " TestColumn1 " . getBytes ( " UTF8 " ) ; <nl> - cd0 . validation _ class = " random class one " ; <nl> - cd0 . index _ name = null ; <nl> - cd0 . index _ type = null ; <nl> - <nl> - ColumnDefinition cd1 = new ColumnDefinition ( ) ; <nl> - cd1 . name = " * " . getBytes ( " UTF8 " ) ; <nl> - cd1 . validation _ class = " random class two " ; <nl> - cd1 . index _ name = " some name " ; <nl> - cd1 . index _ type = " some type " ; <nl> - <nl> - column _ metadata . put ( cd0 . name , cd0 ) ; <nl> - column _ metadata . put ( cd1 . name , cd1 ) ; <nl> - <nl> - CFMetaData newCf = new CFMetaData ( original . name , cf , ColumnFamilyType . Standard , ClockType . Timestamp , UTF8Type . instance , null , new TimestampReconciler ( ) , " A New Column Family " , 0 , false , 1 . 0 , 0 , column _ metadata ) ; <nl> - assert ! DatabaseDescriptor . getTableDefinition ( ks ) . cfMetaData ( ) . containsKey ( newCf . cfName ) ; <nl> - new AddColumnFamily ( newCf ) . apply ( ) ; <nl> - <nl> - assert DatabaseDescriptor . getTableDefinition ( ks ) . cfMetaData ( ) . containsKey ( newCf . cfName ) ; <nl> - assert DatabaseDescriptor . getTableDefinition ( ks ) . cfMetaData ( ) . get ( newCf . cfName ) . equals ( newCf ) ; <nl> - <nl> - ColumnFamilyStore store = Table . open ( ks ) . getColumnFamilyStore ( cf ) ; <nl> - assert store ! = null ; <nl> - store . forceBlockingFlush ( ) ; <nl> - } <nl> - <nl> - <nl> - @ Test <nl> public void dropCf ( ) throws ConfigurationException , IOException , ExecutionException , InterruptedException <nl> { <nl> DecoratedKey dk = Util . dk ( " dropCf " ) ;

TEST DIFF:
diff - - git a / lib / cassandra - driver - core - 3 . 0 . 0 - alpha3 - 7b60bed - SNAPSHOT - shaded . jar b / lib / cassandra - driver - core - 3 . 0 . 0 - alpha3 - 7b60bed - SNAPSHOT - shaded . jar 
 new file mode 100644 
 index 0000000 . . 405919f 
 Binary files / dev / null and b / lib / cassandra - driver - core - 3 . 0 . 0 - alpha3 - 7b60bed - SNAPSHOT - shaded . jar differ 
 diff - - git a / lib / cassandra - driver - core - 3 . 0 . 0 - alpha3 - d56dd0b - SNAPSHOT - shaded . jar b / lib / cassandra - driver - core - 3 . 0 . 0 - alpha3 - d56dd0b - SNAPSHOT - shaded . jar 
 deleted file mode 100644 
 index 79d5a8a . . 0000000 
 Binary files a / lib / cassandra - driver - core - 3 . 0 . 0 - alpha3 - d56dd0b - SNAPSHOT - shaded . jar and / dev / null differ 
 diff - - git a / lib / cassandra - driver - internal - only - 3 . 0 . 0a2 . post0 - 9f91a6d . zip b / lib / cassandra - driver - internal - only - 3 . 0 . 0a2 . post0 - 9f91a6d . zip 
 new file mode 100644 
 index 0000000 . . ff4d150 
 Binary files / dev / null and b / lib / cassandra - driver - internal - only - 3 . 0 . 0a2 . post0 - 9f91a6d . zip differ 
 diff - - git a / lib / cassandra - driver - internal - only - 3 . 0 . 0a2 . post0 - fecbd54 . zip b / lib / cassandra - driver - internal - only - 3 . 0 . 0a2 . post0 - fecbd54 . zip 
 deleted file mode 100644 
 index fe9e0de . . 0000000 
 Binary files a / lib / cassandra - driver - internal - only - 3 . 0 . 0a2 . post0 - fecbd54 . zip and / dev / null differ 
 diff - - git a / src / java / org / apache / cassandra / config / ColumnDefinition . java b / src / java / org / apache / cassandra / config / ColumnDefinition . java 
 index 7dc425f . . 96513c2 100644 
 - - - a / src / java / org / apache / cassandra / config / ColumnDefinition . java 
 + + + b / src / java / org / apache / cassandra / config / ColumnDefinition . java 
 @ @ - 37 , 6 + 37 , 11 @ @ public class ColumnDefinition extends ColumnSpecification implements Comparable < 
 
 public static final int NO _ POSITION = - 1 ; 
 
 + public enum ClusteringOrder 
 + { 
 + ASC , DESC , NONE 
 + } 
 + 
 / * 
 * The type of CQL3 column this definition represents . 
 * There is 4 main type of CQL3 columns : those parts of the partition key , 
 @ @ - 222 , 6 + 227 , 14 @ @ public class ColumnDefinition extends ColumnSpecification implements Comparable < 
 return kind = = Kind . REGULAR ; 
 } 
 
 + public ClusteringOrder clusteringOrder ( ) 
 + { 
 + if ( ! isClusteringColumn ( ) ) 
 + return ClusteringOrder . NONE ; 
 + 
 + return type . isReversed ( ) ? ClusteringOrder . DESC : ClusteringOrder . ASC ; 
 + } 
 + 
 / * * 
 * For convenience sake , if position = = NO _ POSITION , this method will return 0 . The callers should first check 
 * isOnAllComponents ( ) to distinguish between proper 0 position and NO _ POSITION . 
 diff - - git a / src / java / org / apache / cassandra / schema / SchemaKeyspace . java b / src / java / org / apache / cassandra / schema / SchemaKeyspace . java 
 index d8992bd . . 2376fad 100644 
 - - - a / src / java / org / apache / cassandra / schema / SchemaKeyspace . java 
 + + + b / src / java / org / apache / cassandra / schema / SchemaKeyspace . java 
 @ @ - 34 , 6 + 34 , 7 @ @ import org . slf4j . Logger ; 
 import org . slf4j . LoggerFactory ; 
 
 import org . apache . cassandra . config . * ; 
 + import org . apache . cassandra . config . ColumnDefinition . ClusteringOrder ; 
 import org . apache . cassandra . cql3 . ColumnIdentifier ; 
 import org . apache . cassandra . cql3 . QueryProcessor ; 
 import org . apache . cassandra . cql3 . UntypedResultSet ; 
 @ @ - 117 , 6 + 118 , 7 @ @ public final class SchemaKeyspace 
 + " keyspace _ name text , " 
 + " table _ name text , " 
 + " column _ name text , " 
 + + " clustering _ order text , " 
 + " column _ name _ bytes blob , " 
 + " kind text , " 
 + " position int , " 
 @ @ - 1163 , 10 + 1165 , 15 @ @ public final class SchemaKeyspace 
 { 
 RowUpdateBuilder adder = new RowUpdateBuilder ( Columns , timestamp , mutation ) . clustering ( table . cfName , column . name . toString ( ) ) ; 
 
 + AbstractType < ? > type = column . type ; 
 + if ( type instanceof ReversedType ) 
 + type = ( ( ReversedType ) type ) . baseType ; 
 + 
 adder . add ( " column _ name _ bytes " , column . name . bytes ) 
 . add ( " kind " , column . kind . toString ( ) . toLowerCase ( ) ) 
 . add ( " position " , column . isOnAllComponents ( ) ? ColumnDefinition . NO _ POSITION : column . position ( ) ) 
 - . add ( " type " , column . type . toString ( ) ) 
 + . add ( " clustering _ order " , column . clusteringOrder ( ) . toString ( ) . toLowerCase ( ) ) 
 + . add ( " type " , type . toString ( ) ) 
 . build ( ) ; 
 } 
 
 @ @ - 1193 , 8 + 1200 , 11 @ @ public final class SchemaKeyspace 
 ColumnDefinition . Kind kind = ColumnDefinition . Kind . valueOf ( row . getString ( " kind " ) . toUpperCase ( ) ) ; 
 
 int position = row . getInt ( " position " ) ; 
 + ClusteringOrder order = ClusteringOrder . valueOf ( row . getString ( " clustering _ order " ) . toUpperCase ( ) ) ; 
 
 AbstractType < ? > type = parseType ( row . getString ( " type " ) ) ; 
 + if ( order = = ClusteringOrder . DESC ) 
 + type = ReversedType . getInstance ( type ) ; 
 
 return new ColumnDefinition ( keyspace , table , name , type , position , kind ) ; 
 }

NEAREST DIFF:
diff - - git a / src / java / org / apache / cassandra / config / CFMetaData . java b / src / java / org / apache / cassandra / config / CFMetaData . java 
 index 79509bb . . 4fe4692 100644 
 - - - a / src / java / org / apache / cassandra / config / CFMetaData . java 
 + + + b / src / java / org / apache / cassandra / config / CFMetaData . java 
 @ @ - 36 , 7 + 36 , 6 @ @ import org . apache . cassandra . db . clock . TimestampReconciler ; 
 import org . apache . cassandra . db . marshal . * ; 
 import org . apache . cassandra . db . migration . Migration ; 
 import org . apache . cassandra . locator . DatacenterShardStrategy ; 
 - import org . apache . cassandra . service . ColumnValidator ; 
 import org . apache . cassandra . utils . FBUtilities ; 
 import org . apache . cassandra . utils . Pair ; 
 
 @ @ - 323 , 34 + 322 , 11 @ @ public final class CFMetaData 
 return idGen . getAndIncrement ( ) ; 
 } 
 
 - public ColumnValidator getColumnValidator ( byte [ ] column ) 
 + public AbstractType getValueValidator ( byte [ ] column ) 
 { 
 - ColumnValidator validator = null ; 
 ColumnDefinition columnDefinition = column _ metadata . get ( column ) ; 
 - 
 - if ( columnDefinition ! = null ) 
 - { 
 - String className = columnDefinition . validation _ class ; 
 - if ( className ! = null & & className . trim ( ) . length ( ) > 0 ) 
 - { 
 - try 
 - { 
 - validator = ( ColumnValidator ) Class . forName ( className ) . newInstance ( ) ; 
 - } 
 - catch ( ClassNotFoundException cnfe ) 
 - { 
 - throw new MarshalException ( " could not find validation class + " + className , cnfe ) ; 
 - } 
 - catch ( InstantiationException ie ) 
 - { 
 - throw new MarshalException ( " could not instantiate validation class " + className , ie ) ; 
 - } 
 - catch ( IllegalAccessException iae ) 
 - { 
 - throw new MarshalException ( " IllegalAccessException instantiating validation class " + className , iae ) ; 
 - } 
 - } 
 - } 
 - return validator ; 
 + if ( columnDefinition = = null ) 
 + return null ; 
 + return columnDefinition . validator ; 
 } 
 } 
 diff - - git a / src / java / org / apache / cassandra / config / ColumnDefinition . java b / src / java / org / apache / cassandra / config / ColumnDefinition . java 
 index 0290980 . . 6a19e4d 100644 
 - - - a / src / java / org / apache / cassandra / config / ColumnDefinition . java 
 + + + b / src / java / org / apache / cassandra / config / ColumnDefinition . java 
 @ @ - 6 , 58 + 6 , 50 @ @ import java . util . * ; 
 import org . apache . commons . lang . builder . EqualsBuilder ; 
 import org . apache . commons . lang . builder . HashCodeBuilder ; 
 
 + import org . apache . cassandra . db . marshal . AbstractType ; 
 import org . apache . cassandra . thrift . ColumnDef ; 
 import org . apache . cassandra . utils . FBUtilities ; 
 
 public class ColumnDefinition { 
 - public byte [ ] name ; 
 - public String validation _ class ; 
 - public String index _ type ; 
 - public String index _ name ; 
 + public final byte [ ] name ; 
 + public final AbstractType validator ; 
 + public final String index _ type ; 
 + public final String index _ name ; 
 
 - public ColumnDefinition ( ) 
 - { 
 - this ( null , null , null , null ) ; 
 - } 
 - 
 - public ColumnDefinition ( byte [ ] name , String validation _ class , String index _ type , String index _ name ) 
 + public ColumnDefinition ( byte [ ] name , String validation _ class , String index _ type , String index _ name ) throws ConfigurationException 
 { 
 this . name = name ; 
 - this . validation _ class = validation _ class ; 
 this . index _ type = index _ type ; 
 this . index _ name = index _ name ; 
 + this . validator = DatabaseDescriptor . getComparator ( validation _ class ) ; 
 } 
 
 @ Override 
 - public int hashCode ( ) 
 + public boolean equals ( Object o ) 
 { 
 - return new HashCodeBuilder ( ) 
 - . append ( name ) 
 - . append ( validation _ class ) 
 - . append ( index _ type ) 
 - . append ( index _ name ) 
 - . toHashCode ( ) ; 
 + if ( this = = o ) 
 + return true ; 
 + if ( o = = null | | getClass ( ) ! = o . getClass ( ) ) 
 + return false ; 
 + 
 + ColumnDefinition that = ( ColumnDefinition ) o ; 
 + if ( index _ name ! = null ? ! index _ name . equals ( that . index _ name ) : that . index _ name ! = null ) 
 + return false ; 
 + if ( index _ type ! = null ? ! index _ type . equals ( that . index _ type ) : that . index _ type ! = null ) 
 + return false ; 
 + if ( ! Arrays . equals ( name , that . name ) ) 
 + return false ; 
 + return ! ( validator ! = null ? ! validator . equals ( that . validator ) : that . validator ! = null ) ; 
 } 
 
 @ Override 
 - public boolean equals ( Object obj ) 
 + public int hashCode ( ) 
 { 
 - if ( obj = = this ) 
 - { 
 - return true ; 
 - } 
 - else if ( obj = = null | | obj . getClass ( ) ! = getClass ( ) ) 
 - { 
 - return false ; 
 - } 
 - 
 - ColumnDefinition rhs = ( ColumnDefinition ) obj ; 
 - return new EqualsBuilder ( ) 
 - . append ( name , rhs . name ) 
 - . append ( validation _ class , rhs . validation _ class ) 
 - . append ( index _ name , rhs . index _ name ) 
 - . append ( index _ type , rhs . index _ type ) 
 - . isEquals ( ) ; 
 + int result = name ! = null ? Arrays . hashCode ( name ) : 0 ; 
 + result = 31 * result + ( validator ! = null ? validator . hashCode ( ) : 0 ) ; 
 + result = 31 * result + ( index _ type ! = null ? index _ type . hashCode ( ) : 0 ) ; 
 + result = 31 * result + ( index _ name ! = null ? index _ name . hashCode ( ) : 0 ) ; 
 + return result ; 
 } 
 
 public static byte [ ] serialize ( ColumnDefinition cd ) throws IOException 
 @ @ - 66 , 24 + 58 , 15 @ @ public class ColumnDefinition { 
 DataOutputStream out = new DataOutputStream ( bout ) ; 
 out . writeInt ( cd . name . length ) ; 
 out . write ( cd . name ) ; 
 - 
 - out . writeBoolean ( cd . validation _ class ! = null ) ; 
 - if ( cd . validation _ class ! = null ) 
 - { 
 - out . writeUTF ( cd . validation _ class ) ; 
 - } 
 + out . writeUTF ( cd . validator . getClass ( ) . getName ( ) ) ; 
 
 out . writeBoolean ( cd . index _ type ! = null ) ; 
 if ( cd . index _ type ! = null ) 
 - { 
 out . writeUTF ( cd . index _ type ) ; 
 - } 
 
 out . writeBoolean ( cd . index _ name ! = null ) ; 
 if ( cd . index _ name ! = null ) 
 - { 
 out . writeUTF ( cd . index _ name ) ; 
 - } 
 
 out . close ( ) ; 
 return bout . toByteArray ( ) ; 
 @ @ - 91 , 37 + 74 , 36 @ @ public class ColumnDefinition { 
 
 public static ColumnDefinition deserialize ( byte [ ] bytes ) throws IOException 
 { 
 - ColumnDefinition cd = new ColumnDefinition ( ) ; 
 DataInputStream in = new DataInputStream ( new ByteArrayInputStream ( bytes ) ) ; 
 int nameSize = in . readInt ( ) ; 
 - cd . name = new byte [ nameSize ] ; 
 - if ( in . read ( cd . name , 0 , nameSize ) ! = nameSize ) 
 - throw new IOException ( " short read of ColumnDefinition name " ) ; 
 - 
 - if ( in . readBoolean ( ) ) 
 - cd . validation _ class = in . readUTF ( ) ; 
 + byte [ ] name = new byte [ nameSize ] ; 
 + in . readFully ( name ) ; 
 + String validation _ class = in . readUTF ( ) ; 
 
 + String index _ type = null ; 
 if ( in . readBoolean ( ) ) 
 - cd . index _ type = in . readUTF ( ) ; 
 + index _ type = in . readUTF ( ) ; 
 
 + String index _ name = null ; 
 if ( in . readBoolean ( ) ) 
 - cd . index _ name = in . readUTF ( ) ; 
 + index _ name = in . readUTF ( ) ; 
 
 - return cd ; 
 + try 
 + { 
 + return new ColumnDefinition ( name , validation _ class , index _ type , index _ name ) ; 
 + } 
 + catch ( ConfigurationException e ) 
 + { 
 + throw new RuntimeException ( e ) ; 
 + } 
 } 
 
 - public static ColumnDefinition fromColumnDef ( ColumnDef thriftColumnDef ) 
 + public static ColumnDefinition fromColumnDef ( ColumnDef cd ) throws ConfigurationException 
 { 
 - assert thriftColumnDef ! = null ; 
 - ColumnDefinition cd = new ColumnDefinition ( ) ; 
 - cd . name = thriftColumnDef . name ; 
 - cd . validation _ class = thriftColumnDef . validation _ class ; 
 - cd . index _ type = thriftColumnDef . index _ type ; 
 - cd . index _ name = thriftColumnDef . index _ name ; 
 - return cd ; 
 + return new ColumnDefinition ( cd . name , cd . validation _ class , cd . index _ type , cd . index _ name ) ; 
 } 
 
 - public static Map < byte [ ] , ColumnDefinition > fromColumnDef ( List < ColumnDef > thriftDefs ) 
 + public static Map < byte [ ] , ColumnDefinition > fromColumnDef ( List < ColumnDef > thriftDefs ) throws ConfigurationException 
 { 
 if ( thriftDefs = = null ) 
 return Collections . emptyMap ( ) ; 
 diff - - git a / src / java / org / apache / cassandra / config / DatabaseDescriptor . java b / src / java / org / apache / cassandra / config / DatabaseDescriptor . java 
 index d381711 . . 18bcfcc 100644 
 - - - a / src / java / org / apache / cassandra / config / DatabaseDescriptor . java 
 + + + b / src / java / org / apache / cassandra / config / DatabaseDescriptor . java 
 @ @ - 46 , 7 + 46 , 6 @ @ import org . apache . cassandra . dht . IPartitioner ; 
 import org . apache . cassandra . io . util . FileUtils ; 
 import org . apache . cassandra . locator . AbstractReplicationStrategy ; 
 import org . apache . cassandra . locator . IEndpointSnitch ; 
 - import org . apache . cassandra . service . ColumnValidator ; 
 import org . apache . cassandra . service . StorageService ; 
 import org . apache . cassandra . utils . FBUtilities ; 
 import org . apache . cassandra . utils . Pair ; 
 @ @ - 1081 , 8 + 1080 , 8 @ @ public class DatabaseDescriptor 
 return conf . hinted _ handoff _ enabled ; 
 } 
 
 - public static ColumnValidator getColumnValidator ( String keyspace , String cf , byte [ ] column ) 
 + public static AbstractType getValueValidator ( String keyspace , String cf , byte [ ] column ) 
 { 
 - return getCFMetaData ( keyspace , cf ) . getColumnValidator ( column ) ; 
 + return getCFMetaData ( keyspace , cf ) . getValueValidator ( column ) ; 
 } 
 } 
 diff - - git a / src / java / org / apache / cassandra / db / marshal / AbstractType . java b / src / java / org / apache / cassandra / db / marshal / AbstractType . java 
 index 651fdac . . b3cf7b1 100644 
 - - - a / src / java / org / apache / cassandra / db / marshal / AbstractType . java 
 + + + b / src / java / org / apache / cassandra / db / marshal / AbstractType . java 
 @ @ - 86 , 12 + 86 , 4 @ @ public abstract class AbstractType implements Comparator < byte [ ] > 
 } 
 return builder . toString ( ) ; 
 } 
 - 
 - public final boolean equals ( Object obj ) 
 - { 
 - if ( obj = = null ) 
 - return false ; 
 - else 
 - return obj . getClass ( ) . getName ( ) . equals ( getClass ( ) . getName ( ) ) ; 
 - } 
 } 
 diff - - git a / src / java / org / apache / cassandra / service / ColumnValidator . java b / src / java / org / apache / cassandra / service / ColumnValidator . java 
 deleted file mode 100644 
 index a19f25f . . 0000000 
 - - - a / src / java / org / apache / cassandra / service / ColumnValidator . java 
 + + + / dev / null 
 @ @ - 1 , 9 + 0 , 0 @ @ 
 - package org . apache . cassandra . service ; 
 - 
 - import org . apache . cassandra . thrift . Column ; 
 - import org . apache . cassandra . thrift . ColumnParent ; 
 - 
 - public interface ColumnValidator 
 - { 
 - public void validate ( String keyspace , ColumnParent column _ parent , Column column ) ; 
 - } 
 diff - - git a / src / java / org / apache / cassandra / service / ExampleColumnValidator . java b / src / java / org / apache / cassandra / service / ExampleColumnValidator . java 
 deleted file mode 100644 
 index df6a93d . . 0000000 
 - - - a / src / java / org / apache / cassandra / service / ExampleColumnValidator . java 
 + + + / dev / null 
 @ @ - 1 , 15 + 0 , 0 @ @ 
 - package org . apache . cassandra . service ; 
 - 
 - import org . apache . cassandra . db . marshal . MarshalException ; 
 - import org . apache . cassandra . thrift . Column ; 
 - import org . apache . cassandra . thrift . ColumnParent ; 
 - 
 - public class ExampleColumnValidator implements ColumnValidator 
 - { 
 - @ Override 
 - public void validate ( String keyspace , ColumnParent column _ parent , Column column ) 
 - { 
 - if ( column . value . length % 2 = = 0 ) 
 - throw new MarshalException ( " column . value . length is even " ) ; 
 - } 
 - } 
 diff - - git a / src / java / org / apache / cassandra / thrift / ThriftValidation . java b / src / java / org / apache / cassandra / thrift / ThriftValidation . java 
 index 3a51b16 . . 2ae5679 100644 
 - - - a / src / java / org / apache / cassandra / thrift / ThriftValidation . java 
 + + + b / src / java / org / apache / cassandra / thrift / ThriftValidation . java 
 @ @ - 34 , 7 + 34 , 6 @ @ import org . apache . cassandra . dht . IPartitioner ; 
 import org . apache . cassandra . dht . RandomPartitioner ; 
 import org . apache . cassandra . dht . Token ; 
 import org . apache . cassandra . locator . DatacenterShardStrategy ; 
 - import org . apache . cassandra . service . ColumnValidator ; 
 import org . apache . cassandra . service . StorageService ; 
 import org . apache . cassandra . utils . FBUtilities ; 
 
 @ @ - 52 , 7 + 51 , 7 @ @ public class ThriftValidation 
 if ( key . length > FBUtilities . MAX _ UNSIGNED _ SHORT ) 
 { 
 throw new InvalidRequestException ( " Key length of " + key . length + 
 - " is longer than maximum of " + FBUtilities . MAX _ UNSIGNED _ SHORT ) ; 
 + " is longer than maximum of " + FBUtilities . MAX _ UNSIGNED _ SHORT ) ; 
 } 
 } 
 
 @ @ - 148 , 7 + 147 , 7 @ @ public class ThriftValidation 
 } 
 
 private static void validateColumns ( String keyspace , String columnFamilyName , byte [ ] superColumnName , Iterable < byte [ ] > column _ names ) 
 - throws InvalidRequestException 
 + throws InvalidRequestException 
 { 
 if ( superColumnName ! = null ) 
 { 
 @ @ - 282 , 7 + 281 , 7 @ @ public class ThriftValidation 
 if ( del . predicate . slice _ range ! = null ) 
 throw new InvalidRequestException ( " Deletion does not yet support SliceRange predicates . " ) ; 
 } 
 - 
 + 
 if ( ColumnFamilyType . Standard = = DatabaseDescriptor . getColumnFamilyType ( keyspace , cfName ) & & del . super _ column ! = null ) 
 { 
 String msg = String . format ( " deletion of super _ column is not possible on a standard ColumnFamily ( KeySpace = % s ColumnFamily = % s Deletion = % s ) " , keyspace , cfName , del ) ; 
 @ @ - 302 , 33 + 301 , 27 @ @ public class ThriftValidation 
 validateColumns ( keyspace , cfName , scName , predicate . column _ names ) ; 
 } 
 
 - public static void runExternalColumnVerifier ( String keyspace , ColumnParent column _ parent , Column column ) throws InvalidRequestException 
 + public static void validateColumn ( String keyspace , ColumnParent column _ parent , Column column ) throws InvalidRequestException 
 { 
 + validateTtl ( column ) ; 
 + validateColumns ( keyspace , column _ parent , Arrays . asList ( column . name ) ) ; 
 try 
 { 
 - ColumnValidator validator = null ; 
 - validator = DatabaseDescriptor . getColumnValidator ( keyspace , column _ parent . column _ family , column . name ) ; 
 + AbstractType validator = DatabaseDescriptor . getValueValidator ( keyspace , column _ parent . column _ family , column . name ) ; 
 if ( validator ! = null ) 
 - validator . validate ( keyspace , column _ parent , column ) ; 
 + validator . validate ( column . value ) ; 
 } 
 catch ( MarshalException me ) 
 { 
 - String msg = String . format ( " [ % s ] [ % s ] [ md5 ( byte [ ] ) = % s ] = [ md5 ( byte [ ] ) = % s ] failed validation ( % s ) " , 
 - keyspace , column _ parent . getColumn _ family ( ) , 
 - FBUtilities . hexHash ( " MD5 " , column . name ) , 
 - FBUtilities . hexHash ( " MD5 " , column . value ) , 
 - me . getMessage ( ) ) ; 
 - throw new InvalidRequestException ( msg ) ; / / why doesn ' t IRE except a caused _ by argument ? 
 + throw new InvalidRequestException ( String . format ( " [ % s ] [ % s ] [ % s ] = [ % s ] failed validation ( % s ) " , 
 + keyspace , 
 + column _ parent . getColumn _ family ( ) , 
 + FBUtilities . bytesToHex ( column . name ) , 
 + FBUtilities . bytesToHex ( column . value ) , 
 + me . getMessage ( ) ) ) ; 
 } 
 } 
 
 - public static void validateColumn ( String keyspace , ColumnParent column _ parent , Column column ) throws InvalidRequestException 
 - { 
 - validateTtl ( column ) ; 
 - validateColumns ( keyspace , column _ parent , Arrays . asList ( column . name ) ) ; 
 - runExternalColumnVerifier ( keyspace , column _ parent , column ) ; 
 - } 
 - 
 public static void validatePredicate ( String keyspace , ColumnParent column _ parent , SlicePredicate predicate ) 
 throws InvalidRequestException 
 { 
 diff - - git a / src / java / org / apache / cassandra / utils / FBUtilities . java b / src / java / org / apache / cassandra / utils / FBUtilities . java 
 index c6e2512 . . 61d60aa 100644 
 - - - a / src / java / org / apache / cassandra / utils / FBUtilities . java 
 + + + b / src / java / org / apache / cassandra / utils / FBUtilities . java 
 @ @ - 237 , 11 + 237 , 6 @ @ public class FBUtilities 
 return hash . abs ( ) ; 
 } 
 
 - public static String hexHash ( String type , byte [ ] . . . data ) 
 - { 
 - return bytesToHex ( hash ( type , data ) ) ; 
 - } 
 - 
 public static byte [ ] hash ( String type , byte [ ] . . . data ) 
 { 
 	 byte [ ] result ; 
 diff - - git a / test / system / test _ thrift _ server . py b / test / system / test _ thrift _ server . py 
 index 457c94f . . 2c62936 100644 
 - - - a / test / system / test _ thrift _ server . py 
 + + + b / test / system / test _ thrift _ server . py 
 @ @ - 1093 , 41 + 1093 , 23 @ @ class TestMutations ( ThriftTester ) : 
 def test _ column _ validators ( self ) : 
 ks = ' Keyspace1 ' 
 _ set _ keyspace ( ks ) 
 - cd = ColumnDef ( ' col ' , ' org . apache . cassandra . service . ExampleColumnValidator ' , None , None ) 
 + cd = ColumnDef ( ' col ' , ' LongType ' , None , None ) 
 cf = CfDef ( ' Keyspace1 ' , ' ValidatorColumnFamily ' , column _ metadata = [ cd ] ) 
 client . system _ add _ column _ family ( cf ) 
 dks = client . describe _ keyspace ( ks ) 
 assert ' ValidatorColumnFamily ' in dks 
 
 cp = ColumnParent ( ' ValidatorColumnFamily ' ) 
 - col0 = Column ( ' col ' , ' valuegood ' , Clock ( 0 ) ) 
 - col1 = Column ( ' col ' , ' valuebad ' , Clock ( 0 ) ) 
 + col0 = Column ( ' col ' , _ i64 ( 42 ) , Clock ( 0 ) ) 
 + col1 = Column ( ' col ' , " ceci n ' est pas 64bit " , Clock ( 0 ) ) 
 client . insert ( ' key0 ' , cp , col0 , ConsistencyLevel . ONE ) 
 e = _ expect _ exception ( lambda : client . insert ( ' key1 ' , cp , col1 , ConsistencyLevel . ONE ) , InvalidRequestException ) 
 assert e . why . find ( " failed validation " ) > = 0 
 - assert e . why . find ( " column . value . length is even " ) > = 0 
 - 
 - def test _ super _ column _ validators ( self ) : 
 - ks = ' Keyspace1 ' 
 - _ set _ keyspace ( ks ) 
 - cd = ColumnDef ( ' col ' , ' org . apache . cassandra . service . ExampleColumnValidator ' , None , None ) 
 - cf = CfDef ( ' Keyspace1 ' , ' SuperValidatorColumnFamily ' , ' Super ' , column _ metadata = [ cd ] ) 
 - client . system _ add _ column _ family ( cf ) 
 - dks = client . describe _ keyspace ( ' Keyspace1 ' ) 
 - assert ' SuperValidatorColumnFamily ' in dks 
 - 
 - cp = ColumnParent ( ' SuperValidatorColumnFamily ' , ' a subcolumn ' ) 
 - col0 = Column ( ' col ' , ' valuegood ' , Clock ( 0 ) ) 
 - col1 = Column ( ' col ' , ' valuebad ' , Clock ( 0 ) ) 
 - client . insert ( ' key0 ' , cp , col0 , ConsistencyLevel . ONE ) 
 - e = _ expect _ exception ( lambda : client . insert ( ' key1 ' , cp , col1 , ConsistencyLevel . ONE ) , InvalidRequestException ) 
 - assert e . why . find ( " failed validation " ) > = 0 
 - assert e . why . find ( " column . value . length is even " ) > = 0 
 
 def test _ system _ column _ family _ operations ( self ) : 
 _ set _ keyspace ( ' Keyspace1 ' ) 
 # create 
 - cd = ColumnDef ( ' ValidationColumn ' , ' randomclass ' , None , None ) 
 + cd = ColumnDef ( ' ValidationColumn ' , ' BytesType ' , None , None ) 
 newcf = CfDef ( ' Keyspace1 ' , ' NewColumnFamily ' , column _ metadata = [ cd ] ) 
 client . system _ add _ column _ family ( newcf ) 
 ks1 = client . describe _ keyspace ( ' Keyspace1 ' ) 
 @ @ - 1150 , 7 + 1132 , 7 @ @ class TestMutations ( ThriftTester ) : 
 _ set _ keyspace ( ' Keyspace1 ' ) 
 
 # create 
 - cd = ColumnDef ( ' ValidationColumn ' , ' randomclass ' , None , None ) 
 + cd = ColumnDef ( ' ValidationColumn ' , ' BytesType ' , None , None ) 
 newcf = CfDef ( ' Keyspace1 ' , ' NewSuperColumnFamily ' , ' Super ' , column _ metadata = [ cd ] ) 
 client . system _ add _ column _ family ( newcf ) 
 ks1 = client . describe _ keyspace ( ' Keyspace1 ' ) 
 diff - - git a / test / unit / org / apache / cassandra / config / ColumnDefinitionTest . java b / test / unit / org / apache / cassandra / config / ColumnDefinitionTest . java 
 index 623e30f . . 64d8e17 100644 
 - - - a / test / unit / org / apache / cassandra / config / ColumnDefinitionTest . java 
 + + + b / test / unit / org / apache / cassandra / config / ColumnDefinitionTest . java 
 @ @ - 7 , 17 + 7 , 15 @ @ public class ColumnDefinitionTest 
 @ Test 
 public void testSerializeDeserialize ( ) throws Exception 
 { 
 - ColumnDefinition cd0 = new ColumnDefinition ( 
 - " TestColumnDefinitionName0 " . getBytes ( " UTF8 " ) , 
 - " org . apache . cassandra . config . RandomClass0 " , 
 - " random index name 0 " , 
 - " random index type 0 " ) ; 
 + ColumnDefinition cd0 = new ColumnDefinition ( " TestColumnDefinitionName0 " . getBytes ( " UTF8 " ) , 
 + " BytesType " , 
 + " random index type 0 " , 
 + " random index name 0 " ) ; 
 
 - ColumnDefinition cd1 = new ColumnDefinition ( 
 - " TestColumnDefinition1 " . getBytes ( " UTF8 " ) , 
 - " org . apache . cassandra . config . RandomClass1 " , 
 - null , 
 - null ) ; 
 + ColumnDefinition cd1 = new ColumnDefinition ( " TestColumnDefinition1 " . getBytes ( " UTF8 " ) , 
 + " LongType " , 
 + null , 
 + null ) ; 
 
 testSerializeDeserialize ( cd0 ) ; 
 testSerializeDeserialize ( cd1 ) ; 
 diff - - git a / test / unit / org / apache / cassandra / db / DefsTest . java b / test / unit / org / apache / cassandra / db / DefsTest . java 
 index d620686 . . 2a4a478 100644 
 - - - a / test / unit / org / apache / cassandra / db / DefsTest . java 
 + + + b / test / unit / org / apache / cassandra / db / DefsTest . java 
 @ @ - 169 , 43 + 169 , 6 @ @ public class DefsTest extends CleanupHelper 
 } 
 
 @ Test 
 - public void testCanAddColumnDefinitionsInColumnMetaData ( ) throws Exception 
 - { 
 - String ks = " Keyspace1 " ; 
 - String cf = " ValidatorColumnFamily " ; 
 - KSMetaData original = DatabaseDescriptor . getTableDefinition ( ks ) ; 
 - 
 - Map < byte [ ] , ColumnDefinition > column _ metadata = new TreeMap < byte [ ] , ColumnDefinition > ( FBUtilities . byteArrayComparator ) ; 
 - 
 - ColumnDefinition cd0 = new ColumnDefinition ( ) ; 
 - cd0 . name = " TestColumn1 " . getBytes ( " UTF8 " ) ; 
 - cd0 . validation _ class = " random class one " ; 
 - cd0 . index _ name = null ; 
 - cd0 . index _ type = null ; 
 - 
 - ColumnDefinition cd1 = new ColumnDefinition ( ) ; 
 - cd1 . name = " * " . getBytes ( " UTF8 " ) ; 
 - cd1 . validation _ class = " random class two " ; 
 - cd1 . index _ name = " some name " ; 
 - cd1 . index _ type = " some type " ; 
 - 
 - column _ metadata . put ( cd0 . name , cd0 ) ; 
 - column _ metadata . put ( cd1 . name , cd1 ) ; 
 - 
 - CFMetaData newCf = new CFMetaData ( original . name , cf , ColumnFamilyType . Standard , ClockType . Timestamp , UTF8Type . instance , null , new TimestampReconciler ( ) , " A New Column Family " , 0 , false , 1 . 0 , 0 , column _ metadata ) ; 
 - assert ! DatabaseDescriptor . getTableDefinition ( ks ) . cfMetaData ( ) . containsKey ( newCf . cfName ) ; 
 - new AddColumnFamily ( newCf ) . apply ( ) ; 
 - 
 - assert DatabaseDescriptor . getTableDefinition ( ks ) . cfMetaData ( ) . containsKey ( newCf . cfName ) ; 
 - assert DatabaseDescriptor . getTableDefinition ( ks ) . cfMetaData ( ) . get ( newCf . cfName ) . equals ( newCf ) ; 
 - 
 - ColumnFamilyStore store = Table . open ( ks ) . getColumnFamilyStore ( cf ) ; 
 - assert store ! = null ; 
 - store . forceBlockingFlush ( ) ; 
 - } 
 - 
 - 
 - @ Test 
 public void dropCf ( ) throws ConfigurationException , IOException , ExecutionException , InterruptedException 
 { 
 DecoratedKey dk = Util . dk ( " dropCf " ) ;
