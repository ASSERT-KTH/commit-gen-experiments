BLEU SCORE: 0.05693025330278466

TEST MSG: Fix StreamTransferTask abort / complete bad refcounting
GENERATED MSG: Fix SSTable not released if stream session fails

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 48751d9 . . 076bb65 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 2 . 0 . 13 : <nl> + * Fix StreamTransferTask abort / complete bad refcounting ( CASSANDRA - 8815 ) <nl> * Fix AssertionError when querying a DESC clustering ordered <nl> table with ASC ordering and paging ( CASSANDRA - 8767 ) <nl> * AssertionError : " Memory was freed " when running cleanup ( CASSANDRA - 8716 ) <nl> diff - - git a / src / java / org / apache / cassandra / streaming / StreamTransferTask . java b / src / java / org / apache / cassandra / streaming / StreamTransferTask . java <nl> index 5b75555 . . 8d699e1 100644 <nl> - - - a / src / java / org / apache / cassandra / streaming / StreamTransferTask . java <nl> + + + b / src / java / org / apache / cassandra / streaming / StreamTransferTask . java <nl> @ @ - 22 , 6 + 22 , 9 @ @ import java . util . concurrent . * ; <nl> import java . util . concurrent . ScheduledFuture ; <nl> import java . util . concurrent . atomic . AtomicInteger ; <nl> <nl> + import com . google . common . base . Throwables ; <nl> + import com . google . common . collect . Iterables ; <nl> + <nl> import org . apache . cassandra . concurrent . NamedThreadFactory ; <nl> import org . apache . cassandra . io . sstable . SSTableReader ; <nl> import org . apache . cassandra . streaming . messages . OutgoingFileMessage ; <nl> @ @ - 91 , 8 + 94 , 22 @ @ public class StreamTransferTask extends StreamTask <nl> future . cancel ( false ) ; <nl> timeoutTasks . clear ( ) ; <nl> <nl> + Throwable fail = null ; <nl> for ( OutgoingFileMessage file : files . values ( ) ) <nl> - file . sstable . releaseReference ( ) ; <nl> + { <nl> + try <nl> + { <nl> + file . sstable . releaseReference ( ) ; <nl> + } <nl> + catch ( Throwable t ) <nl> + { <nl> + if ( fail = = null ) fail = t ; <nl> + else fail . addSuppressed ( t ) ; <nl> + } <nl> + } <nl> + files . clear ( ) ; <nl> + if ( fail ! = null ) <nl> + Throwables . propagate ( fail ) ; <nl> } <nl> <nl> public synchronized int getTotalNumberOfFiles ( )
NEAREST DIFF (one line): ELIMINATEDSENTENCE

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 48751d9 . . 076bb65 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 2 . 0 . 13 : 
 + * Fix StreamTransferTask abort / complete bad refcounting ( CASSANDRA - 8815 ) 
 * Fix AssertionError when querying a DESC clustering ordered 
 table with ASC ordering and paging ( CASSANDRA - 8767 ) 
 * AssertionError : " Memory was freed " when running cleanup ( CASSANDRA - 8716 ) 
 diff - - git a / src / java / org / apache / cassandra / streaming / StreamTransferTask . java b / src / java / org / apache / cassandra / streaming / StreamTransferTask . java 
 index 5b75555 . . 8d699e1 100644 
 - - - a / src / java / org / apache / cassandra / streaming / StreamTransferTask . java 
 + + + b / src / java / org / apache / cassandra / streaming / StreamTransferTask . java 
 @ @ - 22 , 6 + 22 , 9 @ @ import java . util . concurrent . * ; 
 import java . util . concurrent . ScheduledFuture ; 
 import java . util . concurrent . atomic . AtomicInteger ; 
 
 + import com . google . common . base . Throwables ; 
 + import com . google . common . collect . Iterables ; 
 + 
 import org . apache . cassandra . concurrent . NamedThreadFactory ; 
 import org . apache . cassandra . io . sstable . SSTableReader ; 
 import org . apache . cassandra . streaming . messages . OutgoingFileMessage ; 
 @ @ - 91 , 8 + 94 , 22 @ @ public class StreamTransferTask extends StreamTask 
 future . cancel ( false ) ; 
 timeoutTasks . clear ( ) ; 
 
 + Throwable fail = null ; 
 for ( OutgoingFileMessage file : files . values ( ) ) 
 - file . sstable . releaseReference ( ) ; 
 + { 
 + try 
 + { 
 + file . sstable . releaseReference ( ) ; 
 + } 
 + catch ( Throwable t ) 
 + { 
 + if ( fail = = null ) fail = t ; 
 + else fail . addSuppressed ( t ) ; 
 + } 
 + } 
 + files . clear ( ) ; 
 + if ( fail ! = null ) 
 + Throwables . propagate ( fail ) ; 
 } 
 
 public synchronized int getTotalNumberOfFiles ( )

NEAREST DIFF:
ELIMINATEDSENTENCE
