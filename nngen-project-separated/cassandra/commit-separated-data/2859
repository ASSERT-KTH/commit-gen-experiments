BLEU SCORE: 0.01509869171115925

TEST MSG: Fix merge
GENERATED MSG: create FM objects w / reference count of one

TEST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / thrift / ThriftValidation . java b / src / java / org / apache / cassandra / thrift / ThriftValidation . java <nl> index b597203 . . d491636 100644 <nl> - - - a / src / java / org / apache / cassandra / thrift / ThriftValidation . java <nl> + + + b / src / java / org / apache / cassandra / thrift / ThriftValidation . java <nl> @ @ - 268 , 7 + 268 , 7 @ @ public class ThriftValidation <nl> if ( range . count < 0 ) <nl> throw new org . apache . cassandra . exceptions . InvalidRequestException ( " get _ slice requires non - negative count " ) ; <nl> <nl> - int maxNameLength = org . apache . cassandra . db . Column . MAX _ NAME _ LENGTH ; <nl> + int maxNameLength = Cell . MAX _ NAME _ LENGTH ; <nl> if ( range . start . remaining ( ) > maxNameLength ) <nl> throw new org . apache . cassandra . exceptions . InvalidRequestException ( " range start length cannot be larger than " + maxNameLength ) ; <nl> if ( range . finish . remaining ( ) > maxNameLength )
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 15b0989 . . 4b59dd8 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 13 , 6 + 13 , 8 @ @ <nl> ( CASSANDRA - 2953 ) <nl> * check column family validity in nodetool repair ( CASSANDRA - 2933 ) <nl> * speedup bytes to hex conversions dramatically ( CASSANDRA - 2850 ) <nl> + * Flush memtables on shutdown when durable writes are disabled <nl> + ( CASSANDRA - 2958 ) <nl> <nl> <nl> 0 . 8 . 2 <nl> diff - - git a / src / java / org / apache / cassandra / db / compaction / CompactionIterator . java b / src / java / org / apache / cassandra / db / compaction / CompactionIterator . java <nl> index ad162aa . . 7e5da9a 100644 <nl> - - - a / src / java / org / apache / cassandra / db / compaction / CompactionIterator . java <nl> + + + b / src / java / org / apache / cassandra / db / compaction / CompactionIterator . java <nl> @ @ - 27 , 7 + 27 , 6 @ @ import java . util . ArrayList ; <nl> import java . util . Iterator ; <nl> import java . util . List ; <nl> <nl> - import org . apache . cassandra . service . StorageService ; <nl> import org . apache . commons . collections . iterators . CollatingIterator ; <nl> import org . slf4j . Logger ; <nl> import org . slf4j . LoggerFactory ; <nl> @ @ - 37 , 6 + 36 , 7 @ @ import org . apache . cassandra . io . sstable . SSTableIdentityIterator ; <nl> import org . apache . cassandra . io . sstable . SSTableReader ; <nl> import org . apache . cassandra . io . sstable . SSTableScanner ; <nl> import org . apache . cassandra . io . util . FileUtils ; <nl> + import org . apache . cassandra . service . StorageService ; <nl> import org . apache . cassandra . utils . FBUtilities ; <nl> import org . apache . cassandra . utils . ReducingIterator ; <nl> <nl> diff - - git a / src / java / org / apache / cassandra / db / compaction / LazilyCompactedRow . java b / src / java / org / apache / cassandra / db / compaction / LazilyCompactedRow . java <nl> index 557bd24 . . f4375eb 100644 <nl> - - - a / src / java / org / apache / cassandra / db / compaction / LazilyCompactedRow . java <nl> + + + b / src / java / org / apache / cassandra / db / compaction / LazilyCompactedRow . java <nl> @ @ - 25 , 17 + 25 , 15 @ @ import java . io . DataOutput ; <nl> import java . io . IOError ; <nl> import java . io . IOException ; <nl> import java . security . MessageDigest ; <nl> - import java . util . * ; <nl> + import java . util . ArrayList ; <nl> + import java . util . Iterator ; <nl> + import java . util . List ; <nl> <nl> import com . google . common . base . Predicates ; <nl> import com . google . common . collect . Iterators ; <nl> import org . apache . commons . collections . iterators . CollatingIterator ; <nl> <nl> - import org . apache . cassandra . db . ColumnFamily ; <nl> - import org . apache . cassandra . db . ColumnFamilyStore ; <nl> - import org . apache . cassandra . db . ColumnIndexer ; <nl> - import org . apache . cassandra . db . CounterColumn ; <nl> - import org . apache . cassandra . db . IColumn ; <nl> + import org . apache . cassandra . db . * ; <nl> import org . apache . cassandra . db . marshal . AbstractType ; <nl> import org . apache . cassandra . io . sstable . SSTableIdentityIterator ; <nl> import org . apache . cassandra . io . util . DataOutputBuffer ; <nl> diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java <nl> index 78ad474 . . 8336176 100644 <nl> - - - a / src / java / org / apache / cassandra / service / StorageService . java <nl> + + + b / src / java / org / apache / cassandra / service / StorageService . java <nl> @ @ - 44 , 6 + 44 , 7 @ @ import org . apache . cassandra . concurrent . StageManager ; <nl> import org . apache . cassandra . config . CFMetaData ; <nl> import org . apache . cassandra . config . ConfigurationException ; <nl> import org . apache . cassandra . config . DatabaseDescriptor ; <nl> + import org . apache . cassandra . config . KSMetaData ; <nl> import org . apache . cassandra . db . * ; <nl> import org . apache . cassandra . db . commitlog . CommitLog ; <nl> import org . apache . cassandra . dht . * ; <nl> @ @ - 408 , 6 + 409 , 18 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe <nl> mutationStage . awaitTermination ( 1 , TimeUnit . SECONDS ) ; <nl> CommitLog . instance . shutdownBlocking ( ) ; <nl> } <nl> + <nl> + List < Future < ? > > flushes = new ArrayList < Future < ? > > ( ) ; <nl> + for ( Table table : Table . all ( ) ) <nl> + { <nl> + KSMetaData ksm = DatabaseDescriptor . getKSMetaData ( table . name ) ; <nl> + if ( ! ksm . isDurableWrites ( ) ) <nl> + { <nl> + for ( ColumnFamilyStore cfs : table . getColumnFamilyStores ( ) ) <nl> + flushes . add ( cfs . forceFlush ( ) ) ; <nl> + } <nl> + } <nl> + FBUtilities . waitOnFutures ( flushes ) ; <nl> } <nl> } ) ; <nl> Runtime . getRuntime ( ) . addShutdownHook ( drainOnShutdown ) ;

TEST DIFF:
diff - - git a / src / java / org / apache / cassandra / thrift / ThriftValidation . java b / src / java / org / apache / cassandra / thrift / ThriftValidation . java 
 index b597203 . . d491636 100644 
 - - - a / src / java / org / apache / cassandra / thrift / ThriftValidation . java 
 + + + b / src / java / org / apache / cassandra / thrift / ThriftValidation . java 
 @ @ - 268 , 7 + 268 , 7 @ @ public class ThriftValidation 
 if ( range . count < 0 ) 
 throw new org . apache . cassandra . exceptions . InvalidRequestException ( " get _ slice requires non - negative count " ) ; 
 
 - int maxNameLength = org . apache . cassandra . db . Column . MAX _ NAME _ LENGTH ; 
 + int maxNameLength = Cell . MAX _ NAME _ LENGTH ; 
 if ( range . start . remaining ( ) > maxNameLength ) 
 throw new org . apache . cassandra . exceptions . InvalidRequestException ( " range start length cannot be larger than " + maxNameLength ) ; 
 if ( range . finish . remaining ( ) > maxNameLength )

NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 15b0989 . . 4b59dd8 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 13 , 6 + 13 , 8 @ @ 
 ( CASSANDRA - 2953 ) 
 * check column family validity in nodetool repair ( CASSANDRA - 2933 ) 
 * speedup bytes to hex conversions dramatically ( CASSANDRA - 2850 ) 
 + * Flush memtables on shutdown when durable writes are disabled 
 + ( CASSANDRA - 2958 ) 
 
 
 0 . 8 . 2 
 diff - - git a / src / java / org / apache / cassandra / db / compaction / CompactionIterator . java b / src / java / org / apache / cassandra / db / compaction / CompactionIterator . java 
 index ad162aa . . 7e5da9a 100644 
 - - - a / src / java / org / apache / cassandra / db / compaction / CompactionIterator . java 
 + + + b / src / java / org / apache / cassandra / db / compaction / CompactionIterator . java 
 @ @ - 27 , 7 + 27 , 6 @ @ import java . util . ArrayList ; 
 import java . util . Iterator ; 
 import java . util . List ; 
 
 - import org . apache . cassandra . service . StorageService ; 
 import org . apache . commons . collections . iterators . CollatingIterator ; 
 import org . slf4j . Logger ; 
 import org . slf4j . LoggerFactory ; 
 @ @ - 37 , 6 + 36 , 7 @ @ import org . apache . cassandra . io . sstable . SSTableIdentityIterator ; 
 import org . apache . cassandra . io . sstable . SSTableReader ; 
 import org . apache . cassandra . io . sstable . SSTableScanner ; 
 import org . apache . cassandra . io . util . FileUtils ; 
 + import org . apache . cassandra . service . StorageService ; 
 import org . apache . cassandra . utils . FBUtilities ; 
 import org . apache . cassandra . utils . ReducingIterator ; 
 
 diff - - git a / src / java / org / apache / cassandra / db / compaction / LazilyCompactedRow . java b / src / java / org / apache / cassandra / db / compaction / LazilyCompactedRow . java 
 index 557bd24 . . f4375eb 100644 
 - - - a / src / java / org / apache / cassandra / db / compaction / LazilyCompactedRow . java 
 + + + b / src / java / org / apache / cassandra / db / compaction / LazilyCompactedRow . java 
 @ @ - 25 , 17 + 25 , 15 @ @ import java . io . DataOutput ; 
 import java . io . IOError ; 
 import java . io . IOException ; 
 import java . security . MessageDigest ; 
 - import java . util . * ; 
 + import java . util . ArrayList ; 
 + import java . util . Iterator ; 
 + import java . util . List ; 
 
 import com . google . common . base . Predicates ; 
 import com . google . common . collect . Iterators ; 
 import org . apache . commons . collections . iterators . CollatingIterator ; 
 
 - import org . apache . cassandra . db . ColumnFamily ; 
 - import org . apache . cassandra . db . ColumnFamilyStore ; 
 - import org . apache . cassandra . db . ColumnIndexer ; 
 - import org . apache . cassandra . db . CounterColumn ; 
 - import org . apache . cassandra . db . IColumn ; 
 + import org . apache . cassandra . db . * ; 
 import org . apache . cassandra . db . marshal . AbstractType ; 
 import org . apache . cassandra . io . sstable . SSTableIdentityIterator ; 
 import org . apache . cassandra . io . util . DataOutputBuffer ; 
 diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java 
 index 78ad474 . . 8336176 100644 
 - - - a / src / java / org / apache / cassandra / service / StorageService . java 
 + + + b / src / java / org / apache / cassandra / service / StorageService . java 
 @ @ - 44 , 6 + 44 , 7 @ @ import org . apache . cassandra . concurrent . StageManager ; 
 import org . apache . cassandra . config . CFMetaData ; 
 import org . apache . cassandra . config . ConfigurationException ; 
 import org . apache . cassandra . config . DatabaseDescriptor ; 
 + import org . apache . cassandra . config . KSMetaData ; 
 import org . apache . cassandra . db . * ; 
 import org . apache . cassandra . db . commitlog . CommitLog ; 
 import org . apache . cassandra . dht . * ; 
 @ @ - 408 , 6 + 409 , 18 @ @ public class StorageService implements IEndpointStateChangeSubscriber , StorageSe 
 mutationStage . awaitTermination ( 1 , TimeUnit . SECONDS ) ; 
 CommitLog . instance . shutdownBlocking ( ) ; 
 } 
 + 
 + List < Future < ? > > flushes = new ArrayList < Future < ? > > ( ) ; 
 + for ( Table table : Table . all ( ) ) 
 + { 
 + KSMetaData ksm = DatabaseDescriptor . getKSMetaData ( table . name ) ; 
 + if ( ! ksm . isDurableWrites ( ) ) 
 + { 
 + for ( ColumnFamilyStore cfs : table . getColumnFamilyStores ( ) ) 
 + flushes . add ( cfs . forceFlush ( ) ) ; 
 + } 
 + } 
 + FBUtilities . waitOnFutures ( flushes ) ; 
 } 
 } ) ; 
 Runtime . getRuntime ( ) . addShutdownHook ( drainOnShutdown ) ;
