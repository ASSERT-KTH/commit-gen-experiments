BLEU SCORE: 0.027611988917697356

TEST MSG: Avoid running query to self through messaging service
GENERATED MSG: expunge row cache post - truncate

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 0bfc8c7 . . ef60329 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 4 . 0 <nl> + * Avoid running query to self through messaging service ( CASSANDRA - 14807 ) <nl> * Allow using custom script for chronicle queue BinLog archival ( CASSANDRA - 14373 ) <nl> * Transient - > Full range movements mishandle consistency level upgrade ( CASSANDRA - 14759 ) <nl> * ReplicaCollection follow - up ( CASSANDRA - 14726 ) <nl> diff - - git a / src / java / org / apache / cassandra / service / reads / repair / AbstractReadRepair . java b / src / java / org / apache / cassandra / service / reads / repair / AbstractReadRepair . java <nl> index b74f8d3 . . 761ffb0 100644 <nl> - - - a / src / java / org / apache / cassandra / service / reads / repair / AbstractReadRepair . java <nl> + + + b / src / java / org / apache / cassandra / service / reads / repair / AbstractReadRepair . java <nl> @ @ - 25 , 6 + 25 , 9 @ @ import com . google . common . base . Preconditions ; <nl> <nl> import com . codahale . metrics . Meter ; <nl> import com . google . common . base . Predicates ; <nl> + <nl> + import org . apache . cassandra . concurrent . Stage ; <nl> + import org . apache . cassandra . concurrent . StageManager ; <nl> import org . apache . cassandra . config . DatabaseDescriptor ; <nl> import org . apache . cassandra . db . ColumnFamilyStore ; <nl> import org . apache . cassandra . db . ConsistencyLevel ; <nl> @ @ - 40 , 6 + 43 , 7 @ @ import org . apache . cassandra . metrics . ReadRepairMetrics ; <nl> import org . apache . cassandra . net . MessageOut ; <nl> import org . apache . cassandra . net . MessagingService ; <nl> import org . apache . cassandra . net . ParameterType ; <nl> + import org . apache . cassandra . service . StorageProxy ; <nl> import org . apache . cassandra . service . reads . DataResolver ; <nl> import org . apache . cassandra . service . reads . DigestResolver ; <nl> import org . apache . cassandra . service . reads . ReadCallback ; <nl> @ @ - 87 , 6 + 91 , 13 @ @ public abstract class AbstractReadRepair < E extends Endpoints < E > , P extends Repli <nl> void sendReadCommand ( Replica to , ReadCallback readCallback , boolean speculative ) <nl> { <nl> ReadCommand command = this . command ; <nl> + <nl> + if ( to . isSelf ( ) ) <nl> + { <nl> + StageManager . getStage ( Stage . READ ) . maybeExecuteImmediately ( new StorageProxy . LocalReadRunnable ( command , readCallback ) ) ; <nl> + return ; <nl> + } <nl> + <nl> if ( to . isTransient ( ) ) <nl> { <nl> / / It ' s OK to send queries to transient nodes during RR , as we may have contacted them for their data request initially
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 43fc53a . . ff79b9a 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 8 , 6 + 8 , 8 @ @ <nl> * Separate tracing from Log4J ( CASSANDRA - 4861 ) <nl> * Exclude gcable tombstones from merkle - tree computation ( CASSANDRA - 4905 ) <nl> * Better printing of AbstractBounds for tracing ( CASSANDRA - 4931 ) <nl> + Merged from 1 . 1 : <nl> + * expunge row cache post - truncate ( CASSANDRA - 4940 ) <nl> <nl> <nl> 1 . 2 - beta2 <nl> diff - - git a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java <nl> index 5435a57 . . 2d06036 100644 <nl> - - - a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java <nl> + + + b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java <nl> @ @ - 37 , 6 + 37 , 7 @ @ import org . slf4j . Logger ; <nl> import org . slf4j . LoggerFactory ; <nl> <nl> import org . apache . cassandra . cache . AutoSavingCache ; <nl> + import org . apache . cassandra . cache . RowCacheKey ; <nl> import org . apache . cassandra . concurrent . DebuggableThreadPoolExecutor ; <nl> import org . apache . cassandra . concurrent . NamedThreadFactory ; <nl> import org . apache . cassandra . config . CFMetaData ; <nl> @ @ - 53 , 6 + 54 , 7 @ @ import org . apache . cassandra . io . sstable . * ; <nl> import org . apache . cassandra . io . util . FileUtils ; <nl> import org . apache . cassandra . metrics . CompactionMetrics ; <nl> import org . apache . cassandra . service . AntiEntropyService ; <nl> + import org . apache . cassandra . service . CacheService ; <nl> import org . apache . cassandra . service . StorageService ; <nl> import org . apache . cassandra . utils . CloseableIterator ; <nl> import org . apache . cassandra . utils . CounterId ; <nl> @ @ - 863 , 6 + 865 , 12 @ @ public class CompactionManager implements CompactionManagerMBean <nl> <nl> for ( SecondaryIndex index : main . indexManager . getIndexes ( ) ) <nl> index . truncate ( truncatedAt ) ; <nl> + <nl> + for ( RowCacheKey key : CacheService . instance . rowCache . getKeySet ( ) ) <nl> + { <nl> + if ( key . cfId = = main . metadata . cfId ) <nl> + CacheService . instance . rowCache . remove ( key ) ; <nl> + } <nl> } <nl> finally <nl> {

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 0bfc8c7 . . ef60329 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 4 . 0 
 + * Avoid running query to self through messaging service ( CASSANDRA - 14807 ) 
 * Allow using custom script for chronicle queue BinLog archival ( CASSANDRA - 14373 ) 
 * Transient - > Full range movements mishandle consistency level upgrade ( CASSANDRA - 14759 ) 
 * ReplicaCollection follow - up ( CASSANDRA - 14726 ) 
 diff - - git a / src / java / org / apache / cassandra / service / reads / repair / AbstractReadRepair . java b / src / java / org / apache / cassandra / service / reads / repair / AbstractReadRepair . java 
 index b74f8d3 . . 761ffb0 100644 
 - - - a / src / java / org / apache / cassandra / service / reads / repair / AbstractReadRepair . java 
 + + + b / src / java / org / apache / cassandra / service / reads / repair / AbstractReadRepair . java 
 @ @ - 25 , 6 + 25 , 9 @ @ import com . google . common . base . Preconditions ; 
 
 import com . codahale . metrics . Meter ; 
 import com . google . common . base . Predicates ; 
 + 
 + import org . apache . cassandra . concurrent . Stage ; 
 + import org . apache . cassandra . concurrent . StageManager ; 
 import org . apache . cassandra . config . DatabaseDescriptor ; 
 import org . apache . cassandra . db . ColumnFamilyStore ; 
 import org . apache . cassandra . db . ConsistencyLevel ; 
 @ @ - 40 , 6 + 43 , 7 @ @ import org . apache . cassandra . metrics . ReadRepairMetrics ; 
 import org . apache . cassandra . net . MessageOut ; 
 import org . apache . cassandra . net . MessagingService ; 
 import org . apache . cassandra . net . ParameterType ; 
 + import org . apache . cassandra . service . StorageProxy ; 
 import org . apache . cassandra . service . reads . DataResolver ; 
 import org . apache . cassandra . service . reads . DigestResolver ; 
 import org . apache . cassandra . service . reads . ReadCallback ; 
 @ @ - 87 , 6 + 91 , 13 @ @ public abstract class AbstractReadRepair < E extends Endpoints < E > , P extends Repli 
 void sendReadCommand ( Replica to , ReadCallback readCallback , boolean speculative ) 
 { 
 ReadCommand command = this . command ; 
 + 
 + if ( to . isSelf ( ) ) 
 + { 
 + StageManager . getStage ( Stage . READ ) . maybeExecuteImmediately ( new StorageProxy . LocalReadRunnable ( command , readCallback ) ) ; 
 + return ; 
 + } 
 + 
 if ( to . isTransient ( ) ) 
 { 
 / / It ' s OK to send queries to transient nodes during RR , as we may have contacted them for their data request initially

NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 43fc53a . . ff79b9a 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 8 , 6 + 8 , 8 @ @ 
 * Separate tracing from Log4J ( CASSANDRA - 4861 ) 
 * Exclude gcable tombstones from merkle - tree computation ( CASSANDRA - 4905 ) 
 * Better printing of AbstractBounds for tracing ( CASSANDRA - 4931 ) 
 + Merged from 1 . 1 : 
 + * expunge row cache post - truncate ( CASSANDRA - 4940 ) 
 
 
 1 . 2 - beta2 
 diff - - git a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java 
 index 5435a57 . . 2d06036 100644 
 - - - a / src / java / org / apache / cassandra / db / compaction / CompactionManager . java 
 + + + b / src / java / org / apache / cassandra / db / compaction / CompactionManager . java 
 @ @ - 37 , 6 + 37 , 7 @ @ import org . slf4j . Logger ; 
 import org . slf4j . LoggerFactory ; 
 
 import org . apache . cassandra . cache . AutoSavingCache ; 
 + import org . apache . cassandra . cache . RowCacheKey ; 
 import org . apache . cassandra . concurrent . DebuggableThreadPoolExecutor ; 
 import org . apache . cassandra . concurrent . NamedThreadFactory ; 
 import org . apache . cassandra . config . CFMetaData ; 
 @ @ - 53 , 6 + 54 , 7 @ @ import org . apache . cassandra . io . sstable . * ; 
 import org . apache . cassandra . io . util . FileUtils ; 
 import org . apache . cassandra . metrics . CompactionMetrics ; 
 import org . apache . cassandra . service . AntiEntropyService ; 
 + import org . apache . cassandra . service . CacheService ; 
 import org . apache . cassandra . service . StorageService ; 
 import org . apache . cassandra . utils . CloseableIterator ; 
 import org . apache . cassandra . utils . CounterId ; 
 @ @ - 863 , 6 + 865 , 12 @ @ public class CompactionManager implements CompactionManagerMBean 
 
 for ( SecondaryIndex index : main . indexManager . getIndexes ( ) ) 
 index . truncate ( truncatedAt ) ; 
 + 
 + for ( RowCacheKey key : CacheService . instance . rowCache . getKeySet ( ) ) 
 + { 
 + if ( key . cfId = = main . metadata . cfId ) 
 + CacheService . instance . rowCache . remove ( key ) ; 
 + } 
 } 
 finally 
 {
