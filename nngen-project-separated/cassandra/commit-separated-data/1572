BLEU SCORE: 0.02383853510228548

TEST MSG: Fix empty partition assertion in unsorted sstable writing tools
GENERATED MSG: ninja follow - up to 8619

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index f5c3b41 . . 4d38e1e 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 2 . 1 . 6 <nl> + * Fix empty partition assertion in unsorted sstable writing tools ( CASSANDRA - 9071 ) <nl> * Ensure truncate without snapshot cannot produce corrupt responses ( CASSANDRA - 9388 ) <nl> * Consistent error message when a table mixes counter and non - counter <nl> columns ( CASSANDRA - 9492 ) <nl> diff - - git a / src / java / org / apache / cassandra / io / sstable / SSTableSimpleUnsortedWriter . java b / src / java / org / apache / cassandra / io / sstable / SSTableSimpleUnsortedWriter . java <nl> index 4d7f4fa . . 9ee9ea1 100644 <nl> - - - a / src / java / org / apache / cassandra / io / sstable / SSTableSimpleUnsortedWriter . java <nl> + + + b / src / java / org / apache / cassandra / io / sstable / SSTableSimpleUnsortedWriter . java <nl> @ @ - 175 , 6 + 175 , 7 @ @ public class SSTableSimpleUnsortedWriter extends AbstractSSTableSimpleWriter <nl> buffer = new Buffer ( ) ; <nl> currentSize = 0 ; <nl> columnFamily = getColumnFamily ( ) ; <nl> + buffer . setFirstInsertedKey ( currentKey ) ; <nl> } <nl> <nl> private void put ( Buffer buffer ) throws IOException <nl> @ @ - 207 , 7 + 208 , 17 @ @ public class SSTableSimpleUnsortedWriter extends AbstractSSTableSimpleWriter <nl> } <nl> <nl> / / typedef <nl> - private static class Buffer extends TreeMap < DecoratedKey , ColumnFamily > { } <nl> + private static class Buffer extends TreeMap < DecoratedKey , ColumnFamily > { <nl> + private DecoratedKey firstInsertedKey ; <nl> + <nl> + public void setFirstInsertedKey ( DecoratedKey firstInsertedKey ) { <nl> + this . firstInsertedKey = firstInsertedKey ; <nl> + } <nl> + <nl> + public DecoratedKey getFirstInsertedKey ( ) { <nl> + return firstInsertedKey ; <nl> + } <nl> + } <nl> <nl> private class DiskWriter extends Thread <nl> { <nl> @ @ - 225 , 14 + 236 , 12 @ @ public class SSTableSimpleUnsortedWriter extends AbstractSSTableSimpleWriter <nl> return ; <nl> <nl> writer = getWriter ( ) ; <nl> - boolean first = true ; <nl> for ( Map . Entry < DecoratedKey , ColumnFamily > entry : b . entrySet ( ) ) <nl> { <nl> if ( entry . getValue ( ) . getColumnCount ( ) > 0 ) <nl> writer . append ( entry . getKey ( ) , entry . getValue ( ) ) ; <nl> - else if ( ! first ) <nl> + else if ( ! entry . getKey ( ) . equals ( b . getFirstInsertedKey ( ) ) ) <nl> throw new AssertionError ( " Empty partition " ) ; <nl> - first = false ; <nl> } <nl> writer . close ( ) ; <nl> } <nl> diff - - git a / test / unit / org / apache / cassandra / io / sstable / CQLSSTableWriterTest . java b / test / unit / org / apache / cassandra / io / sstable / CQLSSTableWriterTest . java <nl> index a7b751e . . fa5cbb4 100644 <nl> - - - a / test / unit / org / apache / cassandra / io / sstable / CQLSSTableWriterTest . java <nl> + + + b / test / unit / org / apache / cassandra / io / sstable / CQLSSTableWriterTest . java <nl> @ @ - 22 , 6 + 22 , 7 @ @ import java . io . FilenameFilter ; <nl> import java . nio . ByteBuffer ; <nl> import java . util . Arrays ; <nl> import java . util . Iterator ; <nl> + import java . util . UUID ; <nl> <nl> import com . google . common . collect . ImmutableMap ; <nl> import com . google . common . io . Files ; <nl> @ @ - 173 , 6 + 174 , 34 @ @ public class CQLSSTableWriterTest <nl> } <nl> <nl> <nl> + @ Test <nl> + public void testSyncNoEmptyRows ( ) throws Exception <nl> + { <nl> + / / Check that the write does not throw an empty partition error
NEAREST DIFF (one line): ELIMINATEDSENTENCE

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index f5c3b41 . . 4d38e1e 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 2 . 1 . 6 
 + * Fix empty partition assertion in unsorted sstable writing tools ( CASSANDRA - 9071 ) 
 * Ensure truncate without snapshot cannot produce corrupt responses ( CASSANDRA - 9388 ) 
 * Consistent error message when a table mixes counter and non - counter 
 columns ( CASSANDRA - 9492 ) 
 diff - - git a / src / java / org / apache / cassandra / io / sstable / SSTableSimpleUnsortedWriter . java b / src / java / org / apache / cassandra / io / sstable / SSTableSimpleUnsortedWriter . java 
 index 4d7f4fa . . 9ee9ea1 100644 
 - - - a / src / java / org / apache / cassandra / io / sstable / SSTableSimpleUnsortedWriter . java 
 + + + b / src / java / org / apache / cassandra / io / sstable / SSTableSimpleUnsortedWriter . java 
 @ @ - 175 , 6 + 175 , 7 @ @ public class SSTableSimpleUnsortedWriter extends AbstractSSTableSimpleWriter 
 buffer = new Buffer ( ) ; 
 currentSize = 0 ; 
 columnFamily = getColumnFamily ( ) ; 
 + buffer . setFirstInsertedKey ( currentKey ) ; 
 } 
 
 private void put ( Buffer buffer ) throws IOException 
 @ @ - 207 , 7 + 208 , 17 @ @ public class SSTableSimpleUnsortedWriter extends AbstractSSTableSimpleWriter 
 } 
 
 / / typedef 
 - private static class Buffer extends TreeMap < DecoratedKey , ColumnFamily > { } 
 + private static class Buffer extends TreeMap < DecoratedKey , ColumnFamily > { 
 + private DecoratedKey firstInsertedKey ; 
 + 
 + public void setFirstInsertedKey ( DecoratedKey firstInsertedKey ) { 
 + this . firstInsertedKey = firstInsertedKey ; 
 + } 
 + 
 + public DecoratedKey getFirstInsertedKey ( ) { 
 + return firstInsertedKey ; 
 + } 
 + } 
 
 private class DiskWriter extends Thread 
 { 
 @ @ - 225 , 14 + 236 , 12 @ @ public class SSTableSimpleUnsortedWriter extends AbstractSSTableSimpleWriter 
 return ; 
 
 writer = getWriter ( ) ; 
 - boolean first = true ; 
 for ( Map . Entry < DecoratedKey , ColumnFamily > entry : b . entrySet ( ) ) 
 { 
 if ( entry . getValue ( ) . getColumnCount ( ) > 0 ) 
 writer . append ( entry . getKey ( ) , entry . getValue ( ) ) ; 
 - else if ( ! first ) 
 + else if ( ! entry . getKey ( ) . equals ( b . getFirstInsertedKey ( ) ) ) 
 throw new AssertionError ( " Empty partition " ) ; 
 - first = false ; 
 } 
 writer . close ( ) ; 
 } 
 diff - - git a / test / unit / org / apache / cassandra / io / sstable / CQLSSTableWriterTest . java b / test / unit / org / apache / cassandra / io / sstable / CQLSSTableWriterTest . java 
 index a7b751e . . fa5cbb4 100644 
 - - - a / test / unit / org / apache / cassandra / io / sstable / CQLSSTableWriterTest . java 
 + + + b / test / unit / org / apache / cassandra / io / sstable / CQLSSTableWriterTest . java 
 @ @ - 22 , 6 + 22 , 7 @ @ import java . io . FilenameFilter ; 
 import java . nio . ByteBuffer ; 
 import java . util . Arrays ; 
 import java . util . Iterator ; 
 + import java . util . UUID ; 
 
 import com . google . common . collect . ImmutableMap ; 
 import com . google . common . io . Files ; 
 @ @ - 173 , 6 + 174 , 34 @ @ public class CQLSSTableWriterTest 
 } 
 
 
 + @ Test 
 + public void testSyncNoEmptyRows ( ) throws Exception 
 + { 
 + / / Check that the write does not throw an empty partition error

NEAREST DIFF:
ELIMINATEDSENTENCE
