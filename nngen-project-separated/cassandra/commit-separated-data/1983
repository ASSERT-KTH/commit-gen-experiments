BLEU SCORE: 0.005639761817130674

TEST MSG: Fix size calculations for prepared statements
GENERATED MSG: remove groovy jar , half - baked Callout code . patch by Michael Greene ; reviewed by jbellis for CASSANDRA - 380

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index e008ab9 . . 96da1bd 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 2 . 1 . 3 <nl> + * Fix high size calculations for prepared statements ( CASSANDRA - 8231 ) <nl> * Centralize shared executors ( CASSANDRA - 8055 ) <nl> * Fix filtering for CONTAINS ( KEY ) relations on frozen collection <nl> clustering columns when the query is restricted to a single <nl> diff - - git a / bin / cassandra . bat b / bin / cassandra . bat <nl> index 5169c44 . . 99b291a 100644 <nl> - - - a / bin / cassandra . bat <nl> + + + b / bin / cassandra . bat <nl> @ @ - 54 , 7 + 54 , 7 @ @ if NOT DEFINED JAVA _ HOME goto : err <nl> REM - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - <nl> REM JVM Opts we ' ll use in legacy run or installation <nl> set JAVA _ OPTS = - ea ^ <nl> - - javaagent : " % CASSANDRA _ HOME % \ lib \ jamm - 0 . 2 . 8 . jar " ^ <nl> + - javaagent : " % CASSANDRA _ HOME % \ lib \ jamm - 0 . 3 . 0 . jar " ^ <nl> - Xms2G ^ <nl> - Xmx2G ^ <nl> - XX : + HeapDumpOnOutOfMemoryError ^ <nl> diff - - git a / bin / cassandra . in . sh b / bin / cassandra . in . sh <nl> index 5b4ee0f . . b6a53f3 100644 <nl> - - - a / bin / cassandra . in . sh <nl> + + + b / bin / cassandra . in . sh <nl> @ @ - 48 , 5 + 48 , 5 @ @ done <nl> if [ " $ JVM _ VENDOR " ! = " OpenJDK " - o " $ JVM _ VERSION " \ > " 1 . 6 . 0 " ] \ <nl> | | [ " $ JVM _ VERSION " = " 1 . 6 . 0 " - a " $ JVM _ PATCH _ VERSION " - ge 23 ] <nl> then <nl> - JAVA _ AGENT = " $ JAVA _ AGENT - javaagent : $ CASSANDRA _ HOME / lib / jamm - 0 . 2 . 8 . jar " <nl> + JAVA _ AGENT = " $ JAVA _ AGENT - javaagent : $ CASSANDRA _ HOME / lib / jamm - 0 . 3 . 0 . jar " <nl> fi <nl> diff - - git a / build . xml b / build . xml <nl> index 43fa531 . . 2e5d0ac 100644 <nl> - - - a / build . xml <nl> + + + b / build . xml <nl> @ @ - 369 , 7 + 369 , 7 @ @ <nl> < / dependency > <nl> < dependency groupId = " com . googlecode . json - simple " artifactId = " json - simple " version = " 1 . 1 " / > <nl> < dependency groupId = " com . boundary " artifactId = " high - scale - lib " version = " 1 . 0 . 6 " / > <nl> - < dependency groupId = " com . github . jbellis " artifactId = " jamm " version = " 0 . 2 . 8 " / > <nl> + < dependency groupId = " com . github . jbellis " artifactId = " jamm " version = " 0 . 3 . 0 " / > <nl> < dependency groupId = " com . thinkaurelius . thrift " artifactId = " thrift - server " version = " 0 . 3 . 7 " > <nl> 	 	 < exclusion groupId = " org . slf4j " artifactId = " slf4j - log4j12 " / > <nl> < / dependency > <nl> @ @ - 688 , 7 + 688 , 7 @ @ <nl> < pathelement location = " $ { test . conf } " / > <nl> < / classpath > <nl> < jvmarg value = " - Dstorage - config = $ { test . conf } " / > <nl> - < jvmarg value = " - javaagent : $ { basedir } / lib / jamm - 0 . 2 . 8 . jar " / > <nl> + < jvmarg value = " - javaagent : $ { basedir } / lib / jamm - 0 . 3 . 0 . jar " / > <nl> < jvmarg value = " - ea " / > <nl> < / java > <nl> < / target > <nl> @ @ - 1107 , 7 + 1107 , 7 @ @ <nl> < formatter type = " brief " usefile = " false " / > <nl> < jvmarg value = " - Dstorage - config = $ { test . conf } " / > <nl> < jvmarg value = " - Djava . awt . headless = true " / > <nl> - < jvmarg value = " - javaagent : $ { basedir } / lib / jamm - 0 . 2 . 8 . jar " / > <nl> + < jvmarg value = " - javaagent : $ { basedir } / lib / jamm - 0 . 3 . 0 . jar " / > <nl> < jvmarg value = " - ea " / > <nl> < jvmarg value = " - Xss256k " / > <nl> < jvmarg value = " - Dcassandra . memtable _ row _ overhead _ computation _ step = 100 " / > <nl> @ @ - 1266 , 7 + 1266 , 7 @ @ <nl> < formatter type = " brief " usefile = " false " / > <nl> < jvmarg value = " - Dstorage - config = $ { test . conf } " / > <nl> < jvmarg value = " - Djava . awt . headless = true " / > <nl> - < jvmarg value = " - javaagent : $ { basedir } / lib / jamm - 0 . 2 . 8 . jar " / > <nl> + < jvmarg value = " - javaagent : $ { basedir } / lib / jamm - 0 . 3 . 0 . jar " / > <nl> < jvmarg value = " - ea " / > <nl> < jvmarg value = " - Xss256k " / > <nl> < jvmarg value = " - Dcassandra . memtable _ row _ overhead _ computation _ step = 100 " / > <nl> @ @ - 1309 , 7 + 1309 , 7 @ @ <nl> < formatter type = " brief " usefile = " false " / > <nl> < jvmarg value = " - Dstorage - config = $ { test . conf } " / > <nl> < jvmarg value = " - Djava . awt . headless = true " / > <nl> - < jvmarg value = " - javaagent : $ { basedir } / lib / jamm - 0 . 2 . 8 . jar " / > <nl> + < jvmarg value = " - javaagent : $ { basedir } / lib / jamm - 0 . 3 . 0 . jar " / > <nl> < jvmarg value = " - ea " / > <nl> < jvmarg value = " - Xss256k " / > <nl> < jvmarg value = " - Dcassandra . test . use _ prepared = $ { cassandra . test . use _ prepared } " / > <nl> diff - - git a / conf / cassandra - env . ps1 b / conf / cassandra - env . ps1 <nl> index 0595cf6 . . 5450ac8 100644 <nl> - - - a / conf / cassandra - env . ps1 <nl> + + + b / conf / cassandra - env . ps1 <nl> @ @ - 301 , 7 + 301 , 7 @ @ Function SetCassandraEnvironment <nl> if ( ( $ env : JVM _ VENDOR - ne " OpenJDK " ) - or ( $ env : JVM _ VERSION . CompareTo ( " 1 . 6 . 0 " ) - eq 1 ) - or <nl> ( ( $ env : JVM _ VERSION - eq " 1 . 6 . 0 " ) - and ( $ env : JVM _ PATCH _ VERSION . CompareTo ( " 22 " ) - eq 1 ) ) ) <nl> { <nl> - $ env : JVM _ OPTS = " $ env : JVM _ OPTS - javaagent : " " $ env : CASSANDRA _ HOME \ lib \ jamm - 0 . 2 . 8 . jar " " " <nl> + $ env : JVM _ OPTS = " $ env : JVM _ OPTS - javaagent : " " $ env : CASSANDRA _ HOME \ lib \ jamm - 0 . 3 . 0 . jar " " " <nl> } <nl> <nl> # enable assertions . disabling this in production will give a modest <nl> diff - - git a / conf / cassandra - env . sh b / conf / cassandra - env . sh <nl> index f5669bb . . 191fb7e 100644 <nl> - - - a / conf / cassandra - env . sh <nl> + + + b / conf / cassandra - env . sh <nl> @ @ - 173 , 7 + 173 , 7 @ @ JMX _ PORT = " 7199 " <nl> JVM _ OPTS = " $ JVM _ OPTS - ea " <nl> <nl> # add the jamm javaagent <nl> - JVM _ OPTS = " $ JVM _ OPTS - javaagent : $ CASSANDRA _ HOME / lib / jamm - 0 . 2 . 8 . jar " <nl> + JVM _ OPTS = " $ JVM _ OPTS - javaagent : $ CASSANDRA _ HOME / lib / jamm - 0 . 3 . 0 . jar " <nl> <nl> # some JVMs will fill up their heap when accessed via JMX , see CASSANDRA - 6541 <nl> JVM _ OPTS = " $ JVM _ OPTS - XX : + CMSClassUnloadingEnabled " <nl> diff - - git a / debian / cassandra . in . sh b / debian / cassandra . in . sh <nl> index bf76cf7 . . 9f69ac9 100644 <nl> - - - a / debian / cassandra . in . sh <nl> + + + b / debian / cassandra . in . sh <nl> @ @ - 26 , 5 + 26 , 5 @ @ CLASSPATH = " $ CLASSPATH : $ EXTRA _ CLASSPATH " <nl> if [ " $ JVM _ VENDOR " ! = " OpenJDK " - o " $ JVM _ VERSION " \ > " 1 . 6 . 0 " ] \ <nl> | | [ " $ JVM _ VERSION " = " 1 . 6 . 0 " - a " $ JVM _ PATCH _ VERSION " - ge 23 ] <nl> then <nl> - JAVA _ AGENT = " $ JAVA _ AGENT - javaagent : $ CASSANDRA _ HOME / lib / jamm - 0 . 2 . 8 . jar " <nl> + JAVA _ AGENT = " $ JAVA _ AGENT - javaagent : $ CASSANDRA _ HOME / lib / jamm - 0 . 3 . 0 . jar " <nl> fi <nl> diff - - git a / lib / jamm - 0 . 2 . 8 . jar b / lib / jamm - 0 . 2 . 8 . jar <nl> deleted file mode 100644 <nl> index e1cb669 . . 0000000 <nl> Binary files a / lib / jamm - 0 . 2 . 8 . jar and / dev / null differ <nl> diff - - git a / lib / licenses / jamm - 0 . 2 . 8 . txt b / lib / licenses / jamm - 0 . 2 . 8 . txt <nl> deleted file mode 100644 <nl> index d645695 . . 0000000 <nl> - - - a / lib / licenses / jamm - 0 . 2 . 8 . txt <nl> + + + / dev / null <nl> @ @ - 1 , 202 + 0 , 0 @ @ <nl> - <nl> - Apache License <nl> - Version 2 . 0 , January 2004 <nl> - http : / / www . apache . org / licenses / <nl> - <nl> - TERMS AND CONDITIONS FOR USE , REPRODUCTION , AND DISTRIBUTION <nl> - <nl> - 1 . Definitions . <nl> - <nl> - " License " shall mean the terms and conditions for use , reproduction , <nl> - and distribution as defined by Sections 1 through 9 of this document . <nl> - <nl> - " Licensor " shall mean the copyright owner or entity authorized by <nl> - the copyright owner that is granting the License . <nl> - <nl> - " Legal Entity " shall mean the union of the acting entity and all <nl> - other entities that control , are controlled by , or are under common <nl> - control with that entity . For the purposes of this definition , <nl> - " control " means ( i ) the power , direct or indirect , to cause the <nl> - direction or management of such entity , whether by contract or <nl> - otherwise , or ( ii ) ownership of fifty percent ( 50 % ) or more of the <nl> - outstanding shares , or ( iii ) beneficial ownership of such entity . <nl> - <nl> - " You " ( or " Your " ) shall mean an individual or Legal Entity <nl> - exercising permissions granted by this License . <nl> - <nl> - " Source " form shall mean the preferred form for making modifications , <nl> - including but not limited to software source code , documentation <nl> - source , and configuration files . <nl> - <nl> - " Object " form shall mean any form resulting from mechanical <nl> - transformation or translation of a Source form , including but <nl> - not limited to compiled object code , generated documentation , <nl> - and conversions to other media types . <nl> - <nl> - " Work " shall mean the work of authorship , whether in Source or <nl> - Object form , made available under the License , as indicated by a <nl> - copyright notice that is included in or attached to the work <nl> - ( an example is provided in the Appendix below ) . <nl> - <nl> - " Derivative Works " shall mean any work , whether in Source or Object <nl> - form , that is based on ( or derived from ) the Work and for which the <nl> - editorial revisions , annotations , elaborations , or other modifications <nl> - represent , as a whole , an original work of authorship . For the purposes <nl> - of this License , Derivative Works shall not include works that remain <nl> - separable from , or merely link ( or bind by name ) to the interfaces of , <nl> - the Work and Derivative Works thereof . <nl> - <nl> - " Contribution " shall mean any work of authorship , including <nl> - the original version of the Work and any modifications or additions <nl> - to that Work or Derivative Works thereof , that is intentionally <nl> - submitted to Licensor for inclusion in the Work by the copyright owner <nl> - or by an individual or Legal Entity authorized to submit on behalf of <nl> - the copyright owner . For the purposes of this definition , " submitted " <nl> - means any form of electronic , verbal , or written communication sent <nl> - to the Licensor or its representatives , including but not limited to <nl> - communication on electronic mailing lists , source code control systems , <nl> - and issue tracking systems that are managed by , or on behalf of , the <nl> - Licensor for the purpose of discussing and improving the Work , but <nl> - excluding communication that is conspicuously marked or otherwise <nl> - designated in writing by the copyright owner as " Not a Contribution . " <nl> - <nl> - " Contributor " shall mean Licensor and any individual or Legal Entity <nl> - on behalf of whom a Contribution has been received by Licensor and <nl> - subsequently incorporated within the Work . <nl> - <nl> - 2 . Grant of Copyright License . Subject to the terms and conditions of <nl> - this License , each Contributor hereby grants to You a perpetual , <nl> - worldwide , non - exclusive , no - charge , royalty - free , irrevocable <nl> - copyright license to reproduce , prepare Derivative Works of , <nl> - publicly display , publicly perform , sublicense , and distribute the <nl> - Work and such Derivative Works in Source or Object form . <nl> - <nl> - 3 . Grant of Patent License . Subject to the terms and conditions of <nl> - this License , each Contributor hereby grants to You a perpetual , <nl> - worldwide , non - exclusive , no - charge , royalty - free , irrevocable <nl> - ( except as stated in this section ) patent license to make , have made , <nl> - use , offer to sell , sell , import , and otherwise transfer the Work , <nl> - where such license applies only to those patent claims licensable <nl> - by such Contributor that are necessarily infringed by their <nl> - Contribution ( s ) alone or by combination of their Contribution ( s ) <nl> - with the Work to which such Contribution ( s ) was submitted . If You <nl> - institute patent litigation against any entity ( including a <nl> - cross - claim or counterclaim in a lawsuit ) alleging that the Work <nl> - or a Contribution incorporated within the Work constitutes direct <nl> - or contributory patent infringement , then any patent licenses <nl> - granted to You under this License for that Work shall terminate <nl> - as of the date such litigation is filed . <nl> - <nl> - 4 . Redistribution . You may reproduce and distribute copies of the <nl> - Work or Derivative Works thereof in any medium , with or without <nl> - modifications , and in Source or Object form , provided that You <nl> - meet the following conditions : <nl> - <nl> - ( a ) You must give any other recipients of the Work or <nl> - Derivative Works a copy of this License ; and <nl> - <nl> - ( b ) You must cause any modified files to carry prominent notices <nl> - stating that You changed the files ; and <nl> - <nl> - ( c ) You must retain , in the Source form of any Derivative Works <nl> - that You distribute , all copyright , patent , trademark , and <nl> - attribution notices from the Source form of the Work , <nl> - excluding those notices that do not pertain to any part of <nl> - the Derivative Works ; and <nl> - <nl> - ( d ) If the Work includes a " NOTICE " text file as part of its <nl> - distribution , then any Derivative Works that You distribute must <nl> - include a readable copy of the attribution notices contained <nl> - within such NOTICE file , excluding those notices that do not <nl> - pertain to any part of the Derivative Works , in at least one <nl> - of the following places : within a NOTICE text file distributed <nl> - as part of the Derivative Works ; within the Source form or <nl> - documentation , if provided along with the Derivative Works ; or , <nl> - within a display generated by the Derivative Works , if and <nl> - wherever such third - party notices normally appear . The contents <nl> - of the NOTICE file are for informational purposes only and <nl> - do not modify the License . You may add Your own attribution <nl> - notices within Derivative Works that You distribute , alongside <nl> - or as an addendum to the NOTICE text from the Work , provided <nl> - that such additional attribution notices cannot be construed <nl> - as modifying the License . <nl> - <nl> - You may add Your own copyright statement to Your modifications and <nl> - may provide additional or different license terms and conditions <nl> - for use , reproduction , or distribution of Your modifications , or <nl> - for any such Derivative Works as a whole , provided Your use , <nl> - reproduction , and distribution of the Work otherwise complies with <nl> - the conditions stated in this License . <nl> - <nl> - 5 . Submission of Contributions . Unless You explicitly state otherwise , <nl> - any Contribution intentionally submitted for inclusion in the Work <nl> - by You to the Licensor shall be under the terms and conditions of <nl> - this License , without any additional terms or conditions . <nl> - Notwithstanding the above , nothing herein shall supersede or modify <nl> - the terms of any separate license agreement you may have executed <nl> - with Licensor regarding such Contributions . <nl> - <nl> - 6 . Trademarks . This License does not grant permission to use the trade <nl> - names , trademarks , service marks , or product names of the Licensor , <nl> - except as required for reasonable and customary use in describing the <nl> - origin of the Work and reproducing the content of the NOTICE file . <nl> - <nl> - 7 . Disclaimer of Warranty . Unless required by applicable law or <nl> - agreed to in writing , Licensor provides the Work ( and each <nl> - Contributor provides its Contributions ) on an " AS IS " BASIS , <nl> - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or <nl> - implied , including , without limitation , any warranties or conditions <nl> - of TITLE , NON - INFRINGEMENT , MERCHANTABILITY , or FITNESS FOR A <nl> - PARTICULAR PURPOSE . You are solely responsible for determining the <nl> - appropriateness of using or redistributing the Work and assume any <nl> - risks associated with Your exercise of permissions under this License . <nl> - <nl> - 8 . Limitation of Liability . In no event and under no legal theory , <nl> - whether in tort ( including negligence ) , contract , or otherwise , <nl> - unless required by applicable law ( such as deliberate and grossly <nl> - negligent acts ) or agreed to in writing , shall any Contributor be <nl> - liable to You for damages , including any direct , indirect , special , <nl> - incidental , or consequential damages of any character arising as a <nl> - result of this License or out of the use or inability to use the <nl> - Work ( including but not limited to damages for loss of goodwill , <nl> - work stoppage , computer failure or malfunction , or any and all <nl> - other commercial damages or losses ) , even if such Contributor <nl> - has been advised of the possibility of such damages . <nl> - <nl> - 9 . Accepting Warranty or Additional Liability . While redistributing <nl> - the Work or Derivative Works thereof , You may choose to offer , <nl> - and charge a fee for , acceptance of support , warranty , indemnity , <nl> - or other liability obligations and / or rights consistent with this <nl> - License . However , in accepting such obligations , You may act only <nl> - on Your own behalf and on Your sole responsibility , not on behalf <nl> - of any other Contributor , and only if You agree to indemnify , <nl> - defend , and hold each Contributor harmless for any liability <nl> - incurred by , or claims asserted against , such Contributor by reason <nl> - of your accepting any such warranty or additional liability . <nl> - <nl> - END OF TERMS AND CONDITIONS <nl> - <nl> - APPENDIX : How to apply the Apache License to your work . <nl> - <nl> - To apply the Apache License to your work , attach the following <nl> - boilerplate notice , with the fields enclosed by brackets " [ ] " <nl> - replaced with your own identifying information . ( Don ' t include <nl> - the brackets ! ) The text should be enclosed in the appropriate <nl> - comment syntax for the file format . We also recommend that a <nl> - file or class name and description of purpose be included on the <nl> - same " printed page " as the copyright notice for easier <nl> - identification within third - party archives . <nl> - <nl> - Copyright [ yyyy ] [ name of copyright owner ] <nl> - <nl> - Licensed under the Apache License , Version 2 . 0 ( the " License " ) ; <nl> - you may not use this file except in compliance with the License . <nl> - You may obtain a copy of the License at <nl> - <nl> - http : / / www . apache . org / licenses / LICENSE - 2 . 0 <nl> - <nl> - Unless required by applicable law or agreed to in writing , software <nl> - distributed under the License is distributed on an " AS IS " BASIS , <nl> - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . <nl> - See the License for the specific language governing permissions and <nl> - limitations under the License . <nl> diff - - git a / src / java / org / apache / cassandra / config / CFMetaData . java b / src / java / org / apache / cassandra / config / CFMetaData . java <nl> index 57f5757 . . 74bd5f8 100644 <nl> - - - a / src / java / org / apache / cassandra / config / CFMetaData . java <nl> + + + b / src / java / org / apache / cassandra / config / CFMetaData . java <nl> @ @ - 57 , 6 + 57 , 7 @ @ import org . apache . cassandra . tracing . Tracing ; <nl> import org . apache . cassandra . utils . ByteBufferUtil ; <nl> import org . apache . cassandra . utils . FBUtilities ; <nl> import org . apache . cassandra . utils . UUIDGen ; <nl> + import org . github . jamm . Unmetered ; <nl> <nl> import static org . apache . cassandra . utils . FBUtilities . fromJsonList ; <nl> import static org . apache . cassandra . utils . FBUtilities . fromJsonMap ; <nl> @ @ - 65 , 6 + 66 , 7 @ @ import static org . apache . cassandra . utils . FBUtilities . json ; <nl> / * * <nl> * This class can be tricky to modify . Please read http : / / wiki . apache . org / cassandra / ConfigurationNotes for how to do so safely . <nl> * / <nl> + @ Unmetered <nl> public final class CFMetaData <nl> { <nl> private static final Logger logger = LoggerFactory . getLogger ( CFMetaData . class ) ; <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / MeasurableForPreparedCache . java b / src / java / org / apache / cassandra / cql3 / MeasurableForPreparedCache . java <nl> deleted file mode 100644 <nl> index 6b3b4b5 . . 0000000 <nl> - - - a / src / java / org / apache / cassandra / cql3 / MeasurableForPreparedCache . java <nl> + + + / dev / null <nl> @ @ - 1 , 26 + 0 , 0 @ @ <nl> - / * <nl> - * Licensed to the Apache Software Foundation ( ASF ) under one <nl> - * or more contributor license agreements . See the NOTICE file <nl> - * distributed with this work for additional information <nl> - * regarding copyright ownership . The ASF licenses this file <nl> - * to you under the Apache License , Version 2 . 0 ( the <nl> - * " License " ) ; you may not use this file except in compliance <nl> - * with the License . You may obtain a copy of the License at <nl> - * <nl> - * http : / / www . apache . org / licenses / LICENSE - 2 . 0 <nl> - * <nl> - * Unless required by applicable law or agreed to in writing , <nl> - * software distributed under the License is distributed on an <nl> - * " AS IS " BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY <nl> - * KIND , either express or implied . See the License for the <nl> - * specific language governing permissions and limitations <nl> - * under the License . <nl> - * / <nl> - package org . apache . cassandra . cql3 ; <nl> - <nl> - import org . github . jamm . MemoryMeter ; <nl> - <nl> - public interface MeasurableForPreparedCache <nl> - { <nl> - public long measureForPreparedCache ( MemoryMeter meter ) ; <nl> - } <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / QueryProcessor . java b / src / java / org / apache / cassandra / cql3 / QueryProcessor . java <nl> index 45ef39c . . 8e829e8 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / QueryProcessor . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / QueryProcessor . java <nl> @ @ - 18 , 28 + 18 , 40 @ @ <nl> package org . apache . cassandra . cql3 ; <nl> <nl> import java . nio . ByteBuffer ; <nl> - import java . util . * ; <nl> + import java . util . ArrayList ; <nl> + import java . util . Collections ; <nl> + import java . util . Iterator ; <nl> + import java . util . List ; <nl> import java . util . concurrent . * ; <nl> import java . util . concurrent . atomic . AtomicInteger ; <nl> <nl> import com . google . common . primitives . Ints ; <nl> <nl> + import org . slf4j . Logger ; <nl> + import org . slf4j . LoggerFactory ; <nl> + <nl> import com . googlecode . concurrentlinkedhashmap . ConcurrentLinkedHashMap ; <nl> import com . googlecode . concurrentlinkedhashmap . EntryWeigher ; <nl> import com . googlecode . concurrentlinkedhashmap . EvictionListener ; <nl> - import org . antlr . runtime . * ; <nl> - import org . github . jamm . MemoryMeter ; <nl> - import org . slf4j . Logger ; <nl> - import org . slf4j . LoggerFactory ; <nl> <nl> import org . apache . cassandra . concurrent . ScheduledExecutors ; <nl> + import org . antlr . runtime . * ; <nl> import org . apache . cassandra . cql3 . statements . * ; <nl> import org . apache . cassandra . db . * ; <nl> - import org . apache . cassandra . db . composites . * ; <nl> + import org . apache . cassandra . db . composites . CType ; <nl> + import org . apache . cassandra . db . composites . CellName ; <nl> + import org . apache . cassandra . db . composites . CellNameType ; <nl> + import org . apache . cassandra . db . composites . Composite ; <nl> import org . apache . cassandra . db . marshal . AbstractType ; <nl> - import org . apache . cassandra . exceptions . * ; <nl> + import org . apache . cassandra . exceptions . InvalidRequestException ; <nl> + import org . apache . cassandra . exceptions . RequestExecutionException ; <nl> + import org . apache . cassandra . exceptions . RequestValidationException ; <nl> + import org . apache . cassandra . exceptions . SyntaxException ; <nl> import org . apache . cassandra . metrics . CQLMetrics ; <nl> - import org . apache . cassandra . service . * ; <nl> + import org . apache . cassandra . service . ClientState ; <nl> + import org . apache . cassandra . service . IMigrationListener ; <nl> + import org . apache . cassandra . service . MigrationManager ; <nl> + import org . apache . cassandra . service . QueryState ; <nl> import org . apache . cassandra . service . pager . QueryPager ; <nl> import org . apache . cassandra . service . pager . QueryPagers ; <nl> import org . apache . cassandra . thrift . ThriftClientState ; <nl> @ @ - 48 , 6 + 60 , 7 @ @ import org . apache . cassandra . transport . messages . ResultMessage ; <nl> import org . apache . cassandra . utils . FBUtilities ; <nl> import org . apache . cassandra . utils . MD5Digest ; <nl> import org . apache . cassandra . utils . SemanticVersion ; <nl> + import org . github . jamm . MemoryMeter ; <nl> <nl> public class QueryProcessor implements QueryHandler <nl> { <nl> @ @ - 542 , 9 + 555 , 7 @ @ public class QueryProcessor implements QueryHandler <nl> <nl> private static long measure ( Object key ) <nl> { <nl> - return key instanceof MeasurableForPreparedCache <nl> - ? ( ( MeasurableForPreparedCache ) key ) . measureForPreparedCache ( meter ) <nl> - : meter . measureDeep ( key ) ; <nl> + return meter . measureDeep ( key ) ; <nl> } <nl> <nl> private static class MigrationSubscriber implements IMigrationListener <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / functions / Function . java b / src / java / org / apache / cassandra / cql3 / functions / Function . java <nl> index ba5ae20 . . b278389 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / functions / Function . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / functions / Function . java <nl> @ @ - 22 , 7 + 22 , 9 @ @ import java . util . List ; <nl> <nl> import org . apache . cassandra . db . marshal . AbstractType ; <nl> import org . apache . cassandra . exceptions . InvalidRequestException ; <nl> + import org . github . jamm . Unmetered ; <nl> <nl> + @ Unmetered <nl> public interface Function <nl> { <nl> public String name ( ) ; <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / BatchStatement . java b / src / java / org / apache / cassandra / cql3 / statements / BatchStatement . java <nl> index d54e4fd . . c93bf64 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / BatchStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / BatchStatement . java <nl> @ @ - 23 , 7 + 23 , 6 @ @ import java . util . * ; <nl> import com . google . common . base . Function ; <nl> import com . google . common . collect . * ; <nl> import org . apache . cassandra . config . DatabaseDescriptor ; <nl> - import org . github . jamm . MemoryMeter ; <nl> import org . slf4j . Logger ; <nl> import org . slf4j . LoggerFactory ; <nl> <nl> @ @ - 41 , 7 + 40 , 7 @ @ import org . apache . cassandra . transport . messages . ResultMessage ; <nl> * A < code > BATCH < / code > statement parsed from a CQL query . <nl> * <nl> * / <nl> - public class BatchStatement implements CQLStatement , MeasurableForPreparedCache <nl> + public class BatchStatement implements CQLStatement <nl> { <nl> public static enum Type <nl> { <nl> @ @ - 76 , 17 + 75 , 6 @ @ public class BatchStatement implements CQLStatement , MeasurableForPreparedCache <nl> this . hasConditions = hasConditions ; <nl> } <nl> <nl> - public long measureForPreparedCache ( MemoryMeter meter ) <nl> - { <nl> - long size = meter . measure ( this ) <nl> - + meter . measureDeep ( type ) <nl> - + meter . measure ( statements ) <nl> - + meter . measureDeep ( attrs ) ; <nl> - for ( ModificationStatement stmt : statements ) <nl> - size + = stmt . measureForPreparedCache ( meter ) ; <nl> - return size ; <nl> - } <nl> - <nl> public int getBoundTerms ( ) <nl> { <nl> return boundTerms ; <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / ModificationStatement . java b / src / java / org / apache / cassandra / cql3 / statements / ModificationStatement . java <nl> index c32430a . . 60558b4 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / ModificationStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / ModificationStatement . java <nl> @ @ - 22 , 8 + 22 , 6 @ @ import java . util . * ; <nl> <nl> import com . google . common . base . Function ; <nl> import com . google . common . collect . Iterables ; <nl> - import org . apache . cassandra . db . marshal . AbstractType ; <nl> - import org . github . jamm . MemoryMeter ; <nl> <nl> import org . apache . cassandra . auth . Permission ; <nl> import org . apache . cassandra . config . CFMetaData ; <nl> @ @ - 46 , 7 + 44 , 7 @ @ import org . apache . cassandra . utils . Pair ; <nl> / * <nl> * Abstract parent class of individual modifications , i . e . INSERT , UPDATE and DELETE . <nl> * / <nl> - public abstract class ModificationStatement implements CQLStatement , MeasurableForPreparedCache <nl> + public abstract class ModificationStatement implements CQLStatement <nl> { <nl> private static final ColumnIdentifier CAS _ RESULT _ COLUMN = new ColumnIdentifier ( " [ applied ] " , false ) ; <nl> <nl> @ @ - 87 , 16 + 85 , 6 @ @ public abstract class ModificationStatement implements CQLStatement , MeasurableF <nl> this . attrs = attrs ; <nl> } <nl> <nl> - public long measureForPreparedCache ( MemoryMeter meter ) <nl> - { <nl> - return meter . measure ( this ) <nl> - + meter . measureDeep ( attrs ) <nl> - + meter . measureDeep ( processedKeys ) <nl> - + meter . measureDeep ( columnOperations ) <nl> - + ( columnConditions = = null ? 0 : meter . measureDeep ( columnConditions ) ) <nl> - + ( staticConditions = = null ? 0 : meter . measureDeep ( staticConditions ) ) ; <nl> - } <nl> - <nl> public abstract boolean requireFullClusteringKey ( ) ; <nl> public abstract void addUpdateForKey ( ColumnFamily updates , ByteBuffer key , Composite prefix , UpdateParameters params ) throws InvalidRequestException ; <nl> <nl> diff - - git a / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java b / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java <nl> index de3d67c . . 6d7bdbb 100644 <nl> - - - a / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java <nl> + + + b / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java <nl> @ @ - 27 , 8 + 27 , 6 @ @ import com . google . common . collect . AbstractIterator ; <nl> import com . google . common . collect . Iterables ; <nl> import com . google . common . collect . Iterators ; <nl> <nl> - import org . github . jamm . MemoryMeter ; <nl> - <nl> import org . apache . cassandra . auth . Permission ; <nl> import org . apache . cassandra . cql3 . * ; <nl> import org . apache . cassandra . cql3 . statements . SingleColumnRestriction . Contains ; <nl> @ @ - 61 , 7 + 59 , 7 @ @ import org . slf4j . LoggerFactory ; <nl> * column family , expression , result count , and ordering clause . <nl> * <nl> * / <nl> - public class SelectStatement implements CQLStatement , MeasurableForPreparedCache <nl> + public class SelectStatement implements CQLStatement <nl> { <nl> private static final Logger logger = LoggerFactory . getLogger ( SelectStatement . class ) ; <nl> <nl> @ @ - 162 , 20 + 160 , 6 @ @ public class SelectStatement implements CQLStatement , MeasurableForPreparedCache <nl> : selection . getResultMetadata ( ) ; <nl> } <nl> <nl> - public long measureForPreparedCache ( MemoryMeter meter ) <nl> - { <nl> - return meter . measure ( this ) <nl> - + meter . measureDeep ( parameters ) <nl> - + meter . measureDeep ( selection ) <nl> - + ( limit = = null ? 0 : meter . measureDeep ( limit ) ) <nl> - + meter . measureDeep ( keyRestrictions ) <nl> - + meter . measureDeep ( columnRestrictions ) <nl> - + meter . measureDeep ( metadataRestrictions ) <nl> - + meter . measureDeep ( restrictedColumns ) <nl> - + ( sliceRestriction = = null ? 0 : meter . measureDeep ( sliceRestriction ) ) <nl> - + ( orderingIndexes = = null ? 0 : meter . measureDeep ( orderingIndexes ) ) ; <nl> - } <nl> - <nl> public int getBoundTerms ( ) <nl> { <nl> return boundTerms ; <nl> diff - - git a / src / java / org / apache / cassandra / db / marshal / AbstractType . java b / src / java / org / apache / cassandra / db / marshal / AbstractType . java <nl> index 8dd2ff3 . . 863cd47 100644 <nl> - - - a / src / java / org / apache / cassandra / db / marshal / AbstractType . java <nl> + + + b / src / java / org / apache / cassandra / db / marshal / AbstractType . java <nl> @ @ - 28 , 6 + 28 , 7 @ @ import org . apache . cassandra . cql3 . CQL3Type ; <nl> import org . apache . cassandra . exceptions . SyntaxException ; <nl> import org . apache . cassandra . serializers . TypeSerializer ; <nl> import org . apache . cassandra . serializers . MarshalException ; <nl> + import org . github . jamm . Unmetered ; <nl> <nl> / * * <nl> * Specifies a Comparator for a specific type of ByteBuffer . <nl> @ @ - 37 , 6 + 38 , 7 @ @ import org . apache . cassandra . serializers . MarshalException ; <nl> * should always handle those values even if they normally do not <nl> * represent a valid ByteBuffer for the type being compared . <nl> * / <nl> + @ Unmetered <nl> public abstract class AbstractType < T > implements Comparator < ByteBuffer > <nl> { <nl> public final Comparator < ByteBuffer > reverseComparator ;
NEAREST DIFF (one line): diff - - git a / NOTICE . txt b / NOTICE . txt <nl> index 6756033 . . 81f9862 100644 <nl> - - - a / NOTICE . txt <nl> + + + b / NOTICE . txt <nl> @ @ - 4 , 7 + 4 , 4 @ @ Copyright 2009 The Apache Software Foundation <nl> This product includes software developed by The Apache Software <nl> Foundation ( http : / / www . apache . org / ) . <nl> <nl> - This product includes software developed by The Groovy community <nl> - ( http : / / groovy . codehaus . org / ) . <nl> - Copyright 2003 - 2007 The respective authors and developers . <nl> Developers and Contributors are listed in the project POM file <nl> diff - - git a / conf / storage - conf . xml b / conf / storage - conf . xml <nl> index 3865f84 . . 3728ade 100644 <nl> - - - a / conf / storage - conf . xml <nl> + + + b / conf / storage - conf . xml <nl> @ @ - 138 , 7 + 138 , 6 @ @ <nl> < DataFileDirectories > <nl> < DataFileDirectory > / var / cassandra / data < / DataFileDirectory > <nl> < / DataFileDirectories > <nl> - < CalloutLocation > / var / cassandra / callouts < / CalloutLocation > <nl> < BootstrapFileDirectory > / var / cassandra / bootstrap < / BootstrapFileDirectory > <nl> < StagingFileDirectory > / var / cassandra / staging < / StagingFileDirectory > <nl> <nl> diff - - git a / lib / groovy - 1 . 5 . 6 . jar b / lib / groovy - 1 . 5 . 6 . jar <nl> deleted file mode 100644 <nl> index 8f61940 . . 0000000 <nl> Binary files a / lib / groovy - 1 . 5 . 6 . jar and / dev / null differ <nl> diff - - git a / lib / licenses / groovy - 1 . 5 . 6 . jar . LICENSE b / lib / licenses / groovy - 1 . 5 . 6 . jar . LICENSE <nl> deleted file mode 100644 <nl> index 7a4a3ea . . 0000000 <nl> - - - a / lib / licenses / groovy - 1 . 5 . 6 . jar . LICENSE <nl> + + + / dev / null <nl> @ @ - 1 , 202 + 0 , 0 @ @ <nl> - <nl> - Apache License <nl> - Version 2 . 0 , January 2004 <nl> - http : / / www . apache . org / licenses / <nl> - <nl> - TERMS AND CONDITIONS FOR USE , REPRODUCTION , AND DISTRIBUTION <nl> - <nl> - 1 . Definitions . <nl> - <nl> - " License " shall mean the terms and conditions for use , reproduction , <nl> - and distribution as defined by Sections 1 through 9 of this document . <nl> - <nl> - " Licensor " shall mean the copyright owner or entity authorized by <nl> - the copyright owner that is granting the License . <nl> - <nl> - " Legal Entity " shall mean the union of the acting entity and all <nl> - other entities that control , are controlled by , or are under common <nl> - control with that entity . For the purposes of this definition , <nl> - " control " means ( i ) the power , direct or indirect , to cause the <nl> - direction or management of such entity , whether by contract or <nl> - otherwise , or ( ii ) ownership of fifty percent ( 50 % ) or more of the <nl> - outstanding shares , or ( iii ) beneficial ownership of such entity . <nl> - <nl> - " You " ( or " Your " ) shall mean an individual or Legal Entity <nl> - exercising permissions granted by this License . <nl> - <nl> - " Source " form shall mean the preferred form for making modifications , <nl> - including but not limited to software source code , documentation <nl> - source , and configuration files . <nl> - <nl> - " Object " form shall mean any form resulting from mechanical <nl> - transformation or translation of a Source form , including but <nl> - not limited to compiled object code , generated documentation , <nl> - and conversions to other media types . <nl> - <nl> - " Work " shall mean the work of authorship , whether in Source or <nl> - Object form , made available under the License , as indicated by a <nl> - copyright notice that is included in or attached to the work <nl> - ( an example is provided in the Appendix below ) . <nl> - <nl> - " Derivative Works " shall mean any work , whether in Source or Object <nl> - form , that is based on ( or derived from ) the Work and for which the <nl> - editorial revisions , annotations , elaborations , or other modifications <nl> - represent , as a whole , an original work of authorship . For the purposes <nl> - of this License , Derivative Works shall not include works that remain <nl> - separable from , or merely link ( or bind by name ) to the interfaces of , <nl> - the Work and Derivative Works thereof . <nl> - <nl> - " Contribution " shall mean any work of authorship , including <nl> - the original version of the Work and any modifications or additions <nl> - to that Work or Derivative Works thereof , that is intentionally <nl> - submitted to Licensor for inclusion in the Work by the copyright owner <nl> - or by an individual or Legal Entity authorized to submit on behalf of <nl> - the copyright owner . For the purposes of this definition , " submitted " <nl> - means any form of electronic , verbal , or written communication sent <nl> - to the Licensor or its representatives , including but not limited to <nl> - communication on electronic mailing lists , source code control systems , <nl> - and issue tracking systems that are managed by , or on behalf of , the <nl> - Licensor for the purpose of discussing and improving the Work , but <nl> - excluding communication that is conspicuously marked or otherwise <nl> - designated in writing by the copyright owner as " Not a Contribution . " <nl> - <nl> - " Contributor " shall mean Licensor and any individual or Legal Entity <nl> - on behalf of whom a Contribution has been received by Licensor and <nl> - subsequently incorporated within the Work . <nl> - <nl> - 2 . Grant of Copyright License . Subject to the terms and conditions of <nl> - this License , each Contributor hereby grants to You a perpetual , <nl> - worldwide , non - exclusive , no - charge , royalty - free , irrevocable <nl> - copyright license to reproduce , prepare Derivative Works of , <nl> - publicly display , publicly perform , sublicense , and distribute the <nl> - Work and such Derivative Works in Source or Object form . <nl> - <nl> - 3 . Grant of Patent License . Subject to the terms and conditions of <nl> - this License , each Contributor hereby grants to You a perpetual , <nl> - worldwide , non - exclusive , no - charge , royalty - free , irrevocable <nl> - ( except as stated in this section ) patent license to make , have made , <nl> - use , offer to sell , sell , import , and otherwise transfer the Work , <nl> - where such license applies only to those patent claims licensable <nl> - by such Contributor that are necessarily infringed by their <nl> - Contribution ( s ) alone or by combination of their Contribution ( s ) <nl> - with the Work to which such Contribution ( s ) was submitted . If You <nl> - institute patent litigation against any entity ( including a <nl> - cross - claim or counterclaim in a lawsuit ) alleging that the Work <nl> - or a Contribution incorporated within the Work constitutes direct <nl> - or contributory patent infringement , then any patent licenses <nl> - granted to You under this License for that Work shall terminate <nl> - as of the date such litigation is filed . <nl> - <nl> - 4 . Redistribution . You may reproduce and distribute copies of the <nl> - Work or Derivative Works thereof in any medium , with or without <nl> - modifications , and in Source or Object form , provided that You <nl> - meet the following conditions : <nl> - <nl> - ( a ) You must give any other recipients of the Work or <nl> - Derivative Works a copy of this License ; and <nl> - <nl> - ( b ) You must cause any modified files to carry prominent notices <nl> - stating that You changed the files ; and <nl> - <nl> - ( c ) You must retain , in the Source form of any Derivative Works <nl> - that You distribute , all copyright , patent , trademark , and <nl> - attribution notices from the Source form of the Work , <nl> - excluding those notices that do not pertain to any part of <nl> - the Derivative Works ; and <nl> - <nl> - ( d ) If the Work includes a " NOTICE " text file as part of its <nl> - distribution , then any Derivative Works that You distribute must <nl> - include a readable copy of the attribution notices contained <nl> - within such NOTICE file , excluding those notices that do not <nl> - pertain to any part of the Derivative Works , in at least one <nl> - of the following places : within a NOTICE text file distributed <nl> - as part of the Derivative Works ; within the Source form or <nl> - documentation , if provided along with the Derivative Works ; or , <nl> - within a display generated by the Derivative Works , if and <nl> - wherever such third - party notices normally appear . The contents <nl> - of the NOTICE file are for informational purposes only and <nl> - do not modify the License . You may add Your own attribution <nl> - notices within Derivative Works that You distribute , alongside <nl> - or as an addendum to the NOTICE text from the Work , provided <nl> - that such additional attribution notices cannot be construed <nl> - as modifying the License . <nl> - <nl> - You may add Your own copyright statement to Your modifications and <nl> - may provide additional or different license terms and conditions <nl> - for use , reproduction , or distribution of Your modifications , or <nl> - for any such Derivative Works as a whole , provided Your use , <nl> - reproduction , and distribution of the Work otherwise complies with <nl> - the conditions stated in this License . <nl> - <nl> - 5 . Submission of Contributions . Unless You explicitly state otherwise , <nl> - any Contribution intentionally submitted for inclusion in the Work <nl> - by You to the Licensor shall be under the terms and conditions of <nl> - this License , without any additional terms or conditions . <nl> - Notwithstanding the above , nothing herein shall supersede or modify <nl> - the terms of any separate license agreement you may have executed <nl> - with Licensor regarding such Contributions . <nl> - <nl> - 6 . Trademarks . This License does not grant permission to use the trade <nl> - names , trademarks , service marks , or product names of the Licensor , <nl> - except as required for reasonable and customary use in describing the <nl> - origin of the Work and reproducing the content of the NOTICE file . <nl> - <nl> - 7 . Disclaimer of Warranty . Unless required by applicable law or <nl> - agreed to in writing , Licensor provides the Work ( and each <nl> - Contributor provides its Contributions ) on an " AS IS " BASIS , <nl> - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or <nl> - implied , including , without limitation , any warranties or conditions <nl> - of TITLE , NON - INFRINGEMENT , MERCHANTABILITY , or FITNESS FOR A <nl> - PARTICULAR PURPOSE . You are solely responsible for determining the <nl> - appropriateness of using or redistributing the Work and assume any <nl> - risks associated with Your exercise of permissions under this License . <nl> - <nl> - 8 . Limitation of Liability . In no event and under no legal theory , <nl> - whether in tort ( including negligence ) , contract , or otherwise , <nl> - unless required by applicable law ( such as deliberate and grossly <nl> - negligent acts ) or agreed to in writing , shall any Contributor be <nl> - liable to You for damages , including any direct , indirect , special , <nl> - incidental , or consequential damages of any character arising as a <nl> - result of this License or out of the use or inability to use the <nl> - Work ( including but not limited to damages for loss of goodwill , <nl> - work stoppage , computer failure or malfunction , or any and all <nl> - other commercial damages or losses ) , even if such Contributor <nl> - has been advised of the possibility of such damages . <nl> - <nl> - 9 . Accepting Warranty or Additional Liability . While redistributing <nl> - the Work or Derivative Works thereof , You may choose to offer , <nl> - and charge a fee for , acceptance of support , warranty , indemnity , <nl> - or other liability obligations and / or rights consistent with this <nl> - License . However , in accepting such obligations , You may act only <nl> - on Your own behalf and on Your sole responsibility , not on behalf <nl> - of any other Contributor , and only if You agree to indemnify , <nl> - defend , and hold each Contributor harmless for any liability <nl> - incurred by , or claims asserted against , such Contributor by reason <nl> - of your accepting any such warranty or additional liability . <nl> - <nl> - END OF TERMS AND CONDITIONS <nl> - <nl> - APPENDIX : How to apply the Apache License to your work . <nl> - <nl> - To apply the Apache License to your work , attach the following <nl> - boilerplate notice , with the fields enclosed by brackets " [ ] " <nl> - replaced with your own identifying information . ( Don ' t include <nl> - the brackets ! ) The text should be enclosed in the appropriate <nl> - comment syntax for the file format . We also recommend that a <nl> - file or class name and description of purpose be included on the <nl> - same " printed page " as the copyright notice for easier <nl> - identification within third - party archives . <nl> - <nl> - Copyright [ yyyy ] [ name of copyright owner ] <nl> - <nl> - Licensed under the Apache License , Version 2 . 0 ( the " License " ) ; <nl> - you may not use this file except in compliance with the License . <nl> - You may obtain a copy of the License at <nl> - <nl> - http : / / www . apache . org / licenses / LICENSE - 2 . 0 <nl> - <nl> - Unless required by applicable law or agreed to in writing , software <nl> - distributed under the License is distributed on an " AS IS " BASIS , <nl> - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . <nl> - See the License for the specific language governing permissions and <nl> - limitations under the License . <nl> \ No newline at end of file <nl> diff - - git a / pom . xml b / pom . xml <nl> index 33c426c . . 743bb7a 100644 <nl> - - - a / pom . xml <nl> + + + b / pom . xml <nl> @ @ - 181 , 11 + 181 , 6 @ @ <nl> < version > 3 . 1 . 3 < / version > <nl> < / dependency > <nl> < dependency > <nl> - < groupId > org . codehaus . groovy < / groupId > <nl> - < artifactId > groovy < / artifactId > <nl> - < version > 1 . 5 . 6 < / version > <nl> - < / dependency > <nl> - < dependency > <nl> < groupId > com . google . collections < / groupId > <nl> < artifactId > google - collections < / artifactId > <nl> < version > 1 . 0 - rc1 < / version > <nl> diff - - git a / src / java / org / apache / cassandra / config / DatabaseDescriptor . java b / src / java / org / apache / cassandra / config / DatabaseDescriptor . java <nl> index 91e35ef . . 9016676 100644 <nl> - - - a / src / java / org / apache / cassandra / config / DatabaseDescriptor . java <nl> + + + b / src / java / org / apache / cassandra / config / DatabaseDescriptor . java <nl> @ @ - 113 , 8 + 113 , 6 @ @ public class DatabaseDescriptor <nl> * high throughput on reads but at the cost of consistency . <nl> * / <nl> private static boolean doConsistencyCheck _ = true ; <nl> - / * Callout directories * / <nl> - private static String calloutLocation _ ; <nl> / * Job Jar Location * / <nl> private static String jobJarFileLocation _ ; <nl> / * Address where to run the job tracker * / <nl> @ @ - 222 , 9 + 220 , 6 @ @ public class DatabaseDescriptor <nl> throw new ConfigurationException ( " Invalid endpointsnitch class " + endPointSnitchClassName ) ; <nl> } <nl> <nl> - / * Callout location * / <nl> - calloutLocation _ = xmlUtils . getNodeValue ( " / Storage / CalloutLocation " ) ; <nl> - <nl> / * JobTracker address * / <nl> jobTrackerHost _ = xmlUtils . getNodeValue ( " / Storage / JobTrackerHost " ) ; <nl> <nl> @ @ - 673 , 11 + 668 , 6 @ @ public class DatabaseDescriptor <nl> return replicaPlacementStrategyClass _ ; <nl> } <nl> <nl> - public static String getCalloutLocation ( ) <nl> - { <nl> - return calloutLocation _ ; <nl> - } <nl> - <nl> public static String getJobTrackerAddress ( ) <nl> { <nl> return jobTrackerHost _ ; <nl> diff - - git a / src / java / org / apache / cassandra / db / CalloutDeployMessage . java b / src / java / org / apache / cassandra / db / CalloutDeployMessage . java <nl> deleted file mode 100644 <nl> index 8b15492 . . 0000000 <nl> - - - a / src / java / org / apache / cassandra / db / CalloutDeployMessage . java <nl> + + + / dev / null <nl> @ @ - 1 , 89 + 0 , 0 @ @ <nl> - / * * <nl> - * Licensed to the Apache Software Foundation ( ASF ) under one <nl> - * or more contributor license agreements . See the NOTICE file <nl> - * distributed with this work for additional information <nl> - * regarding copyright ownership . The ASF licenses this file <nl> - * to you under the Apache License , Version 2 . 0 ( the <nl> - * " License " ) ; you may not use this file except in compliance <nl> - * with the License . You may obtain a copy of the License at <nl> - * <nl> - * http : / / www . apache . org / licenses / LICENSE - 2 . 0 <nl> - * <nl> - * Unless required by applicable law or agreed to in writing , software <nl> - * distributed under the License is distributed on an " AS IS " BASIS , <nl> - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . <nl> - * See the License for the specific language governing permissions and <nl> - * limitations under the License . <nl> - * / <nl> - package org . apache . cassandra . db ; <nl> - <nl> - import java . io . ByteArrayOutputStream ; <nl> - import java . io . DataInputStream ; <nl> - import java . io . DataOutputStream ; <nl> - import java . io . IOException ; <nl> - <nl> - import org . apache . cassandra . io . ICompactSerializer ; <nl> - import org . apache . cassandra . net . Message ; <nl> - import org . apache . cassandra . service . StorageService ; <nl> - <nl> - <nl> - public class CalloutDeployMessage <nl> - { <nl> - private static ICompactSerializer < CalloutDeployMessage > serializer _ ; <nl> - <nl> - static <nl> - { <nl> - serializer _ = new CalloutDeployMessageSerializer ( ) ; <nl> - } <nl> - <nl> - public static ICompactSerializer < CalloutDeployMessage > serializer ( ) <nl> - { <nl> - return serializer _ ; <nl> - } <nl> - <nl> - public static Message getCalloutDeployMessage ( CalloutDeployMessage cdMessage ) throws IOException <nl> - { <nl> - ByteArrayOutputStream bos = new ByteArrayOutputStream ( ) ; <nl> - DataOutputStream dos = new DataOutputStream ( bos ) ; <nl> - serializer _ . serialize ( cdMessage , dos ) ; <nl> - Message message = new Message ( StorageService . getLocalStorageEndPoint ( ) , " " , StorageService . calloutDeployVerbHandler _ , bos . toByteArray ( ) ) ; <nl> - return message ; <nl> - } <nl> - <nl> - / * Name of the callout * / <nl> - private String callout _ ; <nl> - / * The actual procedure * / <nl> - private String script _ ; <nl> - <nl> - public CalloutDeployMessage ( String callout , String script ) <nl> - { <nl> - callout _ = callout ; <nl> - script _ = script ; <nl> - } <nl> - <nl> - String getCallout ( ) <nl> - { <nl> - return callout _ ; <nl> - } <nl> - <nl> - String getScript ( ) <nl> - { <nl> - return script _ ; <nl> - } <nl> - } <nl> - <nl> - class CalloutDeployMessageSerializer implements ICompactSerializer < CalloutDeployMessage > <nl> - { <nl> - public void serialize ( CalloutDeployMessage cdMessage , DataOutputStream dos ) throws IOException <nl> - { <nl> - dos . writeUTF ( cdMessage . getCallout ( ) ) ; <nl> - dos . writeUTF ( cdMessage . getScript ( ) ) ; <nl> - } <nl> - <nl> - public CalloutDeployMessage deserialize ( DataInputStream dis ) throws IOException <nl> - { <nl> - String callout = dis . readUTF ( ) ; <nl> - String script = dis . readUTF ( ) ; <nl> - return new CalloutDeployMessage ( callout , script ) ; <nl> - } <nl> - } <nl> diff - - git a / src / java / org / apache / cassandra / db / CalloutDeployVerbHandler . java b / src / java / org / apache / cassandra / db / CalloutDeployVerbHandler . java <nl> deleted file mode 100644 <nl> index 3c50b72 . . 0000000 <nl> - - - a / src / java / org / apache / cassandra / db / CalloutDeployVerbHandler . java <nl> + + + / dev / null <nl> @ @ - 1 , 49 + 0 , 0 @ @ <nl> - / * * <nl> - * Licensed to the Apache Software Foundation ( ASF ) under one <nl> - * or more contributor license agreements . See the NOTICE file <nl> - * distributed with this work for additional information <nl> - * regarding copyright ownership . The ASF licenses this file <nl> - * to you under the Apache License , Version 2 . 0 ( the <nl> - * " License " ) ; you may not use this file except in compliance <nl> - * with the License . You may obtain a copy of the License at <nl> - * <nl> - * http : / / www . apache . org / licenses / LICENSE - 2 . 0 <nl> - * <nl> - * Unless required by applicable law or agreed to in writing , software <nl> - * distributed under the License is distributed on an " AS IS " BASIS , <nl> - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . <nl> - * See the License for the specific language governing permissions and <nl> - * limitations under the License . <nl> - * / <nl> - package org . apache . cassandra . db ; <nl> - <nl> - import java . io . IOException ; <nl> - <nl> - import org . apache . cassandra . io . DataInputBuffer ; <nl> - import org . apache . cassandra . net . IVerbHandler ; <nl> - import org . apache . cassandra . net . Message ; <nl> - import org . apache . cassandra . utils . LogUtil ; <nl> - import org . apache . log4j . Logger ; <nl> - <nl> - <nl> - public class CalloutDeployVerbHandler implements IVerbHandler <nl> - { <nl> - private static Logger logger _ = Logger . getLogger ( CalloutDeployVerbHandler . class ) ; <nl> - <nl> - public void doVerb ( Message message ) <nl> - { <nl> - byte [ ] bytes = message . getMessageBody ( ) ; <nl> - DataInputBuffer bufIn = new DataInputBuffer ( ) ; <nl> - bufIn . reset ( bytes , bytes . length ) ; <nl> - try <nl> - { <nl> - CalloutDeployMessage cdMessage = CalloutDeployMessage . serializer ( ) . deserialize ( bufIn ) ; <nl> - / * save the callout to callout cache and to disk . * / <nl> - CalloutManager . instance ( ) . addCallout ( cdMessage . getCallout ( ) , cdMessage . getScript ( ) ) ; <nl> - } <nl> - catch ( IOException ex ) <nl> - { <nl> - logger _ . warn ( LogUtil . throwableToString ( ex ) ) ; <nl> - } <nl> - } <nl> - } <nl> diff - - git a / src / java / org / apache / cassandra / db / CalloutManager . java b / src / java / org / apache / cassandra / db / CalloutManager . java <nl> deleted file mode 100644 <nl> index a7e6a9b . . 0000000 <nl> - - - a / src / java / org / apache / cassandra / db / CalloutManager . java <nl> + + + / dev / null <nl> @ @ - 1 , 211 + 0 , 0 @ @ <nl> - / * * <nl> - * Licensed to the Apache Software Foundation ( ASF ) under one <nl> - * or more contributor license agreements . See the NOTICE file <nl> - * distributed with this work for additional information <nl> - * regarding copyright ownership . The ASF licenses this file <nl> - * to you under the Apache License , Version 2 . 0 ( the <nl> - * " License " ) ; you may not use this file except in compliance <nl> - * with the License . You may obtain a copy of the License at <nl> - * <nl> - * http : / / www . apache . org / licenses / LICENSE - 2 . 0 <nl> - * <nl> - * Unless required by applicable law or agreed to in writing , software <nl> - * distributed under the License is distributed on an " AS IS " BASIS , <nl> - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . <nl> - * See the License for the specific language governing permissions and <nl> - * limitations under the License . <nl> - * / <nl> - package org . apache . cassandra . db ; <nl> - <nl> - import java . io . File ; <nl> - import java . io . FileInputStream ; <nl> - import java . io . FileOutputStream ; <nl> - import java . io . IOException ; <nl> - import java . util . List ; <nl> - import java . util . HashMap ; <nl> - import java . util . Map ; <nl> - import java . util . concurrent . locks . Lock ; <nl> - import java . util . concurrent . locks . ReentrantLock ; <nl> - <nl> - import javax . script . Bindings ; <nl> - import javax . script . Invocable ; <nl> - import javax . script . ScriptEngine ; <nl> - import javax . script . ScriptEngineManager ; <nl> - import javax . script . Compilable ; <nl> - import javax . script . CompiledScript ; <nl> - import javax . script . ScriptException ; <nl> - import javax . script . SimpleBindings ; <nl> - <nl> - import org . apache . cassandra . config . DatabaseDescriptor ; <nl> - import org . apache . cassandra . procedures . GroovyScriptRunner ; <nl> - import org . apache . cassandra . utils . LogUtil ; <nl> - import org . apache . cassandra . utils . FileUtils ; <nl> - <nl> - import org . apache . log4j . Logger ; <nl> - <nl> - public class CalloutManager <nl> - { <nl> - private final static Logger logger _ = Logger . getLogger ( CalloutManager . class ) ; <nl> - private static final String extn _ = " . groovy " ; <nl> - / * Used to lock the factory for creation of CalloutManager instance * / <nl> - private static Lock createLock _ = new ReentrantLock ( ) ; <nl> - / * An instance of the CalloutManager * / <nl> - private static CalloutManager instance _ ; <nl> - <nl> - public static CalloutManager instance ( ) <nl> - { <nl> - if ( instance _ = = null ) <nl> - { <nl> - CalloutManager . createLock _ . lock ( ) ; <nl> - try <nl> - { <nl> - if ( instance _ = = null ) <nl> - { <nl> - instance _ = new CalloutManager ( ) ; <nl> - } <nl> - } <nl> - finally <nl> - { <nl> - CalloutManager . createLock _ . unlock ( ) ; <nl> - } <nl> - } <nl> - return instance _ ; <nl> - } <nl> - <nl> - / * Map containing the name of callout as key and the callout script as value * / <nl> - private Map < String , CompiledScript > calloutCache _ = new HashMap < String , CompiledScript > ( ) ; <nl> - / * The Groovy Script compiler instance * / <nl> - private Compilable compiler _ ; <nl> - / * The Groovy script invokable instance * / <nl> - private Invocable invokable _ ; <nl> - <nl> - private CalloutManager ( ) <nl> - { <nl> - ScriptEngineManager scriptManager = new ScriptEngineManager ( ) ; <nl> - ScriptEngine groovyEngine = scriptManager . getEngineByName ( " groovy " ) ; <nl> - compiler _ = ( Compilable ) groovyEngine ; <nl> - invokable _ = ( Invocable ) groovyEngine ; <nl> - } <nl> - <nl> - / * * <nl> - * Compile the script and cache the compiled script . <nl> - * @ param script to be compiled <nl> - * @ throws ScriptException <nl> - * / <nl> - private void compileAndCache ( String scriptId , String script ) throws ScriptException <nl> - { <nl> - if ( compiler _ ! = null ) <nl> - { <nl> - CompiledScript compiledScript = compiler _ . compile ( script ) ; <nl> - calloutCache _ . put ( scriptId , compiledScript ) ; <nl> - } <nl> - } <nl> - <nl> - / * * <nl> - * Invoked on start up to load all the stored callouts , compile <nl> - * and cache them . <nl> - * <nl> - * @ throws IOException <nl> - * / <nl> - public void onStart ( ) throws IOException <nl> - { <nl> - 	 String location = DatabaseDescriptor . getCalloutLocation ( ) ; <nl> - 	 if ( location = = null ) <nl> - 	 	 return ; <nl> - 	 <nl> - FileUtils . createDirectory ( location ) ; <nl> - <nl> - File [ ] files = new File ( location ) . listFiles ( ) ; <nl> - <nl> - for ( File file : files ) <nl> - { <nl> - String f = file . getName ( ) ; <nl> - / * Get the callout name from the file * / <nl> - String callout = f . split ( extn _ ) [ 0 ] ; <nl> - FileInputStream fis = new FileInputStream ( file ) ; <nl> - byte [ ] bytes = new byte [ fis . available ( ) ] ; <nl> - fis . read ( bytes ) ; <nl> - fis . close ( ) ; <nl> - / * cache the callout after compiling it * / <nl> - try <nl> - { <nl> - compileAndCache ( callout , new String ( bytes ) ) ; <nl> - } <nl> - catch ( ScriptException ex ) <nl> - { <nl> - logger _ . warn ( LogUtil . throwableToString ( ex ) ) ; <nl> - } <nl> - } <nl> - } <nl> - <nl> - / * * <nl> - * Store the callout in cache and write it out <nl> - * to disk . <nl> - * @ param callout the name of the callout <nl> - * @ param script actual implementation of the callout <nl> - * / <nl> - public void addCallout ( String callout , String script ) throws IOException <nl> - { <nl> - / * cache the script * / <nl> - / * cache the callout after compiling it * / <nl> - try <nl> - { <nl> - compileAndCache ( callout , script ) ; <nl> - } <nl> - catch ( ScriptException ex ) <nl> - { <nl> - logger _ . warn ( LogUtil . throwableToString ( ex ) ) ; <nl> - } <nl> - / * save the script to disk * / <nl> - String scriptFile = DatabaseDescriptor . getCalloutLocation ( ) + File . separator + callout + extn _ ; <nl> - File file = new File ( scriptFile ) ; <nl> - if ( file . exists ( ) ) <nl> - { <nl> - if ( logger _ . isDebugEnabled ( ) ) <nl> - logger _ . debug ( " Deleting the old script file . . . " ) ; <nl> - file . delete ( ) ; <nl> - } <nl> - FileOutputStream fos = new FileOutputStream ( scriptFile ) ; <nl> - fos . write ( script . getBytes ( ) ) ; <nl> - fos . close ( ) ; <nl> - } <nl> - <nl> - / * * <nl> - * Remove the registered callout and delete the <nl> - * script on the disk . <nl> - * @ param callout to be removed <nl> - * / <nl> - public void removeCallout ( String callout ) <nl> - { <nl> - / * remove the script from cache * / <nl> - calloutCache _ . remove ( callout ) ; <nl> - String scriptFile = DatabaseDescriptor . getCalloutLocation ( ) + File . separator + callout + " . grv " ; <nl> - File file = new File ( scriptFile ) ; <nl> - file . delete ( ) ; <nl> - } <nl> - <nl> - / * * <nl> - * Execute the specified callout . <nl> - * @ param callout to be executed . <nl> - * @ param args arguments to be passed to the callouts . <nl> - * / <nl> - public Object executeCallout ( String callout , Object . . . args ) <nl> - { <nl> - Object result = null ; <nl> - CompiledScript script = calloutCache _ . get ( callout ) ; <nl> - if ( script ! = null ) <nl> - { <nl> - try <nl> - { <nl> - Bindings binding = new SimpleBindings ( ) ; <nl> - binding . put ( " args " , args ) ; <nl> - result = script . eval ( binding ) ; <nl> - } <nl> - catch ( ScriptException ex ) <nl> - { <nl> - logger _ . warn ( LogUtil . throwableToString ( ex ) ) ; <nl> - } <nl> - } <nl> - return result ; <nl> - } <nl> - } <nl> diff - - git a / src / java / org / apache / cassandra / procedures / GroovyScriptRunner . java b / src / java / org / apache / cassandra / procedures / GroovyScriptRunner . java <nl> index 6df394d . . e69de29 100644 <nl> - - - a / src / java / org / apache / cassandra / procedures / GroovyScriptRunner . java <nl> + + + b / src / java / org / apache / cassandra / procedures / GroovyScriptRunner . java <nl> @ @ - 1 , 31 + 0 , 0 @ @ <nl> - / * <nl> - * Licensed to the Apache Software Foundation ( ASF ) under one <nl> - * or more contributor license agreements . See the NOTICE file <nl> - * distributed with this work for additional information <nl> - * regarding copyright ownership . The ASF licenses this file <nl> - * to you under the Apache License , Version 2 . 0 ( the <nl> - * " License " ) ; you may not use this file except in compliance <nl> - * with the License . You may obtain a copy of the License at <nl> - * <nl> - * http : / / www . apache . org / licenses / LICENSE - 2 . 0 <nl> - * <nl> - * Unless required by applicable law or agreed to in writing , <nl> - * software distributed under the License is distributed on an <nl> - * " AS IS " BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY <nl> - * KIND , either express or implied . See the License for the <nl> - * specific language governing permissions and limitations <nl> - * under the License . <nl> - * / <nl> - package org . apache . cassandra . procedures ; <nl> - <nl> - import groovy . lang . GroovyShell ; <nl> - <nl> - public class GroovyScriptRunner <nl> - { <nl> - 	 private static GroovyShell groovyShell _ = new GroovyShell ( ) ; <nl> - <nl> - 	 public static String evaluateString ( String script ) <nl> - 	 { <nl> - 	 	 return groovyShell _ . evaluate ( script ) . toString ( ) ; <nl> - 	 } <nl> - } <nl> diff - - git a / src / java / org / apache / cassandra / service / CassandraDaemon . java b / src / java / org / apache / cassandra / service / CassandraDaemon . java <nl> index a3111b6 . . 97bc5ac 100644 <nl> - - - a / src / java / org / apache / cassandra / service / CassandraDaemon . java <nl> + + + b / src / java / org / apache / cassandra / service / CassandraDaemon . java <nl> @ @ - 36 , 7 + 36 , 6 @ @ import org . apache . cassandra . config . DatabaseDescriptor ; <nl> import org . apache . cassandra . utils . FBUtilities ; <nl> import org . apache . cassandra . db . Table ; <nl> import org . apache . cassandra . db . RecoveryManager ; <nl> - import org . apache . cassandra . db . CalloutManager ; <nl> <nl> / * * <nl> * This class supports two methods for creating a Cassandra node daemon , <nl> @ @ - 77 , 8 + 76 , 6 @ @ public class CassandraDaemon <nl> } ) ; <nl> <nl> / / initialize stuff <nl> - CalloutManager . instance ( ) . onStart ( ) ; <nl> - <nl> Set < String > tables = DatabaseDescriptor . getTableToColumnFamilyMap ( ) . keySet ( ) ; <nl> for ( String table : tables ) <nl> { <nl> diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java <nl> index 5d6c3ef . . 03b6bba 100644 <nl> - - - a / src / java / org / apache / cassandra / service / StorageService . java <nl> + + + b / src / java / org / apache / cassandra / service / StorageService . java <nl> @ @ - 76 , 7 + 76 , 6 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto <nl> public final static String dataFileVerbHandler _ = " DATA - FILE - VERB - HANDLER " ; <nl> public final static String mbrshipCleanerVerbHandler _ = " MBRSHIP - CLEANER - VERB - HANDLER " ; <nl> public final static String bsMetadataVerbHandler _ = " BS - METADATA - VERB - HANDLER " ; <nl> - public final static String calloutDeployVerbHandler _ = " CALLOUT - DEPLOY - VERB - HANDLER " ; <nl> public final static String rangeVerbHandler _ = " RANGE - VERB - HANDLER " ; <nl> <nl> public static enum ConsistencyLevel <nl> @ @ - 252 , 7 + 251 , 6 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto <nl> MessagingService . getMessagingInstance ( ) . registerVerbHandlers ( StorageService . dataFileVerbHandler _ , new DataFileVerbHandler ( ) ) ; <nl> MessagingService . getMessagingInstance ( ) . registerVerbHandlers ( StorageService . mbrshipCleanerVerbHandler _ , new MembershipCleanerVerbHandler ( ) ) ; <nl> MessagingService . getMessagingInstance ( ) . registerVerbHandlers ( StorageService . bsMetadataVerbHandler _ , new BootstrapMetadataVerbHandler ( ) ) ; <nl> - MessagingService . getMessagingInstance ( ) . registerVerbHandlers ( StorageService . calloutDeployVerbHandler _ , new CalloutDeployVerbHandler ( ) ) ; <nl> MessagingService . getMessagingInstance ( ) . registerVerbHandlers ( StorageService . rangeVerbHandler _ , new RangeVerbHandler ( ) ) ; <nl> <nl> / * register the stage for the mutations * / <nl> diff - - git a / test / conf / storage - conf . xml b / test / conf / storage - conf . xml <nl> index e0ac28f . . 20f3377 100644 <nl> - - - a / test / conf / storage - conf . xml <nl> + + + b / test / conf / storage - conf . xml <nl> @ @ - 37 , 7 + 37 , 6 @ @ <nl> < DataFileDirectories > <nl> < DataFileDirectory > build / test / cassandra / data < / DataFileDirectory > <nl> < / DataFileDirectories > <nl> - < CalloutLocation > build / test / cassandra / callouts < / CalloutLocation > <nl> < BootstrapFileDirectory > build / test / cassandra / bootstrap < / BootstrapFileDirectory > <nl> < StagingFileDirectory > build / test / cassandra / staging < / StagingFileDirectory > <nl> < MemtableSizeInMB > 1 < / MemtableSizeInMB >

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index e008ab9 . . 96da1bd 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 2 . 1 . 3 
 + * Fix high size calculations for prepared statements ( CASSANDRA - 8231 ) 
 * Centralize shared executors ( CASSANDRA - 8055 ) 
 * Fix filtering for CONTAINS ( KEY ) relations on frozen collection 
 clustering columns when the query is restricted to a single 
 diff - - git a / bin / cassandra . bat b / bin / cassandra . bat 
 index 5169c44 . . 99b291a 100644 
 - - - a / bin / cassandra . bat 
 + + + b / bin / cassandra . bat 
 @ @ - 54 , 7 + 54 , 7 @ @ if NOT DEFINED JAVA _ HOME goto : err 
 REM - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - - 
 REM JVM Opts we ' ll use in legacy run or installation 
 set JAVA _ OPTS = - ea ^ 
 - - javaagent : " % CASSANDRA _ HOME % \ lib \ jamm - 0 . 2 . 8 . jar " ^ 
 + - javaagent : " % CASSANDRA _ HOME % \ lib \ jamm - 0 . 3 . 0 . jar " ^ 
 - Xms2G ^ 
 - Xmx2G ^ 
 - XX : + HeapDumpOnOutOfMemoryError ^ 
 diff - - git a / bin / cassandra . in . sh b / bin / cassandra . in . sh 
 index 5b4ee0f . . b6a53f3 100644 
 - - - a / bin / cassandra . in . sh 
 + + + b / bin / cassandra . in . sh 
 @ @ - 48 , 5 + 48 , 5 @ @ done 
 if [ " $ JVM _ VENDOR " ! = " OpenJDK " - o " $ JVM _ VERSION " \ > " 1 . 6 . 0 " ] \ 
 | | [ " $ JVM _ VERSION " = " 1 . 6 . 0 " - a " $ JVM _ PATCH _ VERSION " - ge 23 ] 
 then 
 - JAVA _ AGENT = " $ JAVA _ AGENT - javaagent : $ CASSANDRA _ HOME / lib / jamm - 0 . 2 . 8 . jar " 
 + JAVA _ AGENT = " $ JAVA _ AGENT - javaagent : $ CASSANDRA _ HOME / lib / jamm - 0 . 3 . 0 . jar " 
 fi 
 diff - - git a / build . xml b / build . xml 
 index 43fa531 . . 2e5d0ac 100644 
 - - - a / build . xml 
 + + + b / build . xml 
 @ @ - 369 , 7 + 369 , 7 @ @ 
 < / dependency > 
 < dependency groupId = " com . googlecode . json - simple " artifactId = " json - simple " version = " 1 . 1 " / > 
 < dependency groupId = " com . boundary " artifactId = " high - scale - lib " version = " 1 . 0 . 6 " / > 
 - < dependency groupId = " com . github . jbellis " artifactId = " jamm " version = " 0 . 2 . 8 " / > 
 + < dependency groupId = " com . github . jbellis " artifactId = " jamm " version = " 0 . 3 . 0 " / > 
 < dependency groupId = " com . thinkaurelius . thrift " artifactId = " thrift - server " version = " 0 . 3 . 7 " > 
 	 	 < exclusion groupId = " org . slf4j " artifactId = " slf4j - log4j12 " / > 
 < / dependency > 
 @ @ - 688 , 7 + 688 , 7 @ @ 
 < pathelement location = " $ { test . conf } " / > 
 < / classpath > 
 < jvmarg value = " - Dstorage - config = $ { test . conf } " / > 
 - < jvmarg value = " - javaagent : $ { basedir } / lib / jamm - 0 . 2 . 8 . jar " / > 
 + < jvmarg value = " - javaagent : $ { basedir } / lib / jamm - 0 . 3 . 0 . jar " / > 
 < jvmarg value = " - ea " / > 
 < / java > 
 < / target > 
 @ @ - 1107 , 7 + 1107 , 7 @ @ 
 < formatter type = " brief " usefile = " false " / > 
 < jvmarg value = " - Dstorage - config = $ { test . conf } " / > 
 < jvmarg value = " - Djava . awt . headless = true " / > 
 - < jvmarg value = " - javaagent : $ { basedir } / lib / jamm - 0 . 2 . 8 . jar " / > 
 + < jvmarg value = " - javaagent : $ { basedir } / lib / jamm - 0 . 3 . 0 . jar " / > 
 < jvmarg value = " - ea " / > 
 < jvmarg value = " - Xss256k " / > 
 < jvmarg value = " - Dcassandra . memtable _ row _ overhead _ computation _ step = 100 " / > 
 @ @ - 1266 , 7 + 1266 , 7 @ @ 
 < formatter type = " brief " usefile = " false " / > 
 < jvmarg value = " - Dstorage - config = $ { test . conf } " / > 
 < jvmarg value = " - Djava . awt . headless = true " / > 
 - < jvmarg value = " - javaagent : $ { basedir } / lib / jamm - 0 . 2 . 8 . jar " / > 
 + < jvmarg value = " - javaagent : $ { basedir } / lib / jamm - 0 . 3 . 0 . jar " / > 
 < jvmarg value = " - ea " / > 
 < jvmarg value = " - Xss256k " / > 
 < jvmarg value = " - Dcassandra . memtable _ row _ overhead _ computation _ step = 100 " / > 
 @ @ - 1309 , 7 + 1309 , 7 @ @ 
 < formatter type = " brief " usefile = " false " / > 
 < jvmarg value = " - Dstorage - config = $ { test . conf } " / > 
 < jvmarg value = " - Djava . awt . headless = true " / > 
 - < jvmarg value = " - javaagent : $ { basedir } / lib / jamm - 0 . 2 . 8 . jar " / > 
 + < jvmarg value = " - javaagent : $ { basedir } / lib / jamm - 0 . 3 . 0 . jar " / > 
 < jvmarg value = " - ea " / > 
 < jvmarg value = " - Xss256k " / > 
 < jvmarg value = " - Dcassandra . test . use _ prepared = $ { cassandra . test . use _ prepared } " / > 
 diff - - git a / conf / cassandra - env . ps1 b / conf / cassandra - env . ps1 
 index 0595cf6 . . 5450ac8 100644 
 - - - a / conf / cassandra - env . ps1 
 + + + b / conf / cassandra - env . ps1 
 @ @ - 301 , 7 + 301 , 7 @ @ Function SetCassandraEnvironment 
 if ( ( $ env : JVM _ VENDOR - ne " OpenJDK " ) - or ( $ env : JVM _ VERSION . CompareTo ( " 1 . 6 . 0 " ) - eq 1 ) - or 
 ( ( $ env : JVM _ VERSION - eq " 1 . 6 . 0 " ) - and ( $ env : JVM _ PATCH _ VERSION . CompareTo ( " 22 " ) - eq 1 ) ) ) 
 { 
 - $ env : JVM _ OPTS = " $ env : JVM _ OPTS - javaagent : " " $ env : CASSANDRA _ HOME \ lib \ jamm - 0 . 2 . 8 . jar " " " 
 + $ env : JVM _ OPTS = " $ env : JVM _ OPTS - javaagent : " " $ env : CASSANDRA _ HOME \ lib \ jamm - 0 . 3 . 0 . jar " " " 
 } 
 
 # enable assertions . disabling this in production will give a modest 
 diff - - git a / conf / cassandra - env . sh b / conf / cassandra - env . sh 
 index f5669bb . . 191fb7e 100644 
 - - - a / conf / cassandra - env . sh 
 + + + b / conf / cassandra - env . sh 
 @ @ - 173 , 7 + 173 , 7 @ @ JMX _ PORT = " 7199 " 
 JVM _ OPTS = " $ JVM _ OPTS - ea " 
 
 # add the jamm javaagent 
 - JVM _ OPTS = " $ JVM _ OPTS - javaagent : $ CASSANDRA _ HOME / lib / jamm - 0 . 2 . 8 . jar " 
 + JVM _ OPTS = " $ JVM _ OPTS - javaagent : $ CASSANDRA _ HOME / lib / jamm - 0 . 3 . 0 . jar " 
 
 # some JVMs will fill up their heap when accessed via JMX , see CASSANDRA - 6541 
 JVM _ OPTS = " $ JVM _ OPTS - XX : + CMSClassUnloadingEnabled " 
 diff - - git a / debian / cassandra . in . sh b / debian / cassandra . in . sh 
 index bf76cf7 . . 9f69ac9 100644 
 - - - a / debian / cassandra . in . sh 
 + + + b / debian / cassandra . in . sh 
 @ @ - 26 , 5 + 26 , 5 @ @ CLASSPATH = " $ CLASSPATH : $ EXTRA _ CLASSPATH " 
 if [ " $ JVM _ VENDOR " ! = " OpenJDK " - o " $ JVM _ VERSION " \ > " 1 . 6 . 0 " ] \ 
 | | [ " $ JVM _ VERSION " = " 1 . 6 . 0 " - a " $ JVM _ PATCH _ VERSION " - ge 23 ] 
 then 
 - JAVA _ AGENT = " $ JAVA _ AGENT - javaagent : $ CASSANDRA _ HOME / lib / jamm - 0 . 2 . 8 . jar " 
 + JAVA _ AGENT = " $ JAVA _ AGENT - javaagent : $ CASSANDRA _ HOME / lib / jamm - 0 . 3 . 0 . jar " 
 fi 
 diff - - git a / lib / jamm - 0 . 2 . 8 . jar b / lib / jamm - 0 . 2 . 8 . jar 
 deleted file mode 100644 
 index e1cb669 . . 0000000 
 Binary files a / lib / jamm - 0 . 2 . 8 . jar and / dev / null differ 
 diff - - git a / lib / licenses / jamm - 0 . 2 . 8 . txt b / lib / licenses / jamm - 0 . 2 . 8 . txt 
 deleted file mode 100644 
 index d645695 . . 0000000 
 - - - a / lib / licenses / jamm - 0 . 2 . 8 . txt 
 + + + / dev / null 
 @ @ - 1 , 202 + 0 , 0 @ @ 
 - 
 - Apache License 
 - Version 2 . 0 , January 2004 
 - http : / / www . apache . org / licenses / 
 - 
 - TERMS AND CONDITIONS FOR USE , REPRODUCTION , AND DISTRIBUTION 
 - 
 - 1 . Definitions . 
 - 
 - " License " shall mean the terms and conditions for use , reproduction , 
 - and distribution as defined by Sections 1 through 9 of this document . 
 - 
 - " Licensor " shall mean the copyright owner or entity authorized by 
 - the copyright owner that is granting the License . 
 - 
 - " Legal Entity " shall mean the union of the acting entity and all 
 - other entities that control , are controlled by , or are under common 
 - control with that entity . For the purposes of this definition , 
 - " control " means ( i ) the power , direct or indirect , to cause the 
 - direction or management of such entity , whether by contract or 
 - otherwise , or ( ii ) ownership of fifty percent ( 50 % ) or more of the 
 - outstanding shares , or ( iii ) beneficial ownership of such entity . 
 - 
 - " You " ( or " Your " ) shall mean an individual or Legal Entity 
 - exercising permissions granted by this License . 
 - 
 - " Source " form shall mean the preferred form for making modifications , 
 - including but not limited to software source code , documentation 
 - source , and configuration files . 
 - 
 - " Object " form shall mean any form resulting from mechanical 
 - transformation or translation of a Source form , including but 
 - not limited to compiled object code , generated documentation , 
 - and conversions to other media types . 
 - 
 - " Work " shall mean the work of authorship , whether in Source or 
 - Object form , made available under the License , as indicated by a 
 - copyright notice that is included in or attached to the work 
 - ( an example is provided in the Appendix below ) . 
 - 
 - " Derivative Works " shall mean any work , whether in Source or Object 
 - form , that is based on ( or derived from ) the Work and for which the 
 - editorial revisions , annotations , elaborations , or other modifications 
 - represent , as a whole , an original work of authorship . For the purposes 
 - of this License , Derivative Works shall not include works that remain 
 - separable from , or merely link ( or bind by name ) to the interfaces of , 
 - the Work and Derivative Works thereof . 
 - 
 - " Contribution " shall mean any work of authorship , including 
 - the original version of the Work and any modifications or additions 
 - to that Work or Derivative Works thereof , that is intentionally 
 - submitted to Licensor for inclusion in the Work by the copyright owner 
 - or by an individual or Legal Entity authorized to submit on behalf of 
 - the copyright owner . For the purposes of this definition , " submitted " 
 - means any form of electronic , verbal , or written communication sent 
 - to the Licensor or its representatives , including but not limited to 
 - communication on electronic mailing lists , source code control systems , 
 - and issue tracking systems that are managed by , or on behalf of , the 
 - Licensor for the purpose of discussing and improving the Work , but 
 - excluding communication that is conspicuously marked or otherwise 
 - designated in writing by the copyright owner as " Not a Contribution . " 
 - 
 - " Contributor " shall mean Licensor and any individual or Legal Entity 
 - on behalf of whom a Contribution has been received by Licensor and 
 - subsequently incorporated within the Work . 
 - 
 - 2 . Grant of Copyright License . Subject to the terms and conditions of 
 - this License , each Contributor hereby grants to You a perpetual , 
 - worldwide , non - exclusive , no - charge , royalty - free , irrevocable 
 - copyright license to reproduce , prepare Derivative Works of , 
 - publicly display , publicly perform , sublicense , and distribute the 
 - Work and such Derivative Works in Source or Object form . 
 - 
 - 3 . Grant of Patent License . Subject to the terms and conditions of 
 - this License , each Contributor hereby grants to You a perpetual , 
 - worldwide , non - exclusive , no - charge , royalty - free , irrevocable 
 - ( except as stated in this section ) patent license to make , have made , 
 - use , offer to sell , sell , import , and otherwise transfer the Work , 
 - where such license applies only to those patent claims licensable 
 - by such Contributor that are necessarily infringed by their 
 - Contribution ( s ) alone or by combination of their Contribution ( s ) 
 - with the Work to which such Contribution ( s ) was submitted . If You 
 - institute patent litigation against any entity ( including a 
 - cross - claim or counterclaim in a lawsuit ) alleging that the Work 
 - or a Contribution incorporated within the Work constitutes direct 
 - or contributory patent infringement , then any patent licenses 
 - granted to You under this License for that Work shall terminate 
 - as of the date such litigation is filed . 
 - 
 - 4 . Redistribution . You may reproduce and distribute copies of the 
 - Work or Derivative Works thereof in any medium , with or without 
 - modifications , and in Source or Object form , provided that You 
 - meet the following conditions : 
 - 
 - ( a ) You must give any other recipients of the Work or 
 - Derivative Works a copy of this License ; and 
 - 
 - ( b ) You must cause any modified files to carry prominent notices 
 - stating that You changed the files ; and 
 - 
 - ( c ) You must retain , in the Source form of any Derivative Works 
 - that You distribute , all copyright , patent , trademark , and 
 - attribution notices from the Source form of the Work , 
 - excluding those notices that do not pertain to any part of 
 - the Derivative Works ; and 
 - 
 - ( d ) If the Work includes a " NOTICE " text file as part of its 
 - distribution , then any Derivative Works that You distribute must 
 - include a readable copy of the attribution notices contained 
 - within such NOTICE file , excluding those notices that do not 
 - pertain to any part of the Derivative Works , in at least one 
 - of the following places : within a NOTICE text file distributed 
 - as part of the Derivative Works ; within the Source form or 
 - documentation , if provided along with the Derivative Works ; or , 
 - within a display generated by the Derivative Works , if and 
 - wherever such third - party notices normally appear . The contents 
 - of the NOTICE file are for informational purposes only and 
 - do not modify the License . You may add Your own attribution 
 - notices within Derivative Works that You distribute , alongside 
 - or as an addendum to the NOTICE text from the Work , provided 
 - that such additional attribution notices cannot be construed 
 - as modifying the License . 
 - 
 - You may add Your own copyright statement to Your modifications and 
 - may provide additional or different license terms and conditions 
 - for use , reproduction , or distribution of Your modifications , or 
 - for any such Derivative Works as a whole , provided Your use , 
 - reproduction , and distribution of the Work otherwise complies with 
 - the conditions stated in this License . 
 - 
 - 5 . Submission of Contributions . Unless You explicitly state otherwise , 
 - any Contribution intentionally submitted for inclusion in the Work 
 - by You to the Licensor shall be under the terms and conditions of 
 - this License , without any additional terms or conditions . 
 - Notwithstanding the above , nothing herein shall supersede or modify 
 - the terms of any separate license agreement you may have executed 
 - with Licensor regarding such Contributions . 
 - 
 - 6 . Trademarks . This License does not grant permission to use the trade 
 - names , trademarks , service marks , or product names of the Licensor , 
 - except as required for reasonable and customary use in describing the 
 - origin of the Work and reproducing the content of the NOTICE file . 
 - 
 - 7 . Disclaimer of Warranty . Unless required by applicable law or 
 - agreed to in writing , Licensor provides the Work ( and each 
 - Contributor provides its Contributions ) on an " AS IS " BASIS , 
 - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or 
 - implied , including , without limitation , any warranties or conditions 
 - of TITLE , NON - INFRINGEMENT , MERCHANTABILITY , or FITNESS FOR A 
 - PARTICULAR PURPOSE . You are solely responsible for determining the 
 - appropriateness of using or redistributing the Work and assume any 
 - risks associated with Your exercise of permissions under this License . 
 - 
 - 8 . Limitation of Liability . In no event and under no legal theory , 
 - whether in tort ( including negligence ) , contract , or otherwise , 
 - unless required by applicable law ( such as deliberate and grossly 
 - negligent acts ) or agreed to in writing , shall any Contributor be 
 - liable to You for damages , including any direct , indirect , special , 
 - incidental , or consequential damages of any character arising as a 
 - result of this License or out of the use or inability to use the 
 - Work ( including but not limited to damages for loss of goodwill , 
 - work stoppage , computer failure or malfunction , or any and all 
 - other commercial damages or losses ) , even if such Contributor 
 - has been advised of the possibility of such damages . 
 - 
 - 9 . Accepting Warranty or Additional Liability . While redistributing 
 - the Work or Derivative Works thereof , You may choose to offer , 
 - and charge a fee for , acceptance of support , warranty , indemnity , 
 - or other liability obligations and / or rights consistent with this 
 - License . However , in accepting such obligations , You may act only 
 - on Your own behalf and on Your sole responsibility , not on behalf 
 - of any other Contributor , and only if You agree to indemnify , 
 - defend , and hold each Contributor harmless for any liability 
 - incurred by , or claims asserted against , such Contributor by reason 
 - of your accepting any such warranty or additional liability . 
 - 
 - END OF TERMS AND CONDITIONS 
 - 
 - APPENDIX : How to apply the Apache License to your work . 
 - 
 - To apply the Apache License to your work , attach the following 
 - boilerplate notice , with the fields enclosed by brackets " [ ] " 
 - replaced with your own identifying information . ( Don ' t include 
 - the brackets ! ) The text should be enclosed in the appropriate 
 - comment syntax for the file format . We also recommend that a 
 - file or class name and description of purpose be included on the 
 - same " printed page " as the copyright notice for easier 
 - identification within third - party archives . 
 - 
 - Copyright [ yyyy ] [ name of copyright owner ] 
 - 
 - Licensed under the Apache License , Version 2 . 0 ( the " License " ) ; 
 - you may not use this file except in compliance with the License . 
 - You may obtain a copy of the License at 
 - 
 - http : / / www . apache . org / licenses / LICENSE - 2 . 0 
 - 
 - Unless required by applicable law or agreed to in writing , software 
 - distributed under the License is distributed on an " AS IS " BASIS , 
 - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . 
 - See the License for the specific language governing permissions and 
 - limitations under the License . 
 diff - - git a / src / java / org / apache / cassandra / config / CFMetaData . java b / src / java / org / apache / cassandra / config / CFMetaData . java 
 index 57f5757 . . 74bd5f8 100644 
 - - - a / src / java / org / apache / cassandra / config / CFMetaData . java 
 + + + b / src / java / org / apache / cassandra / config / CFMetaData . java 
 @ @ - 57 , 6 + 57 , 7 @ @ import org . apache . cassandra . tracing . Tracing ; 
 import org . apache . cassandra . utils . ByteBufferUtil ; 
 import org . apache . cassandra . utils . FBUtilities ; 
 import org . apache . cassandra . utils . UUIDGen ; 
 + import org . github . jamm . Unmetered ; 
 
 import static org . apache . cassandra . utils . FBUtilities . fromJsonList ; 
 import static org . apache . cassandra . utils . FBUtilities . fromJsonMap ; 
 @ @ - 65 , 6 + 66 , 7 @ @ import static org . apache . cassandra . utils . FBUtilities . json ; 
 / * * 
 * This class can be tricky to modify . Please read http : / / wiki . apache . org / cassandra / ConfigurationNotes for how to do so safely . 
 * / 
 + @ Unmetered 
 public final class CFMetaData 
 { 
 private static final Logger logger = LoggerFactory . getLogger ( CFMetaData . class ) ; 
 diff - - git a / src / java / org / apache / cassandra / cql3 / MeasurableForPreparedCache . java b / src / java / org / apache / cassandra / cql3 / MeasurableForPreparedCache . java 
 deleted file mode 100644 
 index 6b3b4b5 . . 0000000 
 - - - a / src / java / org / apache / cassandra / cql3 / MeasurableForPreparedCache . java 
 + + + / dev / null 
 @ @ - 1 , 26 + 0 , 0 @ @ 
 - / * 
 - * Licensed to the Apache Software Foundation ( ASF ) under one 
 - * or more contributor license agreements . See the NOTICE file 
 - * distributed with this work for additional information 
 - * regarding copyright ownership . The ASF licenses this file 
 - * to you under the Apache License , Version 2 . 0 ( the 
 - * " License " ) ; you may not use this file except in compliance 
 - * with the License . You may obtain a copy of the License at 
 - * 
 - * http : / / www . apache . org / licenses / LICENSE - 2 . 0 
 - * 
 - * Unless required by applicable law or agreed to in writing , 
 - * software distributed under the License is distributed on an 
 - * " AS IS " BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY 
 - * KIND , either express or implied . See the License for the 
 - * specific language governing permissions and limitations 
 - * under the License . 
 - * / 
 - package org . apache . cassandra . cql3 ; 
 - 
 - import org . github . jamm . MemoryMeter ; 
 - 
 - public interface MeasurableForPreparedCache 
 - { 
 - public long measureForPreparedCache ( MemoryMeter meter ) ; 
 - } 
 diff - - git a / src / java / org / apache / cassandra / cql3 / QueryProcessor . java b / src / java / org / apache / cassandra / cql3 / QueryProcessor . java 
 index 45ef39c . . 8e829e8 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / QueryProcessor . java 
 + + + b / src / java / org / apache / cassandra / cql3 / QueryProcessor . java 
 @ @ - 18 , 28 + 18 , 40 @ @ 
 package org . apache . cassandra . cql3 ; 
 
 import java . nio . ByteBuffer ; 
 - import java . util . * ; 
 + import java . util . ArrayList ; 
 + import java . util . Collections ; 
 + import java . util . Iterator ; 
 + import java . util . List ; 
 import java . util . concurrent . * ; 
 import java . util . concurrent . atomic . AtomicInteger ; 
 
 import com . google . common . primitives . Ints ; 
 
 + import org . slf4j . Logger ; 
 + import org . slf4j . LoggerFactory ; 
 + 
 import com . googlecode . concurrentlinkedhashmap . ConcurrentLinkedHashMap ; 
 import com . googlecode . concurrentlinkedhashmap . EntryWeigher ; 
 import com . googlecode . concurrentlinkedhashmap . EvictionListener ; 
 - import org . antlr . runtime . * ; 
 - import org . github . jamm . MemoryMeter ; 
 - import org . slf4j . Logger ; 
 - import org . slf4j . LoggerFactory ; 
 
 import org . apache . cassandra . concurrent . ScheduledExecutors ; 
 + import org . antlr . runtime . * ; 
 import org . apache . cassandra . cql3 . statements . * ; 
 import org . apache . cassandra . db . * ; 
 - import org . apache . cassandra . db . composites . * ; 
 + import org . apache . cassandra . db . composites . CType ; 
 + import org . apache . cassandra . db . composites . CellName ; 
 + import org . apache . cassandra . db . composites . CellNameType ; 
 + import org . apache . cassandra . db . composites . Composite ; 
 import org . apache . cassandra . db . marshal . AbstractType ; 
 - import org . apache . cassandra . exceptions . * ; 
 + import org . apache . cassandra . exceptions . InvalidRequestException ; 
 + import org . apache . cassandra . exceptions . RequestExecutionException ; 
 + import org . apache . cassandra . exceptions . RequestValidationException ; 
 + import org . apache . cassandra . exceptions . SyntaxException ; 
 import org . apache . cassandra . metrics . CQLMetrics ; 
 - import org . apache . cassandra . service . * ; 
 + import org . apache . cassandra . service . ClientState ; 
 + import org . apache . cassandra . service . IMigrationListener ; 
 + import org . apache . cassandra . service . MigrationManager ; 
 + import org . apache . cassandra . service . QueryState ; 
 import org . apache . cassandra . service . pager . QueryPager ; 
 import org . apache . cassandra . service . pager . QueryPagers ; 
 import org . apache . cassandra . thrift . ThriftClientState ; 
 @ @ - 48 , 6 + 60 , 7 @ @ import org . apache . cassandra . transport . messages . ResultMessage ; 
 import org . apache . cassandra . utils . FBUtilities ; 
 import org . apache . cassandra . utils . MD5Digest ; 
 import org . apache . cassandra . utils . SemanticVersion ; 
 + import org . github . jamm . MemoryMeter ; 
 
 public class QueryProcessor implements QueryHandler 
 { 
 @ @ - 542 , 9 + 555 , 7 @ @ public class QueryProcessor implements QueryHandler 
 
 private static long measure ( Object key ) 
 { 
 - return key instanceof MeasurableForPreparedCache 
 - ? ( ( MeasurableForPreparedCache ) key ) . measureForPreparedCache ( meter ) 
 - : meter . measureDeep ( key ) ; 
 + return meter . measureDeep ( key ) ; 
 } 
 
 private static class MigrationSubscriber implements IMigrationListener 
 diff - - git a / src / java / org / apache / cassandra / cql3 / functions / Function . java b / src / java / org / apache / cassandra / cql3 / functions / Function . java 
 index ba5ae20 . . b278389 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / functions / Function . java 
 + + + b / src / java / org / apache / cassandra / cql3 / functions / Function . java 
 @ @ - 22 , 7 + 22 , 9 @ @ import java . util . List ; 
 
 import org . apache . cassandra . db . marshal . AbstractType ; 
 import org . apache . cassandra . exceptions . InvalidRequestException ; 
 + import org . github . jamm . Unmetered ; 
 
 + @ Unmetered 
 public interface Function 
 { 
 public String name ( ) ; 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / BatchStatement . java b / src / java / org / apache / cassandra / cql3 / statements / BatchStatement . java 
 index d54e4fd . . c93bf64 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / BatchStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / BatchStatement . java 
 @ @ - 23 , 7 + 23 , 6 @ @ import java . util . * ; 
 import com . google . common . base . Function ; 
 import com . google . common . collect . * ; 
 import org . apache . cassandra . config . DatabaseDescriptor ; 
 - import org . github . jamm . MemoryMeter ; 
 import org . slf4j . Logger ; 
 import org . slf4j . LoggerFactory ; 
 
 @ @ - 41 , 7 + 40 , 7 @ @ import org . apache . cassandra . transport . messages . ResultMessage ; 
 * A < code > BATCH < / code > statement parsed from a CQL query . 
 * 
 * / 
 - public class BatchStatement implements CQLStatement , MeasurableForPreparedCache 
 + public class BatchStatement implements CQLStatement 
 { 
 public static enum Type 
 { 
 @ @ - 76 , 17 + 75 , 6 @ @ public class BatchStatement implements CQLStatement , MeasurableForPreparedCache 
 this . hasConditions = hasConditions ; 
 } 
 
 - public long measureForPreparedCache ( MemoryMeter meter ) 
 - { 
 - long size = meter . measure ( this ) 
 - + meter . measureDeep ( type ) 
 - + meter . measure ( statements ) 
 - + meter . measureDeep ( attrs ) ; 
 - for ( ModificationStatement stmt : statements ) 
 - size + = stmt . measureForPreparedCache ( meter ) ; 
 - return size ; 
 - } 
 - 
 public int getBoundTerms ( ) 
 { 
 return boundTerms ; 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / ModificationStatement . java b / src / java / org / apache / cassandra / cql3 / statements / ModificationStatement . java 
 index c32430a . . 60558b4 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / ModificationStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / ModificationStatement . java 
 @ @ - 22 , 8 + 22 , 6 @ @ import java . util . * ; 
 
 import com . google . common . base . Function ; 
 import com . google . common . collect . Iterables ; 
 - import org . apache . cassandra . db . marshal . AbstractType ; 
 - import org . github . jamm . MemoryMeter ; 
 
 import org . apache . cassandra . auth . Permission ; 
 import org . apache . cassandra . config . CFMetaData ; 
 @ @ - 46 , 7 + 44 , 7 @ @ import org . apache . cassandra . utils . Pair ; 
 / * 
 * Abstract parent class of individual modifications , i . e . INSERT , UPDATE and DELETE . 
 * / 
 - public abstract class ModificationStatement implements CQLStatement , MeasurableForPreparedCache 
 + public abstract class ModificationStatement implements CQLStatement 
 { 
 private static final ColumnIdentifier CAS _ RESULT _ COLUMN = new ColumnIdentifier ( " [ applied ] " , false ) ; 
 
 @ @ - 87 , 16 + 85 , 6 @ @ public abstract class ModificationStatement implements CQLStatement , MeasurableF 
 this . attrs = attrs ; 
 } 
 
 - public long measureForPreparedCache ( MemoryMeter meter ) 
 - { 
 - return meter . measure ( this ) 
 - + meter . measureDeep ( attrs ) 
 - + meter . measureDeep ( processedKeys ) 
 - + meter . measureDeep ( columnOperations ) 
 - + ( columnConditions = = null ? 0 : meter . measureDeep ( columnConditions ) ) 
 - + ( staticConditions = = null ? 0 : meter . measureDeep ( staticConditions ) ) ; 
 - } 
 - 
 public abstract boolean requireFullClusteringKey ( ) ; 
 public abstract void addUpdateForKey ( ColumnFamily updates , ByteBuffer key , Composite prefix , UpdateParameters params ) throws InvalidRequestException ; 
 
 diff - - git a / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java b / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java 
 index de3d67c . . 6d7bdbb 100644 
 - - - a / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java 
 + + + b / src / java / org / apache / cassandra / cql3 / statements / SelectStatement . java 
 @ @ - 27 , 8 + 27 , 6 @ @ import com . google . common . collect . AbstractIterator ; 
 import com . google . common . collect . Iterables ; 
 import com . google . common . collect . Iterators ; 
 
 - import org . github . jamm . MemoryMeter ; 
 - 
 import org . apache . cassandra . auth . Permission ; 
 import org . apache . cassandra . cql3 . * ; 
 import org . apache . cassandra . cql3 . statements . SingleColumnRestriction . Contains ; 
 @ @ - 61 , 7 + 59 , 7 @ @ import org . slf4j . LoggerFactory ; 
 * column family , expression , result count , and ordering clause . 
 * 
 * / 
 - public class SelectStatement implements CQLStatement , MeasurableForPreparedCache 
 + public class SelectStatement implements CQLStatement 
 { 
 private static final Logger logger = LoggerFactory . getLogger ( SelectStatement . class ) ; 
 
 @ @ - 162 , 20 + 160 , 6 @ @ public class SelectStatement implements CQLStatement , MeasurableForPreparedCache 
 : selection . getResultMetadata ( ) ; 
 } 
 
 - public long measureForPreparedCache ( MemoryMeter meter ) 
 - { 
 - return meter . measure ( this ) 
 - + meter . measureDeep ( parameters ) 
 - + meter . measureDeep ( selection ) 
 - + ( limit = = null ? 0 : meter . measureDeep ( limit ) ) 
 - + meter . measureDeep ( keyRestrictions ) 
 - + meter . measureDeep ( columnRestrictions ) 
 - + meter . measureDeep ( metadataRestrictions ) 
 - + meter . measureDeep ( restrictedColumns ) 
 - + ( sliceRestriction = = null ? 0 : meter . measureDeep ( sliceRestriction ) ) 
 - + ( orderingIndexes = = null ? 0 : meter . measureDeep ( orderingIndexes ) ) ; 
 - } 
 - 
 public int getBoundTerms ( ) 
 { 
 return boundTerms ; 
 diff - - git a / src / java / org / apache / cassandra / db / marshal / AbstractType . java b / src / java / org / apache / cassandra / db / marshal / AbstractType . java 
 index 8dd2ff3 . . 863cd47 100644 
 - - - a / src / java / org / apache / cassandra / db / marshal / AbstractType . java 
 + + + b / src / java / org / apache / cassandra / db / marshal / AbstractType . java 
 @ @ - 28 , 6 + 28 , 7 @ @ import org . apache . cassandra . cql3 . CQL3Type ; 
 import org . apache . cassandra . exceptions . SyntaxException ; 
 import org . apache . cassandra . serializers . TypeSerializer ; 
 import org . apache . cassandra . serializers . MarshalException ; 
 + import org . github . jamm . Unmetered ; 
 
 / * * 
 * Specifies a Comparator for a specific type of ByteBuffer . 
 @ @ - 37 , 6 + 38 , 7 @ @ import org . apache . cassandra . serializers . MarshalException ; 
 * should always handle those values even if they normally do not 
 * represent a valid ByteBuffer for the type being compared . 
 * / 
 + @ Unmetered 
 public abstract class AbstractType < T > implements Comparator < ByteBuffer > 
 { 
 public final Comparator < ByteBuffer > reverseComparator ;

NEAREST DIFF:
diff - - git a / NOTICE . txt b / NOTICE . txt 
 index 6756033 . . 81f9862 100644 
 - - - a / NOTICE . txt 
 + + + b / NOTICE . txt 
 @ @ - 4 , 7 + 4 , 4 @ @ Copyright 2009 The Apache Software Foundation 
 This product includes software developed by The Apache Software 
 Foundation ( http : / / www . apache . org / ) . 
 
 - This product includes software developed by The Groovy community 
 - ( http : / / groovy . codehaus . org / ) . 
 - Copyright 2003 - 2007 The respective authors and developers . 
 Developers and Contributors are listed in the project POM file 
 diff - - git a / conf / storage - conf . xml b / conf / storage - conf . xml 
 index 3865f84 . . 3728ade 100644 
 - - - a / conf / storage - conf . xml 
 + + + b / conf / storage - conf . xml 
 @ @ - 138 , 7 + 138 , 6 @ @ 
 < DataFileDirectories > 
 < DataFileDirectory > / var / cassandra / data < / DataFileDirectory > 
 < / DataFileDirectories > 
 - < CalloutLocation > / var / cassandra / callouts < / CalloutLocation > 
 < BootstrapFileDirectory > / var / cassandra / bootstrap < / BootstrapFileDirectory > 
 < StagingFileDirectory > / var / cassandra / staging < / StagingFileDirectory > 
 
 diff - - git a / lib / groovy - 1 . 5 . 6 . jar b / lib / groovy - 1 . 5 . 6 . jar 
 deleted file mode 100644 
 index 8f61940 . . 0000000 
 Binary files a / lib / groovy - 1 . 5 . 6 . jar and / dev / null differ 
 diff - - git a / lib / licenses / groovy - 1 . 5 . 6 . jar . LICENSE b / lib / licenses / groovy - 1 . 5 . 6 . jar . LICENSE 
 deleted file mode 100644 
 index 7a4a3ea . . 0000000 
 - - - a / lib / licenses / groovy - 1 . 5 . 6 . jar . LICENSE 
 + + + / dev / null 
 @ @ - 1 , 202 + 0 , 0 @ @ 
 - 
 - Apache License 
 - Version 2 . 0 , January 2004 
 - http : / / www . apache . org / licenses / 
 - 
 - TERMS AND CONDITIONS FOR USE , REPRODUCTION , AND DISTRIBUTION 
 - 
 - 1 . Definitions . 
 - 
 - " License " shall mean the terms and conditions for use , reproduction , 
 - and distribution as defined by Sections 1 through 9 of this document . 
 - 
 - " Licensor " shall mean the copyright owner or entity authorized by 
 - the copyright owner that is granting the License . 
 - 
 - " Legal Entity " shall mean the union of the acting entity and all 
 - other entities that control , are controlled by , or are under common 
 - control with that entity . For the purposes of this definition , 
 - " control " means ( i ) the power , direct or indirect , to cause the 
 - direction or management of such entity , whether by contract or 
 - otherwise , or ( ii ) ownership of fifty percent ( 50 % ) or more of the 
 - outstanding shares , or ( iii ) beneficial ownership of such entity . 
 - 
 - " You " ( or " Your " ) shall mean an individual or Legal Entity 
 - exercising permissions granted by this License . 
 - 
 - " Source " form shall mean the preferred form for making modifications , 
 - including but not limited to software source code , documentation 
 - source , and configuration files . 
 - 
 - " Object " form shall mean any form resulting from mechanical 
 - transformation or translation of a Source form , including but 
 - not limited to compiled object code , generated documentation , 
 - and conversions to other media types . 
 - 
 - " Work " shall mean the work of authorship , whether in Source or 
 - Object form , made available under the License , as indicated by a 
 - copyright notice that is included in or attached to the work 
 - ( an example is provided in the Appendix below ) . 
 - 
 - " Derivative Works " shall mean any work , whether in Source or Object 
 - form , that is based on ( or derived from ) the Work and for which the 
 - editorial revisions , annotations , elaborations , or other modifications 
 - represent , as a whole , an original work of authorship . For the purposes 
 - of this License , Derivative Works shall not include works that remain 
 - separable from , or merely link ( or bind by name ) to the interfaces of , 
 - the Work and Derivative Works thereof . 
 - 
 - " Contribution " shall mean any work of authorship , including 
 - the original version of the Work and any modifications or additions 
 - to that Work or Derivative Works thereof , that is intentionally 
 - submitted to Licensor for inclusion in the Work by the copyright owner 
 - or by an individual or Legal Entity authorized to submit on behalf of 
 - the copyright owner . For the purposes of this definition , " submitted " 
 - means any form of electronic , verbal , or written communication sent 
 - to the Licensor or its representatives , including but not limited to 
 - communication on electronic mailing lists , source code control systems , 
 - and issue tracking systems that are managed by , or on behalf of , the 
 - Licensor for the purpose of discussing and improving the Work , but 
 - excluding communication that is conspicuously marked or otherwise 
 - designated in writing by the copyright owner as " Not a Contribution . " 
 - 
 - " Contributor " shall mean Licensor and any individual or Legal Entity 
 - on behalf of whom a Contribution has been received by Licensor and 
 - subsequently incorporated within the Work . 
 - 
 - 2 . Grant of Copyright License . Subject to the terms and conditions of 
 - this License , each Contributor hereby grants to You a perpetual , 
 - worldwide , non - exclusive , no - charge , royalty - free , irrevocable 
 - copyright license to reproduce , prepare Derivative Works of , 
 - publicly display , publicly perform , sublicense , and distribute the 
 - Work and such Derivative Works in Source or Object form . 
 - 
 - 3 . Grant of Patent License . Subject to the terms and conditions of 
 - this License , each Contributor hereby grants to You a perpetual , 
 - worldwide , non - exclusive , no - charge , royalty - free , irrevocable 
 - ( except as stated in this section ) patent license to make , have made , 
 - use , offer to sell , sell , import , and otherwise transfer the Work , 
 - where such license applies only to those patent claims licensable 
 - by such Contributor that are necessarily infringed by their 
 - Contribution ( s ) alone or by combination of their Contribution ( s ) 
 - with the Work to which such Contribution ( s ) was submitted . If You 
 - institute patent litigation against any entity ( including a 
 - cross - claim or counterclaim in a lawsuit ) alleging that the Work 
 - or a Contribution incorporated within the Work constitutes direct 
 - or contributory patent infringement , then any patent licenses 
 - granted to You under this License for that Work shall terminate 
 - as of the date such litigation is filed . 
 - 
 - 4 . Redistribution . You may reproduce and distribute copies of the 
 - Work or Derivative Works thereof in any medium , with or without 
 - modifications , and in Source or Object form , provided that You 
 - meet the following conditions : 
 - 
 - ( a ) You must give any other recipients of the Work or 
 - Derivative Works a copy of this License ; and 
 - 
 - ( b ) You must cause any modified files to carry prominent notices 
 - stating that You changed the files ; and 
 - 
 - ( c ) You must retain , in the Source form of any Derivative Works 
 - that You distribute , all copyright , patent , trademark , and 
 - attribution notices from the Source form of the Work , 
 - excluding those notices that do not pertain to any part of 
 - the Derivative Works ; and 
 - 
 - ( d ) If the Work includes a " NOTICE " text file as part of its 
 - distribution , then any Derivative Works that You distribute must 
 - include a readable copy of the attribution notices contained 
 - within such NOTICE file , excluding those notices that do not 
 - pertain to any part of the Derivative Works , in at least one 
 - of the following places : within a NOTICE text file distributed 
 - as part of the Derivative Works ; within the Source form or 
 - documentation , if provided along with the Derivative Works ; or , 
 - within a display generated by the Derivative Works , if and 
 - wherever such third - party notices normally appear . The contents 
 - of the NOTICE file are for informational purposes only and 
 - do not modify the License . You may add Your own attribution 
 - notices within Derivative Works that You distribute , alongside 
 - or as an addendum to the NOTICE text from the Work , provided 
 - that such additional attribution notices cannot be construed 
 - as modifying the License . 
 - 
 - You may add Your own copyright statement to Your modifications and 
 - may provide additional or different license terms and conditions 
 - for use , reproduction , or distribution of Your modifications , or 
 - for any such Derivative Works as a whole , provided Your use , 
 - reproduction , and distribution of the Work otherwise complies with 
 - the conditions stated in this License . 
 - 
 - 5 . Submission of Contributions . Unless You explicitly state otherwise , 
 - any Contribution intentionally submitted for inclusion in the Work 
 - by You to the Licensor shall be under the terms and conditions of 
 - this License , without any additional terms or conditions . 
 - Notwithstanding the above , nothing herein shall supersede or modify 
 - the terms of any separate license agreement you may have executed 
 - with Licensor regarding such Contributions . 
 - 
 - 6 . Trademarks . This License does not grant permission to use the trade 
 - names , trademarks , service marks , or product names of the Licensor , 
 - except as required for reasonable and customary use in describing the 
 - origin of the Work and reproducing the content of the NOTICE file . 
 - 
 - 7 . Disclaimer of Warranty . Unless required by applicable law or 
 - agreed to in writing , Licensor provides the Work ( and each 
 - Contributor provides its Contributions ) on an " AS IS " BASIS , 
 - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or 
 - implied , including , without limitation , any warranties or conditions 
 - of TITLE , NON - INFRINGEMENT , MERCHANTABILITY , or FITNESS FOR A 
 - PARTICULAR PURPOSE . You are solely responsible for determining the 
 - appropriateness of using or redistributing the Work and assume any 
 - risks associated with Your exercise of permissions under this License . 
 - 
 - 8 . Limitation of Liability . In no event and under no legal theory , 
 - whether in tort ( including negligence ) , contract , or otherwise , 
 - unless required by applicable law ( such as deliberate and grossly 
 - negligent acts ) or agreed to in writing , shall any Contributor be 
 - liable to You for damages , including any direct , indirect , special , 
 - incidental , or consequential damages of any character arising as a 
 - result of this License or out of the use or inability to use the 
 - Work ( including but not limited to damages for loss of goodwill , 
 - work stoppage , computer failure or malfunction , or any and all 
 - other commercial damages or losses ) , even if such Contributor 
 - has been advised of the possibility of such damages . 
 - 
 - 9 . Accepting Warranty or Additional Liability . While redistributing 
 - the Work or Derivative Works thereof , You may choose to offer , 
 - and charge a fee for , acceptance of support , warranty , indemnity , 
 - or other liability obligations and / or rights consistent with this 
 - License . However , in accepting such obligations , You may act only 
 - on Your own behalf and on Your sole responsibility , not on behalf 
 - of any other Contributor , and only if You agree to indemnify , 
 - defend , and hold each Contributor harmless for any liability 
 - incurred by , or claims asserted against , such Contributor by reason 
 - of your accepting any such warranty or additional liability . 
 - 
 - END OF TERMS AND CONDITIONS 
 - 
 - APPENDIX : How to apply the Apache License to your work . 
 - 
 - To apply the Apache License to your work , attach the following 
 - boilerplate notice , with the fields enclosed by brackets " [ ] " 
 - replaced with your own identifying information . ( Don ' t include 
 - the brackets ! ) The text should be enclosed in the appropriate 
 - comment syntax for the file format . We also recommend that a 
 - file or class name and description of purpose be included on the 
 - same " printed page " as the copyright notice for easier 
 - identification within third - party archives . 
 - 
 - Copyright [ yyyy ] [ name of copyright owner ] 
 - 
 - Licensed under the Apache License , Version 2 . 0 ( the " License " ) ; 
 - you may not use this file except in compliance with the License . 
 - You may obtain a copy of the License at 
 - 
 - http : / / www . apache . org / licenses / LICENSE - 2 . 0 
 - 
 - Unless required by applicable law or agreed to in writing , software 
 - distributed under the License is distributed on an " AS IS " BASIS , 
 - WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . 
 - See the License for the specific language governing permissions and 
 - limitations under the License . 
 \ No newline at end of file 
 diff - - git a / pom . xml b / pom . xml 
 index 33c426c . . 743bb7a 100644 
 - - - a / pom . xml 
 + + + b / pom . xml 
 @ @ - 181 , 11 + 181 , 6 @ @ 
 < version > 3 . 1 . 3 < / version > 
 < / dependency > 
 < dependency > 
 - < groupId > org . codehaus . groovy < / groupId > 
 - < artifactId > groovy < / artifactId > 
 - < version > 1 . 5 . 6 < / version > 
 - < / dependency > 
 - < dependency > 
 < groupId > com . google . collections < / groupId > 
 < artifactId > google - collections < / artifactId > 
 < version > 1 . 0 - rc1 < / version > 
 diff - - git a / src / java / org / apache / cassandra / config / DatabaseDescriptor . java b / src / java / org / apache / cassandra / config / DatabaseDescriptor . java 
 index 91e35ef . . 9016676 100644 
 - - - a / src / java / org / apache / cassandra / config / DatabaseDescriptor . java 
 + + + b / src / java / org / apache / cassandra / config / DatabaseDescriptor . java 
 @ @ - 113 , 8 + 113 , 6 @ @ public class DatabaseDescriptor 
 * high throughput on reads but at the cost of consistency . 
 * / 
 private static boolean doConsistencyCheck _ = true ; 
 - / * Callout directories * / 
 - private static String calloutLocation _ ; 
 / * Job Jar Location * / 
 private static String jobJarFileLocation _ ; 
 / * Address where to run the job tracker * / 
 @ @ - 222 , 9 + 220 , 6 @ @ public class DatabaseDescriptor 
 throw new ConfigurationException ( " Invalid endpointsnitch class " + endPointSnitchClassName ) ; 
 } 
 
 - / * Callout location * / 
 - calloutLocation _ = xmlUtils . getNodeValue ( " / Storage / CalloutLocation " ) ; 
 - 
 / * JobTracker address * / 
 jobTrackerHost _ = xmlUtils . getNodeValue ( " / Storage / JobTrackerHost " ) ; 
 
 @ @ - 673 , 11 + 668 , 6 @ @ public class DatabaseDescriptor 
 return replicaPlacementStrategyClass _ ; 
 } 
 
 - public static String getCalloutLocation ( ) 
 - { 
 - return calloutLocation _ ; 
 - } 
 - 
 public static String getJobTrackerAddress ( ) 
 { 
 return jobTrackerHost _ ; 
 diff - - git a / src / java / org / apache / cassandra / db / CalloutDeployMessage . java b / src / java / org / apache / cassandra / db / CalloutDeployMessage . java 
 deleted file mode 100644 
 index 8b15492 . . 0000000 
 - - - a / src / java / org / apache / cassandra / db / CalloutDeployMessage . java 
 + + + / dev / null 
 @ @ - 1 , 89 + 0 , 0 @ @ 
 - / * * 
 - * Licensed to the Apache Software Foundation ( ASF ) under one 
 - * or more contributor license agreements . See the NOTICE file 
 - * distributed with this work for additional information 
 - * regarding copyright ownership . The ASF licenses this file 
 - * to you under the Apache License , Version 2 . 0 ( the 
 - * " License " ) ; you may not use this file except in compliance 
 - * with the License . You may obtain a copy of the License at 
 - * 
 - * http : / / www . apache . org / licenses / LICENSE - 2 . 0 
 - * 
 - * Unless required by applicable law or agreed to in writing , software 
 - * distributed under the License is distributed on an " AS IS " BASIS , 
 - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . 
 - * See the License for the specific language governing permissions and 
 - * limitations under the License . 
 - * / 
 - package org . apache . cassandra . db ; 
 - 
 - import java . io . ByteArrayOutputStream ; 
 - import java . io . DataInputStream ; 
 - import java . io . DataOutputStream ; 
 - import java . io . IOException ; 
 - 
 - import org . apache . cassandra . io . ICompactSerializer ; 
 - import org . apache . cassandra . net . Message ; 
 - import org . apache . cassandra . service . StorageService ; 
 - 
 - 
 - public class CalloutDeployMessage 
 - { 
 - private static ICompactSerializer < CalloutDeployMessage > serializer _ ; 
 - 
 - static 
 - { 
 - serializer _ = new CalloutDeployMessageSerializer ( ) ; 
 - } 
 - 
 - public static ICompactSerializer < CalloutDeployMessage > serializer ( ) 
 - { 
 - return serializer _ ; 
 - } 
 - 
 - public static Message getCalloutDeployMessage ( CalloutDeployMessage cdMessage ) throws IOException 
 - { 
 - ByteArrayOutputStream bos = new ByteArrayOutputStream ( ) ; 
 - DataOutputStream dos = new DataOutputStream ( bos ) ; 
 - serializer _ . serialize ( cdMessage , dos ) ; 
 - Message message = new Message ( StorageService . getLocalStorageEndPoint ( ) , " " , StorageService . calloutDeployVerbHandler _ , bos . toByteArray ( ) ) ; 
 - return message ; 
 - } 
 - 
 - / * Name of the callout * / 
 - private String callout _ ; 
 - / * The actual procedure * / 
 - private String script _ ; 
 - 
 - public CalloutDeployMessage ( String callout , String script ) 
 - { 
 - callout _ = callout ; 
 - script _ = script ; 
 - } 
 - 
 - String getCallout ( ) 
 - { 
 - return callout _ ; 
 - } 
 - 
 - String getScript ( ) 
 - { 
 - return script _ ; 
 - } 
 - } 
 - 
 - class CalloutDeployMessageSerializer implements ICompactSerializer < CalloutDeployMessage > 
 - { 
 - public void serialize ( CalloutDeployMessage cdMessage , DataOutputStream dos ) throws IOException 
 - { 
 - dos . writeUTF ( cdMessage . getCallout ( ) ) ; 
 - dos . writeUTF ( cdMessage . getScript ( ) ) ; 
 - } 
 - 
 - public CalloutDeployMessage deserialize ( DataInputStream dis ) throws IOException 
 - { 
 - String callout = dis . readUTF ( ) ; 
 - String script = dis . readUTF ( ) ; 
 - return new CalloutDeployMessage ( callout , script ) ; 
 - } 
 - } 
 diff - - git a / src / java / org / apache / cassandra / db / CalloutDeployVerbHandler . java b / src / java / org / apache / cassandra / db / CalloutDeployVerbHandler . java 
 deleted file mode 100644 
 index 3c50b72 . . 0000000 
 - - - a / src / java / org / apache / cassandra / db / CalloutDeployVerbHandler . java 
 + + + / dev / null 
 @ @ - 1 , 49 + 0 , 0 @ @ 
 - / * * 
 - * Licensed to the Apache Software Foundation ( ASF ) under one 
 - * or more contributor license agreements . See the NOTICE file 
 - * distributed with this work for additional information 
 - * regarding copyright ownership . The ASF licenses this file 
 - * to you under the Apache License , Version 2 . 0 ( the 
 - * " License " ) ; you may not use this file except in compliance 
 - * with the License . You may obtain a copy of the License at 
 - * 
 - * http : / / www . apache . org / licenses / LICENSE - 2 . 0 
 - * 
 - * Unless required by applicable law or agreed to in writing , software 
 - * distributed under the License is distributed on an " AS IS " BASIS , 
 - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . 
 - * See the License for the specific language governing permissions and 
 - * limitations under the License . 
 - * / 
 - package org . apache . cassandra . db ; 
 - 
 - import java . io . IOException ; 
 - 
 - import org . apache . cassandra . io . DataInputBuffer ; 
 - import org . apache . cassandra . net . IVerbHandler ; 
 - import org . apache . cassandra . net . Message ; 
 - import org . apache . cassandra . utils . LogUtil ; 
 - import org . apache . log4j . Logger ; 
 - 
 - 
 - public class CalloutDeployVerbHandler implements IVerbHandler 
 - { 
 - private static Logger logger _ = Logger . getLogger ( CalloutDeployVerbHandler . class ) ; 
 - 
 - public void doVerb ( Message message ) 
 - { 
 - byte [ ] bytes = message . getMessageBody ( ) ; 
 - DataInputBuffer bufIn = new DataInputBuffer ( ) ; 
 - bufIn . reset ( bytes , bytes . length ) ; 
 - try 
 - { 
 - CalloutDeployMessage cdMessage = CalloutDeployMessage . serializer ( ) . deserialize ( bufIn ) ; 
 - / * save the callout to callout cache and to disk . * / 
 - CalloutManager . instance ( ) . addCallout ( cdMessage . getCallout ( ) , cdMessage . getScript ( ) ) ; 
 - } 
 - catch ( IOException ex ) 
 - { 
 - logger _ . warn ( LogUtil . throwableToString ( ex ) ) ; 
 - } 
 - } 
 - } 
 diff - - git a / src / java / org / apache / cassandra / db / CalloutManager . java b / src / java / org / apache / cassandra / db / CalloutManager . java 
 deleted file mode 100644 
 index a7e6a9b . . 0000000 
 - - - a / src / java / org / apache / cassandra / db / CalloutManager . java 
 + + + / dev / null 
 @ @ - 1 , 211 + 0 , 0 @ @ 
 - / * * 
 - * Licensed to the Apache Software Foundation ( ASF ) under one 
 - * or more contributor license agreements . See the NOTICE file 
 - * distributed with this work for additional information 
 - * regarding copyright ownership . The ASF licenses this file 
 - * to you under the Apache License , Version 2 . 0 ( the 
 - * " License " ) ; you may not use this file except in compliance 
 - * with the License . You may obtain a copy of the License at 
 - * 
 - * http : / / www . apache . org / licenses / LICENSE - 2 . 0 
 - * 
 - * Unless required by applicable law or agreed to in writing , software 
 - * distributed under the License is distributed on an " AS IS " BASIS , 
 - * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND , either express or implied . 
 - * See the License for the specific language governing permissions and 
 - * limitations under the License . 
 - * / 
 - package org . apache . cassandra . db ; 
 - 
 - import java . io . File ; 
 - import java . io . FileInputStream ; 
 - import java . io . FileOutputStream ; 
 - import java . io . IOException ; 
 - import java . util . List ; 
 - import java . util . HashMap ; 
 - import java . util . Map ; 
 - import java . util . concurrent . locks . Lock ; 
 - import java . util . concurrent . locks . ReentrantLock ; 
 - 
 - import javax . script . Bindings ; 
 - import javax . script . Invocable ; 
 - import javax . script . ScriptEngine ; 
 - import javax . script . ScriptEngineManager ; 
 - import javax . script . Compilable ; 
 - import javax . script . CompiledScript ; 
 - import javax . script . ScriptException ; 
 - import javax . script . SimpleBindings ; 
 - 
 - import org . apache . cassandra . config . DatabaseDescriptor ; 
 - import org . apache . cassandra . procedures . GroovyScriptRunner ; 
 - import org . apache . cassandra . utils . LogUtil ; 
 - import org . apache . cassandra . utils . FileUtils ; 
 - 
 - import org . apache . log4j . Logger ; 
 - 
 - public class CalloutManager 
 - { 
 - private final static Logger logger _ = Logger . getLogger ( CalloutManager . class ) ; 
 - private static final String extn _ = " . groovy " ; 
 - / * Used to lock the factory for creation of CalloutManager instance * / 
 - private static Lock createLock _ = new ReentrantLock ( ) ; 
 - / * An instance of the CalloutManager * / 
 - private static CalloutManager instance _ ; 
 - 
 - public static CalloutManager instance ( ) 
 - { 
 - if ( instance _ = = null ) 
 - { 
 - CalloutManager . createLock _ . lock ( ) ; 
 - try 
 - { 
 - if ( instance _ = = null ) 
 - { 
 - instance _ = new CalloutManager ( ) ; 
 - } 
 - } 
 - finally 
 - { 
 - CalloutManager . createLock _ . unlock ( ) ; 
 - } 
 - } 
 - return instance _ ; 
 - } 
 - 
 - / * Map containing the name of callout as key and the callout script as value * / 
 - private Map < String , CompiledScript > calloutCache _ = new HashMap < String , CompiledScript > ( ) ; 
 - / * The Groovy Script compiler instance * / 
 - private Compilable compiler _ ; 
 - / * The Groovy script invokable instance * / 
 - private Invocable invokable _ ; 
 - 
 - private CalloutManager ( ) 
 - { 
 - ScriptEngineManager scriptManager = new ScriptEngineManager ( ) ; 
 - ScriptEngine groovyEngine = scriptManager . getEngineByName ( " groovy " ) ; 
 - compiler _ = ( Compilable ) groovyEngine ; 
 - invokable _ = ( Invocable ) groovyEngine ; 
 - } 
 - 
 - / * * 
 - * Compile the script and cache the compiled script . 
 - * @ param script to be compiled 
 - * @ throws ScriptException 
 - * / 
 - private void compileAndCache ( String scriptId , String script ) throws ScriptException 
 - { 
 - if ( compiler _ ! = null ) 
 - { 
 - CompiledScript compiledScript = compiler _ . compile ( script ) ; 
 - calloutCache _ . put ( scriptId , compiledScript ) ; 
 - } 
 - } 
 - 
 - / * * 
 - * Invoked on start up to load all the stored callouts , compile 
 - * and cache them . 
 - * 
 - * @ throws IOException 
 - * / 
 - public void onStart ( ) throws IOException 
 - { 
 - 	 String location = DatabaseDescriptor . getCalloutLocation ( ) ; 
 - 	 if ( location = = null ) 
 - 	 	 return ; 
 - 	 
 - FileUtils . createDirectory ( location ) ; 
 - 
 - File [ ] files = new File ( location ) . listFiles ( ) ; 
 - 
 - for ( File file : files ) 
 - { 
 - String f = file . getName ( ) ; 
 - / * Get the callout name from the file * / 
 - String callout = f . split ( extn _ ) [ 0 ] ; 
 - FileInputStream fis = new FileInputStream ( file ) ; 
 - byte [ ] bytes = new byte [ fis . available ( ) ] ; 
 - fis . read ( bytes ) ; 
 - fis . close ( ) ; 
 - / * cache the callout after compiling it * / 
 - try 
 - { 
 - compileAndCache ( callout , new String ( bytes ) ) ; 
 - } 
 - catch ( ScriptException ex ) 
 - { 
 - logger _ . warn ( LogUtil . throwableToString ( ex ) ) ; 
 - } 
 - } 
 - } 
 - 
 - / * * 
 - * Store the callout in cache and write it out 
 - * to disk . 
 - * @ param callout the name of the callout 
 - * @ param script actual implementation of the callout 
 - * / 
 - public void addCallout ( String callout , String script ) throws IOException 
 - { 
 - / * cache the script * / 
 - / * cache the callout after compiling it * / 
 - try 
 - { 
 - compileAndCache ( callout , script ) ; 
 - } 
 - catch ( ScriptException ex ) 
 - { 
 - logger _ . warn ( LogUtil . throwableToString ( ex ) ) ; 
 - } 
 - / * save the script to disk * / 
 - String scriptFile = DatabaseDescriptor . getCalloutLocation ( ) + File . separator + callout + extn _ ; 
 - File file = new File ( scriptFile ) ; 
 - if ( file . exists ( ) ) 
 - { 
 - if ( logger _ . isDebugEnabled ( ) ) 
 - logger _ . debug ( " Deleting the old script file . . . " ) ; 
 - file . delete ( ) ; 
 - } 
 - FileOutputStream fos = new FileOutputStream ( scriptFile ) ; 
 - fos . write ( script . getBytes ( ) ) ; 
 - fos . close ( ) ; 
 - } 
 - 
 - / * * 
 - * Remove the registered callout and delete the 
 - * script on the disk . 
 - * @ param callout to be removed 
 - * / 
 - public void removeCallout ( String callout ) 
 - { 
 - / * remove the script from cache * / 
 - calloutCache _ . remove ( callout ) ; 
 - String scriptFile = DatabaseDescriptor . getCalloutLocation ( ) + File . separator + callout + " . grv " ; 
 - File file = new File ( scriptFile ) ; 
 - file . delete ( ) ; 
 - } 
 - 
 - / * * 
 - * Execute the specified callout . 
 - * @ param callout to be executed . 
 - * @ param args arguments to be passed to the callouts . 
 - * / 
 - public Object executeCallout ( String callout , Object . . . args ) 
 - { 
 - Object result = null ; 
 - CompiledScript script = calloutCache _ . get ( callout ) ; 
 - if ( script ! = null ) 
 - { 
 - try 
 - { 
 - Bindings binding = new SimpleBindings ( ) ; 
 - binding . put ( " args " , args ) ; 
 - result = script . eval ( binding ) ; 
 - } 
 - catch ( ScriptException ex ) 
 - { 
 - logger _ . warn ( LogUtil . throwableToString ( ex ) ) ; 
 - } 
 - } 
 - return result ; 
 - } 
 - } 
 diff - - git a / src / java / org / apache / cassandra / procedures / GroovyScriptRunner . java b / src / java / org / apache / cassandra / procedures / GroovyScriptRunner . java 
 index 6df394d . . e69de29 100644 
 - - - a / src / java / org / apache / cassandra / procedures / GroovyScriptRunner . java 
 + + + b / src / java / org / apache / cassandra / procedures / GroovyScriptRunner . java 
 @ @ - 1 , 31 + 0 , 0 @ @ 
 - / * 
 - * Licensed to the Apache Software Foundation ( ASF ) under one 
 - * or more contributor license agreements . See the NOTICE file 
 - * distributed with this work for additional information 
 - * regarding copyright ownership . The ASF licenses this file 
 - * to you under the Apache License , Version 2 . 0 ( the 
 - * " License " ) ; you may not use this file except in compliance 
 - * with the License . You may obtain a copy of the License at 
 - * 
 - * http : / / www . apache . org / licenses / LICENSE - 2 . 0 
 - * 
 - * Unless required by applicable law or agreed to in writing , 
 - * software distributed under the License is distributed on an 
 - * " AS IS " BASIS , WITHOUT WARRANTIES OR CONDITIONS OF ANY 
 - * KIND , either express or implied . See the License for the 
 - * specific language governing permissions and limitations 
 - * under the License . 
 - * / 
 - package org . apache . cassandra . procedures ; 
 - 
 - import groovy . lang . GroovyShell ; 
 - 
 - public class GroovyScriptRunner 
 - { 
 - 	 private static GroovyShell groovyShell _ = new GroovyShell ( ) ; 
 - 
 - 	 public static String evaluateString ( String script ) 
 - 	 { 
 - 	 	 return groovyShell _ . evaluate ( script ) . toString ( ) ; 
 - 	 } 
 - } 
 diff - - git a / src / java / org / apache / cassandra / service / CassandraDaemon . java b / src / java / org / apache / cassandra / service / CassandraDaemon . java 
 index a3111b6 . . 97bc5ac 100644 
 - - - a / src / java / org / apache / cassandra / service / CassandraDaemon . java 
 + + + b / src / java / org / apache / cassandra / service / CassandraDaemon . java 
 @ @ - 36 , 7 + 36 , 6 @ @ import org . apache . cassandra . config . DatabaseDescriptor ; 
 import org . apache . cassandra . utils . FBUtilities ; 
 import org . apache . cassandra . db . Table ; 
 import org . apache . cassandra . db . RecoveryManager ; 
 - import org . apache . cassandra . db . CalloutManager ; 
 
 / * * 
 * This class supports two methods for creating a Cassandra node daemon , 
 @ @ - 77 , 8 + 76 , 6 @ @ public class CassandraDaemon 
 } ) ; 
 
 / / initialize stuff 
 - CalloutManager . instance ( ) . onStart ( ) ; 
 - 
 Set < String > tables = DatabaseDescriptor . getTableToColumnFamilyMap ( ) . keySet ( ) ; 
 for ( String table : tables ) 
 { 
 diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java 
 index 5d6c3ef . . 03b6bba 100644 
 - - - a / src / java / org / apache / cassandra / service / StorageService . java 
 + + + b / src / java / org / apache / cassandra / service / StorageService . java 
 @ @ - 76 , 7 + 76 , 6 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto 
 public final static String dataFileVerbHandler _ = " DATA - FILE - VERB - HANDLER " ; 
 public final static String mbrshipCleanerVerbHandler _ = " MBRSHIP - CLEANER - VERB - HANDLER " ; 
 public final static String bsMetadataVerbHandler _ = " BS - METADATA - VERB - HANDLER " ; 
 - public final static String calloutDeployVerbHandler _ = " CALLOUT - DEPLOY - VERB - HANDLER " ; 
 public final static String rangeVerbHandler _ = " RANGE - VERB - HANDLER " ; 
 
 public static enum ConsistencyLevel 
 @ @ - 252 , 7 + 251 , 6 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto 
 MessagingService . getMessagingInstance ( ) . registerVerbHandlers ( StorageService . dataFileVerbHandler _ , new DataFileVerbHandler ( ) ) ; 
 MessagingService . getMessagingInstance ( ) . registerVerbHandlers ( StorageService . mbrshipCleanerVerbHandler _ , new MembershipCleanerVerbHandler ( ) ) ; 
 MessagingService . getMessagingInstance ( ) . registerVerbHandlers ( StorageService . bsMetadataVerbHandler _ , new BootstrapMetadataVerbHandler ( ) ) ; 
 - MessagingService . getMessagingInstance ( ) . registerVerbHandlers ( StorageService . calloutDeployVerbHandler _ , new CalloutDeployVerbHandler ( ) ) ; 
 MessagingService . getMessagingInstance ( ) . registerVerbHandlers ( StorageService . rangeVerbHandler _ , new RangeVerbHandler ( ) ) ; 
 
 / * register the stage for the mutations * / 
 diff - - git a / test / conf / storage - conf . xml b / test / conf / storage - conf . xml 
 index e0ac28f . . 20f3377 100644 
 - - - a / test / conf / storage - conf . xml 
 + + + b / test / conf / storage - conf . xml 
 @ @ - 37 , 7 + 37 , 6 @ @ 
 < DataFileDirectories > 
 < DataFileDirectory > build / test / cassandra / data < / DataFileDirectory > 
 < / DataFileDirectories > 
 - < CalloutLocation > build / test / cassandra / callouts < / CalloutLocation > 
 < BootstrapFileDirectory > build / test / cassandra / bootstrap < / BootstrapFileDirectory > 
 < StagingFileDirectory > build / test / cassandra / staging < / StagingFileDirectory > 
 < MemtableSizeInMB > 1 < / MemtableSizeInMB >
