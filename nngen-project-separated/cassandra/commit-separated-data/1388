BLEU SCORE: 0.7071067811865476

TEST MSG: Fix CommitLogFailurePolicyTest
GENERATED MSG: fix CommitLogFailurePolicyTest

TEST DIFF (one line): diff - - git a / test / unit / org / apache / cassandra / db / CommitLogFailurePolicyTest . java b / test / unit / org / apache / cassandra / db / CommitLogFailurePolicyTest . java <nl> index cca6503 . . 0ecab3c 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / CommitLogFailurePolicyTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / CommitLogFailurePolicyTest . java <nl> @ @ - 19 , 8 + 19 , 6 @ @ <nl> <nl> package org . apache . cassandra . db ; <nl> <nl> - import java . io . File ; <nl> - <nl> import org . junit . Assert ; <nl> import org . junit . BeforeClass ; <nl> import org . junit . Test ; <nl> @ @ - 28 , 7 + 26 , 6 @ @ import org . apache . cassandra . SchemaLoader ; <nl> import org . apache . cassandra . config . Config ; <nl> import org . apache . cassandra . config . DatabaseDescriptor ; <nl> import org . apache . cassandra . db . commitlog . CommitLog ; <nl> - import org . apache . cassandra . db . commitlog . CommitLogSegmentManager ; <nl> import org . apache . cassandra . exceptions . ConfigurationException ; <nl> import org . apache . cassandra . gms . Gossiper ; <nl> import org . apache . cassandra . service . CassandraDaemon ; <nl> @ @ - 38 , 7 + 35 , 6 @ @ import org . apache . cassandra . utils . KillerForTests ; <nl> <nl> public class CommitLogFailurePolicyTest <nl> { <nl> - <nl> @ BeforeClass <nl> public static void defineSchema ( ) throws ConfigurationException <nl> { <nl> @ @ - 95 , 57 + 91 , 20 @ @ public class CommitLogFailurePolicyTest <nl> } <nl> <nl> @ Test <nl> - public void testCommitFailurePolicy _ mustDieIfNotStartedUp ( ) <nl> - { <nl> - / / startup was not completed successfuly ( since method completeSetup ( ) was not called ) <nl> - CassandraDaemon daemon = new CassandraDaemon ( ) ; <nl> - StorageService . instance . registerDaemon ( daemon ) ; <nl> - <nl> - KillerForTests killerForTests = new KillerForTests ( ) ; <nl> - JVMStabilityInspector . Killer originalKiller = JVMStabilityInspector . replaceKiller ( killerForTests ) ; <nl> - Config . CommitFailurePolicy oldPolicy = DatabaseDescriptor . getCommitFailurePolicy ( ) ; <nl> - try <nl> - { <nl> - / / even though policy is ignore , JVM must die because Daemon has not finished initializing <nl> - DatabaseDescriptor . setCommitFailurePolicy ( Config . CommitFailurePolicy . ignore ) ; <nl> - CommitLog . handleCommitError ( " Testing die policy " , new Throwable ( ) ) ; <nl> - Assert . assertTrue ( killerForTests . wasKilled ( ) ) ; <nl> - Assert . assertTrue ( killerForTests . wasKilledQuietly ( ) ) ; / / killed quietly due to startup failure <nl> - } <nl> - finally <nl> - { <nl> - DatabaseDescriptor . setCommitFailurePolicy ( oldPolicy ) ; <nl> - JVMStabilityInspector . replaceKiller ( originalKiller ) ; <nl> - } <nl> - } <nl> - <nl> - @ Test <nl> - public void testCommitLogFailureBeforeInitialization _ mustKillJVM ( ) throws Exception <nl> + public void testCommitFailurePolicy _ ignore _ beforeStartup ( ) <nl> { <nl> / / startup was not completed successfuly ( since method completeSetup ( ) was not called ) <nl> CassandraDaemon daemon = new CassandraDaemon ( ) ; <nl> StorageService . instance . registerDaemon ( daemon ) ; <nl> <nl> - / / let ' s make the commit log directory non - writable <nl> - File commitLogDir = new File ( DatabaseDescriptor . getCommitLogLocation ( ) ) ; <nl> - commitLogDir . setWritable ( false ) ; <nl> - <nl> KillerForTests killerForTests = new KillerForTests ( ) ; <nl> JVMStabilityInspector . Killer originalKiller = JVMStabilityInspector . replaceKiller ( killerForTests ) ; <nl> Config . CommitFailurePolicy oldPolicy = DatabaseDescriptor . getCommitFailurePolicy ( ) ; <nl> try <nl> { <nl> DatabaseDescriptor . setCommitFailurePolicy ( Config . CommitFailurePolicy . ignore ) ; <nl> - <nl> - / / now let ' s create a commit log segment manager and wait for it to fail <nl> - new CommitLogSegmentManager ( CommitLog . instance ) ; <nl> - <nl> - / / busy wait since commitlogsegmentmanager spawns another thread <nl> - int retries = 0 ; <nl> - while ( ! killerForTests . wasKilled ( ) & & retries + + < 5 ) <nl> - Thread . sleep ( 10 ) ; <nl> - <nl> - / / since failure was before CassandraDaemon startup , the JVM must be killed <nl> + CommitLog . handleCommitError ( " Testing ignore policy " , new Throwable ( ) ) ; <nl> + / / even though policy is ignore , JVM must die because Daemon has not finished initializing <nl> Assert . assertTrue ( killerForTests . wasKilled ( ) ) ; <nl> Assert . assertTrue ( killerForTests . wasKilledQuietly ( ) ) ; / / killed quietly due to startup failure <nl> } <nl> @ @ - 153 , 35 + 112 , 23 @ @ public class CommitLogFailurePolicyTest <nl> { <nl> DatabaseDescriptor . setCommitFailurePolicy ( oldPolicy ) ; <nl> JVMStabilityInspector . replaceKiller ( originalKiller ) ; <nl> - commitLogDir . setWritable ( true ) ; <nl> } <nl> } <nl> <nl> @ Test <nl> - public void testCommitLogFailureAfterInitialization _ mustRespectFailurePolicy ( ) throws Exception <nl> + public void testCommitFailurePolicy _ ignore _ afterStartup ( ) throws Exception <nl> { <nl> - / / startup was not completed successfuly ( since method completeSetup ( ) was not called ) <nl> CassandraDaemon daemon = new CassandraDaemon ( ) ; <nl> daemon . completeSetup ( ) ; / / startup must be completed , otherwise commit log failure must kill JVM regardless of failure policy <nl> StorageService . instance . registerDaemon ( daemon ) ; <nl> <nl> - / / let ' s make the commit log directory non - writable <nl> - File commitLogDir = new File ( DatabaseDescriptor . getCommitLogLocation ( ) ) ; <nl> - commitLogDir . setWritable ( false ) ; <nl> - <nl> KillerForTests killerForTests = new KillerForTests ( ) ; <nl> JVMStabilityInspector . Killer originalKiller = JVMStabilityInspector . replaceKiller ( killerForTests ) ; <nl> Config . CommitFailurePolicy oldPolicy = DatabaseDescriptor . getCommitFailurePolicy ( ) ; <nl> try <nl> { <nl> DatabaseDescriptor . setCommitFailurePolicy ( Config . CommitFailurePolicy . ignore ) ; <nl> - <nl> - / / now let ' s create a commit log segment manager and wait for it to fail <nl> - new CommitLogSegmentManager ( CommitLog . instance ) ; <nl> - <nl> - / / wait commit log segment manager thread to execute <nl> - Thread . sleep ( 50 ) ; <nl> - <nl> + CommitLog . handleCommitError ( " Testing ignore policy " , new Throwable ( ) ) ; <nl> / / error policy is set to IGNORE , so JVM must not be killed if error ocurs after startup <nl> Assert . assertFalse ( killerForTests . wasKilled ( ) ) ; <nl> } <nl> @ @ - 189 , 7 + 136 , 6 @ @ public class CommitLogFailurePolicyTest <nl> { <nl> DatabaseDescriptor . setCommitFailurePolicy ( oldPolicy ) ; <nl> JVMStabilityInspector . replaceKiller ( originalKiller ) ; <nl> - commitLogDir . setWritable ( true ) ; <nl> } <nl> } <nl> }
NEAREST DIFF (one line): ELIMINATEDSENTENCE

TEST DIFF:
diff - - git a / test / unit / org / apache / cassandra / db / CommitLogFailurePolicyTest . java b / test / unit / org / apache / cassandra / db / CommitLogFailurePolicyTest . java 
 index cca6503 . . 0ecab3c 100644 
 - - - a / test / unit / org / apache / cassandra / db / CommitLogFailurePolicyTest . java 
 + + + b / test / unit / org / apache / cassandra / db / CommitLogFailurePolicyTest . java 
 @ @ - 19 , 8 + 19 , 6 @ @ 
 
 package org . apache . cassandra . db ; 
 
 - import java . io . File ; 
 - 
 import org . junit . Assert ; 
 import org . junit . BeforeClass ; 
 import org . junit . Test ; 
 @ @ - 28 , 7 + 26 , 6 @ @ import org . apache . cassandra . SchemaLoader ; 
 import org . apache . cassandra . config . Config ; 
 import org . apache . cassandra . config . DatabaseDescriptor ; 
 import org . apache . cassandra . db . commitlog . CommitLog ; 
 - import org . apache . cassandra . db . commitlog . CommitLogSegmentManager ; 
 import org . apache . cassandra . exceptions . ConfigurationException ; 
 import org . apache . cassandra . gms . Gossiper ; 
 import org . apache . cassandra . service . CassandraDaemon ; 
 @ @ - 38 , 7 + 35 , 6 @ @ import org . apache . cassandra . utils . KillerForTests ; 
 
 public class CommitLogFailurePolicyTest 
 { 
 - 
 @ BeforeClass 
 public static void defineSchema ( ) throws ConfigurationException 
 { 
 @ @ - 95 , 57 + 91 , 20 @ @ public class CommitLogFailurePolicyTest 
 } 
 
 @ Test 
 - public void testCommitFailurePolicy _ mustDieIfNotStartedUp ( ) 
 - { 
 - / / startup was not completed successfuly ( since method completeSetup ( ) was not called ) 
 - CassandraDaemon daemon = new CassandraDaemon ( ) ; 
 - StorageService . instance . registerDaemon ( daemon ) ; 
 - 
 - KillerForTests killerForTests = new KillerForTests ( ) ; 
 - JVMStabilityInspector . Killer originalKiller = JVMStabilityInspector . replaceKiller ( killerForTests ) ; 
 - Config . CommitFailurePolicy oldPolicy = DatabaseDescriptor . getCommitFailurePolicy ( ) ; 
 - try 
 - { 
 - / / even though policy is ignore , JVM must die because Daemon has not finished initializing 
 - DatabaseDescriptor . setCommitFailurePolicy ( Config . CommitFailurePolicy . ignore ) ; 
 - CommitLog . handleCommitError ( " Testing die policy " , new Throwable ( ) ) ; 
 - Assert . assertTrue ( killerForTests . wasKilled ( ) ) ; 
 - Assert . assertTrue ( killerForTests . wasKilledQuietly ( ) ) ; / / killed quietly due to startup failure 
 - } 
 - finally 
 - { 
 - DatabaseDescriptor . setCommitFailurePolicy ( oldPolicy ) ; 
 - JVMStabilityInspector . replaceKiller ( originalKiller ) ; 
 - } 
 - } 
 - 
 - @ Test 
 - public void testCommitLogFailureBeforeInitialization _ mustKillJVM ( ) throws Exception 
 + public void testCommitFailurePolicy _ ignore _ beforeStartup ( ) 
 { 
 / / startup was not completed successfuly ( since method completeSetup ( ) was not called ) 
 CassandraDaemon daemon = new CassandraDaemon ( ) ; 
 StorageService . instance . registerDaemon ( daemon ) ; 
 
 - / / let ' s make the commit log directory non - writable 
 - File commitLogDir = new File ( DatabaseDescriptor . getCommitLogLocation ( ) ) ; 
 - commitLogDir . setWritable ( false ) ; 
 - 
 KillerForTests killerForTests = new KillerForTests ( ) ; 
 JVMStabilityInspector . Killer originalKiller = JVMStabilityInspector . replaceKiller ( killerForTests ) ; 
 Config . CommitFailurePolicy oldPolicy = DatabaseDescriptor . getCommitFailurePolicy ( ) ; 
 try 
 { 
 DatabaseDescriptor . setCommitFailurePolicy ( Config . CommitFailurePolicy . ignore ) ; 
 - 
 - / / now let ' s create a commit log segment manager and wait for it to fail 
 - new CommitLogSegmentManager ( CommitLog . instance ) ; 
 - 
 - / / busy wait since commitlogsegmentmanager spawns another thread 
 - int retries = 0 ; 
 - while ( ! killerForTests . wasKilled ( ) & & retries + + < 5 ) 
 - Thread . sleep ( 10 ) ; 
 - 
 - / / since failure was before CassandraDaemon startup , the JVM must be killed 
 + CommitLog . handleCommitError ( " Testing ignore policy " , new Throwable ( ) ) ; 
 + / / even though policy is ignore , JVM must die because Daemon has not finished initializing 
 Assert . assertTrue ( killerForTests . wasKilled ( ) ) ; 
 Assert . assertTrue ( killerForTests . wasKilledQuietly ( ) ) ; / / killed quietly due to startup failure 
 } 
 @ @ - 153 , 35 + 112 , 23 @ @ public class CommitLogFailurePolicyTest 
 { 
 DatabaseDescriptor . setCommitFailurePolicy ( oldPolicy ) ; 
 JVMStabilityInspector . replaceKiller ( originalKiller ) ; 
 - commitLogDir . setWritable ( true ) ; 
 } 
 } 
 
 @ Test 
 - public void testCommitLogFailureAfterInitialization _ mustRespectFailurePolicy ( ) throws Exception 
 + public void testCommitFailurePolicy _ ignore _ afterStartup ( ) throws Exception 
 { 
 - / / startup was not completed successfuly ( since method completeSetup ( ) was not called ) 
 CassandraDaemon daemon = new CassandraDaemon ( ) ; 
 daemon . completeSetup ( ) ; / / startup must be completed , otherwise commit log failure must kill JVM regardless of failure policy 
 StorageService . instance . registerDaemon ( daemon ) ; 
 
 - / / let ' s make the commit log directory non - writable 
 - File commitLogDir = new File ( DatabaseDescriptor . getCommitLogLocation ( ) ) ; 
 - commitLogDir . setWritable ( false ) ; 
 - 
 KillerForTests killerForTests = new KillerForTests ( ) ; 
 JVMStabilityInspector . Killer originalKiller = JVMStabilityInspector . replaceKiller ( killerForTests ) ; 
 Config . CommitFailurePolicy oldPolicy = DatabaseDescriptor . getCommitFailurePolicy ( ) ; 
 try 
 { 
 DatabaseDescriptor . setCommitFailurePolicy ( Config . CommitFailurePolicy . ignore ) ; 
 - 
 - / / now let ' s create a commit log segment manager and wait for it to fail 
 - new CommitLogSegmentManager ( CommitLog . instance ) ; 
 - 
 - / / wait commit log segment manager thread to execute 
 - Thread . sleep ( 50 ) ; 
 - 
 + CommitLog . handleCommitError ( " Testing ignore policy " , new Throwable ( ) ) ; 
 / / error policy is set to IGNORE , so JVM must not be killed if error ocurs after startup 
 Assert . assertFalse ( killerForTests . wasKilled ( ) ) ; 
 } 
 @ @ - 189 , 7 + 136 , 6 @ @ public class CommitLogFailurePolicyTest 
 { 
 DatabaseDescriptor . setCommitFailurePolicy ( oldPolicy ) ; 
 JVMStabilityInspector . replaceKiller ( originalKiller ) ; 
 - commitLogDir . setWritable ( true ) ; 
 } 
 } 
 }

NEAREST DIFF:
ELIMINATEDSENTENCE
