BLEU SCORE: 0.08310415003234632

TEST MSG: remove dead code
GENERATED MSG: r / m @ author tags

TEST DIFF (one line): diff - - git a / test / unit / org / apache / cassandra / SchemaLoader . java b / test / unit / org / apache / cassandra / SchemaLoader . java <nl> index 90dc629 . . df74108 100644 <nl> - - - a / test / unit / org / apache / cassandra / SchemaLoader . java <nl> + + + b / test / unit / org / apache / cassandra / SchemaLoader . java <nl> @ @ - 34 , 7 + 34 , 6 @ @ import org . apache . cassandra . cql3 . ColumnIdentifier ; <nl> import org . apache . cassandra . db . * ; <nl> import org . apache . cassandra . db . commitlog . CommitLog ; <nl> import org . apache . cassandra . db . compaction . LeveledCompactionStrategy ; <nl> - import org . apache . cassandra . db . filter . QueryFilter ; <nl> import org . apache . cassandra . db . marshal . * ; <nl> import org . apache . cassandra . exceptions . ConfigurationException ; <nl> import org . apache . cassandra . gms . Gossiper ; <nl> @ @ - 51 , 12 + 50 , 12 @ @ public class SchemaLoader <nl> private static Logger logger = LoggerFactory . getLogger ( SchemaLoader . class ) ; <nl> <nl> @ BeforeClass <nl> - public static void loadSchema ( ) throws IOException , ConfigurationException <nl> + public static void loadSchema ( ) throws ConfigurationException <nl> { <nl> loadSchema ( false ) ; <nl> } <nl> <nl> - public static void loadSchema ( boolean withOldCfIds ) throws IOException , ConfigurationException <nl> + public static void loadSchema ( boolean withOldCfIds ) throws ConfigurationException <nl> { <nl> / / Cleanup first <nl> cleanupAndLeaveDirs ( ) ; <nl> @ @ - 115 , 8 + 114 , 6 @ @ public class SchemaLoader <nl> Map < String , String > opts _ rf3 = KSMetaData . optsWithRF ( 3 ) ; <nl> Map < String , String > opts _ rf5 = KSMetaData . optsWithRF ( 5 ) ; <nl> <nl> - ColumnFamilyType st = ColumnFamilyType . Standard ; <nl> - ColumnFamilyType su = ColumnFamilyType . Super ; <nl> AbstractType bytes = BytesType . instance ; <nl> <nl> AbstractType < ? > composite = CompositeType . getInstance ( Arrays . asList ( new AbstractType < ? > [ ] { BytesType . instance , TimeUUIDType . instance , IntegerType . instance } ) ) ; <nl> @ @ - 397 , 7 + 394 , 7 @ @ public class SchemaLoader <nl> DatabaseDescriptor . createAllDirectories ( ) ; <nl> } <nl> <nl> - protected void insertData ( String keyspace , String columnFamily , int offset , int numberOfRows ) throws IOException <nl> + protected void insertData ( String keyspace , String columnFamily , int offset , int numberOfRows ) <nl> { <nl> for ( int i = offset ; i < offset + numberOfRows ; i + + ) <nl> { <nl> @ @ - 409 , 7 + 406 , 7 @ @ public class SchemaLoader <nl> } <nl> <nl> / * usually used to populate the cache * / <nl> - protected void readData ( String keyspace , String columnFamily , int offset , int numberOfRows ) throws IOException <nl> + protected void readData ( String keyspace , String columnFamily , int offset , int numberOfRows ) <nl> { <nl> ColumnFamilyStore store = Keyspace . open ( keyspace ) . getColumnFamilyStore ( columnFamily ) ; <nl> for ( int i = offset ; i < offset + numberOfRows ; i + + ) <nl> diff - - git a / test / unit / org / apache / cassandra / db / SerializationsTest . java b / test / unit / org / apache / cassandra / db / SerializationsTest . java <nl> index e3a6077 . . 983a8f7 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / SerializationsTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / SerializationsTest . java <nl> @ @ - 50 , 7 + 50 , 7 @ @ public class SerializationsTest extends AbstractSerializationsTester <nl> Statics statics = new Statics ( ) ; <nl> <nl> @ BeforeClass <nl> - public static void loadSchema ( ) throws IOException , ConfigurationException <nl> + public static void loadSchema ( ) throws ConfigurationException <nl> { <nl> loadSchema ( true ) ; <nl> }
NEAREST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / db / compaction / CompactionController . java b / src / java / org / apache / cassandra / db / compaction / CompactionController . java <nl> index c7d5501 . . 085b043 100644 <nl> - - - a / src / java / org / apache / cassandra / db / compaction / CompactionController . java <nl> + + + b / src / java / org / apache / cassandra / db / compaction / CompactionController . java <nl> @ @ - 46 , 6 + 46 , 7 @ @ public class CompactionController <nl> <nl> public final boolean isMajor ; <nl> public final int gcBefore ; <nl> + private int throttleResolution ; <nl> <nl> public CompactionController ( ColumnFamilyStore cfs , Collection < SSTableReader > sstables , int gcBefore , boolean forceDeserialize ) <nl> { <nl> @ @ - 55 , 15 + 56 , 22 @ @ public class CompactionController <nl> this . gcBefore = gcBefore ; <nl> this . forceDeserialize = forceDeserialize ; <nl> isMajor = cfs . isCompleteSSTables ( this . sstables ) ; <nl> + / / how many rows we expect to compact in 100ms <nl> + throttleResolution = ( int ) ( DatabaseDescriptor . getCompactionThroughputMbPerSec ( ) * 1024 * 1024 / ( 10 * cfs . getMeanRowSize ( ) ) ) ; <nl> + if ( throttleResolution < = 0 ) <nl> + throttleResolution = 1 ; <nl> + } <nl> + <nl> + public int getThrottleResolution ( ) <nl> + { <nl> + return throttleResolution ; <nl> } <nl> <nl> - / * * @ return the keyspace name * / <nl> public String getKeyspace ( ) <nl> { <nl> return cfs . table . name ; <nl> } <nl> <nl> - / * * @ return the column family name * / <nl> public String getColumnFamily ( ) <nl> { <nl> return cfs . columnFamily ; <nl> diff - - git a / src / java / org / apache / cassandra / db / compaction / CompactionIterator . java b / src / java / org / apache / cassandra / db / compaction / CompactionIterator . java <nl> index 4b1013b . . ad162aa 100644 <nl> - - - a / src / java / org / apache / cassandra / db / compaction / CompactionIterator . java <nl> + + + b / src / java / org / apache / cassandra / db / compaction / CompactionIterator . java <nl> @ @ - 137 , 13 + 137 , 11 @ @ implements Closeable , CompactionInfo . Holder <nl> finally <nl> { <nl> rows . clear ( ) ; <nl> - if ( ( row + + % 1000 ) = = 0 ) <nl> + if ( ( row + + % controller . getThrottleResolution ( ) ) = = 0 ) <nl> { <nl> bytesRead = 0 ; <nl> for ( SSTableScanner scanner : getScanners ( ) ) <nl> - { <nl> bytesRead + = scanner . getFilePointer ( ) ; <nl> - } <nl> throttle ( ) ; <nl> } <nl> } <nl> @ @ - 164 , 9 + 162 , 7 @ @ implements Closeable , CompactionInfo . Holder <nl> int newTarget = totalBytesPerMS / <nl> Math . max ( 1 , CompactionManager . instance . getActiveCompactions ( ) ) ; <nl> if ( newTarget ! = targetBytesPerMS ) <nl> - logger . info ( String . format ( " % s now compacting at % d bytes / ms . " , <nl> - this , <nl> - newTarget ) ) ; <nl> + logger . debug ( " { } now compacting at { } bytes / ms . " , this , newTarget ) ; <nl> targetBytesPerMS = newTarget ; <nl> <nl> / / the excess bytes that were compacted in this period <nl> @ @ - 179 , 7 + 175 , 14 @ @ implements Closeable , CompactionInfo . Holder <nl> if ( logger . isTraceEnabled ( ) ) <nl> logger . trace ( String . format ( " Compacted % d bytes in % d ms : throttling for % d ms " , <nl> bytesSinceLast , msSinceLast , timeToDelay ) ) ; <nl> - try { Thread . sleep ( timeToDelay ) ; } catch ( InterruptedException e ) { throw new AssertionError ( e ) ; } <nl> + try <nl> + { <nl> + Thread . sleep ( timeToDelay ) ; <nl> + } <nl> + catch ( InterruptedException e ) <nl> + { <nl> + throw new AssertionError ( e ) ; <nl> + } <nl> } <nl> bytesAtLastDelay = bytesRead ; <nl> timeAtLastDelay = System . currentTimeMillis ( ) ;

TEST DIFF:
diff - - git a / test / unit / org / apache / cassandra / SchemaLoader . java b / test / unit / org / apache / cassandra / SchemaLoader . java 
 index 90dc629 . . df74108 100644 
 - - - a / test / unit / org / apache / cassandra / SchemaLoader . java 
 + + + b / test / unit / org / apache / cassandra / SchemaLoader . java 
 @ @ - 34 , 7 + 34 , 6 @ @ import org . apache . cassandra . cql3 . ColumnIdentifier ; 
 import org . apache . cassandra . db . * ; 
 import org . apache . cassandra . db . commitlog . CommitLog ; 
 import org . apache . cassandra . db . compaction . LeveledCompactionStrategy ; 
 - import org . apache . cassandra . db . filter . QueryFilter ; 
 import org . apache . cassandra . db . marshal . * ; 
 import org . apache . cassandra . exceptions . ConfigurationException ; 
 import org . apache . cassandra . gms . Gossiper ; 
 @ @ - 51 , 12 + 50 , 12 @ @ public class SchemaLoader 
 private static Logger logger = LoggerFactory . getLogger ( SchemaLoader . class ) ; 
 
 @ BeforeClass 
 - public static void loadSchema ( ) throws IOException , ConfigurationException 
 + public static void loadSchema ( ) throws ConfigurationException 
 { 
 loadSchema ( false ) ; 
 } 
 
 - public static void loadSchema ( boolean withOldCfIds ) throws IOException , ConfigurationException 
 + public static void loadSchema ( boolean withOldCfIds ) throws ConfigurationException 
 { 
 / / Cleanup first 
 cleanupAndLeaveDirs ( ) ; 
 @ @ - 115 , 8 + 114 , 6 @ @ public class SchemaLoader 
 Map < String , String > opts _ rf3 = KSMetaData . optsWithRF ( 3 ) ; 
 Map < String , String > opts _ rf5 = KSMetaData . optsWithRF ( 5 ) ; 
 
 - ColumnFamilyType st = ColumnFamilyType . Standard ; 
 - ColumnFamilyType su = ColumnFamilyType . Super ; 
 AbstractType bytes = BytesType . instance ; 
 
 AbstractType < ? > composite = CompositeType . getInstance ( Arrays . asList ( new AbstractType < ? > [ ] { BytesType . instance , TimeUUIDType . instance , IntegerType . instance } ) ) ; 
 @ @ - 397 , 7 + 394 , 7 @ @ public class SchemaLoader 
 DatabaseDescriptor . createAllDirectories ( ) ; 
 } 
 
 - protected void insertData ( String keyspace , String columnFamily , int offset , int numberOfRows ) throws IOException 
 + protected void insertData ( String keyspace , String columnFamily , int offset , int numberOfRows ) 
 { 
 for ( int i = offset ; i < offset + numberOfRows ; i + + ) 
 { 
 @ @ - 409 , 7 + 406 , 7 @ @ public class SchemaLoader 
 } 
 
 / * usually used to populate the cache * / 
 - protected void readData ( String keyspace , String columnFamily , int offset , int numberOfRows ) throws IOException 
 + protected void readData ( String keyspace , String columnFamily , int offset , int numberOfRows ) 
 { 
 ColumnFamilyStore store = Keyspace . open ( keyspace ) . getColumnFamilyStore ( columnFamily ) ; 
 for ( int i = offset ; i < offset + numberOfRows ; i + + ) 
 diff - - git a / test / unit / org / apache / cassandra / db / SerializationsTest . java b / test / unit / org / apache / cassandra / db / SerializationsTest . java 
 index e3a6077 . . 983a8f7 100644 
 - - - a / test / unit / org / apache / cassandra / db / SerializationsTest . java 
 + + + b / test / unit / org / apache / cassandra / db / SerializationsTest . java 
 @ @ - 50 , 7 + 50 , 7 @ @ public class SerializationsTest extends AbstractSerializationsTester 
 Statics statics = new Statics ( ) ; 
 
 @ BeforeClass 
 - public static void loadSchema ( ) throws IOException , ConfigurationException 
 + public static void loadSchema ( ) throws ConfigurationException 
 { 
 loadSchema ( true ) ; 
 }

NEAREST DIFF:
diff - - git a / src / java / org / apache / cassandra / db / compaction / CompactionController . java b / src / java / org / apache / cassandra / db / compaction / CompactionController . java 
 index c7d5501 . . 085b043 100644 
 - - - a / src / java / org / apache / cassandra / db / compaction / CompactionController . java 
 + + + b / src / java / org / apache / cassandra / db / compaction / CompactionController . java 
 @ @ - 46 , 6 + 46 , 7 @ @ public class CompactionController 
 
 public final boolean isMajor ; 
 public final int gcBefore ; 
 + private int throttleResolution ; 
 
 public CompactionController ( ColumnFamilyStore cfs , Collection < SSTableReader > sstables , int gcBefore , boolean forceDeserialize ) 
 { 
 @ @ - 55 , 15 + 56 , 22 @ @ public class CompactionController 
 this . gcBefore = gcBefore ; 
 this . forceDeserialize = forceDeserialize ; 
 isMajor = cfs . isCompleteSSTables ( this . sstables ) ; 
 + / / how many rows we expect to compact in 100ms 
 + throttleResolution = ( int ) ( DatabaseDescriptor . getCompactionThroughputMbPerSec ( ) * 1024 * 1024 / ( 10 * cfs . getMeanRowSize ( ) ) ) ; 
 + if ( throttleResolution < = 0 ) 
 + throttleResolution = 1 ; 
 + } 
 + 
 + public int getThrottleResolution ( ) 
 + { 
 + return throttleResolution ; 
 } 
 
 - / * * @ return the keyspace name * / 
 public String getKeyspace ( ) 
 { 
 return cfs . table . name ; 
 } 
 
 - / * * @ return the column family name * / 
 public String getColumnFamily ( ) 
 { 
 return cfs . columnFamily ; 
 diff - - git a / src / java / org / apache / cassandra / db / compaction / CompactionIterator . java b / src / java / org / apache / cassandra / db / compaction / CompactionIterator . java 
 index 4b1013b . . ad162aa 100644 
 - - - a / src / java / org / apache / cassandra / db / compaction / CompactionIterator . java 
 + + + b / src / java / org / apache / cassandra / db / compaction / CompactionIterator . java 
 @ @ - 137 , 13 + 137 , 11 @ @ implements Closeable , CompactionInfo . Holder 
 finally 
 { 
 rows . clear ( ) ; 
 - if ( ( row + + % 1000 ) = = 0 ) 
 + if ( ( row + + % controller . getThrottleResolution ( ) ) = = 0 ) 
 { 
 bytesRead = 0 ; 
 for ( SSTableScanner scanner : getScanners ( ) ) 
 - { 
 bytesRead + = scanner . getFilePointer ( ) ; 
 - } 
 throttle ( ) ; 
 } 
 } 
 @ @ - 164 , 9 + 162 , 7 @ @ implements Closeable , CompactionInfo . Holder 
 int newTarget = totalBytesPerMS / 
 Math . max ( 1 , CompactionManager . instance . getActiveCompactions ( ) ) ; 
 if ( newTarget ! = targetBytesPerMS ) 
 - logger . info ( String . format ( " % s now compacting at % d bytes / ms . " , 
 - this , 
 - newTarget ) ) ; 
 + logger . debug ( " { } now compacting at { } bytes / ms . " , this , newTarget ) ; 
 targetBytesPerMS = newTarget ; 
 
 / / the excess bytes that were compacted in this period 
 @ @ - 179 , 7 + 175 , 14 @ @ implements Closeable , CompactionInfo . Holder 
 if ( logger . isTraceEnabled ( ) ) 
 logger . trace ( String . format ( " Compacted % d bytes in % d ms : throttling for % d ms " , 
 bytesSinceLast , msSinceLast , timeToDelay ) ) ; 
 - try { Thread . sleep ( timeToDelay ) ; } catch ( InterruptedException e ) { throw new AssertionError ( e ) ; } 
 + try 
 + { 
 + Thread . sleep ( timeToDelay ) ; 
 + } 
 + catch ( InterruptedException e ) 
 + { 
 + throw new AssertionError ( e ) ; 
 + } 
 } 
 bytesAtLastDelay = bytesRead ; 
 timeAtLastDelay = System . currentTimeMillis ( ) ;
