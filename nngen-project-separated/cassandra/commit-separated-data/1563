BLEU SCORE: 0.0064958374044742275

TEST MSG: Ninja fix CommitLogStressTest . testRandomSize
GENERATED MSG: avoid replaying fully - flushed commitlog segments . patch by jbellis ; reviewed by mdennis for CASSANDRA - 1298

TEST DIFF (one line): diff - - git a / test / long / org / apache / cassandra / db / commitlog / CommitLogStressTest . java b / test / long / org / apache / cassandra / db / commitlog / CommitLogStressTest . java <nl> index ba8896f . . f5fd2cf 100644 <nl> - - - a / test / long / org / apache / cassandra / db / commitlog / CommitLogStressTest . java <nl> + + + b / test / long / org / apache / cassandra / db / commitlog / CommitLogStressTest . java <nl> @ @ - 161 , 7 + 161 , 7 @ @ public class CommitLogStressTest <nl> @ Test <nl> public void testRandomSize ( ) throws Exception <nl> { <nl> - randomSize = false ; <nl> + randomSize = true ; <nl> discardedRun = false ; <nl> testAllLogConfigs ( ) ; <nl> }
NEAREST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / db / commitlog / CommitLog . java b / src / java / org / apache / cassandra / db / commitlog / CommitLog . java <nl> index 437bed4 . . d117dbc 100644 <nl> - - - a / src / java / org / apache / cassandra / db / commitlog / CommitLog . java <nl> + + + b / src / java / org / apache / cassandra / db / commitlog / CommitLog . java <nl> @ @ - 203 , 6 + 203 , 11 @ @ public class CommitLog <nl> logger . info ( headerPath + " incomplete , missing or corrupt . Everything is ok , don ' t panic . CommitLog will be replayed from the beginning " ) ; <nl> logger . debug ( " exception was " , ioe ) ; <nl> } <nl> + if ( replayPosition < 0 ) <nl> + { <nl> + logger . debug ( " skipping replay of fully - flushed { } " , file ) ; <nl> + continue ; <nl> + } <nl> reader . seek ( replayPosition ) ; <nl> <nl> if ( logger . isDebugEnabled ( ) ) <nl> diff - - git a / src / java / org / apache / cassandra / db / commitlog / CommitLogHeader . java b / src / java / org / apache / cassandra / db / commitlog / CommitLogHeader . java <nl> index 2b7d75f . . 2f02bf3 100644 <nl> - - - a / src / java / org / apache / cassandra / db / commitlog / CommitLogHeader . java <nl> + + + b / src / java / org / apache / cassandra / db / commitlog / CommitLogHeader . java <nl> @ @ - 147 , 7 + 147 , 7 @ @ public class CommitLogHeader <nl> <nl> int getReplayPosition ( ) <nl> { <nl> - return cfDirtiedAt . isEmpty ( ) ? 0 : Collections . min ( cfDirtiedAt . values ( ) ) ; <nl> + return cfDirtiedAt . isEmpty ( ) ? - 1 : Collections . min ( cfDirtiedAt . values ( ) ) ; <nl> } <nl> <nl> static class CommitLogHeaderSerializer implements ICompactSerializer2 < CommitLogHeader > <nl> diff - - git a / test / unit / org / apache / cassandra / db / commitlog / CommitLogHeaderTest . java b / test / unit / org / apache / cassandra / db / commitlog / CommitLogHeaderTest . java <nl> index 35b2ffe . . 6c1276e 100644 <nl> - - - a / test / unit / org / apache / cassandra / db / commitlog / CommitLogHeaderTest . java <nl> + + + b / test / unit / org / apache / cassandra / db / commitlog / CommitLogHeaderTest . java <nl> @ @ - 33 , 7 + 33 , 7 @ @ public class CommitLogHeaderTest extends SchemaLoader <nl> public void testEmptyHeader ( ) <nl> { <nl> CommitLogHeader clh = new CommitLogHeader ( ) ; <nl> - assert clh . getReplayPosition ( ) = = 0 ; <nl> + assert clh . getReplayPosition ( ) < 0 ; <nl> } <nl> <nl> @ Test <nl> @ @ - 47 , 14 + 47 , 7 @ @ public class CommitLogHeaderTest extends SchemaLoader <nl> clh . turnOn ( 65 , 2 ) ; <nl> assert clh . getReplayPosition ( ) = = 0 ; <nl> } <nl> - <nl> - @ Test <nl> - public void lowestPositionEmpty ( ) <nl> - { <nl> - CommitLogHeader clh = new CommitLogHeader ( ) ; <nl> - assert clh . getReplayPosition ( ) = = 0 ; <nl> - } <nl> - <nl> + <nl> @ Test <nl> public void constantSize ( ) throws IOException <nl> {

TEST DIFF:
diff - - git a / test / long / org / apache / cassandra / db / commitlog / CommitLogStressTest . java b / test / long / org / apache / cassandra / db / commitlog / CommitLogStressTest . java 
 index ba8896f . . f5fd2cf 100644 
 - - - a / test / long / org / apache / cassandra / db / commitlog / CommitLogStressTest . java 
 + + + b / test / long / org / apache / cassandra / db / commitlog / CommitLogStressTest . java 
 @ @ - 161 , 7 + 161 , 7 @ @ public class CommitLogStressTest 
 @ Test 
 public void testRandomSize ( ) throws Exception 
 { 
 - randomSize = false ; 
 + randomSize = true ; 
 discardedRun = false ; 
 testAllLogConfigs ( ) ; 
 }

NEAREST DIFF:
diff - - git a / src / java / org / apache / cassandra / db / commitlog / CommitLog . java b / src / java / org / apache / cassandra / db / commitlog / CommitLog . java 
 index 437bed4 . . d117dbc 100644 
 - - - a / src / java / org / apache / cassandra / db / commitlog / CommitLog . java 
 + + + b / src / java / org / apache / cassandra / db / commitlog / CommitLog . java 
 @ @ - 203 , 6 + 203 , 11 @ @ public class CommitLog 
 logger . info ( headerPath + " incomplete , missing or corrupt . Everything is ok , don ' t panic . CommitLog will be replayed from the beginning " ) ; 
 logger . debug ( " exception was " , ioe ) ; 
 } 
 + if ( replayPosition < 0 ) 
 + { 
 + logger . debug ( " skipping replay of fully - flushed { } " , file ) ; 
 + continue ; 
 + } 
 reader . seek ( replayPosition ) ; 
 
 if ( logger . isDebugEnabled ( ) ) 
 diff - - git a / src / java / org / apache / cassandra / db / commitlog / CommitLogHeader . java b / src / java / org / apache / cassandra / db / commitlog / CommitLogHeader . java 
 index 2b7d75f . . 2f02bf3 100644 
 - - - a / src / java / org / apache / cassandra / db / commitlog / CommitLogHeader . java 
 + + + b / src / java / org / apache / cassandra / db / commitlog / CommitLogHeader . java 
 @ @ - 147 , 7 + 147 , 7 @ @ public class CommitLogHeader 
 
 int getReplayPosition ( ) 
 { 
 - return cfDirtiedAt . isEmpty ( ) ? 0 : Collections . min ( cfDirtiedAt . values ( ) ) ; 
 + return cfDirtiedAt . isEmpty ( ) ? - 1 : Collections . min ( cfDirtiedAt . values ( ) ) ; 
 } 
 
 static class CommitLogHeaderSerializer implements ICompactSerializer2 < CommitLogHeader > 
 diff - - git a / test / unit / org / apache / cassandra / db / commitlog / CommitLogHeaderTest . java b / test / unit / org / apache / cassandra / db / commitlog / CommitLogHeaderTest . java 
 index 35b2ffe . . 6c1276e 100644 
 - - - a / test / unit / org / apache / cassandra / db / commitlog / CommitLogHeaderTest . java 
 + + + b / test / unit / org / apache / cassandra / db / commitlog / CommitLogHeaderTest . java 
 @ @ - 33 , 7 + 33 , 7 @ @ public class CommitLogHeaderTest extends SchemaLoader 
 public void testEmptyHeader ( ) 
 { 
 CommitLogHeader clh = new CommitLogHeader ( ) ; 
 - assert clh . getReplayPosition ( ) = = 0 ; 
 + assert clh . getReplayPosition ( ) < 0 ; 
 } 
 
 @ Test 
 @ @ - 47 , 14 + 47 , 7 @ @ public class CommitLogHeaderTest extends SchemaLoader 
 clh . turnOn ( 65 , 2 ) ; 
 assert clh . getReplayPosition ( ) = = 0 ; 
 } 
 - 
 - @ Test 
 - public void lowestPositionEmpty ( ) 
 - { 
 - CommitLogHeader clh = new CommitLogHeader ( ) ; 
 - assert clh . getReplayPosition ( ) = = 0 ; 
 - } 
 - 
 + 
 @ Test 
 public void constantSize ( ) throws IOException 
 {
