BLEU SCORE: 0.08745825313180632

TEST MSG: merge from 2 . 0
GENERATED MSG: Allow deleting snapshots from dropped keyspaces

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 1fbf50c . . 21d4d5a 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 29 , 6 + 29 , 7 @ @ <nl> * Fix off - by - one error in stress ( CASSANDRA - 6883 ) <nl> * Make OpOrder AutoCloseable ( CASSANDRA - 6901 ) <nl> Merged from 2 . 0 : <nl> + * Allow deleting snapshots from dropped keyspaces ( CASSANDRA - 6821 ) <nl> * Add uuid ( ) function ( CASSANDRA - 6473 ) <nl> * Omit tombstones from schema digests ( CASSANDRA - 6862 ) <nl> * Include correct consistencyLevel in LWT timeout ( CASSANDRA - 6884 ) <nl> diff - - git a / src / java / org / apache / cassandra / db / Keyspace . java b / src / java / org / apache / cassandra / db / Keyspace . java <nl> index fabd433 . . d6746da 100644 <nl> - - - a / src / java / org / apache / cassandra / db / Keyspace . java <nl> + + + b / src / java / org / apache / cassandra / db / Keyspace . java <nl> @ @ - 237 , 9 + 237 , 9 @ @ public class Keyspace <nl> * @ param snapshotName the user supplied snapshot name . It empty or null , <nl> * all the snapshots will be cleaned <nl> * / <nl> - public void clearSnapshot ( String snapshotName ) <nl> + public static void clearSnapshot ( String snapshotName , String keyspace ) <nl> { <nl> - List < File > snapshotDirs = Directories . getKSChildDirectories ( getName ( ) ) ; <nl> + List < File > snapshotDirs = Directories . getKSChildDirectories ( keyspace ) ; <nl> Directories . clearSnapshot ( snapshotName , snapshotDirs ) ; <nl> } <nl> <nl> diff - - git a / src / java / org / apache / cassandra / service / SnapshotVerbHandler . java b / src / java / org / apache / cassandra / service / SnapshotVerbHandler . java <nl> index 2d393cf . . a997533 100644 <nl> - - - a / src / java / org / apache / cassandra / service / SnapshotVerbHandler . java <nl> + + + b / src / java / org / apache / cassandra / service / SnapshotVerbHandler . java <nl> @ @ - 35 , 7 + 35 , 9 @ @ public class SnapshotVerbHandler implements IVerbHandler < SnapshotCommand > <nl> { <nl> SnapshotCommand command = message . payload ; <nl> if ( command . clear _ snapshot ) <nl> - Keyspace . open ( command . keyspace ) . clearSnapshot ( command . snapshot _ name ) ; <nl> + { <nl> + Keyspace . clearSnapshot ( command . snapshot _ name , command . keyspace ) ; <nl> + } <nl> else <nl> Keyspace . open ( command . keyspace ) . getColumnFamilyStore ( command . column _ family ) . snapshot ( command . snapshot _ name ) ; <nl> logger . debug ( " Enqueuing response to snapshot request { } to { } " , command . snapshot _ name , message . from ) ; <nl> diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java <nl> index 6d49a8f . . 16d8628 100644 <nl> - - - a / src / java / org / apache / cassandra / service / StorageService . java <nl> + + + b / src / java / org / apache / cassandra / service / StorageService . java <nl> @ @ - 2298 , 21 + 2298 , 20 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE <nl> if ( tag = = null ) <nl> tag = " " ; <nl> <nl> - Iterable < Keyspace > keyspaces ; <nl> - if ( keyspaceNames . length = = 0 ) <nl> - { <nl> - keyspaces = Keyspace . all ( ) ; <nl> - } <nl> - else <nl> + Set < String > keyspaces = new HashSet < > ( ) ; <nl> + for ( String dataDir : DatabaseDescriptor . getAllDataFileLocations ( ) ) <nl> { <nl> - ArrayList < Keyspace > tempKeyspaces = new ArrayList < Keyspace > ( keyspaceNames . length ) ; <nl> - for ( String keyspaceName : keyspaceNames ) <nl> - tempKeyspaces . add ( getValidKeyspace ( keyspaceName ) ) ; <nl> - keyspaces = tempKeyspaces ; <nl> + for ( String keyspaceDir : new File ( dataDir ) . list ( ) ) <nl> + { <nl> + / / Only add a ks if it has been specified as a param , assuming params were actually provided . <nl> + if ( keyspaceNames . length > 0 & & ! Arrays . asList ( keyspaceNames ) . contains ( keyspaceDir ) ) <nl> + continue ; <nl> + keyspaces . add ( keyspaceDir ) ; <nl> + } <nl> } <nl> <nl> - for ( Keyspace keyspace : keyspaces ) <nl> - keyspace . clearSnapshot ( tag ) ; <nl> + for ( String keyspace : keyspaces ) <nl> + Keyspace . clearSnapshot ( tag , keyspace ) ; <nl> <nl> if ( logger . isDebugEnabled ( ) ) <nl> logger . debug ( " Cleared out snapshot directories " ) ;
NEAREST DIFF (one line): ELIMINATEDSENTENCE

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 1fbf50c . . 21d4d5a 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 29 , 6 + 29 , 7 @ @ 
 * Fix off - by - one error in stress ( CASSANDRA - 6883 ) 
 * Make OpOrder AutoCloseable ( CASSANDRA - 6901 ) 
 Merged from 2 . 0 : 
 + * Allow deleting snapshots from dropped keyspaces ( CASSANDRA - 6821 ) 
 * Add uuid ( ) function ( CASSANDRA - 6473 ) 
 * Omit tombstones from schema digests ( CASSANDRA - 6862 ) 
 * Include correct consistencyLevel in LWT timeout ( CASSANDRA - 6884 ) 
 diff - - git a / src / java / org / apache / cassandra / db / Keyspace . java b / src / java / org / apache / cassandra / db / Keyspace . java 
 index fabd433 . . d6746da 100644 
 - - - a / src / java / org / apache / cassandra / db / Keyspace . java 
 + + + b / src / java / org / apache / cassandra / db / Keyspace . java 
 @ @ - 237 , 9 + 237 , 9 @ @ public class Keyspace 
 * @ param snapshotName the user supplied snapshot name . It empty or null , 
 * all the snapshots will be cleaned 
 * / 
 - public void clearSnapshot ( String snapshotName ) 
 + public static void clearSnapshot ( String snapshotName , String keyspace ) 
 { 
 - List < File > snapshotDirs = Directories . getKSChildDirectories ( getName ( ) ) ; 
 + List < File > snapshotDirs = Directories . getKSChildDirectories ( keyspace ) ; 
 Directories . clearSnapshot ( snapshotName , snapshotDirs ) ; 
 } 
 
 diff - - git a / src / java / org / apache / cassandra / service / SnapshotVerbHandler . java b / src / java / org / apache / cassandra / service / SnapshotVerbHandler . java 
 index 2d393cf . . a997533 100644 
 - - - a / src / java / org / apache / cassandra / service / SnapshotVerbHandler . java 
 + + + b / src / java / org / apache / cassandra / service / SnapshotVerbHandler . java 
 @ @ - 35 , 7 + 35 , 9 @ @ public class SnapshotVerbHandler implements IVerbHandler < SnapshotCommand > 
 { 
 SnapshotCommand command = message . payload ; 
 if ( command . clear _ snapshot ) 
 - Keyspace . open ( command . keyspace ) . clearSnapshot ( command . snapshot _ name ) ; 
 + { 
 + Keyspace . clearSnapshot ( command . snapshot _ name , command . keyspace ) ; 
 + } 
 else 
 Keyspace . open ( command . keyspace ) . getColumnFamilyStore ( command . column _ family ) . snapshot ( command . snapshot _ name ) ; 
 logger . debug ( " Enqueuing response to snapshot request { } to { } " , command . snapshot _ name , message . from ) ; 
 diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java 
 index 6d49a8f . . 16d8628 100644 
 - - - a / src / java / org / apache / cassandra / service / StorageService . java 
 + + + b / src / java / org / apache / cassandra / service / StorageService . java 
 @ @ - 2298 , 21 + 2298 , 20 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE 
 if ( tag = = null ) 
 tag = " " ; 
 
 - Iterable < Keyspace > keyspaces ; 
 - if ( keyspaceNames . length = = 0 ) 
 - { 
 - keyspaces = Keyspace . all ( ) ; 
 - } 
 - else 
 + Set < String > keyspaces = new HashSet < > ( ) ; 
 + for ( String dataDir : DatabaseDescriptor . getAllDataFileLocations ( ) ) 
 { 
 - ArrayList < Keyspace > tempKeyspaces = new ArrayList < Keyspace > ( keyspaceNames . length ) ; 
 - for ( String keyspaceName : keyspaceNames ) 
 - tempKeyspaces . add ( getValidKeyspace ( keyspaceName ) ) ; 
 - keyspaces = tempKeyspaces ; 
 + for ( String keyspaceDir : new File ( dataDir ) . list ( ) ) 
 + { 
 + / / Only add a ks if it has been specified as a param , assuming params were actually provided . 
 + if ( keyspaceNames . length > 0 & & ! Arrays . asList ( keyspaceNames ) . contains ( keyspaceDir ) ) 
 + continue ; 
 + keyspaces . add ( keyspaceDir ) ; 
 + } 
 } 
 
 - for ( Keyspace keyspace : keyspaces ) 
 - keyspace . clearSnapshot ( tag ) ; 
 + for ( String keyspace : keyspaces ) 
 + Keyspace . clearSnapshot ( tag , keyspace ) ; 
 
 if ( logger . isDebugEnabled ( ) ) 
 logger . debug ( " Cleared out snapshot directories " ) ;

NEAREST DIFF:
ELIMINATEDSENTENCE
