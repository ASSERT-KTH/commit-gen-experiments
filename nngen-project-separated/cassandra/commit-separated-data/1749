BLEU SCORE: 0.04266709328925954

TEST MSG: use parameterized logging
GENERATED MSG: fix broadcastAddress and fix for Ec2MultiRegionSnitch . reconnect

TEST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / dht / RangeStreamer . java b / src / java / org / apache / cassandra / dht / RangeStreamer . java <nl> index fecb308 . . 68c8a11 100644 <nl> - - - a / src / java / org / apache / cassandra / dht / RangeStreamer . java <nl> + + + b / src / java / org / apache / cassandra / dht / RangeStreamer . java <nl> @ @ - 336 , 7 + 336 , 7 @ @ public class RangeStreamer <nl> Set < Range < Token > > availableRanges = stateStore . getAvailableRanges ( keyspace , StorageService . getPartitioner ( ) ) ; <nl> if ( ranges . removeAll ( availableRanges ) ) <nl> { <nl> - logger . info ( availableRanges + " already available . Skipping streaming . " ) ; <nl> + logger . info ( " Some ranges of { } are already available . Skipping streaming those ranges . " , availableRanges ) ; <nl> } <nl> <nl> if ( logger . isDebugEnabled ( ) ) <nl> diff - - git a / src / java / org / apache / cassandra / gms / Gossiper . java b / src / java / org / apache / cassandra / gms / Gossiper . java <nl> index 07f2615 . . 34f54a1 100644 <nl> - - - a / src / java / org / apache / cassandra / gms / Gossiper . java <nl> + + + b / src / java / org / apache / cassandra / gms / Gossiper . java <nl> @ @ - 925 , 7 + 925 , 7 @ @ public class Gossiper implements IFailureDetectionEventListener , GossiperMBean <nl> for ( IEndpointStateChangeSubscriber subscriber : subscribers ) <nl> subscriber . onAlive ( addr , localState ) ; <nl> if ( logger . isTraceEnabled ( ) ) <nl> - logger . trace ( " Notified " + subscribers ) ; <nl> + logger . trace ( " Notified { } " , subscribers ) ; <nl> } <nl> <nl> private void markDead ( InetAddress addr , EndpointState localState ) <nl> diff - - git a / src / java / org / apache / cassandra / net / OutboundTcpConnection . java b / src / java / org / apache / cassandra / net / OutboundTcpConnection . java <nl> index 9ea4660 . . dc43106 100644 <nl> - - - a / src / java / org / apache / cassandra / net / OutboundTcpConnection . java <nl> + + + b / src / java / org / apache / cassandra / net / OutboundTcpConnection . java <nl> @ @ - 94 , 7 + 94 , 7 @ @ public class OutboundTcpConnection extends Thread <nl> case " MOVINGAVERAGE " : <nl> case " FIXED " : <nl> case " DISABLED " : <nl> - logger . info ( " OutboundTcpConnection using coalescing strategy " + strategy ) ; <nl> + logger . info ( " OutboundTcpConnection using coalescing strategy { } " , strategy ) ; <nl> break ; <nl> default : <nl> / / Check that it can be loaded <nl> @ @ - 103 , 7 + 103 , 7 @ @ public class OutboundTcpConnection extends Thread <nl> <nl> int coalescingWindow = DatabaseDescriptor . getOtcCoalescingWindow ( ) ; <nl> if ( coalescingWindow ! = Config . otc _ coalescing _ window _ us _ default ) <nl> - logger . info ( " OutboundTcpConnection coalescing window set to " + coalescingWindow + " μ s " ) ; <nl> + logger . info ( " OutboundTcpConnection coalescing window set to { } μ s " , coalescingWindow ) ; <nl> <nl> if ( coalescingWindow < 0 ) <nl> throw new ExceptionInInitializerError ( <nl> diff - - git a / src / java / org / apache / cassandra / utils / CoalescingStrategies . java b / src / java / org / apache / cassandra / utils / CoalescingStrategies . java <nl> index ca1399b . . 7dba97b 100644 <nl> - - - a / src / java / org / apache / cassandra / utils / CoalescingStrategies . java <nl> + + + b / src / java / org / apache / cassandra / utils / CoalescingStrategies . java <nl> @ @ - 169 , 7 + 169 , 7 @ @ public class CoalescingStrategies <nl> if ( DEBUG _ COALESCING & & shouldLogAverage ) <nl> { <nl> shouldLogAverage = false ; <nl> - logger . info ( toString ( ) + " gap " + TimeUnit . NANOSECONDS . toMicros ( averageGap ) + " μ s " ) ; <nl> + logger . info ( " { } gap { } μ s " , this , TimeUnit . NANOSECONDS . toMicros ( averageGap ) ) ; <nl> } <nl> } <nl>
NEAREST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / cli / CliClient . java b / src / java / org / apache / cassandra / cli / CliClient . java <nl> index 4ffa3e9 . . 3f6fa9d 100644 <nl> - - - a / src / java / org / apache / cassandra / cli / CliClient . java <nl> + + + b / src / java / org / apache / cassandra / cli / CliClient . java <nl> @ @ - 1150 , 15 + 1150 , 7 @ @ public class CliClient <nl> { <nl> SimpleSnitch snitch = new SimpleSnitch ( ) ; <nl> Map < String , String > options = new HashMap < String , String > ( ) ; <nl> - <nl> - try <nl> - { <nl> - options . put ( snitch . getDatacenter ( InetAddress . getLocalHost ( ) ) , " 1 " ) ; <nl> - } <nl> - catch ( UnknownHostException e ) <nl> - { <nl> - throw new RuntimeException ( e ) ; <nl> - } <nl> + options . put ( snitch . getDatacenter ( FBUtilities . getBroadcastAddress ( ) ) , " 1 " ) ; <nl> <nl> ksDef . setStrategy _ options ( options ) ; <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / db / SystemTable . java b / src / java / org / apache / cassandra / db / SystemTable . java <nl> index 58ff41e . . b0b5c60 100644 <nl> - - - a / src / java / org / apache / cassandra / db / SystemTable . java <nl> + + + b / src / java / org / apache / cassandra / db / SystemTable . java <nl> @ @ - 143 , 7 + 143 , 7 @ @ public class SystemTable <nl> * / <nl> public static synchronized void updateToken ( InetAddress ep , Token token ) <nl> { <nl> - if ( ep = = FBUtilities . getLocalAddress ( ) ) <nl> + if ( ep = = FBUtilities . getBroadcastAddress ( ) ) <nl> { <nl> removeToken ( token ) ; <nl> return ; <nl> diff - - git a / src / java / org / apache / cassandra / gms / Gossiper . java b / src / java / org / apache / cassandra / gms / Gossiper . java <nl> index 27a1ba7 . . 9f73717 100644 <nl> - - - a / src / java / org / apache / cassandra / gms / Gossiper . java <nl> + + + b / src / java / org / apache / cassandra / gms / Gossiper . java <nl> @ @ - 1090 , 7 + 1090 , 7 @ @ public class Gossiper implements IFailureDetectionEventListener , GossiperMBean <nl> * / <nl> public void addSavedEndpoint ( InetAddress ep ) <nl> { <nl> - if ( ep = = FBUtilities . getLocalAddress ( ) ) <nl> + if ( ep = = FBUtilities . getBroadcastAddress ( ) ) <nl> { <nl> logger . debug ( " Attempt to add self as saved endpoint " ) ; <nl> return ; <nl> diff - - git a / src / java / org / apache / cassandra / net / OutboundTcpConnection . java b / src / java / org / apache / cassandra / net / OutboundTcpConnection . java <nl> index e920aae . . f9d866d 100644 <nl> - - - a / src / java / org / apache / cassandra / net / OutboundTcpConnection . java <nl> + + + b / src / java / org / apache / cassandra / net / OutboundTcpConnection . java <nl> @ @ - 86 , 6 + 86 , 11 @ @ public class OutboundTcpConnection extends Thread <nl> enqueue ( CLOSE _ SENTINEL , null ) ; <nl> } <nl> <nl> + void softCloseSocket ( ) <nl> + { <nl> + enqueue ( CLOSE _ SENTINEL , null ) ; <nl> + } <nl> + <nl> public void run ( ) <nl> { <nl> while ( true ) <nl> diff - - git a / src / java / org / apache / cassandra / net / OutboundTcpConnectionPool . java b / src / java / org / apache / cassandra / net / OutboundTcpConnectionPool . java <nl> index c7acd9e . . a75dafe 100644 <nl> - - - a / src / java / org / apache / cassandra / net / OutboundTcpConnectionPool . java <nl> + + + b / src / java / org / apache / cassandra / net / OutboundTcpConnectionPool . java <nl> @ @ - 68 , 7 + 68 , 8 @ @ public class OutboundTcpConnectionPool <nl> public void reset ( InetAddress remoteEP ) <nl> { <nl> resetedEndpoint = remoteEP ; <nl> - reset ( ) ; <nl> + for ( OutboundTcpConnection con : new OutboundTcpConnection [ ] { cmdCon , ackCon } ) <nl> + con . softCloseSocket ( ) ; <nl> } <nl> <nl> public Socket newSocket ( ) throws IOException <nl> @ @ - 78 , 7 + 79 , 8 @ @ public class OutboundTcpConnectionPool <nl> { <nl> return SSLFactory . getSocket ( DatabaseDescriptor . getEncryptionOptions ( ) , endPoint ( ) , DatabaseDescriptor . getSSLStoragePort ( ) , FBUtilities . getLocalAddress ( ) , 0 ) ; <nl> } <nl> - else { <nl> + else <nl> + { <nl> return new Socket ( endPoint ( ) , DatabaseDescriptor . getStoragePort ( ) , FBUtilities . getLocalAddress ( ) , 0 ) ; <nl> } <nl> }

TEST DIFF:
diff - - git a / src / java / org / apache / cassandra / dht / RangeStreamer . java b / src / java / org / apache / cassandra / dht / RangeStreamer . java 
 index fecb308 . . 68c8a11 100644 
 - - - a / src / java / org / apache / cassandra / dht / RangeStreamer . java 
 + + + b / src / java / org / apache / cassandra / dht / RangeStreamer . java 
 @ @ - 336 , 7 + 336 , 7 @ @ public class RangeStreamer 
 Set < Range < Token > > availableRanges = stateStore . getAvailableRanges ( keyspace , StorageService . getPartitioner ( ) ) ; 
 if ( ranges . removeAll ( availableRanges ) ) 
 { 
 - logger . info ( availableRanges + " already available . Skipping streaming . " ) ; 
 + logger . info ( " Some ranges of { } are already available . Skipping streaming those ranges . " , availableRanges ) ; 
 } 
 
 if ( logger . isDebugEnabled ( ) ) 
 diff - - git a / src / java / org / apache / cassandra / gms / Gossiper . java b / src / java / org / apache / cassandra / gms / Gossiper . java 
 index 07f2615 . . 34f54a1 100644 
 - - - a / src / java / org / apache / cassandra / gms / Gossiper . java 
 + + + b / src / java / org / apache / cassandra / gms / Gossiper . java 
 @ @ - 925 , 7 + 925 , 7 @ @ public class Gossiper implements IFailureDetectionEventListener , GossiperMBean 
 for ( IEndpointStateChangeSubscriber subscriber : subscribers ) 
 subscriber . onAlive ( addr , localState ) ; 
 if ( logger . isTraceEnabled ( ) ) 
 - logger . trace ( " Notified " + subscribers ) ; 
 + logger . trace ( " Notified { } " , subscribers ) ; 
 } 
 
 private void markDead ( InetAddress addr , EndpointState localState ) 
 diff - - git a / src / java / org / apache / cassandra / net / OutboundTcpConnection . java b / src / java / org / apache / cassandra / net / OutboundTcpConnection . java 
 index 9ea4660 . . dc43106 100644 
 - - - a / src / java / org / apache / cassandra / net / OutboundTcpConnection . java 
 + + + b / src / java / org / apache / cassandra / net / OutboundTcpConnection . java 
 @ @ - 94 , 7 + 94 , 7 @ @ public class OutboundTcpConnection extends Thread 
 case " MOVINGAVERAGE " : 
 case " FIXED " : 
 case " DISABLED " : 
 - logger . info ( " OutboundTcpConnection using coalescing strategy " + strategy ) ; 
 + logger . info ( " OutboundTcpConnection using coalescing strategy { } " , strategy ) ; 
 break ; 
 default : 
 / / Check that it can be loaded 
 @ @ - 103 , 7 + 103 , 7 @ @ public class OutboundTcpConnection extends Thread 
 
 int coalescingWindow = DatabaseDescriptor . getOtcCoalescingWindow ( ) ; 
 if ( coalescingWindow ! = Config . otc _ coalescing _ window _ us _ default ) 
 - logger . info ( " OutboundTcpConnection coalescing window set to " + coalescingWindow + " μ s " ) ; 
 + logger . info ( " OutboundTcpConnection coalescing window set to { } μ s " , coalescingWindow ) ; 
 
 if ( coalescingWindow < 0 ) 
 throw new ExceptionInInitializerError ( 
 diff - - git a / src / java / org / apache / cassandra / utils / CoalescingStrategies . java b / src / java / org / apache / cassandra / utils / CoalescingStrategies . java 
 index ca1399b . . 7dba97b 100644 
 - - - a / src / java / org / apache / cassandra / utils / CoalescingStrategies . java 
 + + + b / src / java / org / apache / cassandra / utils / CoalescingStrategies . java 
 @ @ - 169 , 7 + 169 , 7 @ @ public class CoalescingStrategies 
 if ( DEBUG _ COALESCING & & shouldLogAverage ) 
 { 
 shouldLogAverage = false ; 
 - logger . info ( toString ( ) + " gap " + TimeUnit . NANOSECONDS . toMicros ( averageGap ) + " μ s " ) ; 
 + logger . info ( " { } gap { } μ s " , this , TimeUnit . NANOSECONDS . toMicros ( averageGap ) ) ; 
 } 
 } 


NEAREST DIFF:
diff - - git a / src / java / org / apache / cassandra / cli / CliClient . java b / src / java / org / apache / cassandra / cli / CliClient . java 
 index 4ffa3e9 . . 3f6fa9d 100644 
 - - - a / src / java / org / apache / cassandra / cli / CliClient . java 
 + + + b / src / java / org / apache / cassandra / cli / CliClient . java 
 @ @ - 1150 , 15 + 1150 , 7 @ @ public class CliClient 
 { 
 SimpleSnitch snitch = new SimpleSnitch ( ) ; 
 Map < String , String > options = new HashMap < String , String > ( ) ; 
 - 
 - try 
 - { 
 - options . put ( snitch . getDatacenter ( InetAddress . getLocalHost ( ) ) , " 1 " ) ; 
 - } 
 - catch ( UnknownHostException e ) 
 - { 
 - throw new RuntimeException ( e ) ; 
 - } 
 + options . put ( snitch . getDatacenter ( FBUtilities . getBroadcastAddress ( ) ) , " 1 " ) ; 
 
 ksDef . setStrategy _ options ( options ) ; 
 } 
 diff - - git a / src / java / org / apache / cassandra / db / SystemTable . java b / src / java / org / apache / cassandra / db / SystemTable . java 
 index 58ff41e . . b0b5c60 100644 
 - - - a / src / java / org / apache / cassandra / db / SystemTable . java 
 + + + b / src / java / org / apache / cassandra / db / SystemTable . java 
 @ @ - 143 , 7 + 143 , 7 @ @ public class SystemTable 
 * / 
 public static synchronized void updateToken ( InetAddress ep , Token token ) 
 { 
 - if ( ep = = FBUtilities . getLocalAddress ( ) ) 
 + if ( ep = = FBUtilities . getBroadcastAddress ( ) ) 
 { 
 removeToken ( token ) ; 
 return ; 
 diff - - git a / src / java / org / apache / cassandra / gms / Gossiper . java b / src / java / org / apache / cassandra / gms / Gossiper . java 
 index 27a1ba7 . . 9f73717 100644 
 - - - a / src / java / org / apache / cassandra / gms / Gossiper . java 
 + + + b / src / java / org / apache / cassandra / gms / Gossiper . java 
 @ @ - 1090 , 7 + 1090 , 7 @ @ public class Gossiper implements IFailureDetectionEventListener , GossiperMBean 
 * / 
 public void addSavedEndpoint ( InetAddress ep ) 
 { 
 - if ( ep = = FBUtilities . getLocalAddress ( ) ) 
 + if ( ep = = FBUtilities . getBroadcastAddress ( ) ) 
 { 
 logger . debug ( " Attempt to add self as saved endpoint " ) ; 
 return ; 
 diff - - git a / src / java / org / apache / cassandra / net / OutboundTcpConnection . java b / src / java / org / apache / cassandra / net / OutboundTcpConnection . java 
 index e920aae . . f9d866d 100644 
 - - - a / src / java / org / apache / cassandra / net / OutboundTcpConnection . java 
 + + + b / src / java / org / apache / cassandra / net / OutboundTcpConnection . java 
 @ @ - 86 , 6 + 86 , 11 @ @ public class OutboundTcpConnection extends Thread 
 enqueue ( CLOSE _ SENTINEL , null ) ; 
 } 
 
 + void softCloseSocket ( ) 
 + { 
 + enqueue ( CLOSE _ SENTINEL , null ) ; 
 + } 
 + 
 public void run ( ) 
 { 
 while ( true ) 
 diff - - git a / src / java / org / apache / cassandra / net / OutboundTcpConnectionPool . java b / src / java / org / apache / cassandra / net / OutboundTcpConnectionPool . java 
 index c7acd9e . . a75dafe 100644 
 - - - a / src / java / org / apache / cassandra / net / OutboundTcpConnectionPool . java 
 + + + b / src / java / org / apache / cassandra / net / OutboundTcpConnectionPool . java 
 @ @ - 68 , 7 + 68 , 8 @ @ public class OutboundTcpConnectionPool 
 public void reset ( InetAddress remoteEP ) 
 { 
 resetedEndpoint = remoteEP ; 
 - reset ( ) ; 
 + for ( OutboundTcpConnection con : new OutboundTcpConnection [ ] { cmdCon , ackCon } ) 
 + con . softCloseSocket ( ) ; 
 } 
 
 public Socket newSocket ( ) throws IOException 
 @ @ - 78 , 7 + 79 , 8 @ @ public class OutboundTcpConnectionPool 
 { 
 return SSLFactory . getSocket ( DatabaseDescriptor . getEncryptionOptions ( ) , endPoint ( ) , DatabaseDescriptor . getSSLStoragePort ( ) , FBUtilities . getLocalAddress ( ) , 0 ) ; 
 } 
 - else { 
 + else 
 + { 
 return new Socket ( endPoint ( ) , DatabaseDescriptor . getStoragePort ( ) , FBUtilities . getLocalAddress ( ) , 0 ) ; 
 } 
 }
