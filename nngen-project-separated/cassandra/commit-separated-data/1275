BLEU SCORE: 0.027611988917697356

TEST MSG: Flush system schema tables after local schema changes
GENERATED MSG: clean up IOException usage

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 53269e6 . . 5fddce9 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 3 . 0 <nl> + * Flush system schema tables after local schema changes ( CASSANDRA - 10429 ) <nl> Merged from 2 . 2 : <nl> * cqlsh prompt includes name of keyspace after failed ` use ` statement ( CASSANDRA - 10369 ) <nl> <nl> diff - - git a / build . xml b / build . xml <nl> index 89e3d46 . . 669ca56 100644 <nl> - - - a / build . xml <nl> + + + b / build . xml <nl> @ @ - 101 , 6 + 101 , 9 @ @ <nl> < ! - - default for cql tests . Can be override by - Dcassandra . test . use _ prepared = false - - > <nl> < property name = " cassandra . test . use _ prepared " value = " true " / > <nl> <nl> + < ! - - skip flushing schema tables during tests - - > <nl> + < property name = " cassandra . test . flush _ local _ schema _ changes " value = " false " / > <nl> + <nl> < ! - - http : / / cobertura . sourceforge . net / - - > <nl> < property name = " cobertura . version " value = " 2 . 0 . 3 " / > <nl> < property name = " cobertura . build . dir " value = " $ { build . dir } / cobertura " / > <nl> diff - - git a / src / java / org / apache / cassandra / db / DefinitionsUpdateVerbHandler . java b / src / java / org / apache / cassandra / db / DefinitionsUpdateVerbHandler . java <nl> index e4f4e35 . . b849f95 100644 <nl> - - - a / src / java / org / apache / cassandra / db / DefinitionsUpdateVerbHandler . java <nl> + + + b / src / java / org / apache / cassandra / db / DefinitionsUpdateVerbHandler . java <nl> @ @ - 47 , 7 + 47 , 7 @ @ public class DefinitionsUpdateVerbHandler implements IVerbHandler < Collection < Mut <nl> { <nl> public void runMayThrow ( ) throws Exception <nl> { <nl> - SchemaKeyspace . mergeSchema ( message . payload ) ; <nl> + SchemaKeyspace . mergeSchemaAndAnnounceVersion ( message . payload ) ; <nl> } <nl> } ) ; <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / schema / SchemaKeyspace . java b / src / java / org / apache / cassandra / schema / SchemaKeyspace . java <nl> index bc9da31 . . f0bdd14 100644 <nl> - - - a / src / java / org / apache / cassandra / schema / SchemaKeyspace . java <nl> + + + b / src / java / org / apache / cassandra / schema / SchemaKeyspace . java <nl> @ @ - 62 , 6 + 62 , 8 @ @ public final class SchemaKeyspace <nl> <nl> private static final Logger logger = LoggerFactory . getLogger ( SchemaKeyspace . class ) ; <nl> <nl> + private static final boolean FLUSH _ SCHEMA _ TABLES = Boolean . valueOf ( System . getProperty ( " cassandra . test . flush _ local _ schema _ changes " , " true " ) ) ; <nl> + <nl> public static final String NAME = " system _ schema " ; <nl> <nl> public static final String KEYSPACES = " keyspaces " ; <nl> @ @ - 476 , 13 + 478 , 13 @ @ public final class SchemaKeyspace <nl> * @ throws ConfigurationException If one of metadata attributes has invalid value <nl> * @ throws IOException If data was corrupted during transportation or failed to apply fs operations <nl> * / <nl> - public static synchronized void mergeSchema ( Collection < Mutation > mutations ) throws ConfigurationException , IOException <nl> + public static synchronized void mergeSchemaAndAnnounceVersion ( Collection < Mutation > mutations ) throws ConfigurationException , IOException <nl> { <nl> - mergeSchema ( mutations , true ) ; <nl> + mergeSchema ( mutations ) ; <nl> Schema . instance . updateVersionAndAnnounce ( ) ; <nl> } <nl> <nl> - public static synchronized void mergeSchema ( Collection < Mutation > mutations , boolean doFlush ) throws IOException <nl> + public static synchronized void mergeSchema ( Collection < Mutation > mutations ) throws IOException <nl> { <nl> / / compare before / after schemas of the affected keyspaces only <nl> Set < String > keyspaces = new HashSet < > ( mutations . size ( ) ) ; <nl> @ @ - 499 , 7 + 501 , 7 @ @ public final class SchemaKeyspace <nl> <nl> mutations . forEach ( Mutation : : apply ) ; <nl> <nl> - if ( doFlush ) <nl> + if ( FLUSH _ SCHEMA _ TABLES ) <nl> flush ( ) ; <nl> <nl> / / with new data applied <nl> diff - - git a / src / java / org / apache / cassandra / service / MigrationManager . java b / src / java / org / apache / cassandra / service / MigrationManager . java <nl> index c820f18 . . de6c7f7 100644 <nl> - - - a / src / java / org / apache / cassandra / service / MigrationManager . java <nl> + + + b / src / java / org / apache / cassandra / service / MigrationManager . java <nl> @ @ - 471 , 7 + 471 , 7 @ @ public class MigrationManager <nl> { <nl> try <nl> { <nl> - SchemaKeyspace . mergeSchema ( Collections . singletonList ( schema ) , false ) ; <nl> + SchemaKeyspace . mergeSchema ( Collections . singletonList ( schema ) ) ; <nl> } <nl> catch ( IOException e ) <nl> { <nl> @ @ - 499 , 7 + 499 , 7 @ @ public class MigrationManager <nl> { <nl> protected void runMayThrow ( ) throws IOException , ConfigurationException <nl> { <nl> - SchemaKeyspace . mergeSchema ( schema ) ; <nl> + SchemaKeyspace . mergeSchemaAndAnnounceVersion ( schema ) ; <nl> } <nl> } ) ; <nl> <nl> diff - - git a / src / java / org / apache / cassandra / service / MigrationTask . java b / src / java / org / apache / cassandra / service / MigrationTask . java <nl> index 33bb35f . . 4e3fac3 100644 <nl> - - - a / src / java / org / apache / cassandra / service / MigrationTask . java <nl> + + + b / src / java / org / apache / cassandra / service / MigrationTask . java <nl> @ @ - 72 , 7 + 72 , 7 @ @ class MigrationTask extends WrappedRunnable <nl> { <nl> try <nl> { <nl> - SchemaKeyspace . mergeSchema ( message . payload ) ; <nl> + SchemaKeyspace . mergeSchemaAndAnnounceVersion ( message . payload ) ; <nl> } <nl> catch ( IOException e ) <nl> { <nl> diff - - git a / test / unit / org / apache / cassandra / schema / SchemaKeyspaceTest . java b / test / unit / org / apache / cassandra / schema / SchemaKeyspaceTest . java <nl> index 2f51803 . . 3eb4faf 100644 <nl> - - - a / test / unit / org / apache / cassandra / schema / SchemaKeyspaceTest . java <nl> + + + b / test / unit / org / apache / cassandra / schema / SchemaKeyspaceTest . java <nl> @ @ - 162 , 7 + 162 , 7 @ @ public class SchemaKeyspaceTest <nl> { <nl> KeyspaceMetadata ksm = Schema . instance . getKeyspaceInstance ( keyspace ) . getMetadata ( ) ; <nl> Mutation mutation = SchemaKeyspace . makeUpdateTableMutation ( ksm , oldTable , newTable , FBUtilities . timestampMicros ( ) , false ) ; <nl> - SchemaKeyspace . mergeSchema ( Collections . singleton ( mutation ) , true ) ; <nl> + SchemaKeyspace . mergeSchema ( Collections . singleton ( mutation ) ) ; <nl> } <nl> <nl> private static void createTable ( String keyspace , String cql ) throws IOException <nl> @ @ - 171 , 7 + 171 , 7 @ @ public class SchemaKeyspaceTest <nl> <nl> KeyspaceMetadata ksm = KeyspaceMetadata . create ( keyspace , KeyspaceParams . simple ( 1 ) , Tables . of ( table ) ) ; <nl> Mutation mutation = SchemaKeyspace . makeCreateTableMutation ( ksm , table , FBUtilities . timestampMicros ( ) ) ; <nl> - SchemaKeyspace . mergeSchema ( Collections . singleton ( mutation ) , true ) ; <nl> + SchemaKeyspace . mergeSchema ( Collections . singleton ( mutation ) ) ; <nl> } <nl> <nl> private static void checkInverses ( CFMetaData cfm ) throws Exception
NEAREST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / net / IncomingTcpConnection . java b / src / java / org / apache / cassandra / net / IncomingTcpConnection . java <nl> index 5bf4c5d . . eeb6b31 100644 <nl> - - - a / src / java / org / apache / cassandra / net / IncomingTcpConnection . java <nl> + + + b / src / java / org / apache / cassandra / net / IncomingTcpConnection . java <nl> @ @ - 179 , 7 + 179 , 7 @ @ public class IncomingTcpConnection extends Thread <nl> <nl> String id = input . readUTF ( ) ; <nl> long timestamp = version > = MessagingService . VERSION _ 12 <nl> - ? ( System . currentTimeMillis ( ) | 0x00000000FFFFFFFFL ) & input . readInt ( ) <nl> + ? ( System . currentTimeMillis ( ) & 0xFFFFFFFF00000000L ) | ( ( input . readInt ( ) < < 2 ) > > 2 ) <nl> : System . currentTimeMillis ( ) ; <nl> <nl> MessageIn message = MessageIn . read ( input , version , id ) ;

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 53269e6 . . 5fddce9 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 3 . 0 
 + * Flush system schema tables after local schema changes ( CASSANDRA - 10429 ) 
 Merged from 2 . 2 : 
 * cqlsh prompt includes name of keyspace after failed ` use ` statement ( CASSANDRA - 10369 ) 
 
 diff - - git a / build . xml b / build . xml 
 index 89e3d46 . . 669ca56 100644 
 - - - a / build . xml 
 + + + b / build . xml 
 @ @ - 101 , 6 + 101 , 9 @ @ 
 < ! - - default for cql tests . Can be override by - Dcassandra . test . use _ prepared = false - - > 
 < property name = " cassandra . test . use _ prepared " value = " true " / > 
 
 + < ! - - skip flushing schema tables during tests - - > 
 + < property name = " cassandra . test . flush _ local _ schema _ changes " value = " false " / > 
 + 
 < ! - - http : / / cobertura . sourceforge . net / - - > 
 < property name = " cobertura . version " value = " 2 . 0 . 3 " / > 
 < property name = " cobertura . build . dir " value = " $ { build . dir } / cobertura " / > 
 diff - - git a / src / java / org / apache / cassandra / db / DefinitionsUpdateVerbHandler . java b / src / java / org / apache / cassandra / db / DefinitionsUpdateVerbHandler . java 
 index e4f4e35 . . b849f95 100644 
 - - - a / src / java / org / apache / cassandra / db / DefinitionsUpdateVerbHandler . java 
 + + + b / src / java / org / apache / cassandra / db / DefinitionsUpdateVerbHandler . java 
 @ @ - 47 , 7 + 47 , 7 @ @ public class DefinitionsUpdateVerbHandler implements IVerbHandler < Collection < Mut 
 { 
 public void runMayThrow ( ) throws Exception 
 { 
 - SchemaKeyspace . mergeSchema ( message . payload ) ; 
 + SchemaKeyspace . mergeSchemaAndAnnounceVersion ( message . payload ) ; 
 } 
 } ) ; 
 } 
 diff - - git a / src / java / org / apache / cassandra / schema / SchemaKeyspace . java b / src / java / org / apache / cassandra / schema / SchemaKeyspace . java 
 index bc9da31 . . f0bdd14 100644 
 - - - a / src / java / org / apache / cassandra / schema / SchemaKeyspace . java 
 + + + b / src / java / org / apache / cassandra / schema / SchemaKeyspace . java 
 @ @ - 62 , 6 + 62 , 8 @ @ public final class SchemaKeyspace 
 
 private static final Logger logger = LoggerFactory . getLogger ( SchemaKeyspace . class ) ; 
 
 + private static final boolean FLUSH _ SCHEMA _ TABLES = Boolean . valueOf ( System . getProperty ( " cassandra . test . flush _ local _ schema _ changes " , " true " ) ) ; 
 + 
 public static final String NAME = " system _ schema " ; 
 
 public static final String KEYSPACES = " keyspaces " ; 
 @ @ - 476 , 13 + 478 , 13 @ @ public final class SchemaKeyspace 
 * @ throws ConfigurationException If one of metadata attributes has invalid value 
 * @ throws IOException If data was corrupted during transportation or failed to apply fs operations 
 * / 
 - public static synchronized void mergeSchema ( Collection < Mutation > mutations ) throws ConfigurationException , IOException 
 + public static synchronized void mergeSchemaAndAnnounceVersion ( Collection < Mutation > mutations ) throws ConfigurationException , IOException 
 { 
 - mergeSchema ( mutations , true ) ; 
 + mergeSchema ( mutations ) ; 
 Schema . instance . updateVersionAndAnnounce ( ) ; 
 } 
 
 - public static synchronized void mergeSchema ( Collection < Mutation > mutations , boolean doFlush ) throws IOException 
 + public static synchronized void mergeSchema ( Collection < Mutation > mutations ) throws IOException 
 { 
 / / compare before / after schemas of the affected keyspaces only 
 Set < String > keyspaces = new HashSet < > ( mutations . size ( ) ) ; 
 @ @ - 499 , 7 + 501 , 7 @ @ public final class SchemaKeyspace 
 
 mutations . forEach ( Mutation : : apply ) ; 
 
 - if ( doFlush ) 
 + if ( FLUSH _ SCHEMA _ TABLES ) 
 flush ( ) ; 
 
 / / with new data applied 
 diff - - git a / src / java / org / apache / cassandra / service / MigrationManager . java b / src / java / org / apache / cassandra / service / MigrationManager . java 
 index c820f18 . . de6c7f7 100644 
 - - - a / src / java / org / apache / cassandra / service / MigrationManager . java 
 + + + b / src / java / org / apache / cassandra / service / MigrationManager . java 
 @ @ - 471 , 7 + 471 , 7 @ @ public class MigrationManager 
 { 
 try 
 { 
 - SchemaKeyspace . mergeSchema ( Collections . singletonList ( schema ) , false ) ; 
 + SchemaKeyspace . mergeSchema ( Collections . singletonList ( schema ) ) ; 
 } 
 catch ( IOException e ) 
 { 
 @ @ - 499 , 7 + 499 , 7 @ @ public class MigrationManager 
 { 
 protected void runMayThrow ( ) throws IOException , ConfigurationException 
 { 
 - SchemaKeyspace . mergeSchema ( schema ) ; 
 + SchemaKeyspace . mergeSchemaAndAnnounceVersion ( schema ) ; 
 } 
 } ) ; 
 
 diff - - git a / src / java / org / apache / cassandra / service / MigrationTask . java b / src / java / org / apache / cassandra / service / MigrationTask . java 
 index 33bb35f . . 4e3fac3 100644 
 - - - a / src / java / org / apache / cassandra / service / MigrationTask . java 
 + + + b / src / java / org / apache / cassandra / service / MigrationTask . java 
 @ @ - 72 , 7 + 72 , 7 @ @ class MigrationTask extends WrappedRunnable 
 { 
 try 
 { 
 - SchemaKeyspace . mergeSchema ( message . payload ) ; 
 + SchemaKeyspace . mergeSchemaAndAnnounceVersion ( message . payload ) ; 
 } 
 catch ( IOException e ) 
 { 
 diff - - git a / test / unit / org / apache / cassandra / schema / SchemaKeyspaceTest . java b / test / unit / org / apache / cassandra / schema / SchemaKeyspaceTest . java 
 index 2f51803 . . 3eb4faf 100644 
 - - - a / test / unit / org / apache / cassandra / schema / SchemaKeyspaceTest . java 
 + + + b / test / unit / org / apache / cassandra / schema / SchemaKeyspaceTest . java 
 @ @ - 162 , 7 + 162 , 7 @ @ public class SchemaKeyspaceTest 
 { 
 KeyspaceMetadata ksm = Schema . instance . getKeyspaceInstance ( keyspace ) . getMetadata ( ) ; 
 Mutation mutation = SchemaKeyspace . makeUpdateTableMutation ( ksm , oldTable , newTable , FBUtilities . timestampMicros ( ) , false ) ; 
 - SchemaKeyspace . mergeSchema ( Collections . singleton ( mutation ) , true ) ; 
 + SchemaKeyspace . mergeSchema ( Collections . singleton ( mutation ) ) ; 
 } 
 
 private static void createTable ( String keyspace , String cql ) throws IOException 
 @ @ - 171 , 7 + 171 , 7 @ @ public class SchemaKeyspaceTest 
 
 KeyspaceMetadata ksm = KeyspaceMetadata . create ( keyspace , KeyspaceParams . simple ( 1 ) , Tables . of ( table ) ) ; 
 Mutation mutation = SchemaKeyspace . makeCreateTableMutation ( ksm , table , FBUtilities . timestampMicros ( ) ) ; 
 - SchemaKeyspace . mergeSchema ( Collections . singleton ( mutation ) , true ) ; 
 + SchemaKeyspace . mergeSchema ( Collections . singleton ( mutation ) ) ; 
 } 
 
 private static void checkInverses ( CFMetaData cfm ) throws Exception

NEAREST DIFF:
diff - - git a / src / java / org / apache / cassandra / net / IncomingTcpConnection . java b / src / java / org / apache / cassandra / net / IncomingTcpConnection . java 
 index 5bf4c5d . . eeb6b31 100644 
 - - - a / src / java / org / apache / cassandra / net / IncomingTcpConnection . java 
 + + + b / src / java / org / apache / cassandra / net / IncomingTcpConnection . java 
 @ @ - 179 , 7 + 179 , 7 @ @ public class IncomingTcpConnection extends Thread 
 
 String id = input . readUTF ( ) ; 
 long timestamp = version > = MessagingService . VERSION _ 12 
 - ? ( System . currentTimeMillis ( ) | 0x00000000FFFFFFFFL ) & input . readInt ( ) 
 + ? ( System . currentTimeMillis ( ) & 0xFFFFFFFF00000000L ) | ( ( input . readInt ( ) < < 2 ) > > 2 ) 
 : System . currentTimeMillis ( ) ; 
 
 MessageIn message = MessageIn . read ( input , version , id ) ;
