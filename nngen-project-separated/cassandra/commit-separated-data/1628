BLEU SCORE: 0.0208362582256928

TEST MSG: Populate TokenMetadata early during startup .
GENERATED MSG: Revert ' start thrift before gossip ' part of 4679

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 0efba98 . . bcae76f 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 2 . 2 <nl> + * Populate TokenMetadata early during startup ( CASSANDRA - 9317 ) <nl> * Make Functions . declared thread - safe <nl> * Add client warnings to native protocol v4 ( CASSANDRA - 8930 ) <nl> * Allow roles cache to be invalidated ( CASSANDRA - 8967 ) <nl> diff - - git a / src / java / org / apache / cassandra / service / CassandraDaemon . java b / src / java / org / apache / cassandra / service / CassandraDaemon . java <nl> index c1b4ad6 . . 914600e 100644 <nl> - - - a / src / java / org / apache / cassandra / service / CassandraDaemon . java <nl> + + + b / src / java / org / apache / cassandra / service / CassandraDaemon . java <nl> @ @ - 173 , 6 + 173 , 7 @ @ public class CassandraDaemon <nl> } <nl> } ) ; <nl> <nl> + StorageService . instance . populateTokenMetadata ( ) ; <nl> / / load schema from disk <nl> Schema . instance . loadFromDisk ( ) ; <nl> <nl> diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java <nl> index c0ea872 . . 4573449 100644 <nl> - - - a / src / java / org / apache / cassandra / service / StorageService . java <nl> + + + b / src / java / org / apache / cassandra / service / StorageService . java <nl> @ @ - 565 , 6 + 565 , 21 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE <nl> MessagingService . instance ( ) . listen ( FBUtilities . getLocalAddress ( ) ) ; <nl> } <nl> <nl> + public void populateTokenMetadata ( ) <nl> + { <nl> + if ( Boolean . parseBoolean ( System . getProperty ( " cassandra . load _ ring _ state " , " true " ) ) ) <nl> + { <nl> + logger . info ( " Populating token metadata from system tables " ) ; <nl> + Multimap < InetAddress , Token > loadedTokens = SystemKeyspace . loadTokens ( ) ; <nl> + if ( ! shouldBootstrap ( ) ) / / if we have not completed bootstrapping , we should not add ourselves as a normal token <nl> + loadedTokens . putAll ( FBUtilities . getBroadcastAddress ( ) , SystemKeyspace . getSavedTokens ( ) ) ; <nl> + for ( InetAddress ep : loadedTokens . keySet ( ) ) <nl> + tokenMetadata . updateNormalTokens ( loadedTokens . get ( ep ) , ep ) ; <nl> + <nl> + logger . info ( " Token metadata : { } " , tokenMetadata ) ; <nl> + } <nl> + } <nl> + <nl> public synchronized void initServer ( ) throws ConfigurationException <nl> { <nl> initServer ( RING _ DELAY ) ; <nl> @ @ - 605 , 7 + 620 , 6 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE <nl> } <nl> else <nl> { <nl> - tokenMetadata . updateNormalTokens ( loadedTokens . get ( ep ) , ep ) ; <nl> if ( loadedHostIds . containsKey ( ep ) ) <nl> tokenMetadata . updateHostId ( loadedHostIds . get ( ep ) , ep ) ; <nl> Gossiper . instance . addSavedEndpoint ( ep ) ;
NEAREST DIFF (one line): diff - - git a / build . xml b / build . xml <nl> index 04a5307 . . 097da2a 100644 <nl> - - - a / build . xml <nl> + + + b / build . xml <nl> @ @ - 362 , 7 + 362 , 7 @ @ <nl> < dependency groupId = " org . apache . rat " artifactId = " apache - rat " version = " 0 . 6 " > <nl> < exclusion groupId = " commons - lang " artifactId = " commons - lang " / > <nl> < / dependency > <nl> - < dependency groupId = " org . apache . hadoop " artifactId = " hadoop - core " version = " 1 . 0 . 2 " / > <nl> + < dependency groupId = " org . apache . hadoop " artifactId = " hadoop - core " version = " 1 . 0 . 3 " / > <nl> < dependency groupId = " org . apache . pig " artifactId = " pig " version = " 0 . 10 . 0 " / > <nl> < dependency groupId = " net . sf . jopt - simple " artifactId = " jopt - simple " version = " 3 . 2 " / > <nl> < dependency groupId = " net . java . dev . jna " artifactId = " jna " version = " 3 . 2 . 7 " / >

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 0efba98 . . bcae76f 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 2 . 2 
 + * Populate TokenMetadata early during startup ( CASSANDRA - 9317 ) 
 * Make Functions . declared thread - safe 
 * Add client warnings to native protocol v4 ( CASSANDRA - 8930 ) 
 * Allow roles cache to be invalidated ( CASSANDRA - 8967 ) 
 diff - - git a / src / java / org / apache / cassandra / service / CassandraDaemon . java b / src / java / org / apache / cassandra / service / CassandraDaemon . java 
 index c1b4ad6 . . 914600e 100644 
 - - - a / src / java / org / apache / cassandra / service / CassandraDaemon . java 
 + + + b / src / java / org / apache / cassandra / service / CassandraDaemon . java 
 @ @ - 173 , 6 + 173 , 7 @ @ public class CassandraDaemon 
 } 
 } ) ; 
 
 + StorageService . instance . populateTokenMetadata ( ) ; 
 / / load schema from disk 
 Schema . instance . loadFromDisk ( ) ; 
 
 diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java 
 index c0ea872 . . 4573449 100644 
 - - - a / src / java / org / apache / cassandra / service / StorageService . java 
 + + + b / src / java / org / apache / cassandra / service / StorageService . java 
 @ @ - 565 , 6 + 565 , 21 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE 
 MessagingService . instance ( ) . listen ( FBUtilities . getLocalAddress ( ) ) ; 
 } 
 
 + public void populateTokenMetadata ( ) 
 + { 
 + if ( Boolean . parseBoolean ( System . getProperty ( " cassandra . load _ ring _ state " , " true " ) ) ) 
 + { 
 + logger . info ( " Populating token metadata from system tables " ) ; 
 + Multimap < InetAddress , Token > loadedTokens = SystemKeyspace . loadTokens ( ) ; 
 + if ( ! shouldBootstrap ( ) ) / / if we have not completed bootstrapping , we should not add ourselves as a normal token 
 + loadedTokens . putAll ( FBUtilities . getBroadcastAddress ( ) , SystemKeyspace . getSavedTokens ( ) ) ; 
 + for ( InetAddress ep : loadedTokens . keySet ( ) ) 
 + tokenMetadata . updateNormalTokens ( loadedTokens . get ( ep ) , ep ) ; 
 + 
 + logger . info ( " Token metadata : { } " , tokenMetadata ) ; 
 + } 
 + } 
 + 
 public synchronized void initServer ( ) throws ConfigurationException 
 { 
 initServer ( RING _ DELAY ) ; 
 @ @ - 605 , 7 + 620 , 6 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE 
 } 
 else 
 { 
 - tokenMetadata . updateNormalTokens ( loadedTokens . get ( ep ) , ep ) ; 
 if ( loadedHostIds . containsKey ( ep ) ) 
 tokenMetadata . updateHostId ( loadedHostIds . get ( ep ) , ep ) ; 
 Gossiper . instance . addSavedEndpoint ( ep ) ;

NEAREST DIFF:
diff - - git a / build . xml b / build . xml 
 index 04a5307 . . 097da2a 100644 
 - - - a / build . xml 
 + + + b / build . xml 
 @ @ - 362 , 7 + 362 , 7 @ @ 
 < dependency groupId = " org . apache . rat " artifactId = " apache - rat " version = " 0 . 6 " > 
 < exclusion groupId = " commons - lang " artifactId = " commons - lang " / > 
 < / dependency > 
 - < dependency groupId = " org . apache . hadoop " artifactId = " hadoop - core " version = " 1 . 0 . 2 " / > 
 + < dependency groupId = " org . apache . hadoop " artifactId = " hadoop - core " version = " 1 . 0 . 3 " / > 
 < dependency groupId = " org . apache . pig " artifactId = " pig " version = " 0 . 10 . 0 " / > 
 < dependency groupId = " net . sf . jopt - simple " artifactId = " jopt - simple " version = " 3 . 2 " / > 
 < dependency groupId = " net . java . dev . jna " artifactId = " jna " version = " 3 . 2 . 7 " / >
