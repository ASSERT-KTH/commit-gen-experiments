BLEU SCORE: 0.005105783260904824

TEST MSG: Fix NanoTimeTocurrentTimeMillisTest on Windows
GENERATED MSG: use JNA to call link w / o spawning a separate process during snapshot .

TEST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / utils / NanoTimeToCurrentTimeMillis . java b / src / java / org / apache / cassandra / utils / NanoTimeToCurrentTimeMillis . java <nl> index a6c5d28 . . f124383 100644 <nl> - - - a / src / java / org / apache / cassandra / utils / NanoTimeToCurrentTimeMillis . java <nl> + + + b / src / java / org / apache / cassandra / utils / NanoTimeToCurrentTimeMillis . java <nl> @ @ - 46 , 7 + 46 , 7 @ @ public class NanoTimeToCurrentTimeMillis <nl> * There is also the issue of how scalable nanoTime ( ) and currentTimeMillis ( ) are which is a moving target . <nl> * <nl> * These timestamps don ' t order with System . currentTimeMillis ( ) because currentTimeMillis ( ) can tick over <nl> - * before this one does . I have seen it behind by as much as 2 milliseconds . <nl> + * before this one does . I have seen it behind by as much as 2ms on Linux and 25ms on Windows . <nl> * / <nl> public static final long convert ( long nanoTime ) <nl> { <nl> diff - - git a / test / unit / org / apache / cassandra / utils / NanoTimeToCurrentTimeMillisTest . java b / test / unit / org / apache / cassandra / utils / NanoTimeToCurrentTimeMillisTest . java <nl> index 5c025cf . . 1662e77 100644 <nl> - - - a / test / unit / org / apache / cassandra / utils / NanoTimeToCurrentTimeMillisTest . java <nl> + + + b / test / unit / org / apache / cassandra / utils / NanoTimeToCurrentTimeMillisTest . java <nl> @ @ - 40 , 13 + 40 , 19 @ @ public class NanoTimeToCurrentTimeMillisTest <nl> } <nl> Thread . sleep ( 1 ) ; <nl> } <nl> - nowNanos = Math . max ( now , System . nanoTime ( ) ) ; <nl> + <nl> + nowNanos = Math . max ( nowNanos , System . nanoTime ( ) ) ; <nl> long convertedNow = NanoTimeToCurrentTimeMillis . convert ( nowNanos ) ; <nl> - assertTrue ( " convertedNow = " + convertedNow + " lastConverted = " + lastConverted + " in iteration " + ii , convertedNow > = ( lastConverted - 1 ) ) ; <nl> - lastConverted = convertedNow ; <nl> - / / Seems to be off by as much as two milliseconds sadly <nl> - assertTrue ( " now = " + now + " convertedNow = " + convertedNow + " in iteration " + ii , ( now - 2 ) < = convertedNow ) ; <nl> <nl> + int maxDiff = FBUtilities . isWindows ( ) ? 15 : 1 ; <nl> + assertTrue ( " convertedNow = " + convertedNow + " lastConverted = " + lastConverted + " in iteration " + ii , <nl> + convertedNow > = ( lastConverted - maxDiff ) ) ; <nl> + <nl> + maxDiff = FBUtilities . isWindows ( ) ? 25 : 2 ; <nl> + assertTrue ( " now = " + now + " convertedNow = " + convertedNow + " in iteration " + ii , <nl> + ( maxDiff - 2 ) < = convertedNow ) ; <nl> + <nl> + lastConverted = convertedNow ; <nl> } <nl> } <nl> }
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 420138a . . 8db932b 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 21 , 6 + 21 , 7 @ @ dev <nl> ( CASSANDRA - 1385 ) <nl> * disallow invalid keyspace and column family names . This includes name that <nl> matches a ' ^ \ w + ' regex . ( CASSANDRA - 1377 ) <nl> + * use JNA , if present , to take snapshots ( CASSANDRA - 1371 ) <nl> <nl> <nl> 0 . 7 - beta1 <nl> diff - - git a / src / java / org / apache / cassandra / io / util / FileUtils . java b / src / java / org / apache / cassandra / io / util / FileUtils . java <nl> index cd75871 . . eb1d0e5 100644 <nl> - - - a / src / java / org / apache / cassandra / io / util / FileUtils . java <nl> + + + b / src / java / org / apache / cassandra / io / util / FileUtils . java <nl> @ @ - 25 , 6 + 25 , 9 @ @ import java . util . * ; <nl> import org . slf4j . Logger ; <nl> import org . slf4j . LoggerFactory ; <nl> <nl> + import com . sun . jna . Native ; <nl> + import org . apache . cassandra . utils . CLibrary ; <nl> + <nl> <nl> public class FileUtils <nl> { <nl> @ @ - 206 , 6 + 209 , 30 @ @ public class FileUtils <nl> * / <nl> public static void createHardLink ( File sourceFile , File destinationFile ) throws IOException <nl> { <nl> + int errno = Integer . MIN _ VALUE ; <nl> + try <nl> + { <nl> + int result = CLibrary . link ( sourceFile . getAbsolutePath ( ) , destinationFile . getAbsolutePath ( ) ) ; <nl> + if ( result ! = 0 ) <nl> + errno = Native . getLastError ( ) ; <nl> + } <nl> + catch ( UnsatisfiedLinkError e ) <nl> + { <nl> + createHardLinkWithExec ( sourceFile , destinationFile ) ; <nl> + return ; <nl> + } <nl> + <nl> + if ( errno ! = Integer . MIN _ VALUE ) <nl> + { <nl> + / / there are 17 different error codes listed on the man page . punt until / unless we find which <nl> + / / ones actually turn up in practice . <nl> + throw new IOException ( String . format ( " Unable to create hard link from % s to % s ( errno % d ) " , <nl> + sourceFile , destinationFile , errno ) ) ; <nl> + } <nl> + } <nl> + <nl> + private static void createHardLinkWithExec ( File sourceFile , File destinationFile ) throws IOException <nl> + { <nl> String osname = System . getProperty ( " os . name " ) ; <nl> ProcessBuilder pb ; <nl> if ( osname . startsWith ( " Windows " ) ) <nl> diff - - git a / src / java / org / apache / cassandra / utils / CLibrary . java b / src / java / org / apache / cassandra / utils / CLibrary . java <nl> index 3682927 . . ee85a9a 100644 <nl> - - - a / src / java / org / apache / cassandra / utils / CLibrary . java <nl> + + + b / src / java / org / apache / cassandra / utils / CLibrary . java <nl> @ @ - 49 , 8 + 49 , 9 @ @ public final class CLibrary <nl> } <nl> <nl> public static native int mlockall ( int flags ) ; <nl> - <nl> public static native int munlockall ( ) ; <nl> <nl> + public static native int link ( String from , String to ) ; <nl> + <nl> private CLibrary ( ) { } <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / utils / FBUtilities . java b / src / java / org / apache / cassandra / utils / FBUtilities . java <nl> index 4b846fb . . 366b888 100644 <nl> - - - a / src / java / org / apache / cassandra / utils / FBUtilities . java <nl> + + + b / src / java / org / apache / cassandra / utils / FBUtilities . java <nl> @ @ - 616 , 21 + 616 , 6 @ @ public class FBUtilities <nl> / / this will have already been logged by CLibrary , no need to repeat it <nl> return ; <nl> } <nl> - catch ( Exception e ) <nl> - { <nl> - logger _ . debug ( " Unable to mlockall " , e ) ; <nl> - / / skipping mlockall doesn ' t seem to be a Big Deal except on Linux . See CASSANDRA - 1214 <nl> - if ( System . getProperty ( " os . name " ) . toLowerCase ( ) . contains ( " linux " ) ) <nl> - { <nl> - logger _ . warn ( " Unable to lock JVM memory ( " + e . getMessage ( ) + " ) . " <nl> - + " This can result in part of the JVM being swapped out , especially with mmapped I / O enabled . " ) ; <nl> - } <nl> - else if ( ! System . getProperty ( " os . name " ) . toLowerCase ( ) . contains ( " windows " ) ) <nl> - { <nl> - logger _ . info ( " Unable to lock JVM memory : " + e . getMessage ( ) ) ; <nl> - } <nl> - return ; <nl> - } <nl> <nl> if ( errno ! = Integer . MIN _ VALUE ) <nl> { <nl> diff - - git a / test / unit / org / apache / cassandra / service / StorageServiceServerTest . java b / test / unit / org / apache / cassandra / service / StorageServiceServerTest . java <nl> index 8d342cc . . 369f522 100644 <nl> - - - a / test / unit / org / apache / cassandra / service / StorageServiceServerTest . java <nl> + + + b / test / unit / org / apache / cassandra / service / StorageServiceServerTest . java <nl> @ @ - 60 , 5 + 60 , 11 @ @ public class StorageServiceServerTest <nl> List < Token > toks = Collections . emptyList ( ) ; <nl> assertEquals ( Collections . emptyList ( ) , StorageService . instance . getAllRanges ( toks ) ) ; <nl> } <nl> - } <nl> <nl> + @ Test <nl> + public void testSnapshot ( ) throws IOException <nl> + { <nl> + / / no need to insert extra data , even an " empty " database will have a little information in the system keyspace <nl> + StorageService . instance . takeAllSnapshot ( null ) ; <nl> + } <nl> + }

TEST DIFF:
diff - - git a / src / java / org / apache / cassandra / utils / NanoTimeToCurrentTimeMillis . java b / src / java / org / apache / cassandra / utils / NanoTimeToCurrentTimeMillis . java 
 index a6c5d28 . . f124383 100644 
 - - - a / src / java / org / apache / cassandra / utils / NanoTimeToCurrentTimeMillis . java 
 + + + b / src / java / org / apache / cassandra / utils / NanoTimeToCurrentTimeMillis . java 
 @ @ - 46 , 7 + 46 , 7 @ @ public class NanoTimeToCurrentTimeMillis 
 * There is also the issue of how scalable nanoTime ( ) and currentTimeMillis ( ) are which is a moving target . 
 * 
 * These timestamps don ' t order with System . currentTimeMillis ( ) because currentTimeMillis ( ) can tick over 
 - * before this one does . I have seen it behind by as much as 2 milliseconds . 
 + * before this one does . I have seen it behind by as much as 2ms on Linux and 25ms on Windows . 
 * / 
 public static final long convert ( long nanoTime ) 
 { 
 diff - - git a / test / unit / org / apache / cassandra / utils / NanoTimeToCurrentTimeMillisTest . java b / test / unit / org / apache / cassandra / utils / NanoTimeToCurrentTimeMillisTest . java 
 index 5c025cf . . 1662e77 100644 
 - - - a / test / unit / org / apache / cassandra / utils / NanoTimeToCurrentTimeMillisTest . java 
 + + + b / test / unit / org / apache / cassandra / utils / NanoTimeToCurrentTimeMillisTest . java 
 @ @ - 40 , 13 + 40 , 19 @ @ public class NanoTimeToCurrentTimeMillisTest 
 } 
 Thread . sleep ( 1 ) ; 
 } 
 - nowNanos = Math . max ( now , System . nanoTime ( ) ) ; 
 + 
 + nowNanos = Math . max ( nowNanos , System . nanoTime ( ) ) ; 
 long convertedNow = NanoTimeToCurrentTimeMillis . convert ( nowNanos ) ; 
 - assertTrue ( " convertedNow = " + convertedNow + " lastConverted = " + lastConverted + " in iteration " + ii , convertedNow > = ( lastConverted - 1 ) ) ; 
 - lastConverted = convertedNow ; 
 - / / Seems to be off by as much as two milliseconds sadly 
 - assertTrue ( " now = " + now + " convertedNow = " + convertedNow + " in iteration " + ii , ( now - 2 ) < = convertedNow ) ; 
 
 + int maxDiff = FBUtilities . isWindows ( ) ? 15 : 1 ; 
 + assertTrue ( " convertedNow = " + convertedNow + " lastConverted = " + lastConverted + " in iteration " + ii , 
 + convertedNow > = ( lastConverted - maxDiff ) ) ; 
 + 
 + maxDiff = FBUtilities . isWindows ( ) ? 25 : 2 ; 
 + assertTrue ( " now = " + now + " convertedNow = " + convertedNow + " in iteration " + ii , 
 + ( maxDiff - 2 ) < = convertedNow ) ; 
 + 
 + lastConverted = convertedNow ; 
 } 
 } 
 }

NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 420138a . . 8db932b 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 21 , 6 + 21 , 7 @ @ dev 
 ( CASSANDRA - 1385 ) 
 * disallow invalid keyspace and column family names . This includes name that 
 matches a ' ^ \ w + ' regex . ( CASSANDRA - 1377 ) 
 + * use JNA , if present , to take snapshots ( CASSANDRA - 1371 ) 
 
 
 0 . 7 - beta1 
 diff - - git a / src / java / org / apache / cassandra / io / util / FileUtils . java b / src / java / org / apache / cassandra / io / util / FileUtils . java 
 index cd75871 . . eb1d0e5 100644 
 - - - a / src / java / org / apache / cassandra / io / util / FileUtils . java 
 + + + b / src / java / org / apache / cassandra / io / util / FileUtils . java 
 @ @ - 25 , 6 + 25 , 9 @ @ import java . util . * ; 
 import org . slf4j . Logger ; 
 import org . slf4j . LoggerFactory ; 
 
 + import com . sun . jna . Native ; 
 + import org . apache . cassandra . utils . CLibrary ; 
 + 
 
 public class FileUtils 
 { 
 @ @ - 206 , 6 + 209 , 30 @ @ public class FileUtils 
 * / 
 public static void createHardLink ( File sourceFile , File destinationFile ) throws IOException 
 { 
 + int errno = Integer . MIN _ VALUE ; 
 + try 
 + { 
 + int result = CLibrary . link ( sourceFile . getAbsolutePath ( ) , destinationFile . getAbsolutePath ( ) ) ; 
 + if ( result ! = 0 ) 
 + errno = Native . getLastError ( ) ; 
 + } 
 + catch ( UnsatisfiedLinkError e ) 
 + { 
 + createHardLinkWithExec ( sourceFile , destinationFile ) ; 
 + return ; 
 + } 
 + 
 + if ( errno ! = Integer . MIN _ VALUE ) 
 + { 
 + / / there are 17 different error codes listed on the man page . punt until / unless we find which 
 + / / ones actually turn up in practice . 
 + throw new IOException ( String . format ( " Unable to create hard link from % s to % s ( errno % d ) " , 
 + sourceFile , destinationFile , errno ) ) ; 
 + } 
 + } 
 + 
 + private static void createHardLinkWithExec ( File sourceFile , File destinationFile ) throws IOException 
 + { 
 String osname = System . getProperty ( " os . name " ) ; 
 ProcessBuilder pb ; 
 if ( osname . startsWith ( " Windows " ) ) 
 diff - - git a / src / java / org / apache / cassandra / utils / CLibrary . java b / src / java / org / apache / cassandra / utils / CLibrary . java 
 index 3682927 . . ee85a9a 100644 
 - - - a / src / java / org / apache / cassandra / utils / CLibrary . java 
 + + + b / src / java / org / apache / cassandra / utils / CLibrary . java 
 @ @ - 49 , 8 + 49 , 9 @ @ public final class CLibrary 
 } 
 
 public static native int mlockall ( int flags ) ; 
 - 
 public static native int munlockall ( ) ; 
 
 + public static native int link ( String from , String to ) ; 
 + 
 private CLibrary ( ) { } 
 } 
 diff - - git a / src / java / org / apache / cassandra / utils / FBUtilities . java b / src / java / org / apache / cassandra / utils / FBUtilities . java 
 index 4b846fb . . 366b888 100644 
 - - - a / src / java / org / apache / cassandra / utils / FBUtilities . java 
 + + + b / src / java / org / apache / cassandra / utils / FBUtilities . java 
 @ @ - 616 , 21 + 616 , 6 @ @ public class FBUtilities 
 / / this will have already been logged by CLibrary , no need to repeat it 
 return ; 
 } 
 - catch ( Exception e ) 
 - { 
 - logger _ . debug ( " Unable to mlockall " , e ) ; 
 - / / skipping mlockall doesn ' t seem to be a Big Deal except on Linux . See CASSANDRA - 1214 
 - if ( System . getProperty ( " os . name " ) . toLowerCase ( ) . contains ( " linux " ) ) 
 - { 
 - logger _ . warn ( " Unable to lock JVM memory ( " + e . getMessage ( ) + " ) . " 
 - + " This can result in part of the JVM being swapped out , especially with mmapped I / O enabled . " ) ; 
 - } 
 - else if ( ! System . getProperty ( " os . name " ) . toLowerCase ( ) . contains ( " windows " ) ) 
 - { 
 - logger _ . info ( " Unable to lock JVM memory : " + e . getMessage ( ) ) ; 
 - } 
 - return ; 
 - } 
 
 if ( errno ! = Integer . MIN _ VALUE ) 
 { 
 diff - - git a / test / unit / org / apache / cassandra / service / StorageServiceServerTest . java b / test / unit / org / apache / cassandra / service / StorageServiceServerTest . java 
 index 8d342cc . . 369f522 100644 
 - - - a / test / unit / org / apache / cassandra / service / StorageServiceServerTest . java 
 + + + b / test / unit / org / apache / cassandra / service / StorageServiceServerTest . java 
 @ @ - 60 , 5 + 60 , 11 @ @ public class StorageServiceServerTest 
 List < Token > toks = Collections . emptyList ( ) ; 
 assertEquals ( Collections . emptyList ( ) , StorageService . instance . getAllRanges ( toks ) ) ; 
 } 
 - } 
 
 + @ Test 
 + public void testSnapshot ( ) throws IOException 
 + { 
 + / / no need to insert extra data , even an " empty " database will have a little information in the system keyspace 
 + StorageService . instance . takeAllSnapshot ( null ) ; 
 + } 
 + }
