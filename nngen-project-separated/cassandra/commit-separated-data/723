BLEU SCORE: 0.013139808552042212

TEST MSG: Fixed flacky SSTableRewriterTest : check file counts before calling validateCFS ( CASSANDRA - 12348 )
GENERATED MSG: Replace IndexSummaryManagerTest . testCompactionRace with DataTrackerTest . testCompactOnlyCorrectInstance

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index e7d9066 . . 0f6bc50 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 3 . 9 <nl> + * Fixed flacky SSTableRewriterTest : check file counts before calling validateCFS ( CASSANDRA - 12348 ) <nl> * cqlsh : Fix handling of $ $ - escaped strings ( CASSANDRA - 12189 ) <nl> * Fix SSL JMX requiring truststore containing server cert ( CASSANDRA - 12109 ) <nl> Merged from 3 . 0 : <nl> diff - - git a / test / unit / org / apache / cassandra / io / sstable / SSTableRewriterTest . java b / test / unit / org / apache / cassandra / io / sstable / SSTableRewriterTest . java <nl> index 9c6da77 . . 246a7f0 100644 <nl> - - - a / test / unit / org / apache / cassandra / io / sstable / SSTableRewriterTest . java <nl> + + + b / test / unit / org / apache / cassandra / io / sstable / SSTableRewriterTest . java <nl> @ @ - 99 , 9 + 99 , 9 @ @ public class SSTableRewriterTest extends SSTableWriterTestBase <nl> writer . finish ( ) ; <nl> } <nl> LifecycleTransaction . waitForDeletions ( ) ; <nl> + assertEquals ( 1 , assertFileCounts ( sstables . iterator ( ) . next ( ) . descriptor . directory . list ( ) ) ) ; <nl> + <nl> validateCFS ( cfs ) ; <nl> - int filecounts = assertFileCounts ( sstables . iterator ( ) . next ( ) . descriptor . directory . list ( ) ) ; <nl> - assertEquals ( 1 , filecounts ) ; <nl> truncate ( cfs ) ; <nl> } <nl> @ Test <nl> @ @ - 131 , 9 + 131 , 9 @ @ public class SSTableRewriterTest extends SSTableWriterTestBase <nl> writer . finish ( ) ; <nl> } <nl> LifecycleTransaction . waitForDeletions ( ) ; <nl> + assertEquals ( 1 , assertFileCounts ( sstables . iterator ( ) . next ( ) . descriptor . directory . list ( ) ) ) ; <nl> + <nl> validateCFS ( cfs ) ; <nl> - int filecounts = assertFileCounts ( sstables . iterator ( ) . next ( ) . descriptor . directory . list ( ) ) ; <nl> - assertEquals ( 1 , filecounts ) ; <nl> } <nl> <nl> @ Test <nl> @ @ - 186 , 9 + 186 , 9 @ @ public class SSTableRewriterTest extends SSTableWriterTestBase <nl> writer . finish ( ) ; <nl> } <nl> LifecycleTransaction . waitForDeletions ( ) ; <nl> + assertEquals ( 1 , assertFileCounts ( sstables . iterator ( ) . next ( ) . descriptor . directory . list ( ) ) ) ; <nl> + <nl> validateCFS ( cfs ) ; <nl> - int filecounts = assertFileCounts ( sstables . iterator ( ) . next ( ) . descriptor . directory . list ( ) ) ; <nl> - assertEquals ( 1 , filecounts ) ; <nl> truncate ( cfs ) ; <nl> } <nl> <nl> diff - - git a / test / unit / org / apache / cassandra / io / sstable / SSTableWriterTestBase . java b / test / unit / org / apache / cassandra / io / sstable / SSTableWriterTestBase . java <nl> index 9c3bb19 . . c04fd35 100644 <nl> - - - a / test / unit / org / apache / cassandra / io / sstable / SSTableWriterTestBase . java <nl> + + + b / test / unit / org / apache / cassandra / io / sstable / SSTableWriterTestBase . java <nl> @ @ - 111 , 6 + 111 , 25 @ @ public class SSTableWriterTestBase extends SchemaLoader <nl> validateCFS ( cfs ) ; <nl> } <nl> <nl> + / * * <nl> + * Validate the column family store by checking that all live <nl> + * sstables are referenced only once and are not marked as <nl> + * compacting . It also checks that the generation of the data <nl> + * files on disk is the same as that of the live sstables , <nl> + * to ensure that the data files on disk belong to the live <nl> + * sstables . Finally , it checks that the metrics contain the <nl> + * correct disk space used , live and total . <nl> + * <nl> + * Note that this method will submit a maximal compaction task <nl> + * if there are live sstables , in order to check that there is at least <nl> + * a maximal task when there are live sstables . <nl> + * <nl> + * This method has therefore side effects and should be called after <nl> + * performing any other checks on previous operations , especially <nl> + * checks involving files on disk . <nl> + * <nl> + * @ param cfs - the column family store to validate <nl> + * / <nl> public static void validateCFS ( ColumnFamilyStore cfs ) <nl> { <nl> Set < Integer > liveDescriptors = new HashSet < > ( ) ; <nl> @ @ - 136 , 6 + 155 , 7 @ @ public class SSTableWriterTestBase extends SchemaLoader <nl> assertEquals ( spaceUsed , cfs . metric . liveDiskSpaceUsed . getCount ( ) ) ; <nl> assertEquals ( spaceUsed , cfs . metric . totalDiskSpaceUsed . getCount ( ) ) ; <nl> assertTrue ( cfs . getTracker ( ) . getCompacting ( ) . isEmpty ( ) ) ; <nl> + <nl> if ( cfs . getLiveSSTables ( ) . size ( ) > 0 ) <nl> assertFalse ( CompactionManager . instance . submitMaximal ( cfs , cfs . gcBefore ( ( int ) ( System . currentTimeMillis ( ) / 1000 ) ) , false ) . isEmpty ( ) ) ; <nl> }
NEAREST DIFF (one line): ELIMINATEDSENTENCE

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index e7d9066 . . 0f6bc50 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 3 . 9 
 + * Fixed flacky SSTableRewriterTest : check file counts before calling validateCFS ( CASSANDRA - 12348 ) 
 * cqlsh : Fix handling of $ $ - escaped strings ( CASSANDRA - 12189 ) 
 * Fix SSL JMX requiring truststore containing server cert ( CASSANDRA - 12109 ) 
 Merged from 3 . 0 : 
 diff - - git a / test / unit / org / apache / cassandra / io / sstable / SSTableRewriterTest . java b / test / unit / org / apache / cassandra / io / sstable / SSTableRewriterTest . java 
 index 9c6da77 . . 246a7f0 100644 
 - - - a / test / unit / org / apache / cassandra / io / sstable / SSTableRewriterTest . java 
 + + + b / test / unit / org / apache / cassandra / io / sstable / SSTableRewriterTest . java 
 @ @ - 99 , 9 + 99 , 9 @ @ public class SSTableRewriterTest extends SSTableWriterTestBase 
 writer . finish ( ) ; 
 } 
 LifecycleTransaction . waitForDeletions ( ) ; 
 + assertEquals ( 1 , assertFileCounts ( sstables . iterator ( ) . next ( ) . descriptor . directory . list ( ) ) ) ; 
 + 
 validateCFS ( cfs ) ; 
 - int filecounts = assertFileCounts ( sstables . iterator ( ) . next ( ) . descriptor . directory . list ( ) ) ; 
 - assertEquals ( 1 , filecounts ) ; 
 truncate ( cfs ) ; 
 } 
 @ Test 
 @ @ - 131 , 9 + 131 , 9 @ @ public class SSTableRewriterTest extends SSTableWriterTestBase 
 writer . finish ( ) ; 
 } 
 LifecycleTransaction . waitForDeletions ( ) ; 
 + assertEquals ( 1 , assertFileCounts ( sstables . iterator ( ) . next ( ) . descriptor . directory . list ( ) ) ) ; 
 + 
 validateCFS ( cfs ) ; 
 - int filecounts = assertFileCounts ( sstables . iterator ( ) . next ( ) . descriptor . directory . list ( ) ) ; 
 - assertEquals ( 1 , filecounts ) ; 
 } 
 
 @ Test 
 @ @ - 186 , 9 + 186 , 9 @ @ public class SSTableRewriterTest extends SSTableWriterTestBase 
 writer . finish ( ) ; 
 } 
 LifecycleTransaction . waitForDeletions ( ) ; 
 + assertEquals ( 1 , assertFileCounts ( sstables . iterator ( ) . next ( ) . descriptor . directory . list ( ) ) ) ; 
 + 
 validateCFS ( cfs ) ; 
 - int filecounts = assertFileCounts ( sstables . iterator ( ) . next ( ) . descriptor . directory . list ( ) ) ; 
 - assertEquals ( 1 , filecounts ) ; 
 truncate ( cfs ) ; 
 } 
 
 diff - - git a / test / unit / org / apache / cassandra / io / sstable / SSTableWriterTestBase . java b / test / unit / org / apache / cassandra / io / sstable / SSTableWriterTestBase . java 
 index 9c3bb19 . . c04fd35 100644 
 - - - a / test / unit / org / apache / cassandra / io / sstable / SSTableWriterTestBase . java 
 + + + b / test / unit / org / apache / cassandra / io / sstable / SSTableWriterTestBase . java 
 @ @ - 111 , 6 + 111 , 25 @ @ public class SSTableWriterTestBase extends SchemaLoader 
 validateCFS ( cfs ) ; 
 } 
 
 + / * * 
 + * Validate the column family store by checking that all live 
 + * sstables are referenced only once and are not marked as 
 + * compacting . It also checks that the generation of the data 
 + * files on disk is the same as that of the live sstables , 
 + * to ensure that the data files on disk belong to the live 
 + * sstables . Finally , it checks that the metrics contain the 
 + * correct disk space used , live and total . 
 + * 
 + * Note that this method will submit a maximal compaction task 
 + * if there are live sstables , in order to check that there is at least 
 + * a maximal task when there are live sstables . 
 + * 
 + * This method has therefore side effects and should be called after 
 + * performing any other checks on previous operations , especially 
 + * checks involving files on disk . 
 + * 
 + * @ param cfs - the column family store to validate 
 + * / 
 public static void validateCFS ( ColumnFamilyStore cfs ) 
 { 
 Set < Integer > liveDescriptors = new HashSet < > ( ) ; 
 @ @ - 136 , 6 + 155 , 7 @ @ public class SSTableWriterTestBase extends SchemaLoader 
 assertEquals ( spaceUsed , cfs . metric . liveDiskSpaceUsed . getCount ( ) ) ; 
 assertEquals ( spaceUsed , cfs . metric . totalDiskSpaceUsed . getCount ( ) ) ; 
 assertTrue ( cfs . getTracker ( ) . getCompacting ( ) . isEmpty ( ) ) ; 
 + 
 if ( cfs . getLiveSSTables ( ) . size ( ) > 0 ) 
 assertFalse ( CompactionManager . instance . submitMaximal ( cfs , cfs . gcBefore ( ( int ) ( System . currentTimeMillis ( ) / 1000 ) ) , false ) . isEmpty ( ) ) ; 
 }

NEAREST DIFF:
ELIMINATEDSENTENCE
