BLEU SCORE: 0.05522397783539471

TEST MSG: Fix NPE in StreamTransferTask . createMessageForRetry ( )
GENERATED MSG: Fix ConcurrentModificationException during streaming

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 14b43e5 . . d1d1030 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 2 . 0 . 9 <nl> + * Fix NPE in StreamTransferTask . createMessageForRetry ( ) ( CASSANDRA - 7323 ) <nl> * Add conditional CREATE / DROP USER support ( CASSANDRA - 7264 ) <nl> * Swap local and global default read repair chances ( CASSANDRA - 7320 ) <nl> * Add missing iso8601 patterns for date strings ( CASSANDRA - 6973 ) <nl> diff - - git a / src / java / org / apache / cassandra / streaming / StreamTransferTask . java b / src / java / org / apache / cassandra / streaming / StreamTransferTask . java <nl> index 7d0cc87 . . a543d01 100644 <nl> - - - a / src / java / org / apache / cassandra / streaming / StreamTransferTask . java <nl> + + + b / src / java / org / apache / cassandra / streaming / StreamTransferTask . java <nl> @ @ - 99 , 11 + 99 , 12 @ @ public class StreamTransferTask extends StreamTask <nl> return new ArrayList < > ( files . values ( ) ) ; <nl> } <nl> <nl> - public OutgoingFileMessage createMessageForRetry ( int sequenceNumber ) <nl> + public synchronized OutgoingFileMessage createMessageForRetry ( int sequenceNumber ) <nl> { <nl> / / remove previous time out task to be rescheduled later <nl> ScheduledFuture future = timeoutTasks . get ( sequenceNumber ) ; <nl> - future . cancel ( false ) ; <nl> + if ( future ! = null ) <nl> + future . cancel ( false ) ; <nl> return files . get ( sequenceNumber ) ; <nl> } <nl>
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 4d56c98 . . 20a6373 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 14 , 6 + 14 , 7 @ @ <nl> * Support streaming SSTables of old versions ( CASSANDRA - 5772 ) <nl> * Always respect protocol version in native protocol ( CASSANDRA - 5778 ) <nl> * Fix ConcurrentModificationException during streaming ( CASSANDRA - 5782 ) <nl> + * Update deletion timestamp in Commit # updatesWithPaxosTime ( CASSANDRA - 5787 ) <nl> <nl> <nl> 2 . 0 . 0 - beta1 <nl> diff - - git a / src / java / org / apache / cassandra / db / DeletionInfo . java b / src / java / org / apache / cassandra / db / DeletionInfo . java <nl> index 49aa427 . . 32cc2a7 100644 <nl> - - - a / src / java / org / apache / cassandra / db / DeletionInfo . java <nl> + + + b / src / java / org / apache / cassandra / db / DeletionInfo . java <nl> @ @ - 265 , 6 + 265 , 16 @ @ public class DeletionInfo <nl> return sb . toString ( ) ; <nl> } <nl> <nl> + / / Updates all the timestamp of the deletion contained in this DeletionInfo to be { @ code timestamp } . <nl> + public void updateAllTimestamp ( long timestamp ) <nl> + { <nl> + if ( topLevel . markedForDeleteAt ! = Long . MIN _ VALUE ) <nl> + topLevel = new DeletionTime ( timestamp , topLevel . localDeletionTime ) ; <nl> + <nl> + if ( ranges ! = null ) <nl> + ranges . updateAllTimestamp ( timestamp ) ; <nl> + } <nl> + <nl> @ Override <nl> public boolean equals ( Object o ) <nl> { <nl> diff - - git a / src / java / org / apache / cassandra / db / RangeTombstoneList . java b / src / java / org / apache / cassandra / db / RangeTombstoneList . java <nl> index 771b1a8 . . e99ed9f 100644 <nl> - - - a / src / java / org / apache / cassandra / db / RangeTombstoneList . java <nl> + + + b / src / java / org / apache / cassandra / db / RangeTombstoneList . java <nl> @ @ - 288 , 6 + 288 , 12 @ @ public class RangeTombstoneList implements Iterable < RangeTombstone > <nl> return max ; <nl> } <nl> <nl> + public void updateAllTimestamp ( long timestamp ) <nl> + { <nl> + for ( int i = 0 ; i < size ; i + + ) <nl> + markedAts [ i ] = timestamp ; <nl> + } <nl> + <nl> / * * <nl> * Removes all range tombstones whose local deletion time is older than gcBefore . <nl> * / <nl> diff - - git a / src / java / org / apache / cassandra / service / paxos / Commit . java b / src / java / org / apache / cassandra / service / paxos / Commit . java <nl> index fdc707b . . 04ddca8 100644 <nl> - - - a / src / java / org / apache / cassandra / service / paxos / Commit . java <nl> + + + b / src / java / org / apache / cassandra / service / paxos / Commit . java <nl> @ @ - 114 , 6 + 114 , 7 @ @ public class Commit <nl> { <nl> ColumnFamily cf = updates . cloneMeShallow ( ) ; <nl> long t = UUIDGen . microsTimestamp ( ballot ) ; <nl> + cf . deletionInfo ( ) . updateAllTimestamp ( t ) ; <nl> for ( Column column : updates ) <nl> cf . addAtom ( column . withUpdatedTimestamp ( t ) ) ; <nl> return cf ;

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 14b43e5 . . d1d1030 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 2 . 0 . 9 
 + * Fix NPE in StreamTransferTask . createMessageForRetry ( ) ( CASSANDRA - 7323 ) 
 * Add conditional CREATE / DROP USER support ( CASSANDRA - 7264 ) 
 * Swap local and global default read repair chances ( CASSANDRA - 7320 ) 
 * Add missing iso8601 patterns for date strings ( CASSANDRA - 6973 ) 
 diff - - git a / src / java / org / apache / cassandra / streaming / StreamTransferTask . java b / src / java / org / apache / cassandra / streaming / StreamTransferTask . java 
 index 7d0cc87 . . a543d01 100644 
 - - - a / src / java / org / apache / cassandra / streaming / StreamTransferTask . java 
 + + + b / src / java / org / apache / cassandra / streaming / StreamTransferTask . java 
 @ @ - 99 , 11 + 99 , 12 @ @ public class StreamTransferTask extends StreamTask 
 return new ArrayList < > ( files . values ( ) ) ; 
 } 
 
 - public OutgoingFileMessage createMessageForRetry ( int sequenceNumber ) 
 + public synchronized OutgoingFileMessage createMessageForRetry ( int sequenceNumber ) 
 { 
 / / remove previous time out task to be rescheduled later 
 ScheduledFuture future = timeoutTasks . get ( sequenceNumber ) ; 
 - future . cancel ( false ) ; 
 + if ( future ! = null ) 
 + future . cancel ( false ) ; 
 return files . get ( sequenceNumber ) ; 
 } 


NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 4d56c98 . . 20a6373 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 14 , 6 + 14 , 7 @ @ 
 * Support streaming SSTables of old versions ( CASSANDRA - 5772 ) 
 * Always respect protocol version in native protocol ( CASSANDRA - 5778 ) 
 * Fix ConcurrentModificationException during streaming ( CASSANDRA - 5782 ) 
 + * Update deletion timestamp in Commit # updatesWithPaxosTime ( CASSANDRA - 5787 ) 
 
 
 2 . 0 . 0 - beta1 
 diff - - git a / src / java / org / apache / cassandra / db / DeletionInfo . java b / src / java / org / apache / cassandra / db / DeletionInfo . java 
 index 49aa427 . . 32cc2a7 100644 
 - - - a / src / java / org / apache / cassandra / db / DeletionInfo . java 
 + + + b / src / java / org / apache / cassandra / db / DeletionInfo . java 
 @ @ - 265 , 6 + 265 , 16 @ @ public class DeletionInfo 
 return sb . toString ( ) ; 
 } 
 
 + / / Updates all the timestamp of the deletion contained in this DeletionInfo to be { @ code timestamp } . 
 + public void updateAllTimestamp ( long timestamp ) 
 + { 
 + if ( topLevel . markedForDeleteAt ! = Long . MIN _ VALUE ) 
 + topLevel = new DeletionTime ( timestamp , topLevel . localDeletionTime ) ; 
 + 
 + if ( ranges ! = null ) 
 + ranges . updateAllTimestamp ( timestamp ) ; 
 + } 
 + 
 @ Override 
 public boolean equals ( Object o ) 
 { 
 diff - - git a / src / java / org / apache / cassandra / db / RangeTombstoneList . java b / src / java / org / apache / cassandra / db / RangeTombstoneList . java 
 index 771b1a8 . . e99ed9f 100644 
 - - - a / src / java / org / apache / cassandra / db / RangeTombstoneList . java 
 + + + b / src / java / org / apache / cassandra / db / RangeTombstoneList . java 
 @ @ - 288 , 6 + 288 , 12 @ @ public class RangeTombstoneList implements Iterable < RangeTombstone > 
 return max ; 
 } 
 
 + public void updateAllTimestamp ( long timestamp ) 
 + { 
 + for ( int i = 0 ; i < size ; i + + ) 
 + markedAts [ i ] = timestamp ; 
 + } 
 + 
 / * * 
 * Removes all range tombstones whose local deletion time is older than gcBefore . 
 * / 
 diff - - git a / src / java / org / apache / cassandra / service / paxos / Commit . java b / src / java / org / apache / cassandra / service / paxos / Commit . java 
 index fdc707b . . 04ddca8 100644 
 - - - a / src / java / org / apache / cassandra / service / paxos / Commit . java 
 + + + b / src / java / org / apache / cassandra / service / paxos / Commit . java 
 @ @ - 114 , 6 + 114 , 7 @ @ public class Commit 
 { 
 ColumnFamily cf = updates . cloneMeShallow ( ) ; 
 long t = UUIDGen . microsTimestamp ( ballot ) ; 
 + cf . deletionInfo ( ) . updateAllTimestamp ( t ) ; 
 for ( Column column : updates ) 
 cf . addAtom ( column . withUpdatedTimestamp ( t ) ) ; 
 return cf ;
