BLEU SCORE: 0.04767707020457096

TEST MSG: Fix compactionstats layout for long ks / cf names
GENERATED MSG: add time remaining estimate to nodetool compactionstats

TEST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / tools / NodeTool . java b / src / java / org / apache / cassandra / tools / NodeTool . java <nl> index b25edd9 . . 6aca507 100644 <nl> - - - a / src / java / org / apache / cassandra / tools / NodeTool . java <nl> + + + b / src / java / org / apache / cassandra / tools / NodeTool . java <nl> @ @ - 1129 , 26 + 1129 , 56 @ @ public class NodeTool <nl> int compactionThroughput = probe . getCompactionThroughput ( ) ; <nl> CompactionManagerMBean cm = probe . getCompactionManagerProxy ( ) ; <nl> System . out . println ( " pending tasks : " + probe . getCompactionMetric ( " PendingTasks " ) ) ; <nl> - if ( cm . getCompactions ( ) . size ( ) > 0 ) <nl> - System . out . printf ( " % 25s % 16s % 16s % 16s % 16s % 10s % 10s % n " , " compaction type " , " keyspace " , " table " , " completed " , " total " , " unit " , " progress " ) ; <nl> long remainingBytes = 0 ; <nl> - for ( Map < String , String > c : cm . getCompactions ( ) ) <nl> - { <nl> - String percentComplete = new Long ( c . get ( " total " ) ) = = 0 <nl> - ? " n / a " <nl> - : new DecimalFormat ( " 0 . 00 " ) . format ( ( double ) new Long ( c . get ( " completed " ) ) / new Long ( c . get ( " total " ) ) * 100 ) + " % " ; <nl> - System . out . printf ( " % 25s % 16s % 16s % 16s % 16s % 10s % 10s % n " , c . get ( " taskType " ) , c . get ( " keyspace " ) , c . get ( " columnfamily " ) , c . get ( " completed " ) , c . get ( " total " ) , c . get ( " unit " ) , percentComplete ) ; <nl> - if ( c . get ( " taskType " ) . equals ( OperationType . COMPACTION . toString ( ) ) ) <nl> - remainingBytes + = ( new Long ( c . get ( " total " ) ) - new Long ( c . get ( " completed " ) ) ) ; <nl> + if ( cm . getCompactions ( ) . size ( ) > 0 ) <nl> + { <nl> + List < String [ ] > lines = new ArrayList < > ( ) ; <nl> + int [ ] columnSizes = new int [ ] { 0 , 0 , 0 , 0 , 0 , 0 , 0 } ; <nl> + <nl> + addLine ( lines , columnSizes , " compaction type " , " keyspace " , " table " , " completed " , " total " , " unit " , " progress " ) ; <nl> + for ( Map < String , String > c : cm . getCompactions ( ) ) <nl> + { <nl> + long total = Long . parseLong ( c . get ( " total " ) ) ; <nl> + long completed = Long . parseLong ( c . get ( " completed " ) ) ; <nl> + String taskType = c . get ( " taskType " ) ; <nl> + String keyspace = c . get ( " keyspace " ) ; <nl> + String columnFamily = c . get ( " columnfamily " ) ; <nl> + String unit = c . get ( " unit " ) ; <nl> + String percentComplete = total = = 0 ? " n / a " : new DecimalFormat ( " 0 . 00 " ) . format ( ( double ) completed / total * 100 ) + " % " ; <nl> + addLine ( lines , columnSizes , taskType , keyspace , columnFamily , Long . toString ( completed ) , Long . toString ( total ) , unit , percentComplete ) ; <nl> + if ( taskType . equals ( OperationType . COMPACTION . toString ( ) ) ) <nl> + remainingBytes + = total - completed ; <nl> + } <nl> + <nl> + StringBuilder buffer = new StringBuilder ( ) ; <nl> + for ( int columnSize : columnSizes ) { <nl> + buffer . append ( " % " ) ; <nl> + buffer . append ( columnSize + 3 ) ; <nl> + buffer . append ( " s " ) ; <nl> + } <nl> + buffer . append ( " % n " ) ; <nl> + String format = buffer . toString ( ) ; <nl> + <nl> + for ( String [ ] line : lines ) <nl> + { <nl> + System . out . printf ( format , line [ 0 ] , line [ 1 ] , line [ 2 ] , line [ 3 ] , line [ 4 ] , line [ 5 ] , line [ 6 ] ) ; <nl> + } <nl> + <nl> + String remainingTime = " n / a " ; <nl> + if ( compactionThroughput ! = 0 ) <nl> + { <nl> + long remainingTimeInSecs = remainingBytes / ( 1024L * 1024L * compactionThroughput ) ; <nl> + remainingTime = format ( " % dh % 02dm % 02ds " , remainingTimeInSecs / 3600 , ( remainingTimeInSecs % 3600 ) / 60 , ( remainingTimeInSecs % 60 ) ) ; <nl> + } <nl> + System . out . printf ( " % 25s % 10s % n " , " Active compaction remaining time : " , remainingTime ) ; <nl> + } <nl> + } <nl> + <nl> + private void addLine ( List < String [ ] > lines , int [ ] columnSizes , String . . . columns ) { <nl> + lines . add ( columns ) ; <nl> + for ( int i = 0 ; i < columns . length ; i + + ) { <nl> + columnSizes [ i ] = Math . max ( columnSizes [ i ] , columns [ i ] . length ( ) ) ; <nl> } <nl> - long remainingTimeInSecs = compactionThroughput = = 0 | | remainingBytes = = 0 <nl> - ? - 1 <nl> - : ( remainingBytes ) / ( 1024L * 1024L * compactionThroughput ) ; <nl> - String remainingTime = remainingTimeInSecs < 0 <nl> - ? " n / a " <nl> - : format ( " % dh % 02dm % 02ds " , remainingTimeInSecs / 3600 , ( remainingTimeInSecs % 3600 ) / 60 , ( remainingTimeInSecs % 60 ) ) ; <nl> - <nl> - System . out . printf ( " % 25s % 10s % n " , " Active compaction remaining time : " , remainingTime ) ; <nl> } <nl> } <nl>
NEAREST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 5c140ea . . 21cacb3 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 23 , 6 + 23 , 7 @ @ Merged from 1 . 0 : <nl> * avoid streaming empty files with bulk loader if sstablewriter errors out <nl> ( CASSANDRA - 3946 ) <nl> * fix stress build ( CASSANDRA - 4140 ) <nl> + * add time remaining estimate to nodetool compactionstats ( CASSANDRA - 4167 ) <nl> <nl> <nl> 1 . 1 - rc1 <nl> diff - - git a / src / java / org / apache / cassandra / tools / NodeCmd . java b / src / java / org / apache / cassandra / tools / NodeCmd . java <nl> index 346ee3b . . 14c2427 100644 <nl> - - - a / src / java / org / apache / cassandra / tools / NodeCmd . java <nl> + + + b / src / java / org / apache / cassandra / tools / NodeCmd . java <nl> @ @ - 38 , 6 + 38 , 7 @ @ import org . apache . cassandra . concurrent . JMXEnabledThreadPoolExecutorMBean ; <nl> import org . apache . cassandra . config . ConfigurationException ; <nl> import org . apache . cassandra . db . ColumnFamilyStoreMBean ; <nl> import org . apache . cassandra . db . compaction . CompactionManagerMBean ; <nl> + import org . apache . cassandra . db . compaction . OperationType ; <nl> import org . apache . cassandra . net . MessagingServiceMBean ; <nl> import org . apache . cassandra . thrift . InvalidRequestException ; <nl> import org . apache . cassandra . utils . EstimatedHistogram ; <nl> @ @ - 450 , 17 + 451 , 29 @ @ public class NodeCmd <nl> <nl> public void printCompactionStats ( PrintStream outs ) <nl> { <nl> + 	 int compactionThroughput = probe . getCompactionThroughput ( ) ; <nl> CompactionManagerMBean cm = probe . getCompactionManagerProxy ( ) ; <nl> outs . println ( " pending tasks : " + cm . getPendingTasks ( ) ) ; <nl> if ( cm . getCompactions ( ) . size ( ) > 0 ) <nl> outs . printf ( " % 25s % 16s % 16s % 16s % 16s % 10s % n " , " compaction type " , " keyspace " , " column family " , " bytes compacted " , " bytes total " , " progress " ) ; <nl> + long remainingBytes = 0 ; <nl> for ( Map < String , String > c : cm . getCompactions ( ) ) <nl> { <nl> String percentComplete = new Long ( c . get ( " totalBytes " ) ) = = 0 <nl> ? " n / a " <nl> : new DecimalFormat ( " 0 . 00 " ) . format ( ( double ) new Long ( c . get ( " bytesComplete " ) ) / new Long ( c . get ( " totalBytes " ) ) * 100 ) + " % " ; <nl> outs . printf ( " % 25s % 16s % 16s % 16s % 16s % 10s % n " , c . get ( " taskType " ) , c . get ( " keyspace " ) , c . get ( " columnfamily " ) , c . get ( " bytesComplete " ) , c . get ( " totalBytes " ) , percentComplete ) ; <nl> + if ( c . get ( " taskType " ) . equals ( OperationType . COMPACTION . toString ( ) ) ) <nl> + remainingBytes + = ( new Long ( c . get ( " totalBytes " ) ) - new Long ( c . get ( " bytesComplete " ) ) ) ; <nl> } <nl> + long remainingTimeInSecs = compactionThroughput = = 0 | | remainingBytes = = 0 <nl> + ? - 1 <nl> + : ( remainingBytes ) / ( long ) ( 1024L * 1024L * compactionThroughput ) ; <nl> + String remainingTime = remainingTimeInSecs < 0 <nl> + ? " n / a " <nl> + : String . format ( " % dh % 02dm % 02ds " , remainingTimeInSecs / 3600 , ( remainingTimeInSecs % 3600 ) / 60 , ( remainingTimeInSecs % 60 ) ) ; <nl> + <nl> + outs . printf ( " % 25s % 10s % n " , " Active compaction remaining time : " , remainingTime ) ; <nl> } <nl> <nl> public void printColumnFamilyStats ( PrintStream outs ) <nl> diff - - git a / src / java / org / apache / cassandra / tools / NodeProbe . java b / src / java / org / apache / cassandra / tools / NodeProbe . java <nl> index 077a8b4 . . 1d74a6b 100644 <nl> - - - a / src / java / org / apache / cassandra / tools / NodeProbe . java <nl> + + + b / src / java / org / apache / cassandra / tools / NodeProbe . java <nl> @ @ - 629 , 6 + 629 , 11 @ @ public class NodeProbe <nl> ssProxy . setCompactionThroughputMbPerSec ( value ) ; <nl> } <nl> <nl> + public int getCompactionThroughput ( ) <nl> + { <nl> + return ssProxy . getCompactionThroughputMbPerSec ( ) ; <nl> + } <nl> + <nl> public int getExceptionCount ( ) <nl> { <nl> return ssProxy . getExceptionCount ( ) ; <nl> diff - - git a / tools / bin / stress b / tools / bin / stress <nl> old mode 100644 <nl> new mode 100755 <nl> diff - - git a / tools / bin / stress . bat b / tools / bin / stress . bat <nl> old mode 100644 <nl> new mode 100755 <nl> diff - - git a / tools / bin / stressd b / tools / bin / stressd <nl> old mode 100644 <nl> new mode 100755

TEST DIFF:
diff - - git a / src / java / org / apache / cassandra / tools / NodeTool . java b / src / java / org / apache / cassandra / tools / NodeTool . java 
 index b25edd9 . . 6aca507 100644 
 - - - a / src / java / org / apache / cassandra / tools / NodeTool . java 
 + + + b / src / java / org / apache / cassandra / tools / NodeTool . java 
 @ @ - 1129 , 26 + 1129 , 56 @ @ public class NodeTool 
 int compactionThroughput = probe . getCompactionThroughput ( ) ; 
 CompactionManagerMBean cm = probe . getCompactionManagerProxy ( ) ; 
 System . out . println ( " pending tasks : " + probe . getCompactionMetric ( " PendingTasks " ) ) ; 
 - if ( cm . getCompactions ( ) . size ( ) > 0 ) 
 - System . out . printf ( " % 25s % 16s % 16s % 16s % 16s % 10s % 10s % n " , " compaction type " , " keyspace " , " table " , " completed " , " total " , " unit " , " progress " ) ; 
 long remainingBytes = 0 ; 
 - for ( Map < String , String > c : cm . getCompactions ( ) ) 
 - { 
 - String percentComplete = new Long ( c . get ( " total " ) ) = = 0 
 - ? " n / a " 
 - : new DecimalFormat ( " 0 . 00 " ) . format ( ( double ) new Long ( c . get ( " completed " ) ) / new Long ( c . get ( " total " ) ) * 100 ) + " % " ; 
 - System . out . printf ( " % 25s % 16s % 16s % 16s % 16s % 10s % 10s % n " , c . get ( " taskType " ) , c . get ( " keyspace " ) , c . get ( " columnfamily " ) , c . get ( " completed " ) , c . get ( " total " ) , c . get ( " unit " ) , percentComplete ) ; 
 - if ( c . get ( " taskType " ) . equals ( OperationType . COMPACTION . toString ( ) ) ) 
 - remainingBytes + = ( new Long ( c . get ( " total " ) ) - new Long ( c . get ( " completed " ) ) ) ; 
 + if ( cm . getCompactions ( ) . size ( ) > 0 ) 
 + { 
 + List < String [ ] > lines = new ArrayList < > ( ) ; 
 + int [ ] columnSizes = new int [ ] { 0 , 0 , 0 , 0 , 0 , 0 , 0 } ; 
 + 
 + addLine ( lines , columnSizes , " compaction type " , " keyspace " , " table " , " completed " , " total " , " unit " , " progress " ) ; 
 + for ( Map < String , String > c : cm . getCompactions ( ) ) 
 + { 
 + long total = Long . parseLong ( c . get ( " total " ) ) ; 
 + long completed = Long . parseLong ( c . get ( " completed " ) ) ; 
 + String taskType = c . get ( " taskType " ) ; 
 + String keyspace = c . get ( " keyspace " ) ; 
 + String columnFamily = c . get ( " columnfamily " ) ; 
 + String unit = c . get ( " unit " ) ; 
 + String percentComplete = total = = 0 ? " n / a " : new DecimalFormat ( " 0 . 00 " ) . format ( ( double ) completed / total * 100 ) + " % " ; 
 + addLine ( lines , columnSizes , taskType , keyspace , columnFamily , Long . toString ( completed ) , Long . toString ( total ) , unit , percentComplete ) ; 
 + if ( taskType . equals ( OperationType . COMPACTION . toString ( ) ) ) 
 + remainingBytes + = total - completed ; 
 + } 
 + 
 + StringBuilder buffer = new StringBuilder ( ) ; 
 + for ( int columnSize : columnSizes ) { 
 + buffer . append ( " % " ) ; 
 + buffer . append ( columnSize + 3 ) ; 
 + buffer . append ( " s " ) ; 
 + } 
 + buffer . append ( " % n " ) ; 
 + String format = buffer . toString ( ) ; 
 + 
 + for ( String [ ] line : lines ) 
 + { 
 + System . out . printf ( format , line [ 0 ] , line [ 1 ] , line [ 2 ] , line [ 3 ] , line [ 4 ] , line [ 5 ] , line [ 6 ] ) ; 
 + } 
 + 
 + String remainingTime = " n / a " ; 
 + if ( compactionThroughput ! = 0 ) 
 + { 
 + long remainingTimeInSecs = remainingBytes / ( 1024L * 1024L * compactionThroughput ) ; 
 + remainingTime = format ( " % dh % 02dm % 02ds " , remainingTimeInSecs / 3600 , ( remainingTimeInSecs % 3600 ) / 60 , ( remainingTimeInSecs % 60 ) ) ; 
 + } 
 + System . out . printf ( " % 25s % 10s % n " , " Active compaction remaining time : " , remainingTime ) ; 
 + } 
 + } 
 + 
 + private void addLine ( List < String [ ] > lines , int [ ] columnSizes , String . . . columns ) { 
 + lines . add ( columns ) ; 
 + for ( int i = 0 ; i < columns . length ; i + + ) { 
 + columnSizes [ i ] = Math . max ( columnSizes [ i ] , columns [ i ] . length ( ) ) ; 
 } 
 - long remainingTimeInSecs = compactionThroughput = = 0 | | remainingBytes = = 0 
 - ? - 1 
 - : ( remainingBytes ) / ( 1024L * 1024L * compactionThroughput ) ; 
 - String remainingTime = remainingTimeInSecs < 0 
 - ? " n / a " 
 - : format ( " % dh % 02dm % 02ds " , remainingTimeInSecs / 3600 , ( remainingTimeInSecs % 3600 ) / 60 , ( remainingTimeInSecs % 60 ) ) ; 
 - 
 - System . out . printf ( " % 25s % 10s % n " , " Active compaction remaining time : " , remainingTime ) ; 
 } 
 } 


NEAREST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 5c140ea . . 21cacb3 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 23 , 6 + 23 , 7 @ @ Merged from 1 . 0 : 
 * avoid streaming empty files with bulk loader if sstablewriter errors out 
 ( CASSANDRA - 3946 ) 
 * fix stress build ( CASSANDRA - 4140 ) 
 + * add time remaining estimate to nodetool compactionstats ( CASSANDRA - 4167 ) 
 
 
 1 . 1 - rc1 
 diff - - git a / src / java / org / apache / cassandra / tools / NodeCmd . java b / src / java / org / apache / cassandra / tools / NodeCmd . java 
 index 346ee3b . . 14c2427 100644 
 - - - a / src / java / org / apache / cassandra / tools / NodeCmd . java 
 + + + b / src / java / org / apache / cassandra / tools / NodeCmd . java 
 @ @ - 38 , 6 + 38 , 7 @ @ import org . apache . cassandra . concurrent . JMXEnabledThreadPoolExecutorMBean ; 
 import org . apache . cassandra . config . ConfigurationException ; 
 import org . apache . cassandra . db . ColumnFamilyStoreMBean ; 
 import org . apache . cassandra . db . compaction . CompactionManagerMBean ; 
 + import org . apache . cassandra . db . compaction . OperationType ; 
 import org . apache . cassandra . net . MessagingServiceMBean ; 
 import org . apache . cassandra . thrift . InvalidRequestException ; 
 import org . apache . cassandra . utils . EstimatedHistogram ; 
 @ @ - 450 , 17 + 451 , 29 @ @ public class NodeCmd 
 
 public void printCompactionStats ( PrintStream outs ) 
 { 
 + 	 int compactionThroughput = probe . getCompactionThroughput ( ) ; 
 CompactionManagerMBean cm = probe . getCompactionManagerProxy ( ) ; 
 outs . println ( " pending tasks : " + cm . getPendingTasks ( ) ) ; 
 if ( cm . getCompactions ( ) . size ( ) > 0 ) 
 outs . printf ( " % 25s % 16s % 16s % 16s % 16s % 10s % n " , " compaction type " , " keyspace " , " column family " , " bytes compacted " , " bytes total " , " progress " ) ; 
 + long remainingBytes = 0 ; 
 for ( Map < String , String > c : cm . getCompactions ( ) ) 
 { 
 String percentComplete = new Long ( c . get ( " totalBytes " ) ) = = 0 
 ? " n / a " 
 : new DecimalFormat ( " 0 . 00 " ) . format ( ( double ) new Long ( c . get ( " bytesComplete " ) ) / new Long ( c . get ( " totalBytes " ) ) * 100 ) + " % " ; 
 outs . printf ( " % 25s % 16s % 16s % 16s % 16s % 10s % n " , c . get ( " taskType " ) , c . get ( " keyspace " ) , c . get ( " columnfamily " ) , c . get ( " bytesComplete " ) , c . get ( " totalBytes " ) , percentComplete ) ; 
 + if ( c . get ( " taskType " ) . equals ( OperationType . COMPACTION . toString ( ) ) ) 
 + remainingBytes + = ( new Long ( c . get ( " totalBytes " ) ) - new Long ( c . get ( " bytesComplete " ) ) ) ; 
 } 
 + long remainingTimeInSecs = compactionThroughput = = 0 | | remainingBytes = = 0 
 + ? - 1 
 + : ( remainingBytes ) / ( long ) ( 1024L * 1024L * compactionThroughput ) ; 
 + String remainingTime = remainingTimeInSecs < 0 
 + ? " n / a " 
 + : String . format ( " % dh % 02dm % 02ds " , remainingTimeInSecs / 3600 , ( remainingTimeInSecs % 3600 ) / 60 , ( remainingTimeInSecs % 60 ) ) ; 
 + 
 + outs . printf ( " % 25s % 10s % n " , " Active compaction remaining time : " , remainingTime ) ; 
 } 
 
 public void printColumnFamilyStats ( PrintStream outs ) 
 diff - - git a / src / java / org / apache / cassandra / tools / NodeProbe . java b / src / java / org / apache / cassandra / tools / NodeProbe . java 
 index 077a8b4 . . 1d74a6b 100644 
 - - - a / src / java / org / apache / cassandra / tools / NodeProbe . java 
 + + + b / src / java / org / apache / cassandra / tools / NodeProbe . java 
 @ @ - 629 , 6 + 629 , 11 @ @ public class NodeProbe 
 ssProxy . setCompactionThroughputMbPerSec ( value ) ; 
 } 
 
 + public int getCompactionThroughput ( ) 
 + { 
 + return ssProxy . getCompactionThroughputMbPerSec ( ) ; 
 + } 
 + 
 public int getExceptionCount ( ) 
 { 
 return ssProxy . getExceptionCount ( ) ; 
 diff - - git a / tools / bin / stress b / tools / bin / stress 
 old mode 100644 
 new mode 100755 
 diff - - git a / tools / bin / stress . bat b / tools / bin / stress . bat 
 old mode 100644 
 new mode 100755 
 diff - - git a / tools / bin / stressd b / tools / bin / stressd 
 old mode 100644 
 new mode 100755
