BLEU SCORE: 0.03283637368030199

TEST MSG: Fix snapshot repair error on indexed tables
GENERATED MSG: merge from 1 . 1

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 3c3b838 . . e86ad5b 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 54 , 6 + 54 , 7 @ @ <nl> * Include snippet of CQL query near syntax error in messages ( CASSANDRA - 7111 ) <nl> * Make repair - pr work with - local ( CASSANDRA - 7450 ) <nl> * Fix error in sstableloader with - cph > 1 ( CASSANDRA - 8007 ) <nl> + * Fix snapshot repair error on indexed tables ( CASSANDRA - 8020 ) <nl> Merged from 2 . 0 : <nl> * Fix potential exception when using ReversedType in DynamicCompositeType <nl> ( CASSANDRA - 7898 ) <nl> diff - - git a / src / java / org / apache / cassandra / repair / RepairMessageVerbHandler . java b / src / java / org / apache / cassandra / repair / RepairMessageVerbHandler . java <nl> index 2dac5cd . . 54117a3 100644 <nl> - - - a / src / java / org / apache / cassandra / repair / RepairMessageVerbHandler . java <nl> + + + b / src / java / org / apache / cassandra / repair / RepairMessageVerbHandler . java <nl> @ @ - 32 , 6 + 32 , 7 @ @ import org . apache . cassandra . db . ColumnFamilyStore ; <nl> import org . apache . cassandra . db . Keyspace ; <nl> import org . apache . cassandra . db . compaction . CompactionManager ; <nl> import org . apache . cassandra . dht . Bounds ; <nl> + import org . apache . cassandra . dht . LocalPartitioner ; <nl> import org . apache . cassandra . dht . Range ; <nl> import org . apache . cassandra . dht . Token ; <nl> import org . apache . cassandra . io . sstable . SSTableReader ; <nl> @ @ - 80 , 7 + 81 , 9 @ @ public class RepairMessageVerbHandler implements IVerbHandler < RepairMessage > <nl> { <nl> public boolean apply ( SSTableReader sstable ) <nl> { <nl> - return sstable ! = null & & new Bounds < > ( sstable . first . getToken ( ) , sstable . last . getToken ( ) ) . intersects ( Collections . singleton ( repairingRange ) ) ; <nl> + return sstable ! = null & & <nl> + ! ( sstable . partitioner instanceof LocalPartitioner ) & & / / exclude SSTables from 2i <nl> + new Bounds < > ( sstable . first . getToken ( ) , sstable . last . getToken ( ) ) . intersects ( Collections . singleton ( repairingRange ) ) ; <nl> } <nl> } ) ; <nl>
NEAREST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / db / HintedHandOffManager . java b / src / java / org / apache / cassandra / db / HintedHandOffManager . java <nl> index a83fbab . . e2dc046 100644 <nl> - - - a / src / java / org / apache / cassandra / db / HintedHandOffManager . java <nl> + + + b / src / java / org / apache / cassandra / db / HintedHandOffManager . java <nl> @ @ - 391 , 7 + 391 , 9 @ @ public class HintedHandOffManager implements HintedHandOffManagerMBean <nl> { <nl> Token < ? > token = StorageService . getPartitioner ( ) . getTokenFactory ( ) . fromByteArray ( row . key . key ) ; <nl> InetAddress target = StorageService . instance . getTokenMetadata ( ) . getEndpoint ( token ) ; <nl> - scheduleHintDelivery ( target ) ; <nl> + / / token may have since been removed ( in which case we have just read back a tombstone ) <nl> + if ( target ! = null ) <nl> + scheduleHintDelivery ( target ) ; <nl> } <nl> <nl> if ( logger _ . isDebugEnabled ( ) )

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 3c3b838 . . e86ad5b 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 54 , 6 + 54 , 7 @ @ 
 * Include snippet of CQL query near syntax error in messages ( CASSANDRA - 7111 ) 
 * Make repair - pr work with - local ( CASSANDRA - 7450 ) 
 * Fix error in sstableloader with - cph > 1 ( CASSANDRA - 8007 ) 
 + * Fix snapshot repair error on indexed tables ( CASSANDRA - 8020 ) 
 Merged from 2 . 0 : 
 * Fix potential exception when using ReversedType in DynamicCompositeType 
 ( CASSANDRA - 7898 ) 
 diff - - git a / src / java / org / apache / cassandra / repair / RepairMessageVerbHandler . java b / src / java / org / apache / cassandra / repair / RepairMessageVerbHandler . java 
 index 2dac5cd . . 54117a3 100644 
 - - - a / src / java / org / apache / cassandra / repair / RepairMessageVerbHandler . java 
 + + + b / src / java / org / apache / cassandra / repair / RepairMessageVerbHandler . java 
 @ @ - 32 , 6 + 32 , 7 @ @ import org . apache . cassandra . db . ColumnFamilyStore ; 
 import org . apache . cassandra . db . Keyspace ; 
 import org . apache . cassandra . db . compaction . CompactionManager ; 
 import org . apache . cassandra . dht . Bounds ; 
 + import org . apache . cassandra . dht . LocalPartitioner ; 
 import org . apache . cassandra . dht . Range ; 
 import org . apache . cassandra . dht . Token ; 
 import org . apache . cassandra . io . sstable . SSTableReader ; 
 @ @ - 80 , 7 + 81 , 9 @ @ public class RepairMessageVerbHandler implements IVerbHandler < RepairMessage > 
 { 
 public boolean apply ( SSTableReader sstable ) 
 { 
 - return sstable ! = null & & new Bounds < > ( sstable . first . getToken ( ) , sstable . last . getToken ( ) ) . intersects ( Collections . singleton ( repairingRange ) ) ; 
 + return sstable ! = null & & 
 + ! ( sstable . partitioner instanceof LocalPartitioner ) & & / / exclude SSTables from 2i 
 + new Bounds < > ( sstable . first . getToken ( ) , sstable . last . getToken ( ) ) . intersects ( Collections . singleton ( repairingRange ) ) ; 
 } 
 } ) ; 


NEAREST DIFF:
diff - - git a / src / java / org / apache / cassandra / db / HintedHandOffManager . java b / src / java / org / apache / cassandra / db / HintedHandOffManager . java 
 index a83fbab . . e2dc046 100644 
 - - - a / src / java / org / apache / cassandra / db / HintedHandOffManager . java 
 + + + b / src / java / org / apache / cassandra / db / HintedHandOffManager . java 
 @ @ - 391 , 7 + 391 , 9 @ @ public class HintedHandOffManager implements HintedHandOffManagerMBean 
 { 
 Token < ? > token = StorageService . getPartitioner ( ) . getTokenFactory ( ) . fromByteArray ( row . key . key ) ; 
 InetAddress target = StorageService . instance . getTokenMetadata ( ) . getEndpoint ( token ) ; 
 - scheduleHintDelivery ( target ) ; 
 + / / token may have since been removed ( in which case we have just read back a tombstone ) 
 + if ( target ! = null ) 
 + scheduleHintDelivery ( target ) ; 
 } 
 
 if ( logger _ . isDebugEnabled ( ) )
