BLEU SCORE: 0.005913578458639753

TEST MSG: Mark MVs as built after successful bootstrap
GENERATED MSG: add StorageService . initClient , which starts up Gossiper without setting a token or anything other application state .

TEST DIFF (one line): diff - - git a / CHANGES . txt b / CHANGES . txt <nl> index 38660a0 . . 5621c93 100644 <nl> - - - a / CHANGES . txt <nl> + + + b / CHANGES . txt <nl> @ @ - 1 , 4 + 1 , 5 @ @ <nl> 3 . 0 . 11 <nl> + * Mark MVs as built after successful bootstrap ( CASSANDRA - 12984 ) <nl> * Estimated TS drop - time histogram updated with Cell . NO _ DELETION _ TIME ( CASSANDRA - 13040 ) <nl> * Nodetool compactionstats fails with NullPointerException ( CASSANDRA - 13021 ) <nl> * Thread local pools never cleaned up ( CASSANDRA - 13033 ) <nl> diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java <nl> index 71cbc35 . . 35b2423 100644 <nl> - - - a / src / java / org / apache / cassandra / service / StorageService . java <nl> + + + b / src / java / org / apache / cassandra / service / StorageService . java <nl> @ @ - 57 , 6 + 57 , 7 @ @ import org . apache . cassandra . concurrent . StageManager ; <nl> import org . apache . cassandra . config . CFMetaData ; <nl> import org . apache . cassandra . config . DatabaseDescriptor ; <nl> import org . apache . cassandra . config . Schema ; <nl> + import org . apache . cassandra . config . ViewDefinition ; <nl> import org . apache . cassandra . db . * ; <nl> import org . apache . cassandra . db . commitlog . CommitLog ; <nl> import org . apache . cassandra . db . compaction . CompactionManager ; <nl> @ @ - 1211 , 7 + 1212 , 7 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE <nl> @ Override <nl> public void onSuccess ( StreamState streamState ) <nl> { <nl> - isBootstrapMode = false ; <nl> + bootstrapFinished ( ) ; <nl> logger . info ( " Bootstrap completed ! for the tokens { } " , tokens ) ; <nl> } <nl> <nl> @ @ - 1233 , 6 + 1234 , 25 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE <nl> } <nl> } <nl> <nl> + / * * <nl> + * All MVs have been created during bootstrap , so mark them as built <nl> + * / <nl> + private void markViewsAsBuilt ( ) { <nl> + for ( String keyspace : Schema . instance . getUserKeyspaces ( ) ) <nl> + { <nl> + for ( ViewDefinition view : Schema . instance . getKSMetaData ( keyspace ) . views ) <nl> + SystemKeyspace . finishViewBuildStatus ( view . ksName , view . viewName ) ; <nl> + } <nl> + } <nl> + <nl> + / * * <nl> + * Called when bootstrap did finish successfully <nl> + * / <nl> + private void bootstrapFinished ( ) { <nl> + markViewsAsBuilt ( ) ; <nl> + isBootstrapMode = false ; <nl> + } <nl> + <nl> public boolean resumeBootstrap ( ) <nl> { <nl> if ( isBootstrapMode & & SystemKeyspace . bootstrapInProgress ( ) ) <nl> @ @ - 1250 , 7 + 1270 , 7 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE <nl> @ Override <nl> public void onSuccess ( StreamState streamState ) <nl> { <nl> - isBootstrapMode = false ; <nl> + bootstrapFinished ( ) ; <nl> / / start participating in the ring . <nl> / / pretend we are in survey mode so we can use joinRing ( ) here <nl> isSurveyMode = true ;
NEAREST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / config / DatabaseDescriptor . java b / src / java / org / apache / cassandra / config / DatabaseDescriptor . java <nl> index 6e5ab81 . . b2394b1 100644 <nl> - - - a / src / java / org / apache / cassandra / config / DatabaseDescriptor . java <nl> + + + b / src / java / org / apache / cassandra / config / DatabaseDescriptor . java <nl> @ @ - 390 , 22 + 390 , 9 @ @ public class DatabaseDescriptor <nl> columnIndexSizeInKB _ = Integer . parseInt ( columnIndexSizeInKB ) ; <nl> } <nl> <nl> - / * data file directory * / <nl> + / * data file and commit log directories . they get created later , when they ' re needed . * / <nl> dataFileDirectories _ = xmlUtils . getNodeValues ( " / Storage / DataFileDirectories / DataFileDirectory " ) ; <nl> - if ( dataFileDirectories _ . length = = 0 ) <nl> - { <nl> - throw new ConfigurationException ( " At least one DataFileDirectory must be specified " ) ; <nl> - } <nl> - for ( String dataFileDirectory : dataFileDirectories _ ) <nl> - FileUtils . createDirectory ( dataFileDirectory ) ; <nl> - <nl> - / * commit log directory * / <nl> logFileDirectory _ = xmlUtils . getNodeValue ( " / Storage / CommitLogDirectory " ) ; <nl> - if ( logFileDirectory _ = = null ) <nl> - { <nl> - throw new ConfigurationException ( " CommitLogDirectory must be specified " ) ; <nl> - } <nl> - FileUtils . createDirectory ( logFileDirectory _ ) ; <nl> <nl> / * threshold after which commit log should be rotated . * / <nl> String value = xmlUtils . getNodeValue ( " / Storage / CommitLogRotationThresholdInMB " ) ; <nl> @ @ - 547 , 9 + 534 , 6 @ @ public class DatabaseDescriptor <nl> tableToCFMetaDataMap _ . put ( Table . SYSTEM _ TABLE , systemMetadata ) ; <nl> tableKeysCachedFractions _ . put ( Table . SYSTEM _ TABLE , 0 . 0 ) ; <nl> <nl> - / * make sure we have a directory for each table * / <nl> - createTableDirectories ( ) ; <nl> - <nl> / * Load the seeds for node contact points * / <nl> String [ ] seeds = xmlUtils . getNodeValues ( " / Storage / Seeds / Seed " ) ; <nl> if ( seeds . length < = 0 ) <nl> @ @ - 603 , 11 + 587 , 31 @ @ public class DatabaseDescriptor <nl> } <nl> <nl> / * * <nl> - * Create the table directory in each data directory <nl> + * Creates all storage - related directories . <nl> + * @ throws IOException when a disk problem is encountered . <nl> * / <nl> - public static void createTableDirectories ( ) throws IOException <nl> + public static void createAllDirectories ( ) throws IOException <nl> { <nl> - for ( String dataFile : dataFileDirectories _ ) <nl> + try { <nl> + if ( dataFileDirectories _ . length = = 0 ) <nl> + { <nl> + throw new ConfigurationException ( " At least one DataFileDirectory must be specified " ) ; <nl> + } <nl> + for ( String dataFileDirectory : dataFileDirectories _ ) <nl> + FileUtils . createDirectory ( dataFileDirectory ) ; <nl> + if ( logFileDirectory _ = = null ) <nl> + { <nl> + throw new ConfigurationException ( " CommitLogDirectory must be specified " ) ; <nl> + } <nl> + FileUtils . createDirectory ( logFileDirectory _ ) ; <nl> + } <nl> + catch ( ConfigurationException ex ) { <nl> + logger _ . error ( " Fatal error : " + ex . getMessage ( ) ) ; <nl> + System . err . println ( " Bad configuration ; unable to start server " ) ; <nl> + System . exit ( 1 ) ; <nl> + } <nl> + / * make sure we have a directory for each table * / <nl> + for ( String dataFile : dataFileDirectories _ ) <nl> { <nl> FileUtils . createDirectory ( dataFile + File . separator + Table . SYSTEM _ TABLE ) ; <nl> for ( String table : tables _ ) <nl> diff - - git a / src / java / org / apache / cassandra / db / Table . java b / src / java / org / apache / cassandra / db / Table . java <nl> index 6d2fe48 . . 30d4dc2 100644 <nl> - - - a / src / java / org / apache / cassandra / db / Table . java <nl> + + + b / src / java / org / apache / cassandra / db / Table . java <nl> @ @ - 29 , 14 + 29 , 8 @ @ import java . util . concurrent . Future ; <nl> import org . apache . cassandra . config . DatabaseDescriptor ; <nl> import org . apache . cassandra . dht . Range ; <nl> import org . apache . cassandra . io . SSTableReader ; <nl> - import org . apache . cassandra . io . SSTableWriter ; <nl> import org . apache . cassandra . io . DataOutputBuffer ; <nl> import java . net . InetAddress ; <nl> - import org . apache . cassandra . net . Message ; <nl> - import org . apache . cassandra . net . MessagingService ; <nl> - import org . apache . cassandra . net . io . IStreamComplete ; <nl> - import org . apache . cassandra . net . io . StreamContextManager ; <nl> - import org . apache . cassandra . service . StorageService ; <nl> import org . apache . cassandra . utils . * ; <nl> import org . apache . cassandra . db . filter . * ; <nl> <nl> @ @ - 53 , 6 + 47 , 21 @ @ public class Table <nl> <nl> private static Timer flushTimer _ = new Timer ( " FLUSH - TIMER " ) ; <nl> <nl> + / / This is a result of pushing down the point in time when storage directories get created . It used to happen in <nl> + / / CassandraDaemon , but it is possible to call Table . open without a running daemon , so it made sense to ensure <nl> + / / proper directories here . <nl> + static <nl> + { <nl> + try <nl> + { <nl> + DatabaseDescriptor . createAllDirectories ( ) ; <nl> + } <nl> + catch ( IOException ex ) <nl> + { <nl> + throw new RuntimeException ( ex ) ; <nl> + } <nl> + } <nl> + <nl> / * <nl> * This class represents the metadata of this Table . The metadata <nl> * is basically the column family name and the ID associated with <nl> diff - - git a / src / java / org / apache / cassandra / gms / EndPointState . java b / src / java / org / apache / cassandra / gms / EndPointState . java <nl> index 2be33d9 . . 2db8e6e 100644 <nl> - - - a / src / java / org / apache / cassandra / gms / EndPointState . java <nl> + + + b / src / java / org / apache / cassandra / gms / EndPointState . java <nl> @ @ - 23 , 6 + 23 , 7 @ @ import java . io . DataOutputStream ; <nl> import java . io . IOException ; <nl> import java . util . * ; <nl> import org . apache . cassandra . io . ICompactSerializer ; <nl> + import org . apache . cassandra . service . StorageService ; <nl> <nl> import org . apache . log4j . Logger ; <nl> <nl> @ @ - 82 , 7 + 83 , 8 @ @ public class EndPointState <nl> } <nl> <nl> void addApplicationState ( String key , ApplicationState appState ) <nl> - { <nl> + { <nl> + assert ! StorageService . instance ( ) . isClientMode ( ) ; <nl> applicationState _ . put ( key , appState ) ; <nl> } <nl> <nl> diff - - git a / src / java / org / apache / cassandra / service / CassandraServer . java b / src / java / org / apache / cassandra / service / CassandraServer . java <nl> index 2cd3e5a . . 4600b80 100644 <nl> - - - a / src / java / org / apache / cassandra / service / CassandraServer . java <nl> + + + b / src / java / org / apache / cassandra / service / CassandraServer . java <nl> @ @ - 66 , 7 + 66 , 7 @ @ public class CassandraServer implements Cassandra . Iface <nl> 	 	 LogUtil . init ( ) ; <nl> 	 	 / / LogUtil . setLogLevel ( " com . facebook " , " DEBUG " ) ; <nl> 	 	 / / Start the storage service <nl> - 	 	 storageService . start ( ) ; <nl> + 	 	 storageService . initServer ( ) ; <nl> 	 } <nl> <nl> protected Map < String , ColumnFamily > readColumnFamily ( List < ReadCommand > commands , int consistency _ level ) <nl> diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java <nl> index 73bf9dd . . 7951ab4 100644 <nl> - - - a / src / java / org / apache / cassandra / service / StorageService . java <nl> + + + b / src / java / org / apache / cassandra / service / StorageService . java <nl> @ @ - 32 , 6 + 32 , 7 @ @ import javax . management . * ; <nl> import org . apache . cassandra . concurrent . * ; <nl> import org . apache . cassandra . config . DatabaseDescriptor ; <nl> import org . apache . cassandra . db . * ; <nl> + import org . apache . cassandra . db . filter . QueryPath ; <nl> import org . apache . cassandra . dht . * ; <nl> import org . apache . cassandra . gms . * ; <nl> import org . apache . cassandra . locator . * ; <nl> @ @ - 149 , 6 + 150 , 8 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto <nl> / * Are we starting this node in bootstrap mode ? * / <nl> private boolean isBootstrapMode ; <nl> private Set < InetAddress > bootstrapSet ; <nl> + / * when intialized as a client , we shouldn ' t write to the system table . * / <nl> + private boolean isClientMode ; <nl> <nl> public synchronized void addBootstrapSource ( InetAddress s ) <nl> { <nl> @ @ - 185 , 8 + 188 , 9 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto <nl> } <nl> <nl> / * * <nl> - * for bulk loading clients to be able to use tokenmetadata / messagingservice <nl> - * without fully starting storageservice / systemtable . <nl> + * Intended for operation in client - only ( non - storage mode ) . E . g . : for bulk loading clients <nl> + * to be able to use tokenmetadata / messagingservice without fully starting storageservice / systemtable , <nl> + * or java clients that wish to bypase Thrift entirely . <nl> * / <nl> public void updateForeignTokenUnsafe ( Token token , InetAddress endpoint ) <nl> { <nl> @ @ - 251 , 10 + 255 , 34 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto <nl> } <nl> return replicationStrategy ; <nl> } <nl> + <nl> + public void stopClient ( ) <nl> + { <nl> + Gossiper . instance ( ) . unregister ( this ) ; <nl> + Gossiper . instance ( ) . stop ( ) ; <nl> + MessagingService . shutdown ( ) ; <nl> + } <nl> + <nl> + public void initClient ( ) throws IOException <nl> + { <nl> + isClientMode = true ; <nl> + logger _ . info ( " Starting up client gossip " ) ; <nl> + MessagingService . instance ( ) . listen ( FBUtilities . getLocalAddress ( ) ) ; <nl> + MessagingService . instance ( ) . listenUDP ( FBUtilities . getLocalAddress ( ) ) ; <nl> + <nl> + SelectorManager . getSelectorManager ( ) . start ( ) ; <nl> + SelectorManager . getUdpSelectorManager ( ) . start ( ) ; <nl> + <nl> + Gossiper . instance ( ) . register ( this ) ; <nl> + Gossiper . instance ( ) . start ( FBUtilities . getLocalAddress ( ) , ( int ) ( System . currentTimeMillis ( ) / 1000 ) ) ; / / needed for node - ring gathering . <nl> + } <nl> <nl> - public void start ( ) throws IOException <nl> + public void initServer ( ) throws IOException <nl> { <nl> + isClientMode = false ; <nl> storageMetadata _ = SystemTable . initMetadata ( ) ; <nl> + DatabaseDescriptor . createAllDirectories ( ) ; <nl> + logger _ . info ( " Starting up server gossip " ) ; <nl> <nl> / * Listen for application messages * / <nl> MessagingService . instance ( ) . listen ( FBUtilities . getLocalAddress ( ) ) ; <nl> @ @ - 270 , 7 + 298 , 7 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto <nl> / / for bootstrap to get the load info it needs . <nl> / / ( we won ' t be part of the storage ring though until we add a nodeId to our state , below . ) <nl> Gossiper . instance ( ) . register ( this ) ; <nl> - Gossiper . instance ( ) . start ( FBUtilities . getLocalAddress ( ) , storageMetadata _ . getGeneration ( ) ) ; <nl> + Gossiper . instance ( ) . start ( FBUtilities . getLocalAddress ( ) , storageMetadata _ . getGeneration ( ) ) ; / / needed for node - ring gathering . <nl> <nl> if ( DatabaseDescriptor . isAutoBootstrap ( ) <nl> & & ! ( DatabaseDescriptor . getSeeds ( ) . contains ( FBUtilities . getLocalAddress ( ) ) | | SystemTable . isBootstrapped ( ) ) ) <nl> @ @ - 284 , 7 + 312 , 7 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto <nl> while ( isBootstrapMode ) <nl> { <nl> try <nl> - { <nl> + { <nl> Thread . sleep ( 100 ) ; <nl> } <nl> catch ( InterruptedException e ) <nl> @ @ - 405 , 7 + 433 , 10 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto <nl> Token token = getPartitioner ( ) . getTokenFactory ( ) . fromString ( state . getValue ( ) ) ; <nl> if ( logger _ . isDebugEnabled ( ) ) <nl> logger _ . debug ( endpoint + " state normal , token " + token ) ; <nl> - updateForeignToken ( token , endpoint ) ; <nl> + if ( isClientMode ) <nl> + updateForeignTokenUnsafe ( token , endpoint ) ; <nl> + else <nl> + updateForeignToken ( token , endpoint ) ; <nl> replicationStrategy _ . removeObsoletePendingRanges ( ) ; <nl> } <nl> else if ( STATE _ LEAVING . equals ( stateName ) ) <nl> @ @ - 499 , 7 + 530 , 8 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto <nl> <nl> public void onAlive ( InetAddress endpoint , EndPointState state ) <nl> { <nl> - deliverHints ( endpoint ) ; <nl> + if ( ! isClientMode ) <nl> + deliverHints ( endpoint ) ; <nl> } <nl> <nl> public void onDead ( InetAddress endpoint , EndPointState state ) { } <nl> @ @ - 983 , 6 + 1015 , 7 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto <nl> public void run ( ) <nl> { <nl> Gossiper . instance ( ) . stop ( ) ; <nl> + MessagingService . shutdown ( ) ; <nl> logger _ . info ( " DECOMMISSION FINISHED . " ) ; <nl> / / let op be responsible for killing the process <nl> } <nl> @ @ - 1111 , 4 + 1144 , 9 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto <nl> { <nl> tokenMetadata _ . clearPendingRanges ( ) ; <nl> } <nl> + <nl> + public boolean isClientMode ( ) <nl> + { <nl> + return isClientMode ; <nl> + } <nl> }

TEST DIFF:
diff - - git a / CHANGES . txt b / CHANGES . txt 
 index 38660a0 . . 5621c93 100644 
 - - - a / CHANGES . txt 
 + + + b / CHANGES . txt 
 @ @ - 1 , 4 + 1 , 5 @ @ 
 3 . 0 . 11 
 + * Mark MVs as built after successful bootstrap ( CASSANDRA - 12984 ) 
 * Estimated TS drop - time histogram updated with Cell . NO _ DELETION _ TIME ( CASSANDRA - 13040 ) 
 * Nodetool compactionstats fails with NullPointerException ( CASSANDRA - 13021 ) 
 * Thread local pools never cleaned up ( CASSANDRA - 13033 ) 
 diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java 
 index 71cbc35 . . 35b2423 100644 
 - - - a / src / java / org / apache / cassandra / service / StorageService . java 
 + + + b / src / java / org / apache / cassandra / service / StorageService . java 
 @ @ - 57 , 6 + 57 , 7 @ @ import org . apache . cassandra . concurrent . StageManager ; 
 import org . apache . cassandra . config . CFMetaData ; 
 import org . apache . cassandra . config . DatabaseDescriptor ; 
 import org . apache . cassandra . config . Schema ; 
 + import org . apache . cassandra . config . ViewDefinition ; 
 import org . apache . cassandra . db . * ; 
 import org . apache . cassandra . db . commitlog . CommitLog ; 
 import org . apache . cassandra . db . compaction . CompactionManager ; 
 @ @ - 1211 , 7 + 1212 , 7 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE 
 @ Override 
 public void onSuccess ( StreamState streamState ) 
 { 
 - isBootstrapMode = false ; 
 + bootstrapFinished ( ) ; 
 logger . info ( " Bootstrap completed ! for the tokens { } " , tokens ) ; 
 } 
 
 @ @ - 1233 , 6 + 1234 , 25 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE 
 } 
 } 
 
 + / * * 
 + * All MVs have been created during bootstrap , so mark them as built 
 + * / 
 + private void markViewsAsBuilt ( ) { 
 + for ( String keyspace : Schema . instance . getUserKeyspaces ( ) ) 
 + { 
 + for ( ViewDefinition view : Schema . instance . getKSMetaData ( keyspace ) . views ) 
 + SystemKeyspace . finishViewBuildStatus ( view . ksName , view . viewName ) ; 
 + } 
 + } 
 + 
 + / * * 
 + * Called when bootstrap did finish successfully 
 + * / 
 + private void bootstrapFinished ( ) { 
 + markViewsAsBuilt ( ) ; 
 + isBootstrapMode = false ; 
 + } 
 + 
 public boolean resumeBootstrap ( ) 
 { 
 if ( isBootstrapMode & & SystemKeyspace . bootstrapInProgress ( ) ) 
 @ @ - 1250 , 7 + 1270 , 7 @ @ public class StorageService extends NotificationBroadcasterSupport implements IE 
 @ Override 
 public void onSuccess ( StreamState streamState ) 
 { 
 - isBootstrapMode = false ; 
 + bootstrapFinished ( ) ; 
 / / start participating in the ring . 
 / / pretend we are in survey mode so we can use joinRing ( ) here 
 isSurveyMode = true ;

NEAREST DIFF:
diff - - git a / src / java / org / apache / cassandra / config / DatabaseDescriptor . java b / src / java / org / apache / cassandra / config / DatabaseDescriptor . java 
 index 6e5ab81 . . b2394b1 100644 
 - - - a / src / java / org / apache / cassandra / config / DatabaseDescriptor . java 
 + + + b / src / java / org / apache / cassandra / config / DatabaseDescriptor . java 
 @ @ - 390 , 22 + 390 , 9 @ @ public class DatabaseDescriptor 
 columnIndexSizeInKB _ = Integer . parseInt ( columnIndexSizeInKB ) ; 
 } 
 
 - / * data file directory * / 
 + / * data file and commit log directories . they get created later , when they ' re needed . * / 
 dataFileDirectories _ = xmlUtils . getNodeValues ( " / Storage / DataFileDirectories / DataFileDirectory " ) ; 
 - if ( dataFileDirectories _ . length = = 0 ) 
 - { 
 - throw new ConfigurationException ( " At least one DataFileDirectory must be specified " ) ; 
 - } 
 - for ( String dataFileDirectory : dataFileDirectories _ ) 
 - FileUtils . createDirectory ( dataFileDirectory ) ; 
 - 
 - / * commit log directory * / 
 logFileDirectory _ = xmlUtils . getNodeValue ( " / Storage / CommitLogDirectory " ) ; 
 - if ( logFileDirectory _ = = null ) 
 - { 
 - throw new ConfigurationException ( " CommitLogDirectory must be specified " ) ; 
 - } 
 - FileUtils . createDirectory ( logFileDirectory _ ) ; 
 
 / * threshold after which commit log should be rotated . * / 
 String value = xmlUtils . getNodeValue ( " / Storage / CommitLogRotationThresholdInMB " ) ; 
 @ @ - 547 , 9 + 534 , 6 @ @ public class DatabaseDescriptor 
 tableToCFMetaDataMap _ . put ( Table . SYSTEM _ TABLE , systemMetadata ) ; 
 tableKeysCachedFractions _ . put ( Table . SYSTEM _ TABLE , 0 . 0 ) ; 
 
 - / * make sure we have a directory for each table * / 
 - createTableDirectories ( ) ; 
 - 
 / * Load the seeds for node contact points * / 
 String [ ] seeds = xmlUtils . getNodeValues ( " / Storage / Seeds / Seed " ) ; 
 if ( seeds . length < = 0 ) 
 @ @ - 603 , 11 + 587 , 31 @ @ public class DatabaseDescriptor 
 } 
 
 / * * 
 - * Create the table directory in each data directory 
 + * Creates all storage - related directories . 
 + * @ throws IOException when a disk problem is encountered . 
 * / 
 - public static void createTableDirectories ( ) throws IOException 
 + public static void createAllDirectories ( ) throws IOException 
 { 
 - for ( String dataFile : dataFileDirectories _ ) 
 + try { 
 + if ( dataFileDirectories _ . length = = 0 ) 
 + { 
 + throw new ConfigurationException ( " At least one DataFileDirectory must be specified " ) ; 
 + } 
 + for ( String dataFileDirectory : dataFileDirectories _ ) 
 + FileUtils . createDirectory ( dataFileDirectory ) ; 
 + if ( logFileDirectory _ = = null ) 
 + { 
 + throw new ConfigurationException ( " CommitLogDirectory must be specified " ) ; 
 + } 
 + FileUtils . createDirectory ( logFileDirectory _ ) ; 
 + } 
 + catch ( ConfigurationException ex ) { 
 + logger _ . error ( " Fatal error : " + ex . getMessage ( ) ) ; 
 + System . err . println ( " Bad configuration ; unable to start server " ) ; 
 + System . exit ( 1 ) ; 
 + } 
 + / * make sure we have a directory for each table * / 
 + for ( String dataFile : dataFileDirectories _ ) 
 { 
 FileUtils . createDirectory ( dataFile + File . separator + Table . SYSTEM _ TABLE ) ; 
 for ( String table : tables _ ) 
 diff - - git a / src / java / org / apache / cassandra / db / Table . java b / src / java / org / apache / cassandra / db / Table . java 
 index 6d2fe48 . . 30d4dc2 100644 
 - - - a / src / java / org / apache / cassandra / db / Table . java 
 + + + b / src / java / org / apache / cassandra / db / Table . java 
 @ @ - 29 , 14 + 29 , 8 @ @ import java . util . concurrent . Future ; 
 import org . apache . cassandra . config . DatabaseDescriptor ; 
 import org . apache . cassandra . dht . Range ; 
 import org . apache . cassandra . io . SSTableReader ; 
 - import org . apache . cassandra . io . SSTableWriter ; 
 import org . apache . cassandra . io . DataOutputBuffer ; 
 import java . net . InetAddress ; 
 - import org . apache . cassandra . net . Message ; 
 - import org . apache . cassandra . net . MessagingService ; 
 - import org . apache . cassandra . net . io . IStreamComplete ; 
 - import org . apache . cassandra . net . io . StreamContextManager ; 
 - import org . apache . cassandra . service . StorageService ; 
 import org . apache . cassandra . utils . * ; 
 import org . apache . cassandra . db . filter . * ; 
 
 @ @ - 53 , 6 + 47 , 21 @ @ public class Table 
 
 private static Timer flushTimer _ = new Timer ( " FLUSH - TIMER " ) ; 
 
 + / / This is a result of pushing down the point in time when storage directories get created . It used to happen in 
 + / / CassandraDaemon , but it is possible to call Table . open without a running daemon , so it made sense to ensure 
 + / / proper directories here . 
 + static 
 + { 
 + try 
 + { 
 + DatabaseDescriptor . createAllDirectories ( ) ; 
 + } 
 + catch ( IOException ex ) 
 + { 
 + throw new RuntimeException ( ex ) ; 
 + } 
 + } 
 + 
 / * 
 * This class represents the metadata of this Table . The metadata 
 * is basically the column family name and the ID associated with 
 diff - - git a / src / java / org / apache / cassandra / gms / EndPointState . java b / src / java / org / apache / cassandra / gms / EndPointState . java 
 index 2be33d9 . . 2db8e6e 100644 
 - - - a / src / java / org / apache / cassandra / gms / EndPointState . java 
 + + + b / src / java / org / apache / cassandra / gms / EndPointState . java 
 @ @ - 23 , 6 + 23 , 7 @ @ import java . io . DataOutputStream ; 
 import java . io . IOException ; 
 import java . util . * ; 
 import org . apache . cassandra . io . ICompactSerializer ; 
 + import org . apache . cassandra . service . StorageService ; 
 
 import org . apache . log4j . Logger ; 
 
 @ @ - 82 , 7 + 83 , 8 @ @ public class EndPointState 
 } 
 
 void addApplicationState ( String key , ApplicationState appState ) 
 - { 
 + { 
 + assert ! StorageService . instance ( ) . isClientMode ( ) ; 
 applicationState _ . put ( key , appState ) ; 
 } 
 
 diff - - git a / src / java / org / apache / cassandra / service / CassandraServer . java b / src / java / org / apache / cassandra / service / CassandraServer . java 
 index 2cd3e5a . . 4600b80 100644 
 - - - a / src / java / org / apache / cassandra / service / CassandraServer . java 
 + + + b / src / java / org / apache / cassandra / service / CassandraServer . java 
 @ @ - 66 , 7 + 66 , 7 @ @ public class CassandraServer implements Cassandra . Iface 
 	 	 LogUtil . init ( ) ; 
 	 	 / / LogUtil . setLogLevel ( " com . facebook " , " DEBUG " ) ; 
 	 	 / / Start the storage service 
 - 	 	 storageService . start ( ) ; 
 + 	 	 storageService . initServer ( ) ; 
 	 } 
 
 protected Map < String , ColumnFamily > readColumnFamily ( List < ReadCommand > commands , int consistency _ level ) 
 diff - - git a / src / java / org / apache / cassandra / service / StorageService . java b / src / java / org / apache / cassandra / service / StorageService . java 
 index 73bf9dd . . 7951ab4 100644 
 - - - a / src / java / org / apache / cassandra / service / StorageService . java 
 + + + b / src / java / org / apache / cassandra / service / StorageService . java 
 @ @ - 32 , 6 + 32 , 7 @ @ import javax . management . * ; 
 import org . apache . cassandra . concurrent . * ; 
 import org . apache . cassandra . config . DatabaseDescriptor ; 
 import org . apache . cassandra . db . * ; 
 + import org . apache . cassandra . db . filter . QueryPath ; 
 import org . apache . cassandra . dht . * ; 
 import org . apache . cassandra . gms . * ; 
 import org . apache . cassandra . locator . * ; 
 @ @ - 149 , 6 + 150 , 8 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto 
 / * Are we starting this node in bootstrap mode ? * / 
 private boolean isBootstrapMode ; 
 private Set < InetAddress > bootstrapSet ; 
 + / * when intialized as a client , we shouldn ' t write to the system table . * / 
 + private boolean isClientMode ; 
 
 public synchronized void addBootstrapSource ( InetAddress s ) 
 { 
 @ @ - 185 , 8 + 188 , 9 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto 
 } 
 
 / * * 
 - * for bulk loading clients to be able to use tokenmetadata / messagingservice 
 - * without fully starting storageservice / systemtable . 
 + * Intended for operation in client - only ( non - storage mode ) . E . g . : for bulk loading clients 
 + * to be able to use tokenmetadata / messagingservice without fully starting storageservice / systemtable , 
 + * or java clients that wish to bypase Thrift entirely . 
 * / 
 public void updateForeignTokenUnsafe ( Token token , InetAddress endpoint ) 
 { 
 @ @ - 251 , 10 + 255 , 34 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto 
 } 
 return replicationStrategy ; 
 } 
 + 
 + public void stopClient ( ) 
 + { 
 + Gossiper . instance ( ) . unregister ( this ) ; 
 + Gossiper . instance ( ) . stop ( ) ; 
 + MessagingService . shutdown ( ) ; 
 + } 
 + 
 + public void initClient ( ) throws IOException 
 + { 
 + isClientMode = true ; 
 + logger _ . info ( " Starting up client gossip " ) ; 
 + MessagingService . instance ( ) . listen ( FBUtilities . getLocalAddress ( ) ) ; 
 + MessagingService . instance ( ) . listenUDP ( FBUtilities . getLocalAddress ( ) ) ; 
 + 
 + SelectorManager . getSelectorManager ( ) . start ( ) ; 
 + SelectorManager . getUdpSelectorManager ( ) . start ( ) ; 
 + 
 + Gossiper . instance ( ) . register ( this ) ; 
 + Gossiper . instance ( ) . start ( FBUtilities . getLocalAddress ( ) , ( int ) ( System . currentTimeMillis ( ) / 1000 ) ) ; / / needed for node - ring gathering . 
 + } 
 
 - public void start ( ) throws IOException 
 + public void initServer ( ) throws IOException 
 { 
 + isClientMode = false ; 
 storageMetadata _ = SystemTable . initMetadata ( ) ; 
 + DatabaseDescriptor . createAllDirectories ( ) ; 
 + logger _ . info ( " Starting up server gossip " ) ; 
 
 / * Listen for application messages * / 
 MessagingService . instance ( ) . listen ( FBUtilities . getLocalAddress ( ) ) ; 
 @ @ - 270 , 7 + 298 , 7 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto 
 / / for bootstrap to get the load info it needs . 
 / / ( we won ' t be part of the storage ring though until we add a nodeId to our state , below . ) 
 Gossiper . instance ( ) . register ( this ) ; 
 - Gossiper . instance ( ) . start ( FBUtilities . getLocalAddress ( ) , storageMetadata _ . getGeneration ( ) ) ; 
 + Gossiper . instance ( ) . start ( FBUtilities . getLocalAddress ( ) , storageMetadata _ . getGeneration ( ) ) ; / / needed for node - ring gathering . 
 
 if ( DatabaseDescriptor . isAutoBootstrap ( ) 
 & & ! ( DatabaseDescriptor . getSeeds ( ) . contains ( FBUtilities . getLocalAddress ( ) ) | | SystemTable . isBootstrapped ( ) ) ) 
 @ @ - 284 , 7 + 312 , 7 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto 
 while ( isBootstrapMode ) 
 { 
 try 
 - { 
 + { 
 Thread . sleep ( 100 ) ; 
 } 
 catch ( InterruptedException e ) 
 @ @ - 405 , 7 + 433 , 10 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto 
 Token token = getPartitioner ( ) . getTokenFactory ( ) . fromString ( state . getValue ( ) ) ; 
 if ( logger _ . isDebugEnabled ( ) ) 
 logger _ . debug ( endpoint + " state normal , token " + token ) ; 
 - updateForeignToken ( token , endpoint ) ; 
 + if ( isClientMode ) 
 + updateForeignTokenUnsafe ( token , endpoint ) ; 
 + else 
 + updateForeignToken ( token , endpoint ) ; 
 replicationStrategy _ . removeObsoletePendingRanges ( ) ; 
 } 
 else if ( STATE _ LEAVING . equals ( stateName ) ) 
 @ @ - 499 , 7 + 530 , 8 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto 
 
 public void onAlive ( InetAddress endpoint , EndPointState state ) 
 { 
 - deliverHints ( endpoint ) ; 
 + if ( ! isClientMode ) 
 + deliverHints ( endpoint ) ; 
 } 
 
 public void onDead ( InetAddress endpoint , EndPointState state ) { } 
 @ @ - 983 , 6 + 1015 , 7 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto 
 public void run ( ) 
 { 
 Gossiper . instance ( ) . stop ( ) ; 
 + MessagingService . shutdown ( ) ; 
 logger _ . info ( " DECOMMISSION FINISHED . " ) ; 
 / / let op be responsible for killing the process 
 } 
 @ @ - 1111 , 4 + 1144 , 9 @ @ public final class StorageService implements IEndPointStateChangeSubscriber , Sto 
 { 
 tokenMetadata _ . clearPendingRanges ( ) ; 
 } 
 + 
 + public boolean isClientMode ( ) 
 + { 
 + return isClientMode ; 
 + } 
 }
