BLEU SCORE: 0.011524190727977791

TEST MSG: Follow - up merge fix
GENERATED MSG: fix drop race with flush . patch by gdusbabek , reviewed by jbellis . CASSANDRA - 1631

TEST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / db / SizeEstimatesRecorder . java b / src / java / org / apache / cassandra / db / SizeEstimatesRecorder . java <nl> index dea5467 . . 1b30db3 100644 <nl> - - - a / src / java / org / apache / cassandra / db / SizeEstimatesRecorder . java <nl> + + + b / src / java / org / apache / cassandra / db / SizeEstimatesRecorder . java <nl> @ @ - 75 , 7 + 75 , 10 @ @ public class SizeEstimatesRecorder extends MigrationListener implements Runnable <nl> List < SSTableReader > sstables = null ; <nl> Refs < SSTableReader > refs = null ; <nl> while ( refs = = null ) <nl> - refs = Refs . tryRef ( table . viewFilter ( range . toRowBounds ( ) ) . apply ( table . getDataTracker ( ) . getView ( ) ) ) ; <nl> + { <nl> + sstables = table . viewFilter ( range . toRowBounds ( ) ) . apply ( table . getDataTracker ( ) . getView ( ) ) ; <nl> + refs = Refs . tryRef ( sstables ) ; <nl> + } <nl> <nl> long partitionsCount , meanPartitionSize ; <nl> try
NEAREST DIFF (one line): diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> index e8fcb46 . . 895331a 100644 <nl> - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java <nl> @ @ - 569 , 6 + 569 , 9 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean <nl> { <nl> if ( oldMemtable . isFrozen ( ) ) <nl> return null ; <nl> + <nl> + if ( DatabaseDescriptor . getCFMetaData ( metadata . cfId ) = = null ) <nl> + return null ; / / column family was dropped . no point in flushing . <nl> <nl> assert memtable = = oldMemtable ; <nl> memtable . freeze ( ) ; <nl> diff - - git a / src / java / org / apache / cassandra / db / CompactionManager . java b / src / java / org / apache / cassandra / db / CompactionManager . java <nl> index b588fac . . 057f4a2 100644 <nl> - - - a / src / java / org / apache / cassandra / db / CompactionManager . java <nl> + + + b / src / java / org / apache / cassandra / db / CompactionManager . java <nl> @ @ - 507 , 7 + 507 , 15 @ @ public class CompactionManager implements CompactionManagerMBean <nl> { <nl> for ( ColumnFamilyStore cfs : stores ) <nl> { <nl> - cfs . table . dropCf ( cfs . metadata . cfId ) ; <nl> + Table . flusherLock . writeLock ( ) . lock ( ) ; <nl> + try <nl> + { <nl> + cfs . table . dropCf ( cfs . metadata . cfId ) ; <nl> + } <nl> + finally <nl> + { <nl> + Table . flusherLock . writeLock ( ) . unlock ( ) ; <nl> + } <nl> } <nl> return null ; <nl> } <nl> diff - - git a / src / java / org / apache / cassandra / db / Table . java b / src / java / org / apache / cassandra / db / Table . java <nl> index bbea121 . . 0f5d4e6 100644 <nl> - - - a / src / java / org / apache / cassandra / db / Table . java <nl> + + + b / src / java / org / apache / cassandra / db / Table . java <nl> @ @ - 58 , 7 + 58 , 7 @ @ public class Table <nl> <nl> / * * <nl> * accesses to CFS . memtable should acquire this for thread safety . <nl> - * only Table . maybeSwitchMemtable should aquire the writeLock ; see that method for the full explanation . <nl> + * Table . maybeSwitchMemtable should aquire the writeLock ; see that method for the full explanation . <nl> * / <nl> static final ReentrantReadWriteLock flusherLock = new ReentrantReadWriteLock ( true ) ; <nl>

TEST DIFF:
diff - - git a / src / java / org / apache / cassandra / db / SizeEstimatesRecorder . java b / src / java / org / apache / cassandra / db / SizeEstimatesRecorder . java 
 index dea5467 . . 1b30db3 100644 
 - - - a / src / java / org / apache / cassandra / db / SizeEstimatesRecorder . java 
 + + + b / src / java / org / apache / cassandra / db / SizeEstimatesRecorder . java 
 @ @ - 75 , 7 + 75 , 10 @ @ public class SizeEstimatesRecorder extends MigrationListener implements Runnable 
 List < SSTableReader > sstables = null ; 
 Refs < SSTableReader > refs = null ; 
 while ( refs = = null ) 
 - refs = Refs . tryRef ( table . viewFilter ( range . toRowBounds ( ) ) . apply ( table . getDataTracker ( ) . getView ( ) ) ) ; 
 + { 
 + sstables = table . viewFilter ( range . toRowBounds ( ) ) . apply ( table . getDataTracker ( ) . getView ( ) ) ; 
 + refs = Refs . tryRef ( sstables ) ; 
 + } 
 
 long partitionsCount , meanPartitionSize ; 
 try

NEAREST DIFF:
diff - - git a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 index e8fcb46 . . 895331a 100644 
 - - - a / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 + + + b / src / java / org / apache / cassandra / db / ColumnFamilyStore . java 
 @ @ - 569 , 6 + 569 , 9 @ @ public class ColumnFamilyStore implements ColumnFamilyStoreMBean 
 { 
 if ( oldMemtable . isFrozen ( ) ) 
 return null ; 
 + 
 + if ( DatabaseDescriptor . getCFMetaData ( metadata . cfId ) = = null ) 
 + return null ; / / column family was dropped . no point in flushing . 
 
 assert memtable = = oldMemtable ; 
 memtable . freeze ( ) ; 
 diff - - git a / src / java / org / apache / cassandra / db / CompactionManager . java b / src / java / org / apache / cassandra / db / CompactionManager . java 
 index b588fac . . 057f4a2 100644 
 - - - a / src / java / org / apache / cassandra / db / CompactionManager . java 
 + + + b / src / java / org / apache / cassandra / db / CompactionManager . java 
 @ @ - 507 , 7 + 507 , 15 @ @ public class CompactionManager implements CompactionManagerMBean 
 { 
 for ( ColumnFamilyStore cfs : stores ) 
 { 
 - cfs . table . dropCf ( cfs . metadata . cfId ) ; 
 + Table . flusherLock . writeLock ( ) . lock ( ) ; 
 + try 
 + { 
 + cfs . table . dropCf ( cfs . metadata . cfId ) ; 
 + } 
 + finally 
 + { 
 + Table . flusherLock . writeLock ( ) . unlock ( ) ; 
 + } 
 } 
 return null ; 
 } 
 diff - - git a / src / java / org / apache / cassandra / db / Table . java b / src / java / org / apache / cassandra / db / Table . java 
 index bbea121 . . 0f5d4e6 100644 
 - - - a / src / java / org / apache / cassandra / db / Table . java 
 + + + b / src / java / org / apache / cassandra / db / Table . java 
 @ @ - 58 , 7 + 58 , 7 @ @ public class Table 
 
 / * * 
 * accesses to CFS . memtable should acquire this for thread safety . 
 - * only Table . maybeSwitchMemtable should aquire the writeLock ; see that method for the full explanation . 
 + * Table . maybeSwitchMemtable should aquire the writeLock ; see that method for the full explanation . 
 * / 
 static final ReentrantReadWriteLock flusherLock = new ReentrantReadWriteLock ( true ) ; 

