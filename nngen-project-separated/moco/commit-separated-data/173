BLEU SCORE: 0.027611988917697356

TEST MSG: converted list value to iterable value in maps
GENERATED MSG: enabled multiple headers with same name

TEST DIFF (one line): diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java <nl> index 327c6cb . . 9ecc0ff 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java <nl> @ @ - 6 , 11 + 6 , 10 @ @ import com . google . common . collect . ImmutableMap ; <nl> import com . google . common . collect . Iterables ; <nl> <nl> import java . lang . reflect . ParameterizedType ; <nl> - import java . util . List ; <nl> import java . util . Map ; <nl> <nl> import static com . github . dreamhead . moco . model . MessageContent . content ; <nl> - import static com . github . dreamhead . moco . util . Maps . listValueToArray ; <nl> + import static com . github . dreamhead . moco . util . Maps . iterableValueToArray ; <nl> import static com . github . dreamhead . moco . util . Maps . simpleValueToArray ; <nl> import static com . google . common . collect . ImmutableMap . copyOf ; <nl> <nl> @ @ - 109 , 8 + 108 , 8 @ @ public abstract class DefaultHttpMessage implements HttpMessage { <nl> return copyOf ( ( Map < String , String [ ] > ) headers ) ; <nl> } <nl> <nl> - if ( value instanceof List ) { <nl> - return listValueToArray ( ( Map < String , List < String > > ) headers ) ; <nl> + if ( value instanceof Iterable ) { <nl> + return iterableValueToArray ( ( Map < String , Iterable < String > > ) headers ) ; <nl> } <nl> <nl> throw new IllegalArgumentException ( " Unknown header value type [ " + value . getClass ( ) + " ] " ) ; <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java <nl> index 76507b3 . . 32a427e 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java <nl> @ @ - 12 , 7 + 12 , 6 @ @ import com . google . common . base . Optional ; <nl> import com . google . common . base . Supplier ; <nl> import com . google . common . base . Suppliers ; <nl> import com . google . common . collect . ImmutableMap ; <nl> - import com . google . common . collect . Iterables ; <nl> import io . netty . buffer . ByteBuf ; <nl> import io . netty . buffer . ByteBufInputStream ; <nl> import io . netty . buffer . Unpooled ; <nl> @ @ - 29 , 8 + 28 , 6 @ @ import java . util . List ; <nl> import java . util . Map ; <nl> <nl> import static com . github . dreamhead . moco . model . MessageContent . content ; <nl> - import static com . github . dreamhead . moco . util . Maps . listValueToArray ; <nl> - import static com . github . dreamhead . moco . util . Maps . simpleValueToArray ; <nl> import static com . google . common . collect . ImmutableMap . copyOf ; <nl> <nl> @ JsonDeserialize ( builder = DefaultHttpRequest . Builder . class ) <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpResponse . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpResponse . java <nl> index 1e4a165 . . c9a2fd9 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpResponse . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpResponse . java <nl> @ @ - 28 , 7 + 28 , 7 @ @ public class DefaultHttpResponse extends DefaultHttpMessage implements HttpRespo <nl> return status ; <nl> } <nl> <nl> - public static DefaultHttpResponse newResponse ( final FullHttpResponse response ) { <nl> + public static HttpResponse newResponse ( final FullHttpResponse response ) { <nl> ImmutableMap . Builder < String , String > headerBuilder = ImmutableMap . builder ( ) ; <nl> for ( Map . Entry < String , String > entry : response . headers ( ) ) { <nl> headerBuilder . put ( entry ) ; <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / util / Maps . java b / moco - core / src / main / java / com / github / dreamhead / moco / util / Maps . java <nl> index a35bec0 . . 24ad670 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / util / Maps . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / util / Maps . java <nl> @ @ - 1 , 8 + 1 , 8 @ @ <nl> package com . github . dreamhead . moco . util ; <nl> <nl> import com . google . common . collect . ImmutableMap ; <nl> + import com . google . common . collect . Iterables ; <nl> <nl> - import java . util . List ; <nl> import java . util . Map ; <nl> <nl> public class Maps { <nl> @ @ - 24 , 11 + 24 , 11 @ @ public class Maps { <nl> return builder . build ( ) ; <nl> } <nl> <nl> - public static ImmutableMap < String , String [ ] > listValueToArray ( final Map < String , List < String > > map ) { <nl> + public static ImmutableMap < String , String [ ] > iterableValueToArray ( final Map < String , Iterable < String > > map ) { <nl> ImmutableMap . Builder < String , String [ ] > builder = ImmutableMap . builder ( ) ; <nl> - for ( Map . Entry < String , List < String > > entry : map . entrySet ( ) ) { <nl> - List < String > value = entry . getValue ( ) ; <nl> - builder . put ( entry . getKey ( ) , value . toArray ( new String [ value . size ( ) ] ) ) ; <nl> + for ( Map . Entry < String , Iterable < String > > entry : map . entrySet ( ) ) { <nl> + Iterable < String > value = entry . getValue ( ) ; <nl> + builder . put ( entry . getKey ( ) , Iterables . toArray ( value , String . class ) ) ; <nl> } <nl> <nl> return builder . build ( ) ; <nl> diff - - git a / moco - core / src / test / java / com / github / dreamhead / moco / MocoProxyTest . java b / moco - core / src / test / java / com / github / dreamhead / moco / MocoProxyTest . java <nl> index 0c8bbcc . . 3c5be08 100644 <nl> - - - a / moco - core / src / test / java / com / github / dreamhead / moco / MocoProxyTest . java <nl> + + + b / moco - core / src / test / java / com / github / dreamhead / moco / MocoProxyTest . java <nl> @ @ - 233 , 7 + 233 , 7 @ @ public class MocoProxyTest extends AbstractMocoHttpTest { <nl> <nl> @ Test <nl> public void should _ failover _ with _ same _ response _ once ( ) throws Exception { <nl> - server = httpServer ( port ( ) , log ( ) ) ; <nl> + server = httpServer ( port ( ) ) ; <nl> server . post ( and ( by ( uri ( " / target " ) ) , by ( " proxy " ) ) ) . response ( " 0XCAFEBABE " ) ; <nl> final File tempFile = tempFolder . newFile ( ) ; <nl> server . request ( by ( uri ( " / proxy " ) ) ) . response ( proxy ( remoteUrl ( " / target " ) , failover ( tempFile . getAbsolutePath ( ) ) ) ) ; <nl> diff - - git a / moco - core / src / test / java / com / github / dreamhead / moco / dumper / HttpDumpersTest . java b / moco - core / src / test / java / com / github / dreamhead / moco / dumper / HttpDumpersTest . java <nl> index 2b9bf89 . . 2d5e30c 100644 <nl> - - - a / moco - core / src / test / java / com / github / dreamhead / moco / dumper / HttpDumpersTest . java <nl> + + + b / moco - core / src / test / java / com / github / dreamhead / moco / dumper / HttpDumpersTest . java <nl> @ @ - 68 , 13 + 68 , 13 @ @ public class HttpDumpersTest { <nl> } <nl> <nl> @ Test <nl> - public void should _ parse _ complete _ form _ urlencoded _ media _ type ( ) throws Exception { <nl> + public void should _ parse _ complete _ form _ urlencoded _ media _ type ( ) { <nl> assertMessageContent ( " application / x - www - form - urlencoded ; charset = UTF - 8 " , EXPECTED _ MESSAGE _ BODY ) ; <nl> } <nl> <nl> @ Test <nl> @ SuppressWarnings ( " unchecked " ) <nl> - public void should _ not _ parse _ content _ when _ content _ length _ not _ set ( ) throws Exception { <nl> + public void should _ not _ parse _ content _ when _ content _ length _ not _ set ( ) { <nl> assertThat ( asContent ( messageWithHeaders ( EMPTY _ MAP ) ) , isEmptyString ( ) ) ; <nl> } <nl> <nl> @ @ - 85 , 7 + 85 , 7 @ @ public class HttpDumpersTest { <nl> private HttpMessage messageWithHeaders ( final Map < String , String > headers ) { <nl> return DefaultHttpResponse . builder ( ) <nl> . forHeaders ( headers ) <nl> - . withContent ( MessageContent . content ( MESSAGE _ BODY ) ) <nl> + . withTextContent ( MESSAGE _ BODY ) <nl> . build ( ) ; <nl> } <nl> <nl> diff - - git a / moco - core / src / test / java / com / github / dreamhead / moco / extractor / JsonPathRequestExtractorTest . java b / moco - core / src / test / java / com / github / dreamhead / moco / extractor / JsonPathRequestExtractorTest . java <nl> index a7b3bbb . . 80be424 100644 <nl> - - - a / moco - core / src / test / java / com / github / dreamhead / moco / extractor / JsonPathRequestExtractorTest . java <nl> + + + b / moco - core / src / test / java / com / github / dreamhead / moco / extractor / JsonPathRequestExtractorTest . java <nl> @ @ - 15 , 7 + 15 , 8 @ @ public class JsonPathRequestExtractorTest { <nl> public void should _ extract _ empty _ content _ as _ absent ( ) { <nl> JsonPathRequestExtractor unitUnderTest = new JsonPathRequestExtractor ( " $ . . account " ) ; <nl> HttpRequest request = DefaultHttpRequest . builder ( ) <nl> - . withContent ( MessageContent . content ( " " ) ) . build ( ) ; <nl> + . withTextContent ( " " ) <nl> + . build ( ) ; <nl> Optional < Object > result = unitUnderTest . extract ( request ) ; <nl> assertThat ( result . isPresent ( ) , is ( false ) ) ; <nl> } <nl> diff - - git a / moco - core / src / test / java / com / github / dreamhead / moco / extractor / XPathRequestExtractorTest . java b / moco - core / src / test / java / com / github / dreamhead / moco / extractor / XPathRequestExtractorTest . java <nl> index 13dd597 . . 67a52ae 100644 <nl> - - - a / moco - core / src / test / java / com / github / dreamhead / moco / extractor / XPathRequestExtractorTest . java <nl> + + + b / moco - core / src / test / java / com / github / dreamhead / moco / extractor / XPathRequestExtractorTest . java <nl> @ @ - 13 , 7 + 13 , 7 @ @ public class XPathRequestExtractorTest { <nl> @ Test <nl> public void should _ extract _ empty _ content _ as _ absent ( ) { <nl> XPathRequestExtractor unitUnderTest = new XPathRequestExtractor ( " / request / parameters / id / text ( ) " ) ; <nl> - HttpRequest request = DefaultHttpRequest . builder ( ) . withContent ( MessageContent . content ( " " ) ) . build ( ) ; <nl> + HttpRequest request = DefaultHttpRequest . builder ( ) . withTextContent ( " " ) . build ( ) ; <nl> Optional < String [ ] > result = unitUnderTest . extract ( request ) ; <nl> assertThat ( result . isPresent ( ) , is ( false ) ) ; <nl> } <nl> diff - - git a / moco - core / src / test / java / com / github / dreamhead / moco / matcher / XmlRequestMatcherTest . java b / moco - core / src / test / java / com / github / dreamhead / moco / matcher / XmlRequestMatcherTest . java <nl> index 664d517 . . 1fe66e2 100644 <nl> - - - a / moco - core / src / test / java / com / github / dreamhead / moco / matcher / XmlRequestMatcherTest . java <nl> + + + b / moco - core / src / test / java / com / github / dreamhead / moco / matcher / XmlRequestMatcherTest . java <nl> @ @ - 13 , 7 + 13 , 7 @ @ public class XmlRequestMatcherTest { <nl> @ Test <nl> public void should _ return _ false _ for _ empty _ content ( ) { <nl> XmlRequestMatcher unitUnderTest = new XmlRequestMatcher ( text ( " < request > < parameters > < id > 1 < / id > < / parameters > < / request > " ) ) ; <nl> - HttpRequest request = DefaultHttpRequest . builder ( ) . withContent ( MessageContent . content ( " " ) ) . build ( ) ; <nl> + HttpRequest request = DefaultHttpRequest . builder ( ) . withTextContent ( " " ) . build ( ) ; <nl> assertThat ( unitUnderTest . match ( request ) , is ( false ) ) ; <nl> } <nl> }
NEAREST DIFF (one line): diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / HttpMessage . java b / moco - core / src / main / java / com / github / dreamhead / moco / HttpMessage . java <nl> index 9deacc4 . . c68f37d 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / HttpMessage . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / HttpMessage . java <nl> @ @ - 5 , 7 + 5 , 7 @ @ import com . google . common . collect . ImmutableMap ; <nl> public interface HttpMessage extends Message { <nl> HttpProtocolVersion getVersion ( ) ; <nl> <nl> - ImmutableMap < String , String > getHeaders ( ) ; <nl> + ImmutableMap < String , String [ ] > getHeaders ( ) ; <nl> <nl> String getHeader ( String name ) ; <nl> } <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpRequestDumper . java b / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpRequestDumper . java <nl> index c268a16 . . e4d125d 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpRequestDumper . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpRequestDumper . java <nl> @ @ - 6 , 6 + 6 , 7 @ @ import com . google . common . base . Joiner ; <nl> import io . netty . util . internal . StringUtil ; <nl> <nl> import static com . github . dreamhead . moco . dumper . HttpDumpers . asContent ; <nl> + import static com . github . dreamhead . moco . util . Maps . asSimple ; <nl> <nl> public final class HttpRequestDumper implements Dumper < Request > { <nl> private final Joiner . MapJoiner headerJoiner = Joiner . on ( StringUtil . NEWLINE ) . withKeyValueSeparator ( " : " ) ; <nl> @ @ - 16 , 7 + 17 , 7 @ @ public final class HttpRequestDumper implements Dumper < Request > { <nl> StringBuilder buf = new StringBuilder ( ) ; <nl> buf . append ( requestProtocolLine ( httpRequest ) ) <nl> . append ( StringUtil . NEWLINE ) <nl> - . append ( headerJoiner . join ( httpRequest . getHeaders ( ) ) ) <nl> + . append ( headerJoiner . join ( asSimple ( httpRequest . getHeaders ( ) ) ) ) <nl> . append ( asContent ( httpRequest ) ) ; <nl> return buf . toString ( ) ; <nl> } <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpResponseDumper . java b / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpResponseDumper . java <nl> index 34fa0df . . e64c5c8 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpResponseDumper . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpResponseDumper . java <nl> @ @ - 6 , 6 + 6 , 7 @ @ import com . google . common . base . Joiner ; <nl> import io . netty . util . internal . StringUtil ; <nl> <nl> import static com . github . dreamhead . moco . dumper . HttpDumpers . asContent ; <nl> + import static com . github . dreamhead . moco . util . Maps . asSimple ; <nl> <nl> public class HttpResponseDumper implements Dumper < Response > { <nl> private final Joiner . MapJoiner headerJoiner = Joiner . on ( StringUtil . NEWLINE ) . withKeyValueSeparator ( " : " ) ; <nl> @ @ - 16 , 7 + 17 , 7 @ @ public class HttpResponseDumper implements Dumper < Response > { <nl> return new StringBuilder ( ) <nl> . append ( responseProtocolLine ( httpResponse ) ) <nl> . append ( StringUtil . NEWLINE ) <nl> - . append ( headerJoiner . join ( httpResponse . getHeaders ( ) ) ) <nl> + . append ( headerJoiner . join ( asSimple ( httpResponse . getHeaders ( ) ) ) ) <nl> . append ( asContent ( httpResponse ) ) <nl> . toString ( ) ; <nl> } <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / extractor / HeaderRequestExtractor . java b / moco - core / src / main / java / com / github / dreamhead / moco / extractor / HeaderRequestExtractor . java <nl> index 2af3908 . . 62ecb09 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / extractor / HeaderRequestExtractor . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / extractor / HeaderRequestExtractor . java <nl> @ @ - 4 , 7 + 4 , 6 @ @ import com . github . dreamhead . moco . HttpRequest ; <nl> import com . github . dreamhead . moco . HttpRequestExtractor ; <nl> import com . google . common . base . Function ; <nl> import com . google . common . base . Optional ; <nl> - import com . google . common . collect . ImmutableMap ; <nl> <nl> import java . util . Map ; <nl> <nl> @ @ - 22 , 8 + 21 , 7 @ @ public class HeaderRequestExtractor extends HttpRequestExtractor < String [ ] > { <nl> <nl> @ Override <nl> protected Optional < String [ ] > doExtract ( final HttpRequest request ) { <nl> - final ImmutableMap < String , String > headers = request . getHeaders ( ) ; <nl> - String [ ] extractedValues = from ( headers . entrySet ( ) ) <nl> + String [ ] extractedValues = from ( request . getHeaders ( ) . entrySet ( ) ) <nl> . filter ( isForHeaderName ( name ) ) <nl> . transform ( toValue ( ) ) <nl> . toArray ( String . class ) ; <nl> @ @ - 35 , 11 + 33 , 12 @ @ public class HeaderRequestExtractor extends HttpRequestExtractor < String [ ] > { <nl> return absent ( ) ; <nl> } <nl> <nl> - private Function < Map . Entry < String , String > , String > toValue ( ) { <nl> - return new Function < Map . Entry < String , String > , String > ( ) { <nl> + / / TO FLAT <nl> + private Function < Map . Entry < String , String [ ] > , String > toValue ( ) { <nl> + return new Function < Map . Entry < String , String [ ] > , String > ( ) { <nl> @ Override <nl> - public String apply ( final Map . Entry < String , String > input ) { <nl> - return input . getValue ( ) ; <nl> + public String apply ( final Map . Entry < String , String [ ] > input ) { <nl> + return input . getValue ( ) [ 0 ] ; <nl> } <nl> } ; <nl> } <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / handler / AbstractProxyResponseHandler . java b / moco - core / src / main / java / com / github / dreamhead / moco / handler / AbstractProxyResponseHandler . java <nl> index ea80fac . . 12a3f1e 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / handler / AbstractProxyResponseHandler . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / handler / AbstractProxyResponseHandler . java <nl> @ @ - 236 , 9 + 236 , 13 @ @ public abstract class AbstractProxyResponseHandler extends AbstractHttpResponseH <nl> private void doWritHttpResponse ( final HttpResponse response , final MutableHttpResponse httpResponse ) { <nl> httpResponse . setVersion ( response . getVersion ( ) ) ; <nl> httpResponse . setStatus ( response . getStatus ( ) ) ; <nl> - for ( Map . Entry < String , String > entry : response . getHeaders ( ) . entrySet ( ) ) { <nl> - httpResponse . addHeader ( entry . getKey ( ) , entry . getValue ( ) ) ; <nl> + for ( Map . Entry < String , String [ ] > entry : response . getHeaders ( ) . entrySet ( ) ) { <nl> + String key = entry . getKey ( ) ; <nl> + for ( String value : entry . getValue ( ) ) { <nl> + httpResponse . addHeader ( key , value ) ; <nl> + } <nl> } <nl> + <nl> httpResponse . setContent ( response . getContent ( ) ) ; <nl> } <nl> <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java <nl> index 46fb0f2 . . 7233273 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java <nl> @ @ - 4 , 8 + 4 , 6 @ @ import com . github . dreamhead . moco . HttpMessage ; <nl> import com . github . dreamhead . moco . HttpProtocolVersion ; <nl> import com . google . common . collect . ImmutableMap ; <nl> <nl> - import static com . github . dreamhead . moco . util . Maps . asSimple ; <nl> - <nl> public abstract class DefaultHttpMessage implements HttpMessage { <nl> private final HttpProtocolVersion version ; <nl> private final MessageContent content ; <nl> @ @ - 25 , 8 + 23 , 8 @ @ public abstract class DefaultHttpMessage implements HttpMessage { <nl> } <nl> <nl> @ Override <nl> - public ImmutableMap < String , String > getHeaders ( ) { <nl> - return asSimple ( this . headers ) ; <nl> + public ImmutableMap < String , String [ ] > getHeaders ( ) { <nl> + return this . headers ; <nl> } <nl> <nl> @ Override <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java <nl> index f67feb0 . . afbcd07 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java <nl> @ @ - 177 , 8 + 177 , 12 @ @ public final class DefaultHttpRequest extends DefaultHttpMessage implements Http <nl> <nl> FullHttpRequest request = new DefaultFullHttpRequest ( HttpVersion . valueOf ( getVersion ( ) . text ( ) ) , <nl> io . netty . handler . codec . http . HttpMethod . valueOf ( method . name ( ) ) , encoder . toString ( ) , buffer ) ; <nl> - for ( Map . Entry < String , String > entry : getHeaders ( ) . entrySet ( ) ) { <nl> - request . headers ( ) . add ( entry . getKey ( ) , entry . getValue ( ) ) ; <nl> + <nl> + for ( Map . Entry < String , String [ ] > entry : getHeaders ( ) . entrySet ( ) ) { <nl> + String key = entry . getKey ( ) ; <nl> + for ( String value : entry . getValue ( ) ) { <nl> + request . headers ( ) . add ( key , value ) ; <nl> + } <nl> } <nl> <nl> return request ; <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultMutableHttpResponse . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultMutableHttpResponse . java <nl> index cc1c3ac . . ba562e3 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultMutableHttpResponse . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultMutableHttpResponse . java <nl> @ @ - 12 , 8 + 12 , 6 @ @ import io . netty . handler . codec . http . HttpVersion ; <nl> <nl> import java . util . Map ; <nl> <nl> - import static com . github . dreamhead . moco . util . Maps . asSimple ; <nl> - <nl> public final class DefaultMutableHttpResponse implements MutableHttpResponse { <nl> private HttpProtocolVersion version ; <nl> private Map < String , String [ ] > headers = Maps . newHashMap ( ) ; <nl> @ @ - 80 , 8 + 78 , 8 @ @ public final class DefaultMutableHttpResponse implements MutableHttpResponse { <nl> } <nl> <nl> @ Override <nl> - public ImmutableMap < String , String > getHeaders ( ) { <nl> - return asSimple ( ImmutableMap . copyOf ( this . headers ) ) ; <nl> + public ImmutableMap < String , String [ ] > getHeaders ( ) { <nl> + return ImmutableMap . copyOf ( this . headers ) ; <nl> } <nl> <nl> @ Override <nl> @ @ - 104 , 8 + 102 , 12 @ @ public final class DefaultMutableHttpResponse implements MutableHttpResponse { <nl> public FullHttpResponse toFullResponse ( ) { <nl> FullHttpResponse response = new DefaultFullHttpResponse ( HttpVersion . valueOf ( this . version . text ( ) ) , <nl> HttpResponseStatus . valueOf ( this . status ) ) ; <nl> - for ( Map . Entry < String , String > entry : getHeaders ( ) . entrySet ( ) ) { <nl> - response . headers ( ) . add ( entry . getKey ( ) , entry . getValue ( ) ) ; <nl> + <nl> + for ( Map . Entry < String , String [ ] > entry : getHeaders ( ) . entrySet ( ) ) { <nl> + String key = entry . getKey ( ) ; <nl> + for ( String value : entry . getValue ( ) ) { <nl> + response . headers ( ) . add ( key , value ) ; <nl> + } <nl> } <nl> <nl> if ( this . content ! = null ) { <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java b / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java <nl> index 11964e1 . . 70d8de4 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java <nl> @ @ - 7 , 6 + 7 , 8 @ @ import com . github . dreamhead . moco . model . DefaultHttpRequest ; <nl> import com . github . dreamhead . moco . model . MessageContent ; <nl> import com . google . common . collect . ImmutableMap ; <nl> <nl> + import static com . github . dreamhead . moco . util . Maps . asSimple ; <nl> + <nl> public class TemplateRequest { <nl> private Request request ; <nl> <nl> @ @ - 28 , 7 + 30 , 7 @ @ public class TemplateRequest { <nl> <nl> public ImmutableMap < String , String > getHeaders ( ) { <nl> if ( this . request instanceof HttpRequest ) { <nl> - return ( ( HttpRequest ) this . request ) . getHeaders ( ) ; <nl> + return asSimple ( ( ( HttpRequest ) this . request ) . getHeaders ( ) ) ; <nl> } <nl> <nl> throw new IllegalArgumentException ( " Request is not HTTP request " ) ; <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / util / HttpHeaders . java b / moco - core / src / main / java / com / github / dreamhead / moco / util / HttpHeaders . java <nl> index dbf905e . . fa5d6a2 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / util / HttpHeaders . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / util / HttpHeaders . java <nl> @ @ - 9 , 10 + 9 , 10 @ @ public final class HttpHeaders { <nl> return key . equalsIgnoreCase ( name ) ; <nl> } <nl> <nl> - public static Predicate < Map . Entry < String , String > > isForHeaderName ( final String key ) { <nl> - return new Predicate < Map . Entry < String , String > > ( ) { <nl> + public static Predicate < Map . Entry < String , String [ ] > > isForHeaderName ( final String key ) { <nl> + return new Predicate < Map . Entry < String , String [ ] > > ( ) { <nl> @ Override <nl> - public boolean apply ( final Map . Entry < String , String > input ) { <nl> + public boolean apply ( final Map . Entry < String , String [ ] > input ) { <nl> return isSameHeaderName ( input . getKey ( ) , key ) ; <nl> } <nl> } ;

TEST DIFF:
diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java 
 index 327c6cb . . 9ecc0ff 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java 
 @ @ - 6 , 11 + 6 , 10 @ @ import com . google . common . collect . ImmutableMap ; 
 import com . google . common . collect . Iterables ; 
 
 import java . lang . reflect . ParameterizedType ; 
 - import java . util . List ; 
 import java . util . Map ; 
 
 import static com . github . dreamhead . moco . model . MessageContent . content ; 
 - import static com . github . dreamhead . moco . util . Maps . listValueToArray ; 
 + import static com . github . dreamhead . moco . util . Maps . iterableValueToArray ; 
 import static com . github . dreamhead . moco . util . Maps . simpleValueToArray ; 
 import static com . google . common . collect . ImmutableMap . copyOf ; 
 
 @ @ - 109 , 8 + 108 , 8 @ @ public abstract class DefaultHttpMessage implements HttpMessage { 
 return copyOf ( ( Map < String , String [ ] > ) headers ) ; 
 } 
 
 - if ( value instanceof List ) { 
 - return listValueToArray ( ( Map < String , List < String > > ) headers ) ; 
 + if ( value instanceof Iterable ) { 
 + return iterableValueToArray ( ( Map < String , Iterable < String > > ) headers ) ; 
 } 
 
 throw new IllegalArgumentException ( " Unknown header value type [ " + value . getClass ( ) + " ] " ) ; 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java 
 index 76507b3 . . 32a427e 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java 
 @ @ - 12 , 7 + 12 , 6 @ @ import com . google . common . base . Optional ; 
 import com . google . common . base . Supplier ; 
 import com . google . common . base . Suppliers ; 
 import com . google . common . collect . ImmutableMap ; 
 - import com . google . common . collect . Iterables ; 
 import io . netty . buffer . ByteBuf ; 
 import io . netty . buffer . ByteBufInputStream ; 
 import io . netty . buffer . Unpooled ; 
 @ @ - 29 , 8 + 28 , 6 @ @ import java . util . List ; 
 import java . util . Map ; 
 
 import static com . github . dreamhead . moco . model . MessageContent . content ; 
 - import static com . github . dreamhead . moco . util . Maps . listValueToArray ; 
 - import static com . github . dreamhead . moco . util . Maps . simpleValueToArray ; 
 import static com . google . common . collect . ImmutableMap . copyOf ; 
 
 @ JsonDeserialize ( builder = DefaultHttpRequest . Builder . class ) 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpResponse . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpResponse . java 
 index 1e4a165 . . c9a2fd9 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpResponse . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpResponse . java 
 @ @ - 28 , 7 + 28 , 7 @ @ public class DefaultHttpResponse extends DefaultHttpMessage implements HttpRespo 
 return status ; 
 } 
 
 - public static DefaultHttpResponse newResponse ( final FullHttpResponse response ) { 
 + public static HttpResponse newResponse ( final FullHttpResponse response ) { 
 ImmutableMap . Builder < String , String > headerBuilder = ImmutableMap . builder ( ) ; 
 for ( Map . Entry < String , String > entry : response . headers ( ) ) { 
 headerBuilder . put ( entry ) ; 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / util / Maps . java b / moco - core / src / main / java / com / github / dreamhead / moco / util / Maps . java 
 index a35bec0 . . 24ad670 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / util / Maps . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / util / Maps . java 
 @ @ - 1 , 8 + 1 , 8 @ @ 
 package com . github . dreamhead . moco . util ; 
 
 import com . google . common . collect . ImmutableMap ; 
 + import com . google . common . collect . Iterables ; 
 
 - import java . util . List ; 
 import java . util . Map ; 
 
 public class Maps { 
 @ @ - 24 , 11 + 24 , 11 @ @ public class Maps { 
 return builder . build ( ) ; 
 } 
 
 - public static ImmutableMap < String , String [ ] > listValueToArray ( final Map < String , List < String > > map ) { 
 + public static ImmutableMap < String , String [ ] > iterableValueToArray ( final Map < String , Iterable < String > > map ) { 
 ImmutableMap . Builder < String , String [ ] > builder = ImmutableMap . builder ( ) ; 
 - for ( Map . Entry < String , List < String > > entry : map . entrySet ( ) ) { 
 - List < String > value = entry . getValue ( ) ; 
 - builder . put ( entry . getKey ( ) , value . toArray ( new String [ value . size ( ) ] ) ) ; 
 + for ( Map . Entry < String , Iterable < String > > entry : map . entrySet ( ) ) { 
 + Iterable < String > value = entry . getValue ( ) ; 
 + builder . put ( entry . getKey ( ) , Iterables . toArray ( value , String . class ) ) ; 
 } 
 
 return builder . build ( ) ; 
 diff - - git a / moco - core / src / test / java / com / github / dreamhead / moco / MocoProxyTest . java b / moco - core / src / test / java / com / github / dreamhead / moco / MocoProxyTest . java 
 index 0c8bbcc . . 3c5be08 100644 
 - - - a / moco - core / src / test / java / com / github / dreamhead / moco / MocoProxyTest . java 
 + + + b / moco - core / src / test / java / com / github / dreamhead / moco / MocoProxyTest . java 
 @ @ - 233 , 7 + 233 , 7 @ @ public class MocoProxyTest extends AbstractMocoHttpTest { 
 
 @ Test 
 public void should _ failover _ with _ same _ response _ once ( ) throws Exception { 
 - server = httpServer ( port ( ) , log ( ) ) ; 
 + server = httpServer ( port ( ) ) ; 
 server . post ( and ( by ( uri ( " / target " ) ) , by ( " proxy " ) ) ) . response ( " 0XCAFEBABE " ) ; 
 final File tempFile = tempFolder . newFile ( ) ; 
 server . request ( by ( uri ( " / proxy " ) ) ) . response ( proxy ( remoteUrl ( " / target " ) , failover ( tempFile . getAbsolutePath ( ) ) ) ) ; 
 diff - - git a / moco - core / src / test / java / com / github / dreamhead / moco / dumper / HttpDumpersTest . java b / moco - core / src / test / java / com / github / dreamhead / moco / dumper / HttpDumpersTest . java 
 index 2b9bf89 . . 2d5e30c 100644 
 - - - a / moco - core / src / test / java / com / github / dreamhead / moco / dumper / HttpDumpersTest . java 
 + + + b / moco - core / src / test / java / com / github / dreamhead / moco / dumper / HttpDumpersTest . java 
 @ @ - 68 , 13 + 68 , 13 @ @ public class HttpDumpersTest { 
 } 
 
 @ Test 
 - public void should _ parse _ complete _ form _ urlencoded _ media _ type ( ) throws Exception { 
 + public void should _ parse _ complete _ form _ urlencoded _ media _ type ( ) { 
 assertMessageContent ( " application / x - www - form - urlencoded ; charset = UTF - 8 " , EXPECTED _ MESSAGE _ BODY ) ; 
 } 
 
 @ Test 
 @ SuppressWarnings ( " unchecked " ) 
 - public void should _ not _ parse _ content _ when _ content _ length _ not _ set ( ) throws Exception { 
 + public void should _ not _ parse _ content _ when _ content _ length _ not _ set ( ) { 
 assertThat ( asContent ( messageWithHeaders ( EMPTY _ MAP ) ) , isEmptyString ( ) ) ; 
 } 
 
 @ @ - 85 , 7 + 85 , 7 @ @ public class HttpDumpersTest { 
 private HttpMessage messageWithHeaders ( final Map < String , String > headers ) { 
 return DefaultHttpResponse . builder ( ) 
 . forHeaders ( headers ) 
 - . withContent ( MessageContent . content ( MESSAGE _ BODY ) ) 
 + . withTextContent ( MESSAGE _ BODY ) 
 . build ( ) ; 
 } 
 
 diff - - git a / moco - core / src / test / java / com / github / dreamhead / moco / extractor / JsonPathRequestExtractorTest . java b / moco - core / src / test / java / com / github / dreamhead / moco / extractor / JsonPathRequestExtractorTest . java 
 index a7b3bbb . . 80be424 100644 
 - - - a / moco - core / src / test / java / com / github / dreamhead / moco / extractor / JsonPathRequestExtractorTest . java 
 + + + b / moco - core / src / test / java / com / github / dreamhead / moco / extractor / JsonPathRequestExtractorTest . java 
 @ @ - 15 , 7 + 15 , 8 @ @ public class JsonPathRequestExtractorTest { 
 public void should _ extract _ empty _ content _ as _ absent ( ) { 
 JsonPathRequestExtractor unitUnderTest = new JsonPathRequestExtractor ( " $ . . account " ) ; 
 HttpRequest request = DefaultHttpRequest . builder ( ) 
 - . withContent ( MessageContent . content ( " " ) ) . build ( ) ; 
 + . withTextContent ( " " ) 
 + . build ( ) ; 
 Optional < Object > result = unitUnderTest . extract ( request ) ; 
 assertThat ( result . isPresent ( ) , is ( false ) ) ; 
 } 
 diff - - git a / moco - core / src / test / java / com / github / dreamhead / moco / extractor / XPathRequestExtractorTest . java b / moco - core / src / test / java / com / github / dreamhead / moco / extractor / XPathRequestExtractorTest . java 
 index 13dd597 . . 67a52ae 100644 
 - - - a / moco - core / src / test / java / com / github / dreamhead / moco / extractor / XPathRequestExtractorTest . java 
 + + + b / moco - core / src / test / java / com / github / dreamhead / moco / extractor / XPathRequestExtractorTest . java 
 @ @ - 13 , 7 + 13 , 7 @ @ public class XPathRequestExtractorTest { 
 @ Test 
 public void should _ extract _ empty _ content _ as _ absent ( ) { 
 XPathRequestExtractor unitUnderTest = new XPathRequestExtractor ( " / request / parameters / id / text ( ) " ) ; 
 - HttpRequest request = DefaultHttpRequest . builder ( ) . withContent ( MessageContent . content ( " " ) ) . build ( ) ; 
 + HttpRequest request = DefaultHttpRequest . builder ( ) . withTextContent ( " " ) . build ( ) ; 
 Optional < String [ ] > result = unitUnderTest . extract ( request ) ; 
 assertThat ( result . isPresent ( ) , is ( false ) ) ; 
 } 
 diff - - git a / moco - core / src / test / java / com / github / dreamhead / moco / matcher / XmlRequestMatcherTest . java b / moco - core / src / test / java / com / github / dreamhead / moco / matcher / XmlRequestMatcherTest . java 
 index 664d517 . . 1fe66e2 100644 
 - - - a / moco - core / src / test / java / com / github / dreamhead / moco / matcher / XmlRequestMatcherTest . java 
 + + + b / moco - core / src / test / java / com / github / dreamhead / moco / matcher / XmlRequestMatcherTest . java 
 @ @ - 13 , 7 + 13 , 7 @ @ public class XmlRequestMatcherTest { 
 @ Test 
 public void should _ return _ false _ for _ empty _ content ( ) { 
 XmlRequestMatcher unitUnderTest = new XmlRequestMatcher ( text ( " < request > < parameters > < id > 1 < / id > < / parameters > < / request > " ) ) ; 
 - HttpRequest request = DefaultHttpRequest . builder ( ) . withContent ( MessageContent . content ( " " ) ) . build ( ) ; 
 + HttpRequest request = DefaultHttpRequest . builder ( ) . withTextContent ( " " ) . build ( ) ; 
 assertThat ( unitUnderTest . match ( request ) , is ( false ) ) ; 
 } 
 }

NEAREST DIFF:
diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / HttpMessage . java b / moco - core / src / main / java / com / github / dreamhead / moco / HttpMessage . java 
 index 9deacc4 . . c68f37d 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / HttpMessage . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / HttpMessage . java 
 @ @ - 5 , 7 + 5 , 7 @ @ import com . google . common . collect . ImmutableMap ; 
 public interface HttpMessage extends Message { 
 HttpProtocolVersion getVersion ( ) ; 
 
 - ImmutableMap < String , String > getHeaders ( ) ; 
 + ImmutableMap < String , String [ ] > getHeaders ( ) ; 
 
 String getHeader ( String name ) ; 
 } 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpRequestDumper . java b / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpRequestDumper . java 
 index c268a16 . . e4d125d 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpRequestDumper . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpRequestDumper . java 
 @ @ - 6 , 6 + 6 , 7 @ @ import com . google . common . base . Joiner ; 
 import io . netty . util . internal . StringUtil ; 
 
 import static com . github . dreamhead . moco . dumper . HttpDumpers . asContent ; 
 + import static com . github . dreamhead . moco . util . Maps . asSimple ; 
 
 public final class HttpRequestDumper implements Dumper < Request > { 
 private final Joiner . MapJoiner headerJoiner = Joiner . on ( StringUtil . NEWLINE ) . withKeyValueSeparator ( " : " ) ; 
 @ @ - 16 , 7 + 17 , 7 @ @ public final class HttpRequestDumper implements Dumper < Request > { 
 StringBuilder buf = new StringBuilder ( ) ; 
 buf . append ( requestProtocolLine ( httpRequest ) ) 
 . append ( StringUtil . NEWLINE ) 
 - . append ( headerJoiner . join ( httpRequest . getHeaders ( ) ) ) 
 + . append ( headerJoiner . join ( asSimple ( httpRequest . getHeaders ( ) ) ) ) 
 . append ( asContent ( httpRequest ) ) ; 
 return buf . toString ( ) ; 
 } 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpResponseDumper . java b / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpResponseDumper . java 
 index 34fa0df . . e64c5c8 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpResponseDumper . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpResponseDumper . java 
 @ @ - 6 , 6 + 6 , 7 @ @ import com . google . common . base . Joiner ; 
 import io . netty . util . internal . StringUtil ; 
 
 import static com . github . dreamhead . moco . dumper . HttpDumpers . asContent ; 
 + import static com . github . dreamhead . moco . util . Maps . asSimple ; 
 
 public class HttpResponseDumper implements Dumper < Response > { 
 private final Joiner . MapJoiner headerJoiner = Joiner . on ( StringUtil . NEWLINE ) . withKeyValueSeparator ( " : " ) ; 
 @ @ - 16 , 7 + 17 , 7 @ @ public class HttpResponseDumper implements Dumper < Response > { 
 return new StringBuilder ( ) 
 . append ( responseProtocolLine ( httpResponse ) ) 
 . append ( StringUtil . NEWLINE ) 
 - . append ( headerJoiner . join ( httpResponse . getHeaders ( ) ) ) 
 + . append ( headerJoiner . join ( asSimple ( httpResponse . getHeaders ( ) ) ) ) 
 . append ( asContent ( httpResponse ) ) 
 . toString ( ) ; 
 } 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / extractor / HeaderRequestExtractor . java b / moco - core / src / main / java / com / github / dreamhead / moco / extractor / HeaderRequestExtractor . java 
 index 2af3908 . . 62ecb09 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / extractor / HeaderRequestExtractor . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / extractor / HeaderRequestExtractor . java 
 @ @ - 4 , 7 + 4 , 6 @ @ import com . github . dreamhead . moco . HttpRequest ; 
 import com . github . dreamhead . moco . HttpRequestExtractor ; 
 import com . google . common . base . Function ; 
 import com . google . common . base . Optional ; 
 - import com . google . common . collect . ImmutableMap ; 
 
 import java . util . Map ; 
 
 @ @ - 22 , 8 + 21 , 7 @ @ public class HeaderRequestExtractor extends HttpRequestExtractor < String [ ] > { 
 
 @ Override 
 protected Optional < String [ ] > doExtract ( final HttpRequest request ) { 
 - final ImmutableMap < String , String > headers = request . getHeaders ( ) ; 
 - String [ ] extractedValues = from ( headers . entrySet ( ) ) 
 + String [ ] extractedValues = from ( request . getHeaders ( ) . entrySet ( ) ) 
 . filter ( isForHeaderName ( name ) ) 
 . transform ( toValue ( ) ) 
 . toArray ( String . class ) ; 
 @ @ - 35 , 11 + 33 , 12 @ @ public class HeaderRequestExtractor extends HttpRequestExtractor < String [ ] > { 
 return absent ( ) ; 
 } 
 
 - private Function < Map . Entry < String , String > , String > toValue ( ) { 
 - return new Function < Map . Entry < String , String > , String > ( ) { 
 + / / TO FLAT 
 + private Function < Map . Entry < String , String [ ] > , String > toValue ( ) { 
 + return new Function < Map . Entry < String , String [ ] > , String > ( ) { 
 @ Override 
 - public String apply ( final Map . Entry < String , String > input ) { 
 - return input . getValue ( ) ; 
 + public String apply ( final Map . Entry < String , String [ ] > input ) { 
 + return input . getValue ( ) [ 0 ] ; 
 } 
 } ; 
 } 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / handler / AbstractProxyResponseHandler . java b / moco - core / src / main / java / com / github / dreamhead / moco / handler / AbstractProxyResponseHandler . java 
 index ea80fac . . 12a3f1e 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / handler / AbstractProxyResponseHandler . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / handler / AbstractProxyResponseHandler . java 
 @ @ - 236 , 9 + 236 , 13 @ @ public abstract class AbstractProxyResponseHandler extends AbstractHttpResponseH 
 private void doWritHttpResponse ( final HttpResponse response , final MutableHttpResponse httpResponse ) { 
 httpResponse . setVersion ( response . getVersion ( ) ) ; 
 httpResponse . setStatus ( response . getStatus ( ) ) ; 
 - for ( Map . Entry < String , String > entry : response . getHeaders ( ) . entrySet ( ) ) { 
 - httpResponse . addHeader ( entry . getKey ( ) , entry . getValue ( ) ) ; 
 + for ( Map . Entry < String , String [ ] > entry : response . getHeaders ( ) . entrySet ( ) ) { 
 + String key = entry . getKey ( ) ; 
 + for ( String value : entry . getValue ( ) ) { 
 + httpResponse . addHeader ( key , value ) ; 
 + } 
 } 
 + 
 httpResponse . setContent ( response . getContent ( ) ) ; 
 } 
 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java 
 index 46fb0f2 . . 7233273 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java 
 @ @ - 4 , 8 + 4 , 6 @ @ import com . github . dreamhead . moco . HttpMessage ; 
 import com . github . dreamhead . moco . HttpProtocolVersion ; 
 import com . google . common . collect . ImmutableMap ; 
 
 - import static com . github . dreamhead . moco . util . Maps . asSimple ; 
 - 
 public abstract class DefaultHttpMessage implements HttpMessage { 
 private final HttpProtocolVersion version ; 
 private final MessageContent content ; 
 @ @ - 25 , 8 + 23 , 8 @ @ public abstract class DefaultHttpMessage implements HttpMessage { 
 } 
 
 @ Override 
 - public ImmutableMap < String , String > getHeaders ( ) { 
 - return asSimple ( this . headers ) ; 
 + public ImmutableMap < String , String [ ] > getHeaders ( ) { 
 + return this . headers ; 
 } 
 
 @ Override 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java 
 index f67feb0 . . afbcd07 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java 
 @ @ - 177 , 8 + 177 , 12 @ @ public final class DefaultHttpRequest extends DefaultHttpMessage implements Http 
 
 FullHttpRequest request = new DefaultFullHttpRequest ( HttpVersion . valueOf ( getVersion ( ) . text ( ) ) , 
 io . netty . handler . codec . http . HttpMethod . valueOf ( method . name ( ) ) , encoder . toString ( ) , buffer ) ; 
 - for ( Map . Entry < String , String > entry : getHeaders ( ) . entrySet ( ) ) { 
 - request . headers ( ) . add ( entry . getKey ( ) , entry . getValue ( ) ) ; 
 + 
 + for ( Map . Entry < String , String [ ] > entry : getHeaders ( ) . entrySet ( ) ) { 
 + String key = entry . getKey ( ) ; 
 + for ( String value : entry . getValue ( ) ) { 
 + request . headers ( ) . add ( key , value ) ; 
 + } 
 } 
 
 return request ; 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultMutableHttpResponse . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultMutableHttpResponse . java 
 index cc1c3ac . . ba562e3 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultMutableHttpResponse . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultMutableHttpResponse . java 
 @ @ - 12 , 8 + 12 , 6 @ @ import io . netty . handler . codec . http . HttpVersion ; 
 
 import java . util . Map ; 
 
 - import static com . github . dreamhead . moco . util . Maps . asSimple ; 
 - 
 public final class DefaultMutableHttpResponse implements MutableHttpResponse { 
 private HttpProtocolVersion version ; 
 private Map < String , String [ ] > headers = Maps . newHashMap ( ) ; 
 @ @ - 80 , 8 + 78 , 8 @ @ public final class DefaultMutableHttpResponse implements MutableHttpResponse { 
 } 
 
 @ Override 
 - public ImmutableMap < String , String > getHeaders ( ) { 
 - return asSimple ( ImmutableMap . copyOf ( this . headers ) ) ; 
 + public ImmutableMap < String , String [ ] > getHeaders ( ) { 
 + return ImmutableMap . copyOf ( this . headers ) ; 
 } 
 
 @ Override 
 @ @ - 104 , 8 + 102 , 12 @ @ public final class DefaultMutableHttpResponse implements MutableHttpResponse { 
 public FullHttpResponse toFullResponse ( ) { 
 FullHttpResponse response = new DefaultFullHttpResponse ( HttpVersion . valueOf ( this . version . text ( ) ) , 
 HttpResponseStatus . valueOf ( this . status ) ) ; 
 - for ( Map . Entry < String , String > entry : getHeaders ( ) . entrySet ( ) ) { 
 - response . headers ( ) . add ( entry . getKey ( ) , entry . getValue ( ) ) ; 
 + 
 + for ( Map . Entry < String , String [ ] > entry : getHeaders ( ) . entrySet ( ) ) { 
 + String key = entry . getKey ( ) ; 
 + for ( String value : entry . getValue ( ) ) { 
 + response . headers ( ) . add ( key , value ) ; 
 + } 
 } 
 
 if ( this . content ! = null ) { 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java b / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java 
 index 11964e1 . . 70d8de4 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java 
 @ @ - 7 , 6 + 7 , 8 @ @ import com . github . dreamhead . moco . model . DefaultHttpRequest ; 
 import com . github . dreamhead . moco . model . MessageContent ; 
 import com . google . common . collect . ImmutableMap ; 
 
 + import static com . github . dreamhead . moco . util . Maps . asSimple ; 
 + 
 public class TemplateRequest { 
 private Request request ; 
 
 @ @ - 28 , 7 + 30 , 7 @ @ public class TemplateRequest { 
 
 public ImmutableMap < String , String > getHeaders ( ) { 
 if ( this . request instanceof HttpRequest ) { 
 - return ( ( HttpRequest ) this . request ) . getHeaders ( ) ; 
 + return asSimple ( ( ( HttpRequest ) this . request ) . getHeaders ( ) ) ; 
 } 
 
 throw new IllegalArgumentException ( " Request is not HTTP request " ) ; 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / util / HttpHeaders . java b / moco - core / src / main / java / com / github / dreamhead / moco / util / HttpHeaders . java 
 index dbf905e . . fa5d6a2 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / util / HttpHeaders . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / util / HttpHeaders . java 
 @ @ - 9 , 10 + 9 , 10 @ @ public final class HttpHeaders { 
 return key . equalsIgnoreCase ( name ) ; 
 } 
 
 - public static Predicate < Map . Entry < String , String > > isForHeaderName ( final String key ) { 
 - return new Predicate < Map . Entry < String , String > > ( ) { 
 + public static Predicate < Map . Entry < String , String [ ] > > isForHeaderName ( final String key ) { 
 + return new Predicate < Map . Entry < String , String [ ] > > ( ) { 
 @ Override 
 - public boolean apply ( final Map . Entry < String , String > input ) { 
 + public boolean apply ( final Map . Entry < String , String [ ] > input ) { 
 return isSameHeaderName ( input . getKey ( ) , key ) ; 
 } 
 } ;
