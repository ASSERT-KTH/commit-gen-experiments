BLEU SCORE: 0.2891784933232571

TEST MSG: fixed request and response for multiple headers with same name in proxy failover
GENERATED MSG: enabled multiple headers with same name

TEST DIFF (one line): diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java <nl> index 85759f3 . . 7579deb 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java <nl> @ @ - 12 , 6 + 12 , 7 @ @ import com . google . common . base . Optional ; <nl> import com . google . common . base . Supplier ; <nl> import com . google . common . base . Suppliers ; <nl> import com . google . common . collect . ImmutableMap ; <nl> + import com . google . common . collect . Iterables ; <nl> import io . netty . buffer . ByteBuf ; <nl> import io . netty . buffer . ByteBufInputStream ; <nl> import io . netty . buffer . Unpooled ; <nl> @ @ - 28 , 6 + 29 , 8 @ @ import java . util . List ; <nl> import java . util . Map ; <nl> <nl> import static com . github . dreamhead . moco . model . MessageContent . content ; <nl> + import static com . github . dreamhead . moco . util . Maps . listValueToArray ; <nl> + import static com . github . dreamhead . moco . util . Maps . simpleValueToArray ; <nl> import static com . google . common . collect . ImmutableMap . copyOf ; <nl> <nl> @ JsonDeserialize ( builder = DefaultHttpRequest . Builder . class ) <nl> @ @ - 258 , 14 + 261 , 32 @ @ public final class DefaultHttpRequest extends DefaultHttpMessage implements Http <nl> return this ; <nl> } <nl> <nl> - public Builder withHeaders ( final Map < String , String [ ] > headers ) { <nl> - if ( headers ! = null ) { <nl> - this . headers = copyOf ( headers ) ; <nl> + public Builder withHeaders ( final Map < String , ? > headers ) { <nl> + if ( headers ! = null & & ! headers . isEmpty ( ) ) { <nl> + this . headers = asHeaders ( headers ) ; <nl> } <nl> <nl> return this ; <nl> } <nl> <nl> + private ImmutableMap < String , String [ ] > asHeaders ( final Map < String , ? > headers ) { <nl> + Object value = Iterables . getFirst ( headers . entrySet ( ) , null ) . getValue ( ) ; <nl> + if ( value instanceof String ) { <nl> + return simpleValueToArray ( ( Map < String , String > ) headers ) ; <nl> + } <nl> + <nl> + if ( value instanceof String [ ] ) { <nl> + return copyOf ( ( Map < String , String [ ] > ) headers ) ; <nl> + } <nl> + <nl> + if ( value instanceof List ) { <nl> + return listValueToArray ( ( Map < String , List < String > > ) headers ) ; <nl> + } <nl> + <nl> + throw new IllegalArgumentException ( " Unknown header value type [ " + value . getClass ( ) + " ] " ) ; <nl> + <nl> + } <nl> + <nl> public Builder withMethod ( final HttpMethod method ) { <nl> this . method = method ; <nl> return this ; <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpResponse . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpResponse . java <nl> index f0ef734 . . 5d927b2 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpResponse . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpResponse . java <nl> @ @ - 4 , 14 + 4 , 17 @ @ import com . fasterxml . jackson . databind . annotation . JsonDeserialize ; <nl> import com . github . dreamhead . moco . HttpProtocolVersion ; <nl> import com . github . dreamhead . moco . HttpResponse ; <nl> import com . google . common . collect . ImmutableMap ; <nl> + import com . google . common . collect . Iterables ; <nl> import io . netty . buffer . ByteBufInputStream ; <nl> import io . netty . handler . codec . http . FullHttpResponse ; <nl> import io . netty . handler . codec . http . HttpVersion ; <nl> <nl> + import java . util . List ; <nl> import java . util . Map ; <nl> <nl> import static com . github . dreamhead . moco . model . MessageContent . content ; <nl> - import static com . github . dreamhead . moco . util . Maps . asArray ; <nl> + import static com . github . dreamhead . moco . util . Maps . listValueToArray ; <nl> + import static com . github . dreamhead . moco . util . Maps . simpleValueToArray ; <nl> import static com . google . common . collect . ImmutableMap . copyOf ; <nl> <nl> @ JsonDeserialize ( builder = DefaultHttpResponse . Builder . class ) <nl> @ @ - 70 , 17 + 73 , 34 @ @ public class DefaultHttpResponse extends DefaultHttpMessage implements HttpRespo <nl> return this ; <nl> } <nl> <nl> - public Builder withHeaders ( final Map < String , String [ ] > headers ) { <nl> - if ( headers ! = null ) { <nl> - this . headers = copyOf ( headers ) ; <nl> + public Builder withHeaders ( final Map < String , ? > headers ) { <nl> + if ( headers ! = null & & ! headers . isEmpty ( ) ) { <nl> + this . headers = asHeaders ( headers ) ; <nl> } <nl> <nl> return this ; <nl> } <nl> <nl> + private ImmutableMap < String , String [ ] > asHeaders ( final Map < String , ? > headers ) { <nl> + Object value = Iterables . getFirst ( headers . entrySet ( ) , null ) . getValue ( ) ; <nl> + if ( value instanceof String ) { <nl> + return simpleValueToArray ( ( Map < String , String > ) headers ) ; <nl> + } <nl> + <nl> + if ( value instanceof String [ ] ) { <nl> + return copyOf ( ( Map < String , String [ ] > ) headers ) ; <nl> + } <nl> + <nl> + if ( value instanceof List ) { <nl> + return listValueToArray ( ( Map < String , List < String > > ) headers ) ; <nl> + } <nl> + <nl> + throw new IllegalArgumentException ( " Unknown header value type [ " + value . getClass ( ) + " ] " ) ; <nl> + } <nl> + <nl> public Builder forHeaders ( final Map < String , String > headers ) { <nl> if ( headers ! = null ) { <nl> - this . headers = asArray ( copyOf ( headers ) ) ; <nl> + this . headers = simpleValueToArray ( copyOf ( headers ) ) ; <nl> } <nl> <nl> return this ; <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java b / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java <nl> index 70d8de4 . . 44e9559 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java <nl> @ @ - 7 , 7 + 7 , 7 @ @ import com . github . dreamhead . moco . model . DefaultHttpRequest ; <nl> import com . github . dreamhead . moco . model . MessageContent ; <nl> import com . google . common . collect . ImmutableMap ; <nl> <nl> - import static com . github . dreamhead . moco . util . Maps . asSimple ; <nl> + import static com . github . dreamhead . moco . util . Maps . arrayValueToSimple ; <nl> <nl> public class TemplateRequest { <nl> private Request request ; <nl> @ @ - 30 , 7 + 30 , 7 @ @ public class TemplateRequest { <nl> <nl> public ImmutableMap < String , String > getHeaders ( ) { <nl> if ( this . request instanceof HttpRequest ) { <nl> - return asSimple ( ( ( HttpRequest ) this . request ) . getHeaders ( ) ) ; <nl> + return arrayValueToSimple ( ( ( HttpRequest ) this . request ) . getHeaders ( ) ) ; <nl> } <nl> <nl> throw new IllegalArgumentException ( " Request is not HTTP request " ) ; <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / util / Jsons . java b / moco - core / src / main / java / com / github / dreamhead / moco / util / Jsons . java <nl> index a04fb80 . . 551bd02 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / util / Jsons . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / util / Jsons . java <nl> @ @ - 10 , 12 + 10 , 15 @ @ import com . github . dreamhead . moco . MocoException ; <nl> import com . google . common . base . Function ; <nl> import com . google . common . collect . FluentIterable ; <nl> import com . google . common . collect . ImmutableList ; <nl> + import com . google . common . io . CharStreams ; <nl> + import com . sun . xml . internal . messaging . saaj . util . CharReader ; <nl> import org . slf4j . Logger ; <nl> import org . slf4j . LoggerFactory ; <nl> <nl> import java . io . ByteArrayInputStream ; <nl> import java . io . IOException ; <nl> import java . io . InputStream ; <nl> + import java . io . InputStreamReader ; <nl> import java . util . List ; <nl> import java . util . Map ; <nl> <nl> @ @ - 70 , 7 + 73 , 8 @ @ public final class Jsons { <nl> @ Override <nl> public Iterable < T > apply ( final InputStream input ) { <nl> try ( InputStream actual = input ) { <nl> - return mapper . readValue ( actual , type ) ; <nl> + String text = CharStreams . toString ( new InputStreamReader ( actual ) ) ; <nl> + return mapper . readValue ( text , type ) ; <nl> } catch ( UnrecognizedPropertyException e ) { <nl> logger . info ( " Unrecognized field : { } " , e . getMessage ( ) ) ; <nl> throw new MocoException ( format ( " Unrecognized field [ % s ] , please check ! " , e . getPropertyName ( ) ) ) ; <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / util / Maps . java b / moco - core / src / main / java / com / github / dreamhead / moco / util / Maps . java <nl> index 5f60c3b . . a35bec0 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / util / Maps . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / util / Maps . java <nl> @ @ - 2 , 10 + 2 , 11 @ @ package com . github . dreamhead . moco . util ; <nl> <nl> import com . google . common . collect . ImmutableMap ; <nl> <nl> + import java . util . List ; <nl> import java . util . Map ; <nl> <nl> public class Maps { <nl> - public static ImmutableMap < String , String > asSimple ( final Map < String , String [ ] > map ) { <nl> + public static ImmutableMap < String , String > arrayValueToSimple ( final Map < String , String [ ] > map ) { <nl> ImmutableMap . Builder < String , String > builder = ImmutableMap . builder ( ) ; <nl> for ( Map . Entry < String , String [ ] > entry : map . entrySet ( ) ) { <nl> builder . put ( entry . getKey ( ) , entry . getValue ( ) [ 0 ] ) ; <nl> @ @ - 14 , 7 + 15 , 7 @ @ public class Maps { <nl> return builder . build ( ) ; <nl> } <nl> <nl> - public static ImmutableMap < String , String [ ] > asArray ( final Map < String , String > map ) { <nl> + public static ImmutableMap < String , String [ ] > simpleValueToArray ( final Map < String , String > map ) { <nl> ImmutableMap . Builder < String , String [ ] > builder = ImmutableMap . builder ( ) ; <nl> for ( Map . Entry < String , String > entry : map . entrySet ( ) ) { <nl> builder . put ( entry . getKey ( ) , new String [ ] { entry . getValue ( ) } ) ; <nl> @ @ - 23 , 6 + 24 , 16 @ @ public class Maps { <nl> return builder . build ( ) ; <nl> } <nl> <nl> + public static ImmutableMap < String , String [ ] > listValueToArray ( final Map < String , List < String > > map ) { <nl> + ImmutableMap . Builder < String , String [ ] > builder = ImmutableMap . builder ( ) ; <nl> + for ( Map . Entry < String , List < String > > entry : map . entrySet ( ) ) { <nl> + List < String > value = entry . getValue ( ) ; <nl> + builder . put ( entry . getKey ( ) , value . toArray ( new String [ value . size ( ) ] ) ) ; <nl> + } <nl> + <nl> + return builder . build ( ) ; <nl> + } <nl> + <nl> private Maps ( ) { <nl> } <nl> }
NEAREST DIFF (one line): diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / HttpMessage . java b / moco - core / src / main / java / com / github / dreamhead / moco / HttpMessage . java <nl> index 9deacc4 . . c68f37d 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / HttpMessage . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / HttpMessage . java <nl> @ @ - 5 , 7 + 5 , 7 @ @ import com . google . common . collect . ImmutableMap ; <nl> public interface HttpMessage extends Message { <nl> HttpProtocolVersion getVersion ( ) ; <nl> <nl> - ImmutableMap < String , String > getHeaders ( ) ; <nl> + ImmutableMap < String , String [ ] > getHeaders ( ) ; <nl> <nl> String getHeader ( String name ) ; <nl> } <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpRequestDumper . java b / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpRequestDumper . java <nl> index c268a16 . . e4d125d 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpRequestDumper . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpRequestDumper . java <nl> @ @ - 6 , 6 + 6 , 7 @ @ import com . google . common . base . Joiner ; <nl> import io . netty . util . internal . StringUtil ; <nl> <nl> import static com . github . dreamhead . moco . dumper . HttpDumpers . asContent ; <nl> + import static com . github . dreamhead . moco . util . Maps . asSimple ; <nl> <nl> public final class HttpRequestDumper implements Dumper < Request > { <nl> private final Joiner . MapJoiner headerJoiner = Joiner . on ( StringUtil . NEWLINE ) . withKeyValueSeparator ( " : " ) ; <nl> @ @ - 16 , 7 + 17 , 7 @ @ public final class HttpRequestDumper implements Dumper < Request > { <nl> StringBuilder buf = new StringBuilder ( ) ; <nl> buf . append ( requestProtocolLine ( httpRequest ) ) <nl> . append ( StringUtil . NEWLINE ) <nl> - . append ( headerJoiner . join ( httpRequest . getHeaders ( ) ) ) <nl> + . append ( headerJoiner . join ( asSimple ( httpRequest . getHeaders ( ) ) ) ) <nl> . append ( asContent ( httpRequest ) ) ; <nl> return buf . toString ( ) ; <nl> } <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpResponseDumper . java b / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpResponseDumper . java <nl> index 34fa0df . . e64c5c8 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpResponseDumper . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpResponseDumper . java <nl> @ @ - 6 , 6 + 6 , 7 @ @ import com . google . common . base . Joiner ; <nl> import io . netty . util . internal . StringUtil ; <nl> <nl> import static com . github . dreamhead . moco . dumper . HttpDumpers . asContent ; <nl> + import static com . github . dreamhead . moco . util . Maps . asSimple ; <nl> <nl> public class HttpResponseDumper implements Dumper < Response > { <nl> private final Joiner . MapJoiner headerJoiner = Joiner . on ( StringUtil . NEWLINE ) . withKeyValueSeparator ( " : " ) ; <nl> @ @ - 16 , 7 + 17 , 7 @ @ public class HttpResponseDumper implements Dumper < Response > { <nl> return new StringBuilder ( ) <nl> . append ( responseProtocolLine ( httpResponse ) ) <nl> . append ( StringUtil . NEWLINE ) <nl> - . append ( headerJoiner . join ( httpResponse . getHeaders ( ) ) ) <nl> + . append ( headerJoiner . join ( asSimple ( httpResponse . getHeaders ( ) ) ) ) <nl> . append ( asContent ( httpResponse ) ) <nl> . toString ( ) ; <nl> } <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / extractor / HeaderRequestExtractor . java b / moco - core / src / main / java / com / github / dreamhead / moco / extractor / HeaderRequestExtractor . java <nl> index 2af3908 . . 62ecb09 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / extractor / HeaderRequestExtractor . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / extractor / HeaderRequestExtractor . java <nl> @ @ - 4 , 7 + 4 , 6 @ @ import com . github . dreamhead . moco . HttpRequest ; <nl> import com . github . dreamhead . moco . HttpRequestExtractor ; <nl> import com . google . common . base . Function ; <nl> import com . google . common . base . Optional ; <nl> - import com . google . common . collect . ImmutableMap ; <nl> <nl> import java . util . Map ; <nl> <nl> @ @ - 22 , 8 + 21 , 7 @ @ public class HeaderRequestExtractor extends HttpRequestExtractor < String [ ] > { <nl> <nl> @ Override <nl> protected Optional < String [ ] > doExtract ( final HttpRequest request ) { <nl> - final ImmutableMap < String , String > headers = request . getHeaders ( ) ; <nl> - String [ ] extractedValues = from ( headers . entrySet ( ) ) <nl> + String [ ] extractedValues = from ( request . getHeaders ( ) . entrySet ( ) ) <nl> . filter ( isForHeaderName ( name ) ) <nl> . transform ( toValue ( ) ) <nl> . toArray ( String . class ) ; <nl> @ @ - 35 , 11 + 33 , 12 @ @ public class HeaderRequestExtractor extends HttpRequestExtractor < String [ ] > { <nl> return absent ( ) ; <nl> } <nl> <nl> - private Function < Map . Entry < String , String > , String > toValue ( ) { <nl> - return new Function < Map . Entry < String , String > , String > ( ) { <nl> + / / TO FLAT <nl> + private Function < Map . Entry < String , String [ ] > , String > toValue ( ) { <nl> + return new Function < Map . Entry < String , String [ ] > , String > ( ) { <nl> @ Override <nl> - public String apply ( final Map . Entry < String , String > input ) { <nl> - return input . getValue ( ) ; <nl> + public String apply ( final Map . Entry < String , String [ ] > input ) { <nl> + return input . getValue ( ) [ 0 ] ; <nl> } <nl> } ; <nl> } <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / handler / AbstractProxyResponseHandler . java b / moco - core / src / main / java / com / github / dreamhead / moco / handler / AbstractProxyResponseHandler . java <nl> index ea80fac . . 12a3f1e 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / handler / AbstractProxyResponseHandler . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / handler / AbstractProxyResponseHandler . java <nl> @ @ - 236 , 9 + 236 , 13 @ @ public abstract class AbstractProxyResponseHandler extends AbstractHttpResponseH <nl> private void doWritHttpResponse ( final HttpResponse response , final MutableHttpResponse httpResponse ) { <nl> httpResponse . setVersion ( response . getVersion ( ) ) ; <nl> httpResponse . setStatus ( response . getStatus ( ) ) ; <nl> - for ( Map . Entry < String , String > entry : response . getHeaders ( ) . entrySet ( ) ) { <nl> - httpResponse . addHeader ( entry . getKey ( ) , entry . getValue ( ) ) ; <nl> + for ( Map . Entry < String , String [ ] > entry : response . getHeaders ( ) . entrySet ( ) ) { <nl> + String key = entry . getKey ( ) ; <nl> + for ( String value : entry . getValue ( ) ) { <nl> + httpResponse . addHeader ( key , value ) ; <nl> + } <nl> } <nl> + <nl> httpResponse . setContent ( response . getContent ( ) ) ; <nl> } <nl> <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java <nl> index 46fb0f2 . . 7233273 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java <nl> @ @ - 4 , 8 + 4 , 6 @ @ import com . github . dreamhead . moco . HttpMessage ; <nl> import com . github . dreamhead . moco . HttpProtocolVersion ; <nl> import com . google . common . collect . ImmutableMap ; <nl> <nl> - import static com . github . dreamhead . moco . util . Maps . asSimple ; <nl> - <nl> public abstract class DefaultHttpMessage implements HttpMessage { <nl> private final HttpProtocolVersion version ; <nl> private final MessageContent content ; <nl> @ @ - 25 , 8 + 23 , 8 @ @ public abstract class DefaultHttpMessage implements HttpMessage { <nl> } <nl> <nl> @ Override <nl> - public ImmutableMap < String , String > getHeaders ( ) { <nl> - return asSimple ( this . headers ) ; <nl> + public ImmutableMap < String , String [ ] > getHeaders ( ) { <nl> + return this . headers ; <nl> } <nl> <nl> @ Override <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java <nl> index f67feb0 . . afbcd07 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java <nl> @ @ - 177 , 8 + 177 , 12 @ @ public final class DefaultHttpRequest extends DefaultHttpMessage implements Http <nl> <nl> FullHttpRequest request = new DefaultFullHttpRequest ( HttpVersion . valueOf ( getVersion ( ) . text ( ) ) , <nl> io . netty . handler . codec . http . HttpMethod . valueOf ( method . name ( ) ) , encoder . toString ( ) , buffer ) ; <nl> - for ( Map . Entry < String , String > entry : getHeaders ( ) . entrySet ( ) ) { <nl> - request . headers ( ) . add ( entry . getKey ( ) , entry . getValue ( ) ) ; <nl> + <nl> + for ( Map . Entry < String , String [ ] > entry : getHeaders ( ) . entrySet ( ) ) { <nl> + String key = entry . getKey ( ) ; <nl> + for ( String value : entry . getValue ( ) ) { <nl> + request . headers ( ) . add ( key , value ) ; <nl> + } <nl> } <nl> <nl> return request ; <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultMutableHttpResponse . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultMutableHttpResponse . java <nl> index cc1c3ac . . ba562e3 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultMutableHttpResponse . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultMutableHttpResponse . java <nl> @ @ - 12 , 8 + 12 , 6 @ @ import io . netty . handler . codec . http . HttpVersion ; <nl> <nl> import java . util . Map ; <nl> <nl> - import static com . github . dreamhead . moco . util . Maps . asSimple ; <nl> - <nl> public final class DefaultMutableHttpResponse implements MutableHttpResponse { <nl> private HttpProtocolVersion version ; <nl> private Map < String , String [ ] > headers = Maps . newHashMap ( ) ; <nl> @ @ - 80 , 8 + 78 , 8 @ @ public final class DefaultMutableHttpResponse implements MutableHttpResponse { <nl> } <nl> <nl> @ Override <nl> - public ImmutableMap < String , String > getHeaders ( ) { <nl> - return asSimple ( ImmutableMap . copyOf ( this . headers ) ) ; <nl> + public ImmutableMap < String , String [ ] > getHeaders ( ) { <nl> + return ImmutableMap . copyOf ( this . headers ) ; <nl> } <nl> <nl> @ Override <nl> @ @ - 104 , 8 + 102 , 12 @ @ public final class DefaultMutableHttpResponse implements MutableHttpResponse { <nl> public FullHttpResponse toFullResponse ( ) { <nl> FullHttpResponse response = new DefaultFullHttpResponse ( HttpVersion . valueOf ( this . version . text ( ) ) , <nl> HttpResponseStatus . valueOf ( this . status ) ) ; <nl> - for ( Map . Entry < String , String > entry : getHeaders ( ) . entrySet ( ) ) { <nl> - response . headers ( ) . add ( entry . getKey ( ) , entry . getValue ( ) ) ; <nl> + <nl> + for ( Map . Entry < String , String [ ] > entry : getHeaders ( ) . entrySet ( ) ) { <nl> + String key = entry . getKey ( ) ; <nl> + for ( String value : entry . getValue ( ) ) { <nl> + response . headers ( ) . add ( key , value ) ; <nl> + } <nl> } <nl> <nl> if ( this . content ! = null ) { <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java b / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java <nl> index 11964e1 . . 70d8de4 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java <nl> @ @ - 7 , 6 + 7 , 8 @ @ import com . github . dreamhead . moco . model . DefaultHttpRequest ; <nl> import com . github . dreamhead . moco . model . MessageContent ; <nl> import com . google . common . collect . ImmutableMap ; <nl> <nl> + import static com . github . dreamhead . moco . util . Maps . asSimple ; <nl> + <nl> public class TemplateRequest { <nl> private Request request ; <nl> <nl> @ @ - 28 , 7 + 30 , 7 @ @ public class TemplateRequest { <nl> <nl> public ImmutableMap < String , String > getHeaders ( ) { <nl> if ( this . request instanceof HttpRequest ) { <nl> - return ( ( HttpRequest ) this . request ) . getHeaders ( ) ; <nl> + return asSimple ( ( ( HttpRequest ) this . request ) . getHeaders ( ) ) ; <nl> } <nl> <nl> throw new IllegalArgumentException ( " Request is not HTTP request " ) ; <nl> diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / util / HttpHeaders . java b / moco - core / src / main / java / com / github / dreamhead / moco / util / HttpHeaders . java <nl> index dbf905e . . fa5d6a2 100644 <nl> - - - a / moco - core / src / main / java / com / github / dreamhead / moco / util / HttpHeaders . java <nl> + + + b / moco - core / src / main / java / com / github / dreamhead / moco / util / HttpHeaders . java <nl> @ @ - 9 , 10 + 9 , 10 @ @ public final class HttpHeaders { <nl> return key . equalsIgnoreCase ( name ) ; <nl> } <nl> <nl> - public static Predicate < Map . Entry < String , String > > isForHeaderName ( final String key ) { <nl> - return new Predicate < Map . Entry < String , String > > ( ) { <nl> + public static Predicate < Map . Entry < String , String [ ] > > isForHeaderName ( final String key ) { <nl> + return new Predicate < Map . Entry < String , String [ ] > > ( ) { <nl> @ Override <nl> - public boolean apply ( final Map . Entry < String , String > input ) { <nl> + public boolean apply ( final Map . Entry < String , String [ ] > input ) { <nl> return isSameHeaderName ( input . getKey ( ) , key ) ; <nl> } <nl> } ;

TEST DIFF:
diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java 
 index 85759f3 . . 7579deb 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java 
 @ @ - 12 , 6 + 12 , 7 @ @ import com . google . common . base . Optional ; 
 import com . google . common . base . Supplier ; 
 import com . google . common . base . Suppliers ; 
 import com . google . common . collect . ImmutableMap ; 
 + import com . google . common . collect . Iterables ; 
 import io . netty . buffer . ByteBuf ; 
 import io . netty . buffer . ByteBufInputStream ; 
 import io . netty . buffer . Unpooled ; 
 @ @ - 28 , 6 + 29 , 8 @ @ import java . util . List ; 
 import java . util . Map ; 
 
 import static com . github . dreamhead . moco . model . MessageContent . content ; 
 + import static com . github . dreamhead . moco . util . Maps . listValueToArray ; 
 + import static com . github . dreamhead . moco . util . Maps . simpleValueToArray ; 
 import static com . google . common . collect . ImmutableMap . copyOf ; 
 
 @ JsonDeserialize ( builder = DefaultHttpRequest . Builder . class ) 
 @ @ - 258 , 14 + 261 , 32 @ @ public final class DefaultHttpRequest extends DefaultHttpMessage implements Http 
 return this ; 
 } 
 
 - public Builder withHeaders ( final Map < String , String [ ] > headers ) { 
 - if ( headers ! = null ) { 
 - this . headers = copyOf ( headers ) ; 
 + public Builder withHeaders ( final Map < String , ? > headers ) { 
 + if ( headers ! = null & & ! headers . isEmpty ( ) ) { 
 + this . headers = asHeaders ( headers ) ; 
 } 
 
 return this ; 
 } 
 
 + private ImmutableMap < String , String [ ] > asHeaders ( final Map < String , ? > headers ) { 
 + Object value = Iterables . getFirst ( headers . entrySet ( ) , null ) . getValue ( ) ; 
 + if ( value instanceof String ) { 
 + return simpleValueToArray ( ( Map < String , String > ) headers ) ; 
 + } 
 + 
 + if ( value instanceof String [ ] ) { 
 + return copyOf ( ( Map < String , String [ ] > ) headers ) ; 
 + } 
 + 
 + if ( value instanceof List ) { 
 + return listValueToArray ( ( Map < String , List < String > > ) headers ) ; 
 + } 
 + 
 + throw new IllegalArgumentException ( " Unknown header value type [ " + value . getClass ( ) + " ] " ) ; 
 + 
 + } 
 + 
 public Builder withMethod ( final HttpMethod method ) { 
 this . method = method ; 
 return this ; 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpResponse . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpResponse . java 
 index f0ef734 . . 5d927b2 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpResponse . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpResponse . java 
 @ @ - 4 , 14 + 4 , 17 @ @ import com . fasterxml . jackson . databind . annotation . JsonDeserialize ; 
 import com . github . dreamhead . moco . HttpProtocolVersion ; 
 import com . github . dreamhead . moco . HttpResponse ; 
 import com . google . common . collect . ImmutableMap ; 
 + import com . google . common . collect . Iterables ; 
 import io . netty . buffer . ByteBufInputStream ; 
 import io . netty . handler . codec . http . FullHttpResponse ; 
 import io . netty . handler . codec . http . HttpVersion ; 
 
 + import java . util . List ; 
 import java . util . Map ; 
 
 import static com . github . dreamhead . moco . model . MessageContent . content ; 
 - import static com . github . dreamhead . moco . util . Maps . asArray ; 
 + import static com . github . dreamhead . moco . util . Maps . listValueToArray ; 
 + import static com . github . dreamhead . moco . util . Maps . simpleValueToArray ; 
 import static com . google . common . collect . ImmutableMap . copyOf ; 
 
 @ JsonDeserialize ( builder = DefaultHttpResponse . Builder . class ) 
 @ @ - 70 , 17 + 73 , 34 @ @ public class DefaultHttpResponse extends DefaultHttpMessage implements HttpRespo 
 return this ; 
 } 
 
 - public Builder withHeaders ( final Map < String , String [ ] > headers ) { 
 - if ( headers ! = null ) { 
 - this . headers = copyOf ( headers ) ; 
 + public Builder withHeaders ( final Map < String , ? > headers ) { 
 + if ( headers ! = null & & ! headers . isEmpty ( ) ) { 
 + this . headers = asHeaders ( headers ) ; 
 } 
 
 return this ; 
 } 
 
 + private ImmutableMap < String , String [ ] > asHeaders ( final Map < String , ? > headers ) { 
 + Object value = Iterables . getFirst ( headers . entrySet ( ) , null ) . getValue ( ) ; 
 + if ( value instanceof String ) { 
 + return simpleValueToArray ( ( Map < String , String > ) headers ) ; 
 + } 
 + 
 + if ( value instanceof String [ ] ) { 
 + return copyOf ( ( Map < String , String [ ] > ) headers ) ; 
 + } 
 + 
 + if ( value instanceof List ) { 
 + return listValueToArray ( ( Map < String , List < String > > ) headers ) ; 
 + } 
 + 
 + throw new IllegalArgumentException ( " Unknown header value type [ " + value . getClass ( ) + " ] " ) ; 
 + } 
 + 
 public Builder forHeaders ( final Map < String , String > headers ) { 
 if ( headers ! = null ) { 
 - this . headers = asArray ( copyOf ( headers ) ) ; 
 + this . headers = simpleValueToArray ( copyOf ( headers ) ) ; 
 } 
 
 return this ; 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java b / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java 
 index 70d8de4 . . 44e9559 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java 
 @ @ - 7 , 7 + 7 , 7 @ @ import com . github . dreamhead . moco . model . DefaultHttpRequest ; 
 import com . github . dreamhead . moco . model . MessageContent ; 
 import com . google . common . collect . ImmutableMap ; 
 
 - import static com . github . dreamhead . moco . util . Maps . asSimple ; 
 + import static com . github . dreamhead . moco . util . Maps . arrayValueToSimple ; 
 
 public class TemplateRequest { 
 private Request request ; 
 @ @ - 30 , 7 + 30 , 7 @ @ public class TemplateRequest { 
 
 public ImmutableMap < String , String > getHeaders ( ) { 
 if ( this . request instanceof HttpRequest ) { 
 - return asSimple ( ( ( HttpRequest ) this . request ) . getHeaders ( ) ) ; 
 + return arrayValueToSimple ( ( ( HttpRequest ) this . request ) . getHeaders ( ) ) ; 
 } 
 
 throw new IllegalArgumentException ( " Request is not HTTP request " ) ; 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / util / Jsons . java b / moco - core / src / main / java / com / github / dreamhead / moco / util / Jsons . java 
 index a04fb80 . . 551bd02 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / util / Jsons . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / util / Jsons . java 
 @ @ - 10 , 12 + 10 , 15 @ @ import com . github . dreamhead . moco . MocoException ; 
 import com . google . common . base . Function ; 
 import com . google . common . collect . FluentIterable ; 
 import com . google . common . collect . ImmutableList ; 
 + import com . google . common . io . CharStreams ; 
 + import com . sun . xml . internal . messaging . saaj . util . CharReader ; 
 import org . slf4j . Logger ; 
 import org . slf4j . LoggerFactory ; 
 
 import java . io . ByteArrayInputStream ; 
 import java . io . IOException ; 
 import java . io . InputStream ; 
 + import java . io . InputStreamReader ; 
 import java . util . List ; 
 import java . util . Map ; 
 
 @ @ - 70 , 7 + 73 , 8 @ @ public final class Jsons { 
 @ Override 
 public Iterable < T > apply ( final InputStream input ) { 
 try ( InputStream actual = input ) { 
 - return mapper . readValue ( actual , type ) ; 
 + String text = CharStreams . toString ( new InputStreamReader ( actual ) ) ; 
 + return mapper . readValue ( text , type ) ; 
 } catch ( UnrecognizedPropertyException e ) { 
 logger . info ( " Unrecognized field : { } " , e . getMessage ( ) ) ; 
 throw new MocoException ( format ( " Unrecognized field [ % s ] , please check ! " , e . getPropertyName ( ) ) ) ; 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / util / Maps . java b / moco - core / src / main / java / com / github / dreamhead / moco / util / Maps . java 
 index 5f60c3b . . a35bec0 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / util / Maps . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / util / Maps . java 
 @ @ - 2 , 10 + 2 , 11 @ @ package com . github . dreamhead . moco . util ; 
 
 import com . google . common . collect . ImmutableMap ; 
 
 + import java . util . List ; 
 import java . util . Map ; 
 
 public class Maps { 
 - public static ImmutableMap < String , String > asSimple ( final Map < String , String [ ] > map ) { 
 + public static ImmutableMap < String , String > arrayValueToSimple ( final Map < String , String [ ] > map ) { 
 ImmutableMap . Builder < String , String > builder = ImmutableMap . builder ( ) ; 
 for ( Map . Entry < String , String [ ] > entry : map . entrySet ( ) ) { 
 builder . put ( entry . getKey ( ) , entry . getValue ( ) [ 0 ] ) ; 
 @ @ - 14 , 7 + 15 , 7 @ @ public class Maps { 
 return builder . build ( ) ; 
 } 
 
 - public static ImmutableMap < String , String [ ] > asArray ( final Map < String , String > map ) { 
 + public static ImmutableMap < String , String [ ] > simpleValueToArray ( final Map < String , String > map ) { 
 ImmutableMap . Builder < String , String [ ] > builder = ImmutableMap . builder ( ) ; 
 for ( Map . Entry < String , String > entry : map . entrySet ( ) ) { 
 builder . put ( entry . getKey ( ) , new String [ ] { entry . getValue ( ) } ) ; 
 @ @ - 23 , 6 + 24 , 16 @ @ public class Maps { 
 return builder . build ( ) ; 
 } 
 
 + public static ImmutableMap < String , String [ ] > listValueToArray ( final Map < String , List < String > > map ) { 
 + ImmutableMap . Builder < String , String [ ] > builder = ImmutableMap . builder ( ) ; 
 + for ( Map . Entry < String , List < String > > entry : map . entrySet ( ) ) { 
 + List < String > value = entry . getValue ( ) ; 
 + builder . put ( entry . getKey ( ) , value . toArray ( new String [ value . size ( ) ] ) ) ; 
 + } 
 + 
 + return builder . build ( ) ; 
 + } 
 + 
 private Maps ( ) { 
 } 
 }

NEAREST DIFF:
diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / HttpMessage . java b / moco - core / src / main / java / com / github / dreamhead / moco / HttpMessage . java 
 index 9deacc4 . . c68f37d 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / HttpMessage . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / HttpMessage . java 
 @ @ - 5 , 7 + 5 , 7 @ @ import com . google . common . collect . ImmutableMap ; 
 public interface HttpMessage extends Message { 
 HttpProtocolVersion getVersion ( ) ; 
 
 - ImmutableMap < String , String > getHeaders ( ) ; 
 + ImmutableMap < String , String [ ] > getHeaders ( ) ; 
 
 String getHeader ( String name ) ; 
 } 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpRequestDumper . java b / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpRequestDumper . java 
 index c268a16 . . e4d125d 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpRequestDumper . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpRequestDumper . java 
 @ @ - 6 , 6 + 6 , 7 @ @ import com . google . common . base . Joiner ; 
 import io . netty . util . internal . StringUtil ; 
 
 import static com . github . dreamhead . moco . dumper . HttpDumpers . asContent ; 
 + import static com . github . dreamhead . moco . util . Maps . asSimple ; 
 
 public final class HttpRequestDumper implements Dumper < Request > { 
 private final Joiner . MapJoiner headerJoiner = Joiner . on ( StringUtil . NEWLINE ) . withKeyValueSeparator ( " : " ) ; 
 @ @ - 16 , 7 + 17 , 7 @ @ public final class HttpRequestDumper implements Dumper < Request > { 
 StringBuilder buf = new StringBuilder ( ) ; 
 buf . append ( requestProtocolLine ( httpRequest ) ) 
 . append ( StringUtil . NEWLINE ) 
 - . append ( headerJoiner . join ( httpRequest . getHeaders ( ) ) ) 
 + . append ( headerJoiner . join ( asSimple ( httpRequest . getHeaders ( ) ) ) ) 
 . append ( asContent ( httpRequest ) ) ; 
 return buf . toString ( ) ; 
 } 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpResponseDumper . java b / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpResponseDumper . java 
 index 34fa0df . . e64c5c8 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpResponseDumper . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / dumper / HttpResponseDumper . java 
 @ @ - 6 , 6 + 6 , 7 @ @ import com . google . common . base . Joiner ; 
 import io . netty . util . internal . StringUtil ; 
 
 import static com . github . dreamhead . moco . dumper . HttpDumpers . asContent ; 
 + import static com . github . dreamhead . moco . util . Maps . asSimple ; 
 
 public class HttpResponseDumper implements Dumper < Response > { 
 private final Joiner . MapJoiner headerJoiner = Joiner . on ( StringUtil . NEWLINE ) . withKeyValueSeparator ( " : " ) ; 
 @ @ - 16 , 7 + 17 , 7 @ @ public class HttpResponseDumper implements Dumper < Response > { 
 return new StringBuilder ( ) 
 . append ( responseProtocolLine ( httpResponse ) ) 
 . append ( StringUtil . NEWLINE ) 
 - . append ( headerJoiner . join ( httpResponse . getHeaders ( ) ) ) 
 + . append ( headerJoiner . join ( asSimple ( httpResponse . getHeaders ( ) ) ) ) 
 . append ( asContent ( httpResponse ) ) 
 . toString ( ) ; 
 } 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / extractor / HeaderRequestExtractor . java b / moco - core / src / main / java / com / github / dreamhead / moco / extractor / HeaderRequestExtractor . java 
 index 2af3908 . . 62ecb09 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / extractor / HeaderRequestExtractor . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / extractor / HeaderRequestExtractor . java 
 @ @ - 4 , 7 + 4 , 6 @ @ import com . github . dreamhead . moco . HttpRequest ; 
 import com . github . dreamhead . moco . HttpRequestExtractor ; 
 import com . google . common . base . Function ; 
 import com . google . common . base . Optional ; 
 - import com . google . common . collect . ImmutableMap ; 
 
 import java . util . Map ; 
 
 @ @ - 22 , 8 + 21 , 7 @ @ public class HeaderRequestExtractor extends HttpRequestExtractor < String [ ] > { 
 
 @ Override 
 protected Optional < String [ ] > doExtract ( final HttpRequest request ) { 
 - final ImmutableMap < String , String > headers = request . getHeaders ( ) ; 
 - String [ ] extractedValues = from ( headers . entrySet ( ) ) 
 + String [ ] extractedValues = from ( request . getHeaders ( ) . entrySet ( ) ) 
 . filter ( isForHeaderName ( name ) ) 
 . transform ( toValue ( ) ) 
 . toArray ( String . class ) ; 
 @ @ - 35 , 11 + 33 , 12 @ @ public class HeaderRequestExtractor extends HttpRequestExtractor < String [ ] > { 
 return absent ( ) ; 
 } 
 
 - private Function < Map . Entry < String , String > , String > toValue ( ) { 
 - return new Function < Map . Entry < String , String > , String > ( ) { 
 + / / TO FLAT 
 + private Function < Map . Entry < String , String [ ] > , String > toValue ( ) { 
 + return new Function < Map . Entry < String , String [ ] > , String > ( ) { 
 @ Override 
 - public String apply ( final Map . Entry < String , String > input ) { 
 - return input . getValue ( ) ; 
 + public String apply ( final Map . Entry < String , String [ ] > input ) { 
 + return input . getValue ( ) [ 0 ] ; 
 } 
 } ; 
 } 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / handler / AbstractProxyResponseHandler . java b / moco - core / src / main / java / com / github / dreamhead / moco / handler / AbstractProxyResponseHandler . java 
 index ea80fac . . 12a3f1e 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / handler / AbstractProxyResponseHandler . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / handler / AbstractProxyResponseHandler . java 
 @ @ - 236 , 9 + 236 , 13 @ @ public abstract class AbstractProxyResponseHandler extends AbstractHttpResponseH 
 private void doWritHttpResponse ( final HttpResponse response , final MutableHttpResponse httpResponse ) { 
 httpResponse . setVersion ( response . getVersion ( ) ) ; 
 httpResponse . setStatus ( response . getStatus ( ) ) ; 
 - for ( Map . Entry < String , String > entry : response . getHeaders ( ) . entrySet ( ) ) { 
 - httpResponse . addHeader ( entry . getKey ( ) , entry . getValue ( ) ) ; 
 + for ( Map . Entry < String , String [ ] > entry : response . getHeaders ( ) . entrySet ( ) ) { 
 + String key = entry . getKey ( ) ; 
 + for ( String value : entry . getValue ( ) ) { 
 + httpResponse . addHeader ( key , value ) ; 
 + } 
 } 
 + 
 httpResponse . setContent ( response . getContent ( ) ) ; 
 } 
 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java 
 index 46fb0f2 . . 7233273 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpMessage . java 
 @ @ - 4 , 8 + 4 , 6 @ @ import com . github . dreamhead . moco . HttpMessage ; 
 import com . github . dreamhead . moco . HttpProtocolVersion ; 
 import com . google . common . collect . ImmutableMap ; 
 
 - import static com . github . dreamhead . moco . util . Maps . asSimple ; 
 - 
 public abstract class DefaultHttpMessage implements HttpMessage { 
 private final HttpProtocolVersion version ; 
 private final MessageContent content ; 
 @ @ - 25 , 8 + 23 , 8 @ @ public abstract class DefaultHttpMessage implements HttpMessage { 
 } 
 
 @ Override 
 - public ImmutableMap < String , String > getHeaders ( ) { 
 - return asSimple ( this . headers ) ; 
 + public ImmutableMap < String , String [ ] > getHeaders ( ) { 
 + return this . headers ; 
 } 
 
 @ Override 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java 
 index f67feb0 . . afbcd07 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultHttpRequest . java 
 @ @ - 177 , 8 + 177 , 12 @ @ public final class DefaultHttpRequest extends DefaultHttpMessage implements Http 
 
 FullHttpRequest request = new DefaultFullHttpRequest ( HttpVersion . valueOf ( getVersion ( ) . text ( ) ) , 
 io . netty . handler . codec . http . HttpMethod . valueOf ( method . name ( ) ) , encoder . toString ( ) , buffer ) ; 
 - for ( Map . Entry < String , String > entry : getHeaders ( ) . entrySet ( ) ) { 
 - request . headers ( ) . add ( entry . getKey ( ) , entry . getValue ( ) ) ; 
 + 
 + for ( Map . Entry < String , String [ ] > entry : getHeaders ( ) . entrySet ( ) ) { 
 + String key = entry . getKey ( ) ; 
 + for ( String value : entry . getValue ( ) ) { 
 + request . headers ( ) . add ( key , value ) ; 
 + } 
 } 
 
 return request ; 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultMutableHttpResponse . java b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultMutableHttpResponse . java 
 index cc1c3ac . . ba562e3 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultMutableHttpResponse . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / model / DefaultMutableHttpResponse . java 
 @ @ - 12 , 8 + 12 , 6 @ @ import io . netty . handler . codec . http . HttpVersion ; 
 
 import java . util . Map ; 
 
 - import static com . github . dreamhead . moco . util . Maps . asSimple ; 
 - 
 public final class DefaultMutableHttpResponse implements MutableHttpResponse { 
 private HttpProtocolVersion version ; 
 private Map < String , String [ ] > headers = Maps . newHashMap ( ) ; 
 @ @ - 80 , 8 + 78 , 8 @ @ public final class DefaultMutableHttpResponse implements MutableHttpResponse { 
 } 
 
 @ Override 
 - public ImmutableMap < String , String > getHeaders ( ) { 
 - return asSimple ( ImmutableMap . copyOf ( this . headers ) ) ; 
 + public ImmutableMap < String , String [ ] > getHeaders ( ) { 
 + return ImmutableMap . copyOf ( this . headers ) ; 
 } 
 
 @ Override 
 @ @ - 104 , 8 + 102 , 12 @ @ public final class DefaultMutableHttpResponse implements MutableHttpResponse { 
 public FullHttpResponse toFullResponse ( ) { 
 FullHttpResponse response = new DefaultFullHttpResponse ( HttpVersion . valueOf ( this . version . text ( ) ) , 
 HttpResponseStatus . valueOf ( this . status ) ) ; 
 - for ( Map . Entry < String , String > entry : getHeaders ( ) . entrySet ( ) ) { 
 - response . headers ( ) . add ( entry . getKey ( ) , entry . getValue ( ) ) ; 
 + 
 + for ( Map . Entry < String , String [ ] > entry : getHeaders ( ) . entrySet ( ) ) { 
 + String key = entry . getKey ( ) ; 
 + for ( String value : entry . getValue ( ) ) { 
 + response . headers ( ) . add ( key , value ) ; 
 + } 
 } 
 
 if ( this . content ! = null ) { 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java b / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java 
 index 11964e1 . . 70d8de4 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / resource / reader / TemplateRequest . java 
 @ @ - 7 , 6 + 7 , 8 @ @ import com . github . dreamhead . moco . model . DefaultHttpRequest ; 
 import com . github . dreamhead . moco . model . MessageContent ; 
 import com . google . common . collect . ImmutableMap ; 
 
 + import static com . github . dreamhead . moco . util . Maps . asSimple ; 
 + 
 public class TemplateRequest { 
 private Request request ; 
 
 @ @ - 28 , 7 + 30 , 7 @ @ public class TemplateRequest { 
 
 public ImmutableMap < String , String > getHeaders ( ) { 
 if ( this . request instanceof HttpRequest ) { 
 - return ( ( HttpRequest ) this . request ) . getHeaders ( ) ; 
 + return asSimple ( ( ( HttpRequest ) this . request ) . getHeaders ( ) ) ; 
 } 
 
 throw new IllegalArgumentException ( " Request is not HTTP request " ) ; 
 diff - - git a / moco - core / src / main / java / com / github / dreamhead / moco / util / HttpHeaders . java b / moco - core / src / main / java / com / github / dreamhead / moco / util / HttpHeaders . java 
 index dbf905e . . fa5d6a2 100644 
 - - - a / moco - core / src / main / java / com / github / dreamhead / moco / util / HttpHeaders . java 
 + + + b / moco - core / src / main / java / com / github / dreamhead / moco / util / HttpHeaders . java 
 @ @ - 9 , 10 + 9 , 10 @ @ public final class HttpHeaders { 
 return key . equalsIgnoreCase ( name ) ; 
 } 
 
 - public static Predicate < Map . Entry < String , String > > isForHeaderName ( final String key ) { 
 - return new Predicate < Map . Entry < String , String > > ( ) { 
 + public static Predicate < Map . Entry < String , String [ ] > > isForHeaderName ( final String key ) { 
 + return new Predicate < Map . Entry < String , String [ ] > > ( ) { 
 @ Override 
 - public boolean apply ( final Map . Entry < String , String > input ) { 
 + public boolean apply ( final Map . Entry < String , String [ ] > input ) { 
 return isSameHeaderName ( input . getKey ( ) , key ) ; 
 } 
 } ;
